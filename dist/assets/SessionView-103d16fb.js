import{j as c,c as P,a as e,r as f,b as W,i as qe,s as zn,T as v,B as S,D as ie,k as z,l as Ut,m as T,u as jn,F as U,n as Ge,o as ue,p as Bn,R as Ve,w as ot,q as ct,d as Pe,t as Kt,v as Vn,x as Wt,y as Zt,z as en,A as Hn,C as ae,E as tn,G as Mt,I as Ee,g as qn,J as nn,K as Gn,M as Jn,N as Yn}from"./main.cc7980d7.js";import{D as Qn,H as Xn}from"./index-84625879.js";import{D as ne,H as me,a as oe,T as be,u as Kn,C as Pt,A as nt,L as Zn,b as $e,S as er,l as Ne}from"./mouse-left-107cf13e.js";import{d as Le,R as Gt,L as tr,b as nr,e as Jt,f as rr,u as ar,M as sr,g as ir}from"./editor-9e67c00a.js";import{u as rn,o as Z,O as M,A as H,g as q,a as j,B as St,N as ze,P as an,b as or,I as sn,c as cr,d as lr,e as dr,f as ur,h as Tt,i as mr,T as pe,j as hr,k as Re,M as lt,l as Je,C as Rt,m as on,n as _e,p as dt,W as le,q as cn,r as ln,s as Dt,t as dn,v as fr,w as Ot,x as un,y as We,z as Me,D as pr,E as vr,F as gr,G as mn,H as hn,J as br,K as wr,L as Cr,Q as yr,R as Sr,S as xr,U as Nr,V as _r,X as kr,Y as Ir,Z as Ar,_ as Rr}from"./actions-42459e52.js";import{I as L,a as A,D as ye,S as K,C as ke}from"./DropdownMenu-c9ddf01c.js";import{P as Ur}from"./planet-c905bcdd.js";import{D as F,I as J}from"./index.module-9a456540.js";import{s as Wr,c as Mr,l as Pr,g as Tr,b as xt,a as Dr}from"./common-1b4c5772.js";import{C as ce,A as Nt}from"./cross-0b515b96.js";import{S as R}from"./SettingTile-abd8ecde.js";import{L as _}from"./Label-b8166eab.js";import{u as Ft,M as ut,C as G,F as Te}from"./Footer-aa726a7f.js";import{a as Se,o as he,w as Et,u as Or,b as Ye,c as fn}from"./overlayVisibility-d52fa692.js";import{S as rt}from"./Switch-b59763bd.js";import"./modulepreload-polyfill-3cfb730f.js";import"./Deferred-af9e678f.js";import"./math-0381bedb.js";function Fr({spaces:t,roomList:r}){return c("div",{className:P("SidebarView",{["SidebarView--close"]:!open},"flex gap-xs"),children:[t&&e("div",{className:"shrink-0 flex",children:t}),r&&e("div",{className:"grow flex",children:r})]})}function Ze({className:t,iconSrc:r,name:n,variant:a="surface",isActive:s=!1,onClick:i}){const o=P(`SidebarTab SidebarTab--${a}`,{["SidebarTab--active"]:s},t),l=a==="surface"||a==="surface-low"?"surface-low":`on-${a}`;return e("button",{onClick:i,type:"button",className:o,"aria-label":n,children:e(L,{color:l,src:r,size:"md"})})}const pn="/assets/explore-6b5f2674.svg",Er="/assets/notification-75b7b67d.svg";function mt(t,r){return rn(t,(n,a)=>({onReset:()=>n(Array.from(a)),onAdd:()=>n(Array.from(a)),onUpdate:()=>n(Array.from(a)),onMove:()=>n(Array.from(a)),onRemove:()=>n(Array.from(a))}),n=>Array.from(n),r)}function $r(t,r){return r.timestamp-t.timestamp}function Lr(t){return mt(()=>t.invites.sortValues($r),[t.invites])}const zr="/assets/copy-b0258f81.svg";const jr=f.forwardRef(({className:t,size:r="md",state:n,outlined:a,disabled:s,before:i,after:o,...l},d)=>{const u=P(`Input Input--${r}`,{"Input--success":n==="success","Input--error":n==="error","Input--disabled":s,"Input--outlined":a},t);return c("div",{className:u,children:[i,e("textarea",{ref:d,"data-ui-state":n,disabled:s,...l}),o]})}),Yt=async t=>{const r=t.logger.reporters.find(s=>typeof s.export=="function");if(!r)throw new Error("No logger that can export configured");return(await r.export()).asBlob()};function Br({open:t,requestClose:r}){const{platform:n,session:a}=W(!0),{callback:s,loading:i,error:o}=qe(async u=>{const{bugReportEndpointUrl:m}=n.config;if(!m)throw new Error("No server configured to submit logs");const p=await Yt(n);await zn({app:"thirdroom",userAgent:n.description,version:n.version,text:`Third Room user ${a.userId} on device ${a.deviceId}: ${u??"No description provided."}`},p,m,n.request)},[]),l=u=>{u.preventDefault();const{descInput:m}=u.target,p=m.value.trim()||void 0;m.value="",s(p)},d=async()=>{Yt(n).then(u=>{Wr(u.nativeBlob,`thirdroom-logs-${new Date}.json`)})};return c(ne,{open:t,onOpenChange:r,children:[e(me,{left:e(oe,{size:"lg",children:"Report Bug"}),right:e(A,{iconSrc:ce,onClick:r,label:"Close"})}),c("form",{onSubmit:l,className:"flex flex-column gap-md",style:{padding:"0 var(--sp-md) var(--sp-md)"},children:[c(v,{variant:"b3",children:["Please ",e("a",{href:"https://github.com/matrix-org/thirdroom/issues",target:"_blank",children:"view existing bugs on Github"})," first. No match? ",e("a",{href:"https://github.com/matrix-org/thirdroom/issues/new",target:"_blank",children:"Start a new one"}),"."]}),c("div",{className:"flex flex-column gap-xxs",children:[e(v,{weight:"bold",children:"Submit Debug Logs"}),c(v,{variant:"b3",children:["Debug logs contain application usage data including your username, the IDs or aliases of the rooms or groups you have visited, the usernames of other users and the names of files you send. They do not contain messages. For more information, review our"," ",e("a",{href:"https://element.io/privacy",target:"_blank",children:"privacy policy"}),"."]})]}),e(R,{label:e(_,{children:"Description"}),children:c("div",{className:"flex flex-column gap-xxs",children:[e(jr,{style:{height:"100px"},name:"descInput",disabled:i}),o&&e(v,{variant:"b3",color:"danger",children:o.message||"Failed to submit logs."})]})}),c("div",{className:"flex flex-column gap-sm",children:[e(S,{type:"submit",disabled:i,children:i?e(ie,{color:"on-primary"}):"Submit Logs"}),e(S,{type:"button",onClick:d,fill:"outline",children:"Download Logs"})]})]})]})}function Vr(){const{session:t,platform:r,logout:n}=W(!0),{accountManagementUrl:a}=t.sessionInfo,{userId:s,displayName:i,avatarUrl:o}=z(Ut),l=T(Z),[d,u]=f.useState(!1),[m,p]=f.useState(!1),b=jn();return c(U,{children:[e(Br,{open:m,requestClose:()=>p(!1)}),e(ye,{content:c("div",{className:"UserMenu flex flex-column gap-xs",children:[c("div",{className:"UserMenu__header",children:[e(v,{weight:"medium",children:i}),c("div",{className:"flex items-center gap-xxs",children:[e(v,{className:"truncate",variant:"b3",color:"surface-low",children:s}),e(be,{open:d,content:d?"Copied":"Copy",side:"top",children:e(A,{onClick:()=>{d||(u(!0),Mr(s),setTimeout(()=>u(!1),500))},className:"shrink-0",size:"sm",iconSrc:zr,variant:"primary",label:"Copy user id"})})]})]}),c("div",{children:[e(F,{onSelect:()=>l({type:M.UserProfile}),children:"User Settings"}),a&&e(F,{onSelect:()=>window.open(a),children:"Manage Account"}),e(F,{onSelect:()=>b("/landing"),children:"Landing Page"}),e(F,{onSelect:()=>p(!0),children:"Report Bug"}),e(F,{onSelect:()=>{confirm("Are you sure?")&&n()},variant:"danger",children:"Logout"})]})]}),children:e(H,{onClick:()=>!1,shape:"circle",name:i,bgColor:`var(--usercolor${q(s)})`,imageSrc:o?j(o,40,r,t.mediaRepository):void 0})})]})}function Hr(t,r){return r.lastMessageTimestamp-t.lastMessageTimestamp}var se=(t=>(t[t.World=0]="World",t[t.Room=1]="Room",t[t.Direct=2]="Direct",t))(se||{});const vn=(t,r)=>r===0?t.type==="org.matrix.msc3815.world":r===1&&!t.type&&!t.isDirectMessage?!0:r===2?t.isDirectMessage:!1;function Ie(t,r){const[n,a]=f.useState(r);return[mt(()=>t.rooms.filterValues(s=>vn(s,n)).sortValues(Hr),[t.rooms,n]),a]}var X=(t=>(t.Home="Home",t.Friends="Friends",t.Notifications="Notifications",t))(X||{});const Qt=Ge("Home"),De=Ge(t=>t(Qt),(t,r,n)=>{r(Z,{type:M.None}),r(Qt,n)});function qr(){const{session:t}=W(!0),r=Lr(t),[n]=Ie(t,se.Room),[a]=Ie(t,se.Direct),[s,i]=ue(De),[o,l]=ue(Z),d=n.reduce((m,p)=>m+p.notificationCount,0),u=a.reduce((m,p)=>m+p.notificationCount,0);return c("div",{className:"SpacesView flex flex-column",children:[c("div",{className:"grow flex flex-column items-center gap-xs",children:[e(St,{badge:d>0&&e(ze,{content:d}),children:e(Ze,{onClick:()=>i(X.Home),isActive:s===X.Home&&o.type===M.None,name:"Home",iconSrc:Ur,variant:"surface-low"})}),e(St,{badge:u>0&&e(ze,{content:u}),children:e(Ze,{onClick:()=>i(X.Friends),isActive:s===X.Friends&&o.type===M.None,name:"Friends",iconSrc:an,variant:"surface-low"})}),e(St,{badge:r.length>0?e(ze,{content:r.length}):void 0,children:e(Ze,{onClick:()=>i(X.Notifications),isActive:s===X.Notifications&&o.type===M.None,name:"Notifications",iconSrc:Er,variant:"surface-low"})}),e(Ze,{onClick:()=>l({type:M.Discover}),isActive:o.type===M.Discover,name:"Discover",iconSrc:pn,variant:"surface-low"})]}),e("div",{className:"shrink-0 flex flex-column items-center gap-xs",children:e(Vr,{})})]})}function Gr({header:t,content:r,footer:n}){return c("div",{className:"RoomListView flex flex-column",children:[t,e("div",{className:"RoomListView__container grow",children:e(K,{type:"hover",children:r})}),n]})}const at="/assets/add-f366de5f.svg";function gn({requestClose:t}){const{session:r}=W(!0),[n,a]=f.useState(!1),[s,i]=f.useState(),{loading:o,value:l,setSearchTerm:d}=or(r),u=async b=>{if(n)return;if(i(void 0),a(!0),await Bn(r.hsApi,b)===!1){i(`User id "${b}" is invalid. Failed to start direct message.`),a(!1);return}const C=r.createRoom({visibility:Ve.DirectMessage,invites:[b]});await ot(r,C),t()},m=async b=>{b.preventDefault();const C=b.currentTarget.input.value;u(C.trim())},p=Ft(f.useCallback(b=>{i(void 0),d(b.target.value)},[d]),{wait:400});return c("div",{className:"flex flex-column",children:[e(me,{className:"shrink-0",left:e(oe,{size:"lg",children:"Direct Message"}),right:e(A,{iconSrc:ce,onClick:t,label:"Close"})}),c("form",{onSubmit:m,className:"grow flex flex-column gap-lg",style:{padding:"var(--sp-md)"},children:[c("div",{className:"flex flex-column gap-sm",children:[e(R,{label:c(U,{children:[e(_,{children:"User Id"}),e(be,{content:"User id looks like @user:server.name",side:"right",children:e(L,{src:sn,color:"surface-low",size:"sm"})})]}),children:e(J,{onChange:p,name:"input",maxLength:255,autoFocus:!0,placeholder:"@user:server.name",required:!0})}),!n&&s&&e(v,{variant:"b3",color:"danger",weight:"medium",children:s}),e(cr,{loading:o,suggestion:l==null?void 0:l.results,onSelect:b=>u(b.userId)})]}),c(S,{size:"lg",type:"submit",children:[n&&e(ie,{color:"on-primary"}),n?"Starting":"Direct Message"]})]})]})}function Jr({requestClose:t}){const{session:r}=W(!0),[n,a]=f.useState(!1),[s,i]=f.useState();return c("div",{className:"flex flex-column",children:[e(me,{className:"shrink-0",left:e(oe,{size:"lg",children:"Join with Alias"}),right:e(A,{iconSrc:ce,onClick:t,label:"Close"})}),c("form",{onSubmit:async d=>{if(d.preventDefault(),n)return;i(void 0);const m=d.currentTarget.input.value.trim();if(m!==""){if(m.match(/^(!|#).+:.+$/)==null){i(`Invalid ${m.startsWith("!")?"id":"alias"} "${m}". Alias will look like #example:server.name`);return}a(!0);try{await r.joinRoom(m),t()}catch{i(`Failed to join "${m}". Either world/room is private or doesn't exist.`)}a(!1)}},className:"grow flex flex-column gap-lg",style:{padding:"var(--sp-md)"},children:[c("div",{className:"flex flex-column gap-sm",children:[e(R,{label:c(U,{children:[e(_,{children:"Alias"}),e(be,{content:"Use alias or id.",side:"right",children:e(L,{src:sn,color:"surface-low",size:"sm"})})]}),children:e(J,{onChange:()=>{i(void 0)},name:"input",maxLength:255,autoFocus:!0,placeholder:"#example:server.name",required:!0})}),!n&&s&&e(v,{variant:"b3",color:"danger",weight:"medium",children:s})]}),c(S,{size:"lg",type:"submit",children:[n&&e(ie,{color:"on-primary"}),n?"Joining":"Join"]})]})]})}function Ae(t){const[r,n]=f.useState(t),a=f.useCallback(()=>n(!0),[]),s=f.useCallback(()=>n(!1),[]);return{open:r,setOpen:n,openDialog:a,closeDialog:s}}function Yr(){const t=z(De),r=T(Z),{open:n,setOpen:a,openDialog:s,closeDialog:i}=Ae(!1),{open:o,setOpen:l,openDialog:d,closeDialog:u}=Ae(!1);return c("header",{className:"RoomListHeader shrink-0 flex items-center gap-xs",children:[t===X.Home&&c(U,{children:[e(v,{className:"grow truncate",variant:"s2",weight:"semi-bold",children:"Home"}),e(ne,{open:o,onOpenChange:l,children:e(Jr,{requestClose:u})}),e(ye,{content:c(U,{children:[e(F,{onSelect:()=>r({type:M.CreateWorld}),children:"Create World"}),e(F,{onSelect:d,children:"Join with Alias"})]}),children:e(A,{label:"Add",iconSrc:at})})]}),t===X.Friends&&c(U,{children:[e(v,{className:"grow truncate",variant:"s2",weight:"semi-bold",children:"Friends"}),e(ne,{open:n,onOpenChange:a,children:e(gn,{requestClose:i})}),e(A,{onClick:s,label:"Direct Message",iconSrc:at})]}),t===X.Notifications&&e(U,{children:e(v,{className:"grow truncate",variant:"s2",weight:"semi-bold",children:"Notifications"})})]})}function Qr({children:t}){return e("div",{className:"RoomListViewContent",children:t})}function Xr({chat:t,tiles:r}){return c("div",{className:"ActiveChats flex flex-column",children:[e("div",{className:"ActiveChats__chat grow flex justify-end items-end",children:t}),e(K,{className:"shrink-0",orientation:"horizontal",type:"scroll",children:e("div",{className:"flex justify-end",children:e("div",{className:"ActiveChats__tiles flex flex-row-reverse",children:r})})})]})}const Kr="/assets/cross-circle-99eb2f99.svg";function Zr({roomId:t,avatar:r,title:n,isActive:a,onClick:s,onClose:i}){const o=P("ActiveChatTile",{["ActiveChatTile--active"]:a},"flex items-center");return c("div",{className:o,children:[c("button",{className:"grow flex items-center",type:"button",onClick:()=>s(t),children:[e("div",{className:"shrink-0",children:r}),e(v,{className:"ActiveChatTile__title truncate",type:"span",color:a?"on-primary":"surface",weight:"medium",children:n})]}),e("div",{className:"ActiveChatTile__options shrink-0",children:e(A,{variant:a?"on-primary":"surface-low",size:"sm",iconSrc:Kr,label:"Close",onClick:()=>i(t)})})]})}function ea({children:t}){return e("div",{className:"ChatView flex flex-column",children:t})}function ta({className:t,avatar:r,title:n,options:a}){return c("header",{className:P("ChatHeader flex items-center",t),children:[e("div",{className:"shrink-0 flex",children:r}),e("div",{className:"ChatHeader__title grow",children:e(v,{className:"truncate",children:n})}),e("div",{className:"ChatHeader__options shrink-0 flex",children:a})]})}const na="/assets/minus-18e1b698.svg";function ra({room:t,platform:r,session:n,onMinimize:a,onClose:s}){const i=t.name||"Empty room";return e(ta,{className:"shrink-0",avatar:e(H,{imageSrc:t.avatarUrl?j(t.avatarUrl,50,r,n.mediaRepository):void 0,size:"sm",name:i,bgColor:`var(--usercolor${q(t.id)})`}),title:i,options:c(U,{children:[e(A,{variant:"surface",label:"Minimize",iconSrc:na,onClick:()=>a(t.id)}),e(A,{variant:"surface",label:"Close",iconSrc:ce,onClick:()=>s(t.id)})]})})}class aa extends ct{constructor(r){super(r)}render(r,n){return r.li({className:"ChatGap flex justify-center"},r.p({className:"ChatGap__content Text Text-b2 Text--surface Text--semi-bold"},[a=>a.isLoading?"Loading more messages...":"Not loading!",a=>a.error?a.error:""]))}onClick(){}}class bn extends ct{constructor(r){super(r)}render(r,n){var i,o;const a=((i=n._getContent())==null?void 0:i.msgtype)==="m.emote",s=n.isContinuation;return r.li({className:P("ChatBaseMessage",{"ChatBaseMessage--contentOnly":s&&!a},{"ChatBaseMessage--emote":a},"flex")},[s&&!a?"":this.renderAvatar(r,n),r.div({className:"ChatBaseMessage__content grow"},[s||a?"":r.p({className:"ChatBaseMessage__sender Text Text-b2 Text--surface Text--bold truncate"},n.displayName),r.div({className:"ChatBaseMessage__body"},((o=this.renderBody)==null?void 0:o.call(this,r,n))||"")])])}renderAvatar(r,n){var m;const a=((m=n._getContent())==null?void 0:m.msgtype)==="m.emote",s=n.avatarUrl(40),{avatarColorNumber:i,avatarLetter:o,avatarTitle:l}=n,d=P(`ChatBaseMessage__avatar ChatBaseMessage__avatar-${i} shrink-0`,{"ChatBaseMessage__avatar--sm":a}),u=s?r.img({src:s}):r.span({className:"Text Text-b2 Text--medium"},o);return r.div({className:d,"aria-label":l},u)}onClick(){}}class sa extends bn{constructor(r){super(r)}renderBody(r,n){var i,o;let s=((i=n._getContent())==null?void 0:i.msgtype)==="m.emote"?`* ${n.displayName} `:"";return s+=(o=n._getPlainBody)==null?void 0:o.call(n),r.div({className:"ChatMessage__body flex"},r.p({className:"Text Text-b2 Text--surface Text--regular"},Pr(s)||"*** EMPTY MESSAGE ***"))}onClick(){}}class ia extends ct{constructor(r){super(r)}render(r,n){return r.li({className:"ChatAnnouncement flex"},r.div({className:"ChatAnnouncement__content"},r.p({className:"Text Text-b2 Text--surface-low Text--regular"},n.announcement)))}onClick(){}}class oa extends bn{constructor(r){super(r)}renderBody(r,n){const{height:a}=n;return r.div({className:"ChatImage__body flex"},r.img({src:n.thumbnailUrl,style:`width: 340px; height: ${a}px;`}))}onClick(){}}class ca extends ct{constructor(r){super(r)}render(r,n){return r.p({className:"ChatDate Text Text-b2 Text--surface Text--semi-bold"},r.time({dateTime:n.machineReadableDate},n.relativeDate))}onClick(){}}function la(t){switch(t.shape){case"gap":return aa;case"announcement":return ia;case"message":case"message-status":return sa;case"image":return oa;case"date-header":return ca;default:throw new Error(`Tiles of shape "${t.shape}" are not supported, check the tileClassForEntry function in the view model`)}}function da({timelineViewModel:t}){const r=f.useRef(null);return lr(r,t,la),e("div",{className:"ChatTimeline flex",ref:r})}const ua="/assets/send-1d7f5cd0.svg";function ma({composerViewModel:t}){return e("div",{className:"ChatComposer flex",children:c("form",{className:"grow flex items-center",onSubmit:n=>{n.preventDefault();const a=n.target,s=a.message.value.trim();s!==""&&(a.message.value="",t.sendMessage(s))},children:[e("input",{className:"Text Text-b1 Text--surface Text--regular grow",name:"message",type:"text",placeholder:"Send a message...",autoComplete:"off",autoFocus:!0}),e(A,{iconSrc:ua,label:"Send Message",type:"submit"})]})})}function ha({room:t}){setTimeout(()=>t.clearUnread(),1e3);const{loading:r,roomViewModel:n,error:a}=dr(t,ur);return c(U,{children:[a&&e("div",{className:"grow flex justify-center items-center",children:a.message}),!a&&(r||!n)&&e("div",{className:"grow flex justify-center items-center",children:e(ie,{color:"surface-low"})}),!a&&(n==null?void 0:n.timelineViewModel)&&c(U,{children:[e("div",{className:"grow",children:e(da,{timelineViewModel:n.timelineViewModel})}),e("div",{className:"shrink-0",children:e(ma,{composerViewModel:n.composerViewModel})})]})]})}function wn(t,r){const n=Tt(()=>t.invites,[t.invites]);return r?n.get(r):void 0}function Cn(t,r){const[,n]=f.useReducer(l=>l+1,0),a=Pe(),s=wn(t,r);return{invite:s,accept:async()=>{s&&(n(),await s.accept(),a()&&n())},reject:async()=>{s&&(n(),await s.reject(),a()&&n())}}}function fa({session:t,roomId:r}){const{invite:n,accept:a,reject:s}=Cn(t,r);return n===void 0?e(v,{className:"grow flex justify-center items-center",children:"Failed to load invite"}):c("div",{style:{padding:"var(--sp-md)"},className:"grow text-center flex flex-column justify-center items-center gap-md",children:[e(H,{imageSrc:n.avatarUrl,size:"lg",name:n.name||"Unnamed Room",bgColor:`var(--usercolor${q(n.id)})`}),c(v,{children:[e("b",{children:n.inviter.name})," invites you to ",e("b",{children:n.name||"Unnamed Room"}),"."]}),c("div",{className:"flex gap-xs",children:[!(n.accepting||n.accepted)&&e(S,{fill:"outline",onClick:s,disabled:n.rejecting,children:n.rejecting?e(ie,{color:"primary"}):"Reject"}),!(n.rejecting||n.rejected)&&e(S,{onClick:a,disabled:n.accepting,children:n.accepting?e(ie,{color:"on-primary"}):"Accept"})]})]})}function pa(t,r){return rn(t,n=>n,n=>n.get(),r)}function va(t,r){const{loading:n,error:a,value:s}=mr(t,r),i=pa(()=>s||new Kt(void 0),[s]);return{loading:n,error:a,value:i}}function ga(t,r){return va(()=>r?t.observeRoomStatus(r):Promise.resolve(new Kt(void 0)),[t,r])}function ht({className:t,onRequestClose:r,children:n}){return Kn(a=>{a.key==="Escape"&&(r==null||r())},[]),e("div",{className:P("Window flex flex-column",t),children:n})}function tt({className:t,label:r,content:n,footer:a}){return c("div",{className:P("flex flex-column gap-xs",t),children:[r,n,a]})}function ve({className:t,itemMinWidth:r=475,gap:n="xs",children:a}){return e("div",{style:{display:"grid",gridGap:`var(--sp-${n})`,gridTemplateColumns:`repeat(auto-fit, minmax(${r}px, 1fr))`},className:t,children:a})}function _t({className:t,text:r,iconSrc:n,onClick:a}){return c("button",{style:{cursor:"pointer"},className:P("flex items-center gap-sm",t),onClick:a,type:"button",children:[e(v,{variant:"b3",weight:"bold",children:r}),n&&e(L,{size:"sm",src:n})]})}function $t(t,r){const[n,a]=f.useState(new Vn),s=Pe(),i=Tt(()=>n,[n]);return f.useEffect(()=>{t.observeStateType(r).then(o=>{s()&&a(o)})},[r,t,s]),i}function yn(t){return[...$t(t,$.FeaturedWorld)].map(([n,a])=>a).filter(n=>Object.keys(n.content).length>0)}function Sn({room:t,children:r}){const n=yn(t);return r(n)}function xn(t){return[...$t(t,$.FeaturedRoom)].map(([n,a])=>a).filter(n=>Object.keys(n.content).length>0)}function Nn({room:t,children:r}){const n=xn(t);return r(n)}function st({className:t,avatar:r,name:n,desc:a,memberCount:s,options:i}){return c("div",{className:P("RoomPreviewCard","flex items-center gap-xs",t),children:[e("div",{className:"shrink-0 flex",children:r}),c("div",{className:"grow flex items-center gap-md",children:[c("div",{className:"grow",children:[n&&e(v,{variant:"b2",className:"truncate",weight:"medium",children:n}),s&&c("div",{className:"flex items-center gap-xxs",children:[e(L,{size:"sm",src:an}),e(v,{variant:"b3",weight:"bold",children:s})]}),a&&e(v,{className:"truncate",variant:"b3",children:a})]}),i&&e("div",{className:"shrink-0",children:i})]})]})}function ft(t,r,n){const{homeserver:a}=t.sessionInfo;return fetch(`${a}/_matrix/client/unstable/im.nheko.summary/rooms/${encodeURIComponent(r)}/summary`,{signal:n})}function ba(t){const{session:r}=W(!0),[n,a]=f.useState();return f.useEffect(()=>{let s;return t&&(async()=>{s=new AbortController;const l=await(await ft(r,t,s.signal)).json();l.errcode||a({roomId:l.room_id,avatarUrl:l.avatar_url,name:l.name,topic:l.topic,alias:l.canonical_alias,roomType:l.room_type,memberCount:l.num_joined_members})})(),()=>{s==null||s.abort()}},[r,t]),n}function pt({roomIdOrAlias:t,fallback:r,children:n}){const a=ba(t);return a?n(a):r()}function _n({session:t,roomId:r,children:n}){const{value:a,loading:s,error:i,callback:o}=qe(async d=>{const u=await t.hsApi.joinIdOrAlias(d).response();return(u==null?void 0:u.room_id)??void 0},[t]),l=typeof a=="string"||!!t.rooms.get(r);return n(o,l,s,i)}function kn({session:t,platform:r,roomId:n}){const a=T(Se),s=T(De),i=T(Z),o=()=>{a({type:"OPEN",roomId:n}),s(X.Home),i({type:M.None})};return e(pt,{roomIdOrAlias:n,fallback:()=>e(st,{}),children:l=>e(st,{avatar:e(H,{imageSrc:l.avatarUrl&&j(l.avatarUrl,60,r,t.mediaRepository),shape:"rounded",size:"lg",bgColor:`var(--usercolor${q(l.roomId)})`,name:l.name}),name:l.name,desc:l.topic,memberCount:l.memberCount,options:e("div",{className:"flex items-center gap-xs",children:e(_n,{session:t,roomId:n,children:(d,u,m,p)=>u?e(S,{variant:"secondary",fill:"outline",size:"sm",onClick:o,children:"View"}):c(S,{disabled:m,variant:"secondary",size:"sm",onClick:()=>d(l.alias??n),children:[m&&e(ie,{size:"sm",color:"on-secondary"}),m?"Joining":"Join"]})})})})})}function In({session:t,platform:r,roomId:n}){const a=T(he),s=T(De),i=T(Z),o=()=>{a(n),s(X.Home),i({type:M.None})};return e(pt,{roomIdOrAlias:n,fallback:()=>e(st,{}),children:l=>e(st,{avatar:e(H,{imageSrc:l.avatarUrl&&j(l.avatarUrl,60,r,t.mediaRepository),shape:"circle",size:"lg",bgColor:`var(--usercolor${q(l.roomId)})`,name:l.name}),name:l.name,desc:l.topic,memberCount:l.memberCount,options:e("div",{className:"flex items-center gap-xs",children:e(_n,{session:t,roomId:n,children:(d,u,m,p)=>u?e(S,{variant:"secondary",fill:"outline",size:"sm",onClick:o,children:"View"}):c(S,{disabled:m,variant:"secondary",size:"sm",onClick:()=>d(l.alias??n),children:[m&&e(ie,{size:"sm",color:"on-secondary"}),m?"Joining":"Join"]})})})})})}function Lt(t){return[...$t(t,$.FeaturedScene)].map(([n,a])=>a).filter(n=>Object.keys(n.content).length>0)}function An({room:t,children:r}){const n=Lt(t);return r(n)}function ge({className:t,bgColor:r,size:n="md",outlined:a,wide:s,children:i}){const o={};return r&&(o.backgroundColor=r),e("div",{className:P("Thumbnail",`Thumbnail--${n}`,{"Thumbnail--outlined":a},{"Thumbnail--wide":s},t),style:o,children:i})}function Rn({className:t,thumbnail:r,children:n}){return c("div",{className:P("ScenePreviewCard flex flex-column gap-xs",t),children:[r,n]})}function Un({className:t,children:r}){return e("span",{className:P("ScenePreviewCard__Content flex gap-xs",t),children:r})}function zt({className:t,children:r}){const n=P("ModalAside",t);return e("div",{className:n,children:r})}function jt({className:t,children:r,aside:n}){return c("div",{className:P("ModalContent flex",t),children:[e("div",{className:"ModalContent__main grow flex",children:r}),n&&e("aside",{className:"ModalContent__aside",children:n})]})}function Ue({className:t,src:r,alt:n,fallback:a}){return e("div",{className:P("ScenePreview flex justify-center items-center",t),children:r?e("img",{src:r,alt:n}):a})}function wa({className:t,content:r,children:n}){return c("div",{className:P("ThumbnailHover",t),children:[n,r&&e("div",{className:"ThumbnailHover__content",children:r})]})}function it({url:t,onAvatarPick:r,onAvatarDrop:n}){return e(wa,{className:"shrink-0",content:t?e(A,{variant:"world",onClick:n,size:"xl",iconSrc:ce,label:"Remove avatar"}):void 0,children:e(ge,{size:"sm",className:"flex flex-column",children:t?e(pe,{src:t}):c(U,{children:[e(A,{variant:"surface-low",onClick:r,size:"xl",iconSrc:at,label:"Add avatar"}),e(v,{color:"surface-low",variant:"b3",weight:"semi-bold",children:"Upload"})]})})})}function vt(t,r){const[n,a]=f.useState({pickUsed:0,dropUsed:0});f.useEffect(()=>()=>{n.url&&URL.revokeObjectURL(n.url)},[n.url]);const s=f.useCallback(async()=>{const l=await t.openFile(r);l&&a(d=>({blob:l.blob,url:URL.createObjectURL(l.blob.nativeBlob),pickUsed:d.pickUsed+1,dropUsed:d.dropUsed}))},[a,t,r]),i=f.useCallback(()=>a(l=>({pickUsed:l.pickUsed,dropUsed:l.dropUsed+1})),[]),o=f.useCallback(()=>({pickUsed:0,dropUsed:0}),[]);return{fileData:n,pickFile:s,dropFile:i,resetUses:o}}const Ca={version:7,sceneUrl:"mxc://thirdroom.io/FLGnLihOjpOWWddGwWPJBSBB",scenePreviewUrl:"mxc://thirdroom.io/OvtWlQFZzTTvEMoQbYnNtVec",defaultAvatar:{info:{h:512,mimetype:"image/png",size:307589,w:512},url:"mxc://thirdroom.io/aQuXXENLaYnfAZdwJVgRpfUT"}},ya=[{sceneName:"Terra",sceneUrl:"mxc://thirdroom.io/fgVQdOhEiMWfvxWaRXbEvmpV",scenePreviewUrl:"mxc://thirdroom.io/OvtWlQFZzTTvEMoQbYnNtVec",defaultRoomAvatarUrl:"mxc://thirdroom.io/aQuXXENLaYnfAZdwJVgRpfUT"},{sceneName:"UK City",sceneUrl:"mxc://thirdroom.io/cwDzwFqxknpmMEljfYPqfmkE",scenePreviewUrl:"mxc://thirdroom.io/VnHYowXiIytpeJAxIkYCTygh",defaultRoomAvatarUrl:"mxc://thirdroom.io/yWBfCCFEHMdjAPOYSQoIAeOZ"}],de={home:Ca,scenes:ya};const Sa="/assets/check-732a46d2.svg";function xa({className:t,name:r,sentBytes:n,totalBytes:a,onUploadDrop:s}){return c("div",{className:P("FileUploadCard flex flex-column gap-xs",t),children:[c("div",{className:"flex items-center gap-xs",children:[e("div",{className:"grow",children:e(v,{className:"truncate",variant:"b2",weight:"medium",children:r})}),e(A,{onClick:s,iconSrc:ce,size:"sm",label:"cancel"})]}),n<a&&e(hr,{variant:"secondary",value:n,max:a}),c("div",{className:"flex items-center gap-xs",children:[n<a?e(v,{className:"grow",variant:"b3",color:"surface-low",children:`${Tr(a,n)}%`}):c("div",{className:"grow flex items-start gap-xxs",children:[e(v,{variant:"b3",color:"surface-low",children:"Uploaded"}),e(L,{size:"sm",color:"secondary",src:Sa})]}),e(v,{variant:"b3",color:"surface-low",children:n<a?`${xt(n)} / ${xt(a)}`:xt(a)})]})]})}function Na({className:t,name:r,message:n,onUploadDrop:a}){return c("div",{className:P("FileUploadCard flex flex-column gap-xxs",t),children:[c("div",{className:"flex items-center gap-xs",children:[e("div",{className:"grow",children:e(v,{color:"danger",className:"truncate",variant:"b2",weight:"medium",children:r})}),e(A,{onClick:a,iconSrc:ce,size:"sm",label:"cancel"})]}),n&&e(v,{variant:"b3",children:n})]})}function _a(t,r){const[n,a]=f.useState(),[s,i]=f.useState(),o=f.useRef(),l=f.useCallback(async u=>{if(o.current){console.warn("Already uploading attachment.",u);return}try{const m=await Wt(t,u,p=>{o.current=p},r);if(!o.current)return;a(m),o.current}catch(m){m.name!=="AbortError"&&i(m),o.current}},[t,r]),d=f.useCallback(()=>{var u;(u=o.current)==null||u.abort(),o.current=void 0,i(void 0),a(void 0)},[]);return f.useEffect(()=>()=>{var u;(u=o.current)==null||u.abort()},[]),{mxc:n,error:s,upload:l,cancel:d}}function ka(t,r=100){const n=f.useRef(),a=f.useRef(0),s=f.useCallback((...i)=>{const o=Date.now();o>=a.current+r?t(...i):(clearTimeout(n.current),n.current=window.setTimeout(()=>{a.current=o,t(...i)})),a.current=o},[t,r]);return f.useEffect(()=>()=>{clearTimeout(n.current)},[]),s}function we({renderButton:t,mimeType:r,onUploadInfo:n}){const{session:a,platform:s}=W(!0),{fileData:i,pickFile:o,dropFile:l}=vt(s,r),[d,u]=f.useState(0),m=ka(u,16),{mxc:p,error:b,upload:C,cancel:w}=_a(a.hsApi,m);return f.useEffect(()=>{i.blob?C(i.blob):(w(),u(0))},[i.blob,C,w]),f.useEffect(()=>{n({mxc:p,blob:i.blob,url:i.url})},[p,i.blob,i.url,n]),b?e(Na,{name:b.name,message:b.message,onUploadDrop:l}):i.blob?e(xa,{name:i.blob.nativeBlob.name,sentBytes:p?i.blob.size:d,totalBytes:i.blob.size,onUploadDrop:l}):t(o)}const Ce="/assets/upload-d47e2ebd.svg";function Ia({onSave:t,renderTrigger:r}){const[n,a]=f.useState(!1),s=()=>a(!0),i=()=>a(!1),[o,l]=f.useState({}),[d,u]=f.useState({}),m=()=>{o.mxc&&d.mxc&&(t(o.mxc,d.mxc),i())};return c(U,{children:[r(s),e(ut,{open:n,onOpenChange:a,children:e(G,{className:"grow",children:e(jt,{children:e(G,{top:e(me,{left:e(oe,{children:"Upload Scene"})}),children:e(K,{children:c("div",{className:"UploadScene__content",children:[c(R,{className:"grow basis-0",label:e(_,{children:"Scene"}),children:[e(v,{className:"UploadScene__info-text",variant:"b3",color:"surface-low",children:"Upload a 3D scene (*.glb file)"}),e(we,{mimeType:".glb",onUploadInfo:l,renderButton:p=>c(S,{onClick:p,children:[e(L,{src:Ce,color:"on-primary"}),"Upload Scene"]})})]}),c(R,{className:"grow basis-0",label:e(_,{children:"Scene Preview"}),children:[e(v,{className:"UploadScene__info-text",variant:"b3",color:"surface-low",children:"Upload a preview image of 3D scene"}),e(we,{mimeType:"image/*",onUploadInfo:u,renderButton:p=>c(S,{onClick:p,children:[e(L,{src:Ce,color:"on-primary"}),"Upload Preview"]})})]})]})}),bottom:e(Te,{left:e(S,{onClick:i,fill:"outline",children:"Cancel"}),right:e(S,{onClick:m,disabled:!o.mxc||!d.mxc,children:"Save"})})}),aside:e(zt,{className:"flex",children:e(Ue,{className:"grow",src:d.url,alt:"3D Avatar preview",fallback:e(v,{variant:"b3",color:"surface-low",weight:"medium",children:"Uploaded scene preview will appear here."})})})})})})]})}function Aa({session:t,children:r}){const{homeserver:n}=t.sessionInfo,a=en(t.userId),s=Pe(),[i,o]=f.useState(),l=f.useCallback(async u=>{if(!s()||(o(void 0),u.target.value.trim()===""))return;const m=u.target.value.replace(/\s/g,"-");u.target.value!==m&&(u.target.value=m);const p=await Hn(n,`#${m}:${a}`);u.target.value===m&&s()&&o(p)},[n,a,s]),d=Ft(l,{wait:300,immediate:!0});return e(U,{children:r(i,d)})}async function Wn(t,{avatar:r,name:n,topic:a,visibility:s,alias:i,content:o}){const l=r?{name:r.nativeBlob.name,blob:r,info:{mimetype:r.nativeBlob.type,size:r.size,...await Dr(r.nativeBlob)}}:void 0;return await t.createRoom({type:Zt.World,visibility:s,avatar:l,name:n,topic:a,alias:i,isEncrypted:!1,isFederationDisabled:!1,powerLevelContentOverride:{invite:100,kick:100,ban:100,redact:50,state_default:50,events_default:0,users_default:0,events:{"m.room.power_levels":100,"m.room.history_visibility":100,"m.room.tombstone":100,"m.room.encryption":100,"m.room.name":50,"m.room.message":0,"m.room.encrypted":50,"m.sticker":50,"org.matrix.msc3815.world":50,"org.matrix.msc3401.call":0,"org.matrix.msc3401.call.member":0,"org.matrix.msc3815.member.world":0},users:{[t.userId]:100}},initialState:[{type:"org.matrix.msc3815.world",content:o}]})}function Mn({scene:t,onSceneChange:r,onCreate:n,onClose:a}){var xe,Oe;const{session:s,platform:i}=W(!0),o=en(s.userId),l=Pe(),{fileData:d,pickFile:u,dropFile:m}=vt(i,"image/*"),p=(xe=t==null?void 0:t.event)==null?void 0:xe.content.scene.url,b=(Oe=t==null?void 0:t.event)==null?void 0:Oe.content.scene.preview_url,C=typeof p=="string"&&typeof b=="string"?{url:p,previewUrl:b}:void 0,[w,x]=f.useState(C),[h,y]=f.useState(C),[g,k]=f.useState({}),[N,D]=f.useState(!1),B=async I=>{D(!0);const E=await Wn(s,I),ee=await ot(s,E);ee&&l()&&(n(ee.id),D(!1))},te=I=>{if(I.preventDefault(),!h)return;const{nameInput:E,topicInput:ee,isPrivateInput:Qe,aliasInput:Xe,maxObjectCapInput:Ht}=I.target,O=Xe.getAttribute("data-ui-state")==="error"?void 0:Xe.value||void 0,V={scene_url:h.url,scene_preview_url:h.previewUrl,max_member_object_cap:parseInt(Ht.value)||void 0};g.mxc&&(V.script_url=g.mxc),C&&t&&(V.scene=t.event.content.scene,V.scene_from={state_key:t.event.state_key??void 0,room_id:t.roomId}),B({visibility:Qe.checked?Ve.Private:Ve.Public,name:E.value,topic:ee.value||void 0,avatar:d.blob,alias:O,content:V})};f.useEffect(()=>{r==null||r(h==null?void 0:h.url,h==null?void 0:h.previewUrl)},[h,r]);const re=(I,E,ee)=>e("button",{className:"flex",style:{cursor:"pointer"},onClick:()=>{y({url:I,previewUrl:E})},type:"button",children:e(ge,{outlined:(h==null?void 0:h.url)===I,className:"shrink-0",size:"sm",children:e(pe,{src:Re(s,ee??E)})})},I);return e(G,{onSubmit:te,children:e(K,{children:c("div",{className:"CreateWorldForm",children:[C?null:e(R,{label:e(_,{children:"Scenes *"}),children:e(K,{orientation:"horizontal",type:"hover",children:c("div",{className:"flex items-center gap-md",children:[w&&re(w.url,w.previewUrl),e(Ia,{onSave:(I,E)=>{x({url:I,previewUrl:E}),y({url:I,previewUrl:E})},renderTrigger:I=>e(it,{onAvatarPick:I,onAvatarDrop:()=>!1})}),e("div",{className:"shrink-0",style:{backgroundColor:"var(--bg-surface-border)",height:"40px",width:"2px"}}),de.scenes.map(I=>re(I.sceneUrl,I.scenePreviewUrl,I.defaultRoomAvatarUrl))]})})}),c("div",{className:"flex gap-lg",children:[e(R,{className:"grow basis-0",label:e(_,{children:"World Name *"}),children:e(J,{name:"nameInput",required:!0})}),e(R,{className:"grow basis-0",label:e(_,{children:"Topic"}),children:e(J,{name:"topicInput"})})]}),c("div",{className:"flex gap-lg",children:[e(Aa,{session:s,children:(I,E)=>e(R,{className:"grow basis-0",label:e(_,{color:I?"secondary":I===!1?"danger":void 0,children:I?"Alias (Available)":I===!1?"Alias (Already in use)":"Alias"}),children:e(J,{name:"aliasInput",state:I?"success":I===!1?"error":void 0,onChange:E,maxLength:255-(o.length+2),before:e(v,{variant:"b2",children:"#"}),after:e(v,{variant:"b2",children:`:${o}`})})})}),e(R,{className:"grow basis-0",label:e(_,{children:"Max Spawned Objects Per User"}),children:e(J,{name:"maxObjectCapInput",type:"number",defaultValue:Le,required:!0})})]}),c("div",{className:"flex gap-lg",children:[e(R,{className:"grow basis-0",label:e(_,{children:"Private"}),children:e(rt,{name:"isPrivateInput",defaultChecked:!0})}),e(R,{className:"grow basis-0",label:e(_,{children:"Script (EXPERIMENTAL)"}),children:e(we,{mimeType:".js,.wasm",onUploadInfo:k,renderButton:I=>c(S,{fill:"outline",onClick:I,children:[e(L,{src:Ce,color:"primary"}),"Upload Script"]})})})]}),e(R,{label:e(_,{children:"World Avatar"}),children:e(it,{url:d.url,onAvatarPick:u,onAvatarDrop:m})})]})}),bottom:e(Te,{left:e(S,{size:"lg",fill:"outline",onClick:a,children:"Cancel"}),right:e(S,{size:"lg",type:"submit",disabled:!h||N,children:N?"Creating World...":"Create World"})})})}function Ra({session:t,scene:r,onCreate:n,onClose:a}){const[s,i]=f.useState();return e(G,{className:"grow",children:e(jt,{children:e(G,{top:e(me,{left:e(oe,{children:"Create World"})}),children:e(Mn,{scene:r,onSceneChange:(o,l)=>i(l),onCreate:n,onClose:a})}),aside:e(zt,{className:"flex",children:e(Ue,{className:"grow",src:Re(t,s),alt:"3D Avatar preview",fallback:e(v,{variant:"b3",color:"surface-low",weight:"medium",children:"Uploaded scene preview will appear here."})})})})})}function Pn({session:t,roomId:r,stateEvent:n}){const[a,s]=f.useState(!1),i=n.content,o=T(he),l=T(Z),d=u=>{o(u),l({type:M.None}),s(!1)};return e(Rn,{thumbnail:e(ge,{size:"lg",wide:!0,children:e(pe,{src:Re(t,i.scene.preview_url)??"",alt:i.scene.name})}),children:c(Un,{children:[c("div",{className:"grow",children:[e(v,{className:"truncate",variant:"b3",children:i.scene.author_name}),e(v,{className:"truncate",children:i.scene.name})]}),c("div",{className:"flex items-center gap-xs",children:[e(ut,{open:a,onOpenChange:s,children:e(Ra,{session:t,scene:{roomId:r,event:n},onClose:()=>s(!1),onCreate:d})}),e(S,{onClick:()=>s(!0),variant:"secondary",children:"Create World"})]})]})})}function Ua({room:t,supportRoomSummary:r,onLoadEvent:n}){const{session:a,platform:s}=W(!0);return e(K,{children:e(G,{className:"DiscoverHome__content",children:c("div",{className:"flex flex-column gap-md",children:[r&&c(U,{children:[e(Nn,{room:t,children:i=>i.length===0?null:e(tt,{label:e(_,{children:"Featured Public Rooms"}),content:e(ve,{children:i.sort(ae).slice(0,4).map(o=>e(kn,{session:a,platform:s,roomId:o.state_key},o.state_key))}),footer:i.length>4&&e("div",{className:"flex justify-end",children:e(_t,{onClick:()=>n($.FeaturedRoom),text:"Browse All Public Rooms",iconSrc:Nt})})})}),e(Sn,{room:t,children:i=>i.length===0?null:e(tt,{label:e(_,{children:"Featured Public Worlds"}),content:e(ve,{children:i.sort(ae).slice(0,4).map(o=>e(In,{session:a,platform:s,roomId:o.state_key},o.state_key))}),footer:i.length>4&&e("div",{className:"flex justify-end",children:e(_t,{onClick:()=>n($.FeaturedWorld),text:"Browse All Public Worlds",iconSrc:Nt})})})})]}),e(An,{room:t,children:i=>i.length===0?null:e(tt,{label:e(_,{children:"Featured Scenes"}),content:e(ve,{itemMinWidth:400,gap:"md",children:i.sort(ae).slice(0,3).map(o=>e(Pn,{session:a,roomId:t.id,stateEvent:o},o.state_key))}),footer:i.length>3&&e("div",{className:"flex justify-end",children:e(_t,{onClick:()=>n($.FeaturedScene),text:"Browse All Scenes",iconSrc:Nt})})})})]})})})}function Wa({className:t,children:r}){return e("div",{className:P("SegmentControl",t),children:r})}function kt({className:t,value:r,isSelected:n=!1,onSelect:a,children:s}){return e("button",{className:P("SegmentControlItem",{"SegmentControlItem--selected":n},t),onClick:()=>a(r),children:e(v,{variant:"b2",color:n?"primary":"surface",weight:n?"bold":"medium",children:s})})}const Bt="/assets/bin-ab4b9253.svg";function Tn(t){return{url:t.sceneUrl,preview_url:t.scenePreviewUrl,name:t.sceneName,description:t.sceneDescription,author_name:t.sceneAuthorName,license:t.sceneLicense,version:t.sceneVersion,author_url:t.sceneAuthorUrl,source_url:t.sceneSourceUrl}}function Dn({onSave:t,renderTrigger:r}){const[n,a]=f.useState(!1),s=()=>a(!0),i=()=>a(!1),[o,l]=f.useState({}),[d,u]=f.useState({}),m=b=>{b.preventDefault();const{sceneNameInput:C,sceneDescriptionInput:w,authorNameInput:x,licenseInput:h,authorURLInput:y,sourceURLInput:g}=b.target,k=C.value.trim(),N=w.value.trim(),D=x.value.trim(),B=h.value.trim(),te=y.value.trim()||void 0,re=g.value.trim()||void 0;o.mxc&&d.mxc&&(t({sceneUrl:o.mxc,scenePreviewUrl:d.mxc,sceneName:k,sceneDescription:N,sceneAuthorName:D,sceneLicense:B,sceneVersion:1,sceneAuthorUrl:te,sceneSourceUrl:re}),i())},p=!!o.mxc&&!!d.mxc;return c(U,{children:[r(s),e(ut,{open:n,onOpenChange:a,children:e(G,{className:"grow",children:e(jt,{children:e(G,{onSubmit:m,top:e(me,{left:e(oe,{children:"Scene Submission"})}),children:e(K,{children:c("div",{className:"SceneSubmission__content",children:[c("div",{className:"flex gap-md",children:[c(R,{className:"grow basis-0",label:e(_,{children:"Scene"}),children:[e(v,{className:"SceneSubmission__info-text",variant:"b3",color:"surface-low",children:"Upload a 3D scene (*.glb file)"}),e(we,{mimeType:".glb",onUploadInfo:l,renderButton:b=>c(S,{onClick:b,children:[e(L,{src:Ce,color:"on-primary"}),"Upload Scene"]})})]}),c(R,{className:"grow basis-0",label:e(_,{children:"Scene Preview"}),children:[e(v,{className:"SceneSubmission__info-text",variant:"b3",color:"surface-low",children:"Upload a preview image of 3D scene"}),e(we,{mimeType:"image/*",onUploadInfo:u,renderButton:b=>c(S,{onClick:b,children:[e(L,{src:Ce,color:"on-primary"}),"Upload Preview"]})})]})]}),c("div",{className:"flex gap-md",children:[e(R,{className:"grow basis-0",label:e(_,{children:"Name"}),children:e(J,{name:"sceneNameInput",required:!0})}),e(R,{className:"grow basis-0",label:e(_,{children:"Description"}),children:e(J,{name:"sceneDescriptionInput",required:!0})})]}),c("div",{className:"flex gap-md",children:[e(R,{className:"grow basis-0",label:e(_,{children:"Author Name"}),children:e(J,{name:"authorNameInput",required:!0})}),e(R,{className:"grow basis-0",label:e(_,{children:"License"}),children:e(J,{name:"licenseInput",required:!0})})]}),c("div",{className:"flex gap-md",children:[e(R,{className:"grow basis-0",label:e(_,{children:"Author URL (optional)"}),children:e(J,{name:"authorURLInput"})}),e(R,{className:"grow basis-0",label:e(_,{children:"Source URL (optional)"}),children:e(J,{name:"sourceURLInput"})})]})]})}),bottom:e(Te,{left:e(S,{onClick:i,fill:"outline",children:"Cancel"}),right:e(S,{type:"submit",disabled:!p,children:"Save"})})}),aside:e(zt,{className:"flex",children:e(Ue,{className:"grow",src:d.url,alt:"3D Avatar preview",fallback:e(v,{variant:"b3",color:"surface-low",weight:"medium",children:"Uploaded scene preview will appear here."})})})})})})]})}function gt(){return f.useMemo(()=>{const t=" ",r="~",a=()=>"NNNOOO",s=l=>{if(typeof l!="string"||l===""||l.length>6)return!1;for(let d=0;d<l.length;d=d+1){const u=l.charCodeAt(d);if(u<t.charCodeAt(0)||u>r.charCodeAt(0))return!1}return!0};return{getMidStr:a,validStr:s,getPrevStr:l=>{if(!s(l))return null;let d=l;const u=d.length-1,m=d.charCodeAt(u);if(m===t.charCodeAt(0))return d=d.slice(0,u),d.length===0?null:d;for(d=d.slice(0,u)+String.fromCharCode(m-1);d.length<6;)d=d+r;return d},getNextStr:l=>{if(!s(l))return null;let d=l;if(d.length<6)return d=d+t,d;for(let u=d.length-1;u>=0;u=u-1){const m=d.charCodeAt(u);if(m!==r.charCodeAt(0))return d=d.slice(0,u)+String.fromCharCode(m+1),d;d=d.slice(0,u)}return null}}},[])}function Vt(t,r,n,a){return async i=>{if(i<1)return!1;let o=a.getMidStr(),l=0;for(let d=i-1;d>=0;d=d-1){const m=n[d].content.order;if(a.validStr(m)){o=a.getNextStr(m),l=d+1;break}}for(let d=l;d<=i;d=d+1){if(d===i){const m=n[d-1],p=n[d];return t.hsApi.sendState(r,m.type,m.state_key,{...m.content,order:p.content.order}),t.hsApi.sendState(r,p.type,p.state_key,{...p.content,order:m.content.order}),!0}if(d+1===i){const m=n[d],p=n[d+1];return t.hsApi.sendState(r,m.type,m.state_key,{...m.content,order:p.content.order}),t.hsApi.sendState(r,p.type,p.state_key,{...p.content,order:o}),!0}if(!o)return!1;const u=n[d];t.hsApi.sendState(r,u.type,u.state_key,{...u.content,order:o}),o=a.getNextStr(o)}return!0}}function He({before:t,children:r,after:n}){return c("div",{className:"FeaturedItem flex items-center gap-md",children:[t&&e("div",{children:t}),e("div",{className:"grow",children:r}),n&&e("div",{children:n})]})}function Ma({room:t}){const{session:r,platform:n}=W(!0),a=xn(t),[s]=Ie(r,se.Room),i=s.filter(h=>!a.find(y=>y.state_key===h.id)),o=f.useRef(null),l=a.sort(ae),d=gt(),u=Vt(r,t.id,l,d),{callback:m,loading:p,error:b}=qe(async h=>{var B;if(!tn(h))throw Error("Invalid roomId");if(!(await(await ft(r,h)).json()).room_id)throw Error("Can not feature room. Either room is private or does not exist.");const k=l[0],N=(B=k==null?void 0:k.content)==null?void 0:B.order,D=d.getPrevStr(typeof N=="string"?N:d.getMidStr());await r.hsApi.sendState(t.id,$.FeaturedRoom,h,{suggested:!1,via:[],order:D??void 0})},[r,d]),C=h=>{window.confirm("Are you sure?")&&r.hsApi.sendState(t.id,$.FeaturedRoom,h,{})},w=h=>{const y=o.current;y&&(y.roomIdInput.value=h.id)};return c("div",{className:"flex flex-column gap-sm",children:[e(R,{label:e(_,{children:"Feature Public Room"}),children:c("div",{className:"flex flex-column gap-xxs",children:[c("form",{ref:o,onSubmit:h=>{h.preventDefault();const{roomIdInput:y}=h.target,g=y.value.trim();y.value="",g&&m(g)},className:"flex gap-sm",children:[e(J,{required:!0,name:"roomIdInput",placeholder:"Room Id",after:e(ye,{content:e(K,{style:{maxHeight:"200px",padding:"var(--sp-xs) 0"},children:i.length===0?e("div",{style:{padding:"0 var(--sp-md)"},children:e(v,{variant:"b2",weight:"medium",children:"No Rooms"})}):i.map(h=>c(F,{className:"flex items-center gap-xs",onSelect:()=>w(h),children:[e(H,{imageSrc:h.avatarUrl&&j(h.avatarUrl,60,n,r.mediaRepository),shape:"rounded",size:"xxs",bgColor:`var(--usercolor${q(h.id)})`,name:h.name??"Unknown room"}),e(v,{variant:"b2",weight:"medium",children:h.name})]},h.id))}),children:e(A,{iconSrc:ke,label:"View all"})})}),e(S,{type:"submit",disabled:p,children:"Feature"})]}),b&&e(v,{color:"danger",variant:"b3",children:b.message})]})}),l.length===0?null:e("div",{children:l.map((h,y)=>e(pt,{roomIdOrAlias:h.state_key,fallback:()=>e(He,{}),children:g=>c(He,{before:e(H,{imageSrc:g.avatarUrl&&j(g.avatarUrl,60,n,r.mediaRepository),shape:"rounded",size:"lg",bgColor:`var(--usercolor${q(g.roomId)})`,name:g.name}),after:c("div",{className:"flex gap-xs",children:[e(A,{size:"sm",label:"Remove Featured",iconSrc:Bt,onClick:()=>C(h.state_key)}),c("div",{className:"flex flex-column",children:[y>0&&e(A,{size:"sm",label:"Move Up",iconSrc:Pt,onClick:()=>u(y)}),y<l.length-1&&e(A,{size:"sm",label:"Move Down",iconSrc:ke,onClick:()=>u(y+1)})]})]}),children:[e(v,{className:"truncate",children:g.name}),e(v,{variant:"b3",className:"truncate",children:g.topic})]})},h.state_key))})]})}function Pa({room:t}){const{session:r,platform:n}=W(!0),a=yn(t),[s]=Ie(r,se.World),i=s.filter(h=>!a.find(y=>y.state_key===h.id)),o=f.useRef(null),l=a.sort(ae),d=gt(),u=Vt(r,t.id,l,d),{callback:m,loading:p,error:b}=qe(async h=>{var B;if(!tn(h))throw Error("Invalid roomId");if(!(await(await ft(r,h)).json()).room_id)throw Error("Can not feature world. Either world is private or does not exist.");const k=l[0],N=(B=k==null?void 0:k.content)==null?void 0:B.order,D=d.getPrevStr(typeof N=="string"?N:d.getMidStr());await r.hsApi.sendState(t.id,$.FeaturedWorld,h,{suggested:!1,via:[],order:D??void 0})},[r]),C=h=>{window.confirm("Are you sure?")&&r.hsApi.sendState(t.id,$.FeaturedWorld,h,{})},w=h=>{const y=o.current;y&&(y.roomIdInput.value=h.id)};return c("div",{className:"flex flex-column gap-sm",children:[e(R,{label:e(_,{children:"Feature Public World"}),children:c("div",{className:"flex flex-column gap-xxs",children:[c("form",{ref:o,onSubmit:h=>{h.preventDefault();const{roomIdInput:y}=h.target,g=y.value.trim();y.value="",g&&m(g)},className:"flex gap-sm",children:[e(J,{required:!0,name:"roomIdInput",placeholder:"Room Id",after:e(ye,{content:e(K,{style:{maxHeight:"200px",padding:"var(--sp-xs) 0"},children:i.length===0?e("div",{style:{padding:"0 var(--sp-md)"},children:e(v,{variant:"b2",weight:"medium",children:"No Worlds"})}):i.map(h=>c(F,{className:"flex items-center gap-xs",onSelect:()=>w(h),children:[e(H,{imageSrc:h.avatarUrl&&j(h.avatarUrl,60,n,r.mediaRepository),shape:"rounded",size:"xxs",bgColor:`var(--usercolor${q(h.id)})`,name:h.name??"Unknown world"}),e(v,{variant:"b2",weight:"medium",children:h.name})]},h.id))}),children:e(A,{iconSrc:ke,label:"View all"})})}),e(S,{type:"submit",disabled:p,children:"Feature"})]}),b&&e(v,{color:"danger",variant:"b3",children:b.message})]})}),l.length===0?null:e("div",{children:l.map((h,y)=>e(pt,{roomIdOrAlias:h.state_key,fallback:()=>e(He,{}),children:g=>c(He,{before:e(H,{imageSrc:g.avatarUrl&&j(g.avatarUrl,60,n,r.mediaRepository),shape:"circle",size:"lg",bgColor:`var(--usercolor${q(g.roomId)})`,name:g.name}),after:c("div",{className:"flex gap-xs",children:[e(A,{size:"sm",label:"Remove Featured",iconSrc:Bt,onClick:()=>C(h.state_key)}),c("div",{className:"flex flex-column",children:[y>0&&e(A,{size:"sm",label:"Move Up",iconSrc:Pt,onClick:()=>u(y)}),y<l.length-1&&e(A,{size:"sm",label:"Move Down",iconSrc:ke,onClick:()=>u(y+1)})]})]}),children:[e(v,{className:"truncate",children:g.name}),e(v,{variant:"b3",className:"truncate",children:g.topic})]})},h.state_key))})]})}function Ta({room:t}){const{session:r,platform:n}=W(!0),s=Lt(t).sort(ae),i=gt(),o=Vt(r,t.id,s,i),l=async u=>{const m=Tn(u);try{const b=(await r.hsApi.send(t.id,$.Scene,Mt(),{scene:m}).response()).event_id;if(!b)return;const w=s[0].content.order,x=i.getPrevStr(w);r.hsApi.sendState(t.id,$.FeaturedScene,b,{scene:m,order:x??void 0})}catch(p){console.error(p)}},d=u=>{window.confirm("Are you sure?")&&r.hsApi.sendState(t.id,$.FeaturedScene,u,{})};return c("div",{className:"flex flex-column gap-sm",children:[e(Dn,{onSave:l,renderTrigger:u=>e(R,{label:e(_,{children:"Feature Scene"}),children:e(S,{onClick:u,children:"Submit Scene"})})}),s.length===0?null:e("div",{children:s.sort(ae).map((u,m)=>c(He,{before:e(H,{imageSrc:u.content.scene.preview_url&&j(u.content.scene.preview_url,60,n,r.mediaRepository),shape:"circle",size:"lg",bgColor:`var(--usercolor${q(u.state_key)})`,name:u.content.scene.name}),after:c("div",{className:"flex gap-xs",children:[e(A,{size:"sm",label:"Remove Featured",iconSrc:Bt,onClick:()=>d(u.state_key)}),c("div",{className:"flex flex-column",children:[m>0&&e(A,{size:"sm",label:"Move Up",iconSrc:Pt,onClick:()=>o(m)}),m<s.length-1&&e(A,{size:"sm",label:"Move Down",iconSrc:ke,onClick:()=>o(m+1)})]})]}),children:[e(v,{className:"truncate",children:u.content.scene.name}),e(v,{variant:"b3",className:"truncate",children:u.content.scene.descripton})]},u.state_key))})]})}function Da({room:t,permissions:r}){return e(K,{children:e(G,{className:"DiscoverAdmin__content",children:c("div",{className:"flex flex-column gap-lg",children:[r.canFeatureRooms&&e(Ma,{room:t}),r.canFeatureWorlds&&e(Pa,{room:t}),r.canFeatureScenes&&e(Ta,{room:t})]})})})}function Oa({eventType:t,room:r}){const{session:n,platform:a}=W(!0);return e(K,{children:c(G,{className:"DiscoverAll__content",children:[t==$.FeaturedRoom&&e(ve,{children:e(Nn,{room:r,children:s=>s.length===0?null:e(U,{children:s.sort(ae).map(i=>e(kn,{session:n,platform:a,roomId:i.state_key},i.state_key))})})}),t==$.FeaturedWorld&&e(ve,{children:e(Sn,{room:r,children:s=>s.length===0?null:e(U,{children:s.sort(ae).map(i=>e(In,{session:n,platform:a,roomId:i.state_key},i.state_key))})})}),t===$.FeaturedScene&&e(ve,{children:e(An,{room:r,children:s=>s.length===0?null:e(ve,{itemMinWidth:300,gap:"md",children:s.sort(ae).map(i=>e(Pn,{session:n,roomId:r.id,stateEvent:i},i.state_key))})})})]})})}function Fa({badge:t,children:r}){return c("div",{className:"ThumbnailBadgeWrapper",children:[r,t&&e("div",{className:"ThumbnailBadgeWrapper__item",children:t})]})}const Ea=async(t,r,n)=>t.hsApi.messages(r,{dir:(n==null?void 0:n.dir)??"b",from:n==null?void 0:n.from,limit:(n==null?void 0:n.limit)??20,filter:{types:[$.Scene],senders:n==null?void 0:n.sender}}).response();function $a(t,r){const{session:n}=W(!0),[a,s]=f.useState([]),i=f.useRef({}),o=Pe(),[l,d]=f.useState(!1),u=f.useCallback(async(b,C)=>{d(!0),b&&(i.current={});const w=await Ea(n,t.id,{sender:r?[r]:void 0,from:C?i.current.end:i.current.start,dir:C?"b":"f",limit:10});!o()||!Array.isArray(w.chunk)||(b?(i.current={start:w.start,end:w.end},s(w.chunk)):(C?i.current.end=w.end:i.current.start=w.end,s(x=>C?[...x,...w.chunk]:[...w.chunk,...x])),d(!1))},[n,t,r,o]);f.useEffect(()=>{i.current={},u(!0,!0)},[u]);const m=b=>{s(C=>C.filter(w=>w.event_id!==b.event_id)),n.hsApi.redact(t.id,b.event_id,Mt(),{})},p=typeof i.current.end=="string";return{scenes:a,loading:l,loadScenes:u,canLoadBack:p,deleteScene:m}}function La({room:t,permissions:r}){const{session:n}=W(!0),[a,s]=f.useState(!1),i=gt(),o=Lt(t),l=g=>o.find(k=>k.state_key===g),{scenes:d,loading:u,loadScenes:m,canLoadBack:p,deleteScene:b}=$a(t,a?void 0:n.userId),C=g=>{var N;const k=(N=g==null?void 0:g.content)==null?void 0:N.scene;return typeof k!="object"?!1:!!(k.url&&k.preview_url&&k.name&&k.author_name)},w=g=>{if(!C(g))return;o.sort(ae);let k;if(o.length>0){const D=o[0].content.order;k=i.getPrevStr(D)}n.hsApi.sendState(t.id,$.FeaturedScene,g.event_id,{scene:g.content.scene,order:k??void 0})},x=g=>{n.hsApi.sendState(t.id,$.FeaturedScene,g.event_id,{})},h=g=>{C(g)&&window.open(`/scene-preview?url=${g.content.scene.url}`,"__blank")},y=async g=>{const k=Tn(g);await n.hsApi.send(t.id,$.Scene,Mt(),{scene:k}).response()};return e(K,{children:e(G,{className:"DiscoverCreator__content",children:e(tt,{label:c("div",{className:"flex items-center gap-md",children:[e(_,{className:"grow",children:"Scenes"}),c("div",{className:"flex items-center gap-sm",children:[e("button",{disabled:u,className:"DiscoverCreator__textBtn",onClick:async()=>m(!1,!1),children:e(v,{variant:"b3",weight:"bold",type:"span",children:"Refresh"})}),r.canFeatureScenes&&e("button",{className:"DiscoverCreator__textBtn",onClick:()=>s(g=>!g),children:e(v,{variant:"b3",weight:"bold",type:"span",children:a?"From: Everyone":"From: Me"})})]})]}),content:c("div",{className:"flex flex-column gap-md",children:[c(ve,{itemMinWidth:400,gap:"md",children:[c("a",{target:"_blank",href:"/docs/guides/unity/",className:"DiscoverCreator__unityButton flex flex-column items-center justify-center",children:[e(v,{color:"primary",type:"span",variant:"b1",weight:"semi-bold",children:"Third Room Unity Exporter"}),e(v,{color:"primary",type:"span",variant:"b3",children:"Read docs to create and export your own custom scenes"})]}),e(Dn,{onSave:async g=>{await y(g),m(!1,!1)},renderTrigger:g=>c("button",{onClick:g,className:"DiscoverCreator__sceneButton flex flex-column items-center justify-center",children:[e(L,{size:"xl",src:at}),e(v,{type:"span",variant:"b3",weight:"semi-bold",children:"Upload Scene"})]})}),d.map(g=>C(g)&&e(Rn,{thumbnail:e(Fa,{badge:l(g.event_id)&&e(ze,{content:"Featured"}),children:e(ge,{size:"lg",wide:!0,children:e(pe,{src:Re(n,g.content.scene.preview_url)??"",alt:g.content.scene.name})})}),children:c(Un,{children:[c("div",{className:"grow",children:[e(v,{className:"truncate",variant:"b3",children:g.content.scene.author_name}),e(v,{className:"truncate",children:g.content.scene.name})]}),e("div",{className:"flex items-center gap-xs",children:(r.canFeatureScenes||r.canRedact||n.userId===g.sender)&&e(ye,{content:c("div",{style:{padding:"var(--sp-xxs) 0"},children:[e(F,{onSelect:()=>h(g),children:"Preview"}),r.canFeatureScenes&&e(U,{children:l(g.event_id)?e(F,{onSelect:()=>x(g),children:"Un-Feature"}):e(F,{onSelect:()=>w(g),children:"Feature"})}),(r.canRedact||n.userId===g.sender)&&e(F,{onSelect:()=>{window.confirm("Are you sure?")&&b(g)},children:"Delete"})]}),children:e(A,{iconSrc:lt,label:"Delete Scene"})})})]})},g.event_id))]}),u?c("div",{className:"flex justify-center items-center gap-sm",children:[e(ie,{}),e(v,{children:"Loading"})]}):p&&e("div",{className:"flex justify-center items-center",children:e(S,{className:"DiscoverCreator__loadMore",onClick:()=>m(!1,!0),children:"Load More"})})]})})})})}var $=(t=>(t.FeaturedWorld="msc3948.repository_room.featured_world",t.FeaturedRoom="msc3948.repository_room.featured_room",t.FeaturedScene="msc3948.repository_room.featured_scene",t.Scene="msc3948.repository_room.scene",t))($||{});function za({room:t}){const{session:r}=W(!0),{getPowerLevel:n,canDoAction:a,canSendStateEvent:s}=Je(t),[i,o]=f.useState("Home"),[l,d]=f.useState(),[u,m]=f.useState(!0),p=n(r.userId),b=s("msc3948.repository_room.featured_room",p),C=s("msc3948.repository_room.featured_world",p),w=s("msc3948.repository_room.featured_scene",p),x=b||C;return!x&&i==="Admin"&&o("Home"),f.useEffect(()=>{let h,y=!0;return(async()=>{h=new AbortController,(await(await ft(r,t.id,h.signal)).json()).errcode==="M_UNRECOGNIZED"&&y&&m(!1)})(),()=>{y=!1,h==null||h.abort()}},[t.id,r]),e(ht,{className:"DiscoverView",children:e(G,{top:e(me,{left:c("div",{className:"flex items-center gap-xxs",children:[e("button",{style:{cursor:"pointer"},onClick:()=>d(void 0),children:e(oe,{icon:e(L,{color:"surface",className:"shrink-0",src:pn}),children:"Discover"})}),l?c(U,{children:[e(L,{src:Rt}),e(oe,{children:`All Public ${(()=>{if(l==="msc3948.repository_room.featured_room")return"Rooms";if(l==="msc3948.repository_room.featured_world")return"Worlds";if(l==="msc3948.repository_room.featured_scene")return"Scenes"})()}`})]}):null]}),center:l?null:c(Wa,{children:[e(kt,{value:"Home",isSelected:i==="Home",onSelect:o,children:"Home"}),e(kt,{value:"Creator",isSelected:i==="Creator",onSelect:o,children:"Creator"}),x&&e(kt,{value:"Admin",isSelected:i==="Admin",onSelect:o,children:"Admin"})]})}),children:l?e(Oa,{eventType:l,room:t}):c(U,{children:[i==="Home"&&t&&e(Ua,{supportRoomSummary:u,room:t,onLoadEvent:d}),i==="Creator"&&t&&e(La,{room:t,permissions:{canFeatureScenes:w,canRedact:a("redact",p)}}),i==="Admin"&&t&&e(Da,{room:t,permissions:{canFeatureRooms:b&&u,canFeatureWorlds:C&&u,canFeatureScenes:w}})]})})})}function ja(t,r){const{getPowerLevel:n,canSendStateEvent:a}=Je(r);return{checkForUpdate:async()=>{var l,d,u,m;if(!a("org.matrix.msc3815.world",n(t.userId)))return!1;try{const p=await(r==null?void 0:r.getStateEvent("org.matrix.msc3815.world")),b=(l=p==null?void 0:p.event)==null?void 0:l.content;if(!b)return!1;const C=(d=b.scene_from)==null?void 0:d.state_key,w=(u=b.scene_from)==null?void 0:u.room_id,x=((m=b.scene)==null?void 0:m.version)??1;if(C&&w){const h=await t.hsApi.state(w,$.FeaturedScene,C).response(),y=h==null?void 0:h.scene.version;if(typeof y=="number"&&y>x)return!0}}catch(p){console.warn(p)}return!1},updateScene:async()=>{var m,p,b,C;const o=await(r==null?void 0:r.getStateEvent("org.matrix.msc3815.world")),l=(m=o==null?void 0:o.event)==null?void 0:m.content;if(!l)return!1;const d=(p=l.scene_from)==null?void 0:p.state_key,u=(b=l.scene_from)==null?void 0:b.room_id;if(d&&u){const w=await t.hsApi.state(u,$.FeaturedScene,d).response();await t.hsApi.sendState(r.id,"org.matrix.msc3815.world","",{...((C=o==null?void 0:o.event)==null?void 0:C.content)??{},scene_url:w.scene.url,scene_preview_url:w.scene.preview_url,scene:w.scene,from:w.scene.from})}}}}function Ba({session:t,roomId:r}){const{invite:n,accept:a,reject:s}=Cn(t,r);return n===void 0?e(le,{title:"Failed to load Invite"}):e(le,{title:n.name,desc:`${n.inviter.name} invites you`,options:c("div",{className:"flex gap-xs",children:[!(n.accepting||n.accepted)&&e(S,{fill:"outline",onClick:s,disabled:n.rejecting,children:n.rejecting?e(ie,{color:"primary"}):"Reject"}),!(n.rejecting||n.rejected)&&e(S,{onClick:a,disabled:n.accepting,children:n.accepting?e(ie,{color:"on-primary"}):"Accept"})]})})}function Va({worldIdOrAlias:t}){const r=T(he),{session:n}=W(!0),{loading:a,error:s,callback:i}=qe(async l=>await n.joinRoom(l),[]),o=async l=>{const d=await i(l);d&&r(d)};return e(le,{title:t.startsWith("#")?t:"Unknown world",desc:s&&s.message,options:(()=>a?e(S,{variant:"secondary",disabled:!0,children:"Joining..."}):s?null:e(S,{variant:"secondary",onClick:()=>o(t),children:"Join World"}))()})}function Ha({room:t}){const{session:r,platform:n}=W(!0),a=cn("microphone"),s=ln(n,a),[i,o]=f.useState(),[l,d]=f.useState(!1),[u,m]=f.useState(!1),{navigateEnterWorld:p}=Dt(r),{exitWorld:b}=Or(),{checkForUpdate:C,updateScene:w}=ja(r,t),x=async()=>{b(),p(t)},h=async(g=!1)=>{if(d(!1),o(void 0),m(!0),g&&await C()){d(!0),m(!1);return}if(a==="granted"){m(!1),x();return}const[k,N]=await s(!0,!1);k&&(k.getAudioTracks().forEach(D=>D.stop()),m(!1),x()),N&&(o(N),m(!1))},y=async()=>{m(!0),d(!1),await w(),h()};return c(U,{children:[i&&e(nt,{open:!!i,title:"Microphone",content:c("div",{className:"flex flex-column gap-xs",children:[e(v,{variant:"b2",children:dn(i)}),e(v,{variant:"b2",children:"Connecting to other users may be unreliable without microphone access. We intend to fix this in the near future."})]}),buttons:e(S,{fill:"outline",onClick:x,children:"Enter without Microphone"}),requestClose:()=>o(void 0)}),l&&e(nt,{open:!!l,requestClose:()=>d(!1),title:"Update Scene",content:e("div",{className:"flex flex-column gap-xs",children:e(v,{variant:"b2",children:"New version of your world scene is available."})}),buttons:c("div",{className:"flex flex-column gap-xs",children:[e(S,{onClick:y,children:"Update"}),e(S,{fill:"outline",onClick:()=>h(),children:"Enter without Update"})]})}),e(S,{size:"lg",variant:"primary",disabled:u,onClick:()=>h(!0),children:u?"Entering...":"Enter World"})]})}function qa(){const{session:t}=W(!0),r=z(Et).worldId,n=z(he),[a,s]=on(),i=n||r,o=_e(t,i),[l,d]=f.useState(!1),{loading:u,error:m,value:p}=ga(t,i);return c("div",{className:"WorldPreview grow flex flex-column justify-end items-center",children:[o&&e(ne,{open:l,onOpenChange:d,children:e(dt,{room:o,requestClose:()=>d(!1)})}),(()=>{const b=s??a;return!i&&b?e(Va,{worldIdOrAlias:b}):p===void 0?u?e(le,{title:"Loading Room..."}):o===void 0?null:e(le,{title:"Loading Failed",desc:m?`Error loading world: ${m}`:"Unknown error occured"}):p&Ee.Replaced?null:p&Ee.BeingCreated?e(le,{title:"Creating Room..."}):p&Ee.Invited?i?e(Ba,{session:t,roomId:i}):e(le,{title:"Loading Room..."}):p&Ee.Archived?e(le,{title:"Room Archived"}):p&Ee.Joined?o&&e(le,{title:(o==null?void 0:o.name)||"Unnamed Room",memberCount:(o==null?void 0:o.joinedMemberCount)||0,onMembersClick:()=>d(!0),options:e(Ha,{room:o})}):e(le,{title:"Joining World..."})})()]})}function bt({className:t,children:r,aside:n}){const a=P("WindowContent flex",t);return c("div",{className:a,children:[e("div",{className:"WindowContent__main grow flex",children:r}),n&&e("aside",{className:"WindowContent__aside",children:n})]})}function wt({className:t,children:r}){const n=P("WindowAside",t);return e("div",{className:n,children:r})}function Ga(){const{session:t}=W(!0),r=T(Z),n=T(he),[a,s]=f.useState();return e(ht,{onRequestClose:()=>r({type:M.None}),children:e(G,{top:e(me,{left:e(oe,{icon:e(L,{className:"shrink-0",src:Zn,color:"surface"}),children:"Create World"}),right:e(A,{onClick:()=>r({type:M.None}),iconSrc:ce,label:"Close"})}),children:e(bt,{children:e(Mn,{onSceneChange:(o,l)=>s(l),onCreate:o=>{n(o),r({type:M.None})},onClose:()=>r({type:M.None})}),aside:e(wt,{className:"flex",children:e(Ue,{className:"grow",src:Re(t,a),fallback:e(v,{variant:"b3",color:"surface-low",weight:"medium",children:"Your scene preview will appear here."})})})})})})}function Ja({className:t,overlay:r,children:n}){return c("div",{className:P("ScenePreviewOverlay",t),children:[n,r&&e("div",{className:"ScenePreviewOverlay__overlay flex flex-column",children:r})]})}function Ya(t){const[r,n]=f.useState(),[a,s]=f.useState(),i=f.useCallback(o=>{if(o){const{content:l}=o;n(l.avatar_url),s(l.avatar_preview_url)}else n(void 0),s(void 0)},[]);return fr(t,"org.matrix.msc3815.world.profile","",i),[r,a]}function Qa(){const{session:t,platform:r,profileRoom:n}=W(!0),{displayName:a,avatarUrl:s}=z(Ut),i=T(Z),[o,l]=f.useState(a),[d,u]=$e("feature_immersiveAR",!1),[m,p]=$e(tr,Gt.Auto),[b,C]=$e("feature_sceneEditor",!1),w=nr(),x=f.useMemo(()=>{const I=Jt.find(E=>E.value===rr[w.quality]);return[{value:Gt.Auto,label:`Auto (${I==null?void 0:I.label})`},...Jt]},[w.quality]),[,h]=Ya(n);let y=s?j(s,150,r,t.mediaRepository)??void 0:void 0;const{fileData:g,pickFile:k,dropFile:N,resetUses:D}=vt(r,"image/*"),B=g.dropUsed>0||g.pickUsed>0;y=B?g.url:y;const te=Ft(l,{wait:200});return e(bt,{children:e(G,{onSubmit:async I=>{I.preventDefault(),i({type:M.None});const E=I.currentTarget.displayName.value.trim();if(E!==a&&E!==""&&t.hsApi.setProfileDisplayName(t.userId,E),B){let ee="";typeof g.blob=="object"&&(ee=await Wt(t.hsApi,g.blob)??""),t.hsApi.setProfileAvatarUrl(t.userId,ee)}},onReset:()=>{l(a),D(),i({type:M.None})},children:e(K,{children:c("div",{className:"UserProfileOverview__content",children:[e(R,{label:e(_,{children:"Profile Picture"}),children:e(it,{url:y,onAvatarPick:k,onAvatarDrop:N})}),c("div",{className:"flex gap-lg",children:[e(R,{className:"grow basis-0",label:e(_,{children:"Default Display Name"}),children:e(J,{name:"displayName",onChange:I=>{const E=I.currentTarget.value.trim();te(E)},defaultValue:a,required:!0})}),e("span",{className:"grow basis-0"})]}),c("div",{className:"flex gap-lg",children:[e(R,{className:"grow basis-0",label:e(_,{children:"Graphics Quality (REQUIRES REFRESH)"}),children:e(er,{options:x,value:m,onChange:p})}),e("span",{className:"grow basis-0"})]}),c("div",{className:"flex gap-lg",children:[e(R,{className:"grow basis-0",label:e(_,{children:"Immersive AR (EXPERIMENTAL, REQUIRES REFRESH)"}),children:e(rt,{checked:d,onCheckedChange:u})}),e("span",{className:"grow basis-0"})]}),c("div",{className:"flex gap-lg",children:[e(R,{className:"grow basis-0",label:e(_,{children:"Scene Editor (EXPERIMENTAL, REQUIRES REFRESH)"}),children:e(rt,{checked:b,onCheckedChange:C})}),e("span",{className:"grow basis-0"})]})]})}),bottom:(a!==o||B)&&e(Te,{left:e(S,{fill:"outline",type:"reset",children:"Cancel"}),right:e(S,{type:"submit",children:"Save"})})}),aside:e(wt,{className:"flex",children:e(Ja,{className:"grow flex",overlay:!1,children:e(Ue,{className:"grow",src:Re(t,h),alt:"3D Avatar preview",fallback:!1})})})})}function Xa(){return e(bt,{children:e(G,{children:e(K,{children:e("div",{className:"UserProfileInventory__content"})})}),aside:e(wt,{className:"flex",children:e(Ue,{className:"grow",fallback:e(v,{variant:"b3",color:"surface-low",weight:"medium",children:"Your default avatar preview will appear here."})})})})}function Ka(){const{session:t,platform:r}=W(!0),n=T(Z),{userId:a,displayName:s,avatarUrl:i}=z(Ut),[o]=f.useState("Overview");return c(ht,{onRequestClose:()=>n({type:M.None}),children:[e(me,{left:e(oe,{icon:e(H,{name:s,bgColor:`var(--usercolor${q(a)})`,imageSrc:i?j(i,20,r,t.mediaRepository):void 0,shape:"circle",size:"xxs"}),children:"User Settings"}),right:e(A,{onClick:()=>n({type:M.None}),iconSrc:ce,label:"Close"})}),o==="Overview"&&e(Qa,{}),o==="Inventory"&&e(Xa,{})]})}function Ct({children:t}){return e("div",{className:"AvatarOutline",children:t})}function je({avatar:t,content:r,options:n,isActive:a=!1,isFocused:s=!1,onClick:i}){const o=P("RoomTile",{"RoomTile--active":a},{"RoomTile--focused":s},"flex items-center");return c("div",{className:o,children:[c("button",{onClick:i,className:"grow flex items-center gap-sm",children:[e("div",{className:"RoomTile__avatar shrink-0 flex",children:t}),e("div",{className:"RoomTile__content grow",children:r})]}),n&&e("div",{className:"RoomTile__options shrink-0",children:n})]})}function Be({className:t,children:r}){return e(v,{className:P("truncate",t),weight:"medium",children:r})}function Za({children:t}){return e("div",{className:"AvatarPile",children:t})}const It=5;function es({session:t,platform:r,groupCall:n}){const s=[...Tt(()=>n.members,[n]).values()].reduce((i,o)=>(i.has(o.userId)||i.set(o.userId,o),i),new Map);return s.size===0?null:c(Za,{children:[Array.from(s.values()).slice(0,It).map(({member:i},o)=>e(be,{content:i.name,side:"top",children:e(H,{style:o>0?{marginLeft:"calc(-1 * var(--av-xxs) / 4)"}:{},name:i.displayName||qn(i.userId),bgColor:`var(--usercolor${q(i.userId)})`,imageSrc:i.avatarUrl?j(i.avatarUrl,20,r,t.mediaRepository):void 0,shape:"circle",size:"xxs"})},i.userId)),s.size>It?e(v,{variant:"b3",type:"span",children:`+${s.size-It}`}):void 0]})}function ts({isSelected:t,onSelect:r,room:n,groupCall:a,platform:s,session:i}){const{getPowerLevel:o,canSendStateEvent:l}=Je(n),d=T(Z),u=T(Se),[m,p]=f.useState(!1),{open:b,setOpen:C,openDialog:w,closeDialog:x}=Ae(!1),{open:h,setOpen:y,openDialog:g,closeDialog:k}=Ae(!1);return e(je,{isActive:t,isFocused:m,avatar:(N=>{const D=e(H,{name:N.name||"Empty room",size:"xl",shape:"circle",className:"shrink-0",bgColor:`var(--usercolor${q(N.id)})`,imageSrc:N.avatarUrl?j(N.avatarUrl,50,s,N.mediaRepository):void 0});return t?e(Ct,{children:D}):D})(n),onClick:()=>r(n.id),content:c(U,{children:[e(Be,{children:n.name||"Empty room"}),a&&e(es,{session:i,platform:s,groupCall:a})]}),options:c(U,{children:[e(ne,{open:b,onOpenChange:C,children:e(dt,{room:n,requestClose:x})}),e(ne,{open:h,onOpenChange:y,children:e(Ot,{roomId:n.id,requestClose:k})}),e(ye,{side:"right",onOpenChange:p,content:c(U,{children:[e(F,{onSelect:()=>u({type:"OPEN",roomId:n.id}),children:"Chat"}),e(F,{onSelect:g,children:"Invite"}),e(F,{onSelect:w,children:"Members"}),l(void 0,o(i.userId))&&e(F,{onSelect:()=>d({type:M.WorldSettings,roomId:n.id}),children:"Settings"}),e(F,{variant:"danger",onSelect:()=>{confirm("Are you sure?")&&n.leave()},children:"Leave"})]}),children:e(A,{label:"Options",iconSrc:lt})})]})},n.id)}function On({isSelected:t,onSelect:r,room:n,platform:a}){var x;const[s,i]=f.useState(!1),o=un(n),{open:l,setOpen:d,openDialog:u,closeDialog:m}=Ae(!1),{open:p,setOpen:b,openDialog:C,closeDialog:w}=Ae(!1);return e(je,{isActive:t,isFocused:s,avatar:(h=>{const y=e(H,{name:h.name||"Empty room",size:"lg",shape:h.isDirectMessage?"circle":"rounded",className:"shrink-0",bgColor:`var(--usercolor${q(h.id)})`,imageSrc:h.avatarUrl?j(h.avatarUrl,50,a,h.mediaRepository):void 0});return t?e(Ct,{children:y}):y})(n),onClick:()=>r(n.id),content:c(U,{children:[c("div",{className:"flex items-center gap-xxs",children:[e(Be,{className:"grow",children:n.name||"Empty room"}),(n.isUnread||n.notificationCount>0)&&e(ze,{content:n.notificationCount>0?n.notificationCount:void 0})]}),((x=o==null?void 0:o.content)==null?void 0:x.body)&&e(v,{variant:"b3",className:"truncate",children:`${o.displayName||o.sender}: ${o.content.body}`})]}),options:c(U,{children:[e(ne,{open:l,onOpenChange:d,children:e(dt,{room:n,requestClose:m})}),e(ne,{open:p,onOpenChange:b,children:e(Ot,{roomId:n.id,requestClose:w})}),e(ye,{side:"right",onOpenChange:i,content:c(U,{children:[e(F,{onSelect:C,children:"Invite"}),e(F,{onSelect:u,children:"Members"}),e(F,{variant:"danger",onSelect:()=>{confirm("Are you sure?")&&n.leave()},children:"Leave"})]}),children:e(A,{label:"Options",iconSrc:lt})})]})},n.id)}function yt({className:t,style:r,heading:n,text:a,actions:s}){return c("div",{style:r,className:P("EmptyState text-center flex flex-column justify-center items-center gap-md",t),children:[c("div",{className:"flex flex-column gap-xs",children:[e(v,{weight:"semi-bold",children:n}),e(v,{variant:"b3",children:a})]}),s&&e("div",{className:"flex gap-xs",children:s})]})}function ns({groupCalls:t}){const{session:r,platform:n}=W(!0),[a]=Ie(r,se.World),[s]=Ie(r,se.Room),[i,o]=f.useState(!0),[l,d]=f.useState(!0),u=z(Ye),m=T(Se),[p,b]=ue(he),C=T(Z);return a.length===0&&s.length===0?e(yt,{style:{minHeight:"400px"},heading:"No Worlds",text:"You havent joined any worlds yet.",actions:e(S,{onClick:()=>C({type:M.CreateWorld}),children:"Create World"})}):c(U,{children:[a.length>0&&e(We,{header:e(Me,{title:"Worlds",after:e(L,{src:i?ke:Rt,size:"sm",color:"surface"}),onClick:()=>o(!i)}),children:i&&a.map(w=>{const x=t.get(w.id);return e(ts,{isSelected:p===w.id,onSelect:b,room:w,groupCall:x,session:r,platform:n},w.id)})}),s.length>0&&e(We,{header:e(Me,{title:"Rooms",after:e(L,{src:l?ke:Rt,size:"sm",color:"surface"}),onClick:()=>d(!l)}),children:l&&s.map(w=>e(On,{isSelected:w.id===u,onSelect:x=>m({type:"OPEN",roomId:x}),room:w,platform:n},w.id))})]})}function rs(){const{session:t,platform:r}=W(!0),[n]=Ie(t,se.Direct),{open:a,setOpen:s,openDialog:i,closeDialog:o}=Ae(!1),l=z(Ye),d=T(Se);return n.length===0?e(yt,{style:{minHeight:"400px"},heading:"No Friends",text:"You don't have any friends yet.",actions:c(U,{children:[e(ne,{open:a,onOpenChange:s,children:e(gn,{requestClose:o})}),e(S,{onClick:i,children:"Direct Message"})]})}):e("div",{children:n.map(u=>e(On,{isSelected:u.id===l,onSelect:m=>d({type:"OPEN",roomId:m}),room:u,platform:r},u.id))})}function as({room:t}){const{session:r,platform:n}=W(!0),a=T(Z),{getPowerLevel:s,canSendStateEvent:i}=Je(t),o=s(r.userId),l=Pe();let d=t!=null&&t.avatarUrl?j(t.avatarUrl,150,n,r.mediaRepository)??void 0:void 0;const{fileData:u,pickFile:m,dropFile:p}=vt(n,"image/*"),b=(d||u.blob)&&(u.dropUsed>0||u.pickUsed>0);d=b?u.url:d;const C=(t==null?void 0:t.name)??"Empty Name",[w,x]=f.useState(C),h=f.useRef(!0),[y,g]=f.useState(!0),[k,N]=f.useState({}),[D,B]=f.useState({}),[te,re]=f.useState({}),[xe,Oe]=f.useState({});f.useEffect(()=>{t&&(t.getStateEvent("m.room.join_rules").then(O=>{var V,Y;l()&&(h.current=((V=O==null?void 0:O.event)==null?void 0:V.content.join_rule)!=="public",g(((Y=O==null?void 0:O.event)==null?void 0:Y.content.join_rule)!=="public"))}),Promise.all([t.getStateEvent("m.world"),t.getStateEvent("org.matrix.msc3815.world")]).then(([O,V])=>{var Ke,Fe;if(!l())return;const Y=(Ke=O==null?void 0:O.event)==null?void 0:Ke.content,Q=(Fe=V==null?void 0:V.event)==null?void 0:Fe.content;N({sceneUrl:(Q==null?void 0:Q.scene_url)||(Y==null?void 0:Y.scene_url),previewUrl:(Q==null?void 0:Q.scene_preview_url)||(Y==null?void 0:Y.scene_preview_url)});const fe=(Q==null?void 0:Q.max_member_object_cap)??Le;E.current=fe,Qe(fe)}).catch(console.error))},[t,l]);const I=O=>x(O.target.value.trim()),E=f.useRef(Le),[ee,Qe]=f.useState(Le),Xe=O=>Qe(parseInt(O.target.value)||0);return e(ht,{onRequestClose:()=>a({type:M.None}),children:e(G,{onSubmit:O=>{O.preventDefault(),t&&(b&&(async()=>{let V="";u.blob&&(V=await Wt(r.hsApi,u.blob)??""),r.hsApi.sendState(t.id,"m.room.avatar","",{url:V})})(),h.current!==y&&r.hsApi.sendState(t.id,"m.room.join_rules","",{join_rule:y?"invite":"public"}),C!==w&&w.trim()!==""&&r.hsApi.sendState(t.id,"m.room.name","",{name:w}),(D.mxc||te.mxc||ee!==E.current||xe.mxc)&&Promise.all([t.getStateEvent("m.world"),t.getStateEvent("org.matrix.msc3815.world")]).then(([V,Y])=>{var Fe,qt;const Q=(Fe=V==null?void 0:V.event)==null?void 0:Fe.content,fe=(qt=Y==null?void 0:Y.event)==null?void 0:qt.content,Ke=Y==null?void 0:Y.event.content.script_url;r.hsApi.sendState(t.id,"org.matrix.msc3815.world","",{max_member_object_cap:ee,scene_url:D.mxc??((fe==null?void 0:fe.scene_url)||(Q==null?void 0:Q.scene_url)),scene_preview_url:te.mxc??((fe==null?void 0:fe.scene_preview_url)||(Q==null?void 0:Q.scene_preview_url)),script_url:xe.mxc||Ke})}),a({type:M.None}))},top:e(me,{left:e(oe,{children:"World Settings"}),right:e(A,{onClick:()=>a({type:M.None}),label:"Close",iconSrc:ce})}),children:e(bt,{children:e(G,{children:e(K,{children:c("div",{className:"WorldSettings__content",children:[i("m.room.avatar",o)&&e("div",{className:"flex gap-lg",children:e(R,{label:e(_,{children:"World Avatar"}),children:e(it,{url:d,onAvatarPick:m,onAvatarDrop:p})})}),(i("m.room.name",o)||i("m.room.join_rules",o))&&c("div",{className:"flex gap-lg",children:[i("m.room.name",o)&&e(R,{className:"grow basis-0",label:e(_,{children:"World Name *"}),children:e(J,{onChange:I,defaultValue:C,required:!0})}),i("m.room.join_rules",o)&&e(R,{className:"grow basis-0",label:e(_,{children:"Private"}),children:e(rt,{checked:y,onCheckedChange:g})})]}),i("org.matrix.msc3815.world",o)&&c("div",{className:"flex gap-lg",children:[e(R,{className:"grow basis-0",label:e(_,{children:"Scene"}),children:e(we,{mimeType:".glb",onUploadInfo:B,renderButton:O=>c(S,{fill:"outline",onClick:O,children:[e(L,{src:Ce,color:"primary"}),"Change Scene"]})})}),e(R,{className:"grow basis-0",label:e(_,{children:"Scene Preview"}),children:e(we,{mimeType:"image/*",onUploadInfo:re,renderButton:O=>c(S,{fill:"outline",onClick:O,children:[e(L,{src:Ce,color:"primary"}),"Change Preview"]})})})]}),i("org.matrix.msc3815.world",o)&&e("div",{className:"flex gap-lg",children:e(R,{className:"grow basis-0",label:e(_,{children:"Max Spawned Objects Per User"}),children:e(J,{type:"number",value:ee,onChange:Xe,required:!0})})}),i("org.matrix.msc3815.world",o)&&e("div",{className:"flex gap-lg",children:e(R,{className:"grow basis-0",label:e(_,{children:"Script (EXPERIMENTAL)"}),children:e(we,{mimeType:".js,.wasm",onUploadInfo:Oe,renderButton:O=>c(S,{fill:"outline",onClick:O,children:[e(L,{src:Ce,color:"primary"}),"Change Script"]})})})}),e(yt,{className:"WorldSettings__empty-state",heading:"Permission Required",text:"You do not have sufficient permissions to change any of the settings."})]})}),bottom:e(Te,{left:e(S,{size:"lg",fill:"outline",onClick:()=>a({type:M.None}),children:"Cancel"}),right:e(S,{size:"lg",type:"submit",disabled:!b&&h.current===y&&C===w&&!D.mxc&&!te.mxc&&ee===E.current&&!xe.mxc,children:"Save"})})}),aside:e(wt,{className:"flex",children:e(Ue,{className:"grow",src:te.url??Re(r,k.previewUrl),alt:"Scene Preview",fallback:e(v,{variant:"b3",color:"surface-low",weight:"medium",children:"Your uploaded scene preview will appear here."})})})})})})}function ss(t,r){return r.timestamp-t.timestamp}function At(t,r){const[n,a]=f.useState(r);return[mt(()=>t.invites.filterValues(s=>vn(s,n)).sortValues(ss),[t.invites,n]),a]}function is(){const{session:t,platform:r}=W(!0),[n]=At(t,se.World),[a]=At(t,se.Room),[s]=At(t,se.Direct),i=z(Ye),o=T(Se),[l,d]=ue(he),u=(m,p)=>{const b=e(H,{name:m.name||"Empty room",size:p?"xl":"lg",shape:p||m.isDirectMessage?"circle":"rounded",className:"shrink-0",bgColor:`var(--usercolor${q(m.id)})`,imageSrc:m.avatarUrl?j(m.avatarUrl,50,r,m.mediaRepository):void 0});return i===m.id||l===m.id?e(Ct,{children:b}):b};return n.length===0&&a.length===0&&s.length===0?e(yt,{style:{minHeight:"400px"},heading:"No Notification",text:"You don't have any notifications yet."}):c(U,{children:[n.length>0&&e(We,{header:e(Me,{title:"Invites - Worlds"}),children:n.map(m=>e(je,{avatar:u(m,!0),content:e(Be,{children:m.name||"Empty room"}),onClick:()=>d(m.id)},m.id))}),a.length>0&&e(We,{header:e(Me,{title:"Invites - Rooms"}),children:a.map(m=>e(je,{avatar:u(m,!1),content:e(Be,{children:m.name||"Empty room"}),onClick:()=>o({type:"OPEN",roomId:m.id})},m.id))}),s.length>0&&e(We,{header:e(Me,{title:"Invites - Direct Messages"}),children:s.map(m=>e(je,{avatar:u(m,!1),content:e(Be,{children:m.name||"Empty room"}),onClick:()=>o({type:"OPEN",roomId:m.id})},m.id))})]})}function os({avatar:t,content:r,options:n,leftControls:a,rightControls:s}){return c("div",{className:"NowPlaying",children:[c("div",{className:"NowPlaying__main flex items-center",children:[e("div",{className:"shrink-0",children:t}),e("div",{className:"grow",children:r}),n&&e("div",{className:"shrink-0",children:n})]}),c("div",{className:"NowPlaying__controls flex",children:[e("div",{className:"grow flex",children:a}),s&&e("div",{className:"flex",children:s})]})]})}const cs="/assets/network-d37fe473.svg";function ls({status:t,children:r}){const n=t==="connected"?"secondary":"danger";return c("div",{className:"NowPlayingStatus flex items-baseline",style:{gap:"var(--sp-xxs)"},children:[e(L,{color:n,size:"xs",src:cs}),e(v,{color:n,className:"truncate",variant:"b3",weight:"bold",children:r})]})}function ds({children:t}){return e(v,{className:"truncate",children:t})}function us({world:t,activeCall:r,onExitWorld:n,platform:a}){const{session:s}=W(!0),i=T(Se),o=z(Ye),l=T(Z),{getPowerLevel:d,canSendStateEvent:u}=Je(t),[m,p]=f.useState(!1),[b,C]=f.useState(!1),{mute:w,requestStream:x,handleMute:h,micException:y,setMicException:g}=pr(r);return e(os,{avatar:e(Ct,{children:e(H,{shape:"circle",size:"lg",name:t.name||"Unnamed World",bgColor:`var(--usercolor${q(t.id)})`,imageSrc:t.avatarUrl&&j(t.avatarUrl,70,a,t.mediaRepository)})}),content:c(U,{children:[e(ls,{status:"connected",children:"Connected"}),e(ds,{children:t.name||"Unnamed World"})]}),options:e(be,{side:"top",content:o===t.id?"Minimize Chat":"Open Chat",children:e(A,{onClick:()=>i({type:o===t.id?"MINIMIZE":"OPEN",roomId:t.id}),variant:"surface-low",label:"Options",iconSrc:vr})}),leftControls:c(U,{children:[e(gr,{micException:y,setMicException:g}),e(be,{content:w?"Unmute":"Mute",children:e(A,{variant:"surface-low",label:"Mic",iconSrc:w?mn:hn,onClick:()=>{h(async()=>br(x,g))}})}),e(be,{content:"Disconnect",children:e(A,{variant:"danger",label:"Disconnect",iconSrc:wr,onClick:n})})]}),rightControls:c(U,{children:[e(ne,{open:m,onOpenChange:p,children:e(dt,{room:t,requestClose:()=>p(!1)})}),e(ne,{open:b,onOpenChange:C,children:e(Ot,{roomId:t.id,requestClose:()=>C(!1)})}),e(ye,{content:c(U,{children:[e(F,{onSelect:()=>C(!0),children:"Invite"}),e(F,{onSelect:()=>p(!0),children:"Members"}),u(void 0,d(s.userId))&&e(F,{onSelect:()=>l({type:M.WorldSettings,roomId:t.id}),children:"Settings"})]}),children:e(A,{variant:"surface-low",label:"Options",iconSrc:lt})})]})})}function ms(){const{platform:t}=W(!0),r=cn("microphone"),n=ln(t,r),[a,s]=f.useState(),[i,o]=Cr();return c("div",{className:"NowPlayingControls shrink-0 flex items-center",children:[a&&e(nt,{open:!!a,title:"Microphone",content:e(v,{variant:"b2",children:dn(a)}),requestClose:()=>s(void 0)}),e(be,{content:i?"Mute":"Unmute",children:e(A,{variant:"surface-low",label:"Mic",iconSrc:i?hn:mn,onClick:async()=>{if(r=="granted")o(!i);else if(i)o(!1);else{const[l,d]=await n(!0,!1);d?s(d):(o(!!l),l==null||l.getAudioTracks().forEach(u=>{u.stop()}))}}})})]})}function hs(){const{session:t,platform:r}=W(!0),n=yr(t),a=z(Ye),[s,i]=ue(Se),o=z(he),l=z(De),{worldId:d,entered:u}=z(Et),m=_e(t,nn.repositoryRoomIdOrAlias),p=Sr(n,d),{navigateExitWorld:b}=Dt(t),C=_e(t,u?d:void 0),w=_e(t,a),x=wn(t,a),h=z(Z),y=new Map;Array.from(n).flatMap(([,N])=>y.set(N.roomId,N));const g=_e(t,h.type===M.WorldSettings?h.roomId:void 0);xr();const k=w||x;return c("div",{className:P("Overlay",{"Overlay--no-bg":!u},"flex items-end"),children:[e(Fr,{spaces:e(qr,{}),roomList:h.type===M.None&&e(Gr,{header:e(Yr,{}),content:c(Qr,{children:[l===X.Home&&e(ns,{groupCalls:y}),l===X.Friends&&e(rs,{}),l===X.Notifications&&e(is,{})]}),footer:C&&p?e(us,{world:C,activeCall:p,onExitWorld:b,platform:r}):e(ms,{})})}),h.type!==M.None?c("div",{className:"Overlay__window grow flex",children:[h.type===M.CreateWorld&&e(Ga,{}),h.type===M.UserProfile&&e(Ka,{}),h.type===M.WorldSettings&&g&&e(as,{room:g}),h.type===M.Discover&&m&&e(za,{room:m})]}):c("div",{className:"Overlay__content grow",children:[d&&d===o||k?void 0:e(qa,{}),s.size===0?void 0:e(Xr,{chat:k&&c(ea,{children:[e(ra,{platform:r,session:t,room:w||x,onMinimize:N=>i({type:"MINIMIZE",roomId:N}),onClose:N=>i({type:"CLOSE",roomId:N})}),w&&e(ha,{room:w}),x&&e(fa,{session:t,roomId:x.id})]}),tiles:[...s].map(N=>{const D=t.rooms.get(N)??t.invites.get(N);if(!D)return null;const B=N===a,te=D.name||"Empty room";return e(Zr,{isActive:B,roomId:N,avatar:e(H,{size:"sm",imageSrc:D.avatarUrl?j(D.avatarUrl,50,r,t.mediaRepository):void 0,name:te,bgColor:`var(--usercolor${q(D.id)})`}),title:te,onClick:re=>i({type:B?"MINIMIZE":"OPEN",roomId:re}),onClose:re=>i({type:"CLOSE",roomId:re})},N)})})]})]})}function fs(t,r){return r.lastMessageTimestamp-t.lastMessageTimestamp}function ps(t){return mt(()=>t.rooms.sortValues(fs),[t.rooms])}const vs=Ge(!1),Fn=Ge(void 0),En=Ge(!1),Xt="io.thirdroom.whats_new";function $n(){const{session:t,platform:r}=W(!0),[n,a]=ue(vs);return f.useEffect(()=>{async function i(){const o=await t.getAccountData(Xt),{whatsNewVersion:l}=r.config,d=o==null?void 0:o.version;(typeof d!="number"||d<l)&&a(!0)}i().catch(console.error)},[t,r.config,a]),{whatsNew:n,finishWhatsNew:()=>{a(!1),t.setAccountData(Xt,{version:r.config.whatsNewVersion})}}}function gs(){const{whatsNew:t,finishWhatsNew:r}=$n(),[n,a]=ue(Fn),s=z(En);return!t||n||s?null:c("div",{className:"flex items-center gap-xxs",style:{padding:"var(--sp-xxs) var(--sp-xs)",background:"var(--bg-primary)",borderRadius:"var(--br-xs)"},children:[e("div",{className:"shrink-0 flex",children:e(A,{variant:"on-primary",size:"sm",iconSrc:ce,label:"Close",onClick:()=>{window.confirm("This action is permanent. Are you sure?")&&r()}})}),e("button",{className:"grow flex items-center",style:{cursor:"pointer"},type:"button",onClick:()=>a(!0),children:e(v,{variant:"b3",className:"truncate",type:"span",color:"on-primary",weight:"medium",children:"The Creator Update is out! "})})]})}function Ln({style:t,children:r,onClick:n}){return e("button",{className:"OverlayButton",style:t,onClick:n,type:"button",children:r})}function bs(t){var l;const[,r]=f.useReducer(d=>d+1,0),n=f.useRef({count:void 0,eventEntry:void 0}),a=ps(t).filter(d=>!d.type),s=a.reduce((d,u)=>d+u.notificationCount,0),i=un(a[0]);n.current.count!==s&&(n.current.eventEntry=i,setTimeout(()=>{i===n.current.eventEntry&&(n.current.eventEntry=void 0,n.current.count=s,r())},5e3));const o=n.current.count;return{notifCount:s,eventEntry:o!==void 0&&s>o?n.current.eventEntry:void 0,roomId:(l=a[0])==null?void 0:l.id}}function ws({onClick:t}){const{session:r,platform:n}=W(!0),{notifCount:a,eventEntry:s,roomId:i}=bs(r),o=T(Se);return e(Ln,{onClick:()=>{t(),s&&o({type:"OPEN",roomId:i})},children:s?c(U,{children:[e(H,{className:"shrink-0",shape:"circle",size:"xxs",imageSrc:s.avatarUrl?j(s.avatarUrl,20,n,r.mediaRepository):void 0,bgColor:`var(--usercolor${q(s.sender)})`,name:s.displayName}),e(v,{variant:"b3",className:"truncate",color:"world",children:`${s.displayName}: ${s.content.body}`})]}):e(v,{variant:"b3",color:"world",children:`${a} Notifications`})})}function Cs(){const{session:t}=W(!0),[r,n]=ue(fn),a=T(_r),s=T(De),o=Gn({path:"/",end:!0})!==null,[l]=Nr(),d=l?t.rooms.get(l):void 0,u=()=>{r?n(!1):(document.exitPointerLock(),a(!1),n(!0))},m=()=>{r?n(!1):(document.exitPointerLock(),a(!1),n(!0),s(X.Notifications))};return c("div",{className:"StatusBar shrink-0 flex items-center",children:[e("div",{className:"StatusBar__left grow basis-0 flex",children:l&&c(Ln,{style:{paddingLeft:"var(--sp-xxs)"},onClick:u,children:[e(v,{color:"world",weight:"medium",variant:"b3",style:{padding:"0 3px",borderRadius:"var(--br-xxs)",border:"1px solid var(--bg-world-border)"},children:"ESC"}),e(v,{className:"flex items-center",color:"world",variant:"b3",children:r?"Close Overlay":"Open Overlay"})]})}),e("div",{className:"StatusBar__center",children:e(v,{color:"world",weight:"semi-bold",children:o?"Home":(d==null?void 0:d.name)??(d==null?void 0:d.canonicalAlias)??"Unknown"})}),c("div",{className:"StatusBar__right grow basis-0 flex justify-end gap-xxs",children:[e(gs,{}),l&&e(ws,{onClick:m})]})]})}async function ys(t){return await t.createRoom({type:Zt.World,visibility:Ve.Private,avatar:de.home.defaultAvatar,name:"Home World",isEncrypted:!1,isFederationDisabled:!1,powerLevelContentOverride:{invite:100,kick:100,ban:100,redact:100,state_default:100,events_default:100,users_default:0,events:{"m.room.power_levels":100,"m.room.history_visibility":100,"m.room.tombstone":100,"m.room.encryption":100,"m.room.name":100,"m.room.message":0,"m.room.encrypted":100,"m.sticker":0,"org.matrix.msc3401.call.member":0,"org.matrix.msc3815.member.world":0},users:{[t.userId]:100}},initialState:[{type:"org.matrix.msc3815.world",content:{version:de.home.version,scene_url:de.home.sceneUrl,scene_preview_url:de.home.scenePreviewUrl,home:!0}}]})}async function Ss(t,r){const n=t.rooms.get(r.room_id);if(!n)throw new Error("Home world not found");await t.hsApi.sendState(n.id,"org.matrix.msc3815.world","",{scene_url:de.home.sceneUrl,scene_preview_url:de.home.scenePreviewUrl}).response()}function xs(){const{session:t}=W(!0),[r,n]=f.useState();return f.useEffect(()=>{async function a(){var i;const s=await t.getAccountData("org.matrix.msc3815.world.home");if(s&&s.version&&s.version>=4&&t.rooms.get(s.room_id))s.version<de.home.version&&(await Ss(t,s),await t.setAccountData("org.matrix.msc3815.world.home",{version:de.home.version,room_id:s.room_id})),n(s.room_id);else{s&&s.version&&s.version<=3&&await((i=t.rooms.get(s.room_id))==null?void 0:i.leave());const o=await ys(t),l=await ot(t,o);n(l.id),await t.setAccountData("org.matrix.msc3815.world.home",{version:de.home.version,room_id:l.id})}}a().catch(console.error)},[t]),r}function Ns(t,r){const n=_e(t,r);return f.useEffect(()=>{n===void 0&&t.joinRoom(r)},[t,r,n]),n}const _s=f.forwardRef(({children:t},r)=>e("div",{ref:r,className:"SearchResultCategory flex items-center gap-sm",children:e(_,{className:"grow",children:t})})),ks=f.forwardRef(({active:t,subtitle:r,shortcuts:n,children:a},s)=>c("div",{ref:s,className:P("SearchResultItem flex items-center gap-sm",{"SearchResultItem--active":t}),children:[c("div",{className:"grow",children:[e(v,{variant:"b2",weight:"medium",children:a}),r&&e(v,{variant:"b3",children:r})]}),n&&n.length>0&&e("div",{className:"flex items-center gap-xxs",children:n.map((i,o)=>e(kr,{size:"xs",children:i},i))})]}));function Is(){const{results:t}=Ne.useMatches();return e(Ne.KBarResults,{items:t,onRender:({item:r,active:n})=>typeof r=="string"?e(_s,{children:r}):e(ks,{active:n,shortcuts:r.shortcut,subtitle:r.subtitle,children:r.name})})}const As=[];function Rs(){return e(Ne.KBarPortal,{children:e(Ne.KBarPositioner,{className:"CmdPanel__positioner",children:e(Ne.KBarAnimator,{children:c("div",{className:"CmdPanel",children:[e(Ne.KBarSearch,{className:"CmdPanel__search-input",size:1}),e(Is,{})]})})})})}function et({thumbnail:t,title:r,description:n}){return c("div",{className:"WhatsNewCard flex items-start gap-md",children:[e("div",{children:t}),c("div",{className:"WhatsNewCard__content flex flex-column gap-xxs",children:[e(v,{className:"truncate",weight:"medium",children:r}),e(v,{variant:"b3",children:n})]})]})}function Us({open:t,requestClose:r,createSpecialWorld:n}){return e(ut,{open:t,className:"WhatsNewModal",size:"sm",children:e(G,{children:e("div",{className:"WhatsNewModal__content",children:c(K,{type:"hover",children:[c("div",{className:"WhatsNewModal__hero flex flex-column justify-center items-center gap-sm text-center",children:[e(v,{variant:"h2",weight:"bold",children:"Welcome to the Third Room"}),e(v,{variant:"s2",weight:"semi-bold",children:"Creator Update"})]}),c(We,{header:e(Me,{title:"What's New"}),children:[e(et,{thumbnail:e(ge,{size:"sm",bgColor:"var(--bg-surface-low)",children:e(pe,{src:"/creator-update/WebSGThumbnail.jpg"})}),title:"Web Scene Graph API",description:"Add behaviors to your worlds using the new Web Scene Graph API. Create portable interactive worlds with JavaScript and WebAssembly."}),e(et,{thumbnail:e(ge,{size:"sm",bgColor:"var(--bg-surface-low)",children:e(pe,{src:"/creator-update/WebXRThumbnail.jpg"})}),title:"WebXR",description:"Third Room now has WebXR support! You can now use your AR or VR headset to explore 3D worlds and interact with other users."}),e(et,{thumbnail:e(ge,{size:"sm",bgColor:"var(--bg-surface-low)",children:e(pe,{src:"/creator-update/DiscoverPageThumbnail.jpg"})}),title:"Discover Page",description:"Find and share scenes, worlds, and Matrix rooms created by the Third Room Community in the new Discover Page."}),e(et,{thumbnail:e(ge,{size:"sm",bgColor:"var(--bg-surface-low)",children:e(pe,{src:"/creator-update/InspectorThumbnail.jpg"})}),title:"In-World Inspector",description:"Inspect and adjust properties and scripts in your worlds using the new in-world inspector. Press the ` key to open the inspector in any world you have edit access to."})]})]})}),bottom:e(Te,{center:c("div",{className:"flex flex-column gap-xxs",style:{padding:"var(--sp-xs)"},children:[e(S,{onClick:n,children:"Try the Script Editor"}),e(S,{onClick:r,fill:"none",size:"sm",children:"Maybe later"})]})})})})}function Ws({open:t,requestClose:r}){return e(ne,{open:t,children:c("div",{className:"flex flex-column gap-lg",style:{padding:"var(--sp-xl) var(--sp-md) var(--sp-lg)"},children:[c("div",{className:"flex flex-column item-center gap-md text-center",children:[e(v,{variant:"h2",weight:"bold",children:"Web Scene Graph"}),e(v,{variant:"b3",children:"Welcome to the Web Scene Graph tutorial! This tutorial will walk you through the basics of the Web Scene Graph API and how to use it to build your own 3D experiences."})]}),c("div",{style:{maxWidth:225,margin:"auto"},className:"flex flex-column items-center gap-sm text-center",children:[e(S,{style:{minWidth:175},onClick:r,children:"Open Tutorial"}),e(v,{variant:"b3",children:"Instructions for the next step are on the next page "})]})]})})}const Ms="WebSG_roomId",Ps={name:"Scripting World",visibility:Ve.Private,content:{scene_url:"mxc://thirdroom.io/aTPpICQMDRnWddrfYWhdbYxd",scene_preview_url:"mxc://thirdroom.io/eexkLRWjvBNZbAFHyZifnUyL",max_member_object_cap:Le}};function Ts(){const{whatsNew:t,finishWhatsNew:r}=$n(),[n,a]=ue(Fn),[s,i]=ue(En),{session:o}=W(!0),l=T(he),{navigateEnterWorld:d}=Dt(o),{worldId:u,entered:m}=z(Et),[p,b]=$e(Ms,void 0),C=_e(o,p);return f.useEffect(()=>{n===void 0&&t&&!u&&(a(!0),setTimeout(()=>document.exitPointerLock(),1))},[n,t,a,u]),f.useEffect(()=>{t&&u===p&&m&&(i(!0),setTimeout(()=>document.exitPointerLock(),1))},[u,p,m,t,i]),c(U,{children:[e(Us,{open:!!n,requestClose:()=>a(!1),createSpecialWorld:async()=>{if(a(!1),C){l(C.id),d(C);return}try{const x=await Wn(o,Ps);l(x.id);const h=await ot(o,x);h&&(b(h.id),l(h.id),d(h))}catch(x){console.error(x)}}}),e(Ws,{open:s,requestClose:()=>{window.open("/docs/guides/websg/basketball/part-1.html","__blank"),i(!1),r()}})]})}const Ds="firefox_perf_alert",Os=typeof navigator<"u"&&navigator.userAgent.indexOf("Gecko/")>=0;function Fs(){const[t,r]=$e(Ds,Os),n=()=>r(!1);return e(nt,{open:t,requestClose:n,title:"Warning",content:c(v,{variant:"b2",children:["Third Room is currently experiencing degraded performance in Firefox due to a bug in the browsers garbage collector when using multiple threads. Were currently investigating this problem and possible workarounds."," ",e("a",{href:"https://bugzilla.mozilla.org/show_bug.cgi?id=1822411",target:"_blank",referrerPolicy:"no-referrer",children:"Read More"})]}),buttons:e(S,{onClick:n,variant:"primary",fill:"outline",children:"Ok"})})}function Es(){return Ir(),Ar(),Rr(),null}function ri(){const t=f.useRef(null),r=ar(t),{session:n}=W(!0),a=z(fn),[s,i]=on(),o=xs(),l=T(he);Ns(n,nn.repositoryRoomIdOrAlias);const d=z(ir);return f.useEffect(()=>{!s&&!i&&o&&l(o)},[s,i,o,l]),e(Qn,{backend:Xn,children:c(Ne.KBarProvider,{actions:As,options:{disableScrollbarManagement:!0},children:[e(Rs,{}),e(Es,{}),c("div",{className:"SessionView",children:[e("canvas",{className:"SessionView__viewport",ref:t}),r?c(sr,{value:r,children:[e(Jn,{}),a&&e(hs,{}),!d&&e(Cs,{}),e(Fs,{}),e(Ts,{})]}):e(Yn,{message:"Initializing engine..."})]})]})})}export{ri as default};
//# sourceMappingURL=SessionView-103d16fb.js.map
