import{o as B,r as c,b as D,j as m,F as A,a as e,B as _,T as v,q as j,c as L,d as Y,i as ye,k as J,m as O,P as Te,Q as Se,I as Me,g as We}from"./main.cc7980d7.js";import{s as Q,W as se,j as Ee,d as Ne,e as Re,E as Pe,x as ke,$ as Ae,T as Ie,D as Ve,F as _e,G as Le,H as Oe,J as De,a0 as oe,S as le,a1 as de,P as He,p as ue,K as Be,A as $e,g as je,a as Ue,l as Fe,Q as Xe,R as qe,a2 as Ge,a3 as Ke,a4 as ze,a5 as Ye,a6 as Je,a7 as Qe,a8 as Ze,a9 as et,aa as tt,V as st,U as ot,n as nt}from"./actions-42459e52.js";import{c as Z,w as $,u as me,o as fe}from"./overlayVisibility-d52fa692.js";import{b as I,r as ee,a as G,h as rt,i as te,j as at,T as he,P as ge,I as q,c as it,g as be}from"./editor-9e67c00a.js";import{g as ne,b as re,l as ct,d as K}from"./common-1b4c5772.js";import{W as lt}from"./WorldThumbnail-72ae1991.js";import{b as pe,T as k,u as xe,D as z,H as ve,a as we,l as ae}from"./mouse-left-107cf13e.js";import{I as dt,a as P,S as Ce}from"./DropdownMenu-c9ddf01c.js";import{b as ie,I as ut,u as mt,R as ft,a as ht,c as gt,S as bt,E as pt}from"./Reticle-a481b0a6.js";import{C as xt}from"./cross-0b515b96.js";import{M as vt,C as wt,F as Ct}from"./Footer-aa726a7f.js";import"./modulepreload-polyfill-3cfb730f.js";import"./Label-b8166eab.js";import"./index.module-9a456540.js";import"./SettingTile-abd8ecde.js";import"./math-0381bedb.js";import"./Deferred-af9e678f.js";const yt="fetch-progress-message";function Tt(){const t=I(),[s,o]=c.useState({loaded:0,total:0});return c.useEffect(()=>ee(t,yt,(i,a)=>{o(a.status)}),[t]),[c.useCallback(()=>{o({loaded:0,total:0})},[]),s]}function St({world:t,loading:s,error:o}){const[r]=B(Z),[n,i]=Tt(),[a,d]=c.useState(),{session:l}=D(!0),{navigateEnterWorld:f,navigateExitWorld:p}=Q(l);return c.useEffect(()=>{n()},[n,s]),c.useEffect(()=>{let g=!1;return t==null||t.getStateEvent("m.room.create","").then(x=>{if(g)return;const b=x==null?void 0:x.event.sender;b&&d(b)}),()=>{g=!0}},[t]),r?null:m(A,{children:[o&&e("div",{className:"WorldLoading flex justify-center",children:e(se,{title:t.name??t.canonicalAlias??"Unknown World",desc:o.message,options:m("div",{className:"flex gap-xxs",children:[e(_,{onClick:p,fill:"outline",children:"Exit"}),e(_,{onClick:()=>{f(t,{reload:!0})},children:"Reload"})]})})}),!o&&s&&e("div",{className:"WorldLoading flex justify-center",children:e(se,{title:t.name??t.canonicalAlias??"Unknown World",desc:a?`Created by ${a}`:void 0,content:m("div",{className:"flex flex-column gap-xs",children:[e(Ee,{variant:"secondary",max:100,value:ne(i.total,i.loaded)}),m("div",{className:"flex justify-between gap-md",children:[e(v,{variant:"b3",children:`Loading Scene: ${ne(i.total,i.loaded)}%`}),e(v,{variant:"b3",children:`${re(i.loaded)} / ${re(i.total)}`})]})]}),options:e("div",{className:"flex gap-xxs",children:e(_,{onClick:p,fill:"outline",children:"Cancel"})})})})]})}class Mt extends j{constructor(s){super(s)}render(s,o){var i,a;const r=((i=o._getContent())==null?void 0:i.msgtype)==="m.emote";let n=r?`* ${o.displayName} `:"";return n+=(a=o._getPlainBody)==null?void 0:a.call(o),s.li({className:L("WorldChat__TextMessageView",{"WorldChat__TextMessageView--emote":r})},s.div({className:"Text Text-b2 Text--world Text--regular"},[r?"":s.span({className:"WorldChat__TextMessageView-sender Text Text-b2 Text--world Text--semi-bold"},`${o.displayName}:`),s.span(ct(n)||"*** EMPTY MESSAGE ***")]))}onClick(){}}class Wt extends j{constructor(s){super(s)}render(s,o){return s.li({className:"WorldChat__AnnouncementView"},s.div({className:"Text Text-b2 Text--world Text--regular"},o.announcement))}onClick(){}}class Et extends j{constructor(s){super(s)}render(s,o){return s.li({className:"WorldChatGap flex item-center"},s.p({className:"Text Text-b2 Text--world Text--semi-bold"},[r=>r.isLoading?"Loading more messages...":"Not loading!",r=>r.error?r.error:""]))}onClick(){}}class Nt extends j{constructor(s){super(s)}render(s,o){return s.span({className:"inline-flex"},"")}onClick(){}}function Rt(t){switch(t.shape){case"gap":return Et;case"announcement":return Wt;case"message":case"message-status":return Mt;case"date-header":return Nt;default:throw new Error(`Tiles of shape "${t.shape}" are not supported, check the tileClassForEntry function in the view model`)}}function Pt({timelineViewModel:t}){const s=c.useRef(null);return Ne(s,t,Rt),e("div",{className:"WorldChatTimeline grow flex",ref:s})}function kt({composerViewModel:t}){return e("form",{className:"WorldChatComposer grow",onSubmit:o=>{o.preventDefault();const r=o.target,n=r.message.value.trim();n!==""&&(r.message.value="",t.sendMessage(n))},children:e("input",{className:"Text Text-b2 Text--world Text-regular",name:"message",type:"text",placeholder:"",autoComplete:"off",autoFocus:!0})})}function At(t){const s=c.useRef();return c.useEffect(()=>{s.current=t},[t]),s.current}function It(t,s=5){const o=c.useRef([]),[,r]=c.useReducer(a=>a+1,0),n=ke(t),i=At(n);return i&&n&&n!==i&&(o.current.length>=s&&o.current.shift(),o.current.push(n),setTimeout(()=>{o.current.shift(),r()},5e3)),t||(o.current=[]),o.current}function Vt({room:t,open:s}){const{loading:o,roomViewModel:r,error:n}=Re(t,Ae),i=It(s?void 0:t,5);return m("div",{className:"WorldChat flex flex-column justify-end",id:"WorldChat",children:[s?(()=>n?e("div",{className:"grow flex justify-center items-center",children:e(v,{children:n.message})}):o||!r?e("div",{className:"grow flex justify-center items-center",children:e(v,{children:"loading..."})}):e(Pt,{timelineViewModel:r.timelineViewModel}))():(()=>i.length>0&&e("div",{className:"grow flex items-end",style:{padding:"var(--sp-xs) 0"},children:e("div",{className:"flex flex-column items-start justify-end gap-xs",children:i.map(l=>e("li",{className:"WorldChat__TextMessageView",children:m("div",{className:"Text Text-b2 Text--world Text--regular",children:[e("span",{className:"WorldChat__TextMessageView-sender Text Text-b2 Text--world Text--semi-bold",children:l.displayName}),l.content.body]})},l.id))})}))(),m("div",{className:"WorldChat__input flex items-center",children:[e(dt,{color:"world",src:Pe,size:"sm"}),s&&r?m(A,{children:[e(kt,{composerViewModel:r.composerViewModel}),e(v,{variant:"b3",color:"world",weight:"bold",className:"uppercase",children:"Enter"})]}):m(v,{variant:"b2",color:"world",children:["Press ",e("b",{children:"Enter"})," to chat"]})]})]})}function _t(){const[{toastShown:t,toastContent:s},o]=c.useState({toastShown:!1,toastContent:""}),r=Y(),n=c.useRef(),i=c.useCallback(a=>{o({toastShown:!0,toastContent:a}),clearTimeout(n.current),n.current=window.setTimeout(()=>{r()&&o(d=>({...d,toastShown:!1}))},2e3)},[r]);return{toastShown:t,toastContent:s,showToast:i}}const Lt={optionalFeatures:["local-floor","bounded-floor","hand-tracking","layers"]};function Ot(){const t=I(),[s]=pe("feature_immersiveAR",!1),[o,r]=c.useState(!1),{callback:n,loading:i,value:a,error:d}=ye(async()=>{if("xr"in navigator&&navigator.xr&&t.supportedXRSessionModes){if(o)return;const l=s&&t.supportedXRSessionModes.includes("immersive-ar")?"immersive-ar":"immersive-vr";console.log(s,t.supportedXRSessionModes);const f=await navigator.xr.requestSession(l,Lt);return t.sendMessage(G.Render,{type:rt.EnterXR,session:f,mode:l}),f}},[t,o,s]);return c.useEffect(()=>{if(a){r(!0);const l=()=>r(!1);return a.addEventListener("end",l),()=>{a.removeEventListener("end",l)}}},[a]),{enteringXR:i,isPresenting:o,isWebXRSupported:!!t.supportedXRSessionModes,error:d,enterXR:n}}function Dt({imageSrc:t,label:s="Object",shortcutKey:o}){return m("div",{className:"HotbarSlot flex items-center",children:[e(k,{content:s,children:e(Ie,{src:t,alt:s})}),e(v,{className:"HotbarSlot__key",variant:"b3",color:"world",weight:"bold",children:o})]})}function Ht({children:t}){return e("div",{className:"Hotbar flex gap-sm",children:t})}const Bt="/assets/subtitles-d189ab02.svg",$t="/assets/subtitles-off-15bd08f0.svg",jt="/assets/help-8b733830.svg",Ut="/assets/xr-4ff37431.svg";function Ft(){const t=I(),[s,o]=c.useState([]);return c.useEffect(()=>{const{actionBarItems:r}=te(t,at);return o(r),ee(t,he.SetActionBarItems,(n,i)=>{o(i.actionBarItems)})},[t]),s}function Xt(){const t=Ft();return e(Ht,{children:t.map((s,o)=>e(Dt,{imageSrc:s.thumbnail,shortcutKey:o+1,label:s.label},s.id))})}const qt=c.forwardRef(({activeCall:t,showToast:s},o)=>{const{mute:r,requestStream:n,handleMute:i,micException:a,setMicException:d}=Ve(t);return m(A,{children:[e(_e,{micException:a,setMicException:d}),e(k,{content:r?"Unmute":"Mute",children:e(P,{variant:"world",label:"Mic",iconSrc:r?Le:Oe,onClick:()=>{s(r?"Microphone Unmuted":"Microphone Muted"),i(async()=>De(n,d))},ref:o})})]})});function Gt({className:t,session:s,activeCall:o,world:r,showToast:n,isWebXRSupported:i,enterXR:a,showNames:d,setShowNames:l}){const f=I(),{navigateExitWorld:p}=Q(s),[g,x]=c.useState(!1),[b,h]=c.useState(!1),W=()=>x(u=>!u),w=()=>h(u=>!u),T=c.useCallback(()=>{const u=!d;l(u),f.sendMessage(G.Game,{type:oe,enabled:u}),n(u?"Show Names":"Hide Names")},[f,d,n,l]);return c.useEffect(()=>{f.sendMessage(G.Game,{type:oe,enabled:d})},[f,d]),xe(u=>{K()||u.altKey&&u.code==="KeyL"&&p()},[a,i]),le(b||g),m("div",{className:L(t,"flex"),children:[m("div",{className:"flex flex-column items-center",children:[e(k,{content:b?"Hide Help":"Show Help",children:e(P,{variant:"world",label:"help",iconSrc:jt,onClick:w})}),e(v,{variant:"b3",color:"world",weight:"bold",children:"/"}),m(z,{open:b,onOpenChange:h,children:[e(ve,{left:e(we,{size:"lg",children:"Controls"}),right:e(P,{iconSrc:xt,onClick:w,label:"Close"})}),e("div",{className:"flex",style:{height:"600px"},children:e(Ce,{type:"hover",children:e(de,{})})})]})]}),i&&m("div",{className:"flex flex-column items-center",children:[e(k,{content:"Enter XR",children:e(P,{variant:"world",label:"Enter XR",iconSrc:Ut,onClick:a})}),e(v,{variant:"b3",color:"world",weight:"bold",children:"Alt + X"})]}),m("div",{className:"flex flex-column items-center",children:[e(k,{content:g?"Hide Members":"Show Members",children:e(P,{variant:"world",label:"activeMembers",iconSrc:He,onClick:W})}),e(v,{variant:"b3",color:"world",weight:"bold",children:"P"}),!("isBeingCreated"in r)&&e(z,{open:g,onOpenChange:x,children:e(ue,{room:r,requestClose:()=>x(!1)})})]}),m("div",{className:"flex flex-column items-center",children:[e(k,{content:d?"Hide Names":"Show Names",children:e(P,{variant:"world",label:"Toggle Names",iconSrc:d?Bt:$t,onClick:T})}),e(v,{variant:"b3",color:"world",weight:"bold",children:"N"})]}),o&&m("div",{className:"flex flex-column items-center",children:[e(qt,{showToast:n,activeCall:o}),e(v,{variant:"b3",color:"world",weight:"bold",children:"M"})]}),m("div",{className:"flex flex-column items-center",children:[e(k,{content:"Disconnect",children:e(P,{variant:"danger",label:"Disconnect",iconSrc:Be,onClick:p})}),e(v,{variant:"b3",color:"world",weight:"bold",children:"Alt + L"})]})]})}const ce="io.thirdroom.onboarding";function Kt(t){const{session:s,platform:o}=D(!0),[r,n]=c.useState(!1);return c.useEffect(()=>{async function a(){const d=await s.getAccountData("org.matrix.msc3815.world.home");if(!d||d.room_id!==t)return;const l=await s.getAccountData(ce),{onboardingVersion:f}=o.config,p=l==null?void 0:l.version;(typeof p!="number"||p<f)&&n(!0)}t&&a().catch(console.error)},[t,s,o.config]),{onboarding:r,finishOnboarding:()=>{n(!1),s.setAccountData(ce,{version:o.config.onboardingVersion})}}}function zt({className:t,max:s,value:o}){return e("div",{className:L("PaginationDot",t),children:Array.from({length:s}).map((r,n)=>e("span",{className:L("PaginationDot__item",{"PaginationDot__item--active":n+1===o})},n))})}function Yt({open:t,world:s,requestClose:o}){const{platform:r}=D(!0),[n,i]=c.useState(1),a=2;return e(vt,{open:t,className:"OnboardingModal",size:"sm",children:e(wt,{top:e(ve,{center:e(we,{children:n===1?"Get Started":"Controls"})}),children:m("div",{className:"OnboardingModal__content",children:[n===1&&m("div",{className:"OnboardingModal__screen1 flex flex-column justify-center items-center gap-sm text-center",children:[e($e,{name:s.name||"Home World",size:"xl",shape:"circle",className:"shrink-0",bgColor:`var(--usercolor${je(s.id)})`,imageSrc:s.avatarUrl?Ue(s.avatarUrl,50,r,s.mediaRepository):void 0}),e(v,{variant:"h2",weight:"semi-bold",children:"Welcome to your home world"}),e(v,{children:"This is a private world to make your own that will evolve as Third Room grows."}),e(v,{children:"We've set up a few portals in your space leading to public worlds for you to explore. You can get back to this space at any time in the overlay."}),e(v,{children:"Have fun exploring Third Room!"})]}),n===2&&e(Ce,{type:"hover",children:e(de,{})})]}),bottom:e(Ct,{left:n>1?e(_,{onClick:()=>i(n-1),fill:"outline",children:"Back"}):e(A,{}),center:e(zt,{max:a,value:n}),right:m(A,{children:[a===n&&e(_,{onClick:o,children:"Finish"}),n<a&&e(_,{onClick:()=>i(n+1),children:"Next"})]})})})})}function Jt({world:t}){const s=I(),o=J($).entered,{onboarding:r,finishOnboarding:n}=Kt(o?t.id:void 0);c.useEffect(()=>{r&&document.exitPointerLock()},[r]);const i=c.useCallback(()=>{var a;n(),(a=s.canvas)==null||a.requestPointerLock()},[s.canvas,n]);return e(Yt,{open:r,world:t,requestClose:i})}function Qt({session:t,world:s,activeCall:o}){const r=I(),n=te(r,ge),[i,a]=ie(),[d,l]=ie({}),[f,p]=c.useState(!1),{navigateEnterWorld:g}=Q(t),{exitWorld:x}=me(),b=O(fe),h=Y(),W=c.useCallback(async T=>{let u;try{l({});const{uri:C}=T;if(!C)throw Error("Portal does not have valid matrix id/alias");const y=Te(C);if(y instanceof URL){window.location.href=y.href;return}const E=y.mxid1,N=E.startsWith("#")?Se(t.rooms,y.mxid1):y.mxid1;if(!N){l({joining:!0});const R=await t.joinRoom(E);if(!h())return;l({}),u=(await t.observeRoomStatus(R)).subscribe(async F=>{const S=t.rooms.get(R);if(!S||F!==Me.Joined)return;const M=await S.getStateEvent("org.matrix.msc3815.world");M!=null&&M.event.content&&(b(N),x(),g(S))});return}const V=t.rooms.get(N);if(V){const R=await V.getStateEvent("org.matrix.msc3815.world");if(!(R==null?void 0:R.event.content))return;b(N),x(),g(V);return}}catch(C){if(!h())return;l({error:C})}return()=>{u==null||u()}},[t,b,x,g,h,l]),w=c.useCallback(T=>{var E;if(!T)return a(void 0);const{interactableType:u,action:C,peerId:y}=T;if(C===ut.Grab){if(u===q.Player&&typeof y=="string"){p(!0),document.exitPointerLock();return}if(u===q.Portal){W(T);return}}if(u===q.Player){const N={...T,name:y?((E=o==null?void 0:o.members.get(y))==null?void 0:E.member.displayName)||We(y):"Player"};a(N)}a(T)},[W,a,o]);return mt(r,w),m("div",{children:[!("isBeingCreated"in s)&&e(z,{open:f,onOpenChange:p,children:e(ue,{room:s,requestClose:()=>p(!1)})}),!n.orbiting&&e(ft,{}),i&&!n.orbiting&&e(ht,{activeEntity:i,portalProcess:d})]})}const Zt="showNames";function es({world:t}){const s=I(),{session:o}=D(!0),{getPowerLevel:r,canSendStateEvent:n}=Fe(t),i=n("org.matrix.msc3815.world",r(o.userId)),a=Xe(o),d=qe(a,t.id),l=J($).entered,[f,p]=B(st),[g,x]=B(Z),[b,h]=B(be),[W,w]=c.useState(!1),{toastShown:T,toastContent:u,showToast:C}=_t(),y=te(s,ge),[E,N]=pe(Zt,!0),{isWebXRSupported:V,enterXR:R,isPresenting:U}=Ot(),{kbarVisible:F}=ae.useKBar(S=>({kbarVisible:S.visualState!==ae.VisualState.hidden}));return le(F),Ge(E,N,C),Ke(h,i,C),ze(),Ye(w),c.useEffect(()=>{const S=(H,X)=>{C("Maximum number of objects reached.")},M=it([ee(s,he.ObjectCapReached,S)]);return()=>{M()}},[s,C]),xe(S=>{var M,H,X;if(!(S.key==="Escape"&&y.orbiting)){if(S.key==="Escape"){if(f){(M=s.canvas)==null||M.requestPointerLock(),p(!1);return}if(K())return;if(b){(H=s.canvas)==null||H.requestPointerLock(),h(!1);return}if(g){(X=s.canvas)==null||X.requestPointerLock(),x(!1);return}else{document.exitPointerLock(),x(!0);return}}if(!K()&&S.key==="Enter"&&!g&&!f){if(document.activeElement!==document.body)return;document.exitPointerLock(),p(!0);return}}},[f,g,b]),gt("click",S=>{var M;l!==!1&&(!y.orbiting&&!b&&((M=s.canvas)==null||M.requestPointerLock()),f&&p(!1),g&&x(!1))},s.canvas,[l,f,p,g,x,b]),c.useEffect(()=>{s.canvas.requestPointerLock()},[s]),U?null:m("div",{className:"WorldView",children:[e(Je,{activeCall:d,showToast:C}),e(Qe,{world:t}),e(Ze,{}),V&&e(et,{enter:R}),e(Jt,{world:t}),e(bt,{statsEnabled:W}),e("div",{className:L("WorldView__chat flex",{"WorldView__chat--open":f}),children:!("isBeingCreated"in t)&&!b&&e(Vt,{open:f,room:t})}),t&&!b&&m(A,{children:[!f&&e(Xt,{}),e(Gt,{className:"WorldView__controls",session:o,world:t,activeCall:d,showToast:C,isWebXRSupported:V,enterXR:R,showNames:E,setShowNames:N})]}),t&&b&&e(pt,{room:t}),!("isBeingCreated"in t)&&e(tt,{room:t,show:E&&!g}),!g&&!b&&e(Qt,{session:o,world:t,activeCall:d}),e("div",{className:"WorldView__toast-container",children:e("div",{className:L("WorldView__toast",{"WorldView__toast--shown":T}),children:e(v,{variant:"b2",color:"world",weight:"semi-bold",children:u})})})]})}async function ts(t){const s=await t.getStateEvent("org.matrix.msc3815.world");return s==null?void 0:s.event.content}function vs(){const{entered:t,loading:s}=J($),o=O($),{session:r}=D(!0),n=Y(),[i,a]=c.useState(),d=O(Z),{loadAndEnterWorld:l,reloadWorld:f,exitWorld:p}=me(),g=O(fe),[x,b]=ot(),h=nt(r,x),W=O(be);return c.useEffect(()=>{p(),h&&(async()=>{try{const w=await ts(h);await l(h,w??{})}catch(w){a(w),console.error(w)}})()},[h,b,g,l,p,o]),c.useEffect(()=>{h&&g(h.id)},[h,g]),c.useEffect(()=>{d(!s&&!t)},[d,t,s]),c.useEffect(()=>{a(void 0);let w;if(h&&t){const T=async u=>{const C=u==null?void 0:u.content;if(C){W(!1);try{await f(h,C)}catch(y){a(y),console.error(y)}}};h.observeStateTypeAndKey("org.matrix.msc3815.world","").then(async u=>{w=u.subscribe(T)})}return()=>{w==null||w()}},[h,t,n,f,W]),m(A,{children:[h&&t&&e(es,{world:h}),e(lt,{}),h&&e(St,{world:h,loading:s,error:i})]})}export{vs as default};
//# sourceMappingURL=WorldRootView-34a7ecdd.js.map
