import"./modulepreload-polyfill-3cfb730f.js";function mk(n,e){for(var t=0;t<e.length;t++){const r=e[t];if(typeof r!="string"&&!Array.isArray(r)){for(const i in r)if(i!=="default"&&!(i in n)){const s=Object.getOwnPropertyDescriptor(r,i);s&&Object.defineProperty(n,i,s.get?s:{enumerable:!0,get:()=>r[i]})}}}return Object.freeze(Object.defineProperty(n,Symbol.toStringTag,{value:"Module"}))}var _k=typeof globalThis<"u"?globalThis:typeof window<"u"?window:typeof global<"u"?global:typeof self<"u"?self:{};function mo(n){return n&&n.__esModule&&Object.prototype.hasOwnProperty.call(n,"default")?n.default:n}function gk(n){if(n.__esModule)return n;var e=n.default;if(typeof e=="function"){var t=function r(){if(this instanceof r){var i=[null];i.push.apply(i,arguments);var s=Function.bind.apply(e,i);return new s}return e.apply(this,arguments)};t.prototype=e.prototype}else t={};return Object.defineProperty(t,"__esModule",{value:!0}),Object.keys(n).forEach(function(r){var i=Object.getOwnPropertyDescriptor(n,r);Object.defineProperty(t,r,i.get?i:{enumerable:!0,get:function(){return n[r]}})}),t}var dw={exports:{}},vl={};/*
object-assign
(c) Sindre Sorhus
@license MIT
*/var D_=Object.getOwnPropertySymbols,yk=Object.prototype.hasOwnProperty,vk=Object.prototype.propertyIsEnumerable;function wk(n){if(n==null)throw new TypeError("Object.assign cannot be called with null or undefined");return Object(n)}function bk(){try{if(!Object.assign)return!1;var n=new String("abc");if(n[5]="de",Object.getOwnPropertyNames(n)[0]==="5")return!1;for(var e={},t=0;t<10;t++)e["_"+String.fromCharCode(t)]=t;var r=Object.getOwnPropertyNames(e).map(function(s){return e[s]});if(r.join("")!=="0123456789")return!1;var i={};return"abcdefghijklmnopqrst".split("").forEach(function(s){i[s]=s}),Object.keys(Object.assign({},i)).join("")==="abcdefghijklmnopqrst"}catch{return!1}}var hw=bk()?Object.assign:function(n,e){for(var t,r=wk(n),i,s=1;s<arguments.length;s++){t=Object(arguments[s]);for(var o in t)yk.call(t,o)&&(r[o]=t[o]);if(D_){i=D_(t);for(var a=0;a<i.length;a++)vk.call(t,i[a])&&(r[i[a]]=t[i[a]])}}return r},fw={exports:{}},ue={};/** @license React v17.0.2
 * react.production.min.js
 *
 * Copyright (c) Facebook, Inc. and its affiliates.
 *
 * This source code is licensed under the MIT license found in the
 * LICENSE file in the root directory of this source tree.
 */var Ep=hw,_o=60103,pw=60106;ue.Fragment=60107;ue.StrictMode=60108;ue.Profiler=60114;var mw=60109,_w=60110,gw=60112;ue.Suspense=60113;var yw=60115,vw=60116;if(typeof Symbol=="function"&&Symbol.for){var fn=Symbol.for;_o=fn("react.element"),pw=fn("react.portal"),ue.Fragment=fn("react.fragment"),ue.StrictMode=fn("react.strict_mode"),ue.Profiler=fn("react.profiler"),mw=fn("react.provider"),_w=fn("react.context"),gw=fn("react.forward_ref"),ue.Suspense=fn("react.suspense"),yw=fn("react.memo"),vw=fn("react.lazy")}var N_=typeof Symbol=="function"&&Symbol.iterator;function Sk(n){return n===null||typeof n!="object"?null:(n=N_&&n[N_]||n["@@iterator"],typeof n=="function"?n:null)}function wl(n){for(var e="https://reactjs.org/docs/error-decoder.html?invariant="+n,t=1;t<arguments.length;t++)e+="&args[]="+encodeURIComponent(arguments[t]);return"Minified React error #"+n+"; visit "+e+" for the full message or use the non-minified dev environment for full errors and additional helpful warnings."}var ww={isMounted:function(){return!1},enqueueForceUpdate:function(){},enqueueReplaceState:function(){},enqueueSetState:function(){}},bw={};function go(n,e,t){this.props=n,this.context=e,this.refs=bw,this.updater=t||ww}go.prototype.isReactComponent={};go.prototype.setState=function(n,e){if(typeof n!="object"&&typeof n!="function"&&n!=null)throw Error(wl(85));this.updater.enqueueSetState(this,n,e,"setState")};go.prototype.forceUpdate=function(n){this.updater.enqueueForceUpdate(this,n,"forceUpdate")};function Sw(){}Sw.prototype=go.prototype;function kp(n,e,t){this.props=n,this.context=e,this.refs=bw,this.updater=t||ww}var Ip=kp.prototype=new Sw;Ip.constructor=kp;Ep(Ip,go.prototype);Ip.isPureReactComponent=!0;var Tp={current:null},Ew=Object.prototype.hasOwnProperty,kw={key:!0,ref:!0,__self:!0,__source:!0};function Iw(n,e,t){var r,i={},s=null,o=null;if(e!=null)for(r in e.ref!==void 0&&(o=e.ref),e.key!==void 0&&(s=""+e.key),e)Ew.call(e,r)&&!kw.hasOwnProperty(r)&&(i[r]=e[r]);var a=arguments.length-2;if(a===1)i.children=t;else if(1<a){for(var c=Array(a),u=0;u<a;u++)c[u]=arguments[u+2];i.children=c}if(n&&n.defaultProps)for(r in a=n.defaultProps,a)i[r]===void 0&&(i[r]=a[r]);return{$$typeof:_o,type:n,key:s,ref:o,props:i,_owner:Tp.current}}function Ek(n,e){return{$$typeof:_o,type:n.type,key:e,ref:n.ref,props:n.props,_owner:n._owner}}function Rp(n){return typeof n=="object"&&n!==null&&n.$$typeof===_o}function kk(n){var e={"=":"=0",":":"=2"};return"$"+n.replace(/[=:]/g,function(t){return e[t]})}var P_=/\/+/g;function Vd(n,e){return typeof n=="object"&&n!==null&&n.key!=null?kk(""+n.key):e.toString(36)}function Mc(n,e,t,r,i){var s=typeof n;(s==="undefined"||s==="boolean")&&(n=null);var o=!1;if(n===null)o=!0;else switch(s){case"string":case"number":o=!0;break;case"object":switch(n.$$typeof){case _o:case pw:o=!0}}if(o)return o=n,i=i(o),n=r===""?"."+Vd(o,0):r,Array.isArray(i)?(t="",n!=null&&(t=n.replace(P_,"$&/")+"/"),Mc(i,e,t,"",function(u){return u})):i!=null&&(Rp(i)&&(i=Ek(i,t+(!i.key||o&&o.key===i.key?"":(""+i.key).replace(P_,"$&/")+"/")+n)),e.push(i)),1;if(o=0,r=r===""?".":r+":",Array.isArray(n))for(var a=0;a<n.length;a++){s=n[a];var c=r+Vd(s,a);o+=Mc(s,e,t,c,i)}else if(c=Sk(n),typeof c=="function")for(n=c.call(n),a=0;!(s=n.next()).done;)s=s.value,c=r+Vd(s,a++),o+=Mc(s,e,t,c,i);else if(s==="object")throw e=""+n,Error(wl(31,e==="[object Object]"?"object with keys {"+Object.keys(n).join(", ")+"}":e));return o}function Ol(n,e,t){if(n==null)return n;var r=[],i=0;return Mc(n,r,"","",function(s){return e.call(t,s,i++)}),r}function Ik(n){if(n._status===-1){var e=n._result;e=e(),n._status=0,n._result=e,e.then(function(t){n._status===0&&(t=t.default,n._status=1,n._result=t)},function(t){n._status===0&&(n._status=2,n._result=t)})}if(n._status===1)return n._result;throw n._result}var Tw={current:null};function br(){var n=Tw.current;if(n===null)throw Error(wl(321));return n}var Tk={ReactCurrentDispatcher:Tw,ReactCurrentBatchConfig:{transition:0},ReactCurrentOwner:Tp,IsSomeRendererActing:{current:!1},assign:Ep};ue.Children={map:Ol,forEach:function(n,e,t){Ol(n,function(){e.apply(this,arguments)},t)},count:function(n){var e=0;return Ol(n,function(){e++}),e},toArray:function(n){return Ol(n,function(e){return e})||[]},only:function(n){if(!Rp(n))throw Error(wl(143));return n}};ue.Component=go;ue.PureComponent=kp;ue.__SECRET_INTERNALS_DO_NOT_USE_OR_YOU_WILL_BE_FIRED=Tk;ue.cloneElement=function(n,e,t){if(n==null)throw Error(wl(267,n));var r=Ep({},n.props),i=n.key,s=n.ref,o=n._owner;if(e!=null){if(e.ref!==void 0&&(s=e.ref,o=Tp.current),e.key!==void 0&&(i=""+e.key),n.type&&n.type.defaultProps)var a=n.type.defaultProps;for(c in e)Ew.call(e,c)&&!kw.hasOwnProperty(c)&&(r[c]=e[c]===void 0&&a!==void 0?a[c]:e[c])}var c=arguments.length-2;if(c===1)r.children=t;else if(1<c){a=Array(c);for(var u=0;u<c;u++)a[u]=arguments[u+2];r.children=a}return{$$typeof:_o,type:n.type,key:i,ref:s,props:r,_owner:o}};ue.createContext=function(n,e){return e===void 0&&(e=null),n={$$typeof:_w,_calculateChangedBits:e,_currentValue:n,_currentValue2:n,_threadCount:0,Provider:null,Consumer:null},n.Provider={$$typeof:mw,_context:n},n.Consumer=n};ue.createElement=Iw;ue.createFactory=function(n){var e=Iw.bind(null,n);return e.type=n,e};ue.createRef=function(){return{current:null}};ue.forwardRef=function(n){return{$$typeof:gw,render:n}};ue.isValidElement=Rp;ue.lazy=function(n){return{$$typeof:vw,_payload:{_status:-1,_result:n},_init:Ik}};ue.memo=function(n,e){return{$$typeof:yw,type:n,compare:e===void 0?null:e}};ue.useCallback=function(n,e){return br().useCallback(n,e)};ue.useContext=function(n,e){return br().useContext(n,e)};ue.useDebugValue=function(){};ue.useEffect=function(n,e){return br().useEffect(n,e)};ue.useImperativeHandle=function(n,e,t){return br().useImperativeHandle(n,e,t)};ue.useLayoutEffect=function(n,e){return br().useLayoutEffect(n,e)};ue.useMemo=function(n,e){return br().useMemo(n,e)};ue.useReducer=function(n,e,t){return br().useReducer(n,e,t)};ue.useRef=function(n){return br().useRef(n)};ue.useState=function(n){return br().useState(n)};ue.version="17.0.2";fw.exports=ue;var R=fw.exports;const jt=mo(R),lK=mk({__proto__:null,default:jt},[R]);/** @license React v17.0.2
 * react-jsx-runtime.production.min.js
 *
 * Copyright (c) Facebook, Inc. and its affiliates.
 *
 * This source code is licensed under the MIT license found in the
 * LICENSE file in the root directory of this source tree.
 */var Rk=R,Rw=60103;vl.Fragment=60107;if(typeof Symbol=="function"&&Symbol.for){var O_=Symbol.for;Rw=O_("react.element"),vl.Fragment=O_("react.fragment")}var Ck=Rk.__SECRET_INTERNALS_DO_NOT_USE_OR_YOU_WILL_BE_FIRED.ReactCurrentOwner,Mk=Object.prototype.hasOwnProperty,xk={key:!0,ref:!0,__self:!0,__source:!0};function Cw(n,e,t){var r,i={},s=null,o=null;t!==void 0&&(s=""+t),e.key!==void 0&&(s=""+e.key),e.ref!==void 0&&(o=e.ref);for(r in e)Mk.call(e,r)&&!xk.hasOwnProperty(r)&&(i[r]=e[r]);if(n&&n.defaultProps)for(r in e=n.defaultProps,e)i[r]===void 0&&(i[r]=e[r]);return{$$typeof:Rw,type:n,key:s,ref:o,props:i,_owner:Ck.current}}vl.jsx=Cw;vl.jsxs=Cw;dw.exports=vl;var Cp=dw.exports;const ca=Cp.Fragment,V=Cp.jsx,Br=Cp.jsxs;var Mw={exports:{}},cn={},xw={exports:{}},Aw={};/** @license React v0.20.2
 * scheduler.production.min.js
 *
 * Copyright (c) Facebook, Inc. and its affiliates.
 *
 * This source code is licensed under the MIT license found in the
 * LICENSE file in the root directory of this source tree.
 */(function(n){var e,t,r,i;if(typeof performance=="object"&&typeof performance.now=="function"){var s=performance;n.unstable_now=function(){return s.now()}}else{var o=Date,a=o.now();n.unstable_now=function(){return o.now()-a}}if(typeof window>"u"||typeof MessageChannel!="function"){var c=null,u=null,l=function(){if(c!==null)try{var O=n.unstable_now();c(!0,O),c=null}catch(W){throw setTimeout(l,0),W}};e=function(O){c!==null?setTimeout(e,0,O):(c=O,setTimeout(l,0))},t=function(O,W){u=setTimeout(O,W)},r=function(){clearTimeout(u)},n.unstable_shouldYield=function(){return!1},i=n.unstable_forceFrameRate=function(){}}else{var d=window.setTimeout,p=window.clearTimeout;if(typeof console<"u"){var m=window.cancelAnimationFrame;typeof window.requestAnimationFrame!="function"&&console.error("This browser doesn't support requestAnimationFrame. Make sure that you load a polyfill in older browsers. https://reactjs.org/link/react-polyfills"),typeof m!="function"&&console.error("This browser doesn't support cancelAnimationFrame. Make sure that you load a polyfill in older browsers. https://reactjs.org/link/react-polyfills")}var w=!1,S=null,v=-1,_=5,b=0;n.unstable_shouldYield=function(){return n.unstable_now()>=b},i=function(){},n.unstable_forceFrameRate=function(O){0>O||125<O?console.error("forceFrameRate takes a positive int between 0 and 125, forcing frame rates higher than 125 fps is not supported"):_=0<O?Math.floor(1e3/O):5};var k=new MessageChannel,g=k.port2;k.port1.onmessage=function(){if(S!==null){var O=n.unstable_now();b=O+_;try{S(!0,O)?g.postMessage(null):(w=!1,S=null)}catch(W){throw g.postMessage(null),W}}else w=!1},e=function(O){S=O,w||(w=!0,g.postMessage(null))},t=function(O,W){v=d(function(){O(n.unstable_now())},W)},r=function(){p(v),v=-1}}function A(O,W){var j=O.length;O.push(W);e:for(;;){var de=j-1>>>1,ee=O[de];if(ee!==void 0&&0<P(ee,W))O[de]=W,O[j]=ee,j=de;else break e}}function M(O){return O=O[0],O===void 0?null:O}function C(O){var W=O[0];if(W!==void 0){var j=O.pop();if(j!==W){O[0]=j;e:for(var de=0,ee=O.length;de<ee;){var et=2*(de+1)-1,Rt=O[et],un=et+1,Ut=O[un];if(Rt!==void 0&&0>P(Rt,j))Ut!==void 0&&0>P(Ut,Rt)?(O[de]=Ut,O[un]=j,de=un):(O[de]=Rt,O[et]=j,de=et);else if(Ut!==void 0&&0>P(Ut,j))O[de]=Ut,O[un]=j,de=un;else break e}}return W}return null}function P(O,W){var j=O.sortIndex-W.sortIndex;return j!==0?j:O.id-W.id}var I=[],$=[],x=1,U=null,T=3,N=!1,X=!1,H=!1;function ne(O){for(var W=M($);W!==null;){if(W.callback===null)C($);else if(W.startTime<=O)C($),W.sortIndex=W.expirationTime,A(I,W);else break;W=M($)}}function me(O){if(H=!1,ne(O),!X)if(M(I)!==null)X=!0,e(_e);else{var W=M($);W!==null&&t(me,W.startTime-O)}}function _e(O,W){X=!1,H&&(H=!1,r()),N=!0;var j=T;try{for(ne(W),U=M(I);U!==null&&(!(U.expirationTime>W)||O&&!n.unstable_shouldYield());){var de=U.callback;if(typeof de=="function"){U.callback=null,T=U.priorityLevel;var ee=de(U.expirationTime<=W);W=n.unstable_now(),typeof ee=="function"?U.callback=ee:U===M(I)&&C(I),ne(W)}else C(I);U=M(I)}if(U!==null)var et=!0;else{var Rt=M($);Rt!==null&&t(me,Rt.startTime-W),et=!1}return et}finally{U=null,T=j,N=!1}}var He=i;n.unstable_IdlePriority=5,n.unstable_ImmediatePriority=1,n.unstable_LowPriority=4,n.unstable_NormalPriority=3,n.unstable_Profiling=null,n.unstable_UserBlockingPriority=2,n.unstable_cancelCallback=function(O){O.callback=null},n.unstable_continueExecution=function(){X||N||(X=!0,e(_e))},n.unstable_getCurrentPriorityLevel=function(){return T},n.unstable_getFirstCallbackNode=function(){return M(I)},n.unstable_next=function(O){switch(T){case 1:case 2:case 3:var W=3;break;default:W=T}var j=T;T=W;try{return O()}finally{T=j}},n.unstable_pauseExecution=function(){},n.unstable_requestPaint=He,n.unstable_runWithPriority=function(O,W){switch(O){case 1:case 2:case 3:case 4:case 5:break;default:O=3}var j=T;T=O;try{return W()}finally{T=j}},n.unstable_scheduleCallback=function(O,W,j){var de=n.unstable_now();switch(typeof j=="object"&&j!==null?(j=j.delay,j=typeof j=="number"&&0<j?de+j:de):j=de,O){case 1:var ee=-1;break;case 2:ee=250;break;case 5:ee=1073741823;break;case 4:ee=1e4;break;default:ee=5e3}return ee=j+ee,O={id:x++,callback:W,priorityLevel:O,startTime:j,expirationTime:ee,sortIndex:-1},j>de?(O.sortIndex=j,A($,O),M(I)===null&&O===M($)&&(H?r():H=!0,t(me,j-de))):(O.sortIndex=ee,A(I,O),X||N||(X=!0,e(_e))),O},n.unstable_wrapCallback=function(O){var W=T;return function(){var j=T;T=W;try{return O.apply(this,arguments)}finally{T=j}}}})(Aw);xw.exports=Aw;var Ak=xw.exports;/** @license React v17.0.2
 * react-dom.production.min.js
 *
 * Copyright (c) Facebook, Inc. and its affiliates.
 *
 * This source code is licensed under the MIT license found in the
 * LICENSE file in the root directory of this source tree.
 */var qu=R,Me=hw,Qe=Ak;function L(n){for(var e="https://reactjs.org/docs/error-decoder.html?invariant="+n,t=1;t<arguments.length;t++)e+="&args[]="+encodeURIComponent(arguments[t]);return"Minified React error #"+n+"; visit "+e+" for the full message or use the non-minified dev environment for full errors and additional helpful warnings."}if(!qu)throw Error(L(227));var Dw=new Set,Ba={};function is(n,e){Qs(n,e),Qs(n+"Capture",e)}function Qs(n,e){for(Ba[n]=e,n=0;n<e.length;n++)Dw.add(e[n])}var _r=!(typeof window>"u"||typeof window.document>"u"||typeof window.document.createElement>"u"),Dk=/^[:A-Z_a-z\u00C0-\u00D6\u00D8-\u00F6\u00F8-\u02FF\u0370-\u037D\u037F-\u1FFF\u200C-\u200D\u2070-\u218F\u2C00-\u2FEF\u3001-\uD7FF\uF900-\uFDCF\uFDF0-\uFFFD][:A-Z_a-z\u00C0-\u00D6\u00D8-\u00F6\u00F8-\u02FF\u0370-\u037D\u037F-\u1FFF\u200C-\u200D\u2070-\u218F\u2C00-\u2FEF\u3001-\uD7FF\uF900-\uFDCF\uFDF0-\uFFFD\-.0-9\u00B7\u0300-\u036F\u203F-\u2040]*$/,U_=Object.prototype.hasOwnProperty,$_={},L_={};function Nk(n){return U_.call(L_,n)?!0:U_.call($_,n)?!1:Dk.test(n)?L_[n]=!0:($_[n]=!0,!1)}function Pk(n,e,t,r){if(t!==null&&t.type===0)return!1;switch(typeof e){case"function":case"symbol":return!0;case"boolean":return r?!1:t!==null?!t.acceptsBooleans:(n=n.toLowerCase().slice(0,5),n!=="data-"&&n!=="aria-");default:return!1}}function Ok(n,e,t,r){if(e===null||typeof e>"u"||Pk(n,e,t,r))return!0;if(r)return!1;if(t!==null)switch(t.type){case 3:return!e;case 4:return e===!1;case 5:return isNaN(e);case 6:return isNaN(e)||1>e}return!1}function Tt(n,e,t,r,i,s,o){this.acceptsBooleans=e===2||e===3||e===4,this.attributeName=r,this.attributeNamespace=i,this.mustUseProperty=t,this.propertyName=n,this.type=e,this.sanitizeURL=s,this.removeEmptyString=o}var at={};"children dangerouslySetInnerHTML defaultValue defaultChecked innerHTML suppressContentEditableWarning suppressHydrationWarning style".split(" ").forEach(function(n){at[n]=new Tt(n,0,!1,n,null,!1,!1)});[["acceptCharset","accept-charset"],["className","class"],["htmlFor","for"],["httpEquiv","http-equiv"]].forEach(function(n){var e=n[0];at[e]=new Tt(e,1,!1,n[1],null,!1,!1)});["contentEditable","draggable","spellCheck","value"].forEach(function(n){at[n]=new Tt(n,2,!1,n.toLowerCase(),null,!1,!1)});["autoReverse","externalResourcesRequired","focusable","preserveAlpha"].forEach(function(n){at[n]=new Tt(n,2,!1,n,null,!1,!1)});"allowFullScreen async autoFocus autoPlay controls default defer disabled disablePictureInPicture disableRemotePlayback formNoValidate hidden loop noModule noValidate open playsInline readOnly required reversed scoped seamless itemScope".split(" ").forEach(function(n){at[n]=new Tt(n,3,!1,n.toLowerCase(),null,!1,!1)});["checked","multiple","muted","selected"].forEach(function(n){at[n]=new Tt(n,3,!0,n,null,!1,!1)});["capture","download"].forEach(function(n){at[n]=new Tt(n,4,!1,n,null,!1,!1)});["cols","rows","size","span"].forEach(function(n){at[n]=new Tt(n,6,!1,n,null,!1,!1)});["rowSpan","start"].forEach(function(n){at[n]=new Tt(n,5,!1,n.toLowerCase(),null,!1,!1)});var Mp=/[\-:]([a-z])/g;function xp(n){return n[1].toUpperCase()}"accent-height alignment-baseline arabic-form baseline-shift cap-height clip-path clip-rule color-interpolation color-interpolation-filters color-profile color-rendering dominant-baseline enable-background fill-opacity fill-rule flood-color flood-opacity font-family font-size font-size-adjust font-stretch font-style font-variant font-weight glyph-name glyph-orientation-horizontal glyph-orientation-vertical horiz-adv-x horiz-origin-x image-rendering letter-spacing lighting-color marker-end marker-mid marker-start overline-position overline-thickness paint-order panose-1 pointer-events rendering-intent shape-rendering stop-color stop-opacity strikethrough-position strikethrough-thickness stroke-dasharray stroke-dashoffset stroke-linecap stroke-linejoin stroke-miterlimit stroke-opacity stroke-width text-anchor text-decoration text-rendering underline-position underline-thickness unicode-bidi unicode-range units-per-em v-alphabetic v-hanging v-ideographic v-mathematical vector-effect vert-adv-y vert-origin-x vert-origin-y word-spacing writing-mode xmlns:xlink x-height".split(" ").forEach(function(n){var e=n.replace(Mp,xp);at[e]=new Tt(e,1,!1,n,null,!1,!1)});"xlink:actuate xlink:arcrole xlink:role xlink:show xlink:title xlink:type".split(" ").forEach(function(n){var e=n.replace(Mp,xp);at[e]=new Tt(e,1,!1,n,"http://www.w3.org/1999/xlink",!1,!1)});["xml:base","xml:lang","xml:space"].forEach(function(n){var e=n.replace(Mp,xp);at[e]=new Tt(e,1,!1,n,"http://www.w3.org/XML/1998/namespace",!1,!1)});["tabIndex","crossOrigin"].forEach(function(n){at[n]=new Tt(n,1,!1,n.toLowerCase(),null,!1,!1)});at.xlinkHref=new Tt("xlinkHref",1,!1,"xlink:href","http://www.w3.org/1999/xlink",!0,!1);["src","href","action","formAction"].forEach(function(n){at[n]=new Tt(n,1,!1,n.toLowerCase(),null,!0,!0)});function Ap(n,e,t,r){var i=at.hasOwnProperty(e)?at[e]:null,s=i!==null?i.type===0:r?!1:!(!(2<e.length)||e[0]!=="o"&&e[0]!=="O"||e[1]!=="n"&&e[1]!=="N");s||(Ok(e,t,i,r)&&(t=null),r||i===null?Nk(e)&&(t===null?n.removeAttribute(e):n.setAttribute(e,""+t)):i.mustUseProperty?n[i.propertyName]=t===null?i.type===3?!1:"":t:(e=i.attributeName,r=i.attributeNamespace,t===null?n.removeAttribute(e):(i=i.type,t=i===3||i===4&&t===!0?"":""+t,r?n.setAttributeNS(r,e,t):n.setAttribute(e,t))))}var ss=qu.__SECRET_INTERNALS_DO_NOT_USE_OR_YOU_WILL_BE_FIRED,ua=60103,Pi=60106,Or=60107,Dp=60108,Ea=60114,Np=60109,Pp=60110,Wu=60112,ka=60113,Wc=60120,Yu=60115,Op=60116,Up=60121,$p=60128,Nw=60129,Lp=60130,Wh=60131;if(typeof Symbol=="function"&&Symbol.for){var Xe=Symbol.for;ua=Xe("react.element"),Pi=Xe("react.portal"),Or=Xe("react.fragment"),Dp=Xe("react.strict_mode"),Ea=Xe("react.profiler"),Np=Xe("react.provider"),Pp=Xe("react.context"),Wu=Xe("react.forward_ref"),ka=Xe("react.suspense"),Wc=Xe("react.suspense_list"),Yu=Xe("react.memo"),Op=Xe("react.lazy"),Up=Xe("react.block"),Xe("react.scope"),$p=Xe("react.opaque.id"),Nw=Xe("react.debug_trace_mode"),Lp=Xe("react.offscreen"),Wh=Xe("react.legacy_hidden")}var F_=typeof Symbol=="function"&&Symbol.iterator;function jo(n){return n===null||typeof n!="object"?null:(n=F_&&n[F_]||n["@@iterator"],typeof n=="function"?n:null)}var Kd;function da(n){if(Kd===void 0)try{throw Error()}catch(t){var e=t.stack.trim().match(/\n( *(at )?)/);Kd=e&&e[1]||""}return`
`+Kd+n}var jd=!1;function Ul(n,e){if(!n||jd)return"";jd=!0;var t=Error.prepareStackTrace;Error.prepareStackTrace=void 0;try{if(e)if(e=function(){throw Error()},Object.defineProperty(e.prototype,"props",{set:function(){throw Error()}}),typeof Reflect=="object"&&Reflect.construct){try{Reflect.construct(e,[])}catch(c){var r=c}Reflect.construct(n,[],e)}else{try{e.call()}catch(c){r=c}n.call(e.prototype)}else{try{throw Error()}catch(c){r=c}n()}}catch(c){if(c&&r&&typeof c.stack=="string"){for(var i=c.stack.split(`
`),s=r.stack.split(`
`),o=i.length-1,a=s.length-1;1<=o&&0<=a&&i[o]!==s[a];)a--;for(;1<=o&&0<=a;o--,a--)if(i[o]!==s[a]){if(o!==1||a!==1)do if(o--,a--,0>a||i[o]!==s[a])return`
`+i[o].replace(" at new "," at ");while(1<=o&&0<=a);break}}}finally{jd=!1,Error.prepareStackTrace=t}return(n=n?n.displayName||n.name:"")?da(n):""}function Uk(n){switch(n.tag){case 5:return da(n.type);case 16:return da("Lazy");case 13:return da("Suspense");case 19:return da("SuspenseList");case 0:case 2:case 15:return n=Ul(n.type,!1),n;case 11:return n=Ul(n.type.render,!1),n;case 22:return n=Ul(n.type._render,!1),n;case 1:return n=Ul(n.type,!0),n;default:return""}}function Ds(n){if(n==null)return null;if(typeof n=="function")return n.displayName||n.name||null;if(typeof n=="string")return n;switch(n){case Or:return"Fragment";case Pi:return"Portal";case Ea:return"Profiler";case Dp:return"StrictMode";case ka:return"Suspense";case Wc:return"SuspenseList"}if(typeof n=="object")switch(n.$$typeof){case Pp:return(n.displayName||"Context")+".Consumer";case Np:return(n._context.displayName||"Context")+".Provider";case Wu:var e=n.render;return e=e.displayName||e.name||"",n.displayName||(e!==""?"ForwardRef("+e+")":"ForwardRef");case Yu:return Ds(n.type);case Up:return Ds(n._render);case Op:e=n._payload,n=n._init;try{return Ds(n(e))}catch{}}return null}function ai(n){switch(typeof n){case"boolean":case"number":case"object":case"string":case"undefined":return n;default:return""}}function Pw(n){var e=n.type;return(n=n.nodeName)&&n.toLowerCase()==="input"&&(e==="checkbox"||e==="radio")}function $k(n){var e=Pw(n)?"checked":"value",t=Object.getOwnPropertyDescriptor(n.constructor.prototype,e),r=""+n[e];if(!n.hasOwnProperty(e)&&typeof t<"u"&&typeof t.get=="function"&&typeof t.set=="function"){var i=t.get,s=t.set;return Object.defineProperty(n,e,{configurable:!0,get:function(){return i.call(this)},set:function(o){r=""+o,s.call(this,o)}}),Object.defineProperty(n,e,{enumerable:t.enumerable}),{getValue:function(){return r},setValue:function(o){r=""+o},stopTracking:function(){n._valueTracker=null,delete n[e]}}}}function $l(n){n._valueTracker||(n._valueTracker=$k(n))}function Ow(n){if(!n)return!1;var e=n._valueTracker;if(!e)return!0;var t=e.getValue(),r="";return n&&(r=Pw(n)?n.checked?"true":"false":n.value),n=r,n!==t?(e.setValue(n),!0):!1}function Yc(n){if(n=n||(typeof document<"u"?document:void 0),typeof n>"u")return null;try{return n.activeElement||n.body}catch{return n.body}}function Yh(n,e){var t=e.checked;return Me({},e,{defaultChecked:void 0,defaultValue:void 0,value:void 0,checked:t??n._wrapperState.initialChecked})}function B_(n,e){var t=e.defaultValue==null?"":e.defaultValue,r=e.checked!=null?e.checked:e.defaultChecked;t=ai(e.value!=null?e.value:t),n._wrapperState={initialChecked:r,initialValue:t,controlled:e.type==="checkbox"||e.type==="radio"?e.checked!=null:e.value!=null}}function Uw(n,e){e=e.checked,e!=null&&Ap(n,"checked",e,!1)}function Xh(n,e){Uw(n,e);var t=ai(e.value),r=e.type;if(t!=null)r==="number"?(t===0&&n.value===""||n.value!=t)&&(n.value=""+t):n.value!==""+t&&(n.value=""+t);else if(r==="submit"||r==="reset"){n.removeAttribute("value");return}e.hasOwnProperty("value")?Jh(n,e.type,t):e.hasOwnProperty("defaultValue")&&Jh(n,e.type,ai(e.defaultValue)),e.checked==null&&e.defaultChecked!=null&&(n.defaultChecked=!!e.defaultChecked)}function V_(n,e,t){if(e.hasOwnProperty("value")||e.hasOwnProperty("defaultValue")){var r=e.type;if(!(r!=="submit"&&r!=="reset"||e.value!==void 0&&e.value!==null))return;e=""+n._wrapperState.initialValue,t||e===n.value||(n.value=e),n.defaultValue=e}t=n.name,t!==""&&(n.name=""),n.defaultChecked=!!n._wrapperState.initialChecked,t!==""&&(n.name=t)}function Jh(n,e,t){(e!=="number"||Yc(n.ownerDocument)!==n)&&(t==null?n.defaultValue=""+n._wrapperState.initialValue:n.defaultValue!==""+t&&(n.defaultValue=""+t))}function Lk(n){var e="";return qu.Children.forEach(n,function(t){t!=null&&(e+=t)}),e}function Qh(n,e){return n=Me({children:void 0},e),(e=Lk(e.children))&&(n.children=e),n}function Ns(n,e,t,r){if(n=n.options,e){e={};for(var i=0;i<t.length;i++)e["$"+t[i]]=!0;for(t=0;t<n.length;t++)i=e.hasOwnProperty("$"+n[t].value),n[t].selected!==i&&(n[t].selected=i),i&&r&&(n[t].defaultSelected=!0)}else{for(t=""+ai(t),e=null,i=0;i<n.length;i++){if(n[i].value===t){n[i].selected=!0,r&&(n[i].defaultSelected=!0);return}e!==null||n[i].disabled||(e=n[i])}e!==null&&(e.selected=!0)}}function Zh(n,e){if(e.dangerouslySetInnerHTML!=null)throw Error(L(91));return Me({},e,{value:void 0,defaultValue:void 0,children:""+n._wrapperState.initialValue})}function K_(n,e){var t=e.value;if(t==null){if(t=e.children,e=e.defaultValue,t!=null){if(e!=null)throw Error(L(92));if(Array.isArray(t)){if(!(1>=t.length))throw Error(L(93));t=t[0]}e=t}e==null&&(e=""),t=e}n._wrapperState={initialValue:ai(t)}}function $w(n,e){var t=ai(e.value),r=ai(e.defaultValue);t!=null&&(t=""+t,t!==n.value&&(n.value=t),e.defaultValue==null&&n.defaultValue!==t&&(n.defaultValue=t)),r!=null&&(n.defaultValue=""+r)}function j_(n){var e=n.textContent;e===n._wrapperState.initialValue&&e!==""&&e!==null&&(n.value=e)}var ef={html:"http://www.w3.org/1999/xhtml",mathml:"http://www.w3.org/1998/Math/MathML",svg:"http://www.w3.org/2000/svg"};function Lw(n){switch(n){case"svg":return"http://www.w3.org/2000/svg";case"math":return"http://www.w3.org/1998/Math/MathML";default:return"http://www.w3.org/1999/xhtml"}}function tf(n,e){return n==null||n==="http://www.w3.org/1999/xhtml"?Lw(e):n==="http://www.w3.org/2000/svg"&&e==="foreignObject"?"http://www.w3.org/1999/xhtml":n}var Ll,Fw=function(n){return typeof MSApp<"u"&&MSApp.execUnsafeLocalFunction?function(e,t,r,i){MSApp.execUnsafeLocalFunction(function(){return n(e,t,r,i)})}:n}(function(n,e){if(n.namespaceURI!==ef.svg||"innerHTML"in n)n.innerHTML=e;else{for(Ll=Ll||document.createElement("div"),Ll.innerHTML="<svg>"+e.valueOf().toString()+"</svg>",e=Ll.firstChild;n.firstChild;)n.removeChild(n.firstChild);for(;e.firstChild;)n.appendChild(e.firstChild)}});function Va(n,e){if(e){var t=n.firstChild;if(t&&t===n.lastChild&&t.nodeType===3){t.nodeValue=e;return}}n.textContent=e}var Ia={animationIterationCount:!0,borderImageOutset:!0,borderImageSlice:!0,borderImageWidth:!0,boxFlex:!0,boxFlexGroup:!0,boxOrdinalGroup:!0,columnCount:!0,columns:!0,flex:!0,flexGrow:!0,flexPositive:!0,flexShrink:!0,flexNegative:!0,flexOrder:!0,gridArea:!0,gridRow:!0,gridRowEnd:!0,gridRowSpan:!0,gridRowStart:!0,gridColumn:!0,gridColumnEnd:!0,gridColumnSpan:!0,gridColumnStart:!0,fontWeight:!0,lineClamp:!0,lineHeight:!0,opacity:!0,order:!0,orphans:!0,tabSize:!0,widows:!0,zIndex:!0,zoom:!0,fillOpacity:!0,floodOpacity:!0,stopOpacity:!0,strokeDasharray:!0,strokeDashoffset:!0,strokeMiterlimit:!0,strokeOpacity:!0,strokeWidth:!0},Fk=["Webkit","ms","Moz","O"];Object.keys(Ia).forEach(function(n){Fk.forEach(function(e){e=e+n.charAt(0).toUpperCase()+n.substring(1),Ia[e]=Ia[n]})});function Bw(n,e,t){return e==null||typeof e=="boolean"||e===""?"":t||typeof e!="number"||e===0||Ia.hasOwnProperty(n)&&Ia[n]?(""+e).trim():e+"px"}function Vw(n,e){n=n.style;for(var t in e)if(e.hasOwnProperty(t)){var r=t.indexOf("--")===0,i=Bw(t,e[t],r);t==="float"&&(t="cssFloat"),r?n.setProperty(t,i):n[t]=i}}var Bk=Me({menuitem:!0},{area:!0,base:!0,br:!0,col:!0,embed:!0,hr:!0,img:!0,input:!0,keygen:!0,link:!0,meta:!0,param:!0,source:!0,track:!0,wbr:!0});function nf(n,e){if(e){if(Bk[n]&&(e.children!=null||e.dangerouslySetInnerHTML!=null))throw Error(L(137,n));if(e.dangerouslySetInnerHTML!=null){if(e.children!=null)throw Error(L(60));if(!(typeof e.dangerouslySetInnerHTML=="object"&&"__html"in e.dangerouslySetInnerHTML))throw Error(L(61))}if(e.style!=null&&typeof e.style!="object")throw Error(L(62))}}function rf(n,e){if(n.indexOf("-")===-1)return typeof e.is=="string";switch(n){case"annotation-xml":case"color-profile":case"font-face":case"font-face-src":case"font-face-uri":case"font-face-format":case"font-face-name":case"missing-glyph":return!1;default:return!0}}function Fp(n){return n=n.target||n.srcElement||window,n.correspondingUseElement&&(n=n.correspondingUseElement),n.nodeType===3?n.parentNode:n}var sf=null,Ps=null,Os=null;function H_(n){if(n=Sl(n)){if(typeof sf!="function")throw Error(L(280));var e=n.stateNode;e&&(e=td(e),sf(n.stateNode,n.type,e))}}function Kw(n){Ps?Os?Os.push(n):Os=[n]:Ps=n}function jw(){if(Ps){var n=Ps,e=Os;if(Os=Ps=null,H_(n),e)for(n=0;n<e.length;n++)H_(e[n])}}function Bp(n,e){return n(e)}function Hw(n,e,t,r,i){return n(e,t,r,i)}function Vp(){}var zw=Bp,Oi=!1,Hd=!1;function Kp(){(Ps!==null||Os!==null)&&(Vp(),jw())}function Vk(n,e,t){if(Hd)return n(e,t);Hd=!0;try{return zw(n,e,t)}finally{Hd=!1,Kp()}}function Ka(n,e){var t=n.stateNode;if(t===null)return null;var r=td(t);if(r===null)return null;t=r[e];e:switch(e){case"onClick":case"onClickCapture":case"onDoubleClick":case"onDoubleClickCapture":case"onMouseDown":case"onMouseDownCapture":case"onMouseMove":case"onMouseMoveCapture":case"onMouseUp":case"onMouseUpCapture":case"onMouseEnter":(r=!r.disabled)||(n=n.type,r=!(n==="button"||n==="input"||n==="select"||n==="textarea")),n=!r;break e;default:n=!1}if(n)return null;if(t&&typeof t!="function")throw Error(L(231,e,typeof t));return t}var of=!1;if(_r)try{var Ho={};Object.defineProperty(Ho,"passive",{get:function(){of=!0}}),window.addEventListener("test",Ho,Ho),window.removeEventListener("test",Ho,Ho)}catch{of=!1}function Kk(n,e,t,r,i,s,o,a,c){var u=Array.prototype.slice.call(arguments,3);try{e.apply(t,u)}catch(l){this.onError(l)}}var Ta=!1,Xc=null,Jc=!1,af=null,jk={onError:function(n){Ta=!0,Xc=n}};function Hk(n,e,t,r,i,s,o,a,c){Ta=!1,Xc=null,Kk.apply(jk,arguments)}function zk(n,e,t,r,i,s,o,a,c){if(Hk.apply(this,arguments),Ta){if(Ta){var u=Xc;Ta=!1,Xc=null}else throw Error(L(198));Jc||(Jc=!0,af=u)}}function os(n){var e=n,t=n;if(n.alternate)for(;e.return;)e=e.return;else{n=e;do e=n,e.flags&1026&&(t=e.return),n=e.return;while(n)}return e.tag===3?t:null}function Gw(n){if(n.tag===13){var e=n.memoizedState;if(e===null&&(n=n.alternate,n!==null&&(e=n.memoizedState)),e!==null)return e.dehydrated}return null}function z_(n){if(os(n)!==n)throw Error(L(188))}function Gk(n){var e=n.alternate;if(!e){if(e=os(n),e===null)throw Error(L(188));return e!==n?null:n}for(var t=n,r=e;;){var i=t.return;if(i===null)break;var s=i.alternate;if(s===null){if(r=i.return,r!==null){t=r;continue}break}if(i.child===s.child){for(s=i.child;s;){if(s===t)return z_(i),n;if(s===r)return z_(i),e;s=s.sibling}throw Error(L(188))}if(t.return!==r.return)t=i,r=s;else{for(var o=!1,a=i.child;a;){if(a===t){o=!0,t=i,r=s;break}if(a===r){o=!0,r=i,t=s;break}a=a.sibling}if(!o){for(a=s.child;a;){if(a===t){o=!0,t=s,r=i;break}if(a===r){o=!0,r=s,t=i;break}a=a.sibling}if(!o)throw Error(L(189))}}if(t.alternate!==r)throw Error(L(190))}if(t.tag!==3)throw Error(L(188));return t.stateNode.current===t?n:e}function qw(n){if(n=Gk(n),!n)return null;for(var e=n;;){if(e.tag===5||e.tag===6)return e;if(e.child)e.child.return=e,e=e.child;else{if(e===n)break;for(;!e.sibling;){if(!e.return||e.return===n)return null;e=e.return}e.sibling.return=e.return,e=e.sibling}}return null}function G_(n,e){for(var t=n.alternate;e!==null;){if(e===n||e===t)return!0;e=e.return}return!1}var Ww,jp,Yw,Xw,lf=!1,Dn=[],qr=null,Wr=null,Yr=null,ja=new Map,Ha=new Map,zo=[],q_="mousedown mouseup touchcancel touchend touchstart auxclick dblclick pointercancel pointerdown pointerup dragend dragstart drop compositionend compositionstart keydown keypress keyup input textInput copy cut paste click change contextmenu reset submit".split(" ");function cf(n,e,t,r,i){return{blockedOn:n,domEventName:e,eventSystemFlags:t|16,nativeEvent:i,targetContainers:[r]}}function W_(n,e){switch(n){case"focusin":case"focusout":qr=null;break;case"dragenter":case"dragleave":Wr=null;break;case"mouseover":case"mouseout":Yr=null;break;case"pointerover":case"pointerout":ja.delete(e.pointerId);break;case"gotpointercapture":case"lostpointercapture":Ha.delete(e.pointerId)}}function Go(n,e,t,r,i,s){return n===null||n.nativeEvent!==s?(n=cf(e,t,r,i,s),e!==null&&(e=Sl(e),e!==null&&jp(e)),n):(n.eventSystemFlags|=r,e=n.targetContainers,i!==null&&e.indexOf(i)===-1&&e.push(i),n)}function qk(n,e,t,r,i){switch(e){case"focusin":return qr=Go(qr,n,e,t,r,i),!0;case"dragenter":return Wr=Go(Wr,n,e,t,r,i),!0;case"mouseover":return Yr=Go(Yr,n,e,t,r,i),!0;case"pointerover":var s=i.pointerId;return ja.set(s,Go(ja.get(s)||null,n,e,t,r,i)),!0;case"gotpointercapture":return s=i.pointerId,Ha.set(s,Go(Ha.get(s)||null,n,e,t,r,i)),!0}return!1}function Wk(n){var e=Ui(n.target);if(e!==null){var t=os(e);if(t!==null){if(e=t.tag,e===13){if(e=Gw(t),e!==null){n.blockedOn=e,Xw(n.lanePriority,function(){Qe.unstable_runWithPriority(n.priority,function(){Yw(t)})});return}}else if(e===3&&t.stateNode.hydrate){n.blockedOn=t.tag===3?t.stateNode.containerInfo:null;return}}}n.blockedOn=null}function xc(n){if(n.blockedOn!==null)return!1;for(var e=n.targetContainers;0<e.length;){var t=qp(n.domEventName,n.eventSystemFlags,e[0],n.nativeEvent);if(t!==null)return e=Sl(t),e!==null&&jp(e),n.blockedOn=t,!1;e.shift()}return!0}function Y_(n,e,t){xc(n)&&t.delete(e)}function Yk(){for(lf=!1;0<Dn.length;){var n=Dn[0];if(n.blockedOn!==null){n=Sl(n.blockedOn),n!==null&&Ww(n);break}for(var e=n.targetContainers;0<e.length;){var t=qp(n.domEventName,n.eventSystemFlags,e[0],n.nativeEvent);if(t!==null){n.blockedOn=t;break}e.shift()}n.blockedOn===null&&Dn.shift()}qr!==null&&xc(qr)&&(qr=null),Wr!==null&&xc(Wr)&&(Wr=null),Yr!==null&&xc(Yr)&&(Yr=null),ja.forEach(Y_),Ha.forEach(Y_)}function qo(n,e){n.blockedOn===e&&(n.blockedOn=null,lf||(lf=!0,Qe.unstable_scheduleCallback(Qe.unstable_NormalPriority,Yk)))}function Jw(n){function e(i){return qo(i,n)}if(0<Dn.length){qo(Dn[0],n);for(var t=1;t<Dn.length;t++){var r=Dn[t];r.blockedOn===n&&(r.blockedOn=null)}}for(qr!==null&&qo(qr,n),Wr!==null&&qo(Wr,n),Yr!==null&&qo(Yr,n),ja.forEach(e),Ha.forEach(e),t=0;t<zo.length;t++)r=zo[t],r.blockedOn===n&&(r.blockedOn=null);for(;0<zo.length&&(t=zo[0],t.blockedOn===null);)Wk(t),t.blockedOn===null&&zo.shift()}function Fl(n,e){var t={};return t[n.toLowerCase()]=e.toLowerCase(),t["Webkit"+n]="webkit"+e,t["Moz"+n]="moz"+e,t}var Ss={animationend:Fl("Animation","AnimationEnd"),animationiteration:Fl("Animation","AnimationIteration"),animationstart:Fl("Animation","AnimationStart"),transitionend:Fl("Transition","TransitionEnd")},zd={},Qw={};_r&&(Qw=document.createElement("div").style,"AnimationEvent"in window||(delete Ss.animationend.animation,delete Ss.animationiteration.animation,delete Ss.animationstart.animation),"TransitionEvent"in window||delete Ss.transitionend.transition);function Xu(n){if(zd[n])return zd[n];if(!Ss[n])return n;var e=Ss[n],t;for(t in e)if(e.hasOwnProperty(t)&&t in Qw)return zd[n]=e[t];return n}var Zw=Xu("animationend"),eb=Xu("animationiteration"),tb=Xu("animationstart"),nb=Xu("transitionend"),rb=new Map,Hp=new Map,Xk=["abort","abort",Zw,"animationEnd",eb,"animationIteration",tb,"animationStart","canplay","canPlay","canplaythrough","canPlayThrough","durationchange","durationChange","emptied","emptied","encrypted","encrypted","ended","ended","error","error","gotpointercapture","gotPointerCapture","load","load","loadeddata","loadedData","loadedmetadata","loadedMetadata","loadstart","loadStart","lostpointercapture","lostPointerCapture","playing","playing","progress","progress","seeking","seeking","stalled","stalled","suspend","suspend","timeupdate","timeUpdate",nb,"transitionEnd","waiting","waiting"];function zp(n,e){for(var t=0;t<n.length;t+=2){var r=n[t],i=n[t+1];i="on"+(i[0].toUpperCase()+i.slice(1)),Hp.set(r,e),rb.set(r,i),is(i,[r])}}var Jk=Qe.unstable_now;Jk();var Se=8;function _s(n){if(1&n)return Se=15,1;if(2&n)return Se=14,2;if(4&n)return Se=13,4;var e=24&n;return e!==0?(Se=12,e):n&32?(Se=11,32):(e=192&n,e!==0?(Se=10,e):n&256?(Se=9,256):(e=3584&n,e!==0?(Se=8,e):n&4096?(Se=7,4096):(e=4186112&n,e!==0?(Se=6,e):(e=62914560&n,e!==0?(Se=5,e):n&67108864?(Se=4,67108864):n&134217728?(Se=3,134217728):(e=805306368&n,e!==0?(Se=2,e):1073741824&n?(Se=1,1073741824):(Se=8,n))))))}function Qk(n){switch(n){case 99:return 15;case 98:return 10;case 97:case 96:return 8;case 95:return 2;default:return 0}}function Zk(n){switch(n){case 15:case 14:return 99;case 13:case 12:case 11:case 10:return 98;case 9:case 8:case 7:case 6:case 4:case 5:return 97;case 3:case 2:case 1:return 95;case 0:return 90;default:throw Error(L(358,n))}}function za(n,e){var t=n.pendingLanes;if(t===0)return Se=0;var r=0,i=0,s=n.expiredLanes,o=n.suspendedLanes,a=n.pingedLanes;if(s!==0)r=s,i=Se=15;else if(s=t&134217727,s!==0){var c=s&~o;c!==0?(r=_s(c),i=Se):(a&=s,a!==0&&(r=_s(a),i=Se))}else s=t&~o,s!==0?(r=_s(s),i=Se):a!==0&&(r=_s(a),i=Se);if(r===0)return 0;if(r=31-li(r),r=t&((0>r?0:1<<r)<<1)-1,e!==0&&e!==r&&!(e&o)){if(_s(e),i<=Se)return e;Se=i}if(e=n.entangledLanes,e!==0)for(n=n.entanglements,e&=r;0<e;)t=31-li(e),i=1<<t,r|=n[t],e&=~i;return r}function ib(n){return n=n.pendingLanes&-1073741825,n!==0?n:n&1073741824?1073741824:0}function Qc(n,e){switch(n){case 15:return 1;case 14:return 2;case 12:return n=gs(24&~e),n===0?Qc(10,e):n;case 10:return n=gs(192&~e),n===0?Qc(8,e):n;case 8:return n=gs(3584&~e),n===0&&(n=gs(4186112&~e),n===0&&(n=512)),n;case 2:return e=gs(805306368&~e),e===0&&(e=268435456),e}throw Error(L(358,n))}function gs(n){return n&-n}function Gd(n){for(var e=[],t=0;31>t;t++)e.push(n);return e}function Ju(n,e,t){n.pendingLanes|=e;var r=e-1;n.suspendedLanes&=r,n.pingedLanes&=r,n=n.eventTimes,e=31-li(e),n[e]=t}var li=Math.clz32?Math.clz32:nI,eI=Math.log,tI=Math.LN2;function nI(n){return n===0?32:31-(eI(n)/tI|0)|0}var rI=Qe.unstable_UserBlockingPriority,iI=Qe.unstable_runWithPriority,Ac=!0;function sI(n,e,t,r){Oi||Vp();var i=Gp,s=Oi;Oi=!0;try{Hw(i,n,e,t,r)}finally{(Oi=s)||Kp()}}function oI(n,e,t,r){iI(rI,Gp.bind(null,n,e,t,r))}function Gp(n,e,t,r){if(Ac){var i;if((i=(e&4)===0)&&0<Dn.length&&-1<q_.indexOf(n))n=cf(null,n,e,t,r),Dn.push(n);else{var s=qp(n,e,t,r);if(s===null)i&&W_(n,r);else{if(i){if(-1<q_.indexOf(n)){n=cf(s,n,e,t,r),Dn.push(n);return}if(qk(s,n,e,t,r))return;W_(n,r)}gb(n,e,r,null,t)}}}}function qp(n,e,t,r){var i=Fp(r);if(i=Ui(i),i!==null){var s=os(i);if(s===null)i=null;else{var o=s.tag;if(o===13){if(i=Gw(s),i!==null)return i;i=null}else if(o===3){if(s.stateNode.hydrate)return s.tag===3?s.stateNode.containerInfo:null;i=null}else s!==i&&(i=null)}}return gb(n,e,r,i,t),null}var Vr=null,Wp=null,Dc=null;function sb(){if(Dc)return Dc;var n,e=Wp,t=e.length,r,i="value"in Vr?Vr.value:Vr.textContent,s=i.length;for(n=0;n<t&&e[n]===i[n];n++);var o=t-n;for(r=1;r<=o&&e[t-r]===i[s-r];r++);return Dc=i.slice(n,1<r?1-r:void 0)}function Nc(n){var e=n.keyCode;return"charCode"in n?(n=n.charCode,n===0&&e===13&&(n=13)):n=e,n===10&&(n=13),32<=n||n===13?n:0}function Bl(){return!0}function X_(){return!1}function qt(n){function e(t,r,i,s,o){this._reactName=t,this._targetInst=i,this.type=r,this.nativeEvent=s,this.target=o,this.currentTarget=null;for(var a in n)n.hasOwnProperty(a)&&(t=n[a],this[a]=t?t(s):s[a]);return this.isDefaultPrevented=(s.defaultPrevented!=null?s.defaultPrevented:s.returnValue===!1)?Bl:X_,this.isPropagationStopped=X_,this}return Me(e.prototype,{preventDefault:function(){this.defaultPrevented=!0;var t=this.nativeEvent;t&&(t.preventDefault?t.preventDefault():typeof t.returnValue!="unknown"&&(t.returnValue=!1),this.isDefaultPrevented=Bl)},stopPropagation:function(){var t=this.nativeEvent;t&&(t.stopPropagation?t.stopPropagation():typeof t.cancelBubble!="unknown"&&(t.cancelBubble=!0),this.isPropagationStopped=Bl)},persist:function(){},isPersistent:Bl}),e}var yo={eventPhase:0,bubbles:0,cancelable:0,timeStamp:function(n){return n.timeStamp||Date.now()},defaultPrevented:0,isTrusted:0},Yp=qt(yo),bl=Me({},yo,{view:0,detail:0}),aI=qt(bl),qd,Wd,Wo,Qu=Me({},bl,{screenX:0,screenY:0,clientX:0,clientY:0,pageX:0,pageY:0,ctrlKey:0,shiftKey:0,altKey:0,metaKey:0,getModifierState:Xp,button:0,buttons:0,relatedTarget:function(n){return n.relatedTarget===void 0?n.fromElement===n.srcElement?n.toElement:n.fromElement:n.relatedTarget},movementX:function(n){return"movementX"in n?n.movementX:(n!==Wo&&(Wo&&n.type==="mousemove"?(qd=n.screenX-Wo.screenX,Wd=n.screenY-Wo.screenY):Wd=qd=0,Wo=n),qd)},movementY:function(n){return"movementY"in n?n.movementY:Wd}}),J_=qt(Qu),lI=Me({},Qu,{dataTransfer:0}),cI=qt(lI),uI=Me({},bl,{relatedTarget:0}),Yd=qt(uI),dI=Me({},yo,{animationName:0,elapsedTime:0,pseudoElement:0}),hI=qt(dI),fI=Me({},yo,{clipboardData:function(n){return"clipboardData"in n?n.clipboardData:window.clipboardData}}),pI=qt(fI),mI=Me({},yo,{data:0}),Q_=qt(mI),_I={Esc:"Escape",Spacebar:" ",Left:"ArrowLeft",Up:"ArrowUp",Right:"ArrowRight",Down:"ArrowDown",Del:"Delete",Win:"OS",Menu:"ContextMenu",Apps:"ContextMenu",Scroll:"ScrollLock",MozPrintableKey:"Unidentified"},gI={8:"Backspace",9:"Tab",12:"Clear",13:"Enter",16:"Shift",17:"Control",18:"Alt",19:"Pause",20:"CapsLock",27:"Escape",32:" ",33:"PageUp",34:"PageDown",35:"End",36:"Home",37:"ArrowLeft",38:"ArrowUp",39:"ArrowRight",40:"ArrowDown",45:"Insert",46:"Delete",112:"F1",113:"F2",114:"F3",115:"F4",116:"F5",117:"F6",118:"F7",119:"F8",120:"F9",121:"F10",122:"F11",123:"F12",144:"NumLock",145:"ScrollLock",224:"Meta"},yI={Alt:"altKey",Control:"ctrlKey",Meta:"metaKey",Shift:"shiftKey"};function vI(n){var e=this.nativeEvent;return e.getModifierState?e.getModifierState(n):(n=yI[n])?!!e[n]:!1}function Xp(){return vI}var wI=Me({},bl,{key:function(n){if(n.key){var e=_I[n.key]||n.key;if(e!=="Unidentified")return e}return n.type==="keypress"?(n=Nc(n),n===13?"Enter":String.fromCharCode(n)):n.type==="keydown"||n.type==="keyup"?gI[n.keyCode]||"Unidentified":""},code:0,location:0,ctrlKey:0,shiftKey:0,altKey:0,metaKey:0,repeat:0,locale:0,getModifierState:Xp,charCode:function(n){return n.type==="keypress"?Nc(n):0},keyCode:function(n){return n.type==="keydown"||n.type==="keyup"?n.keyCode:0},which:function(n){return n.type==="keypress"?Nc(n):n.type==="keydown"||n.type==="keyup"?n.keyCode:0}}),bI=qt(wI),SI=Me({},Qu,{pointerId:0,width:0,height:0,pressure:0,tangentialPressure:0,tiltX:0,tiltY:0,twist:0,pointerType:0,isPrimary:0}),Z_=qt(SI),EI=Me({},bl,{touches:0,targetTouches:0,changedTouches:0,altKey:0,metaKey:0,ctrlKey:0,shiftKey:0,getModifierState:Xp}),kI=qt(EI),II=Me({},yo,{propertyName:0,elapsedTime:0,pseudoElement:0}),TI=qt(II),RI=Me({},Qu,{deltaX:function(n){return"deltaX"in n?n.deltaX:"wheelDeltaX"in n?-n.wheelDeltaX:0},deltaY:function(n){return"deltaY"in n?n.deltaY:"wheelDeltaY"in n?-n.wheelDeltaY:"wheelDelta"in n?-n.wheelDelta:0},deltaZ:0,deltaMode:0}),CI=qt(RI),MI=[9,13,27,32],Jp=_r&&"CompositionEvent"in window,Ra=null;_r&&"documentMode"in document&&(Ra=document.documentMode);var xI=_r&&"TextEvent"in window&&!Ra,ob=_r&&(!Jp||Ra&&8<Ra&&11>=Ra),eg=String.fromCharCode(32),tg=!1;function ab(n,e){switch(n){case"keyup":return MI.indexOf(e.keyCode)!==-1;case"keydown":return e.keyCode!==229;case"keypress":case"mousedown":case"focusout":return!0;default:return!1}}function lb(n){return n=n.detail,typeof n=="object"&&"data"in n?n.data:null}var Es=!1;function AI(n,e){switch(n){case"compositionend":return lb(e);case"keypress":return e.which!==32?null:(tg=!0,eg);case"textInput":return n=e.data,n===eg&&tg?null:n;default:return null}}function DI(n,e){if(Es)return n==="compositionend"||!Jp&&ab(n,e)?(n=sb(),Dc=Wp=Vr=null,Es=!1,n):null;switch(n){case"paste":return null;case"keypress":if(!(e.ctrlKey||e.altKey||e.metaKey)||e.ctrlKey&&e.altKey){if(e.char&&1<e.char.length)return e.char;if(e.which)return String.fromCharCode(e.which)}return null;case"compositionend":return ob&&e.locale!=="ko"?null:e.data;default:return null}}var NI={color:!0,date:!0,datetime:!0,"datetime-local":!0,email:!0,month:!0,number:!0,password:!0,range:!0,search:!0,tel:!0,text:!0,time:!0,url:!0,week:!0};function ng(n){var e=n&&n.nodeName&&n.nodeName.toLowerCase();return e==="input"?!!NI[n.type]:e==="textarea"}function cb(n,e,t,r){Kw(r),e=Zc(e,"onChange"),0<e.length&&(t=new Yp("onChange","change",null,t,r),n.push({event:t,listeners:e}))}var Ca=null,Ga=null;function PI(n){pb(n,0)}function Zu(n){var e=Is(n);if(Ow(e))return n}function OI(n,e){if(n==="change")return e}var ub=!1;if(_r){var Xd;if(_r){var Jd="oninput"in document;if(!Jd){var rg=document.createElement("div");rg.setAttribute("oninput","return;"),Jd=typeof rg.oninput=="function"}Xd=Jd}else Xd=!1;ub=Xd&&(!document.documentMode||9<document.documentMode)}function ig(){Ca&&(Ca.detachEvent("onpropertychange",db),Ga=Ca=null)}function db(n){if(n.propertyName==="value"&&Zu(Ga)){var e=[];if(cb(e,Ga,n,Fp(n)),n=PI,Oi)n(e);else{Oi=!0;try{Bp(n,e)}finally{Oi=!1,Kp()}}}}function UI(n,e,t){n==="focusin"?(ig(),Ca=e,Ga=t,Ca.attachEvent("onpropertychange",db)):n==="focusout"&&ig()}function $I(n){if(n==="selectionchange"||n==="keyup"||n==="keydown")return Zu(Ga)}function LI(n,e){if(n==="click")return Zu(e)}function FI(n,e){if(n==="input"||n==="change")return Zu(e)}function BI(n,e){return n===e&&(n!==0||1/n===1/e)||n!==n&&e!==e}var Qt=typeof Object.is=="function"?Object.is:BI,VI=Object.prototype.hasOwnProperty;function qa(n,e){if(Qt(n,e))return!0;if(typeof n!="object"||n===null||typeof e!="object"||e===null)return!1;var t=Object.keys(n),r=Object.keys(e);if(t.length!==r.length)return!1;for(r=0;r<t.length;r++)if(!VI.call(e,t[r])||!Qt(n[t[r]],e[t[r]]))return!1;return!0}function sg(n){for(;n&&n.firstChild;)n=n.firstChild;return n}function og(n,e){var t=sg(n);n=0;for(var r;t;){if(t.nodeType===3){if(r=n+t.textContent.length,n<=e&&r>=e)return{node:t,offset:e-n};n=r}e:{for(;t;){if(t.nextSibling){t=t.nextSibling;break e}t=t.parentNode}t=void 0}t=sg(t)}}function hb(n,e){return n&&e?n===e?!0:n&&n.nodeType===3?!1:e&&e.nodeType===3?hb(n,e.parentNode):"contains"in n?n.contains(e):n.compareDocumentPosition?!!(n.compareDocumentPosition(e)&16):!1:!1}function ag(){for(var n=window,e=Yc();e instanceof n.HTMLIFrameElement;){try{var t=typeof e.contentWindow.location.href=="string"}catch{t=!1}if(t)n=e.contentWindow;else break;e=Yc(n.document)}return e}function uf(n){var e=n&&n.nodeName&&n.nodeName.toLowerCase();return e&&(e==="input"&&(n.type==="text"||n.type==="search"||n.type==="tel"||n.type==="url"||n.type==="password")||e==="textarea"||n.contentEditable==="true")}var KI=_r&&"documentMode"in document&&11>=document.documentMode,ks=null,df=null,Ma=null,hf=!1;function lg(n,e,t){var r=t.window===t?t.document:t.nodeType===9?t:t.ownerDocument;hf||ks==null||ks!==Yc(r)||(r=ks,"selectionStart"in r&&uf(r)?r={start:r.selectionStart,end:r.selectionEnd}:(r=(r.ownerDocument&&r.ownerDocument.defaultView||window).getSelection(),r={anchorNode:r.anchorNode,anchorOffset:r.anchorOffset,focusNode:r.focusNode,focusOffset:r.focusOffset}),Ma&&qa(Ma,r)||(Ma=r,r=Zc(df,"onSelect"),0<r.length&&(e=new Yp("onSelect","select",null,e,t),n.push({event:e,listeners:r}),e.target=ks)))}zp("cancel cancel click click close close contextmenu contextMenu copy copy cut cut auxclick auxClick dblclick doubleClick dragend dragEnd dragstart dragStart drop drop focusin focus focusout blur input input invalid invalid keydown keyDown keypress keyPress keyup keyUp mousedown mouseDown mouseup mouseUp paste paste pause pause play play pointercancel pointerCancel pointerdown pointerDown pointerup pointerUp ratechange rateChange reset reset seeked seeked submit submit touchcancel touchCancel touchend touchEnd touchstart touchStart volumechange volumeChange".split(" "),0);zp("drag drag dragenter dragEnter dragexit dragExit dragleave dragLeave dragover dragOver mousemove mouseMove mouseout mouseOut mouseover mouseOver pointermove pointerMove pointerout pointerOut pointerover pointerOver scroll scroll toggle toggle touchmove touchMove wheel wheel".split(" "),1);zp(Xk,2);for(var cg="change selectionchange textInput compositionstart compositionend compositionupdate".split(" "),Qd=0;Qd<cg.length;Qd++)Hp.set(cg[Qd],0);Qs("onMouseEnter",["mouseout","mouseover"]);Qs("onMouseLeave",["mouseout","mouseover"]);Qs("onPointerEnter",["pointerout","pointerover"]);Qs("onPointerLeave",["pointerout","pointerover"]);is("onChange","change click focusin focusout input keydown keyup selectionchange".split(" "));is("onSelect","focusout contextmenu dragend focusin keydown keyup mousedown mouseup selectionchange".split(" "));is("onBeforeInput",["compositionend","keypress","textInput","paste"]);is("onCompositionEnd","compositionend focusout keydown keypress keyup mousedown".split(" "));is("onCompositionStart","compositionstart focusout keydown keypress keyup mousedown".split(" "));is("onCompositionUpdate","compositionupdate focusout keydown keypress keyup mousedown".split(" "));var ha="abort canplay canplaythrough durationchange emptied encrypted ended error loadeddata loadedmetadata loadstart pause play playing progress ratechange seeked seeking stalled suspend timeupdate volumechange waiting".split(" "),fb=new Set("cancel close invalid load scroll toggle".split(" ").concat(ha));function ug(n,e,t){var r=n.type||"unknown-event";n.currentTarget=t,zk(r,e,void 0,n),n.currentTarget=null}function pb(n,e){e=(e&4)!==0;for(var t=0;t<n.length;t++){var r=n[t],i=r.event;r=r.listeners;e:{var s=void 0;if(e)for(var o=r.length-1;0<=o;o--){var a=r[o],c=a.instance,u=a.currentTarget;if(a=a.listener,c!==s&&i.isPropagationStopped())break e;ug(i,a,u),s=c}else for(o=0;o<r.length;o++){if(a=r[o],c=a.instance,u=a.currentTarget,a=a.listener,c!==s&&i.isPropagationStopped())break e;ug(i,a,u),s=c}}}if(Jc)throw n=af,Jc=!1,af=null,n}function ke(n,e){var t=vb(e),r=n+"__bubble";t.has(r)||(_b(e,n,2,!1),t.add(r))}var dg="_reactListening"+Math.random().toString(36).slice(2);function mb(n){n[dg]||(n[dg]=!0,Dw.forEach(function(e){fb.has(e)||hg(e,!1,n,null),hg(e,!0,n,null)}))}function hg(n,e,t,r){var i=4<arguments.length&&arguments[4]!==void 0?arguments[4]:0,s=t;if(n==="selectionchange"&&t.nodeType!==9&&(s=t.ownerDocument),r!==null&&!e&&fb.has(n)){if(n!=="scroll")return;i|=2,s=r}var o=vb(s),a=n+"__"+(e?"capture":"bubble");o.has(a)||(e&&(i|=4),_b(s,n,i,e),o.add(a))}function _b(n,e,t,r){var i=Hp.get(e);switch(i===void 0?2:i){case 0:i=sI;break;case 1:i=oI;break;default:i=Gp}t=i.bind(null,e,t,n),i=void 0,!of||e!=="touchstart"&&e!=="touchmove"&&e!=="wheel"||(i=!0),r?i!==void 0?n.addEventListener(e,t,{capture:!0,passive:i}):n.addEventListener(e,t,!0):i!==void 0?n.addEventListener(e,t,{passive:i}):n.addEventListener(e,t,!1)}function gb(n,e,t,r,i){var s=r;if(!(e&1)&&!(e&2)&&r!==null)e:for(;;){if(r===null)return;var o=r.tag;if(o===3||o===4){var a=r.stateNode.containerInfo;if(a===i||a.nodeType===8&&a.parentNode===i)break;if(o===4)for(o=r.return;o!==null;){var c=o.tag;if((c===3||c===4)&&(c=o.stateNode.containerInfo,c===i||c.nodeType===8&&c.parentNode===i))return;o=o.return}for(;a!==null;){if(o=Ui(a),o===null)return;if(c=o.tag,c===5||c===6){r=s=o;continue e}a=a.parentNode}}r=r.return}Vk(function(){var u=s,l=Fp(t),d=[];e:{var p=rb.get(n);if(p!==void 0){var m=Yp,w=n;switch(n){case"keypress":if(Nc(t)===0)break e;case"keydown":case"keyup":m=bI;break;case"focusin":w="focus",m=Yd;break;case"focusout":w="blur",m=Yd;break;case"beforeblur":case"afterblur":m=Yd;break;case"click":if(t.button===2)break e;case"auxclick":case"dblclick":case"mousedown":case"mousemove":case"mouseup":case"mouseout":case"mouseover":case"contextmenu":m=J_;break;case"drag":case"dragend":case"dragenter":case"dragexit":case"dragleave":case"dragover":case"dragstart":case"drop":m=cI;break;case"touchcancel":case"touchend":case"touchmove":case"touchstart":m=kI;break;case Zw:case eb:case tb:m=hI;break;case nb:m=TI;break;case"scroll":m=aI;break;case"wheel":m=CI;break;case"copy":case"cut":case"paste":m=pI;break;case"gotpointercapture":case"lostpointercapture":case"pointercancel":case"pointerdown":case"pointermove":case"pointerout":case"pointerover":case"pointerup":m=Z_}var S=(e&4)!==0,v=!S&&n==="scroll",_=S?p!==null?p+"Capture":null:p;S=[];for(var b=u,k;b!==null;){k=b;var g=k.stateNode;if(k.tag===5&&g!==null&&(k=g,_!==null&&(g=Ka(b,_),g!=null&&S.push(Wa(b,g,k)))),v)break;b=b.return}0<S.length&&(p=new m(p,w,null,t,l),d.push({event:p,listeners:S}))}}if(!(e&7)){e:{if(p=n==="mouseover"||n==="pointerover",m=n==="mouseout"||n==="pointerout",p&&!(e&16)&&(w=t.relatedTarget||t.fromElement)&&(Ui(w)||w[vo]))break e;if((m||p)&&(p=l.window===l?l:(p=l.ownerDocument)?p.defaultView||p.parentWindow:window,m?(w=t.relatedTarget||t.toElement,m=u,w=w?Ui(w):null,w!==null&&(v=os(w),w!==v||w.tag!==5&&w.tag!==6)&&(w=null)):(m=null,w=u),m!==w)){if(S=J_,g="onMouseLeave",_="onMouseEnter",b="mouse",(n==="pointerout"||n==="pointerover")&&(S=Z_,g="onPointerLeave",_="onPointerEnter",b="pointer"),v=m==null?p:Is(m),k=w==null?p:Is(w),p=new S(g,b+"leave",m,t,l),p.target=v,p.relatedTarget=k,g=null,Ui(l)===u&&(S=new S(_,b+"enter",w,t,l),S.target=k,S.relatedTarget=v,g=S),v=g,m&&w)t:{for(S=m,_=w,b=0,k=S;k;k=us(k))b++;for(k=0,g=_;g;g=us(g))k++;for(;0<b-k;)S=us(S),b--;for(;0<k-b;)_=us(_),k--;for(;b--;){if(S===_||_!==null&&S===_.alternate)break t;S=us(S),_=us(_)}S=null}else S=null;m!==null&&fg(d,p,m,S,!1),w!==null&&v!==null&&fg(d,v,w,S,!0)}}e:{if(p=u?Is(u):window,m=p.nodeName&&p.nodeName.toLowerCase(),m==="select"||m==="input"&&p.type==="file")var A=OI;else if(ng(p))if(ub)A=FI;else{A=$I;var M=UI}else(m=p.nodeName)&&m.toLowerCase()==="input"&&(p.type==="checkbox"||p.type==="radio")&&(A=LI);if(A&&(A=A(n,u))){cb(d,A,t,l);break e}M&&M(n,p,u),n==="focusout"&&(M=p._wrapperState)&&M.controlled&&p.type==="number"&&Jh(p,"number",p.value)}switch(M=u?Is(u):window,n){case"focusin":(ng(M)||M.contentEditable==="true")&&(ks=M,df=u,Ma=null);break;case"focusout":Ma=df=ks=null;break;case"mousedown":hf=!0;break;case"contextmenu":case"mouseup":case"dragend":hf=!1,lg(d,t,l);break;case"selectionchange":if(KI)break;case"keydown":case"keyup":lg(d,t,l)}var C;if(Jp)e:{switch(n){case"compositionstart":var P="onCompositionStart";break e;case"compositionend":P="onCompositionEnd";break e;case"compositionupdate":P="onCompositionUpdate";break e}P=void 0}else Es?ab(n,t)&&(P="onCompositionEnd"):n==="keydown"&&t.keyCode===229&&(P="onCompositionStart");P&&(ob&&t.locale!=="ko"&&(Es||P!=="onCompositionStart"?P==="onCompositionEnd"&&Es&&(C=sb()):(Vr=l,Wp="value"in Vr?Vr.value:Vr.textContent,Es=!0)),M=Zc(u,P),0<M.length&&(P=new Q_(P,n,null,t,l),d.push({event:P,listeners:M}),C?P.data=C:(C=lb(t),C!==null&&(P.data=C)))),(C=xI?AI(n,t):DI(n,t))&&(u=Zc(u,"onBeforeInput"),0<u.length&&(l=new Q_("onBeforeInput","beforeinput",null,t,l),d.push({event:l,listeners:u}),l.data=C))}pb(d,e)})}function Wa(n,e,t){return{instance:n,listener:e,currentTarget:t}}function Zc(n,e){for(var t=e+"Capture",r=[];n!==null;){var i=n,s=i.stateNode;i.tag===5&&s!==null&&(i=s,s=Ka(n,t),s!=null&&r.unshift(Wa(n,s,i)),s=Ka(n,e),s!=null&&r.push(Wa(n,s,i))),n=n.return}return r}function us(n){if(n===null)return null;do n=n.return;while(n&&n.tag!==5);return n||null}function fg(n,e,t,r,i){for(var s=e._reactName,o=[];t!==null&&t!==r;){var a=t,c=a.alternate,u=a.stateNode;if(c!==null&&c===r)break;a.tag===5&&u!==null&&(a=u,i?(c=Ka(t,s),c!=null&&o.unshift(Wa(t,c,a))):i||(c=Ka(t,s),c!=null&&o.push(Wa(t,c,a)))),t=t.return}o.length!==0&&n.push({event:e,listeners:o})}function eu(){}var Zd=null,eh=null;function yb(n,e){switch(n){case"button":case"input":case"select":case"textarea":return!!e.autoFocus}return!1}function ff(n,e){return n==="textarea"||n==="option"||n==="noscript"||typeof e.children=="string"||typeof e.children=="number"||typeof e.dangerouslySetInnerHTML=="object"&&e.dangerouslySetInnerHTML!==null&&e.dangerouslySetInnerHTML.__html!=null}var pg=typeof setTimeout=="function"?setTimeout:void 0,jI=typeof clearTimeout=="function"?clearTimeout:void 0;function Qp(n){n.nodeType===1?n.textContent="":n.nodeType===9&&(n=n.body,n!=null&&(n.textContent=""))}function Us(n){for(;n!=null;n=n.nextSibling){var e=n.nodeType;if(e===1||e===3)break}return n}function mg(n){n=n.previousSibling;for(var e=0;n;){if(n.nodeType===8){var t=n.data;if(t==="$"||t==="$!"||t==="$?"){if(e===0)return n;e--}else t==="/$"&&e++}n=n.previousSibling}return null}var th=0;function HI(n){return{$$typeof:$p,toString:n,valueOf:n}}var ed=Math.random().toString(36).slice(2),Kr="__reactFiber$"+ed,tu="__reactProps$"+ed,vo="__reactContainer$"+ed,_g="__reactEvents$"+ed;function Ui(n){var e=n[Kr];if(e)return e;for(var t=n.parentNode;t;){if(e=t[vo]||t[Kr]){if(t=e.alternate,e.child!==null||t!==null&&t.child!==null)for(n=mg(n);n!==null;){if(t=n[Kr])return t;n=mg(n)}return e}n=t,t=n.parentNode}return null}function Sl(n){return n=n[Kr]||n[vo],!n||n.tag!==5&&n.tag!==6&&n.tag!==13&&n.tag!==3?null:n}function Is(n){if(n.tag===5||n.tag===6)return n.stateNode;throw Error(L(33))}function td(n){return n[tu]||null}function vb(n){var e=n[_g];return e===void 0&&(e=n[_g]=new Set),e}var pf=[],Ts=-1;function pi(n){return{current:n}}function Re(n){0>Ts||(n.current=pf[Ts],pf[Ts]=null,Ts--)}function Pe(n,e){Ts++,pf[Ts]=n.current,n.current=e}var ci={},_t=pi(ci),Nt=pi(!1),Qi=ci;function Zs(n,e){var t=n.type.contextTypes;if(!t)return ci;var r=n.stateNode;if(r&&r.__reactInternalMemoizedUnmaskedChildContext===e)return r.__reactInternalMemoizedMaskedChildContext;var i={},s;for(s in t)i[s]=e[s];return r&&(n=n.stateNode,n.__reactInternalMemoizedUnmaskedChildContext=e,n.__reactInternalMemoizedMaskedChildContext=i),i}function Pt(n){return n=n.childContextTypes,n!=null}function nu(){Re(Nt),Re(_t)}function gg(n,e,t){if(_t.current!==ci)throw Error(L(168));Pe(_t,e),Pe(Nt,t)}function wb(n,e,t){var r=n.stateNode;if(n=e.childContextTypes,typeof r.getChildContext!="function")return t;r=r.getChildContext();for(var i in r)if(!(i in n))throw Error(L(108,Ds(e)||"Unknown",i));return Me({},t,r)}function Pc(n){return n=(n=n.stateNode)&&n.__reactInternalMemoizedMergedChildContext||ci,Qi=_t.current,Pe(_t,n),Pe(Nt,Nt.current),!0}function yg(n,e,t){var r=n.stateNode;if(!r)throw Error(L(169));t?(n=wb(n,e,Qi),r.__reactInternalMemoizedMergedChildContext=n,Re(Nt),Re(_t),Pe(_t,n)):Re(Nt),Pe(Nt,t)}var Zp=null,Ki=null,zI=Qe.unstable_runWithPriority,em=Qe.unstable_scheduleCallback,mf=Qe.unstable_cancelCallback,GI=Qe.unstable_shouldYield,vg=Qe.unstable_requestPaint,_f=Qe.unstable_now,qI=Qe.unstable_getCurrentPriorityLevel,nd=Qe.unstable_ImmediatePriority,bb=Qe.unstable_UserBlockingPriority,Sb=Qe.unstable_NormalPriority,Eb=Qe.unstable_LowPriority,kb=Qe.unstable_IdlePriority,nh={},WI=vg!==void 0?vg:function(){},er=null,Oc=null,rh=!1,wg=_f(),ft=1e4>wg?_f:function(){return _f()-wg};function eo(){switch(qI()){case nd:return 99;case bb:return 98;case Sb:return 97;case Eb:return 96;case kb:return 95;default:throw Error(L(332))}}function Ib(n){switch(n){case 99:return nd;case 98:return bb;case 97:return Sb;case 96:return Eb;case 95:return kb;default:throw Error(L(332))}}function Zi(n,e){return n=Ib(n),zI(n,e)}function Ya(n,e,t){return n=Ib(n),em(n,e,t)}function jn(){if(Oc!==null){var n=Oc;Oc=null,mf(n)}Tb()}function Tb(){if(!rh&&er!==null){rh=!0;var n=0;try{var e=er;Zi(99,function(){for(;n<e.length;n++){var t=e[n];do t=t(!0);while(t!==null)}}),er=null}catch(t){throw er!==null&&(er=er.slice(n+1)),em(nd,jn),t}finally{rh=!1}}}var YI=ss.ReactCurrentBatchConfig;function pn(n,e){if(n&&n.defaultProps){e=Me({},e),n=n.defaultProps;for(var t in n)e[t]===void 0&&(e[t]=n[t]);return e}return e}var ru=pi(null),iu=null,Rs=null,su=null;function tm(){su=Rs=iu=null}function nm(n){var e=ru.current;Re(ru),n.type._context._currentValue=e}function Rb(n,e){for(;n!==null;){var t=n.alternate;if((n.childLanes&e)===e){if(t===null||(t.childLanes&e)===e)break;t.childLanes|=e}else n.childLanes|=e,t!==null&&(t.childLanes|=e);n=n.return}}function $s(n,e){iu=n,su=Rs=null,n=n.dependencies,n!==null&&n.firstContext!==null&&(n.lanes&e&&(gn=!0),n.firstContext=null)}function on(n,e){if(su!==n&&e!==!1&&e!==0)if((typeof e!="number"||e===1073741823)&&(su=n,e=1073741823),e={context:n,observedBits:e,next:null},Rs===null){if(iu===null)throw Error(L(308));Rs=e,iu.dependencies={lanes:0,firstContext:e,responders:null}}else Rs=Rs.next=e;return n._currentValue}var Ar=!1;function rm(n){n.updateQueue={baseState:n.memoizedState,firstBaseUpdate:null,lastBaseUpdate:null,shared:{pending:null},effects:null}}function Cb(n,e){n=n.updateQueue,e.updateQueue===n&&(e.updateQueue={baseState:n.baseState,firstBaseUpdate:n.firstBaseUpdate,lastBaseUpdate:n.lastBaseUpdate,shared:n.shared,effects:n.effects})}function Xr(n,e){return{eventTime:n,lane:e,tag:0,payload:null,callback:null,next:null}}function Jr(n,e){if(n=n.updateQueue,n!==null){n=n.shared;var t=n.pending;t===null?e.next=e:(e.next=t.next,t.next=e),n.pending=e}}function bg(n,e){var t=n.updateQueue,r=n.alternate;if(r!==null&&(r=r.updateQueue,t===r)){var i=null,s=null;if(t=t.firstBaseUpdate,t!==null){do{var o={eventTime:t.eventTime,lane:t.lane,tag:t.tag,payload:t.payload,callback:t.callback,next:null};s===null?i=s=o:s=s.next=o,t=t.next}while(t!==null);s===null?i=s=e:s=s.next=e}else i=s=e;t={baseState:r.baseState,firstBaseUpdate:i,lastBaseUpdate:s,shared:r.shared,effects:r.effects},n.updateQueue=t;return}n=t.lastBaseUpdate,n===null?t.firstBaseUpdate=e:n.next=e,t.lastBaseUpdate=e}function Xa(n,e,t,r){var i=n.updateQueue;Ar=!1;var s=i.firstBaseUpdate,o=i.lastBaseUpdate,a=i.shared.pending;if(a!==null){i.shared.pending=null;var c=a,u=c.next;c.next=null,o===null?s=u:o.next=u,o=c;var l=n.alternate;if(l!==null){l=l.updateQueue;var d=l.lastBaseUpdate;d!==o&&(d===null?l.firstBaseUpdate=u:d.next=u,l.lastBaseUpdate=c)}}if(s!==null){d=i.baseState,o=0,l=u=c=null;do{a=s.lane;var p=s.eventTime;if((r&a)===a){l!==null&&(l=l.next={eventTime:p,lane:0,tag:s.tag,payload:s.payload,callback:s.callback,next:null});e:{var m=n,w=s;switch(a=e,p=t,w.tag){case 1:if(m=w.payload,typeof m=="function"){d=m.call(p,d,a);break e}d=m;break e;case 3:m.flags=m.flags&-4097|64;case 0:if(m=w.payload,a=typeof m=="function"?m.call(p,d,a):m,a==null)break e;d=Me({},d,a);break e;case 2:Ar=!0}}s.callback!==null&&(n.flags|=32,a=i.effects,a===null?i.effects=[s]:a.push(s))}else p={eventTime:p,lane:a,tag:s.tag,payload:s.payload,callback:s.callback,next:null},l===null?(u=l=p,c=d):l=l.next=p,o|=a;if(s=s.next,s===null){if(a=i.shared.pending,a===null)break;s=a.next,a.next=null,i.lastBaseUpdate=a,i.shared.pending=null}}while(1);l===null&&(c=d),i.baseState=c,i.firstBaseUpdate=u,i.lastBaseUpdate=l,kl|=o,n.lanes=o,n.memoizedState=d}}function Sg(n,e,t){if(n=e.effects,e.effects=null,n!==null)for(e=0;e<n.length;e++){var r=n[e],i=r.callback;if(i!==null){if(r.callback=null,r=t,typeof i!="function")throw Error(L(191,i));i.call(r)}}}var Mb=new qu.Component().refs;function ou(n,e,t,r){e=n.memoizedState,t=t(r,e),t=t==null?e:Me({},e,t),n.memoizedState=t,n.lanes===0&&(n.updateQueue.baseState=t)}var rd={isMounted:function(n){return(n=n._reactInternals)?os(n)===n:!1},enqueueSetState:function(n,e,t){n=n._reactInternals;var r=Ht(),i=Qr(n),s=Xr(r,i);s.payload=e,t!=null&&(s.callback=t),Jr(n,s),Zr(n,i,r)},enqueueReplaceState:function(n,e,t){n=n._reactInternals;var r=Ht(),i=Qr(n),s=Xr(r,i);s.tag=1,s.payload=e,t!=null&&(s.callback=t),Jr(n,s),Zr(n,i,r)},enqueueForceUpdate:function(n,e){n=n._reactInternals;var t=Ht(),r=Qr(n),i=Xr(t,r);i.tag=2,e!=null&&(i.callback=e),Jr(n,i),Zr(n,r,t)}};function Eg(n,e,t,r,i,s,o){return n=n.stateNode,typeof n.shouldComponentUpdate=="function"?n.shouldComponentUpdate(r,s,o):e.prototype&&e.prototype.isPureReactComponent?!qa(t,r)||!qa(i,s):!0}function xb(n,e,t){var r=!1,i=ci,s=e.contextType;return typeof s=="object"&&s!==null?s=on(s):(i=Pt(e)?Qi:_t.current,r=e.contextTypes,s=(r=r!=null)?Zs(n,i):ci),e=new e(t,s),n.memoizedState=e.state!==null&&e.state!==void 0?e.state:null,e.updater=rd,n.stateNode=e,e._reactInternals=n,r&&(n=n.stateNode,n.__reactInternalMemoizedUnmaskedChildContext=i,n.__reactInternalMemoizedMaskedChildContext=s),e}function kg(n,e,t,r){n=e.state,typeof e.componentWillReceiveProps=="function"&&e.componentWillReceiveProps(t,r),typeof e.UNSAFE_componentWillReceiveProps=="function"&&e.UNSAFE_componentWillReceiveProps(t,r),e.state!==n&&rd.enqueueReplaceState(e,e.state,null)}function gf(n,e,t,r){var i=n.stateNode;i.props=t,i.state=n.memoizedState,i.refs=Mb,rm(n);var s=e.contextType;typeof s=="object"&&s!==null?i.context=on(s):(s=Pt(e)?Qi:_t.current,i.context=Zs(n,s)),Xa(n,t,i,r),i.state=n.memoizedState,s=e.getDerivedStateFromProps,typeof s=="function"&&(ou(n,e,s,t),i.state=n.memoizedState),typeof e.getDerivedStateFromProps=="function"||typeof i.getSnapshotBeforeUpdate=="function"||typeof i.UNSAFE_componentWillMount!="function"&&typeof i.componentWillMount!="function"||(e=i.state,typeof i.componentWillMount=="function"&&i.componentWillMount(),typeof i.UNSAFE_componentWillMount=="function"&&i.UNSAFE_componentWillMount(),e!==i.state&&rd.enqueueReplaceState(i,i.state,null),Xa(n,t,i,r),i.state=n.memoizedState),typeof i.componentDidMount=="function"&&(n.flags|=4)}var Vl=Array.isArray;function Yo(n,e,t){if(n=t.ref,n!==null&&typeof n!="function"&&typeof n!="object"){if(t._owner){if(t=t._owner,t){if(t.tag!==1)throw Error(L(309));var r=t.stateNode}if(!r)throw Error(L(147,n));var i=""+n;return e!==null&&e.ref!==null&&typeof e.ref=="function"&&e.ref._stringRef===i?e.ref:(e=function(s){var o=r.refs;o===Mb&&(o=r.refs={}),s===null?delete o[i]:o[i]=s},e._stringRef=i,e)}if(typeof n!="string")throw Error(L(284));if(!t._owner)throw Error(L(290,n))}return n}function Kl(n,e){if(n.type!=="textarea")throw Error(L(31,Object.prototype.toString.call(e)==="[object Object]"?"object with keys {"+Object.keys(e).join(", ")+"}":e))}function Ab(n){function e(v,_){if(n){var b=v.lastEffect;b!==null?(b.nextEffect=_,v.lastEffect=_):v.firstEffect=v.lastEffect=_,_.nextEffect=null,_.flags=8}}function t(v,_){if(!n)return null;for(;_!==null;)e(v,_),_=_.sibling;return null}function r(v,_){for(v=new Map;_!==null;)_.key!==null?v.set(_.key,_):v.set(_.index,_),_=_.sibling;return v}function i(v,_){return v=di(v,_),v.index=0,v.sibling=null,v}function s(v,_,b){return v.index=b,n?(b=v.alternate,b!==null?(b=b.index,b<_?(v.flags=2,_):b):(v.flags=2,_)):_}function o(v){return n&&v.alternate===null&&(v.flags=2),v}function a(v,_,b,k){return _===null||_.tag!==6?(_=lh(b,v.mode,k),_.return=v,_):(_=i(_,b),_.return=v,_)}function c(v,_,b,k){return _!==null&&_.elementType===b.type?(k=i(_,b.props),k.ref=Yo(v,_,b),k.return=v,k):(k=Fc(b.type,b.key,b.props,null,v.mode,k),k.ref=Yo(v,_,b),k.return=v,k)}function u(v,_,b,k){return _===null||_.tag!==4||_.stateNode.containerInfo!==b.containerInfo||_.stateNode.implementation!==b.implementation?(_=ch(b,v.mode,k),_.return=v,_):(_=i(_,b.children||[]),_.return=v,_)}function l(v,_,b,k,g){return _===null||_.tag!==7?(_=Vs(b,v.mode,k,g),_.return=v,_):(_=i(_,b),_.return=v,_)}function d(v,_,b){if(typeof _=="string"||typeof _=="number")return _=lh(""+_,v.mode,b),_.return=v,_;if(typeof _=="object"&&_!==null){switch(_.$$typeof){case ua:return b=Fc(_.type,_.key,_.props,null,v.mode,b),b.ref=Yo(v,null,_),b.return=v,b;case Pi:return _=ch(_,v.mode,b),_.return=v,_}if(Vl(_)||jo(_))return _=Vs(_,v.mode,b,null),_.return=v,_;Kl(v,_)}return null}function p(v,_,b,k){var g=_!==null?_.key:null;if(typeof b=="string"||typeof b=="number")return g!==null?null:a(v,_,""+b,k);if(typeof b=="object"&&b!==null){switch(b.$$typeof){case ua:return b.key===g?b.type===Or?l(v,_,b.props.children,k,g):c(v,_,b,k):null;case Pi:return b.key===g?u(v,_,b,k):null}if(Vl(b)||jo(b))return g!==null?null:l(v,_,b,k,null);Kl(v,b)}return null}function m(v,_,b,k,g){if(typeof k=="string"||typeof k=="number")return v=v.get(b)||null,a(_,v,""+k,g);if(typeof k=="object"&&k!==null){switch(k.$$typeof){case ua:return v=v.get(k.key===null?b:k.key)||null,k.type===Or?l(_,v,k.props.children,g,k.key):c(_,v,k,g);case Pi:return v=v.get(k.key===null?b:k.key)||null,u(_,v,k,g)}if(Vl(k)||jo(k))return v=v.get(b)||null,l(_,v,k,g,null);Kl(_,k)}return null}function w(v,_,b,k){for(var g=null,A=null,M=_,C=_=0,P=null;M!==null&&C<b.length;C++){M.index>C?(P=M,M=null):P=M.sibling;var I=p(v,M,b[C],k);if(I===null){M===null&&(M=P);break}n&&M&&I.alternate===null&&e(v,M),_=s(I,_,C),A===null?g=I:A.sibling=I,A=I,M=P}if(C===b.length)return t(v,M),g;if(M===null){for(;C<b.length;C++)M=d(v,b[C],k),M!==null&&(_=s(M,_,C),A===null?g=M:A.sibling=M,A=M);return g}for(M=r(v,M);C<b.length;C++)P=m(M,v,C,b[C],k),P!==null&&(n&&P.alternate!==null&&M.delete(P.key===null?C:P.key),_=s(P,_,C),A===null?g=P:A.sibling=P,A=P);return n&&M.forEach(function($){return e(v,$)}),g}function S(v,_,b,k){var g=jo(b);if(typeof g!="function")throw Error(L(150));if(b=g.call(b),b==null)throw Error(L(151));for(var A=g=null,M=_,C=_=0,P=null,I=b.next();M!==null&&!I.done;C++,I=b.next()){M.index>C?(P=M,M=null):P=M.sibling;var $=p(v,M,I.value,k);if($===null){M===null&&(M=P);break}n&&M&&$.alternate===null&&e(v,M),_=s($,_,C),A===null?g=$:A.sibling=$,A=$,M=P}if(I.done)return t(v,M),g;if(M===null){for(;!I.done;C++,I=b.next())I=d(v,I.value,k),I!==null&&(_=s(I,_,C),A===null?g=I:A.sibling=I,A=I);return g}for(M=r(v,M);!I.done;C++,I=b.next())I=m(M,v,C,I.value,k),I!==null&&(n&&I.alternate!==null&&M.delete(I.key===null?C:I.key),_=s(I,_,C),A===null?g=I:A.sibling=I,A=I);return n&&M.forEach(function(x){return e(v,x)}),g}return function(v,_,b,k){var g=typeof b=="object"&&b!==null&&b.type===Or&&b.key===null;g&&(b=b.props.children);var A=typeof b=="object"&&b!==null;if(A)switch(b.$$typeof){case ua:e:{for(A=b.key,g=_;g!==null;){if(g.key===A){switch(g.tag){case 7:if(b.type===Or){t(v,g.sibling),_=i(g,b.props.children),_.return=v,v=_;break e}break;default:if(g.elementType===b.type){t(v,g.sibling),_=i(g,b.props),_.ref=Yo(v,g,b),_.return=v,v=_;break e}}t(v,g);break}else e(v,g);g=g.sibling}b.type===Or?(_=Vs(b.props.children,v.mode,k,b.key),_.return=v,v=_):(k=Fc(b.type,b.key,b.props,null,v.mode,k),k.ref=Yo(v,_,b),k.return=v,v=k)}return o(v);case Pi:e:{for(g=b.key;_!==null;){if(_.key===g)if(_.tag===4&&_.stateNode.containerInfo===b.containerInfo&&_.stateNode.implementation===b.implementation){t(v,_.sibling),_=i(_,b.children||[]),_.return=v,v=_;break e}else{t(v,_);break}else e(v,_);_=_.sibling}_=ch(b,v.mode,k),_.return=v,v=_}return o(v)}if(typeof b=="string"||typeof b=="number")return b=""+b,_!==null&&_.tag===6?(t(v,_.sibling),_=i(_,b),_.return=v,v=_):(t(v,_),_=lh(b,v.mode,k),_.return=v,v=_),o(v);if(Vl(b))return w(v,_,b,k);if(jo(b))return S(v,_,b,k);if(A&&Kl(v,b),typeof b>"u"&&!g)switch(v.tag){case 1:case 22:case 0:case 11:case 15:throw Error(L(152,Ds(v.type)||"Component"))}return t(v,_)}}var au=Ab(!0),Db=Ab(!1),El={},On=pi(El),Ja=pi(El),Qa=pi(El);function $i(n){if(n===El)throw Error(L(174));return n}function yf(n,e){switch(Pe(Qa,e),Pe(Ja,n),Pe(On,El),n=e.nodeType,n){case 9:case 11:e=(e=e.documentElement)?e.namespaceURI:tf(null,"");break;default:n=n===8?e.parentNode:e,e=n.namespaceURI||null,n=n.tagName,e=tf(e,n)}Re(On),Pe(On,e)}function to(){Re(On),Re(Ja),Re(Qa)}function Ig(n){$i(Qa.current);var e=$i(On.current),t=tf(e,n.type);e!==t&&(Pe(Ja,n),Pe(On,t))}function im(n){Ja.current===n&&(Re(On),Re(Ja))}var Ne=pi(0);function lu(n){for(var e=n;e!==null;){if(e.tag===13){var t=e.memoizedState;if(t!==null&&(t=t.dehydrated,t===null||t.data==="$?"||t.data==="$!"))return e}else if(e.tag===19&&e.memoizedProps.revealOrder!==void 0){if(e.flags&64)return e}else if(e.child!==null){e.child.return=e,e=e.child;continue}if(e===n)break;for(;e.sibling===null;){if(e.return===null||e.return===n)return null;e=e.return}e.sibling.return=e.return,e=e.sibling}return null}var ar=null,jr=null,Un=!1;function Nb(n,e){var t=Zt(5,null,null,0);t.elementType="DELETED",t.type="DELETED",t.stateNode=e,t.return=n,t.flags=8,n.lastEffect!==null?(n.lastEffect.nextEffect=t,n.lastEffect=t):n.firstEffect=n.lastEffect=t}function Tg(n,e){switch(n.tag){case 5:var t=n.type;return e=e.nodeType!==1||t.toLowerCase()!==e.nodeName.toLowerCase()?null:e,e!==null?(n.stateNode=e,!0):!1;case 6:return e=n.pendingProps===""||e.nodeType!==3?null:e,e!==null?(n.stateNode=e,!0):!1;case 13:return!1;default:return!1}}function vf(n){if(Un){var e=jr;if(e){var t=e;if(!Tg(n,e)){if(e=Us(t.nextSibling),!e||!Tg(n,e)){n.flags=n.flags&-1025|2,Un=!1,ar=n;return}Nb(ar,t)}ar=n,jr=Us(e.firstChild)}else n.flags=n.flags&-1025|2,Un=!1,ar=n}}function Rg(n){for(n=n.return;n!==null&&n.tag!==5&&n.tag!==3&&n.tag!==13;)n=n.return;ar=n}function jl(n){if(n!==ar)return!1;if(!Un)return Rg(n),Un=!0,!1;var e=n.type;if(n.tag!==5||e!=="head"&&e!=="body"&&!ff(e,n.memoizedProps))for(e=jr;e;)Nb(n,e),e=Us(e.nextSibling);if(Rg(n),n.tag===13){if(n=n.memoizedState,n=n!==null?n.dehydrated:null,!n)throw Error(L(317));e:{for(n=n.nextSibling,e=0;n;){if(n.nodeType===8){var t=n.data;if(t==="/$"){if(e===0){jr=Us(n.nextSibling);break e}e--}else t!=="$"&&t!=="$!"&&t!=="$?"||e++}n=n.nextSibling}jr=null}}else jr=ar?Us(n.stateNode.nextSibling):null;return!0}function ih(){jr=ar=null,Un=!1}var Ls=[];function sm(){for(var n=0;n<Ls.length;n++)Ls[n]._workInProgressVersionPrimary=null;Ls.length=0}var xa=ss.ReactCurrentDispatcher,rn=ss.ReactCurrentBatchConfig,Za=0,Fe=null,dt=null,it=null,cu=!1,Aa=!1;function Mt(){throw Error(L(321))}function om(n,e){if(e===null)return!1;for(var t=0;t<e.length&&t<n.length;t++)if(!Qt(n[t],e[t]))return!1;return!0}function am(n,e,t,r,i,s){if(Za=s,Fe=e,e.memoizedState=null,e.updateQueue=null,e.lanes=0,xa.current=n===null||n.memoizedState===null?JI:QI,n=t(r,i),Aa){s=0;do{if(Aa=!1,!(25>s))throw Error(L(301));s+=1,it=dt=null,e.updateQueue=null,xa.current=ZI,n=t(r,i)}while(Aa)}if(xa.current=fu,e=dt!==null&&dt.next!==null,Za=0,it=dt=Fe=null,cu=!1,e)throw Error(L(300));return n}function Li(){var n={memoizedState:null,baseState:null,baseQueue:null,queue:null,next:null};return it===null?Fe.memoizedState=it=n:it=it.next=n,it}function as(){if(dt===null){var n=Fe.alternate;n=n!==null?n.memoizedState:null}else n=dt.next;var e=it===null?Fe.memoizedState:it.next;if(e!==null)it=e,dt=n;else{if(n===null)throw Error(L(310));dt=n,n={memoizedState:dt.memoizedState,baseState:dt.baseState,baseQueue:dt.baseQueue,queue:dt.queue,next:null},it===null?Fe.memoizedState=it=n:it=it.next=n}return it}function Nn(n,e){return typeof e=="function"?e(n):e}function Xo(n){var e=as(),t=e.queue;if(t===null)throw Error(L(311));t.lastRenderedReducer=n;var r=dt,i=r.baseQueue,s=t.pending;if(s!==null){if(i!==null){var o=i.next;i.next=s.next,s.next=o}r.baseQueue=i=s,t.pending=null}if(i!==null){i=i.next,r=r.baseState;var a=o=s=null,c=i;do{var u=c.lane;if((Za&u)===u)a!==null&&(a=a.next={lane:0,action:c.action,eagerReducer:c.eagerReducer,eagerState:c.eagerState,next:null}),r=c.eagerReducer===n?c.eagerState:n(r,c.action);else{var l={lane:u,action:c.action,eagerReducer:c.eagerReducer,eagerState:c.eagerState,next:null};a===null?(o=a=l,s=r):a=a.next=l,Fe.lanes|=u,kl|=u}c=c.next}while(c!==null&&c!==i);a===null?s=r:a.next=o,Qt(r,e.memoizedState)||(gn=!0),e.memoizedState=r,e.baseState=s,e.baseQueue=a,t.lastRenderedState=r}return[e.memoizedState,t.dispatch]}function Jo(n){var e=as(),t=e.queue;if(t===null)throw Error(L(311));t.lastRenderedReducer=n;var r=t.dispatch,i=t.pending,s=e.memoizedState;if(i!==null){t.pending=null;var o=i=i.next;do s=n(s,o.action),o=o.next;while(o!==i);Qt(s,e.memoizedState)||(gn=!0),e.memoizedState=s,e.baseQueue===null&&(e.baseState=s),t.lastRenderedState=s}return[s,r]}function Cg(n,e,t){var r=e._getVersion;r=r(e._source);var i=e._workInProgressVersionPrimary;if(i!==null?n=i===r:(n=n.mutableReadLanes,(n=(Za&n)===n)&&(e._workInProgressVersionPrimary=r,Ls.push(e))),n)return t(e._source);throw Ls.push(e),Error(L(350))}function Pb(n,e,t,r){var i=kt;if(i===null)throw Error(L(349));var s=e._getVersion,o=s(e._source),a=xa.current,c=a.useState(function(){return Cg(i,e,t)}),u=c[1],l=c[0];c=it;var d=n.memoizedState,p=d.refs,m=p.getSnapshot,w=d.source;d=d.subscribe;var S=Fe;return n.memoizedState={refs:p,source:e,subscribe:r},a.useEffect(function(){p.getSnapshot=t,p.setSnapshot=u;var v=s(e._source);if(!Qt(o,v)){v=t(e._source),Qt(l,v)||(u(v),v=Qr(S),i.mutableReadLanes|=v&i.pendingLanes),v=i.mutableReadLanes,i.entangledLanes|=v;for(var _=i.entanglements,b=v;0<b;){var k=31-li(b),g=1<<k;_[k]|=v,b&=~g}}},[t,e,r]),a.useEffect(function(){return r(e._source,function(){var v=p.getSnapshot,_=p.setSnapshot;try{_(v(e._source));var b=Qr(S);i.mutableReadLanes|=b&i.pendingLanes}catch(k){_(function(){throw k})}})},[e,r]),Qt(m,t)&&Qt(w,e)&&Qt(d,r)||(n={pending:null,dispatch:null,lastRenderedReducer:Nn,lastRenderedState:l},n.dispatch=u=um.bind(null,Fe,n),c.queue=n,c.baseQueue=null,l=Cg(i,e,t),c.memoizedState=c.baseState=l),l}function Ob(n,e,t){var r=as();return Pb(r,n,e,t)}function Qo(n){var e=Li();return typeof n=="function"&&(n=n()),e.memoizedState=e.baseState=n,n=e.queue={pending:null,dispatch:null,lastRenderedReducer:Nn,lastRenderedState:n},n=n.dispatch=um.bind(null,Fe,n),[e.memoizedState,n]}function uu(n,e,t,r){return n={tag:n,create:e,destroy:t,deps:r,next:null},e=Fe.updateQueue,e===null?(e={lastEffect:null},Fe.updateQueue=e,e.lastEffect=n.next=n):(t=e.lastEffect,t===null?e.lastEffect=n.next=n:(r=t.next,t.next=n,n.next=r,e.lastEffect=n)),n}function Mg(n){var e=Li();return n={current:n},e.memoizedState=n}function du(){return as().memoizedState}function wf(n,e,t,r){var i=Li();Fe.flags|=n,i.memoizedState=uu(1|e,t,void 0,r===void 0?null:r)}function lm(n,e,t,r){var i=as();r=r===void 0?null:r;var s=void 0;if(dt!==null){var o=dt.memoizedState;if(s=o.destroy,r!==null&&om(r,o.deps)){uu(e,t,s,r);return}}Fe.flags|=n,i.memoizedState=uu(1|e,t,s,r)}function xg(n,e){return wf(516,4,n,e)}function hu(n,e){return lm(516,4,n,e)}function Ub(n,e){return lm(4,2,n,e)}function $b(n,e){if(typeof e=="function")return n=n(),e(n),function(){e(null)};if(e!=null)return n=n(),e.current=n,function(){e.current=null}}function Lb(n,e,t){return t=t!=null?t.concat([n]):null,lm(4,2,$b.bind(null,e,n),t)}function cm(){}function Fb(n,e){var t=as();e=e===void 0?null:e;var r=t.memoizedState;return r!==null&&e!==null&&om(e,r[1])?r[0]:(t.memoizedState=[n,e],n)}function Bb(n,e){var t=as();e=e===void 0?null:e;var r=t.memoizedState;return r!==null&&e!==null&&om(e,r[1])?r[0]:(n=n(),t.memoizedState=[n,e],n)}function XI(n,e){var t=eo();Zi(98>t?98:t,function(){n(!0)}),Zi(97<t?97:t,function(){var r=rn.transition;rn.transition=1;try{n(!1),e()}finally{rn.transition=r}})}function um(n,e,t){var r=Ht(),i=Qr(n),s={lane:i,action:t,eagerReducer:null,eagerState:null,next:null},o=e.pending;if(o===null?s.next=s:(s.next=o.next,o.next=s),e.pending=s,o=n.alternate,n===Fe||o!==null&&o===Fe)Aa=cu=!0;else{if(n.lanes===0&&(o===null||o.lanes===0)&&(o=e.lastRenderedReducer,o!==null))try{var a=e.lastRenderedState,c=o(a,t);if(s.eagerReducer=o,s.eagerState=c,Qt(c,a))return}catch{}finally{}Zr(n,i,r)}}var fu={readContext:on,useCallback:Mt,useContext:Mt,useEffect:Mt,useImperativeHandle:Mt,useLayoutEffect:Mt,useMemo:Mt,useReducer:Mt,useRef:Mt,useState:Mt,useDebugValue:Mt,useDeferredValue:Mt,useTransition:Mt,useMutableSource:Mt,useOpaqueIdentifier:Mt,unstable_isNewReconciler:!1},JI={readContext:on,useCallback:function(n,e){return Li().memoizedState=[n,e===void 0?null:e],n},useContext:on,useEffect:xg,useImperativeHandle:function(n,e,t){return t=t!=null?t.concat([n]):null,wf(4,2,$b.bind(null,e,n),t)},useLayoutEffect:function(n,e){return wf(4,2,n,e)},useMemo:function(n,e){var t=Li();return e=e===void 0?null:e,n=n(),t.memoizedState=[n,e],n},useReducer:function(n,e,t){var r=Li();return e=t!==void 0?t(e):e,r.memoizedState=r.baseState=e,n=r.queue={pending:null,dispatch:null,lastRenderedReducer:n,lastRenderedState:e},n=n.dispatch=um.bind(null,Fe,n),[r.memoizedState,n]},useRef:Mg,useState:Qo,useDebugValue:cm,useDeferredValue:function(n){var e=Qo(n),t=e[0],r=e[1];return xg(function(){var i=rn.transition;rn.transition=1;try{r(n)}finally{rn.transition=i}},[n]),t},useTransition:function(){var n=Qo(!1),e=n[0];return n=XI.bind(null,n[1]),Mg(n),[n,e]},useMutableSource:function(n,e,t){var r=Li();return r.memoizedState={refs:{getSnapshot:e,setSnapshot:null},source:n,subscribe:t},Pb(r,n,e,t)},useOpaqueIdentifier:function(){if(Un){var n=!1,e=HI(function(){throw n||(n=!0,t("r:"+(th++).toString(36))),Error(L(355))}),t=Qo(e)[1];return!(Fe.mode&2)&&(Fe.flags|=516,uu(5,function(){t("r:"+(th++).toString(36))},void 0,null)),e}return e="r:"+(th++).toString(36),Qo(e),e},unstable_isNewReconciler:!1},QI={readContext:on,useCallback:Fb,useContext:on,useEffect:hu,useImperativeHandle:Lb,useLayoutEffect:Ub,useMemo:Bb,useReducer:Xo,useRef:du,useState:function(){return Xo(Nn)},useDebugValue:cm,useDeferredValue:function(n){var e=Xo(Nn),t=e[0],r=e[1];return hu(function(){var i=rn.transition;rn.transition=1;try{r(n)}finally{rn.transition=i}},[n]),t},useTransition:function(){var n=Xo(Nn)[0];return[du().current,n]},useMutableSource:Ob,useOpaqueIdentifier:function(){return Xo(Nn)[0]},unstable_isNewReconciler:!1},ZI={readContext:on,useCallback:Fb,useContext:on,useEffect:hu,useImperativeHandle:Lb,useLayoutEffect:Ub,useMemo:Bb,useReducer:Jo,useRef:du,useState:function(){return Jo(Nn)},useDebugValue:cm,useDeferredValue:function(n){var e=Jo(Nn),t=e[0],r=e[1];return hu(function(){var i=rn.transition;rn.transition=1;try{r(n)}finally{rn.transition=i}},[n]),t},useTransition:function(){var n=Jo(Nn)[0];return[du().current,n]},useMutableSource:Ob,useOpaqueIdentifier:function(){return Jo(Nn)[0]},unstable_isNewReconciler:!1},eT=ss.ReactCurrentOwner,gn=!1;function Dt(n,e,t,r){e.child=n===null?Db(e,null,t,r):au(e,n.child,t,r)}function Ag(n,e,t,r,i){t=t.render;var s=e.ref;return $s(e,i),r=am(n,e,t,r,s,i),n!==null&&!gn?(e.updateQueue=n.updateQueue,e.flags&=-517,n.lanes&=~i,lr(n,e,i)):(e.flags|=1,Dt(n,e,r,i),e.child)}function Dg(n,e,t,r,i,s){if(n===null){var o=t.type;return typeof o=="function"&&!_m(o)&&o.defaultProps===void 0&&t.compare===null&&t.defaultProps===void 0?(e.tag=15,e.type=o,Vb(n,e,o,r,i,s)):(n=Fc(t.type,null,r,e,e.mode,s),n.ref=e.ref,n.return=e,e.child=n)}return o=n.child,!(i&s)&&(i=o.memoizedProps,t=t.compare,t=t!==null?t:qa,t(i,r)&&n.ref===e.ref)?lr(n,e,s):(e.flags|=1,n=di(o,r),n.ref=e.ref,n.return=e,e.child=n)}function Vb(n,e,t,r,i,s){if(n!==null&&qa(n.memoizedProps,r)&&n.ref===e.ref)if(gn=!1,(s&i)!==0)n.flags&16384&&(gn=!0);else return e.lanes=n.lanes,lr(n,e,s);return bf(n,e,t,r,s)}function sh(n,e,t){var r=e.pendingProps,i=r.children,s=n!==null?n.memoizedState:null;if(r.mode==="hidden"||r.mode==="unstable-defer-without-hiding")if(!(e.mode&4))e.memoizedState={baseLanes:0},zl(e,t);else if(t&1073741824)e.memoizedState={baseLanes:0},zl(e,s!==null?s.baseLanes:t);else return n=s!==null?s.baseLanes|t:t,e.lanes=e.childLanes=1073741824,e.memoizedState={baseLanes:n},zl(e,n),null;else s!==null?(r=s.baseLanes|t,e.memoizedState=null):r=t,zl(e,r);return Dt(n,e,i,t),e.child}function Kb(n,e){var t=e.ref;(n===null&&t!==null||n!==null&&n.ref!==t)&&(e.flags|=128)}function bf(n,e,t,r,i){var s=Pt(t)?Qi:_t.current;return s=Zs(e,s),$s(e,i),t=am(n,e,t,r,s,i),n!==null&&!gn?(e.updateQueue=n.updateQueue,e.flags&=-517,n.lanes&=~i,lr(n,e,i)):(e.flags|=1,Dt(n,e,t,i),e.child)}function Ng(n,e,t,r,i){if(Pt(t)){var s=!0;Pc(e)}else s=!1;if($s(e,i),e.stateNode===null)n!==null&&(n.alternate=null,e.alternate=null,e.flags|=2),xb(e,t,r),gf(e,t,r,i),r=!0;else if(n===null){var o=e.stateNode,a=e.memoizedProps;o.props=a;var c=o.context,u=t.contextType;typeof u=="object"&&u!==null?u=on(u):(u=Pt(t)?Qi:_t.current,u=Zs(e,u));var l=t.getDerivedStateFromProps,d=typeof l=="function"||typeof o.getSnapshotBeforeUpdate=="function";d||typeof o.UNSAFE_componentWillReceiveProps!="function"&&typeof o.componentWillReceiveProps!="function"||(a!==r||c!==u)&&kg(e,o,r,u),Ar=!1;var p=e.memoizedState;o.state=p,Xa(e,r,o,i),c=e.memoizedState,a!==r||p!==c||Nt.current||Ar?(typeof l=="function"&&(ou(e,t,l,r),c=e.memoizedState),(a=Ar||Eg(e,t,a,r,p,c,u))?(d||typeof o.UNSAFE_componentWillMount!="function"&&typeof o.componentWillMount!="function"||(typeof o.componentWillMount=="function"&&o.componentWillMount(),typeof o.UNSAFE_componentWillMount=="function"&&o.UNSAFE_componentWillMount()),typeof o.componentDidMount=="function"&&(e.flags|=4)):(typeof o.componentDidMount=="function"&&(e.flags|=4),e.memoizedProps=r,e.memoizedState=c),o.props=r,o.state=c,o.context=u,r=a):(typeof o.componentDidMount=="function"&&(e.flags|=4),r=!1)}else{o=e.stateNode,Cb(n,e),a=e.memoizedProps,u=e.type===e.elementType?a:pn(e.type,a),o.props=u,d=e.pendingProps,p=o.context,c=t.contextType,typeof c=="object"&&c!==null?c=on(c):(c=Pt(t)?Qi:_t.current,c=Zs(e,c));var m=t.getDerivedStateFromProps;(l=typeof m=="function"||typeof o.getSnapshotBeforeUpdate=="function")||typeof o.UNSAFE_componentWillReceiveProps!="function"&&typeof o.componentWillReceiveProps!="function"||(a!==d||p!==c)&&kg(e,o,r,c),Ar=!1,p=e.memoizedState,o.state=p,Xa(e,r,o,i);var w=e.memoizedState;a!==d||p!==w||Nt.current||Ar?(typeof m=="function"&&(ou(e,t,m,r),w=e.memoizedState),(u=Ar||Eg(e,t,u,r,p,w,c))?(l||typeof o.UNSAFE_componentWillUpdate!="function"&&typeof o.componentWillUpdate!="function"||(typeof o.componentWillUpdate=="function"&&o.componentWillUpdate(r,w,c),typeof o.UNSAFE_componentWillUpdate=="function"&&o.UNSAFE_componentWillUpdate(r,w,c)),typeof o.componentDidUpdate=="function"&&(e.flags|=4),typeof o.getSnapshotBeforeUpdate=="function"&&(e.flags|=256)):(typeof o.componentDidUpdate!="function"||a===n.memoizedProps&&p===n.memoizedState||(e.flags|=4),typeof o.getSnapshotBeforeUpdate!="function"||a===n.memoizedProps&&p===n.memoizedState||(e.flags|=256),e.memoizedProps=r,e.memoizedState=w),o.props=r,o.state=w,o.context=c,r=u):(typeof o.componentDidUpdate!="function"||a===n.memoizedProps&&p===n.memoizedState||(e.flags|=4),typeof o.getSnapshotBeforeUpdate!="function"||a===n.memoizedProps&&p===n.memoizedState||(e.flags|=256),r=!1)}return Sf(n,e,t,r,s,i)}function Sf(n,e,t,r,i,s){Kb(n,e);var o=(e.flags&64)!==0;if(!r&&!o)return i&&yg(e,t,!1),lr(n,e,s);r=e.stateNode,eT.current=e;var a=o&&typeof t.getDerivedStateFromError!="function"?null:r.render();return e.flags|=1,n!==null&&o?(e.child=au(e,n.child,null,s),e.child=au(e,null,a,s)):Dt(n,e,a,s),e.memoizedState=r.state,i&&yg(e,t,!0),e.child}function Pg(n){var e=n.stateNode;e.pendingContext?gg(n,e.pendingContext,e.pendingContext!==e.context):e.context&&gg(n,e.context,!1),yf(n,e.containerInfo)}var Hl={dehydrated:null,retryLane:0};function Og(n,e,t){var r=e.pendingProps,i=Ne.current,s=!1,o;return(o=(e.flags&64)!==0)||(o=n!==null&&n.memoizedState===null?!1:(i&2)!==0),o?(s=!0,e.flags&=-65):n!==null&&n.memoizedState===null||r.fallback===void 0||r.unstable_avoidThisFallback===!0||(i|=1),Pe(Ne,i&1),n===null?(r.fallback!==void 0&&vf(e),n=r.children,i=r.fallback,s?(n=Ug(e,n,i,t),e.child.memoizedState={baseLanes:t},e.memoizedState=Hl,n):typeof r.unstable_expectedLoadTime=="number"?(n=Ug(e,n,i,t),e.child.memoizedState={baseLanes:t},e.memoizedState=Hl,e.lanes=33554432,n):(t=gm({mode:"visible",children:n},e.mode,t,null),t.return=e,e.child=t)):n.memoizedState!==null?s?(r=Lg(n,e,r.children,r.fallback,t),s=e.child,i=n.child.memoizedState,s.memoizedState=i===null?{baseLanes:t}:{baseLanes:i.baseLanes|t},s.childLanes=n.childLanes&~t,e.memoizedState=Hl,r):(t=$g(n,e,r.children,t),e.memoizedState=null,t):s?(r=Lg(n,e,r.children,r.fallback,t),s=e.child,i=n.child.memoizedState,s.memoizedState=i===null?{baseLanes:t}:{baseLanes:i.baseLanes|t},s.childLanes=n.childLanes&~t,e.memoizedState=Hl,r):(t=$g(n,e,r.children,t),e.memoizedState=null,t)}function Ug(n,e,t,r){var i=n.mode,s=n.child;return e={mode:"hidden",children:e},!(i&2)&&s!==null?(s.childLanes=0,s.pendingProps=e):s=gm(e,i,0,null),t=Vs(t,i,r,null),s.return=n,t.return=n,s.sibling=t,n.child=s,t}function $g(n,e,t,r){var i=n.child;return n=i.sibling,t=di(i,{mode:"visible",children:t}),!(e.mode&2)&&(t.lanes=r),t.return=e,t.sibling=null,n!==null&&(n.nextEffect=null,n.flags=8,e.firstEffect=e.lastEffect=n),e.child=t}function Lg(n,e,t,r,i){var s=e.mode,o=n.child;n=o.sibling;var a={mode:"hidden",children:t};return!(s&2)&&e.child!==o?(t=e.child,t.childLanes=0,t.pendingProps=a,o=t.lastEffect,o!==null?(e.firstEffect=t.firstEffect,e.lastEffect=o,o.nextEffect=null):e.firstEffect=e.lastEffect=null):t=di(o,a),n!==null?r=di(n,r):(r=Vs(r,s,i,null),r.flags|=2),r.return=e,t.return=e,t.sibling=r,e.child=t,r}function Fg(n,e){n.lanes|=e;var t=n.alternate;t!==null&&(t.lanes|=e),Rb(n.return,e)}function oh(n,e,t,r,i,s){var o=n.memoizedState;o===null?n.memoizedState={isBackwards:e,rendering:null,renderingStartTime:0,last:r,tail:t,tailMode:i,lastEffect:s}:(o.isBackwards=e,o.rendering=null,o.renderingStartTime=0,o.last=r,o.tail=t,o.tailMode=i,o.lastEffect=s)}function Bg(n,e,t){var r=e.pendingProps,i=r.revealOrder,s=r.tail;if(Dt(n,e,r.children,t),r=Ne.current,r&2)r=r&1|2,e.flags|=64;else{if(n!==null&&n.flags&64)e:for(n=e.child;n!==null;){if(n.tag===13)n.memoizedState!==null&&Fg(n,t);else if(n.tag===19)Fg(n,t);else if(n.child!==null){n.child.return=n,n=n.child;continue}if(n===e)break e;for(;n.sibling===null;){if(n.return===null||n.return===e)break e;n=n.return}n.sibling.return=n.return,n=n.sibling}r&=1}if(Pe(Ne,r),!(e.mode&2))e.memoizedState=null;else switch(i){case"forwards":for(t=e.child,i=null;t!==null;)n=t.alternate,n!==null&&lu(n)===null&&(i=t),t=t.sibling;t=i,t===null?(i=e.child,e.child=null):(i=t.sibling,t.sibling=null),oh(e,!1,i,t,s,e.lastEffect);break;case"backwards":for(t=null,i=e.child,e.child=null;i!==null;){if(n=i.alternate,n!==null&&lu(n)===null){e.child=i;break}n=i.sibling,i.sibling=t,t=i,i=n}oh(e,!0,t,null,s,e.lastEffect);break;case"together":oh(e,!1,null,null,void 0,e.lastEffect);break;default:e.memoizedState=null}return e.child}function lr(n,e,t){if(n!==null&&(e.dependencies=n.dependencies),kl|=e.lanes,t&e.childLanes){if(n!==null&&e.child!==n.child)throw Error(L(153));if(e.child!==null){for(n=e.child,t=di(n,n.pendingProps),e.child=t,t.return=e;n.sibling!==null;)n=n.sibling,t=t.sibling=di(n,n.pendingProps),t.return=e;t.sibling=null}return e.child}return null}var jb,Ef,Hb,zb;jb=function(n,e){for(var t=e.child;t!==null;){if(t.tag===5||t.tag===6)n.appendChild(t.stateNode);else if(t.tag!==4&&t.child!==null){t.child.return=t,t=t.child;continue}if(t===e)break;for(;t.sibling===null;){if(t.return===null||t.return===e)return;t=t.return}t.sibling.return=t.return,t=t.sibling}};Ef=function(){};Hb=function(n,e,t,r){var i=n.memoizedProps;if(i!==r){n=e.stateNode,$i(On.current);var s=null;switch(t){case"input":i=Yh(n,i),r=Yh(n,r),s=[];break;case"option":i=Qh(n,i),r=Qh(n,r),s=[];break;case"select":i=Me({},i,{value:void 0}),r=Me({},r,{value:void 0}),s=[];break;case"textarea":i=Zh(n,i),r=Zh(n,r),s=[];break;default:typeof i.onClick!="function"&&typeof r.onClick=="function"&&(n.onclick=eu)}nf(t,r);var o;t=null;for(u in i)if(!r.hasOwnProperty(u)&&i.hasOwnProperty(u)&&i[u]!=null)if(u==="style"){var a=i[u];for(o in a)a.hasOwnProperty(o)&&(t||(t={}),t[o]="")}else u!=="dangerouslySetInnerHTML"&&u!=="children"&&u!=="suppressContentEditableWarning"&&u!=="suppressHydrationWarning"&&u!=="autoFocus"&&(Ba.hasOwnProperty(u)?s||(s=[]):(s=s||[]).push(u,null));for(u in r){var c=r[u];if(a=i!=null?i[u]:void 0,r.hasOwnProperty(u)&&c!==a&&(c!=null||a!=null))if(u==="style")if(a){for(o in a)!a.hasOwnProperty(o)||c&&c.hasOwnProperty(o)||(t||(t={}),t[o]="");for(o in c)c.hasOwnProperty(o)&&a[o]!==c[o]&&(t||(t={}),t[o]=c[o])}else t||(s||(s=[]),s.push(u,t)),t=c;else u==="dangerouslySetInnerHTML"?(c=c?c.__html:void 0,a=a?a.__html:void 0,c!=null&&a!==c&&(s=s||[]).push(u,c)):u==="children"?typeof c!="string"&&typeof c!="number"||(s=s||[]).push(u,""+c):u!=="suppressContentEditableWarning"&&u!=="suppressHydrationWarning"&&(Ba.hasOwnProperty(u)?(c!=null&&u==="onScroll"&&ke("scroll",n),s||a===c||(s=[])):typeof c=="object"&&c!==null&&c.$$typeof===$p?c.toString():(s=s||[]).push(u,c))}t&&(s=s||[]).push("style",t);var u=s;(e.updateQueue=u)&&(e.flags|=4)}};zb=function(n,e,t,r){t!==r&&(e.flags|=4)};function Zo(n,e){if(!Un)switch(n.tailMode){case"hidden":e=n.tail;for(var t=null;e!==null;)e.alternate!==null&&(t=e),e=e.sibling;t===null?n.tail=null:t.sibling=null;break;case"collapsed":t=n.tail;for(var r=null;t!==null;)t.alternate!==null&&(r=t),t=t.sibling;r===null?e||n.tail===null?n.tail=null:n.tail.sibling=null:r.sibling=null}}function tT(n,e,t){var r=e.pendingProps;switch(e.tag){case 2:case 16:case 15:case 0:case 11:case 7:case 8:case 12:case 9:case 14:return null;case 1:return Pt(e.type)&&nu(),null;case 3:return to(),Re(Nt),Re(_t),sm(),r=e.stateNode,r.pendingContext&&(r.context=r.pendingContext,r.pendingContext=null),(n===null||n.child===null)&&(jl(e)?e.flags|=4:r.hydrate||(e.flags|=256)),Ef(e),null;case 5:im(e);var i=$i(Qa.current);if(t=e.type,n!==null&&e.stateNode!=null)Hb(n,e,t,r,i),n.ref!==e.ref&&(e.flags|=128);else{if(!r){if(e.stateNode===null)throw Error(L(166));return null}if(n=$i(On.current),jl(e)){r=e.stateNode,t=e.type;var s=e.memoizedProps;switch(r[Kr]=e,r[tu]=s,t){case"dialog":ke("cancel",r),ke("close",r);break;case"iframe":case"object":case"embed":ke("load",r);break;case"video":case"audio":for(n=0;n<ha.length;n++)ke(ha[n],r);break;case"source":ke("error",r);break;case"img":case"image":case"link":ke("error",r),ke("load",r);break;case"details":ke("toggle",r);break;case"input":B_(r,s),ke("invalid",r);break;case"select":r._wrapperState={wasMultiple:!!s.multiple},ke("invalid",r);break;case"textarea":K_(r,s),ke("invalid",r)}nf(t,s),n=null;for(var o in s)s.hasOwnProperty(o)&&(i=s[o],o==="children"?typeof i=="string"?r.textContent!==i&&(n=["children",i]):typeof i=="number"&&r.textContent!==""+i&&(n=["children",""+i]):Ba.hasOwnProperty(o)&&i!=null&&o==="onScroll"&&ke("scroll",r));switch(t){case"input":$l(r),V_(r,s,!0);break;case"textarea":$l(r),j_(r);break;case"select":case"option":break;default:typeof s.onClick=="function"&&(r.onclick=eu)}r=n,e.updateQueue=r,r!==null&&(e.flags|=4)}else{switch(o=i.nodeType===9?i:i.ownerDocument,n===ef.html&&(n=Lw(t)),n===ef.html?t==="script"?(n=o.createElement("div"),n.innerHTML="<script><\/script>",n=n.removeChild(n.firstChild)):typeof r.is=="string"?n=o.createElement(t,{is:r.is}):(n=o.createElement(t),t==="select"&&(o=n,r.multiple?o.multiple=!0:r.size&&(o.size=r.size))):n=o.createElementNS(n,t),n[Kr]=e,n[tu]=r,jb(n,e,!1,!1),e.stateNode=n,o=rf(t,r),t){case"dialog":ke("cancel",n),ke("close",n),i=r;break;case"iframe":case"object":case"embed":ke("load",n),i=r;break;case"video":case"audio":for(i=0;i<ha.length;i++)ke(ha[i],n);i=r;break;case"source":ke("error",n),i=r;break;case"img":case"image":case"link":ke("error",n),ke("load",n),i=r;break;case"details":ke("toggle",n),i=r;break;case"input":B_(n,r),i=Yh(n,r),ke("invalid",n);break;case"option":i=Qh(n,r);break;case"select":n._wrapperState={wasMultiple:!!r.multiple},i=Me({},r,{value:void 0}),ke("invalid",n);break;case"textarea":K_(n,r),i=Zh(n,r),ke("invalid",n);break;default:i=r}nf(t,i);var a=i;for(s in a)if(a.hasOwnProperty(s)){var c=a[s];s==="style"?Vw(n,c):s==="dangerouslySetInnerHTML"?(c=c?c.__html:void 0,c!=null&&Fw(n,c)):s==="children"?typeof c=="string"?(t!=="textarea"||c!=="")&&Va(n,c):typeof c=="number"&&Va(n,""+c):s!=="suppressContentEditableWarning"&&s!=="suppressHydrationWarning"&&s!=="autoFocus"&&(Ba.hasOwnProperty(s)?c!=null&&s==="onScroll"&&ke("scroll",n):c!=null&&Ap(n,s,c,o))}switch(t){case"input":$l(n),V_(n,r,!1);break;case"textarea":$l(n),j_(n);break;case"option":r.value!=null&&n.setAttribute("value",""+ai(r.value));break;case"select":n.multiple=!!r.multiple,s=r.value,s!=null?Ns(n,!!r.multiple,s,!1):r.defaultValue!=null&&Ns(n,!!r.multiple,r.defaultValue,!0);break;default:typeof i.onClick=="function"&&(n.onclick=eu)}yb(t,r)&&(e.flags|=4)}e.ref!==null&&(e.flags|=128)}return null;case 6:if(n&&e.stateNode!=null)zb(n,e,n.memoizedProps,r);else{if(typeof r!="string"&&e.stateNode===null)throw Error(L(166));t=$i(Qa.current),$i(On.current),jl(e)?(r=e.stateNode,t=e.memoizedProps,r[Kr]=e,r.nodeValue!==t&&(e.flags|=4)):(r=(t.nodeType===9?t:t.ownerDocument).createTextNode(r),r[Kr]=e,e.stateNode=r)}return null;case 13:return Re(Ne),r=e.memoizedState,e.flags&64?(e.lanes=t,e):(r=r!==null,t=!1,n===null?e.memoizedProps.fallback!==void 0&&jl(e):t=n.memoizedState!==null,r&&!t&&e.mode&2&&(n===null&&e.memoizedProps.unstable_avoidThisFallback!==!0||Ne.current&1?ot===0&&(ot=3):((ot===0||ot===3)&&(ot=4),kt===null||!(kl&134217727)&&!(bo&134217727)||Fs(kt,mt))),(r||t)&&(e.flags|=4),null);case 4:return to(),Ef(e),n===null&&mb(e.stateNode.containerInfo),null;case 10:return nm(e),null;case 17:return Pt(e.type)&&nu(),null;case 19:if(Re(Ne),r=e.memoizedState,r===null)return null;if(s=(e.flags&64)!==0,o=r.rendering,o===null)if(s)Zo(r,!1);else{if(ot!==0||n!==null&&n.flags&64)for(n=e.child;n!==null;){if(o=lu(n),o!==null){for(e.flags|=64,Zo(r,!1),s=o.updateQueue,s!==null&&(e.updateQueue=s,e.flags|=4),r.lastEffect===null&&(e.firstEffect=null),e.lastEffect=r.lastEffect,r=t,t=e.child;t!==null;)s=t,n=r,s.flags&=2,s.nextEffect=null,s.firstEffect=null,s.lastEffect=null,o=s.alternate,o===null?(s.childLanes=0,s.lanes=n,s.child=null,s.memoizedProps=null,s.memoizedState=null,s.updateQueue=null,s.dependencies=null,s.stateNode=null):(s.childLanes=o.childLanes,s.lanes=o.lanes,s.child=o.child,s.memoizedProps=o.memoizedProps,s.memoizedState=o.memoizedState,s.updateQueue=o.updateQueue,s.type=o.type,n=o.dependencies,s.dependencies=n===null?null:{lanes:n.lanes,firstContext:n.firstContext}),t=t.sibling;return Pe(Ne,Ne.current&1|2),e.child}n=n.sibling}r.tail!==null&&ft()>Mf&&(e.flags|=64,s=!0,Zo(r,!1),e.lanes=33554432)}else{if(!s)if(n=lu(o),n!==null){if(e.flags|=64,s=!0,t=n.updateQueue,t!==null&&(e.updateQueue=t,e.flags|=4),Zo(r,!0),r.tail===null&&r.tailMode==="hidden"&&!o.alternate&&!Un)return e=e.lastEffect=r.lastEffect,e!==null&&(e.nextEffect=null),null}else 2*ft()-r.renderingStartTime>Mf&&t!==1073741824&&(e.flags|=64,s=!0,Zo(r,!1),e.lanes=33554432);r.isBackwards?(o.sibling=e.child,e.child=o):(t=r.last,t!==null?t.sibling=o:e.child=o,r.last=o)}return r.tail!==null?(t=r.tail,r.rendering=t,r.tail=t.sibling,r.lastEffect=e.lastEffect,r.renderingStartTime=ft(),t.sibling=null,e=Ne.current,Pe(Ne,s?e&1|2:e&1),t):null;case 23:case 24:return mm(),n!==null&&n.memoizedState!==null!=(e.memoizedState!==null)&&r.mode!=="unstable-defer-without-hiding"&&(e.flags|=4),null}throw Error(L(156,e.tag))}function nT(n){switch(n.tag){case 1:Pt(n.type)&&nu();var e=n.flags;return e&4096?(n.flags=e&-4097|64,n):null;case 3:if(to(),Re(Nt),Re(_t),sm(),e=n.flags,e&64)throw Error(L(285));return n.flags=e&-4097|64,n;case 5:return im(n),null;case 13:return Re(Ne),e=n.flags,e&4096?(n.flags=e&-4097|64,n):null;case 19:return Re(Ne),null;case 4:return to(),null;case 10:return nm(n),null;case 23:case 24:return mm(),null;default:return null}}function dm(n,e){try{var t="",r=e;do t+=Uk(r),r=r.return;while(r);var i=t}catch(s){i=`
Error generating stack: `+s.message+`
`+s.stack}return{value:n,source:e,stack:i}}function kf(n,e){try{console.error(e.value)}catch(t){setTimeout(function(){throw t})}}var rT=typeof WeakMap=="function"?WeakMap:Map;function Gb(n,e,t){t=Xr(-1,t),t.tag=3,t.payload={element:null};var r=e.value;return t.callback=function(){mu||(mu=!0,xf=r),kf(n,e)},t}function qb(n,e,t){t=Xr(-1,t),t.tag=3;var r=n.type.getDerivedStateFromError;if(typeof r=="function"){var i=e.value;t.payload=function(){return kf(n,e),r(i)}}var s=n.stateNode;return s!==null&&typeof s.componentDidCatch=="function"&&(t.callback=function(){typeof r!="function"&&(Pn===null?Pn=new Set([this]):Pn.add(this),kf(n,e));var o=e.stack;this.componentDidCatch(e.value,{componentStack:o!==null?o:""})}),t}var iT=typeof WeakSet=="function"?WeakSet:Set;function Vg(n){var e=n.ref;if(e!==null)if(typeof e=="function")try{e(null)}catch(t){ei(n,t)}else e.current=null}function sT(n,e){switch(e.tag){case 0:case 11:case 15:case 22:return;case 1:if(e.flags&256&&n!==null){var t=n.memoizedProps,r=n.memoizedState;n=e.stateNode,e=n.getSnapshotBeforeUpdate(e.elementType===e.type?t:pn(e.type,t),r),n.__reactInternalSnapshotBeforeUpdate=e}return;case 3:e.flags&256&&Qp(e.stateNode.containerInfo);return;case 5:case 6:case 4:case 17:return}throw Error(L(163))}function oT(n,e,t){switch(t.tag){case 0:case 11:case 15:case 22:if(e=t.updateQueue,e=e!==null?e.lastEffect:null,e!==null){n=e=e.next;do{if((n.tag&3)===3){var r=n.create;n.destroy=r()}n=n.next}while(n!==e)}if(e=t.updateQueue,e=e!==null?e.lastEffect:null,e!==null){n=e=e.next;do{var i=n;r=i.next,i=i.tag,i&4&&i&1&&(nS(t,n),pT(t,n)),n=r}while(n!==e)}return;case 1:n=t.stateNode,t.flags&4&&(e===null?n.componentDidMount():(r=t.elementType===t.type?e.memoizedProps:pn(t.type,e.memoizedProps),n.componentDidUpdate(r,e.memoizedState,n.__reactInternalSnapshotBeforeUpdate))),e=t.updateQueue,e!==null&&Sg(t,e,n);return;case 3:if(e=t.updateQueue,e!==null){if(n=null,t.child!==null)switch(t.child.tag){case 5:n=t.child.stateNode;break;case 1:n=t.child.stateNode}Sg(t,e,n)}return;case 5:n=t.stateNode,e===null&&t.flags&4&&yb(t.type,t.memoizedProps)&&n.focus();return;case 6:return;case 4:return;case 12:return;case 13:t.memoizedState===null&&(t=t.alternate,t!==null&&(t=t.memoizedState,t!==null&&(t=t.dehydrated,t!==null&&Jw(t))));return;case 19:case 17:case 20:case 21:case 23:case 24:return}throw Error(L(163))}function Kg(n,e){for(var t=n;;){if(t.tag===5){var r=t.stateNode;if(e)r=r.style,typeof r.setProperty=="function"?r.setProperty("display","none","important"):r.display="none";else{r=t.stateNode;var i=t.memoizedProps.style;i=i!=null&&i.hasOwnProperty("display")?i.display:null,r.style.display=Bw("display",i)}}else if(t.tag===6)t.stateNode.nodeValue=e?"":t.memoizedProps;else if((t.tag!==23&&t.tag!==24||t.memoizedState===null||t===n)&&t.child!==null){t.child.return=t,t=t.child;continue}if(t===n)break;for(;t.sibling===null;){if(t.return===null||t.return===n)return;t=t.return}t.sibling.return=t.return,t=t.sibling}}function jg(n,e){if(Ki&&typeof Ki.onCommitFiberUnmount=="function")try{Ki.onCommitFiberUnmount(Zp,e)}catch{}switch(e.tag){case 0:case 11:case 14:case 15:case 22:if(n=e.updateQueue,n!==null&&(n=n.lastEffect,n!==null)){var t=n=n.next;do{var r=t,i=r.destroy;if(r=r.tag,i!==void 0)if(r&4)nS(e,t);else{r=e;try{i()}catch(s){ei(r,s)}}t=t.next}while(t!==n)}break;case 1:if(Vg(e),n=e.stateNode,typeof n.componentWillUnmount=="function")try{n.props=e.memoizedProps,n.state=e.memoizedState,n.componentWillUnmount()}catch(s){ei(e,s)}break;case 5:Vg(e);break;case 4:Wb(n,e)}}function Hg(n){n.alternate=null,n.child=null,n.dependencies=null,n.firstEffect=null,n.lastEffect=null,n.memoizedProps=null,n.memoizedState=null,n.pendingProps=null,n.return=null,n.updateQueue=null}function zg(n){return n.tag===5||n.tag===3||n.tag===4}function Gg(n){e:{for(var e=n.return;e!==null;){if(zg(e))break e;e=e.return}throw Error(L(160))}var t=e;switch(e=t.stateNode,t.tag){case 5:var r=!1;break;case 3:e=e.containerInfo,r=!0;break;case 4:e=e.containerInfo,r=!0;break;default:throw Error(L(161))}t.flags&16&&(Va(e,""),t.flags&=-17);e:t:for(t=n;;){for(;t.sibling===null;){if(t.return===null||zg(t.return)){t=null;break e}t=t.return}for(t.sibling.return=t.return,t=t.sibling;t.tag!==5&&t.tag!==6&&t.tag!==18;){if(t.flags&2||t.child===null||t.tag===4)continue t;t.child.return=t,t=t.child}if(!(t.flags&2)){t=t.stateNode;break e}}r?If(n,t,e):Tf(n,t,e)}function If(n,e,t){var r=n.tag,i=r===5||r===6;if(i)n=i?n.stateNode:n.stateNode.instance,e?t.nodeType===8?t.parentNode.insertBefore(n,e):t.insertBefore(n,e):(t.nodeType===8?(e=t.parentNode,e.insertBefore(n,t)):(e=t,e.appendChild(n)),t=t._reactRootContainer,t!=null||e.onclick!==null||(e.onclick=eu));else if(r!==4&&(n=n.child,n!==null))for(If(n,e,t),n=n.sibling;n!==null;)If(n,e,t),n=n.sibling}function Tf(n,e,t){var r=n.tag,i=r===5||r===6;if(i)n=i?n.stateNode:n.stateNode.instance,e?t.insertBefore(n,e):t.appendChild(n);else if(r!==4&&(n=n.child,n!==null))for(Tf(n,e,t),n=n.sibling;n!==null;)Tf(n,e,t),n=n.sibling}function Wb(n,e){for(var t=e,r=!1,i,s;;){if(!r){r=t.return;e:for(;;){if(r===null)throw Error(L(160));switch(i=r.stateNode,r.tag){case 5:s=!1;break e;case 3:i=i.containerInfo,s=!0;break e;case 4:i=i.containerInfo,s=!0;break e}r=r.return}r=!0}if(t.tag===5||t.tag===6){e:for(var o=n,a=t,c=a;;)if(jg(o,c),c.child!==null&&c.tag!==4)c.child.return=c,c=c.child;else{if(c===a)break e;for(;c.sibling===null;){if(c.return===null||c.return===a)break e;c=c.return}c.sibling.return=c.return,c=c.sibling}s?(o=i,a=t.stateNode,o.nodeType===8?o.parentNode.removeChild(a):o.removeChild(a)):i.removeChild(t.stateNode)}else if(t.tag===4){if(t.child!==null){i=t.stateNode.containerInfo,s=!0,t.child.return=t,t=t.child;continue}}else if(jg(n,t),t.child!==null){t.child.return=t,t=t.child;continue}if(t===e)break;for(;t.sibling===null;){if(t.return===null||t.return===e)return;t=t.return,t.tag===4&&(r=!1)}t.sibling.return=t.return,t=t.sibling}}function ah(n,e){switch(e.tag){case 0:case 11:case 14:case 15:case 22:var t=e.updateQueue;if(t=t!==null?t.lastEffect:null,t!==null){var r=t=t.next;do(r.tag&3)===3&&(n=r.destroy,r.destroy=void 0,n!==void 0&&n()),r=r.next;while(r!==t)}return;case 1:return;case 5:if(t=e.stateNode,t!=null){r=e.memoizedProps;var i=n!==null?n.memoizedProps:r;n=e.type;var s=e.updateQueue;if(e.updateQueue=null,s!==null){for(t[tu]=r,n==="input"&&r.type==="radio"&&r.name!=null&&Uw(t,r),rf(n,i),e=rf(n,r),i=0;i<s.length;i+=2){var o=s[i],a=s[i+1];o==="style"?Vw(t,a):o==="dangerouslySetInnerHTML"?Fw(t,a):o==="children"?Va(t,a):Ap(t,o,a,e)}switch(n){case"input":Xh(t,r);break;case"textarea":$w(t,r);break;case"select":n=t._wrapperState.wasMultiple,t._wrapperState.wasMultiple=!!r.multiple,s=r.value,s!=null?Ns(t,!!r.multiple,s,!1):n!==!!r.multiple&&(r.defaultValue!=null?Ns(t,!!r.multiple,r.defaultValue,!0):Ns(t,!!r.multiple,r.multiple?[]:"",!1))}}}return;case 6:if(e.stateNode===null)throw Error(L(162));e.stateNode.nodeValue=e.memoizedProps;return;case 3:t=e.stateNode,t.hydrate&&(t.hydrate=!1,Jw(t.containerInfo));return;case 12:return;case 13:e.memoizedState!==null&&(pm=ft(),Kg(e.child,!0)),qg(e);return;case 19:qg(e);return;case 17:return;case 23:case 24:Kg(e,e.memoizedState!==null);return}throw Error(L(163))}function qg(n){var e=n.updateQueue;if(e!==null){n.updateQueue=null;var t=n.stateNode;t===null&&(t=n.stateNode=new iT),e.forEach(function(r){var i=gT.bind(null,n,r);t.has(r)||(t.add(r),r.then(i,i))})}}function aT(n,e){return n!==null&&(n=n.memoizedState,n===null||n.dehydrated!==null)?(e=e.memoizedState,e!==null&&e.dehydrated===null):!1}var lT=Math.ceil,pu=ss.ReactCurrentDispatcher,hm=ss.ReactCurrentOwner,J=0,kt=null,Ye=null,mt=0,es=0,Rf=pi(0),ot=0,id=null,wo=0,kl=0,bo=0,fm=0,Cf=null,pm=0,Mf=1/0;function So(){Mf=ft()+500}var z=null,mu=!1,xf=null,Pn=null,ui=!1,Da=null,fa=90,Af=[],Df=[],cr=null,Na=0,Nf=null,Uc=-1,ir=0,$c=0,Pa=null,Lc=!1;function Ht(){return J&48?ft():Uc!==-1?Uc:Uc=ft()}function Qr(n){if(n=n.mode,!(n&2))return 1;if(!(n&4))return eo()===99?1:2;if(ir===0&&(ir=wo),YI.transition!==0){$c!==0&&($c=Cf!==null?Cf.pendingLanes:0),n=ir;var e=4186112&~$c;return e&=-e,e===0&&(n=4186112&~n,e=n&-n,e===0&&(e=8192)),e}return n=eo(),J&4&&n===98?n=Qc(12,ir):(n=Qk(n),n=Qc(n,ir)),n}function Zr(n,e,t){if(50<Na)throw Na=0,Nf=null,Error(L(185));if(n=sd(n,e),n===null)return null;Ju(n,e,t),n===kt&&(bo|=e,ot===4&&Fs(n,mt));var r=eo();e===1?J&8&&!(J&48)?Pf(n):(an(n,t),J===0&&(So(),jn())):(!(J&4)||r!==98&&r!==99||(cr===null?cr=new Set([n]):cr.add(n)),an(n,t)),Cf=n}function sd(n,e){n.lanes|=e;var t=n.alternate;for(t!==null&&(t.lanes|=e),t=n,n=n.return;n!==null;)n.childLanes|=e,t=n.alternate,t!==null&&(t.childLanes|=e),t=n,n=n.return;return t.tag===3?t.stateNode:null}function an(n,e){for(var t=n.callbackNode,r=n.suspendedLanes,i=n.pingedLanes,s=n.expirationTimes,o=n.pendingLanes;0<o;){var a=31-li(o),c=1<<a,u=s[a];if(u===-1){if(!(c&r)||c&i){u=e,_s(c);var l=Se;s[a]=10<=l?u+250:6<=l?u+5e3:-1}}else u<=e&&(n.expiredLanes|=c);o&=~c}if(r=za(n,n===kt?mt:0),e=Se,r===0)t!==null&&(t!==nh&&mf(t),n.callbackNode=null,n.callbackPriority=0);else{if(t!==null){if(n.callbackPriority===e)return;t!==nh&&mf(t)}e===15?(t=Pf.bind(null,n),er===null?(er=[t],Oc=em(nd,Tb)):er.push(t),t=nh):e===14?t=Ya(99,Pf.bind(null,n)):(t=Zk(e),t=Ya(t,Yb.bind(null,n))),n.callbackPriority=e,n.callbackNode=t}}function Yb(n){if(Uc=-1,$c=ir=0,J&48)throw Error(L(327));var e=n.callbackNode;if(mi()&&n.callbackNode!==e)return null;var t=za(n,n===kt?mt:0);if(t===0)return null;var r=t,i=J;J|=16;var s=Zb();(kt!==n||mt!==r)&&(So(),Bs(n,r));do try{dT();break}catch(a){Qb(n,a)}while(1);if(tm(),pu.current=s,J=i,Ye!==null?r=0:(kt=null,mt=0,r=ot),wo&bo)Bs(n,0);else if(r!==0){if(r===2&&(J|=64,n.hydrate&&(n.hydrate=!1,Qp(n.containerInfo)),t=ib(n),t!==0&&(r=pa(n,t))),r===1)throw e=id,Bs(n,0),Fs(n,t),an(n,ft()),e;switch(n.finishedWork=n.current.alternate,n.finishedLanes=t,r){case 0:case 1:throw Error(L(345));case 2:xi(n);break;case 3:if(Fs(n,t),(t&62914560)===t&&(r=pm+500-ft(),10<r)){if(za(n,0)!==0)break;if(i=n.suspendedLanes,(i&t)!==t){Ht(),n.pingedLanes|=n.suspendedLanes&i;break}n.timeoutHandle=pg(xi.bind(null,n),r);break}xi(n);break;case 4:if(Fs(n,t),(t&4186112)===t)break;for(r=n.eventTimes,i=-1;0<t;){var o=31-li(t);s=1<<o,o=r[o],o>i&&(i=o),t&=~s}if(t=i,t=ft()-t,t=(120>t?120:480>t?480:1080>t?1080:1920>t?1920:3e3>t?3e3:4320>t?4320:1960*lT(t/1960))-t,10<t){n.timeoutHandle=pg(xi.bind(null,n),t);break}xi(n);break;case 5:xi(n);break;default:throw Error(L(329))}}return an(n,ft()),n.callbackNode===e?Yb.bind(null,n):null}function Fs(n,e){for(e&=~fm,e&=~bo,n.suspendedLanes|=e,n.pingedLanes&=~e,n=n.expirationTimes;0<e;){var t=31-li(e),r=1<<t;n[t]=-1,e&=~r}}function Pf(n){if(J&48)throw Error(L(327));if(mi(),n===kt&&n.expiredLanes&mt){var e=mt,t=pa(n,e);wo&bo&&(e=za(n,e),t=pa(n,e))}else e=za(n,0),t=pa(n,e);if(n.tag!==0&&t===2&&(J|=64,n.hydrate&&(n.hydrate=!1,Qp(n.containerInfo)),e=ib(n),e!==0&&(t=pa(n,e))),t===1)throw t=id,Bs(n,0),Fs(n,e),an(n,ft()),t;return n.finishedWork=n.current.alternate,n.finishedLanes=e,xi(n),an(n,ft()),null}function cT(){if(cr!==null){var n=cr;cr=null,n.forEach(function(e){e.expiredLanes|=24&e.pendingLanes,an(e,ft())})}jn()}function Xb(n,e){var t=J;J|=1;try{return n(e)}finally{J=t,J===0&&(So(),jn())}}function Jb(n,e){var t=J;J&=-2,J|=8;try{return n(e)}finally{J=t,J===0&&(So(),jn())}}function zl(n,e){Pe(Rf,es),es|=e,wo|=e}function mm(){es=Rf.current,Re(Rf)}function Bs(n,e){n.finishedWork=null,n.finishedLanes=0;var t=n.timeoutHandle;if(t!==-1&&(n.timeoutHandle=-1,jI(t)),Ye!==null)for(t=Ye.return;t!==null;){var r=t;switch(r.tag){case 1:r=r.type.childContextTypes,r!=null&&nu();break;case 3:to(),Re(Nt),Re(_t),sm();break;case 5:im(r);break;case 4:to();break;case 13:Re(Ne);break;case 19:Re(Ne);break;case 10:nm(r);break;case 23:case 24:mm()}t=t.return}kt=n,Ye=di(n.current,null),mt=es=wo=e,ot=0,id=null,fm=bo=kl=0}function Qb(n,e){do{var t=Ye;try{if(tm(),xa.current=fu,cu){for(var r=Fe.memoizedState;r!==null;){var i=r.queue;i!==null&&(i.pending=null),r=r.next}cu=!1}if(Za=0,it=dt=Fe=null,Aa=!1,hm.current=null,t===null||t.return===null){ot=1,id=e,Ye=null;break}e:{var s=n,o=t.return,a=t,c=e;if(e=mt,a.flags|=2048,a.firstEffect=a.lastEffect=null,c!==null&&typeof c=="object"&&typeof c.then=="function"){var u=c;if(!(a.mode&2)){var l=a.alternate;l?(a.updateQueue=l.updateQueue,a.memoizedState=l.memoizedState,a.lanes=l.lanes):(a.updateQueue=null,a.memoizedState=null)}var d=(Ne.current&1)!==0,p=o;do{var m;if(m=p.tag===13){var w=p.memoizedState;if(w!==null)m=w.dehydrated!==null;else{var S=p.memoizedProps;m=S.fallback===void 0?!1:S.unstable_avoidThisFallback!==!0?!0:!d}}if(m){var v=p.updateQueue;if(v===null){var _=new Set;_.add(u),p.updateQueue=_}else v.add(u);if(!(p.mode&2)){if(p.flags|=64,a.flags|=16384,a.flags&=-2981,a.tag===1)if(a.alternate===null)a.tag=17;else{var b=Xr(-1,1);b.tag=2,Jr(a,b)}a.lanes|=1;break e}c=void 0,a=e;var k=s.pingCache;if(k===null?(k=s.pingCache=new rT,c=new Set,k.set(u,c)):(c=k.get(u),c===void 0&&(c=new Set,k.set(u,c))),!c.has(a)){c.add(a);var g=_T.bind(null,s,u,a);u.then(g,g)}p.flags|=4096,p.lanes=e;break e}p=p.return}while(p!==null);c=Error((Ds(a.type)||"A React component")+` suspended while rendering, but no fallback UI was specified.

Add a <Suspense fallback=...> component higher in the tree to provide a loading indicator or placeholder to display.`)}ot!==5&&(ot=2),c=dm(c,a),p=o;do{switch(p.tag){case 3:s=c,p.flags|=4096,e&=-e,p.lanes|=e;var A=Gb(p,s,e);bg(p,A);break e;case 1:s=c;var M=p.type,C=p.stateNode;if(!(p.flags&64)&&(typeof M.getDerivedStateFromError=="function"||C!==null&&typeof C.componentDidCatch=="function"&&(Pn===null||!Pn.has(C)))){p.flags|=4096,e&=-e,p.lanes|=e;var P=qb(p,s,e);bg(p,P);break e}}p=p.return}while(p!==null)}tS(t)}catch(I){e=I,Ye===t&&t!==null&&(Ye=t=t.return);continue}break}while(1)}function Zb(){var n=pu.current;return pu.current=fu,n===null?fu:n}function pa(n,e){var t=J;J|=16;var r=Zb();kt===n&&mt===e||Bs(n,e);do try{uT();break}catch(i){Qb(n,i)}while(1);if(tm(),J=t,pu.current=r,Ye!==null)throw Error(L(261));return kt=null,mt=0,ot}function uT(){for(;Ye!==null;)eS(Ye)}function dT(){for(;Ye!==null&&!GI();)eS(Ye)}function eS(n){var e=rS(n.alternate,n,es);n.memoizedProps=n.pendingProps,e===null?tS(n):Ye=e,hm.current=null}function tS(n){var e=n;do{var t=e.alternate;if(n=e.return,e.flags&2048){if(t=nT(e),t!==null){t.flags&=2047,Ye=t;return}n!==null&&(n.firstEffect=n.lastEffect=null,n.flags|=2048)}else{if(t=tT(t,e,es),t!==null){Ye=t;return}if(t=e,t.tag!==24&&t.tag!==23||t.memoizedState===null||es&1073741824||!(t.mode&4)){for(var r=0,i=t.child;i!==null;)r|=i.lanes|i.childLanes,i=i.sibling;t.childLanes=r}n!==null&&!(n.flags&2048)&&(n.firstEffect===null&&(n.firstEffect=e.firstEffect),e.lastEffect!==null&&(n.lastEffect!==null&&(n.lastEffect.nextEffect=e.firstEffect),n.lastEffect=e.lastEffect),1<e.flags&&(n.lastEffect!==null?n.lastEffect.nextEffect=e:n.firstEffect=e,n.lastEffect=e))}if(e=e.sibling,e!==null){Ye=e;return}Ye=e=n}while(e!==null);ot===0&&(ot=5)}function xi(n){var e=eo();return Zi(99,hT.bind(null,n,e)),null}function hT(n,e){do mi();while(Da!==null);if(J&48)throw Error(L(327));var t=n.finishedWork;if(t===null)return null;if(n.finishedWork=null,n.finishedLanes=0,t===n.current)throw Error(L(177));n.callbackNode=null;var r=t.lanes|t.childLanes,i=r,s=n.pendingLanes&~i;n.pendingLanes=i,n.suspendedLanes=0,n.pingedLanes=0,n.expiredLanes&=i,n.mutableReadLanes&=i,n.entangledLanes&=i,i=n.entanglements;for(var o=n.eventTimes,a=n.expirationTimes;0<s;){var c=31-li(s),u=1<<c;i[c]=0,o[c]=-1,a[c]=-1,s&=~u}if(cr!==null&&!(r&24)&&cr.has(n)&&cr.delete(n),n===kt&&(Ye=kt=null,mt=0),1<t.flags?t.lastEffect!==null?(t.lastEffect.nextEffect=t,r=t.firstEffect):r=t:r=t.firstEffect,r!==null){if(i=J,J|=32,hm.current=null,Zd=Ac,o=ag(),uf(o)){if("selectionStart"in o)a={start:o.selectionStart,end:o.selectionEnd};else e:if(a=(a=o.ownerDocument)&&a.defaultView||window,(u=a.getSelection&&a.getSelection())&&u.rangeCount!==0){a=u.anchorNode,s=u.anchorOffset,c=u.focusNode,u=u.focusOffset;try{a.nodeType,c.nodeType}catch{a=null;break e}var l=0,d=-1,p=-1,m=0,w=0,S=o,v=null;t:for(;;){for(var _;S!==a||s!==0&&S.nodeType!==3||(d=l+s),S!==c||u!==0&&S.nodeType!==3||(p=l+u),S.nodeType===3&&(l+=S.nodeValue.length),(_=S.firstChild)!==null;)v=S,S=_;for(;;){if(S===o)break t;if(v===a&&++m===s&&(d=l),v===c&&++w===u&&(p=l),(_=S.nextSibling)!==null)break;S=v,v=S.parentNode}S=_}a=d===-1||p===-1?null:{start:d,end:p}}else a=null;a=a||{start:0,end:0}}else a=null;eh={focusedElem:o,selectionRange:a},Ac=!1,Pa=null,Lc=!1,z=r;do try{fT()}catch(I){if(z===null)throw Error(L(330));ei(z,I),z=z.nextEffect}while(z!==null);Pa=null,z=r;do try{for(o=n;z!==null;){var b=z.flags;if(b&16&&Va(z.stateNode,""),b&128){var k=z.alternate;if(k!==null){var g=k.ref;g!==null&&(typeof g=="function"?g(null):g.current=null)}}switch(b&1038){case 2:Gg(z),z.flags&=-3;break;case 6:Gg(z),z.flags&=-3,ah(z.alternate,z);break;case 1024:z.flags&=-1025;break;case 1028:z.flags&=-1025,ah(z.alternate,z);break;case 4:ah(z.alternate,z);break;case 8:a=z,Wb(o,a);var A=a.alternate;Hg(a),A!==null&&Hg(A)}z=z.nextEffect}}catch(I){if(z===null)throw Error(L(330));ei(z,I),z=z.nextEffect}while(z!==null);if(g=eh,k=ag(),b=g.focusedElem,o=g.selectionRange,k!==b&&b&&b.ownerDocument&&hb(b.ownerDocument.documentElement,b)){for(o!==null&&uf(b)&&(k=o.start,g=o.end,g===void 0&&(g=k),"selectionStart"in b?(b.selectionStart=k,b.selectionEnd=Math.min(g,b.value.length)):(g=(k=b.ownerDocument||document)&&k.defaultView||window,g.getSelection&&(g=g.getSelection(),a=b.textContent.length,A=Math.min(o.start,a),o=o.end===void 0?A:Math.min(o.end,a),!g.extend&&A>o&&(a=o,o=A,A=a),a=og(b,A),s=og(b,o),a&&s&&(g.rangeCount!==1||g.anchorNode!==a.node||g.anchorOffset!==a.offset||g.focusNode!==s.node||g.focusOffset!==s.offset)&&(k=k.createRange(),k.setStart(a.node,a.offset),g.removeAllRanges(),A>o?(g.addRange(k),g.extend(s.node,s.offset)):(k.setEnd(s.node,s.offset),g.addRange(k)))))),k=[],g=b;g=g.parentNode;)g.nodeType===1&&k.push({element:g,left:g.scrollLeft,top:g.scrollTop});for(typeof b.focus=="function"&&b.focus(),b=0;b<k.length;b++)g=k[b],g.element.scrollLeft=g.left,g.element.scrollTop=g.top}Ac=!!Zd,eh=Zd=null,n.current=t,z=r;do try{for(b=n;z!==null;){var M=z.flags;if(M&36&&oT(b,z.alternate,z),M&128){k=void 0;var C=z.ref;if(C!==null){var P=z.stateNode;switch(z.tag){case 5:k=P;break;default:k=P}typeof C=="function"?C(k):C.current=k}}z=z.nextEffect}}catch(I){if(z===null)throw Error(L(330));ei(z,I),z=z.nextEffect}while(z!==null);z=null,WI(),J=i}else n.current=t;if(ui)ui=!1,Da=n,fa=e;else for(z=r;z!==null;)e=z.nextEffect,z.nextEffect=null,z.flags&8&&(M=z,M.sibling=null,M.stateNode=null),z=e;if(r=n.pendingLanes,r===0&&(Pn=null),r===1?n===Nf?Na++:(Na=0,Nf=n):Na=0,t=t.stateNode,Ki&&typeof Ki.onCommitFiberRoot=="function")try{Ki.onCommitFiberRoot(Zp,t,void 0,(t.current.flags&64)===64)}catch{}if(an(n,ft()),mu)throw mu=!1,n=xf,xf=null,n;return J&8||jn(),null}function fT(){for(;z!==null;){var n=z.alternate;Lc||Pa===null||(z.flags&8?G_(z,Pa)&&(Lc=!0):z.tag===13&&aT(n,z)&&G_(z,Pa)&&(Lc=!0));var e=z.flags;e&256&&sT(n,z),!(e&512)||ui||(ui=!0,Ya(97,function(){return mi(),null})),z=z.nextEffect}}function mi(){if(fa!==90){var n=97<fa?97:fa;return fa=90,Zi(n,mT)}return!1}function pT(n,e){Af.push(e,n),ui||(ui=!0,Ya(97,function(){return mi(),null}))}function nS(n,e){Df.push(e,n),ui||(ui=!0,Ya(97,function(){return mi(),null}))}function mT(){if(Da===null)return!1;var n=Da;if(Da=null,J&48)throw Error(L(331));var e=J;J|=32;var t=Df;Df=[];for(var r=0;r<t.length;r+=2){var i=t[r],s=t[r+1],o=i.destroy;if(i.destroy=void 0,typeof o=="function")try{o()}catch(c){if(s===null)throw Error(L(330));ei(s,c)}}for(t=Af,Af=[],r=0;r<t.length;r+=2){i=t[r],s=t[r+1];try{var a=i.create;i.destroy=a()}catch(c){if(s===null)throw Error(L(330));ei(s,c)}}for(a=n.current.firstEffect;a!==null;)n=a.nextEffect,a.nextEffect=null,a.flags&8&&(a.sibling=null,a.stateNode=null),a=n;return J=e,jn(),!0}function Wg(n,e,t){e=dm(t,e),e=Gb(n,e,1),Jr(n,e),e=Ht(),n=sd(n,1),n!==null&&(Ju(n,1,e),an(n,e))}function ei(n,e){if(n.tag===3)Wg(n,n,e);else for(var t=n.return;t!==null;){if(t.tag===3){Wg(t,n,e);break}else if(t.tag===1){var r=t.stateNode;if(typeof t.type.getDerivedStateFromError=="function"||typeof r.componentDidCatch=="function"&&(Pn===null||!Pn.has(r))){n=dm(e,n);var i=qb(t,n,1);if(Jr(t,i),i=Ht(),t=sd(t,1),t!==null)Ju(t,1,i),an(t,i);else if(typeof r.componentDidCatch=="function"&&(Pn===null||!Pn.has(r)))try{r.componentDidCatch(e,n)}catch{}break}}t=t.return}}function _T(n,e,t){var r=n.pingCache;r!==null&&r.delete(e),e=Ht(),n.pingedLanes|=n.suspendedLanes&t,kt===n&&(mt&t)===t&&(ot===4||ot===3&&(mt&62914560)===mt&&500>ft()-pm?Bs(n,0):fm|=t),an(n,e)}function gT(n,e){var t=n.stateNode;t!==null&&t.delete(e),e=0,e===0&&(e=n.mode,e&2?e&4?(ir===0&&(ir=wo),e=gs(62914560&~ir),e===0&&(e=4194304)):e=eo()===99?1:2:e=1),t=Ht(),n=sd(n,e),n!==null&&(Ju(n,e,t),an(n,t))}var rS;rS=function(n,e,t){var r=e.lanes;if(n!==null)if(n.memoizedProps!==e.pendingProps||Nt.current)gn=!0;else if(t&r)gn=!!(n.flags&16384);else{switch(gn=!1,e.tag){case 3:Pg(e),ih();break;case 5:Ig(e);break;case 1:Pt(e.type)&&Pc(e);break;case 4:yf(e,e.stateNode.containerInfo);break;case 10:r=e.memoizedProps.value;var i=e.type._context;Pe(ru,i._currentValue),i._currentValue=r;break;case 13:if(e.memoizedState!==null)return t&e.child.childLanes?Og(n,e,t):(Pe(Ne,Ne.current&1),e=lr(n,e,t),e!==null?e.sibling:null);Pe(Ne,Ne.current&1);break;case 19:if(r=(t&e.childLanes)!==0,n.flags&64){if(r)return Bg(n,e,t);e.flags|=64}if(i=e.memoizedState,i!==null&&(i.rendering=null,i.tail=null,i.lastEffect=null),Pe(Ne,Ne.current),r)break;return null;case 23:case 24:return e.lanes=0,sh(n,e,t)}return lr(n,e,t)}else gn=!1;switch(e.lanes=0,e.tag){case 2:if(r=e.type,n!==null&&(n.alternate=null,e.alternate=null,e.flags|=2),n=e.pendingProps,i=Zs(e,_t.current),$s(e,t),i=am(null,e,r,n,i,t),e.flags|=1,typeof i=="object"&&i!==null&&typeof i.render=="function"&&i.$$typeof===void 0){if(e.tag=1,e.memoizedState=null,e.updateQueue=null,Pt(r)){var s=!0;Pc(e)}else s=!1;e.memoizedState=i.state!==null&&i.state!==void 0?i.state:null,rm(e);var o=r.getDerivedStateFromProps;typeof o=="function"&&ou(e,r,o,n),i.updater=rd,e.stateNode=i,i._reactInternals=e,gf(e,r,n,t),e=Sf(null,e,r,!0,s,t)}else e.tag=0,Dt(null,e,i,t),e=e.child;return e;case 16:i=e.elementType;e:{switch(n!==null&&(n.alternate=null,e.alternate=null,e.flags|=2),n=e.pendingProps,s=i._init,i=s(i._payload),e.type=i,s=e.tag=vT(i),n=pn(i,n),s){case 0:e=bf(null,e,i,n,t);break e;case 1:e=Ng(null,e,i,n,t);break e;case 11:e=Ag(null,e,i,n,t);break e;case 14:e=Dg(null,e,i,pn(i.type,n),r,t);break e}throw Error(L(306,i,""))}return e;case 0:return r=e.type,i=e.pendingProps,i=e.elementType===r?i:pn(r,i),bf(n,e,r,i,t);case 1:return r=e.type,i=e.pendingProps,i=e.elementType===r?i:pn(r,i),Ng(n,e,r,i,t);case 3:if(Pg(e),r=e.updateQueue,n===null||r===null)throw Error(L(282));if(r=e.pendingProps,i=e.memoizedState,i=i!==null?i.element:null,Cb(n,e),Xa(e,r,null,t),r=e.memoizedState.element,r===i)ih(),e=lr(n,e,t);else{if(i=e.stateNode,(s=i.hydrate)&&(jr=Us(e.stateNode.containerInfo.firstChild),ar=e,s=Un=!0),s){if(n=i.mutableSourceEagerHydrationData,n!=null)for(i=0;i<n.length;i+=2)s=n[i],s._workInProgressVersionPrimary=n[i+1],Ls.push(s);for(t=Db(e,null,r,t),e.child=t;t;)t.flags=t.flags&-3|1024,t=t.sibling}else Dt(n,e,r,t),ih();e=e.child}return e;case 5:return Ig(e),n===null&&vf(e),r=e.type,i=e.pendingProps,s=n!==null?n.memoizedProps:null,o=i.children,ff(r,i)?o=null:s!==null&&ff(r,s)&&(e.flags|=16),Kb(n,e),Dt(n,e,o,t),e.child;case 6:return n===null&&vf(e),null;case 13:return Og(n,e,t);case 4:return yf(e,e.stateNode.containerInfo),r=e.pendingProps,n===null?e.child=au(e,null,r,t):Dt(n,e,r,t),e.child;case 11:return r=e.type,i=e.pendingProps,i=e.elementType===r?i:pn(r,i),Ag(n,e,r,i,t);case 7:return Dt(n,e,e.pendingProps,t),e.child;case 8:return Dt(n,e,e.pendingProps.children,t),e.child;case 12:return Dt(n,e,e.pendingProps.children,t),e.child;case 10:e:{r=e.type._context,i=e.pendingProps,o=e.memoizedProps,s=i.value;var a=e.type._context;if(Pe(ru,a._currentValue),a._currentValue=s,o!==null)if(a=o.value,s=Qt(a,s)?0:(typeof r._calculateChangedBits=="function"?r._calculateChangedBits(a,s):1073741823)|0,s===0){if(o.children===i.children&&!Nt.current){e=lr(n,e,t);break e}}else for(a=e.child,a!==null&&(a.return=e);a!==null;){var c=a.dependencies;if(c!==null){o=a.child;for(var u=c.firstContext;u!==null;){if(u.context===r&&u.observedBits&s){a.tag===1&&(u=Xr(-1,t&-t),u.tag=2,Jr(a,u)),a.lanes|=t,u=a.alternate,u!==null&&(u.lanes|=t),Rb(a.return,t),c.lanes|=t;break}u=u.next}}else o=a.tag===10&&a.type===e.type?null:a.child;if(o!==null)o.return=a;else for(o=a;o!==null;){if(o===e){o=null;break}if(a=o.sibling,a!==null){a.return=o.return,o=a;break}o=o.return}a=o}Dt(n,e,i.children,t),e=e.child}return e;case 9:return i=e.type,s=e.pendingProps,r=s.children,$s(e,t),i=on(i,s.unstable_observedBits),r=r(i),e.flags|=1,Dt(n,e,r,t),e.child;case 14:return i=e.type,s=pn(i,e.pendingProps),s=pn(i.type,s),Dg(n,e,i,s,r,t);case 15:return Vb(n,e,e.type,e.pendingProps,r,t);case 17:return r=e.type,i=e.pendingProps,i=e.elementType===r?i:pn(r,i),n!==null&&(n.alternate=null,e.alternate=null,e.flags|=2),e.tag=1,Pt(r)?(n=!0,Pc(e)):n=!1,$s(e,t),xb(e,r,i),gf(e,r,i,t),Sf(null,e,r,!0,n,t);case 19:return Bg(n,e,t);case 23:return sh(n,e,t);case 24:return sh(n,e,t)}throw Error(L(156,e.tag))};function yT(n,e,t,r){this.tag=n,this.key=t,this.sibling=this.child=this.return=this.stateNode=this.type=this.elementType=null,this.index=0,this.ref=null,this.pendingProps=e,this.dependencies=this.memoizedState=this.updateQueue=this.memoizedProps=null,this.mode=r,this.flags=0,this.lastEffect=this.firstEffect=this.nextEffect=null,this.childLanes=this.lanes=0,this.alternate=null}function Zt(n,e,t,r){return new yT(n,e,t,r)}function _m(n){return n=n.prototype,!(!n||!n.isReactComponent)}function vT(n){if(typeof n=="function")return _m(n)?1:0;if(n!=null){if(n=n.$$typeof,n===Wu)return 11;if(n===Yu)return 14}return 2}function di(n,e){var t=n.alternate;return t===null?(t=Zt(n.tag,e,n.key,n.mode),t.elementType=n.elementType,t.type=n.type,t.stateNode=n.stateNode,t.alternate=n,n.alternate=t):(t.pendingProps=e,t.type=n.type,t.flags=0,t.nextEffect=null,t.firstEffect=null,t.lastEffect=null),t.childLanes=n.childLanes,t.lanes=n.lanes,t.child=n.child,t.memoizedProps=n.memoizedProps,t.memoizedState=n.memoizedState,t.updateQueue=n.updateQueue,e=n.dependencies,t.dependencies=e===null?null:{lanes:e.lanes,firstContext:e.firstContext},t.sibling=n.sibling,t.index=n.index,t.ref=n.ref,t}function Fc(n,e,t,r,i,s){var o=2;if(r=n,typeof n=="function")_m(n)&&(o=1);else if(typeof n=="string")o=5;else e:switch(n){case Or:return Vs(t.children,i,s,e);case Nw:o=8,i|=16;break;case Dp:o=8,i|=1;break;case Ea:return n=Zt(12,t,e,i|8),n.elementType=Ea,n.type=Ea,n.lanes=s,n;case ka:return n=Zt(13,t,e,i),n.type=ka,n.elementType=ka,n.lanes=s,n;case Wc:return n=Zt(19,t,e,i),n.elementType=Wc,n.lanes=s,n;case Lp:return gm(t,i,s,e);case Wh:return n=Zt(24,t,e,i),n.elementType=Wh,n.lanes=s,n;default:if(typeof n=="object"&&n!==null)switch(n.$$typeof){case Np:o=10;break e;case Pp:o=9;break e;case Wu:o=11;break e;case Yu:o=14;break e;case Op:o=16,r=null;break e;case Up:o=22;break e}throw Error(L(130,n==null?n:typeof n,""))}return e=Zt(o,t,e,i),e.elementType=n,e.type=r,e.lanes=s,e}function Vs(n,e,t,r){return n=Zt(7,n,r,e),n.lanes=t,n}function gm(n,e,t,r){return n=Zt(23,n,r,e),n.elementType=Lp,n.lanes=t,n}function lh(n,e,t){return n=Zt(6,n,null,e),n.lanes=t,n}function ch(n,e,t){return e=Zt(4,n.children!==null?n.children:[],n.key,e),e.lanes=t,e.stateNode={containerInfo:n.containerInfo,pendingChildren:null,implementation:n.implementation},e}function wT(n,e,t){this.tag=e,this.containerInfo=n,this.finishedWork=this.pingCache=this.current=this.pendingChildren=null,this.timeoutHandle=-1,this.pendingContext=this.context=null,this.hydrate=t,this.callbackNode=null,this.callbackPriority=0,this.eventTimes=Gd(0),this.expirationTimes=Gd(-1),this.entangledLanes=this.finishedLanes=this.mutableReadLanes=this.expiredLanes=this.pingedLanes=this.suspendedLanes=this.pendingLanes=0,this.entanglements=Gd(0),this.mutableSourceEagerHydrationData=null}function bT(n,e,t){var r=3<arguments.length&&arguments[3]!==void 0?arguments[3]:null;return{$$typeof:Pi,key:r==null?null:""+r,children:n,containerInfo:e,implementation:t}}function _u(n,e,t,r){var i=e.current,s=Ht(),o=Qr(i);e:if(t){t=t._reactInternals;t:{if(os(t)!==t||t.tag!==1)throw Error(L(170));var a=t;do{switch(a.tag){case 3:a=a.stateNode.context;break t;case 1:if(Pt(a.type)){a=a.stateNode.__reactInternalMemoizedMergedChildContext;break t}}a=a.return}while(a!==null);throw Error(L(171))}if(t.tag===1){var c=t.type;if(Pt(c)){t=wb(t,c,a);break e}}t=a}else t=ci;return e.context===null?e.context=t:e.pendingContext=t,e=Xr(s,o),e.payload={element:n},r=r===void 0?null:r,r!==null&&(e.callback=r),Jr(i,e),Zr(i,o,s),o}function uh(n){if(n=n.current,!n.child)return null;switch(n.child.tag){case 5:return n.child.stateNode;default:return n.child.stateNode}}function Yg(n,e){if(n=n.memoizedState,n!==null&&n.dehydrated!==null){var t=n.retryLane;n.retryLane=t!==0&&t<e?t:e}}function ym(n,e){Yg(n,e),(n=n.alternate)&&Yg(n,e)}function ST(){return null}function vm(n,e,t){var r=t!=null&&t.hydrationOptions!=null&&t.hydrationOptions.mutableSources||null;if(t=new wT(n,e,t!=null&&t.hydrate===!0),e=Zt(3,null,null,e===2?7:e===1?3:0),t.current=e,e.stateNode=t,rm(e),n[vo]=t.current,mb(n.nodeType===8?n.parentNode:n),r)for(n=0;n<r.length;n++){e=r[n];var i=e._getVersion;i=i(e._source),t.mutableSourceEagerHydrationData==null?t.mutableSourceEagerHydrationData=[e,i]:t.mutableSourceEagerHydrationData.push(e,i)}this._internalRoot=t}vm.prototype.render=function(n){_u(n,this._internalRoot,null,null)};vm.prototype.unmount=function(){var n=this._internalRoot,e=n.containerInfo;_u(null,n,null,function(){e[vo]=null})};function Il(n){return!(!n||n.nodeType!==1&&n.nodeType!==9&&n.nodeType!==11&&(n.nodeType!==8||n.nodeValue!==" react-mount-point-unstable "))}function ET(n,e){if(e||(e=n?n.nodeType===9?n.documentElement:n.firstChild:null,e=!(!e||e.nodeType!==1||!e.hasAttribute("data-reactroot"))),!e)for(var t;t=n.lastChild;)n.removeChild(t);return new vm(n,0,e?{hydrate:!0}:void 0)}function od(n,e,t,r,i){var s=t._reactRootContainer;if(s){var o=s._internalRoot;if(typeof i=="function"){var a=i;i=function(){var u=uh(o);a.call(u)}}_u(e,o,n,i)}else{if(s=t._reactRootContainer=ET(t,r),o=s._internalRoot,typeof i=="function"){var c=i;i=function(){var u=uh(o);c.call(u)}}Jb(function(){_u(e,o,n,i)})}return uh(o)}Ww=function(n){if(n.tag===13){var e=Ht();Zr(n,4,e),ym(n,4)}};jp=function(n){if(n.tag===13){var e=Ht();Zr(n,67108864,e),ym(n,67108864)}};Yw=function(n){if(n.tag===13){var e=Ht(),t=Qr(n);Zr(n,t,e),ym(n,t)}};Xw=function(n,e){return e()};sf=function(n,e,t){switch(e){case"input":if(Xh(n,t),e=t.name,t.type==="radio"&&e!=null){for(t=n;t.parentNode;)t=t.parentNode;for(t=t.querySelectorAll("input[name="+JSON.stringify(""+e)+'][type="radio"]'),e=0;e<t.length;e++){var r=t[e];if(r!==n&&r.form===n.form){var i=td(r);if(!i)throw Error(L(90));Ow(r),Xh(r,i)}}}break;case"textarea":$w(n,t);break;case"select":e=t.value,e!=null&&Ns(n,!!t.multiple,e,!1)}};Bp=Xb;Hw=function(n,e,t,r,i){var s=J;J|=4;try{return Zi(98,n.bind(null,e,t,r,i))}finally{J=s,J===0&&(So(),jn())}};Vp=function(){!(J&49)&&(cT(),mi())};zw=function(n,e){var t=J;J|=2;try{return n(e)}finally{J=t,J===0&&(So(),jn())}};function iS(n,e){var t=2<arguments.length&&arguments[2]!==void 0?arguments[2]:null;if(!Il(e))throw Error(L(200));return bT(n,e,null,t)}var kT={Events:[Sl,Is,td,Kw,jw,mi,{current:!1}]},ea={findFiberByHostInstance:Ui,bundleType:0,version:"17.0.2",rendererPackageName:"react-dom"},IT={bundleType:ea.bundleType,version:ea.version,rendererPackageName:ea.rendererPackageName,rendererConfig:ea.rendererConfig,overrideHookState:null,overrideHookStateDeletePath:null,overrideHookStateRenamePath:null,overrideProps:null,overridePropsDeletePath:null,overridePropsRenamePath:null,setSuspenseHandler:null,scheduleUpdate:null,currentDispatcherRef:ss.ReactCurrentDispatcher,findHostInstanceByFiber:function(n){return n=qw(n),n===null?null:n.stateNode},findFiberByHostInstance:ea.findFiberByHostInstance||ST,findHostInstancesForRefresh:null,scheduleRefresh:null,scheduleRoot:null,setRefreshHandler:null,getCurrentFiber:null};if(typeof __REACT_DEVTOOLS_GLOBAL_HOOK__<"u"){var Gl=__REACT_DEVTOOLS_GLOBAL_HOOK__;if(!Gl.isDisabled&&Gl.supportsFiber)try{Zp=Gl.inject(IT),Ki=Gl}catch{}}cn.__SECRET_INTERNALS_DO_NOT_USE_OR_YOU_WILL_BE_FIRED=kT;cn.createPortal=iS;cn.findDOMNode=function(n){if(n==null)return null;if(n.nodeType===1)return n;var e=n._reactInternals;if(e===void 0)throw typeof n.render=="function"?Error(L(188)):Error(L(268,Object.keys(n)));return n=qw(e),n=n===null?null:n.stateNode,n};cn.flushSync=function(n,e){var t=J;if(t&48)return n(e);J|=1;try{if(n)return Zi(99,n.bind(null,e))}finally{J=t,jn()}};cn.hydrate=function(n,e,t){if(!Il(e))throw Error(L(200));return od(null,n,e,!0,t)};cn.render=function(n,e,t){if(!Il(e))throw Error(L(200));return od(null,n,e,!1,t)};cn.unmountComponentAtNode=function(n){if(!Il(n))throw Error(L(40));return n._reactRootContainer?(Jb(function(){od(null,null,n,!1,function(){n._reactRootContainer=null,n[vo]=null})}),!0):!1};cn.unstable_batchedUpdates=Xb;cn.unstable_createPortal=function(n,e){return iS(n,e,2<arguments.length&&arguments[2]!==void 0?arguments[2]:null)};cn.unstable_renderSubtreeIntoContainer=function(n,e,t,r){if(!Il(t))throw Error(L(200));if(n==null||n._reactInternals===void 0)throw Error(L(38));return od(n,e,t,!1,r)};cn.version="17.0.2";function sS(){if(!(typeof __REACT_DEVTOOLS_GLOBAL_HOOK__>"u"||typeof __REACT_DEVTOOLS_GLOBAL_HOOK__.checkDCE!="function"))try{__REACT_DEVTOOLS_GLOBAL_HOOK__.checkDCE(sS)}catch(n){console.error(n)}}sS(),Mw.exports=cn;var TT=Mw.exports;const RT=mo(TT);function gu(){return gu=Object.assign?Object.assign.bind():function(n){for(var e=1;e<arguments.length;e++){var t=arguments[e];for(var r in t)Object.prototype.hasOwnProperty.call(t,r)&&(n[r]=t[r])}return n},gu.apply(this,arguments)}var Fi;(function(n){n.Pop="POP",n.Push="PUSH",n.Replace="REPLACE"})(Fi||(Fi={}));var Xg=function(n){return n},Jg="beforeunload",CT="popstate";function MT(n){n===void 0&&(n={});var e=n,t=e.window,r=t===void 0?document.defaultView:t,i=r.history;function s(){var C=r.location,P=C.pathname,I=C.search,$=C.hash,x=i.state||{};return[x.idx,Xg({pathname:P,search:I,hash:$,state:x.usr||null,key:x.key||"default"})]}var o=null;function a(){if(o)m.call(o),o=null;else{var C=Fi.Pop,P=s(),I=P[0],$=P[1];if(m.length){if(I!=null){var x=l-I;x&&(o={action:C,location:$,retry:function(){A(x*-1)}},A(x))}}else b(C)}}r.addEventListener(CT,a);var c=Fi.Pop,u=s(),l=u[0],d=u[1],p=Zg(),m=Zg();l==null&&(l=0,i.replaceState(gu({},i.state,{idx:l}),""));function w(C){return typeof C=="string"?C:AT(C)}function S(C,P){return P===void 0&&(P=null),Xg(gu({pathname:d.pathname,hash:"",search:""},typeof C=="string"?Eo(C):C,{state:P,key:xT()}))}function v(C,P){return[{usr:C.state,key:C.key,idx:P},w(C)]}function _(C,P,I){return!m.length||(m.call({action:C,location:P,retry:I}),!1)}function b(C){c=C;var P=s();l=P[0],d=P[1],p.call({action:c,location:d})}function k(C,P){var I=Fi.Push,$=S(C,P);function x(){k(C,P)}if(_(I,$,x)){var U=v($,l+1),T=U[0],N=U[1];try{i.pushState(T,"",N)}catch{r.location.assign(N)}b(I)}}function g(C,P){var I=Fi.Replace,$=S(C,P);function x(){g(C,P)}if(_(I,$,x)){var U=v($,l),T=U[0],N=U[1];i.replaceState(T,"",N),b(I)}}function A(C){i.go(C)}var M={get action(){return c},get location(){return d},createHref:w,push:k,replace:g,go:A,back:function(){A(-1)},forward:function(){A(1)},listen:function(P){return p.push(P)},block:function(P){var I=m.push(P);return m.length===1&&r.addEventListener(Jg,Qg),function(){I(),m.length||r.removeEventListener(Jg,Qg)}}};return M}function Qg(n){n.preventDefault(),n.returnValue=""}function Zg(){var n=[];return{get length(){return n.length},push:function(t){return n.push(t),function(){n=n.filter(function(r){return r!==t})}},call:function(t){n.forEach(function(r){return r&&r(t)})}}}function xT(){return Math.random().toString(36).substr(2,8)}function AT(n){var e=n.pathname,t=e===void 0?"/":e,r=n.search,i=r===void 0?"":r,s=n.hash,o=s===void 0?"":s;return i&&i!=="?"&&(t+=i.charAt(0)==="?"?i:"?"+i),o&&o!=="#"&&(t+=o.charAt(0)==="#"?o:"#"+o),t}function Eo(n){var e={};if(n){var t=n.indexOf("#");t>=0&&(e.hash=n.substr(t),n=n.substr(0,t));var r=n.indexOf("?");r>=0&&(e.search=n.substr(r),n=n.substr(0,r)),n&&(e.pathname=n)}return e}/**
 * React Router v6.3.0
 *
 * Copyright (c) Remix Software Inc.
 *
 * This source code is licensed under the MIT license found in the
 * LICENSE.md file in the root directory of this source tree.
 *
 * @license MIT
 */const oS=R.createContext(null),ad=R.createContext(null),ld=R.createContext({outlet:null,matches:[]});function bn(n,e){if(!n)throw new Error(e)}function aS(n,e,t){t===void 0&&(t="/");let r=typeof e=="string"?Eo(e):e,i=uS(r.pathname||"/",t);if(i==null)return null;let s=lS(n);DT(s);let o=null;for(let a=0;o==null&&a<s.length;++a)o=VT(s[a],i);return o}function lS(n,e,t,r){return e===void 0&&(e=[]),t===void 0&&(t=[]),r===void 0&&(r=""),n.forEach((i,s)=>{let o={relativePath:i.path||"",caseSensitive:i.caseSensitive===!0,childrenIndex:s,route:i};o.relativePath.startsWith("/")&&(o.relativePath.startsWith(r)||bn(!1),o.relativePath=o.relativePath.slice(r.length));let a=ji([r,o.relativePath]),c=t.concat(o);i.children&&i.children.length>0&&(i.index===!0&&bn(!1),lS(i.children,e,c,a)),!(i.path==null&&!i.index)&&e.push({path:a,score:FT(a,i.index),routesMeta:c})}),e}function DT(n){n.sort((e,t)=>e.score!==t.score?t.score-e.score:BT(e.routesMeta.map(r=>r.childrenIndex),t.routesMeta.map(r=>r.childrenIndex)))}const NT=/^:\w+$/,PT=3,OT=2,UT=1,$T=10,LT=-2,ey=n=>n==="*";function FT(n,e){let t=n.split("/"),r=t.length;return t.some(ey)&&(r+=LT),e&&(r+=OT),t.filter(i=>!ey(i)).reduce((i,s)=>i+(NT.test(s)?PT:s===""?UT:$T),r)}function BT(n,e){return n.length===e.length&&n.slice(0,-1).every((r,i)=>r===e[i])?n[n.length-1]-e[e.length-1]:0}function VT(n,e){let{routesMeta:t}=n,r={},i="/",s=[];for(let o=0;o<t.length;++o){let a=t[o],c=o===t.length-1,u=i==="/"?e:e.slice(i.length)||"/",l=cS({path:a.relativePath,caseSensitive:a.caseSensitive,end:c},u);if(!l)return null;Object.assign(r,l.params);let d=a.route;s.push({params:r,pathname:ji([i,l.pathname]),pathnameBase:dS(ji([i,l.pathnameBase])),route:d}),l.pathnameBase!=="/"&&(i=ji([i,l.pathnameBase]))}return s}function cS(n,e){typeof n=="string"&&(n={path:n,caseSensitive:!1,end:!0});let[t,r]=KT(n.path,n.caseSensitive,n.end),i=e.match(t);if(!i)return null;let s=i[0],o=s.replace(/(.)\/+$/,"$1"),a=i.slice(1);return{params:r.reduce((u,l,d)=>{if(l==="*"){let p=a[d]||"";o=s.slice(0,s.length-p.length).replace(/(.)\/+$/,"$1")}return u[l]=jT(a[d]||""),u},{}),pathname:s,pathnameBase:o,pattern:n}}function KT(n,e,t){e===void 0&&(e=!1),t===void 0&&(t=!0);let r=[],i="^"+n.replace(/\/*\*?$/,"").replace(/^\/*/,"/").replace(/[\\.*+^$?{}|()[\]]/g,"\\$&").replace(/:(\w+)/g,(o,a)=>(r.push(a),"([^\\/]+)"));return n.endsWith("*")?(r.push("*"),i+=n==="*"||n==="/*"?"(.*)$":"(?:\\/(.+)|\\/*)$"):i+=t?"\\/*$":"(?:(?=[.~-]|%[0-9A-F]{2})|\\b|\\/|$)",[new RegExp(i,e?void 0:"i"),r]}function jT(n,e){try{return decodeURIComponent(n)}catch{return n}}function HT(n,e){e===void 0&&(e="/");let{pathname:t,search:r="",hash:i=""}=typeof n=="string"?Eo(n):n;return{pathname:t?t.startsWith("/")?t:zT(t,e):e,search:qT(r),hash:WT(i)}}function zT(n,e){let t=e.replace(/\/+$/,"").split("/");return n.split("/").forEach(i=>{i===".."?t.length>1&&t.pop():i!=="."&&t.push(i)}),t.length>1?t.join("/"):"/"}function GT(n,e,t){let r=typeof n=="string"?Eo(n):n,i=n===""||r.pathname===""?"/":r.pathname,s;if(i==null)s=t;else{let a=e.length-1;if(i.startsWith("..")){let c=i.split("/");for(;c[0]==="..";)c.shift(),a-=1;r.pathname=c.join("/")}s=a>=0?e[a]:"/"}let o=HT(r,s);return i&&i!=="/"&&i.endsWith("/")&&!o.pathname.endsWith("/")&&(o.pathname+="/"),o}function uS(n,e){if(e==="/")return n;if(!n.toLowerCase().startsWith(e.toLowerCase()))return null;let t=n.charAt(e.length);return t&&t!=="/"?null:n.slice(e.length)||"/"}const ji=n=>n.join("/").replace(/\/\/+/g,"/"),dS=n=>n.replace(/\/+$/,"").replace(/^\/*/,"/"),qT=n=>!n||n==="?"?"":n.startsWith("?")?n:"?"+n,WT=n=>!n||n==="#"?"":n.startsWith("#")?n:"#"+n;function ko(){return R.useContext(ad)!=null}function Io(){return ko()||bn(!1),R.useContext(ad).location}function YT(){return R.useContext(ad).navigationType}function ty(n){ko()||bn(!1);let{pathname:e}=Io();return R.useMemo(()=>cS(n,e),[e,n])}function cd(){ko()||bn(!1);let{basename:n,navigator:e}=R.useContext(oS),{matches:t}=R.useContext(ld),{pathname:r}=Io(),i=JSON.stringify(t.map(a=>a.pathnameBase)),s=R.useRef(!1);return R.useEffect(()=>{s.current=!0}),R.useCallback(function(a,c){if(c===void 0&&(c={}),!s.current)return;if(typeof a=="number"){e.go(a);return}let u=GT(a,JSON.parse(i),r);n!=="/"&&(u.pathname=ji([n,u.pathname])),(c.replace?e.replace:e.push)(u,c.state)},[n,e,i,r])}const XT=R.createContext(null);function JT(n){let e=R.useContext(ld).outlet;return e&&R.createElement(XT.Provider,{value:n},e)}function QT(n,e){ko()||bn(!1);let{matches:t}=R.useContext(ld),r=t[t.length-1],i=r?r.params:{};r&&r.pathname;let s=r?r.pathnameBase:"/";r&&r.route;let o=Io(),a;if(e){var c;let p=typeof e=="string"?Eo(e):e;s==="/"||(c=p.pathname)!=null&&c.startsWith(s)||bn(!1),a=p}else a=o;let u=a.pathname||"/",l=s==="/"?u:u.slice(s.length)||"/",d=aS(n,{pathname:l});return ZT(d&&d.map(p=>Object.assign({},p,{params:Object.assign({},i,p.params),pathname:ji([s,p.pathname]),pathnameBase:p.pathnameBase==="/"?s:ji([s,p.pathnameBase])})),t)}function ZT(n,e){return e===void 0&&(e=[]),n==null?null:n.reduceRight((t,r,i)=>R.createElement(ld.Provider,{children:r.route.element!==void 0?r.route.element:t,value:{outlet:t,matches:e.concat(n.slice(0,i+1))}}),null)}function ql(n){let{to:e,replace:t,state:r}=n;ko()||bn(!1);let i=cd();return R.useEffect(()=>{i(e,{replace:t,state:r})}),null}function eR(n){return JT(n.context)}function Vt(n){bn(!1)}function tR(n){let{basename:e="/",children:t=null,location:r,navigationType:i=Fi.Pop,navigator:s,static:o=!1}=n;ko()&&bn(!1);let a=dS(e),c=R.useMemo(()=>({basename:a,navigator:s,static:o}),[a,s,o]);typeof r=="string"&&(r=Eo(r));let{pathname:u="/",search:l="",hash:d="",state:p=null,key:m="default"}=r,w=R.useMemo(()=>{let S=uS(u,a);return S==null?null:{pathname:S,search:l,hash:d,state:p,key:m}},[a,u,l,d,p,m]);return w==null?null:R.createElement(oS.Provider,{value:c},R.createElement(ad.Provider,{children:t,value:{location:w,navigationType:i}}))}function nR(n){let{children:e,location:t}=n;return QT(yu(e),t)}function yu(n){let e=[];return R.Children.forEach(n,t=>{if(!R.isValidElement(t))return;if(t.type===R.Fragment){e.push.apply(e,yu(t.props.children));return}t.type!==Vt&&bn(!1);let r={caseSensitive:t.props.caseSensitive,element:t.props.element,index:t.props.index,path:t.props.path};t.props.children&&(r.children=yu(t.props.children)),e.push(r)}),e}/**
 * React Router DOM v6.3.0
 *
 * Copyright (c) Remix Software Inc.
 *
 * This source code is licensed under the MIT license found in the
 * LICENSE.md file in the root directory of this source tree.
 *
 * @license MIT
 */function rR(n){let{basename:e,children:t,window:r}=n,i=R.useRef();i.current==null&&(i.current=MT({window:r}));let s=i.current,[o,a]=R.useState({action:s.action,location:s.location});return R.useLayoutEffect(()=>s.listen(a),[s]),R.createElement(tR,{basename:e,children:t,location:o.location,navigationType:o.action,navigator:s})}function cK(n){let e=R.useRef(dh(n)),t=Io(),r=R.useMemo(()=>{let o=dh(t.search);for(let a of e.current.keys())o.has(a)||e.current.getAll(a).forEach(c=>{o.append(a,c)});return o},[t.search]),i=cd(),s=R.useCallback((o,a)=>{i("?"+dh(o),a)},[i]);return[r,s]}function dh(n){return n===void 0&&(n=""),new URLSearchParams(typeof n=="string"||Array.isArray(n)||n instanceof URLSearchParams?n:Object.keys(n).reduce((e,t)=>{let r=n[t];return e.concat(Array.isArray(r)?r.map(i=>[t,i]):[[t,r]])},[]))}function en(n){for(var e=arguments.length,t=Array(e>1?e-1:0),r=1;r<e;r++)t[r-1]=arguments[r];throw Error("[Immer] minified error nr: "+n+(t.length?" "+t.map(function(i){return"'"+i+"'"}).join(","):"")+". Find the full error at: https://bit.ly/3cXEKWf")}function no(n){return!!n&&!!n[he]}function gr(n){return!!n&&(function(e){if(!e||typeof e!="object")return!1;var t=Object.getPrototypeOf(e);if(t===null)return!0;var r=Object.hasOwnProperty.call(t,"constructor")&&t.constructor;return r===Object||typeof r=="function"&&Function.toString.call(r)===fR}(n)||Array.isArray(n)||!!n[ly]||!!n.constructor[ly]||wm(n)||bm(n))}function ro(n,e,t){t===void 0&&(t=!1),To(n)===0?(t?Object.keys:Tm)(n).forEach(function(r){t&&typeof r=="symbol"||e(r,n[r],n)}):n.forEach(function(r,i){return e(i,r,n)})}function To(n){var e=n[he];return e?e.i>3?e.i-4:e.i:Array.isArray(n)?1:wm(n)?2:bm(n)?3:0}function Of(n,e){return To(n)===2?n.has(e):Object.prototype.hasOwnProperty.call(n,e)}function iR(n,e){return To(n)===2?n.get(e):n[e]}function hS(n,e,t){var r=To(n);r===2?n.set(e,t):r===3?(n.delete(e),n.add(t)):n[e]=t}function sR(n,e){return n===e?n!==0||1/n==1/e:n!=n&&e!=e}function wm(n){return dR&&n instanceof Map}function bm(n){return hR&&n instanceof Set}function Je(n){return n.o||n.t}function Sm(n){if(Array.isArray(n))return Array.prototype.slice.call(n);var e=pR(n);delete e[he];for(var t=Tm(e),r=0;r<t.length;r++){var i=t[r],s=e[i];s.writable===!1&&(s.writable=!0,s.configurable=!0),(s.get||s.set)&&(e[i]={configurable:!0,writable:!0,enumerable:s.enumerable,value:n[i]})}return Object.create(Object.getPrototypeOf(n),e)}function Em(n,e){return e===void 0&&(e=!1),km(n)||no(n)||!gr(n)||(To(n)>1&&(n.set=n.add=n.clear=n.delete=oR),Object.freeze(n),e&&ro(n,function(t,r){return Em(r,!0)},!0)),n}function oR(){en(2)}function km(n){return n==null||typeof n!="object"||Object.isFrozen(n)}function $n(n){var e=$f[n];return e||en(18,n),e}function aR(n,e){$f[n]||($f[n]=e)}function vu(){return tl}function hh(n,e){e&&($n("Patches"),n.u=[],n.s=[],n.v=e)}function wu(n){Uf(n),n.p.forEach(lR),n.p=null}function Uf(n){n===tl&&(tl=n.l)}function ny(n){return tl={p:[],l:tl,h:n,m:!0,_:0}}function lR(n){var e=n[he];e.i===0||e.i===1?e.j():e.O=!0}function fh(n,e){e._=e.p.length;var t=e.p[0],r=n!==void 0&&n!==t;return e.h.g||$n("ES5").S(e,n,r),r?(t[he].P&&(wu(e),en(4)),gr(n)&&(n=bu(e,n),e.l||Su(e,n)),e.u&&$n("Patches").M(t[he].t,n,e.u,e.s)):n=bu(e,t,[]),wu(e),e.u&&e.v(e.u,e.s),n!==fS?n:void 0}function bu(n,e,t){if(km(e))return e;var r=e[he];if(!r)return ro(e,function(s,o){return ry(n,r,e,s,o,t)},!0),e;if(r.A!==n)return e;if(!r.P)return Su(n,r.t,!0),r.t;if(!r.I){r.I=!0,r.A._--;var i=r.i===4||r.i===5?r.o=Sm(r.k):r.o;ro(r.i===3?new Set(i):i,function(s,o){return ry(n,r,i,s,o,t)}),Su(n,i,!1),t&&n.u&&$n("Patches").R(r,t,n.u,n.s)}return r.o}function ry(n,e,t,r,i,s){if(no(i)){var o=bu(n,i,s&&e&&e.i!==3&&!Of(e.D,r)?s.concat(r):void 0);if(hS(t,r,o),!no(o))return;n.m=!1}if(gr(i)&&!km(i)){if(!n.h.F&&n._<1)return;bu(n,i),e&&e.A.l||Su(n,i)}}function Su(n,e,t){t===void 0&&(t=!1),n.h.F&&n.m&&Em(e,t)}function ph(n,e){var t=n[he];return(t?Je(t):n)[e]}function iy(n,e){if(e in n)for(var t=Object.getPrototypeOf(n);t;){var r=Object.getOwnPropertyDescriptor(t,e);if(r)return r;t=Object.getPrototypeOf(t)}}function tr(n){n.P||(n.P=!0,n.l&&tr(n.l))}function mh(n){n.o||(n.o=Sm(n.t))}function el(n,e,t){var r=wm(e)?$n("MapSet").N(e,t):bm(e)?$n("MapSet").T(e,t):n.g?function(i,s){var o=Array.isArray(i),a={i:o?1:0,A:s?s.A:vu(),P:!1,I:!1,D:{},l:s,t:i,k:null,o:null,j:null,C:!1},c=a,u=Lf;o&&(c=[a],u=ma);var l=Proxy.revocable(c,u),d=l.revoke,p=l.proxy;return a.k=p,a.j=d,p}(e,t):$n("ES5").J(e,t);return(t?t.A:vu()).p.push(r),r}function cR(n){return no(n)||en(22,n),function e(t){if(!gr(t))return t;var r,i=t[he],s=To(t);if(i){if(!i.P&&(i.i<4||!$n("ES5").K(i)))return i.t;i.I=!0,r=sy(t,s),i.I=!1}else r=sy(t,s);return ro(r,function(o,a){i&&iR(i.t,o)===a||hS(r,o,e(a))}),s===3?new Set(r):r}(n)}function sy(n,e){switch(e){case 2:return new Map(n);case 3:return Array.from(n)}return Sm(n)}function uR(){function n(a,c){function u(){this.constructor=a}i(a,c),a.prototype=(u.prototype=c.prototype,new u)}function e(a){a.o||(a.D=new Map,a.o=new Map(a.t))}function t(a){a.o||(a.o=new Set,a.t.forEach(function(c){if(gr(c)){var u=el(a.A.h,c,a);a.p.set(c,u),a.o.add(u)}else a.o.add(c)}))}function r(a){a.O&&en(3,JSON.stringify(Je(a)))}var i=function(a,c){return(i=Object.setPrototypeOf||{__proto__:[]}instanceof Array&&function(u,l){u.__proto__=l}||function(u,l){for(var d in l)l.hasOwnProperty(d)&&(u[d]=l[d])})(a,c)},s=function(){function a(u,l){return this[he]={i:2,l,A:l?l.A:vu(),P:!1,I:!1,o:void 0,D:void 0,t:u,k:this,C:!1,O:!1},this}n(a,Map);var c=a.prototype;return Object.defineProperty(c,"size",{get:function(){return Je(this[he]).size}}),c.has=function(u){return Je(this[he]).has(u)},c.set=function(u,l){var d=this[he];return r(d),Je(d).has(u)&&Je(d).get(u)===l||(e(d),tr(d),d.D.set(u,!0),d.o.set(u,l),d.D.set(u,!0)),this},c.delete=function(u){if(!this.has(u))return!1;var l=this[he];return r(l),e(l),tr(l),l.t.has(u)?l.D.set(u,!1):l.D.delete(u),l.o.delete(u),!0},c.clear=function(){var u=this[he];r(u),Je(u).size&&(e(u),tr(u),u.D=new Map,ro(u.t,function(l){u.D.set(l,!1)}),u.o.clear())},c.forEach=function(u,l){var d=this;Je(this[he]).forEach(function(p,m){u.call(l,d.get(m),m,d)})},c.get=function(u){var l=this[he];r(l);var d=Je(l).get(u);if(l.I||!gr(d)||d!==l.t.get(u))return d;var p=el(l.A.h,d,l);return e(l),l.o.set(u,p),p},c.keys=function(){return Je(this[he]).keys()},c.values=function(){var u,l=this,d=this.keys();return(u={})[Wl]=function(){return l.values()},u.next=function(){var p=d.next();return p.done?p:{done:!1,value:l.get(p.value)}},u},c.entries=function(){var u,l=this,d=this.keys();return(u={})[Wl]=function(){return l.entries()},u.next=function(){var p=d.next();if(p.done)return p;var m=l.get(p.value);return{done:!1,value:[p.value,m]}},u},c[Wl]=function(){return this.entries()},a}(),o=function(){function a(u,l){return this[he]={i:3,l,A:l?l.A:vu(),P:!1,I:!1,o:void 0,t:u,k:this,p:new Map,O:!1,C:!1},this}n(a,Set);var c=a.prototype;return Object.defineProperty(c,"size",{get:function(){return Je(this[he]).size}}),c.has=function(u){var l=this[he];return r(l),l.o?!!l.o.has(u)||!(!l.p.has(u)||!l.o.has(l.p.get(u))):l.t.has(u)},c.add=function(u){var l=this[he];return r(l),this.has(u)||(t(l),tr(l),l.o.add(u)),this},c.delete=function(u){if(!this.has(u))return!1;var l=this[he];return r(l),t(l),tr(l),l.o.delete(u)||!!l.p.has(u)&&l.o.delete(l.p.get(u))},c.clear=function(){var u=this[he];r(u),Je(u).size&&(t(u),tr(u),u.o.clear())},c.values=function(){var u=this[he];return r(u),t(u),u.o.values()},c.entries=function(){var u=this[he];return r(u),t(u),u.o.entries()},c.keys=function(){return this.values()},c[Wl]=function(){return this.values()},c.forEach=function(u,l){for(var d=this.values(),p=d.next();!p.done;)u.call(l,p.value,p.value,this),p=d.next()},a}();aR("MapSet",{N:function(a,c){return new s(a,c)},T:function(a,c){return new o(a,c)}})}var oy,tl,Im=typeof Symbol<"u"&&typeof Symbol("x")=="symbol",dR=typeof Map<"u",hR=typeof Set<"u",ay=typeof Proxy<"u"&&Proxy.revocable!==void 0&&typeof Reflect<"u",fS=Im?Symbol.for("immer-nothing"):((oy={})["immer-nothing"]=!0,oy),ly=Im?Symbol.for("immer-draftable"):"__$immer_draftable",he=Im?Symbol.for("immer-state"):"__$immer_state",Wl=typeof Symbol<"u"&&Symbol.iterator||"@@iterator",fR=""+Object.prototype.constructor,Tm=typeof Reflect<"u"&&Reflect.ownKeys?Reflect.ownKeys:Object.getOwnPropertySymbols!==void 0?function(n){return Object.getOwnPropertyNames(n).concat(Object.getOwnPropertySymbols(n))}:Object.getOwnPropertyNames,pR=Object.getOwnPropertyDescriptors||function(n){var e={};return Tm(n).forEach(function(t){e[t]=Object.getOwnPropertyDescriptor(n,t)}),e},$f={},Lf={get:function(n,e){if(e===he)return n;var t=Je(n);if(!Of(t,e))return function(i,s,o){var a,c=iy(s,o);return c?"value"in c?c.value:(a=c.get)===null||a===void 0?void 0:a.call(i.k):void 0}(n,t,e);var r=t[e];return n.I||!gr(r)?r:r===ph(n.t,e)?(mh(n),n.o[e]=el(n.A.h,r,n)):r},has:function(n,e){return e in Je(n)},ownKeys:function(n){return Reflect.ownKeys(Je(n))},set:function(n,e,t){var r=iy(Je(n),e);if(r!=null&&r.set)return r.set.call(n.k,t),!0;if(!n.P){var i=ph(Je(n),e),s=i==null?void 0:i[he];if(s&&s.t===t)return n.o[e]=t,n.D[e]=!1,!0;if(sR(t,i)&&(t!==void 0||Of(n.t,e)))return!0;mh(n),tr(n)}return n.o[e]===t&&typeof t!="number"&&(t!==void 0||e in n.o)||(n.o[e]=t,n.D[e]=!0,!0)},deleteProperty:function(n,e){return ph(n.t,e)!==void 0||e in n.t?(n.D[e]=!1,mh(n),tr(n)):delete n.D[e],n.o&&delete n.o[e],!0},getOwnPropertyDescriptor:function(n,e){var t=Je(n),r=Reflect.getOwnPropertyDescriptor(t,e);return r&&{writable:!0,configurable:n.i!==1||e!=="length",enumerable:r.enumerable,value:t[e]}},defineProperty:function(){en(11)},getPrototypeOf:function(n){return Object.getPrototypeOf(n.t)},setPrototypeOf:function(){en(12)}},ma={};ro(Lf,function(n,e){ma[n]=function(){return arguments[0]=arguments[0][0],e.apply(this,arguments)}}),ma.deleteProperty=function(n,e){return ma.set.call(this,n,e,void 0)},ma.set=function(n,e,t){return Lf.set.call(this,n[0],e,t,n[0])};var mR=function(){function n(t){var r=this;this.g=ay,this.F=!0,this.produce=function(i,s,o){if(typeof i=="function"&&typeof s!="function"){var a=s;s=i;var c=r;return function(S){var v=this;S===void 0&&(S=a);for(var _=arguments.length,b=Array(_>1?_-1:0),k=1;k<_;k++)b[k-1]=arguments[k];return c.produce(S,function(g){var A;return(A=s).call.apply(A,[v,g].concat(b))})}}var u;if(typeof s!="function"&&en(6),o!==void 0&&typeof o!="function"&&en(7),gr(i)){var l=ny(r),d=el(r,i,void 0),p=!0;try{u=s(d),p=!1}finally{p?wu(l):Uf(l)}return typeof Promise<"u"&&u instanceof Promise?u.then(function(S){return hh(l,o),fh(S,l)},function(S){throw wu(l),S}):(hh(l,o),fh(u,l))}if(!i||typeof i!="object"){if((u=s(i))===void 0&&(u=i),u===fS&&(u=void 0),r.F&&Em(u,!0),o){var m=[],w=[];$n("Patches").M(i,u,m,w),o(m,w)}return u}en(21,i)},this.produceWithPatches=function(i,s){if(typeof i=="function")return function(u){for(var l=arguments.length,d=Array(l>1?l-1:0),p=1;p<l;p++)d[p-1]=arguments[p];return r.produceWithPatches(u,function(m){return i.apply(void 0,[m].concat(d))})};var o,a,c=r.produce(i,s,function(u,l){o=u,a=l});return typeof Promise<"u"&&c instanceof Promise?c.then(function(u){return[u,o,a]}):[c,o,a]},typeof(t==null?void 0:t.useProxies)=="boolean"&&this.setUseProxies(t.useProxies),typeof(t==null?void 0:t.autoFreeze)=="boolean"&&this.setAutoFreeze(t.autoFreeze)}var e=n.prototype;return e.createDraft=function(t){gr(t)||en(8),no(t)&&(t=cR(t));var r=ny(this),i=el(this,t,void 0);return i[he].C=!0,Uf(r),i},e.finishDraft=function(t,r){var i=t&&t[he],s=i.A;return hh(s,r),fh(void 0,s)},e.setAutoFreeze=function(t){this.F=t},e.setUseProxies=function(t){t&&!ay&&en(20),this.g=t},e.applyPatches=function(t,r){var i;for(i=r.length-1;i>=0;i--){var s=r[i];if(s.path.length===0&&s.op==="replace"){t=s.value;break}}i>-1&&(r=r.slice(i+1));var o=$n("Patches").$;return no(t)?o(t,r):this.produce(t,function(a){return o(a,r)})},n}(),Gt=new mR,uK=Gt.produce;Gt.produceWithPatches.bind(Gt);Gt.setAutoFreeze.bind(Gt);Gt.setUseProxies.bind(Gt);Gt.applyPatches.bind(Gt);Gt.createDraft.bind(Gt);Gt.finishDraft.bind(Gt);function _R(){return typeof __SENTRY_BROWSER_BUNDLE__<"u"&&!!__SENTRY_BROWSER_BUNDLE__}function ud(){return!_R()&&Object.prototype.toString.call(typeof process<"u"?process:0)==="[object process]"}function Hr(n,e){return n.require(e)}function gR(n){let e;try{e=Hr(module,n)}catch{}try{const{cwd:t}=Hr(module,"process");e=Hr(module,`${t()}/node_modules/${n}`)}catch{}return e}var yR={};function fe(){return ud()?global:typeof window<"u"?window:typeof self<"u"?self:yR}function Rm(n,e,t){var r=t||fe(),i=r.__SENTRY__=r.__SENTRY__||{},s=i[n]||(i[n]=e());return s}var pS=Object.prototype.toString;function mS(n){switch(pS.call(n)){case"[object Error]":case"[object Exception]":case"[object DOMException]":return!0;default:return Bn(n,Error)}}function Ro(n,e){return pS.call(n)===`[object ${e}]`}function _S(n){return Ro(n,"ErrorEvent")}function cy(n){return Ro(n,"DOMError")}function vR(n){return Ro(n,"DOMException")}function ts(n){return Ro(n,"String")}function gS(n){return n===null||typeof n!="object"&&typeof n!="function"}function io(n){return Ro(n,"Object")}function Cm(n){return typeof Event<"u"&&Bn(n,Event)}function wR(n){return typeof Element<"u"&&Bn(n,Element)}function bR(n){return Ro(n,"RegExp")}function Mm(n){return!!(n&&n.then&&typeof n.then=="function")}function SR(n){return io(n)&&"nativeEvent"in n&&"preventDefault"in n&&"stopPropagation"in n}function yS(n){return typeof n=="number"&&n!==n}function Bn(n,e){try{return n instanceof e}catch{return!1}}function nl(n,e){try{let a=n;var t=5,r=80,i=[];let c=0,u=0;var s=" > ",o=s.length;let l;for(;a&&c++<t&&(l=ER(a,e),!(l==="html"||c>1&&u+i.length*o+l.length>=r));)i.push(l),u+=l.length,a=a.parentNode;return i.reverse().join(s)}catch{return"<unknown>"}}function ER(n,e){var t=n,r=[];let i,s,o,a,c;if(!t||!t.tagName)return"";r.push(t.tagName.toLowerCase());var u=e&&e.length?e.filter(d=>t.getAttribute(d)).map(d=>[d,t.getAttribute(d)]):null;if(u&&u.length)u.forEach(d=>{r.push(`[${d[0]}="${d[1]}"]`)});else if(t.id&&r.push(`#${t.id}`),i=t.className,i&&ts(i))for(s=i.split(/\s+/),c=0;c<s.length;c++)r.push(`.${s[c]}`);var l=["type","name","title","alt"];for(c=0;c<l.length;c++)o=l[c],a=t.getAttribute(o),a&&r.push(`[${o}="${a}"]`);return r.join("")}function kR(){var n=fe();try{return n.document.location.href}catch{return""}}function IR(n){var e=fe();return e.document&&e.document.querySelector?e.document.querySelector(n):null}class ht extends Error{constructor(e,t="warn"){super(e),this.message=e,this.name=new.target.prototype.constructor.name,Object.setPrototypeOf(this,new.target.prototype),this.logLevel=t}}var TR=/^(?:(\w+):)\/\/(?:(\w+)(?::(\w+))?@)([\w.-]+)(?::(\d+))?\/(.+)/;function RR(n){return n==="http"||n==="https"}function xm(n,e=!1){const{host:t,path:r,pass:i,port:s,projectId:o,protocol:a,publicKey:c}=n;return`${a}://${c}${e&&i?`:${i}`:""}@${t}${s?`:${s}`:""}/${r&&`${r}/`}${o}`}function CR(n){var e=TR.exec(n);if(!e)throw new ht(`Invalid Sentry Dsn: ${n}`);const[t,r,i="",s,o="",a]=e.slice(1);let c="",u=a;var l=u.split("/");if(l.length>1&&(c=l.slice(0,-1).join("/"),u=l.pop()),u){var d=u.match(/^\d+/);d&&(u=d[0])}return vS({host:s,pass:i,path:c,projectId:u,port:o,protocol:t,publicKey:r})}function vS(n){return{protocol:n.protocol,publicKey:n.publicKey||"",pass:n.pass||"",host:n.host,port:n.port||"",path:n.path||"",projectId:n.projectId}}function MR(n){if(!(typeof __SENTRY_DEBUG__>"u"||__SENTRY_DEBUG__))return;const{port:e,projectId:t,protocol:r}=n;var i=["protocol","publicKey","host","projectId"];if(i.forEach(s=>{if(!n[s])throw new ht(`Invalid Sentry Dsn: ${s} missing`)}),!t.match(/^\d+$/))throw new ht(`Invalid Sentry Dsn: Invalid projectId ${t}`);if(!RR(r))throw new ht(`Invalid Sentry Dsn: Invalid protocol ${r}`);if(e&&isNaN(parseInt(e,10)))throw new ht(`Invalid Sentry Dsn: Invalid port ${e}`);return!0}function xR(n){var e=typeof n=="string"?CR(n):vS(n);return MR(e),e}var AR=fe(),DR="Sentry Logger ",Eu=["debug","info","warn","error","log","assert","trace"];function wS(n){var e=fe();if(!("console"in e))return n();var t=e.console,r={};Eu.forEach(i=>{var s=t[i]&&t[i].__sentry_original__;i in e.console&&s&&(r[i]=t[i],t[i]=s)});try{return n()}finally{Object.keys(r).forEach(i=>{t[i]=r[i]})}}function uy(){let n=!1;var e={enable:()=>{n=!0},disable:()=>{n=!1}};return typeof __SENTRY_DEBUG__>"u"||__SENTRY_DEBUG__?Eu.forEach(t=>{e[t]=(...r)=>{n&&wS(()=>{AR.console[t](`${DR}[${t}]:`,...r)})}}):Eu.forEach(t=>{e[t]=()=>{}}),e}let F;typeof __SENTRY_DEBUG__>"u"||__SENTRY_DEBUG__?F=Rm("logger",uy):F=uy();function Oa(n,e=0){return typeof n!="string"||e===0||n.length<=e?n:`${n.substr(0,e)}...`}function dy(n,e){if(!Array.isArray(n))return"";var t=[];for(let i=0;i<n.length;i++){var r=n[i];try{t.push(String(r))}catch{t.push("[value cannot be serialized]")}}return t.join(e)}function rl(n,e){return ts(n)?bR(e)?e.test(n):typeof e=="string"?n.indexOf(e)!==-1:!1:!1}function pt(n,e,t){if(e in n){var r=n[e],i=t(r);if(typeof i=="function")try{bS(i,r)}catch{}n[e]=i}}function Am(n,e,t){Object.defineProperty(n,e,{value:t,writable:!0,configurable:!0})}function bS(n,e){var t=e.prototype||{};n.prototype=e.prototype=t,Am(n,"__sentry_original__",e)}function Dm(n){return n.__sentry_original__}function NR(n){return Object.keys(n).map(e=>`${encodeURIComponent(e)}=${encodeURIComponent(n[e])}`).join("&")}function SS(n){if(mS(n))return{message:n.message,name:n.name,stack:n.stack,...fy(n)};if(Cm(n)){var e={type:n.type,target:hy(n.target),currentTarget:hy(n.currentTarget),...fy(n)};return typeof CustomEvent<"u"&&Bn(n,CustomEvent)&&(e.detail=n.detail),e}else return n}function hy(n){try{return wR(n)?nl(n):Object.prototype.toString.call(n)}catch{return"<unknown>"}}function fy(n){if(typeof n=="object"&&n!==null){var e={};for(var t in n)Object.prototype.hasOwnProperty.call(n,t)&&(e[t]=n[t]);return e}else return{}}function PR(n,e=40){var t=Object.keys(SS(n));if(t.sort(),!t.length)return"[object has no keys]";if(t[0].length>=e)return Oa(t[0],e);for(let i=t.length;i>0;i--){var r=t.slice(0,i).join(", ");if(!(r.length>e))return i===t.length?r:Oa(r,e)}return""}function ti(n){var e=new Map;return Ff(n,e)}function Ff(n,e){if(io(n)){var t=e.get(n);if(t!==void 0)return t;var r={};e.set(n,r);for(var i of Object.keys(n))typeof n[i]<"u"&&(r[i]=Ff(n[i],e));return r}if(Array.isArray(n)){var t=e.get(n);if(t!==void 0)return t;var r=[];return e.set(n,r),n.forEach(a=>{r.push(Ff(a,e))}),r}return n}function Ur(n,e){return n??e()}function OR(n){let e,t=n[0],r=1;for(;r<n.length;){var i=n[r],s=n[r+1];if(r+=2,(i==="optionalAccess"||i==="optionalCall")&&t==null)return;i==="access"||i==="optionalAccess"?(e=t,t=s(t)):(i==="call"||i==="optionalCall")&&(t=s((...o)=>t.call(e,...o)),e=void 0)}return t}var UR=50;function ES(...n){var e=n.sort((t,r)=>t[0]-r[0]).map(t=>t[1]);return(t,r=0)=>{var i=[];for(var s of t.split(`
`).slice(r)){var o=s.replace(/\(error: (.*)\)/,"$1");for(var a of e){var c=a(o);if(c){i.push(c);break}}}return LR(i)}}function $R(n){return Array.isArray(n)?ES(...n):n}function LR(n){if(!n.length)return[];let e=n;var t=e[0].function||"",r=e[e.length-1].function||"";return(t.indexOf("captureMessage")!==-1||t.indexOf("captureException")!==-1)&&(e=e.slice(1)),r.indexOf("sentryWrapped")!==-1&&(e=e.slice(0,-1)),e.slice(0,UR).map(i=>({...i,filename:i.filename||e[0].filename,function:i.function||"?"})).reverse()}var _h="<anonymous>";function hi(n){try{return!n||typeof n!="function"?_h:n.name||_h}catch{return _h}}function Nm(){if(!("fetch"in fe()))return!1;try{return new Headers,new Request("http://www.example.com"),new Response,!0}catch{return!1}}function Bf(n){return n&&/^function fetch\(\)\s+\{\s+\[native code\]\s+\}$/.test(n.toString())}function FR(){if(!Nm())return!1;var n=fe();if(Bf(n.fetch))return!0;let e=!1;var t=n.document;if(t&&typeof t.createElement=="function")try{var r=t.createElement("iframe");r.hidden=!0,t.head.appendChild(r),r.contentWindow&&r.contentWindow.fetch&&(e=Bf(r.contentWindow.fetch)),t.head.removeChild(r)}catch(i){(typeof __SENTRY_DEBUG__>"u"||__SENTRY_DEBUG__)&&F.warn("Could not create sandbox iframe for pure fetch check, bailing to window.fetch: ",i)}return e}function BR(){var n=fe(),e=n.chrome,t=e&&e.app&&e.app.runtime,r="history"in n&&!!n.history.pushState&&!!n.history.replaceState;return!t&&r}var Ce=fe(),Ua={},py={};function VR(n){if(!py[n])switch(py[n]=!0,n){case"console":KR();break;case"dom":JR();break;case"xhr":GR();break;case"fetch":jR();break;case"history":qR();break;case"error":QR();break;case"unhandledrejection":ZR();break;default:(typeof __SENTRY_DEBUG__>"u"||__SENTRY_DEBUG__)&&F.warn("unknown instrumentation type:",n);return}}function Kt(n,e){Ua[n]=Ua[n]||[],Ua[n].push(e),VR(n)}function wn(n,e){if(!(!n||!Ua[n]))for(var t of Ua[n]||[])try{t(e)}catch(r){(typeof __SENTRY_DEBUG__>"u"||__SENTRY_DEBUG__)&&F.error(`Error while triggering instrumentation handler.
Type: ${n}
Name: ${hi(t)}
Error:`,r)}}function KR(){"console"in Ce&&Eu.forEach(function(n){n in Ce.console&&pt(Ce.console,n,function(e){return function(...t){wn("console",{args:t,level:n}),e&&e.apply(Ce.console,t)}})})}function jR(){FR()&&pt(Ce,"fetch",function(n){return function(...e){var t={args:e,fetchData:{method:HR(e),url:zR(e)},startTimestamp:Date.now()};return wn("fetch",{...t}),n.apply(Ce,e).then(r=>(wn("fetch",{...t,endTimestamp:Date.now(),response:r}),r),r=>{throw wn("fetch",{...t,endTimestamp:Date.now(),error:r}),r})}})}function HR(n=[]){return"Request"in Ce&&Bn(n[0],Request)&&n[0].method?String(n[0].method).toUpperCase():n[1]&&n[1].method?String(n[1].method).toUpperCase():"GET"}function zR(n=[]){return typeof n[0]=="string"?n[0]:"Request"in Ce&&Bn(n[0],Request)?n[0].url:String(n[0])}function GR(){if("XMLHttpRequest"in Ce){var n=XMLHttpRequest.prototype;pt(n,"open",function(e){return function(...t){var r=this,i=t[1],s=r.__sentry_xhr__={method:ts(t[0])?t[0].toUpperCase():t[0],url:t[1]};ts(i)&&s.method==="POST"&&i.match(/sentry_key/)&&(r.__sentry_own_request__=!0);var o=function(){if(r.readyState===4){try{s.status_code=r.status}catch{}wn("xhr",{args:t,endTimestamp:Date.now(),startTimestamp:Date.now(),xhr:r})}};return"onreadystatechange"in r&&typeof r.onreadystatechange=="function"?pt(r,"onreadystatechange",function(a){return function(...c){return o(),a.apply(r,c)}}):r.addEventListener("readystatechange",o),e.apply(r,t)}}),pt(n,"send",function(e){return function(...t){return this.__sentry_xhr__&&t[0]!==void 0&&(this.__sentry_xhr__.body=t[0]),wn("xhr",{args:t,startTimestamp:Date.now(),xhr:this}),e.apply(this,t)}})}}let Yl;function qR(){if(!BR())return;var n=Ce.onpopstate;Ce.onpopstate=function(...t){var r=Ce.location.href,i=Yl;if(Yl=r,wn("history",{from:i,to:r}),n)try{return n.apply(this,t)}catch{}};function e(t){return function(...r){var i=r.length>2?r[2]:void 0;if(i){var s=Yl,o=String(i);Yl=o,wn("history",{from:s,to:o})}return t.apply(this,r)}}pt(Ce.history,"pushState",e),pt(Ce.history,"replaceState",e)}var WR=1e3;let Xl,Jl;function YR(n,e){if(!n||n.type!==e.type)return!0;try{if(n.target!==e.target)return!0}catch{}return!1}function XR(n){if(n.type!=="keypress")return!1;try{var e=n.target;if(!e||!e.tagName)return!0;if(e.tagName==="INPUT"||e.tagName==="TEXTAREA"||e.isContentEditable)return!1}catch{}return!0}function my(n,e=!1){return t=>{if(!(!t||Jl===t)&&!XR(t)){var r=t.type==="keypress"?"input":t.type;Xl===void 0?(n({event:t,name:r,global:e}),Jl=t):YR(Jl,t)&&(n({event:t,name:r,global:e}),Jl=t),clearTimeout(Xl),Xl=Ce.setTimeout(()=>{Xl=void 0},WR)}}}function JR(){if("document"in Ce){var n=wn.bind(null,"dom"),e=my(n,!0);Ce.document.addEventListener("click",e,!1),Ce.document.addEventListener("keypress",e,!1),["EventTarget","Node"].forEach(t=>{var r=Ce[t]&&Ce[t].prototype;!r||!r.hasOwnProperty||!r.hasOwnProperty("addEventListener")||(pt(r,"addEventListener",function(i){return function(s,o,a){if(s==="click"||s=="keypress")try{var c=this,u=c.__sentry_instrumentation_handlers__=c.__sentry_instrumentation_handlers__||{},l=u[s]=u[s]||{refCount:0};if(!l.handler){var d=my(n);l.handler=d,i.call(this,s,d,a)}l.refCount+=1}catch{}return i.call(this,s,o,a)}}),pt(r,"removeEventListener",function(i){return function(s,o,a){if(s==="click"||s=="keypress")try{var c=this,u=c.__sentry_instrumentation_handlers__||{},l=u[s];l&&(l.refCount-=1,l.refCount<=0&&(i.call(this,s,l.handler,a),l.handler=void 0,delete u[s]),Object.keys(u).length===0&&delete c.__sentry_instrumentation_handlers__)}catch{}return i.call(this,s,o,a)}}))})}}let gh=null;function QR(){gh=Ce.onerror,Ce.onerror=function(n,e,t,r,i){return wn("error",{column:r,error:i,line:t,msg:n,url:e}),gh?gh.apply(this,arguments):!1}}let yh=null;function ZR(){yh=Ce.onunhandledrejection,Ce.onunhandledrejection=function(n){return wn("unhandledrejection",n),yh?yh.apply(this,arguments):!0}}function e1(){var n=typeof WeakSet=="function",e=n?new WeakSet:[];function t(i){if(n)return e.has(i)?!0:(e.add(i),!1);for(let o=0;o<e.length;o++){var s=e[o];if(s===i)return!0}return e.push(i),!1}function r(i){if(n)e.delete(i);else for(let s=0;s<e.length;s++)if(e[s]===i){e.splice(s,1);break}}return[t,r]}function ni(){var n=fe(),e=n.crypto||n.msCrypto;if(e&&e.randomUUID)return e.randomUUID().replace(/-/g,"");var t=e&&e.getRandomValues?()=>e.getRandomValues(new Uint8Array(1))[0]:()=>Math.random()*16;return([1e7]+1e3+4e3+8e3+1e11).replace(/[018]/g,r=>(r^(t()&15)>>r/4).toString(16))}function kS(n){return n.exception&&n.exception.values?n.exception.values[0]:void 0}function Bi(n){const{message:e,event_id:t}=n;if(e)return e;var r=kS(n);return r?r.type&&r.value?`${r.type}: ${r.value}`:r.type||r.value||t||"<unknown>":t||"<unknown>"}function Vf(n,e,t){var r=n.exception=n.exception||{},i=r.values=r.values||[],s=i[0]=i[0]||{};s.value||(s.value=e||""),s.type||(s.type=t||"Error")}function il(n,e){var t=kS(n);if(t){var r={type:"generic",handled:!0},i=t.mechanism;if(t.mechanism={...r,...i,...e},e&&"data"in e){var s={...i&&i.data,...e.data};t.mechanism.data=s}}}function _y(n){if(n&&n.__sentry_captured__)return!0;try{Am(n,"__sentry_captured__",!0)}catch{}return!1}function IS(n){return Array.isArray(n)?n:[n]}function Ai(n,e=1/0,t=1/0){try{return Kf("",n,e,t)}catch(r){return{ERROR:`**non-serializable** (${r})`}}}function TS(n,e=3,t=100*1024){var r=Ai(n,e);return r1(r)>t?TS(n,e-1,t):r}function Kf(n,e,t=1/0,r=1/0,i=e1()){const[s,o]=i;if(e===null||["number","boolean","string"].includes(typeof e)&&!yS(e))return e;var a=t1(n,e);if(!a.startsWith("[object "))return a;if(e.__sentry_skip_normalization__)return e;if(t===0)return a.replace("object ","");if(s(e))return"[Circular ~]";var c=e;if(c&&typeof c.toJSON=="function")try{var u=c.toJSON();return Kf("",u,t-1,r,i)}catch{}var l=Array.isArray(e)?[]:{};let d=0;var p=SS(e);for(var m in p)if(Object.prototype.hasOwnProperty.call(p,m)){if(d>=r){l[m]="[MaxProperties ~]";break}var w=p[m];l[m]=Kf(m,w,t-1,r,i),d+=1}return o(e),l}function t1(n,e){try{return n==="domain"&&e&&typeof e=="object"&&e._events?"[Domain]":n==="domainEmitter"?"[DomainEmitter]":typeof global<"u"&&e===global?"[Global]":typeof window<"u"&&e===window?"[Window]":typeof document<"u"&&e===document?"[Document]":SR(e)?"[SyntheticEvent]":typeof e=="number"&&e!==e?"[NaN]":e===void 0?"[undefined]":typeof e=="function"?`[Function: ${hi(e)}]`:typeof e=="symbol"?`[${String(e)}]`:typeof e=="bigint"?`[BigInt: ${String(e)}]`:`[object ${Object.getPrototypeOf(e).constructor.name}]`}catch(t){return`**non-serializable** (${t})`}}function n1(n){return~-encodeURI(n).split(/%..|./).length}function r1(n){return n1(JSON.stringify(n))}var Zn;(function(n){var e=0;n[n.PENDING=e]="PENDING";var t=1;n[n.RESOLVED=t]="RESOLVED";var r=2;n[n.REJECTED=r]="REJECTED"})(Zn||(Zn={}));function ns(n){return new bt(e=>{e(n)})}function jf(n){return new bt((e,t)=>{t(n)})}class bt{__init(){this._state=Zn.PENDING}__init2(){this._handlers=[]}constructor(e){bt.prototype.__init.call(this),bt.prototype.__init2.call(this),bt.prototype.__init3.call(this),bt.prototype.__init4.call(this),bt.prototype.__init5.call(this),bt.prototype.__init6.call(this);try{e(this._resolve,this._reject)}catch(t){this._reject(t)}}then(e,t){return new bt((r,i)=>{this._handlers.push([!1,s=>{if(!e)r(s);else try{r(e(s))}catch(o){i(o)}},s=>{if(!t)i(s);else try{r(t(s))}catch(o){i(o)}}]),this._executeHandlers()})}catch(e){return this.then(t=>t,e)}finally(e){return new bt((t,r)=>{let i,s;return this.then(o=>{s=!1,i=o,e&&e()},o=>{s=!0,i=o,e&&e()}).then(()=>{if(s){r(i);return}t(i)})})}__init3(){this._resolve=e=>{this._setResult(Zn.RESOLVED,e)}}__init4(){this._reject=e=>{this._setResult(Zn.REJECTED,e)}}__init5(){this._setResult=(e,t)=>{if(this._state===Zn.PENDING){if(Mm(t)){t.then(this._resolve,this._reject);return}this._state=e,this._value=t,this._executeHandlers()}}}__init6(){this._executeHandlers=()=>{if(this._state!==Zn.PENDING){var e=this._handlers.slice();this._handlers=[],e.forEach(t=>{t[0]||(this._state===Zn.RESOLVED&&t[1](this._value),this._state===Zn.REJECTED&&t[2](this._value),t[0]=!0)})}}}}function i1(n){var e=[];function t(){return n===void 0||e.length<n}function r(o){return e.splice(e.indexOf(o),1)[0]}function i(o){if(!t())return jf(new ht("Not adding Promise because buffer limit was reached."));var a=o();return e.indexOf(a)===-1&&e.push(a),a.then(()=>r(a)).then(null,()=>r(a).then(null,()=>{})),a}function s(o){return new bt((a,c)=>{let u=e.length;if(!u)return a(!0);var l=setTimeout(()=>{o&&o>0&&a(!1)},o);e.forEach(d=>{ns(d).then(()=>{--u||(clearTimeout(l),a(!0))},c)})})}return{$:e,add:i,drain:s}}function vh(n){if(!n)return{};var e=n.match(/^(([^:/?#]+):)?(\/\/([^/?#]*))?([^?#]*)(\?([^#]*))?(#(.*))?$/);if(!e)return{};var t=e[6]||"",r=e[8]||"";return{host:e[4],path:e[5],protocol:e[2],relative:e[5]+t+r}}function gy(n){return n.split(/\\?\//).filter(e=>e.length>0&&e!==",").length}var s1=["fatal","error","warning","log","info","debug"];function o1(n){return n==="warn"?"warning":s1.includes(n)?n:"log"}var Hf={nowSeconds:()=>Date.now()/1e3};function a1(){const{performance:n}=fe();if(!(!n||!n.now)){var e=Date.now()-n.now();return{now:()=>n.now(),timeOrigin:e}}}function l1(){try{var n=Hr(module,"perf_hooks");return n.performance}catch{return}}var wh=ud()?l1():a1(),yy=wh===void 0?Hf:{nowSeconds:()=>(wh.timeOrigin+wh.now())/1e3},dd=Hf.nowSeconds.bind(Hf),hd=yy.nowSeconds.bind(yy),sl=hd,ol=(()=>{const{performance:n}=fe();if(!(!n||!n.now)){var e=3600*1e3,t=n.now(),r=Date.now(),i=n.timeOrigin?Math.abs(n.timeOrigin+t-r):e,s=i<e,o=n.timing&&n.timing.navigationStart,a=typeof o=="number",c=a?Math.abs(o+t-r):e,u=c<e;return s||u?i<=c?n.timeOrigin:o:r}})(),c1=new RegExp("^[ \\t]*([0-9a-f]{32})?-?([0-9a-f]{16})?-?([01])?[ \\t]*$");function u1(n){var e=n.match(c1);if(!n||!e)return;let t;return e[3]==="1"?t=!0:e[3]==="0"&&(t=!1),{traceId:e[1],parentSampled:t,parentSpanId:e[2]}}function fd(n,e=[]){return[n,e]}function d1(n,e){const[t,r]=n;return[t,[...r,e]]}function vy(n,e){var t=n[1];t.forEach(r=>{var i=r[0].type;e(r,i)})}function zf(n,e){var t=e||new TextEncoder;return t.encode(n)}function RS(n,e){const[t,r]=n;let i=JSON.stringify(t);function s(a){typeof i=="string"?i=typeof a=="string"?i+a:[zf(i,e),a]:i.push(typeof a=="string"?zf(a,e):a)}for(var o of r){const[a,c]=o;s(`
${JSON.stringify(a)}
`),s(typeof c=="string"||c instanceof Uint8Array?c:JSON.stringify(c))}return typeof i=="string"?i:h1(i)}function h1(n){var e=n.reduce((s,o)=>s+o.length,0),t=new Uint8Array(e);let r=0;for(var i of n)t.set(i,r),r+=i.length;return t}function f1(n,e){var t=typeof n.data=="string"?zf(n.data,e):n.data;return[ti({type:"attachment",length:t.length,filename:n.filename,content_type:n.contentType,attachment_type:n.attachmentType}),t]}var p1={session:"session",sessions:"session",attachment:"attachment",transaction:"transaction",event:"error",client_report:"internal",user_report:"default"};function wy(n){return p1[n]}function m1(n,e,t){var r=[{type:"client_report"},{timestamp:t||dd(),discarded_events:n}];return fd(e?{dsn:e}:{},[r])}var _1=60*1e3;function g1(n,e=Date.now()){var t=parseInt(`${n}`,10);if(!isNaN(t))return t*1e3;var r=Date.parse(`${n}`);return isNaN(r)?_1:r-e}function y1(n,e){return n[e]||n.all||0}function v1(n,e,t=Date.now()){return y1(n,e)>t}function w1(n,{statusCode:e,headers:t},r=Date.now()){var i={...n},s=t&&t["x-sentry-rate-limits"],o=t&&t["retry-after"];if(s)for(var a of s.trim().split(",")){const[d,p]=a.split(":",2);var c=parseInt(d,10),u=(isNaN(c)?60:c)*1e3;if(!p)i.all=r+u;else for(var l of p.split(";"))i[l]=r+u}else o?i.all=r+g1(o,r):e===429&&(i.all=r+60*1e3);return i}var Gf="baggage",CS="sentry-",b1=/^sentry-/,S1=8192;function E1(n){if(!ts(n)&&!Array.isArray(n))return;let e={};if(Array.isArray(n))e=n.reduce((r,i)=>{var s=by(i);return{...r,...s}},{});else{if(!n)return;e=by(n)}var t=Object.entries(e).reduce((r,[i,s])=>{if(i.match(b1)){var o=i.slice(CS.length);r[o]=s}return r},{});if(Object.keys(t).length>0)return t}function MS(n){var e=Object.entries(n).reduce((t,[r,i])=>(i&&(t[`${CS}${r}`]=i),t),{});return k1(e)}function by(n){return n.split(",").map(e=>e.split("=").map(t=>decodeURIComponent(t.trim()))).reduce((e,[t,r])=>(e[t]=r,e),{})}function k1(n){if(Object.keys(n).length!==0)return Object.entries(n).reduce((e,[t,r],i)=>{var s=`${encodeURIComponent(t)}=${encodeURIComponent(r)}`,o=i===0?s:`${e},${s}`;return o.length>S1?((typeof __SENTRY_DEBUG__>"u"||__SENTRY_DEBUG__)&&F.warn(`Not adding key: ${t} with val: ${r} to baggage header due to exceeding baggage size limits.`),e):o},"")}function I1(n){var e=hd(),t={sid:ni(),init:!0,timestamp:e,started:e,duration:0,status:"ok",errors:0,ignoreDuration:!1,toJSON:()=>R1(t)};return n&&so(t,n),t}function so(n,e={}){if(e.user&&(!n.ipAddress&&e.user.ip_address&&(n.ipAddress=e.user.ip_address),!n.did&&!e.did&&(n.did=e.user.id||e.user.email||e.user.username)),n.timestamp=e.timestamp||hd(),e.ignoreDuration&&(n.ignoreDuration=e.ignoreDuration),e.sid&&(n.sid=e.sid.length===32?e.sid:ni()),e.init!==void 0&&(n.init=e.init),!n.did&&e.did&&(n.did=`${e.did}`),typeof e.started=="number"&&(n.started=e.started),n.ignoreDuration)n.duration=void 0;else if(typeof e.duration=="number")n.duration=e.duration;else{var t=n.timestamp-n.started;n.duration=t>=0?t:0}e.release&&(n.release=e.release),e.environment&&(n.environment=e.environment),!n.ipAddress&&e.ipAddress&&(n.ipAddress=e.ipAddress),!n.userAgent&&e.userAgent&&(n.userAgent=e.userAgent),typeof e.errors=="number"&&(n.errors=e.errors),e.status&&(n.status=e.status)}function T1(n,e){let t={};e?t={status:e}:n.status==="ok"&&(t={status:"exited"}),so(n,t)}function R1(n){return ti({sid:`${n.sid}`,init:n.init,started:new Date(n.started*1e3).toISOString(),timestamp:new Date(n.timestamp*1e3).toISOString(),status:n.status,errors:n.errors,did:typeof n.did=="number"||typeof n.did=="string"?`${n.did}`:void 0,duration:n.duration,attrs:{release:n.release,environment:n.environment,ip_address:n.ipAddress,user_agent:n.userAgent}})}var Sy=100;class ri{constructor(){this._notifyingListeners=!1,this._scopeListeners=[],this._eventProcessors=[],this._breadcrumbs=[],this._attachments=[],this._user={},this._tags={},this._extra={},this._contexts={},this._sdkProcessingMetadata={}}static clone(e){var t=new ri;return e&&(t._breadcrumbs=[...e._breadcrumbs],t._tags={...e._tags},t._extra={...e._extra},t._contexts={...e._contexts},t._user=e._user,t._level=e._level,t._span=e._span,t._session=e._session,t._transactionName=e._transactionName,t._fingerprint=e._fingerprint,t._eventProcessors=[...e._eventProcessors],t._requestSession=e._requestSession,t._attachments=[...e._attachments]),t}addScopeListener(e){this._scopeListeners.push(e)}addEventProcessor(e){return this._eventProcessors.push(e),this}setUser(e){return this._user=e||{},this._session&&so(this._session,{user:e}),this._notifyScopeListeners(),this}getUser(){return this._user}getRequestSession(){return this._requestSession}setRequestSession(e){return this._requestSession=e,this}setTags(e){return this._tags={...this._tags,...e},this._notifyScopeListeners(),this}setTag(e,t){return this._tags={...this._tags,[e]:t},this._notifyScopeListeners(),this}setExtras(e){return this._extra={...this._extra,...e},this._notifyScopeListeners(),this}setExtra(e,t){return this._extra={...this._extra,[e]:t},this._notifyScopeListeners(),this}setFingerprint(e){return this._fingerprint=e,this._notifyScopeListeners(),this}setLevel(e){return this._level=e,this._notifyScopeListeners(),this}setTransactionName(e){return this._transactionName=e,this._notifyScopeListeners(),this}setContext(e,t){return t===null?delete this._contexts[e]:this._contexts={...this._contexts,[e]:t},this._notifyScopeListeners(),this}setSpan(e){return this._span=e,this._notifyScopeListeners(),this}getSpan(){return this._span}getTransaction(){var e=this.getSpan();return e&&e.transaction}setSession(e){return e?this._session=e:delete this._session,this._notifyScopeListeners(),this}getSession(){return this._session}update(e){if(!e)return this;if(typeof e=="function"){var t=e(this);return t instanceof ri?t:this}return e instanceof ri?(this._tags={...this._tags,...e._tags},this._extra={...this._extra,...e._extra},this._contexts={...this._contexts,...e._contexts},e._user&&Object.keys(e._user).length&&(this._user=e._user),e._level&&(this._level=e._level),e._fingerprint&&(this._fingerprint=e._fingerprint),e._requestSession&&(this._requestSession=e._requestSession)):io(e)&&(e=e,this._tags={...this._tags,...e.tags},this._extra={...this._extra,...e.extra},this._contexts={...this._contexts,...e.contexts},e.user&&(this._user=e.user),e.level&&(this._level=e.level),e.fingerprint&&(this._fingerprint=e.fingerprint),e.requestSession&&(this._requestSession=e.requestSession)),this}clear(){return this._breadcrumbs=[],this._tags={},this._extra={},this._user={},this._contexts={},this._level=void 0,this._transactionName=void 0,this._fingerprint=void 0,this._requestSession=void 0,this._span=void 0,this._session=void 0,this._notifyScopeListeners(),this._attachments=[],this}addBreadcrumb(e,t){var r=typeof t=="number"?Math.min(t,Sy):Sy;if(r<=0)return this;var i={timestamp:dd(),...e};return this._breadcrumbs=[...this._breadcrumbs,i].slice(-r),this._notifyScopeListeners(),this}clearBreadcrumbs(){return this._breadcrumbs=[],this._notifyScopeListeners(),this}addAttachment(e){return this._attachments.push(e),this}getAttachments(){return this._attachments}clearAttachments(){return this._attachments=[],this}applyToEvent(e,t={}){if(this._extra&&Object.keys(this._extra).length&&(e.extra={...this._extra,...e.extra}),this._tags&&Object.keys(this._tags).length&&(e.tags={...this._tags,...e.tags}),this._user&&Object.keys(this._user).length&&(e.user={...this._user,...e.user}),this._contexts&&Object.keys(this._contexts).length&&(e.contexts={...this._contexts,...e.contexts}),this._level&&(e.level=this._level),this._transactionName&&(e.transaction=this._transactionName),this._span){e.contexts={trace:this._span.getTraceContext(),...e.contexts};var r=this._span.transaction&&this._span.transaction.name;r&&(e.tags={transaction:r,...e.tags})}return this._applyFingerprint(e),e.breadcrumbs=[...e.breadcrumbs||[],...this._breadcrumbs],e.breadcrumbs=e.breadcrumbs.length>0?e.breadcrumbs:void 0,e.sdkProcessingMetadata={...e.sdkProcessingMetadata,...this._sdkProcessingMetadata},this._notifyEventProcessors([...xS(),...this._eventProcessors],e,t)}setSDKProcessingMetadata(e){return this._sdkProcessingMetadata={...this._sdkProcessingMetadata,...e},this}_notifyEventProcessors(e,t,r,i=0){return new bt((s,o)=>{var a=e[i];if(t===null||typeof a!="function")s(t);else{var c=a({...t},r);(typeof __SENTRY_DEBUG__>"u"||__SENTRY_DEBUG__)&&a.id&&c===null&&F.log(`Event processor "${a.id}" dropped event`),Mm(c)?c.then(u=>this._notifyEventProcessors(e,u,r,i+1).then(s)).then(null,o):this._notifyEventProcessors(e,c,r,i+1).then(s).then(null,o)}})}_notifyScopeListeners(){this._notifyingListeners||(this._notifyingListeners=!0,this._scopeListeners.forEach(e=>{e(this)}),this._notifyingListeners=!1)}_applyFingerprint(e){e.fingerprint=e.fingerprint?IS(e.fingerprint):[],this._fingerprint&&(e.fingerprint=e.fingerprint.concat(this._fingerprint)),e.fingerprint&&!e.fingerprint.length&&delete e.fingerprint}}function xS(){return Rm("globalEventProcessors",()=>[])}function Pm(n){xS().push(n)}var Om=4,C1=100;class Tl{__init(){this._stack=[{}]}constructor(e,t=new ri,r=Om){this._version=r,Tl.prototype.__init.call(this),this.getStackTop().scope=t,e&&this.bindClient(e)}isOlderThan(e){return this._version<e}bindClient(e){var t=this.getStackTop();t.client=e,e&&e.setupIntegrations&&e.setupIntegrations()}pushScope(){var e=ri.clone(this.getScope());return this.getStack().push({client:this.getClient(),scope:e}),e}popScope(){return this.getStack().length<=1?!1:!!this.getStack().pop()}withScope(e){var t=this.pushScope();try{e(t)}finally{this.popScope()}}getClient(){return this.getStackTop().client}getScope(){return this.getStackTop().scope}getStack(){return this._stack}getStackTop(){return this._stack[this._stack.length-1]}captureException(e,t){var r=this._lastEventId=t&&t.event_id?t.event_id:ni(),i=new Error("Sentry syntheticException");return this._withClient((s,o)=>{s.captureException(e,{originalException:e,syntheticException:i,...t,event_id:r},o)}),r}captureMessage(e,t,r){var i=this._lastEventId=r&&r.event_id?r.event_id:ni(),s=new Error(e);return this._withClient((o,a)=>{o.captureMessage(e,t,{originalException:e,syntheticException:s,...r,event_id:i},a)}),i}captureEvent(e,t){var r=t&&t.event_id?t.event_id:ni();return e.type!=="transaction"&&(this._lastEventId=r),this._withClient((i,s)=>{i.captureEvent(e,{...t,event_id:r},s)}),r}lastEventId(){return this._lastEventId}addBreadcrumb(e,t){const{scope:r,client:i}=this.getStackTop();if(!r||!i)return;const{beforeBreadcrumb:s=null,maxBreadcrumbs:o=C1}=i.getOptions&&i.getOptions()||{};if(!(o<=0)){var a=dd(),c={timestamp:a,...e},u=s?wS(()=>s(c,t)):c;u!==null&&r.addBreadcrumb(u,o)}}setUser(e){var t=this.getScope();t&&t.setUser(e)}setTags(e){var t=this.getScope();t&&t.setTags(e)}setExtras(e){var t=this.getScope();t&&t.setExtras(e)}setTag(e,t){var r=this.getScope();r&&r.setTag(e,t)}setExtra(e,t){var r=this.getScope();r&&r.setExtra(e,t)}setContext(e,t){var r=this.getScope();r&&r.setContext(e,t)}configureScope(e){const{scope:t,client:r}=this.getStackTop();t&&r&&e(t)}run(e){var t=Ey(this);try{e(this)}finally{Ey(t)}}getIntegration(e){var t=this.getClient();if(!t)return null;try{return t.getIntegration(e)}catch{return(typeof __SENTRY_DEBUG__>"u"||__SENTRY_DEBUG__)&&F.warn(`Cannot retrieve integration ${e.id} from the current Hub`),null}}startTransaction(e,t){return this._callExtensionMethod("startTransaction",e,t)}traceHeaders(){return this._callExtensionMethod("traceHeaders")}captureSession(e=!1){if(e)return this.endSession();this._sendSessionUpdate()}endSession(){var e=this.getStackTop(),t=e&&e.scope,r=t&&t.getSession();r&&T1(r),this._sendSessionUpdate(),t&&t.setSession()}startSession(e){const{scope:t,client:r}=this.getStackTop(),{release:i,environment:s}=r&&r.getOptions()||{};var o=fe();const{userAgent:a}=o.navigator||{};var c=I1({release:i,environment:s,...t&&{user:t.getUser()},...a&&{userAgent:a},...e});if(t){var u=t.getSession&&t.getSession();u&&u.status==="ok"&&so(u,{status:"exited"}),this.endSession(),t.setSession(c)}return c}shouldSendDefaultPii(){var e=this.getClient(),t=e&&e.getOptions();return!!(t&&t.sendDefaultPii)}_sendSessionUpdate(){const{scope:e,client:t}=this.getStackTop();if(e){var r=e.getSession();r&&t&&t.captureSession&&t.captureSession(r)}}_withClient(e){const{scope:t,client:r}=this.getStackTop();r&&e(r,t)}_callExtensionMethod(e,...t){var r=Co(),i=r.__SENTRY__;if(i&&i.extensions&&typeof i.extensions[e]=="function")return i.extensions[e].apply(this,t);(typeof __SENTRY_DEBUG__>"u"||__SENTRY_DEBUG__)&&F.warn(`Extension method ${e} couldn't be found, doing nothing.`)}}function Co(){var n=fe();return n.__SENTRY__=n.__SENTRY__||{extensions:{},hub:void 0},n}function Ey(n){var e=Co(),t=$r(e);return Um(e,n),t}function Oe(){var n=Co();return(!AS(n)||$r(n).isOlderThan(Om))&&Um(n,new Tl),ud()?M1(n):$r(n)}function M1(n){try{var e=Co().__SENTRY__,t=e&&e.extensions&&e.extensions.domain&&e.extensions.domain.active;if(!t)return $r(n);if(!AS(t)||$r(t).isOlderThan(Om)){var r=$r(n).getStackTop();Um(t,new Tl(r.client,ri.clone(r.scope)))}return $r(t)}catch{return $r(n)}}function AS(n){return!!(n&&n.__SENTRY__&&n.__SENTRY__.hub)}function $r(n){return Rm("hub",()=>new Tl,n)}function Um(n,e){if(!n)return!1;var t=n.__SENTRY__=n.__SENTRY__||{};return t.hub=e,!0}function x1(n,e){return Oe().captureException(n,{captureContext:e})}function A1(n){Oe().withScope(n)}var D1="7";function N1(n){var e=n.protocol?`${n.protocol}:`:"",t=n.port?`:${n.port}`:"";return`${e}//${n.host}${t}${n.path?`/${n.path}`:""}/api/`}function P1(n){return`${N1(n)}${n.projectId}/envelope/`}function O1(n,e){return NR({sentry_key:n.publicKey,sentry_version:D1,...e&&{sentry_client:`${e.name}/${e.version}`}})}function DS(n,e={}){var t=typeof e=="string"?e:e.tunnel,r=typeof e=="string"||!e._metadata?void 0:e._metadata.sdk;return t||`${P1(n)}?${O1(n,r)}`}function NS(n){if(!n||!n.sdk)return;const{name:e,version:t}=n.sdk;return{name:e,version:t}}function U1(n,e){return e&&(n.sdk=n.sdk||{},n.sdk.name=n.sdk.name||e.name,n.sdk.version=n.sdk.version||e.version,n.sdk.integrations=[...n.sdk.integrations||[],...e.integrations||[]],n.sdk.packages=[...n.sdk.packages||[],...e.packages||[]]),n}function $1(n,e,t,r){var i=NS(t),s={sent_at:new Date().toISOString(),...i&&{sdk:i},...!!r&&{dsn:xm(e)}},o="aggregates"in n?[{type:"sessions"},n]:[{type:"session"},n];return fd(s,[o])}function L1(n,e,t,r){var i=NS(t),s=n.type||"event";const{transactionSampling:o}=n.sdkProcessingMetadata||{},{method:a,rate:c}=o||{};U1(n,t&&t.sdk);var u=F1(n,i,r,e);delete n.sdkProcessingMetadata;var l=[{type:s,sample_rates:[{id:a,rate:c}]},n];return fd(u,[l])}function F1(n,e,t,r){var i=n.sdkProcessingMetadata&&n.sdkProcessingMetadata.dynamicSamplingContext;return{event_id:n.event_id,sent_at:new Date().toISOString(),...e&&{sdk:e},...!!t&&{dsn:xm(r)},...n.type==="transaction"&&i&&{trace:ti({...i})}}}var ky=[];function B1(n){var e={};return n.forEach(t=>{const{name:r}=t;var i=e[r];i&&!i.isDefaultInstance&&t.isDefaultInstance||(e[r]=t)}),Object.values(e)}function V1(n){var e=n.defaultIntegrations||[],t=n.integrations;e.forEach(o=>{o.isDefaultInstance=!0});let r;Array.isArray(t)?r=[...e,...t]:typeof t=="function"?r=IS(t(e)):r=e;var i=B1(r),s=i.findIndex(o=>o.name==="Debug");if(s!==-1){const[o]=i.splice(s,1);i.push(o)}return i}function K1(n){var e={};return n.forEach(t=>{e[t.name]=t,ky.indexOf(t.name)===-1&&(t.setupOnce(Pm,Oe),ky.push(t.name),(typeof __SENTRY_DEBUG__>"u"||__SENTRY_DEBUG__)&&F.log(`Integration installed: ${t.name}`))}),e}var Iy="Not capturing exception because it's already been captured.";class Cs{__init(){this._integrations={}}__init2(){this._integrationsInitialized=!1}__init3(){this._numProcessing=0}__init4(){this._outcomes={}}constructor(e){if(Cs.prototype.__init.call(this),Cs.prototype.__init2.call(this),Cs.prototype.__init3.call(this),Cs.prototype.__init4.call(this),this._options=e,e.dsn){this._dsn=xR(e.dsn);var t=DS(this._dsn,e);this._transport=e.transport({recordDroppedEvent:this.recordDroppedEvent.bind(this),...e.transportOptions,url:t})}else(typeof __SENTRY_DEBUG__>"u"||__SENTRY_DEBUG__)&&F.warn("No DSN provided, client will not do anything.")}captureException(e,t,r){if(_y(e)){(typeof __SENTRY_DEBUG__>"u"||__SENTRY_DEBUG__)&&F.log(Iy);return}let i=t&&t.event_id;return this._process(this.eventFromException(e,t).then(s=>this._captureEvent(s,t,r)).then(s=>{i=s})),i}captureMessage(e,t,r,i){let s=r&&r.event_id;var o=gS(e)?this.eventFromMessage(String(e),t,r):this.eventFromException(e,r);return this._process(o.then(a=>this._captureEvent(a,r,i)).then(a=>{s=a})),s}captureEvent(e,t,r){if(t&&t.originalException&&_y(t.originalException)){(typeof __SENTRY_DEBUG__>"u"||__SENTRY_DEBUG__)&&F.log(Iy);return}let i=t&&t.event_id;return this._process(this._captureEvent(e,t,r).then(s=>{i=s})),i}captureSession(e){if(!this._isEnabled()){(typeof __SENTRY_DEBUG__>"u"||__SENTRY_DEBUG__)&&F.warn("SDK not enabled, will not capture session.");return}typeof e.release!="string"?(typeof __SENTRY_DEBUG__>"u"||__SENTRY_DEBUG__)&&F.warn("Discarded session because of missing or non-string release"):(this.sendSession(e),so(e,{init:!1}))}getDsn(){return this._dsn}getOptions(){return this._options}getTransport(){return this._transport}flush(e){var t=this._transport;return t?this._isClientDoneProcessing(e).then(r=>t.flush(e).then(i=>r&&i)):ns(!0)}close(e){return this.flush(e).then(t=>(this.getOptions().enabled=!1,t))}setupIntegrations(){this._isEnabled()&&!this._integrationsInitialized&&(this._integrations=K1(this._options.integrations),this._integrationsInitialized=!0)}getIntegrationById(e){return this._integrations[e]}getIntegration(e){try{return this._integrations[e.id]||null}catch{return(typeof __SENTRY_DEBUG__>"u"||__SENTRY_DEBUG__)&&F.warn(`Cannot retrieve integration ${e.id} from the current Client`),null}}sendEvent(e,t={}){if(this._dsn){let i=L1(e,this._dsn,this._options._metadata,this._options.tunnel);for(var r of t.attachments||[])i=d1(i,f1(r,this._options.transportOptions&&this._options.transportOptions.textEncoder));this._sendEnvelope(i)}}sendSession(e){if(this._dsn){var t=$1(e,this._dsn,this._options._metadata,this._options.tunnel);this._sendEnvelope(t)}}recordDroppedEvent(e,t){if(this._options.sendClientReports){var r=`${e}:${t}`;(typeof __SENTRY_DEBUG__>"u"||__SENTRY_DEBUG__)&&F.log(`Adding outcome: "${r}"`),this._outcomes[r]=this._outcomes[r]+1||1}}_updateSessionFromEvent(e,t){let r=!1,i=!1;var s=t.exception&&t.exception.values;if(s){i=!0;for(var o of s){var a=o.mechanism;if(a&&a.handled===!1){r=!0;break}}}var c=e.status==="ok",u=c&&e.errors===0||c&&r;u&&(so(e,{...r&&{status:"crashed"},errors:e.errors||Number(i||r)}),this.captureSession(e))}_isClientDoneProcessing(e){return new bt(t=>{let r=0;var i=1,s=setInterval(()=>{this._numProcessing==0?(clearInterval(s),t(!0)):(r+=i,e&&r>=e&&(clearInterval(s),t(!1)))},i)})}_isEnabled(){return this.getOptions().enabled!==!1&&this._dsn!==void 0}_prepareEvent(e,t,r){const{normalizeDepth:i=3,normalizeMaxBreadth:s=1e3}=this.getOptions();var o={...e,event_id:e.event_id||t.event_id||ni(),timestamp:e.timestamp||dd()};this._applyClientOptions(o),this._applyIntegrationsMetadata(o);let a=r;t.captureContext&&(a=ri.clone(a).update(t.captureContext));let c=ns(o);if(a){var u=[...t.attachments||[],...a.getAttachments()];u.length&&(t.attachments=u),c=a.applyToEvent(o,t)}return c.then(l=>typeof i=="number"&&i>0?this._normalizeEvent(l,i,s):l)}_normalizeEvent(e,t,r){if(!e)return null;var i={...e,...e.breadcrumbs&&{breadcrumbs:e.breadcrumbs.map(s=>({...s,...s.data&&{data:Ai(s.data,t,r)}}))},...e.user&&{user:Ai(e.user,t,r)},...e.contexts&&{contexts:Ai(e.contexts,t,r)},...e.extra&&{extra:Ai(e.extra,t,r)}};return e.contexts&&e.contexts.trace&&i.contexts&&(i.contexts.trace=e.contexts.trace,e.contexts.trace.data&&(i.contexts.trace.data=Ai(e.contexts.trace.data,t,r))),e.spans&&(i.spans=e.spans.map(s=>(s.data&&(s.data=Ai(s.data,t,r)),s))),i}_applyClientOptions(e){var t=this.getOptions();const{environment:r,release:i,dist:s,maxValueLength:o=250}=t;"environment"in e||(e.environment="environment"in t?r:"production"),e.release===void 0&&i!==void 0&&(e.release=i),e.dist===void 0&&s!==void 0&&(e.dist=s),e.message&&(e.message=Oa(e.message,o));var a=e.exception&&e.exception.values&&e.exception.values[0];a&&a.value&&(a.value=Oa(a.value,o));var c=e.request;c&&c.url&&(c.url=Oa(c.url,o))}_applyIntegrationsMetadata(e){var t=Object.keys(this._integrations);t.length>0&&(e.sdk=e.sdk||{},e.sdk.integrations=[...e.sdk.integrations||[],...t])}_captureEvent(e,t={},r){return this._processEvent(e,t,r).then(i=>i.event_id,i=>{if(typeof __SENTRY_DEBUG__>"u"||__SENTRY_DEBUG__){var s=i;s.logLevel==="log"?F.log(s.message):F.warn(s)}})}_processEvent(e,t,r){const{beforeSend:i,sampleRate:s}=this.getOptions();if(!this._isEnabled())return jf(new ht("SDK not enabled, will not capture event.","log"));var o=e.type==="transaction";return!o&&typeof s=="number"&&Math.random()>s?(this.recordDroppedEvent("sample_rate","error"),jf(new ht(`Discarding event because it's not included in the random sample (sampling rate = ${s})`,"log"))):this._prepareEvent(e,t,r).then(a=>{if(a===null)throw this.recordDroppedEvent("event_processor",e.type||"error"),new ht("An event processor returned null, will not send event.","log");var c=t.data&&t.data.__sentry__===!0;if(c||o||!i)return a;var u=i(a,t);return j1(u)}).then(a=>{if(a===null)throw this.recordDroppedEvent("before_send",e.type||"error"),new ht("`beforeSend` returned `null`, will not send event.","log");var c=r&&r.getSession();!o&&c&&this._updateSessionFromEvent(c,a);var u=a.transaction_info;if(o&&u&&a.transaction!==e.transaction){var l="custom";a.transaction_info={...u,source:l,changes:[...u.changes,{source:l,timestamp:a.timestamp,propagations:u.propagations}]}}return this.sendEvent(a,t),a}).then(null,a=>{throw a instanceof ht?a:(this.captureException(a,{data:{__sentry__:!0},originalException:a}),new ht(`Event processing pipeline threw an error, original event will not be sent. Details have been sent as a new event.
Reason: ${a}`))})}_process(e){this._numProcessing+=1,e.then(t=>(this._numProcessing-=1,t),t=>(this._numProcessing-=1,t))}_sendEnvelope(e){this._transport&&this._dsn?this._transport.send(e).then(null,t=>{(typeof __SENTRY_DEBUG__>"u"||__SENTRY_DEBUG__)&&F.error("Error while sending event:",t)}):(typeof __SENTRY_DEBUG__>"u"||__SENTRY_DEBUG__)&&F.error("Transport disabled")}_clearOutcomes(){var e=this._outcomes;return this._outcomes={},Object.keys(e).map(t=>{const[r,i]=t.split(":");return{reason:r,category:i,quantity:e[t]}})}}function j1(n){var e="`beforeSend` method has to return `null` or a valid event.";if(Mm(n))return n.then(t=>{if(!(io(t)||t===null))throw new ht(e);return t},t=>{throw new ht(`beforeSend rejected with ${t}`)});if(!(io(n)||n===null))throw new ht(e);return n}function H1(n,e){e.debug===!0&&(typeof __SENTRY_DEBUG__>"u"||__SENTRY_DEBUG__?F.enable():console.warn("[Sentry] Cannot initialize SDK with `debug` option using a non-debug bundle."));var t=Oe(),r=t.getScope();r&&r.update(e.initialScope);var i=new n(e);t.bindClient(i)}var z1=30;function PS(n,e,t=i1(n.bufferSize||z1)){let r={};var i=o=>t.drain(o);function s(o){var a=[];if(vy(o,(d,p)=>{var m=wy(p);v1(r,m)?n.recordDroppedEvent("ratelimit_backoff",m):a.push(d)}),a.length===0)return ns();var c=fd(o[0],a),u=d=>{vy(c,(p,m)=>{n.recordDroppedEvent(d,wy(m))})},l=()=>e({body:RS(c,n.textEncoder)}).then(d=>{d.statusCode!==void 0&&(d.statusCode<200||d.statusCode>=300)&&(typeof __SENTRY_DEBUG__>"u"||__SENTRY_DEBUG__)&&F.warn(`Sentry responded with status code ${d.statusCode} to sent event.`),r=w1(r,d)},d=>{(typeof __SENTRY_DEBUG__>"u"||__SENTRY_DEBUG__)&&F.error("Failed while sending event:",d),u("network_error")});return t.add(l).then(d=>d,d=>{if(d instanceof ht)return(typeof __SENTRY_DEBUG__>"u"||__SENTRY_DEBUG__)&&F.error("Skipped sending event because buffer is full."),u("queue_overflow"),ns();throw d})}return{send:s,flush:i}}var ku="7.13.0";let Ty;class al{constructor(){al.prototype.__init.call(this)}static __initStatic(){this.id="FunctionToString"}__init(){this.name=al.id}setupOnce(){Ty=Function.prototype.toString,Function.prototype.toString=function(...e){var t=Dm(this)||this;return Ty.apply(t,e)}}}al.__initStatic();var G1=[/^Script error\.?$/,/^Javascript error: Script error\.? on line 0$/];class Ks{static __initStatic(){this.id="InboundFilters"}__init(){this.name=Ks.id}constructor(e={}){this._options=e,Ks.prototype.__init.call(this)}setupOnce(e,t){var r=i=>{var s=t();if(s){var o=s.getIntegration(Ks);if(o){var a=s.getClient(),c=a?a.getOptions():{},u=q1(o._options,c);return W1(i,u)?null:i}}return i};r.id=this.name,e(r)}}Ks.__initStatic();function q1(n={},e={}){return{allowUrls:[...n.allowUrls||[],...e.allowUrls||[]],denyUrls:[...n.denyUrls||[],...e.denyUrls||[]],ignoreErrors:[...n.ignoreErrors||[],...e.ignoreErrors||[],...G1],ignoreInternal:n.ignoreInternal!==void 0?n.ignoreInternal:!0}}function W1(n,e){return e.ignoreInternal&&Z1(n)?((typeof __SENTRY_DEBUG__>"u"||__SENTRY_DEBUG__)&&F.warn(`Event dropped due to being internal Sentry Error.
Event: ${Bi(n)}`),!0):Y1(n,e.ignoreErrors)?((typeof __SENTRY_DEBUG__>"u"||__SENTRY_DEBUG__)&&F.warn(`Event dropped due to being matched by \`ignoreErrors\` option.
Event: ${Bi(n)}`),!0):X1(n,e.denyUrls)?((typeof __SENTRY_DEBUG__>"u"||__SENTRY_DEBUG__)&&F.warn(`Event dropped due to being matched by \`denyUrls\` option.
Event: ${Bi(n)}.
Url: ${Iu(n)}`),!0):J1(n,e.allowUrls)?!1:((typeof __SENTRY_DEBUG__>"u"||__SENTRY_DEBUG__)&&F.warn(`Event dropped due to not being matched by \`allowUrls\` option.
Event: ${Bi(n)}.
Url: ${Iu(n)}`),!0)}function Y1(n,e){return!e||!e.length?!1:Q1(n).some(t=>e.some(r=>rl(t,r)))}function X1(n,e){if(!e||!e.length)return!1;var t=Iu(n);return t?e.some(r=>rl(t,r)):!1}function J1(n,e){if(!e||!e.length)return!0;var t=Iu(n);return t?e.some(r=>rl(t,r)):!0}function Q1(n){if(n.message)return[n.message];if(n.exception)try{const{type:e="",value:t=""}=n.exception.values&&n.exception.values[0]||{};return[`${t}`,`${e}: ${t}`]}catch{return(typeof __SENTRY_DEBUG__>"u"||__SENTRY_DEBUG__)&&F.error(`Cannot extract message for event ${Bi(n)}`),[]}return[]}function Z1(n){try{return n.exception.values[0].type==="SentryError"}catch{}return!1}function eC(n=[]){for(let t=n.length-1;t>=0;t--){var e=n[t];if(e&&e.filename!=="<anonymous>"&&e.filename!=="[native code]")return e.filename||null}return null}function Iu(n){try{let e;try{e=n.exception.values[0].stacktrace.frames}catch{}return e?eC(e):null}catch{return(typeof __SENTRY_DEBUG__>"u"||__SENTRY_DEBUG__)&&F.error(`Cannot extract url for event ${Bi(n)}`),null}}function OS(n,e){var t=$m(n,e),r={type:e&&e.name,value:iC(e)};return t.length&&(r.stacktrace={frames:t}),r.type===void 0&&r.value===""&&(r.value="Unrecoverable error caught"),r}function tC(n,e,t,r){var i=Oe(),s=i.getClient(),o=s&&s.getOptions().normalizeDepth,a={exception:{values:[{type:Cm(e)?e.constructor.name:r?"UnhandledRejection":"Error",value:`Non-Error ${r?"promise rejection":"exception"} captured with keys: ${PR(e)}`}]},extra:{__serialized__:TS(e,o)}};if(t){var c=$m(n,t);c.length&&(a.exception.values[0].stacktrace={frames:c})}return a}function bh(n,e){return{exception:{values:[OS(n,e)]}}}function $m(n,e){var t=e.stacktrace||e.stack||"",r=rC(e);try{return n(t,r)}catch{}return[]}var nC=/Minified React error #\d+;/i;function rC(n){if(n){if(typeof n.framesToPop=="number")return n.framesToPop;if(nC.test(n.message))return 1}return 0}function iC(n){var e=n&&n.message;return e?e.error&&typeof e.error.message=="string"?e.error.message:e:"No error message"}function sC(n,e,t,r){var i=t&&t.syntheticException||void 0,s=Lm(n,e,i,r);return il(s),s.level="error",t&&t.event_id&&(s.event_id=t.event_id),ns(s)}function oC(n,e,t="info",r,i){var s=r&&r.syntheticException||void 0,o=qf(n,e,s,i);return o.level=t,r&&r.event_id&&(o.event_id=r.event_id),ns(o)}function Lm(n,e,t,r,i){let s;if(_S(e)&&e.error){var o=e;return bh(n,o.error)}if(cy(e)||vR(e)){var a=e;if("stack"in e)s=bh(n,e);else{var c=a.name||(cy(a)?"DOMError":"DOMException"),u=a.message?`${c}: ${a.message}`:c;s=qf(n,u,t,r),Vf(s,u)}return"code"in a&&(s.tags={...s.tags,"DOMException.code":`${a.code}`}),s}if(mS(e))return bh(n,e);if(io(e)||Cm(e)){var l=e;return s=tC(n,l,t,i),il(s,{synthetic:!0}),s}return s=qf(n,e,t,r),Vf(s,`${e}`,void 0),il(s,{synthetic:!0}),s}function qf(n,e,t,r){var i={message:e};if(r&&t){var s=$m(n,t);s.length&&(i.exception={values:[{value:e,stacktrace:{frames:s}}]})}return i}var US="Breadcrumbs";class ll{static __initStatic(){this.id=US}__init(){this.name=ll.id}constructor(e){ll.prototype.__init.call(this),this.options={console:!0,dom:!0,fetch:!0,history:!0,sentry:!0,xhr:!0,...e}}setupOnce(){this.options.console&&Kt("console",lC),this.options.dom&&Kt("dom",aC(this.options.dom)),this.options.xhr&&Kt("xhr",cC),this.options.fetch&&Kt("fetch",uC),this.options.history&&Kt("history",dC)}}ll.__initStatic();function aC(n){function e(t){let r,i=typeof n=="object"?n.serializeAttribute:void 0;typeof i=="string"&&(i=[i]);try{r=t.event.target?nl(t.event.target,i):nl(t.event,i)}catch{r="<unknown>"}r.length!==0&&Oe().addBreadcrumb({category:`ui.${t.name}`,message:r},{event:t.event,name:t.name,global:t.global})}return e}function lC(n){var e={category:"console",data:{arguments:n.args,logger:"console"},level:o1(n.level),message:dy(n.args," ")};if(n.level==="assert")if(n.args[0]===!1)e.message=`Assertion failed: ${dy(n.args.slice(1)," ")||"console.assert"}`,e.data.arguments=n.args.slice(1);else return;Oe().addBreadcrumb(e,{input:n.args,level:n.level})}function cC(n){if(n.endTimestamp){if(n.xhr.__sentry_own_request__)return;const{method:e,url:t,status_code:r,body:i}=n.xhr.__sentry_xhr__||{};Oe().addBreadcrumb({category:"xhr",data:{method:e,url:t,status_code:r},type:"http"},{xhr:n.xhr,input:i});return}}function uC(n){n.endTimestamp&&(n.fetchData.url.match(/sentry_key/)&&n.fetchData.method==="POST"||(n.error?Oe().addBreadcrumb({category:"fetch",data:n.fetchData,level:"error",type:"http"},{data:n.error,input:n.args}):Oe().addBreadcrumb({category:"fetch",data:{...n.fetchData,status_code:n.response.status},type:"http"},{input:n.args,response:n.response})))}function dC(n){var e=fe();let t=n.from,r=n.to;var i=vh(e.location.href);let s=vh(t);var o=vh(r);s.path||(s=i),i.protocol===o.protocol&&i.host===o.host&&(r=o.relative),i.protocol===s.protocol&&i.host===s.host&&(t=s.relative),Oe().addBreadcrumb({category:"navigation",data:{from:t,to:r}})}var _n=fe();let Ql;function $S(){if(Ql)return Ql;if(Bf(_n.fetch))return Ql=_n.fetch.bind(_n);var n=_n.document;let e=_n.fetch;if(n&&typeof n.createElement=="function")try{var t=n.createElement("iframe");t.hidden=!0,n.head.appendChild(t);var r=t.contentWindow;r&&r.fetch&&(e=r.fetch),n.head.removeChild(t)}catch(i){(typeof __SENTRY_DEBUG__>"u"||__SENTRY_DEBUG__)&&F.warn("Could not create sandbox iframe for pure fetch check, bailing to window.fetch: ",i)}return Ql=e.bind(_n)}function hC(n,e){var t=Object.prototype.toString.call(_n&&_n.navigator)==="[object Navigator]",r=t&&typeof _n.navigator.sendBeacon=="function";if(r){var i=_n.navigator.sendBeacon.bind(_n.navigator);i(n,e)}else if(Nm()){var s=$S();s(n,{body:e,method:"POST",credentials:"omit",keepalive:!0}).then(null,o=>{(typeof __SENTRY_DEBUG__>"u"||__SENTRY_DEBUG__)&&F.error(o)})}}var Sh=fe();class fC extends Cs{constructor(e){e._metadata=e._metadata||{},e._metadata.sdk=e._metadata.sdk||{name:"sentry.javascript.browser",packages:[{name:"npm:@sentry/browser",version:ku}],version:ku},super(e),e.sendClientReports&&Sh.document&&Sh.document.addEventListener("visibilitychange",()=>{Sh.document.visibilityState==="hidden"&&this._flushOutcomes()})}eventFromException(e,t){return sC(this._options.stackParser,e,t,this._options.attachStacktrace)}eventFromMessage(e,t="info",r){return oC(this._options.stackParser,e,t,r,this._options.attachStacktrace)}sendEvent(e,t){var r=this.getIntegrationById(US);r&&r.options&&r.options.sentry&&Oe().addBreadcrumb({category:`sentry.${e.type==="transaction"?"transaction":"event"}`,event_id:e.event_id,level:e.level,message:Bi(e)},{event:e}),super.sendEvent(e,t)}_prepareEvent(e,t,r){return e.platform=e.platform||"javascript",super._prepareEvent(e,t,r)}_flushOutcomes(){var e=this._clearOutcomes();if(e.length===0){(typeof __SENTRY_DEBUG__>"u"||__SENTRY_DEBUG__)&&F.log("No outcomes to send");return}if(!this._dsn){(typeof __SENTRY_DEBUG__>"u"||__SENTRY_DEBUG__)&&F.log("No dsn provided, will not send outcomes");return}(typeof __SENTRY_DEBUG__>"u"||__SENTRY_DEBUG__)&&F.log("Sending outcomes:",e);var t=DS(this._dsn,this._options),r=m1(e,this._options.tunnel&&xm(this._dsn));try{hC(t,RS(r))}catch(i){(typeof __SENTRY_DEBUG__>"u"||__SENTRY_DEBUG__)&&F.error(i)}}}function pC(n,e=$S()){function t(r){var i={body:r.body,method:"POST",referrerPolicy:"origin",headers:n.headers,keepalive:r.body.length<=65536,...n.fetchOptions};return e(n.url,i).then(s=>({statusCode:s.status,headers:{"x-sentry-rate-limits":s.headers.get("X-Sentry-Rate-Limits"),"retry-after":s.headers.get("Retry-After")}}))}return PS(n,t)}var mC=4;function _C(n){function e(t){return new bt((r,i)=>{var s=new XMLHttpRequest;s.onerror=i,s.onreadystatechange=()=>{s.readyState===mC&&r({statusCode:s.status,headers:{"x-sentry-rate-limits":s.getResponseHeader("X-Sentry-Rate-Limits"),"retry-after":s.getResponseHeader("Retry-After")}})},s.open("POST",n.url);for(var o in n.headers)Object.prototype.hasOwnProperty.call(n.headers,o)&&s.setRequestHeader(o,n.headers[o]);s.send(t.body)})}return PS(n,e)}var pd="?",gC=30,yC=40,vC=50;function Fm(n,e,t,r){var i={filename:n,function:e,in_app:!0};return t!==void 0&&(i.lineno=t),r!==void 0&&(i.colno=r),i}var wC=/^\s*at (?:(.*\).*?|.*?) ?\((?:address at )?)?((?:file|https?|blob|chrome-extension|address|native|eval|webpack|<anonymous>|[-a-z]+:|.*bundle|\/)?.*?)(?::(\d+))?(?::(\d+))?\)?\s*$/i,bC=/\((\S*)(?::(\d+))(?::(\d+))\)/,SC=n=>{var e=wC.exec(n);if(e){var t=e[2]&&e[2].indexOf("eval")===0;if(t){var r=bC.exec(e[2]);r&&(e[2]=r[1],e[3]=r[2],e[4]=r[3])}const[i,s]=LS(e[1]||pd,e[2]);return Fm(s,i,e[3]?+e[3]:void 0,e[4]?+e[4]:void 0)}},EC=[gC,SC],kC=/^\s*(.*?)(?:\((.*?)\))?(?:^|@)?((?:file|https?|blob|chrome|webpack|resource|moz-extension|safari-extension|safari-web-extension|capacitor)?:\/.*?|\[native code\]|[^@]*(?:bundle|\d+\.js)|\/[\w\-. /=]+)(?::(\d+))?(?::(\d+))?\s*$/i,IC=/(\S+) line (\d+)(?: > eval line \d+)* > eval/i,TC=n=>{var e=kC.exec(n);if(e){var t=e[3]&&e[3].indexOf(" > eval")>-1;if(t){var r=IC.exec(e[3]);r&&(e[1]=e[1]||"eval",e[3]=r[1],e[4]=r[2],e[5]="")}let i=e[3],s=e[1]||pd;return[s,i]=LS(s,i),Fm(i,s,e[4]?+e[4]:void 0,e[5]?+e[5]:void 0)}},RC=[vC,TC],CC=/^\s*at (?:((?:\[object object\])?.+) )?\(?((?:file|ms-appx|https?|webpack|blob):.*?):(\d+)(?::(\d+))?\)?\s*$/i,MC=n=>{var e=CC.exec(n);return e?Fm(e[2],e[1]||pd,+e[3],e[4]?+e[4]:void 0):void 0},xC=[yC,MC],AC=[EC,RC,xC],DC=ES(...AC),LS=(n,e)=>{var t=n.indexOf("safari-extension")!==-1,r=n.indexOf("safari-web-extension")!==-1;return t||r?[n.indexOf("@")!==-1?n.split("@")[0]:pd,t?`safari-extension:${e}`:`safari-web-extension:${e}`]:[n,e]};let Wf=0;function FS(){return Wf>0}function NC(){Wf+=1,setTimeout(()=>{Wf-=1})}function oo(n,e={},t){if(typeof n!="function")return n;try{var r=n.__sentry_wrapped__;if(r)return r;if(Dm(n))return n}catch{return n}var i=function(){var a=Array.prototype.slice.call(arguments);try{t&&typeof t=="function"&&t.apply(this,arguments);var c=a.map(u=>oo(u,e));return n.apply(this,c)}catch(u){throw NC(),A1(l=>{l.addEventProcessor(d=>(e.mechanism&&(Vf(d,void 0,void 0),il(d,e.mechanism)),d.extra={...d.extra,arguments:a},d)),x1(u)}),u}};try{for(var s in n)Object.prototype.hasOwnProperty.call(n,s)&&(i[s]=n[s])}catch{}bS(i,n),Am(n,"__sentry_wrapped__",i);try{var o=Object.getOwnPropertyDescriptor(i,"name");o.configurable&&Object.defineProperty(i,"name",{get(){return n.name}})}catch{}return i}class ii{static __initStatic(){this.id="GlobalHandlers"}__init(){this.name=ii.id}__init2(){this._installFunc={onerror:PC,onunhandledrejection:OC}}constructor(e){ii.prototype.__init.call(this),ii.prototype.__init2.call(this),this._options={onerror:!0,onunhandledrejection:!0,...e}}setupOnce(){Error.stackTraceLimit=50;var e=this._options;for(var t in e){var r=this._installFunc[t];r&&e[t]&&(LC(t),r(),this._installFunc[t]=void 0)}}}ii.__initStatic();function PC(){Kt("error",n=>{const[e,t,r]=KS();if(!e.getIntegration(ii))return;const{msg:i,url:s,line:o,column:a,error:c}=n;if(!(FS()||c&&c.__sentry_own_request__)){var u=c===void 0&&ts(i)?$C(i,s,o,a):BS(Lm(t,c||i,void 0,r,!1),s,o,a);u.level="error",VS(e,c,u,"onerror")}})}function OC(){Kt("unhandledrejection",n=>{const[e,t,r]=KS();if(!e.getIntegration(ii))return;let i=n;try{"reason"in n?i=n.reason:"detail"in n&&"reason"in n.detail&&(i=n.detail.reason)}catch{}if(FS()||i&&i.__sentry_own_request__)return!0;var s=gS(i)?UC(i):Lm(t,i,void 0,r,!0);s.level="error",VS(e,i,s,"onunhandledrejection")})}function UC(n){return{exception:{values:[{type:"UnhandledRejection",value:`Non-Error promise rejection captured with value: ${String(n)}`}]}}}function $C(n,e,t,r){var i=/^(?:[Uu]ncaught (?:exception: )?)?(?:((?:Eval|Internal|Range|Reference|Syntax|Type|URI|)Error): )?(.*)$/i;let s=_S(n)?n.message:n,o="Error";var a=s.match(i);a&&(o=a[1],s=a[2]);var c={exception:{values:[{type:o,value:s}]}};return BS(c,e,t,r)}function BS(n,e,t,r){var i=n.exception=n.exception||{},s=i.values=i.values||[],o=s[0]=s[0]||{},a=o.stacktrace=o.stacktrace||{},c=a.frames=a.frames||[],u=isNaN(parseInt(r,10))?void 0:r,l=isNaN(parseInt(t,10))?void 0:t,d=ts(e)&&e.length>0?e:kR();return c.length===0&&c.push({colno:u,filename:d,function:"?",in_app:!0,lineno:l}),n}function LC(n){(typeof __SENTRY_DEBUG__>"u"||__SENTRY_DEBUG__)&&F.log(`Global Handler attached: ${n}`)}function VS(n,e,t,r){il(t,{handled:!1,type:r}),n.captureEvent(t,{originalException:e})}function KS(){var n=Oe(),e=n.getClient(),t=e&&e.getOptions()||{stackParser:()=>[],attachStacktrace:!1};return[n,t.stackParser,t.attachStacktrace]}var FC=["EventTarget","Window","Node","ApplicationCache","AudioTrackList","ChannelMergerNode","CryptoOperation","EventSource","FileReader","HTMLUnknownElement","IDBDatabase","IDBRequest","IDBTransaction","KeyOperation","MediaController","MessagePort","ModalWindow","Notification","SVGElementInstance","Screen","TextTrack","TextTrackCue","TextTrackList","WebSocket","WebSocketWorker","Worker","XMLHttpRequest","XMLHttpRequestEventTarget","XMLHttpRequestUpload"];class cl{static __initStatic(){this.id="TryCatch"}__init(){this.name=cl.id}constructor(e){cl.prototype.__init.call(this),this._options={XMLHttpRequest:!0,eventTarget:!0,requestAnimationFrame:!0,setInterval:!0,setTimeout:!0,...e}}setupOnce(){var e=fe();this._options.setTimeout&&pt(e,"setTimeout",Ry),this._options.setInterval&&pt(e,"setInterval",Ry),this._options.requestAnimationFrame&&pt(e,"requestAnimationFrame",BC),this._options.XMLHttpRequest&&"XMLHttpRequest"in e&&pt(XMLHttpRequest.prototype,"send",VC);var t=this._options.eventTarget;if(t){var r=Array.isArray(t)?t:FC;r.forEach(KC)}}}cl.__initStatic();function Ry(n){return function(...e){var t=e[0];return e[0]=oo(t,{mechanism:{data:{function:hi(n)},handled:!0,type:"instrument"}}),n.apply(this,e)}}function BC(n){return function(e){return n.apply(this,[oo(e,{mechanism:{data:{function:"requestAnimationFrame",handler:hi(n)},handled:!0,type:"instrument"}})])}}function VC(n){return function(...e){var t=this,r=["onload","onerror","onprogress","onreadystatechange"];return r.forEach(i=>{i in t&&typeof t[i]=="function"&&pt(t,i,function(s){var o={mechanism:{data:{function:i,handler:hi(s)},handled:!0,type:"instrument"}},a=Dm(s);return a&&(o.mechanism.data.handler=hi(a)),oo(s,o)})}),n.apply(this,e)}}function KC(n){var e=fe(),t=e[n]&&e[n].prototype;!t||!t.hasOwnProperty||!t.hasOwnProperty("addEventListener")||(pt(t,"addEventListener",function(r){return function(i,s,o){try{typeof s.handleEvent=="function"&&(s.handleEvent=oo(s.handleEvent,{mechanism:{data:{function:"handleEvent",handler:hi(s),target:n},handled:!0,type:"instrument"}}))}catch{}return r.apply(this,[i,oo(s,{mechanism:{data:{function:"addEventListener",handler:hi(s),target:n},handled:!0,type:"instrument"}}),o])}}),pt(t,"removeEventListener",function(r){return function(i,s,o){var a=s;try{var c=a&&a.__sentry_wrapped__;c&&r.call(this,i,c,o)}catch{}return r.call(this,i,a,o)}}))}var jC="cause",HC=5;class js{static __initStatic(){this.id="LinkedErrors"}__init(){this.name=js.id}constructor(e={}){js.prototype.__init.call(this),this._key=e.key||jC,this._limit=e.limit||HC}setupOnce(){var e=Oe().getClient();e&&Pm((t,r)=>{var i=Oe().getIntegration(js);return i?zC(e.getOptions().stackParser,i._key,i._limit,t,r):t})}}js.__initStatic();function zC(n,e,t,r,i){if(!r.exception||!r.exception.values||!i||!Bn(i.originalException,Error))return r;var s=jS(n,t,i.originalException,e);return r.exception.values=[...s,...r.exception.values],r}function jS(n,e,t,r,i=[]){if(!Bn(t[r],Error)||i.length+1>=e)return i;var s=OS(n,t[r]);return jS(n,e,t[r],r,[s,...i])}var ki=fe();class Hs{constructor(){Hs.prototype.__init.call(this)}static __initStatic(){this.id="HttpContext"}__init(){this.name=Hs.id}setupOnce(){Pm(e=>{if(Oe().getIntegration(Hs)){if(!ki.navigator&&!ki.location&&!ki.document)return e;var t=e.request&&e.request.url||ki.location&&ki.location.href;const{referrer:s}=ki.document||{},{userAgent:o}=ki.navigator||{};var r={...e.request&&e.request.headers,...s&&{Referer:s},...o&&{"User-Agent":o}},i={...t&&{url:t},headers:r};return{...e,request:i}}return e})}}Hs.__initStatic();class zs{constructor(){zs.prototype.__init.call(this)}static __initStatic(){this.id="Dedupe"}__init(){this.name=zs.id}setupOnce(e,t){var r=i=>{var s=t().getIntegration(zs);if(s){try{if(GC(i,s._previousEvent))return(typeof __SENTRY_DEBUG__>"u"||__SENTRY_DEBUG__)&&F.warn("Event dropped due to being a duplicate of previously captured event."),null}catch{return s._previousEvent=i}return s._previousEvent=i}return i};r.id=this.name,e(r)}}zs.__initStatic();function GC(n,e){return e?!!(qC(n,e)||WC(n,e)):!1}function qC(n,e){var t=n.message,r=e.message;return!(!t&&!r||t&&!r||!t&&r||t!==r||!zS(n,e)||!HS(n,e))}function WC(n,e){var t=Cy(e),r=Cy(n);return!(!t||!r||t.type!==r.type||t.value!==r.value||!zS(n,e)||!HS(n,e))}function HS(n,e){let t=My(n),r=My(e);if(!t&&!r)return!0;if(t&&!r||!t&&r||(t=t,r=r,r.length!==t.length))return!1;for(let o=0;o<r.length;o++){var i=r[o],s=t[o];if(i.filename!==s.filename||i.lineno!==s.lineno||i.colno!==s.colno||i.function!==s.function)return!1}return!0}function zS(n,e){let t=n.fingerprint,r=e.fingerprint;if(!t&&!r)return!0;if(t&&!r||!t&&r)return!1;t=t,r=r;try{return t.join("")===r.join("")}catch{return!1}}function Cy(n){return n.exception&&n.exception.values&&n.exception.values[0]}function My(n){var e=n.exception;if(e)try{return e.values[0].stacktrace.frames}catch{return}}var YC=[new Ks,new al,new cl,new ll,new ii,new js,new zs,new Hs];function XC(n={}){if(n.defaultIntegrations===void 0&&(n.defaultIntegrations=YC),n.release===void 0){var e=fe();e.SENTRY_RELEASE&&e.SENTRY_RELEASE.id&&(n.release=e.SENTRY_RELEASE.id)}n.autoSessionTracking===void 0&&(n.autoSessionTracking=!0),n.sendClientReports===void 0&&(n.sendClientReports=!0);var t={...n,stackParser:$R(n.stackParser||DC),integrations:V1(n),transport:n.transport||(Nm()?pC:_C)};H1(fC,t),n.autoSessionTracking&&JC()}function xy(n){n.startSession({ignoreDuration:!0}),n.captureSession()}function JC(){var n=fe(),e=n.document;if(typeof e>"u"){(typeof __SENTRY_DEBUG__>"u"||__SENTRY_DEBUG__)&&F.warn("Session tracking in non-browser environment with @sentry/browser is not supported.");return}var t=Oe();t.captureSession&&(xy(t),Kt("history",({from:r,to:i})=>{r===void 0||r===i||xy(Oe())}))}function QC(n){n._metadata=n._metadata||{},n._metadata.sdk=n._metadata.sdk||{name:"sentry.javascript.react",packages:[{name:"npm:@sentry/react",version:ku}],version:ku},XC(n)}var GS={exports:{}},pe={};/** @license React v16.13.1
 * react-is.production.min.js
 *
 * Copyright (c) Facebook, Inc. and its affiliates.
 *
 * This source code is licensed under the MIT license found in the
 * LICENSE file in the root directory of this source tree.
 */var Ze=typeof Symbol=="function"&&Symbol.for,Bm=Ze?Symbol.for("react.element"):60103,Vm=Ze?Symbol.for("react.portal"):60106,md=Ze?Symbol.for("react.fragment"):60107,_d=Ze?Symbol.for("react.strict_mode"):60108,gd=Ze?Symbol.for("react.profiler"):60114,yd=Ze?Symbol.for("react.provider"):60109,vd=Ze?Symbol.for("react.context"):60110,Km=Ze?Symbol.for("react.async_mode"):60111,wd=Ze?Symbol.for("react.concurrent_mode"):60111,bd=Ze?Symbol.for("react.forward_ref"):60112,Sd=Ze?Symbol.for("react.suspense"):60113,ZC=Ze?Symbol.for("react.suspense_list"):60120,Ed=Ze?Symbol.for("react.memo"):60115,kd=Ze?Symbol.for("react.lazy"):60116,eM=Ze?Symbol.for("react.block"):60121,tM=Ze?Symbol.for("react.fundamental"):60117,nM=Ze?Symbol.for("react.responder"):60118,rM=Ze?Symbol.for("react.scope"):60119;function Wt(n){if(typeof n=="object"&&n!==null){var e=n.$$typeof;switch(e){case Bm:switch(n=n.type,n){case Km:case wd:case md:case gd:case _d:case Sd:return n;default:switch(n=n&&n.$$typeof,n){case vd:case bd:case kd:case Ed:case yd:return n;default:return e}}case Vm:return e}}}function qS(n){return Wt(n)===wd}pe.AsyncMode=Km;pe.ConcurrentMode=wd;pe.ContextConsumer=vd;pe.ContextProvider=yd;pe.Element=Bm;pe.ForwardRef=bd;pe.Fragment=md;pe.Lazy=kd;pe.Memo=Ed;pe.Portal=Vm;pe.Profiler=gd;pe.StrictMode=_d;pe.Suspense=Sd;pe.isAsyncMode=function(n){return qS(n)||Wt(n)===Km};pe.isConcurrentMode=qS;pe.isContextConsumer=function(n){return Wt(n)===vd};pe.isContextProvider=function(n){return Wt(n)===yd};pe.isElement=function(n){return typeof n=="object"&&n!==null&&n.$$typeof===Bm};pe.isForwardRef=function(n){return Wt(n)===bd};pe.isFragment=function(n){return Wt(n)===md};pe.isLazy=function(n){return Wt(n)===kd};pe.isMemo=function(n){return Wt(n)===Ed};pe.isPortal=function(n){return Wt(n)===Vm};pe.isProfiler=function(n){return Wt(n)===gd};pe.isStrictMode=function(n){return Wt(n)===_d};pe.isSuspense=function(n){return Wt(n)===Sd};pe.isValidElementType=function(n){return typeof n=="string"||typeof n=="function"||n===md||n===wd||n===gd||n===_d||n===Sd||n===ZC||typeof n=="object"&&n!==null&&(n.$$typeof===kd||n.$$typeof===Ed||n.$$typeof===yd||n.$$typeof===vd||n.$$typeof===bd||n.$$typeof===tM||n.$$typeof===nM||n.$$typeof===rM||n.$$typeof===eM)};pe.typeOf=Wt;GS.exports=pe;var iM=GS.exports,jm=iM,sM={childContextTypes:!0,contextType:!0,contextTypes:!0,defaultProps:!0,displayName:!0,getDefaultProps:!0,getDerivedStateFromError:!0,getDerivedStateFromProps:!0,mixins:!0,propTypes:!0,type:!0},oM={name:!0,length:!0,prototype:!0,caller:!0,callee:!0,arguments:!0,arity:!0},aM={$$typeof:!0,render:!0,defaultProps:!0,displayName:!0,propTypes:!0},WS={$$typeof:!0,compare:!0,defaultProps:!0,displayName:!0,propTypes:!0,type:!0},Hm={};Hm[jm.ForwardRef]=aM;Hm[jm.Memo]=WS;function Ay(n){return jm.isMemo(n)?WS:Hm[n.$$typeof]||sM}var lM=Object.defineProperty,cM=Object.getOwnPropertyNames,Dy=Object.getOwnPropertySymbols,uM=Object.getOwnPropertyDescriptor,dM=Object.getPrototypeOf,Ny=Object.prototype;function YS(n,e,t){if(typeof e!="string"){if(Ny){var r=dM(e);r&&r!==Ny&&YS(n,r,t)}var i=cM(e);Dy&&(i=i.concat(Dy(e)));for(var s=Ay(n),o=Ay(e),a=0;a<i.length;++a){var c=i[a];if(!oM[c]&&!(t&&t[c])&&!(o&&o[c])&&!(s&&s[c])){var u=uM(e,c);try{lM(n,c,u)}catch{}}}}return n}var hM=YS;const fM=mo(hM);var pM="/home/runner/work/sentry-javascript/sentry-javascript/packages/react/src/reactrouterv6.tsx";let Lr,Bc,Yf,Xf,Jf,Id,zm,XS;var Eh=fe(),JS={"routing.instrumentation":"react-router-v6"};function mM(n,e,t,r,i){return(s,o=!0,a=!0)=>{var c=Eh&&Eh.location&&Eh.location.pathname;o&&c&&(Lr=s({name:c,op:"pageload",tags:JS,metadata:{source:"url"}})),Bc=n,Yf=e,Xf=t,Id=i,Jf=r,zm=s,XS=a}}function QS(n,e,t){if(!n||n.length===0||!t)return[e.pathname,"url"];var r=t(n,e);let i="";if(r)for(let u=0;u<r.length;u++){var s=r[u],o=s.route;if(o){if(o.index)return[s.pathname,"route"];var a=o.path;if(a){var c=a[0]==="/"?a:`/${a}`;if(i+=c,s.pathname===e.pathname)return gy(i)!==gy(s.pathname)?[c,"route"]:[i,"route"]}}}return[e.pathname,"url"]}function _M(n,e){Lr&&Lr.setName(...QS(e,n,Id))}function gM(n,e,t,r){if(r){Lr&&Lr.finish();return}if(XS&&(t==="PUSH"||t==="POP")){Lr&&Lr.finish();const[i,s]=QS(e,n,Id);Lr=zm({name:i,op:"navigation",tags:JS,metadata:{source:s}})}}function yM(n){if(!Bc||!Yf||!Xf||!Jf||!Id||!zm)return(typeof __SENTRY_DEBUG__>"u"||__SENTRY_DEBUG__)&&F.warn("reactRouterV6Instrumentation was unable to wrap Routes because of one or more missing parameters."),n;let e=!1,t;var r=i=>{var s=Yf(),o=Xf();return Bc(()=>{t=Jf(i.children),e=!0,_M(s,t)},[i.children]),Bc(()=>{gM(s,t,o,e)},[i.children,s,o,e]),e=!1,jt.createElement(n,{...i,__self:this,__source:{fileName:pM,lineNumber:223}})};return fM(r,n),r}function Gm(n){var e=Oe().getClient(),t=n||e&&e.getOptions();return!!t&&("tracesSampleRate"in t||"tracesSampler"in t)}function Rl(n){var e=n||Oe(),t=e.getScope();return t&&t.getTransaction()}function st(n){return n/1e3}function vM(){Kt("error",Py),Kt("unhandledrejection",Py)}function Py(){var n=Rl();if(n){var e="internal_error";(typeof __SENTRY_DEBUG__>"u"||__SENTRY_DEBUG__)&&F.log(`[Tracing] Transaction: ${e} -> Global error occured`),n.setStatus(e)}}class Td{__init(){this.spans=[]}constructor(e=1e3){Td.prototype.__init.call(this),this._maxlen=e}add(e){this.spans.length>this._maxlen?e.spanRecorder=void 0:this.spans.push(e)}}class Dr{__init2(){this.traceId=ni()}__init3(){this.spanId=ni().substring(16)}__init4(){this.startTimestamp=sl()}__init5(){this.tags={}}__init6(){this.data={}}constructor(e){if(Dr.prototype.__init2.call(this),Dr.prototype.__init3.call(this),Dr.prototype.__init4.call(this),Dr.prototype.__init5.call(this),Dr.prototype.__init6.call(this),!e)return this;e.traceId&&(this.traceId=e.traceId),e.spanId&&(this.spanId=e.spanId),e.parentSpanId&&(this.parentSpanId=e.parentSpanId),"sampled"in e&&(this.sampled=e.sampled),e.op&&(this.op=e.op),e.description&&(this.description=e.description),e.data&&(this.data=e.data),e.tags&&(this.tags=e.tags),e.status&&(this.status=e.status),e.startTimestamp&&(this.startTimestamp=e.startTimestamp),e.endTimestamp&&(this.endTimestamp=e.endTimestamp)}startChild(e){var t=new Dr({...e,parentSpanId:this.spanId,sampled:this.sampled,traceId:this.traceId});if(t.spanRecorder=this.spanRecorder,t.spanRecorder&&t.spanRecorder.add(t),t.transaction=this.transaction,(typeof __SENTRY_DEBUG__>"u"||__SENTRY_DEBUG__)&&t.transaction){var r=e&&e.op||"< unknown op >",i=t.transaction.name||"< unknown name >",s=t.transaction.spanId,o=`[Tracing] Starting '${r}' span on transaction '${i}' (${s}).`;t.transaction.metadata.spanMetadata[t.spanId]={logMessage:o},F.log(o)}return t}setTag(e,t){return this.tags={...this.tags,[e]:t},this}setData(e,t){return this.data={...this.data,[e]:t},this}setStatus(e){return this.status=e,this}setHttpStatus(e){this.setTag("http.status_code",String(e));var t=wM(e);return t!=="unknown_error"&&this.setStatus(t),this}isSuccess(){return this.status==="ok"}finish(e){if((typeof __SENTRY_DEBUG__>"u"||__SENTRY_DEBUG__)&&this.transaction&&this.transaction.spanId!==this.spanId){const{logMessage:t}=this.transaction.metadata.spanMetadata[this.spanId];t&&F.log(t.replace("Starting","Finishing"))}this.endTimestamp=typeof e=="number"?e:sl()}toTraceparent(){let e="";return this.sampled!==void 0&&(e=this.sampled?"-1":"-0"),`${this.traceId}-${this.spanId}${e}`}toContext(){return ti({data:this.data,description:this.description,endTimestamp:this.endTimestamp,op:this.op,parentSpanId:this.parentSpanId,sampled:this.sampled,spanId:this.spanId,startTimestamp:this.startTimestamp,status:this.status,tags:this.tags,traceId:this.traceId})}updateWithContext(e){return this.data=Ur(e.data,()=>({})),this.description=e.description,this.endTimestamp=e.endTimestamp,this.op=e.op,this.parentSpanId=e.parentSpanId,this.sampled=e.sampled,this.spanId=Ur(e.spanId,()=>this.spanId),this.startTimestamp=Ur(e.startTimestamp,()=>this.startTimestamp),this.status=e.status,this.tags=Ur(e.tags,()=>({})),this.traceId=Ur(e.traceId,()=>this.traceId),this}getTraceContext(){return ti({data:Object.keys(this.data).length>0?this.data:void 0,description:this.description,op:this.op,parent_span_id:this.parentSpanId,span_id:this.spanId,status:this.status,tags:Object.keys(this.tags).length>0?this.tags:void 0,trace_id:this.traceId})}toJSON(){return ti({data:Object.keys(this.data).length>0?this.data:void 0,description:this.description,op:this.op,parent_span_id:this.parentSpanId,span_id:this.spanId,start_timestamp:this.startTimestamp,status:this.status,tags:Object.keys(this.tags).length>0?this.tags:void 0,timestamp:this.endTimestamp,trace_id:this.traceId})}}function wM(n){if(n<400&&n>=100)return"ok";if(n>=400&&n<500)switch(n){case 401:return"unauthenticated";case 403:return"permission_denied";case 404:return"not_found";case 409:return"already_exists";case 413:return"failed_precondition";case 429:return"resource_exhausted";default:return"invalid_argument"}if(n>=500&&n<600)switch(n){case 501:return"unimplemented";case 503:return"unavailable";case 504:return"deadline_exceeded";default:return"internal_error"}return"unknown_error"}let ZS=class Qf extends Dr{__init(){this._measurements={}}__init2(){this._frozenDynamicSamplingContext=void 0}constructor(e,t){super(e),Qf.prototype.__init.call(this),Qf.prototype.__init2.call(this),this._hub=t||Oe(),this._name=e.name||"",this.metadata={source:"custom",...e.metadata,spanMetadata:{},changes:[],propagations:0},this._trimEnd=e.trimEnd,this.transaction=this;var r=this.metadata.dynamicSamplingContext;r&&(this._frozenDynamicSamplingContext={...r})}get name(){return this._name}set name(e){this.setName(e)}setName(e,t="custom"){(e!==this.name||t!==this.metadata.source)&&this.metadata.changes.push({source:this.metadata.source,timestamp:hd(),propagations:this.metadata.propagations}),this._name=e,this.metadata.source=t}initSpanRecorder(e=1e3){this.spanRecorder||(this.spanRecorder=new Td(e)),this.spanRecorder.add(this)}setMeasurement(e,t,r=""){this._measurements[e]={value:t,unit:r}}setMetadata(e){this.metadata={...this.metadata,...e}}finish(e){if(this.endTimestamp===void 0){if(this.name||((typeof __SENTRY_DEBUG__>"u"||__SENTRY_DEBUG__)&&F.warn("Transaction has no name, falling back to `<unlabeled transaction>`."),this.name="<unlabeled transaction>"),super.finish(e),this.sampled!==!0){(typeof __SENTRY_DEBUG__>"u"||__SENTRY_DEBUG__)&&F.log("[Tracing] Discarding transaction because its trace was not chosen to be sampled.");var t=this._hub.getClient();t&&t.recordDroppedEvent("sample_rate","transaction");return}var r=this.spanRecorder?this.spanRecorder.spans.filter(a=>a!==this&&a.endTimestamp):[];this._trimEnd&&r.length>0&&(this.endTimestamp=r.reduce((a,c)=>a.endTimestamp&&c.endTimestamp?a.endTimestamp>c.endTimestamp?a:c:a).endTimestamp);var i=this.metadata,s={contexts:{trace:this.getTraceContext()},spans:r,start_timestamp:this.startTimestamp,tags:this.tags,timestamp:this.endTimestamp,transaction:this.name,type:"transaction",sdkProcessingMetadata:{...i,dynamicSamplingContext:this.getDynamicSamplingContext()},...i.source&&{transaction_info:{source:i.source,changes:i.changes,propagations:i.propagations}}},o=Object.keys(this._measurements).length>0;return o&&((typeof __SENTRY_DEBUG__>"u"||__SENTRY_DEBUG__)&&F.log("[Measurements] Adding measurements to transaction",JSON.stringify(this._measurements,void 0,2)),s.measurements=this._measurements),(typeof __SENTRY_DEBUG__>"u"||__SENTRY_DEBUG__)&&F.log(`[Tracing] Finishing ${this.op} transaction: ${this.name}.`),this._hub.captureEvent(s)}}toContext(){var e=super.toContext();return ti({...e,name:this.name,trimEnd:this._trimEnd})}updateWithContext(e){return super.updateWithContext(e),this.name=Ur(e.name,()=>""),this._trimEnd=e.trimEnd,this}getDynamicSamplingContext(){if(this._frozenDynamicSamplingContext)return this._frozenDynamicSamplingContext;var e=this._hub||Oe(),t=e&&e.getClient();if(!t)return{};const{environment:r,release:i}=t.getOptions()||{},{publicKey:s}=t.getDsn()||{};var o=(this.metadata.transactionSampling||{}).rate,a=o!==void 0?o.toString():void 0,c=e.getScope();const{segment:u}=c&&c.getUser()||{};var l=this.metadata.source,d=l&&l!=="url"?this.name:void 0,p=ti({environment:r,release:i,transaction:d,user_segment:u,public_key:s,trace_id:this.traceId,sample_rate:a});return p}};var eE=1e3,tE=3e4,bM=5e3;class SM extends Td{constructor(e,t,r,i){super(i),this._pushActivity=e,this._popActivity=t,this.transactionSpanId=r}add(e){e.spanId!==this.transactionSpanId&&(e.finish=t=>{e.endTimestamp=typeof t=="number"?t:sl(),this._popActivity(e.spanId)},e.endTimestamp===void 0&&this._pushActivity(e.spanId)),super.add(e)}}class Ms extends ZS{__init(){this.activities={}}__init2(){this._heartbeatCounter=0}__init3(){this._finished=!1}__init4(){this._beforeFinishCallbacks=[]}constructor(e,t,r=eE,i=tE,s=!1){super(e,t),this._idleHub=t,this._idleTimeout=r,this._finalTimeout=i,this._onScope=s,Ms.prototype.__init.call(this),Ms.prototype.__init2.call(this),Ms.prototype.__init3.call(this),Ms.prototype.__init4.call(this),s&&(Oy(t),(typeof __SENTRY_DEBUG__>"u"||__SENTRY_DEBUG__)&&F.log(`Setting idle transaction on scope. Span ID: ${this.spanId}`),t.configureScope(o=>o.setSpan(this))),this._startIdleTimeout(),setTimeout(()=>{this._finished||(this.setStatus("deadline_exceeded"),this.finish())},this._finalTimeout)}finish(e=sl()){if(this._finished=!0,this.activities={},this.spanRecorder){(typeof __SENTRY_DEBUG__>"u"||__SENTRY_DEBUG__)&&F.log("[Tracing] finishing IdleTransaction",new Date(e*1e3).toISOString(),this.op);for(var t of this._beforeFinishCallbacks)t(this,e);this.spanRecorder.spans=this.spanRecorder.spans.filter(r=>{if(r.spanId===this.spanId)return!0;r.endTimestamp||(r.endTimestamp=e,r.setStatus("cancelled"),(typeof __SENTRY_DEBUG__>"u"||__SENTRY_DEBUG__)&&F.log("[Tracing] cancelling span since transaction ended early",JSON.stringify(r,void 0,2)));var i=r.startTimestamp<e;return i||(typeof __SENTRY_DEBUG__>"u"||__SENTRY_DEBUG__)&&F.log("[Tracing] discarding Span since it happened after Transaction was finished",JSON.stringify(r,void 0,2)),i}),(typeof __SENTRY_DEBUG__>"u"||__SENTRY_DEBUG__)&&F.log("[Tracing] flushing IdleTransaction")}else(typeof __SENTRY_DEBUG__>"u"||__SENTRY_DEBUG__)&&F.log("[Tracing] No active IdleTransaction");return this._onScope&&Oy(this._idleHub),super.finish(e)}registerBeforeFinishCallback(e){this._beforeFinishCallbacks.push(e)}initSpanRecorder(e){if(!this.spanRecorder){var t=i=>{this._finished||this._pushActivity(i)},r=i=>{this._finished||this._popActivity(i)};this.spanRecorder=new SM(t,r,this.spanId,e),(typeof __SENTRY_DEBUG__>"u"||__SENTRY_DEBUG__)&&F.log("Starting heartbeat"),this._pingHeartbeat()}this.spanRecorder.add(this)}_cancelIdleTimeout(){this._idleTimeoutID&&(clearTimeout(this._idleTimeoutID),this._idleTimeoutID=void 0)}_startIdleTimeout(e){this._cancelIdleTimeout(),this._idleTimeoutID=setTimeout(()=>{!this._finished&&Object.keys(this.activities).length===0&&this.finish(e)},this._idleTimeout)}_pushActivity(e){this._cancelIdleTimeout(),(typeof __SENTRY_DEBUG__>"u"||__SENTRY_DEBUG__)&&F.log(`[Tracing] pushActivity: ${e}`),this.activities[e]=!0,(typeof __SENTRY_DEBUG__>"u"||__SENTRY_DEBUG__)&&F.log("[Tracing] new activities count",Object.keys(this.activities).length)}_popActivity(e){if(this.activities[e]&&((typeof __SENTRY_DEBUG__>"u"||__SENTRY_DEBUG__)&&F.log(`[Tracing] popActivity ${e}`),delete this.activities[e],(typeof __SENTRY_DEBUG__>"u"||__SENTRY_DEBUG__)&&F.log("[Tracing] new activities count",Object.keys(this.activities).length)),Object.keys(this.activities).length===0){var t=sl()+this._idleTimeout/1e3;this._startIdleTimeout(t)}}_beat(){if(!this._finished){var e=Object.keys(this.activities).join("");e===this._prevHeartbeatString?this._heartbeatCounter+=1:this._heartbeatCounter=1,this._prevHeartbeatString=e,this._heartbeatCounter>=3?((typeof __SENTRY_DEBUG__>"u"||__SENTRY_DEBUG__)&&F.log("[Tracing] Transaction finished because of no change for 3 heart beats"),this.setStatus("deadline_exceeded"),this.finish()):this._pingHeartbeat()}}_pingHeartbeat(){(typeof __SENTRY_DEBUG__>"u"||__SENTRY_DEBUG__)&&F.log(`pinging Heartbeat -> current counter: ${this._heartbeatCounter}`),setTimeout(()=>{this._beat()},bM)}}function Oy(n){var e=n.getScope();if(e){var t=e.getTransaction();t&&e.setSpan(void 0)}}function EM(){var n=this.getScope();if(n){var e=n.getSpan();if(e)return{"sentry-trace":e.toTraceparent()}}return{}}function nE(n,e,t){if(!Gm(e))return n.sampled=!1,n;if(n.sampled!==void 0)return n.setMetadata({transactionSampling:{method:"explicitly_set",rate:Number(n.sampled)}}),n;let r;return typeof e.tracesSampler=="function"?(r=e.tracesSampler(t),n.setMetadata({transactionSampling:{method:"client_sampler",rate:Number(r)}})):t.parentSampled!==void 0?(r=t.parentSampled,n.setMetadata({transactionSampling:{method:"inheritance"}})):(r=e.tracesSampleRate,n.setMetadata({transactionSampling:{method:"client_rate",rate:Number(r)}})),kM(r)?r?(n.sampled=Math.random()<r,n.sampled?((typeof __SENTRY_DEBUG__>"u"||__SENTRY_DEBUG__)&&F.log(`[Tracing] starting ${n.op} transaction - ${n.name}`),n):((typeof __SENTRY_DEBUG__>"u"||__SENTRY_DEBUG__)&&F.log(`[Tracing] Discarding transaction because it's not included in the random sample (sampling rate = ${Number(r)})`),n)):((typeof __SENTRY_DEBUG__>"u"||__SENTRY_DEBUG__)&&F.log(`[Tracing] Discarding transaction because ${typeof e.tracesSampler=="function"?"tracesSampler returned 0 or false":"a negative sampling decision was inherited or tracesSampleRate is set to 0"}`),n.sampled=!1,n):((typeof __SENTRY_DEBUG__>"u"||__SENTRY_DEBUG__)&&F.warn("[Tracing] Discarding transaction because of invalid sample rate."),n.sampled=!1,n)}function kM(n){return yS(n)||!(typeof n=="number"||typeof n=="boolean")?((typeof __SENTRY_DEBUG__>"u"||__SENTRY_DEBUG__)&&F.warn(`[Tracing] Given sample rate is invalid. Sample rate must be a boolean or a number between 0 and 1. Got ${JSON.stringify(n)} of type ${JSON.stringify(typeof n)}.`),!1):n<0||n>1?((typeof __SENTRY_DEBUG__>"u"||__SENTRY_DEBUG__)&&F.warn(`[Tracing] Given sample rate is invalid. Sample rate must be between 0 and 1. Got ${n}.`),!1):!0}function IM(n,e){var t=this.getClient(),r=t&&t.getOptions()||{};let i=new ZS(n,this);return i=nE(i,r,{parentSampled:n.parentSampled,transactionContext:n,...e}),i.sampled&&i.initSpanRecorder(r._experiments&&r._experiments.maxSpans),i}function TM(n,e,t,r,i,s){var o=n.getClient(),a=o&&o.getOptions()||{};let c=new Ms(e,n,t,r,i);return c=nE(c,a,{parentSampled:e.parentSampled,transactionContext:e,...s}),c.sampled&&c.initSpanRecorder(a._experiments&&a._experiments.maxSpans),c}function RM(){var n=Co();n.__SENTRY__&&(n.__SENTRY__.extensions=n.__SENTRY__.extensions||{},n.__SENTRY__.extensions.startTransaction||(n.__SENTRY__.extensions.startTransaction=IM),n.__SENTRY__.extensions.traceHeaders||(n.__SENTRY__.extensions.traceHeaders=EM))}function CM(){var n=Co();if(n.__SENTRY__){var e={mongodb(){var r=Hr(module,"./integrations/node/mongo");return new r.Mongo},mongoose(){var r=Hr(module,"./integrations/node/mongo");return new r.Mongo({mongoose:!0})},mysql(){var r=Hr(module,"./integrations/node/mysql");return new r.Mysql},pg(){var r=Hr(module,"./integrations/node/postgres");return new r.Postgres}},t=Object.keys(e).filter(r=>!!gR(r)).map(r=>{try{return e[r]()}catch{return}}).filter(r=>r);t.length>0&&(n.__SENTRY__.integrations=[...n.__SENTRY__.integrations||[],...t])}}function MM(){RM(),ud()&&CM(),vM()}var Zl=fe();function xM(){Zl&&Zl.document?Zl.document.addEventListener("visibilitychange",()=>{var n=Rl();if(Zl.document.hidden&&n){var e="cancelled";(typeof __SENTRY_DEBUG__>"u"||__SENTRY_DEBUG__)&&F.log(`[Tracing] Transaction: ${e} -> since tab moved to the background, op: ${n.op}`),n.status||n.setStatus(e),n.setTag("visibilitychange","document.hidden"),n.finish()}}):(typeof __SENTRY_DEBUG__>"u"||__SENTRY_DEBUG__)&&F.warn("[Tracing] Could not set up background tab detection due to lack of global document")}var qm=(n,e,t)=>{let r;return i=>{e.value>=0&&(i||t)&&(e.delta=e.value-(r||0),(e.delta||r===void 0)&&(r=e.value,n(e)))}},AM=()=>`v2-${Date.now()}-${Math.floor(Math.random()*(9e12-1))+1e12}`,Wm=(n,e)=>({name:n,value:Ur(e,()=>-1),delta:0,entries:[],id:AM()}),Rd=(n,e)=>{try{if(PerformanceObserver.supportedEntryTypes.includes(n)){if(n==="first-input"&&!("PerformanceEventTiming"in self))return;var t=new PerformanceObserver(r=>r.getEntries().map(e));return t.observe({type:n,buffered:!0}),t}}catch{}},Cd=(n,e)=>{var t=r=>{(r.type==="pagehide"||fe().document.visibilityState==="hidden")&&(n(r),e&&(removeEventListener("visibilitychange",t,!0),removeEventListener("pagehide",t,!0)))};addEventListener("visibilitychange",t,!0),addEventListener("pagehide",t,!0)},DM=(n,e)=>{var t=Wm("CLS",0);let r,i=0,s=[];var o=c=>{if(c&&!c.hadRecentInput){var u=s[0],l=s[s.length-1];i&&s.length!==0&&c.startTime-l.startTime<1e3&&c.startTime-u.startTime<5e3?(i+=c.value,s.push(c)):(i=c.value,s=[c]),i>t.value&&(t.value=i,t.entries=s,r&&r())}},a=Rd("layout-shift",o);a&&(r=qm(n,t,e),Cd(()=>{a.takeRecords().map(o),r(!0)}))};let Vc=-1;var NM=()=>fe().document.visibilityState==="hidden"?0:1/0,PM=()=>{Cd(({timeStamp:n})=>{Vc=n},!0)},Ym=()=>(Vc<0&&(Vc=NM(),PM()),{get firstHiddenTime(){return Vc}}),OM=(n,e)=>{var t=Ym(),r=Wm("FID");let i;var s=a=>{i&&a.startTime<t.firstHiddenTime&&(r.value=a.processingStart-a.startTime,r.entries.push(a),i(!0))},o=Rd("first-input",s);o&&(i=qm(n,r,e),Cd(()=>{o.takeRecords().map(s),o.disconnect()},!0))},Uy={},UM=(n,e)=>{var t=Ym(),r=Wm("LCP");let i;var s=c=>{var u=c.startTime;u<t.firstHiddenTime&&(r.value=u,r.entries.push(c)),i&&i()},o=Rd("largest-contentful-paint",s);if(o){i=qm(n,r,e);var a=()=>{Uy[r.id]||(o.takeRecords().map(s),o.disconnect(),Uy[r.id]=!0,i(!0))};["keydown","click"].forEach(c=>{addEventListener(c,a,{once:!0,capture:!0})}),Cd(a,!0)}};function ec(n){return typeof n=="number"&&isFinite(n)}function ao(n,{startTimestamp:e,...t}){return e&&n.startTimestamp>e&&(n.startTimestamp=e),n.startChild({startTimestamp:e,...t})}var Hi=fe();function rE(){return Hi&&Hi.addEventListener&&Hi.performance}let $y=0,xe={},Mn,$a;function $M(n=!1){var e=rE();e&&ol&&(e.mark&&Hi.performance.mark("sentry-tracing-init"),FM(),BM(n),VM())}function LM(){var n=e=>{var t=Rl();if(t){var r=st(ol+e.startTime),i=st(e.duration);t.startChild({description:"Main UI thread blocked",op:"ui.long-task",startTimestamp:r,endTimestamp:r+i})}};Rd("longtask",n)}function FM(){DM(n=>{var e=n.entries.pop();e&&((typeof __SENTRY_DEBUG__>"u"||__SENTRY_DEBUG__)&&F.log("[Measurements] Adding CLS"),xe.cls={value:n.value,unit:""},$a=e)})}function BM(n){UM(e=>{var t=e.entries.pop();t&&((typeof __SENTRY_DEBUG__>"u"||__SENTRY_DEBUG__)&&F.log("[Measurements] Adding LCP"),xe.lcp={value:e.value,unit:"millisecond"},Mn=t)},n)}function VM(){OM(n=>{var e=n.entries.pop();if(e){var t=st(ol),r=st(e.startTime);(typeof __SENTRY_DEBUG__>"u"||__SENTRY_DEBUG__)&&F.log("[Measurements] Adding FID"),xe.fid={value:n.value,unit:"millisecond"},xe["mark.fid"]={value:t+r,unit:"second"}}})}function KM(n){var e=rE();if(!e||!Hi.performance.getEntries||!ol)return;(typeof __SENTRY_DEBUG__>"u"||__SENTRY_DEBUG__)&&F.log("[Tracing] Adding & adjusting spans using Performance API");var t=st(ol),r=e.getEntries();let i,s;if(r.slice($y).forEach(a=>{var c=st(a.startTime),u=st(a.duration);if(!(n.op==="navigation"&&t+c<n.startTimestamp))switch(a.entryType){case"navigation":{HM(n,a,t),i=t+st(a.responseStart),s=t+st(a.requestStart);break}case"mark":case"paint":case"measure":{jM(n,a,c,u,t);var l=Ym(),d=a.startTime<l.firstHiddenTime;a.name==="first-paint"&&d&&((typeof __SENTRY_DEBUG__>"u"||__SENTRY_DEBUG__)&&F.log("[Measurements] Adding FP"),xe.fp={value:a.startTime,unit:"millisecond"}),a.name==="first-contentful-paint"&&d&&((typeof __SENTRY_DEBUG__>"u"||__SENTRY_DEBUG__)&&F.log("[Measurements] Adding FCP"),xe.fcp={value:a.startTime,unit:"millisecond"});break}case"resource":{var p=a.name.replace(Hi.location.origin,"");GM(n,a,p,c,u,t);break}}}),$y=Math.max(r.length-1,0),qM(n),n.op==="pageload"){typeof i=="number"&&((typeof __SENTRY_DEBUG__>"u"||__SENTRY_DEBUG__)&&F.log("[Measurements] Adding TTFB"),xe.ttfb={value:(i-n.startTimestamp)*1e3,unit:"millisecond"},typeof s=="number"&&s<=i&&(xe["ttfb.requestTime"]={value:(i-s)*1e3,unit:"millisecond"})),["fcp","fp","lcp"].forEach(a=>{if(!(!xe[a]||t>=n.startTimestamp)){var c=xe[a].value,u=t+st(c),l=Math.abs((u-n.startTimestamp)*1e3),d=l-c;(typeof __SENTRY_DEBUG__>"u"||__SENTRY_DEBUG__)&&F.log(`[Measurements] Normalized ${a} from ${c} to ${l} (${d})`),xe[a].value=l}});var o=xe["mark.fid"];o&&xe.fid&&(ao(n,{description:"first input delay",endTimestamp:o.value+st(xe.fid.value),op:"web.vitals",startTimestamp:o.value}),delete xe["mark.fid"]),"fcp"in xe||delete xe.cls,Object.keys(xe).forEach(a=>{n.setMeasurement(a,xe[a].value,xe[a].unit)}),WM(n)}Mn=void 0,$a=void 0,xe={}}function jM(n,e,t,r,i){var s=i+t,o=s+r;return ao(n,{description:e.name,endTimestamp:o,op:e.entryType,startTimestamp:s}),s}function HM(n,e,t){["unloadEvent","redirect","domContentLoadedEvent","loadEvent","connect"].forEach(r=>{tc(n,e,r,t)}),tc(n,e,"secureConnection",t,"TLS/SSL","connectEnd"),tc(n,e,"fetch",t,"cache","domainLookupStart"),tc(n,e,"domainLookup",t,"DNS"),zM(n,e,t)}function tc(n,e,t,r,i,s){var o=s?e[s]:e[`${t}End`],a=e[`${t}Start`];!a||!o||ao(n,{op:"browser",description:Ur(i,()=>t),startTimestamp:r+st(a),endTimestamp:r+st(o)})}function zM(n,e,t){ao(n,{op:"browser",description:"request",startTimestamp:t+st(e.requestStart),endTimestamp:t+st(e.responseEnd)}),ao(n,{op:"browser",description:"response",startTimestamp:t+st(e.responseStart),endTimestamp:t+st(e.responseEnd)})}function GM(n,e,t,r,i,s){if(!(e.initiatorType==="xmlhttprequest"||e.initiatorType==="fetch")){var o={};"transferSize"in e&&(o["Transfer Size"]=e.transferSize),"encodedBodySize"in e&&(o["Encoded Body Size"]=e.encodedBodySize),"decodedBodySize"in e&&(o["Decoded Body Size"]=e.decodedBodySize);var a=s+r,c=a+i;ao(n,{description:t,endTimestamp:c,op:e.initiatorType?`resource.${e.initiatorType}`:"resource",startTimestamp:a,data:o})}}function qM(n){var e=Hi.navigator;if(e){var t=e.connection;t&&(t.effectiveType&&n.setTag("effectiveConnectionType",t.effectiveType),t.type&&n.setTag("connectionType",t.type),ec(t.rtt)&&(xe["connection.rtt"]={value:t.rtt,unit:"millisecond"}),ec(t.downlink)&&(xe["connection.downlink"]={value:t.downlink,unit:""})),ec(e.deviceMemory)&&n.setTag("deviceMemory",`${e.deviceMemory} GB`),ec(e.hardwareConcurrency)&&n.setTag("hardwareConcurrency",String(e.hardwareConcurrency))}}function WM(n){Mn&&((typeof __SENTRY_DEBUG__>"u"||__SENTRY_DEBUG__)&&F.log("[Measurements] Adding LCP Data"),Mn.element&&n.setTag("lcp.element",nl(Mn.element)),Mn.id&&n.setTag("lcp.id",Mn.id),Mn.url&&n.setTag("lcp.url",Mn.url.trim().slice(0,200)),n.setTag("lcp.size",Mn.size)),$a&&$a.sources&&((typeof __SENTRY_DEBUG__>"u"||__SENTRY_DEBUG__)&&F.log("[Measurements] Adding CLS Data"),$a.sources.forEach((e,t)=>n.setTag(`cls.source.${t+1}`,nl(e.node))))}var YM=["localhost",/^\//],Tu={traceFetch:!0,traceXHR:!0,tracingOrigins:YM};function XM(n){const{traceFetch:e,traceXHR:t,tracingOrigins:r,shouldCreateSpanForRequest:i}={...Tu,...n};var s={},o=u=>{if(s[u])return s[u];var l=r;return s[u]=l.some(d=>rl(u,d))&&!rl(u,"sentry_key"),s[u]};let a=o;typeof i=="function"&&(a=u=>o(u)&&i(u));var c={};e&&Kt("fetch",u=>{JM(u,a,c)}),t&&Kt("xhr",u=>{ZM(u,a,c)})}function JM(n,e,t){if(!(!Gm()||!(n.fetchData&&e(n.fetchData.url)))){if(n.endTimestamp){var r=n.fetchData.__span;if(!r)return;var i=t[r];i&&(n.response?i.setHttpStatus(n.response.status):n.error&&i.setStatus("internal_error"),i.finish(),delete t[r]);return}var s=Rl();if(s){var i=s.startChild({data:{...n.fetchData,type:"fetch"},description:`${n.fetchData.method} ${n.fetchData.url}`,op:"http.client"});n.fetchData.__span=i.spanId,t[i.spanId]=i;var o=n.args[0];n.args[1]=n.args[1]||{};var a=n.args[1];a.headers=QM(o,s.getDynamicSamplingContext(),i,a),s.metadata.propagations+=1}}}function QM(n,e,t,r){var i=MS(e),s=t.toTraceparent(),o=typeof Request<"u"&&Bn(n,Request)?n.headers:r.headers;if(o)if(typeof Headers<"u"&&Bn(o,Headers)){var a=new Headers(o);return a.append("sentry-trace",s),i&&a.append(Gf,i),a}else if(Array.isArray(o)){var a=[...o,["sentry-trace",s]];return i&&a.push([Gf,i]),a}else{var c="baggage"in o?o.baggage:void 0,u=[];return Array.isArray(c)?u.push(...c):c&&u.push(c),i&&u.push(i),{...o,"sentry-trace":s,baggage:u.length>0?u.join(","):void 0}}else return{"sentry-trace":s,baggage:i}}function ZM(n,e,t){if(!(!Gm()||n.xhr&&n.xhr.__sentry_own_request__||!(n.xhr&&n.xhr.__sentry_xhr__&&e(n.xhr.__sentry_xhr__.url)))){var r=n.xhr.__sentry_xhr__;if(n.endTimestamp){var i=n.xhr.__sentry_xhr_span_id__;if(!i)return;var s=t[i];s&&(s.setHttpStatus(r.status_code),s.finish(),delete t[i]);return}var o=Rl();if(o){var s=o.startChild({data:{...r.data,type:"xhr",method:r.method,url:r.url},description:`${r.method} ${r.url}`,op:"http.client"});if(n.xhr.__sentry_xhr_span_id__=s.spanId,t[n.xhr.__sentry_xhr_span_id__]=s,n.xhr.setRequestHeader)try{n.xhr.setRequestHeader("sentry-trace",s.toTraceparent());var a=o.getDynamicSamplingContext(),c=MS(a);c&&n.xhr.setRequestHeader(Gf,c),o.metadata.propagations+=1}catch{}}}}var ta=fe();function ex(n,e=!0,t=!0){if(!ta||!ta.location){(typeof __SENTRY_DEBUG__>"u"||__SENTRY_DEBUG__)&&F.warn("Could not initialize routing instrumentation due to invalid location");return}let r=ta.location.href,i;e&&(i=n({name:ta.location.pathname,op:"pageload",metadata:{source:"url"}})),t&&Kt("history",({to:s,from:o})=>{if(o===void 0&&r&&r.indexOf(s)!==-1){r=void 0;return}o!==s&&(r=void 0,i&&((typeof __SENTRY_DEBUG__>"u"||__SENTRY_DEBUG__)&&F.log(`[Tracing] Finishing current transaction with op: ${i.op}`),i.finish()),i=n({name:ta.location.pathname,op:"navigation",metadata:{source:"url"}}))})}var tx="BrowserTracing",nx={idleTimeout:eE,finalTimeout:tE,markBackgroundTransactions:!0,routingInstrumentation:ex,startTransactionOnLocationChange:!0,startTransactionOnPageLoad:!0,_experiments:{enableLongTask:!0},...Tu};class Xm{__init(){this.name=tx}constructor(e){Xm.prototype.__init.call(this);let t=Tu.tracingOrigins;e&&(e.tracingOrigins&&Array.isArray(e.tracingOrigins)?t=e.tracingOrigins:(typeof __SENTRY_DEBUG__>"u"||__SENTRY_DEBUG__)&&(this._emitOptionsWarning=!0)),this.options={...nx,...e,tracingOrigins:t};const{_metricOptions:r}=this.options;$M(r&&r._reportAllChanges),OR([this,"access",i=>i.options,"access",i=>i._experiments,"optionalAccess",i=>i.enableLongTask])&&LM()}setupOnce(e,t){this._getCurrentHub=t,this._emitOptionsWarning&&((typeof __SENTRY_DEBUG__>"u"||__SENTRY_DEBUG__)&&F.warn("[Tracing] You need to define `tracingOrigins` in the options. Set an array of urls or patterns to trace."),(typeof __SENTRY_DEBUG__>"u"||__SENTRY_DEBUG__)&&F.warn(`[Tracing] We added a reasonable default for you: ${Tu.tracingOrigins}`));const{routingInstrumentation:r,startTransactionOnLocationChange:i,startTransactionOnPageLoad:s,markBackgroundTransactions:o,traceFetch:a,traceXHR:c,tracingOrigins:u,shouldCreateSpanForRequest:l}=this.options;r(d=>this._createRouteTransaction(d),s,i),o&&xM(),XM({traceFetch:a,traceXHR:c,tracingOrigins:u,shouldCreateSpanForRequest:l})}_createRouteTransaction(e){if(!this._getCurrentHub){(typeof __SENTRY_DEBUG__>"u"||__SENTRY_DEBUG__)&&F.warn(`[Tracing] Did not create ${e.op} transaction because _getCurrentHub is invalid.`);return}const{beforeNavigate:t,idleTimeout:r,finalTimeout:i}=this.options;var s=e.op==="pageload",o=s?Ly("sentry-trace"):null,a=s?Ly("baggage"):null,c=o?u1(o):void 0,u=a?E1(a):void 0,l={...e,...c,metadata:{...e.metadata,dynamicSamplingContext:c&&!u?{}:u},trimEnd:!0},d=typeof t=="function"?t(l):l,p=d===void 0?{...l,sampled:!1}:d;p.metadata=p.name!==l.name?{...p.metadata,source:"custom"}:p.metadata,p.sampled===!1&&(typeof __SENTRY_DEBUG__>"u"||__SENTRY_DEBUG__)&&F.log(`[Tracing] Will not send ${p.op} transaction because of beforeNavigate.`),(typeof __SENTRY_DEBUG__>"u"||__SENTRY_DEBUG__)&&F.log(`[Tracing] Starting ${p.op} transaction on scope`);var m=this._getCurrentHub();const{location:w}=fe();var S=TM(m,p,r,i,!0,{location:w});return S.registerBeforeFinishCallback(v=>{KM(v),v.setTag("sentry_reportAllChanges",!!(this.options._metricOptions&&this.options._metricOptions._reportAllChanges))}),S}}function Ly(n){var e=IR(`meta[name=${n}]`);return e?e.getAttribute("content"):null}(typeof __SENTRY_TRACING__>"u"||__SENTRY_TRACING__)&&MM();const rx="modulepreload",ix=function(n){return"/"+n},Fy={},_i=function(e,t,r){if(!t||t.length===0)return e();const i=document.getElementsByTagName("link");return Promise.all(t.map(s=>{if(s=ix(s),s in Fy)return;Fy[s]=!0;const o=s.endsWith(".css"),a=o?'[rel="stylesheet"]':"";if(!!r)for(let l=i.length-1;l>=0;l--){const d=i[l];if(d.href===s&&(!o||d.rel==="stylesheet"))return}else if(document.querySelector(`link[href="${s}"]${a}`))return;const u=document.createElement("link");if(u.rel=o?"stylesheet":rx,o||(u.as="script",u.crossOrigin=""),u.href=s,document.head.appendChild(u),o)return new Promise((l,d)=>{u.addEventListener("load",l),u.addEventListener("error",()=>d(new Error(`Unable to preload CSS for ${s}`)))})})).then(()=>e())};function Jm(n,e,t,r){Object.defineProperty(n,e,{get:t,set:r,enumerable:!0,configurable:!0})}var Qm={};Jm(Qm,"SSRProvider",()=>sx);Jm(Qm,"useSSRSafeId",()=>iE);Jm(Qm,"useIsSSR",()=>ax);const Md={prefix:String(Math.round(Math.random()*1e10)),current:0},Ru=jt.createContext(Md);function sx(n){let e=R.useContext(Ru),t=R.useMemo(()=>({prefix:e===Md?"":`${e.prefix}-${++e.current}`,current:0}),[e]);return jt.createElement(Ru.Provider,{value:t},n.children)}let ox=!!(typeof window<"u"&&window.document&&window.document.createElement);function iE(n){let e=R.useContext(Ru);return e===Md&&!ox&&console.warn("When server rendering, you must wrap your application in an <SSRProvider> to ensure consistent ids are generated between the client and server."),R.useMemo(()=>n||`react-aria${e.prefix}-${++e.current}`,[n])}function ax(){let e=R.useContext(Ru)!==Md,[t,r]=R.useState(e);return typeof window<"u"&&e&&R.useLayoutEffect(()=>{r(!1)},[]),t}function sE(n){var e,t,r="";if(typeof n=="string"||typeof n=="number")r+=n;else if(typeof n=="object")if(Array.isArray(n))for(e=0;e<n.length;e++)n[e]&&(t=sE(n[e]))&&(r&&(r+=" "),r+=t);else for(e in n)n[e]&&(r&&(r+=" "),r+=e);return r}function lx(){for(var n,e,t=0,r="";t<arguments.length;)(n=arguments[t++])&&(e=sE(n))&&(r&&(r+=" "),r+=e);return r}function xd(n,e,t,r){Object.defineProperty(n,e,{get:t,set:r,enumerable:!0,configurable:!0})}var cx={};xd(cx,"useControlledState",()=>ux);function ux(n,e,t){let[r,i]=R.useState(n||e),s=R.useRef(n!==void 0),o=s.current,a=n!==void 0,c=R.useRef(r);o!==a&&console.warn(`WARN: A component changed from ${o?"controlled":"uncontrolled"} to ${a?"controlled":"uncontrolled"}.`),s.current=a;let u=R.useCallback((l,...d)=>{let p=(m,...w)=>{t&&(Object.is(c.current,m)||t(m,...w)),a||(c.current=m)};typeof l=="function"?(console.warn("We can not support a function callback. See Github Issues for details https://github.com/adobe/react-spectrum/issues/2320"),i((w,...S)=>{let v=l(a?c.current:w,...S);return p(v,...d),a?w:v})):(a||i(l),p(l,...d))},[a,t]);return a?c.current=n:n=r,[n,u]}var Zm={};xd(Zm,"clamp",()=>oE);xd(Zm,"snapValueToStep",()=>aE);xd(Zm,"toFixedNumber",()=>dx);function oE(n,e=-1/0,t=1/0){return Math.min(Math.max(n,e),t)}function aE(n,e,t,r){let i=(n-(isNaN(e)?0:e))%r,s=Math.abs(i)*2>=r?n+Math.sign(i)*(r-Math.abs(i)):n-i;isNaN(e)?!isNaN(t)&&s>t&&(s=Math.floor(t/r)*r):s<e?s=e:!isNaN(t)&&s>t&&(s=e+Math.floor((t-e)/r)*r);let o=r.toString(),a=o.indexOf("."),c=a>=0?o.length-a:0;if(c>0){let u=Math.pow(10,c);s=Math.round(s*u)/u}return s}function dx(n,e,t=10){const r=Math.pow(t,e);return Math.round(n*r)/r}function le(n,e,t,r){Object.defineProperty(n,e,{get:t,set:r,enumerable:!0,configurable:!0})}var e_={};le(e_,"useId",()=>t_);le(e_,"mergeIds",()=>lE);le(e_,"useSlotId",()=>fx);var hx={};le(hx,"useLayoutEffect",()=>gi);const gi=typeof window<"u"?jt.useLayoutEffect:()=>{};let Cu=new Map;function t_(n){let[e,t]=R.useState(n),r=R.useRef(null),i=iE(e),s=R.useCallback(o=>{r.current=o},[]);return Cu.set(i,s),gi(()=>{let o=i;return()=>{Cu.delete(o)}},[i]),R.useEffect(()=>{let o=r.current;o&&(r.current=null,t(o))}),i}function lE(n,e){if(n===e)return n;let t=Cu.get(n);if(t)return t(e),e;let r=Cu.get(e);return r?(r(n),n):e}function fx(n=[]){let e=t_(),[t,r]=yE(e),i=R.useCallback(()=>{r(function*(){yield e,yield document.getElementById(e)?e:null})},[e,r]);return gi(i,[e,i,...n]),t}var px={};le(px,"chain",()=>cE);function cE(...n){return(...e)=>{for(let t of n)typeof t=="function"&&t(...e)}}var mx={};le(mx,"mergeProps",()=>Mo);function Mo(...n){let e={...n[0]};for(let t=1;t<n.length;t++){let r=n[t];for(let i in r){let s=e[i],o=r[i];typeof s=="function"&&typeof o=="function"&&i[0]==="o"&&i[1]==="n"&&i.charCodeAt(2)>=65&&i.charCodeAt(2)<=90?e[i]=cE(s,o):(i==="className"||i==="UNSAFE_className")&&typeof s=="string"&&typeof o=="string"?e[i]=lx(s,o):i==="id"&&s&&o?e.id=lE(s,o):e[i]=o!==void 0?o:s}}return e}var _x={};le(_x,"mergeRefs",()=>gx);function gx(...n){return e=>{for(let t of n)typeof t=="function"?t(e):t!=null&&(t.current=e)}}var yx={};le(yx,"filterDOMProps",()=>Sx);const vx=new Set(["id"]),wx=new Set(["aria-label","aria-labelledby","aria-describedby","aria-details"]),bx=/^(data-.*)$/;function Sx(n,e={}){let{labelable:t,propNames:r}=e,i={};for(const s in n)Object.prototype.hasOwnProperty.call(n,s)&&(vx.has(s)||t&&wx.has(s)||r!=null&&r.has(s)||bx.test(s))&&(i[s]=n[s]);return i}var Ex={};le(Ex,"focusWithoutScrolling",()=>_a);function _a(n){if(kx())n.focus({preventScroll:!0});else{let e=Ix(n);n.focus(),Tx(e)}}let nc=null;function kx(){if(nc==null){nc=!1;try{var n=document.createElement("div");n.focus({get preventScroll(){return nc=!0,!0}})}catch{}}return nc}function Ix(n){for(var e=n.parentNode,t=[],r=document.scrollingElement||document.documentElement;e instanceof HTMLElement&&e!==r;)(e.offsetHeight<e.scrollHeight||e.offsetWidth<e.scrollWidth)&&t.push({element:e,scrollTop:e.scrollTop,scrollLeft:e.scrollLeft}),e=e.parentNode;return r instanceof HTMLElement&&t.push({element:r,scrollTop:r.scrollTop,scrollLeft:r.scrollLeft}),t}function Tx(n){for(let{element:e,scrollTop:t,scrollLeft:r}of n)e.scrollTop=t,e.scrollLeft=r}var Rx={};le(Rx,"getOffset",()=>uE);function uE(n,e,t="horizontal"){let r=n.getBoundingClientRect();return e?t==="horizontal"?r.right:r.bottom:t==="horizontal"?r.left:r.top}var dE={};le(dE,"clamp",()=>oE);le(dE,"snapValueToStep",()=>aE);var Cx={};le(Cx,"runAfterTransition",()=>hE);let ys=new Map,Zf=new Set;function By(){if(typeof window>"u")return;let n=t=>{let r=ys.get(t.target);r||(r=new Set,ys.set(t.target,r),t.target.addEventListener("transitioncancel",e)),r.add(t.propertyName)},e=t=>{let r=ys.get(t.target);if(r&&(r.delete(t.propertyName),r.size===0&&(t.target.removeEventListener("transitioncancel",e),ys.delete(t.target)),ys.size===0)){for(let i of Zf)i();Zf.clear()}};document.body.addEventListener("transitionrun",n),document.body.addEventListener("transitionend",e)}typeof document<"u"&&(document.readyState!=="loading"?By():document.addEventListener("DOMContentLoaded",By));function hE(n){requestAnimationFrame(()=>{ys.size===0?n():Zf.add(n)})}var Mx={};le(Mx,"useDrag1D",()=>xx);const rc=[];function xx(n){console.warn("useDrag1D is deprecated, please use `useMove` instead https://react-spectrum.adobe.com/react-aria/useMove.html");let{containerRef:e,reverse:t,orientation:r,onHover:i,onDrag:s,onPositionChange:o,onIncrement:a,onDecrement:c,onIncrementToMax:u,onDecrementToMin:l,onCollapseToggle:d}=n,p=C=>r==="horizontal"?C.clientX:C.clientY,m=C=>{let P=uE(e.current,t,r),I=p(C);return t?P-I:I-P},w=R.useRef(!1),S=R.useRef(0),v=R.useRef({onPositionChange:o,onDrag:s});v.current.onDrag=s,v.current.onPositionChange=o;let _=C=>{C.preventDefault();let P=m(C);w.current||(w.current=!0,v.current.onDrag&&v.current.onDrag(!0),v.current.onPositionChange&&v.current.onPositionChange(P)),S.current!==P&&(S.current=P,o&&o(P))},b=C=>{const P=C.target;w.current=!1;let I=m(C);v.current.onDrag&&v.current.onDrag(!1),v.current.onPositionChange&&v.current.onPositionChange(I),rc.splice(rc.indexOf(P),1),window.removeEventListener("mouseup",b,!1),window.removeEventListener("mousemove",_,!1)};return{onMouseDown:C=>{const P=C.currentTarget;rc.some(I=>P.contains(I))||(rc.push(P),window.addEventListener("mousemove",_,!1),window.addEventListener("mouseup",b,!1))},onMouseEnter:()=>{i&&i(!0)},onMouseOut:()=>{i&&i(!1)},onKeyDown:C=>{switch(C.key){case"Left":case"ArrowLeft":r==="horizontal"&&(C.preventDefault(),c&&!t?c():a&&t&&a());break;case"Up":case"ArrowUp":r==="vertical"&&(C.preventDefault(),c&&!t?c():a&&t&&a());break;case"Right":case"ArrowRight":r==="horizontal"&&(C.preventDefault(),a&&!t?a():c&&t&&c());break;case"Down":case"ArrowDown":r==="vertical"&&(C.preventDefault(),a&&!t?a():c&&t&&c());break;case"Home":C.preventDefault(),l&&l();break;case"End":C.preventDefault(),u&&u();break;case"Enter":C.preventDefault(),d&&d();break}}}}var Ax={};le(Ax,"useGlobalListeners",()=>Ad);function Ad(){let n=R.useRef(new Map),e=R.useCallback((i,s,o,a)=>{let c=a!=null&&a.once?(...u)=>{n.current.delete(o),o(...u)}:o;n.current.set(o,{type:s,eventTarget:i,fn:c,options:a}),i.addEventListener(s,o,a)},[]),t=R.useCallback((i,s,o,a)=>{var c;let u=((c=n.current.get(o))===null||c===void 0?void 0:c.fn)||o;i.removeEventListener(s,u,a),n.current.delete(o)},[]),r=R.useCallback(()=>{n.current.forEach((i,s)=>{t(i.eventTarget,i.type,s,i.options)})},[t]);return R.useEffect(()=>r,[r]),{addGlobalListener:e,removeGlobalListener:t,removeAllGlobalListeners:r}}var Dx={};le(Dx,"useLabels",()=>Nx);function Nx(n,e){let{id:t,"aria-label":r,"aria-labelledby":i}=n;return t=t_(t),i&&r?i=[...new Set([...i.trim().split(/\s+/),t])].join(" "):i&&(i=i.trim().split(/\s+/).join(" ")),!r&&!i&&e&&(r=e),{id:t,"aria-label":r,"aria-labelledby":i}}var Px={};le(Px,"useObjectRef",()=>Ox);function Ox(n){const e=R.useRef();return gi(()=>{n&&(typeof n=="function"?n(e.current):n.current=e.current)},[n]),e}var Ux={};le(Ux,"useUpdateEffect",()=>$x);function $x(n,e){const t=R.useRef(!0);R.useEffect(()=>{t.current?t.current=!1:n()},e)}var Lx={};le(Lx,"useResizeObserver",()=>Bx);function Fx(){return typeof window.ResizeObserver<"u"}function Bx(n){const{ref:e,onResize:t}=n;R.useEffect(()=>{let r=e==null?void 0:e.current;if(r)if(Fx()){const i=new window.ResizeObserver(s=>{s.length&&t()});return i.observe(r),()=>{r&&i.unobserve(r)}}else return window.addEventListener("resize",t,!1),()=>{window.removeEventListener("resize",t,!1)}},[t,e])}var Vx={};le(Vx,"useSyncRef",()=>n_);function n_(n,e){gi(()=>{if(n&&n.ref&&e)return n.ref.current=e.current,()=>{n.ref.current=null}},[n,e])}var Kx={};le(Kx,"getScrollParent",()=>jx);function jx(n){for(;n&&!Hx(n);)n=n.parentElement;return n||document.scrollingElement||document.documentElement}function Hx(n){let e=window.getComputedStyle(n);return/(auto|scroll)/.test(e.overflow+e.overflowX+e.overflowY)}var zx={};le(zx,"useViewportSize",()=>Gx);let xn=typeof window<"u"&&window.visualViewport;function Gx(){let[n,e]=R.useState(()=>Vy());return R.useEffect(()=>{let t=()=>{e(r=>{let i=Vy();return i.width===r.width&&i.height===r.height?r:i})};return xn?xn.addEventListener("resize",t):window.addEventListener("resize",t),()=>{xn?xn.removeEventListener("resize",t):window.removeEventListener("resize",t)}},[]),n}function Vy(){return{width:(xn==null?void 0:xn.width)||window.innerWidth,height:(xn==null?void 0:xn.height)||window.innerHeight}}var qx={};le(qx,"useDescription",()=>fE);let Wx=0;const kh=new Map;function fE(n){let[e,t]=R.useState(null);return gi(()=>{if(!n)return;let r=kh.get(n);if(r)t(r.element.id);else{let i=`react-aria-description-${Wx++}`;t(i);let s=document.createElement("div");s.id=i,s.style.display="none",s.textContent=n,document.body.appendChild(s),r={refCount:0,element:s},kh.set(n,r)}return r.refCount++,()=>{--r.refCount===0&&(r.element.remove(),kh.delete(n))}},[n]),{"aria-describedby":n?e:void 0}}var yi={};le(yi,"isMac",()=>Dd);le(yi,"isIPhone",()=>pE);le(yi,"isIPad",()=>mE);le(yi,"isIOS",()=>Nd);le(yi,"isAppleDevice",()=>Yx);le(yi,"isWebKit",()=>Xx);le(yi,"isChrome",()=>_E);le(yi,"isAndroid",()=>Jx);function r_(n){var e;return typeof window>"u"||window.navigator==null?!1:((e=window.navigator.userAgentData)===null||e===void 0?void 0:e.brands.some(t=>n.test(t.brand)))||n.test(window.navigator.userAgent)}function i_(n){return typeof window<"u"&&window.navigator!=null?n.test((window.navigator.userAgentData||window.navigator).platform):!1}function Dd(){return i_(/^Mac/i)}function pE(){return i_(/^iPhone/i)}function mE(){return i_(/^iPad/i)||Dd()&&navigator.maxTouchPoints>1}function Nd(){return pE()||mE()}function Yx(){return Dd()||Nd()}function Xx(){return r_(/AppleWebKit/i)&&!_E()}function _E(){return r_(/Chrome/i)}function Jx(){return r_(/Android/i)}var Qx={};le(Qx,"useEvent",()=>gE);function gE(n,e,t,r){let i=R.useRef(t);i.current=t;let s=t==null;R.useEffect(()=>{if(s)return;let o=n.current,a=c=>i.current.call(this,c);return o.addEventListener(e,a,r),()=>{o.removeEventListener(e,a,r)}},[n,e,r,s])}var Zx={};le(Zx,"useValueEffect",()=>yE);function yE(n){let[e,t]=R.useState(n),r=R.useRef(e),i=R.useRef(null);r.current=e;let s=R.useRef(null);s.current=()=>{let a=i.current.next();if(a.done){i.current=null;return}e===a.value?s.current():t(a.value)},gi(()=>{i.current&&s.current()});let o=R.useCallback(a=>{i.current=a(r.current),s.current()},[i,s]);return[e,o]}var eA={};le(eA,"scrollIntoView",()=>tA);function tA(n,e){let t=Ky(n,e,"left"),r=Ky(n,e,"top"),i=e.offsetWidth,s=e.offsetHeight,o=n.scrollLeft,a=n.scrollTop,c=o+n.offsetWidth,u=a+n.offsetHeight;t<=o?o=t:t+i>c&&(o+=t+i-c),r<=a?a=r:r+s>u&&(a+=r+s-u),n.scrollLeft=o,n.scrollTop=a}function Ky(n,e,t){const r=t==="left"?"offsetLeft":"offsetTop";let i=0;for(;e.offsetParent&&(i+=e[r],e.offsetParent!==n);){if(e.offsetParent.contains(n)){i-=n[r];break}e=e.offsetParent}return i}function lt(n,e,t,r){Object.defineProperty(n,e,{get:t,set:r,enumerable:!0,configurable:!0})}var nA={};lt(nA,"Pressable",()=>uA);var rA={};lt(rA,"usePress",()=>s_);let xs="default",ep="",Kc=new WeakMap;function tp(n){Nd()?(xs==="default"&&(ep=document.documentElement.style.webkitUserSelect,document.documentElement.style.webkitUserSelect="none"),xs="disabled"):n&&(Kc.set(n,n.style.userSelect),n.style.userSelect="none")}function ga(n){if(Nd()){if(xs!=="disabled")return;xs="restoring",setTimeout(()=>{hE(()=>{xs==="restoring"&&(document.documentElement.style.webkitUserSelect==="none"&&(document.documentElement.style.webkitUserSelect=ep||""),ep="",xs="default")})},300)}else if(n&&Kc.has(n)){let e=Kc.get(n);n.style.userSelect==="none"&&(n.style.userSelect=e),n.getAttribute("style")===""&&n.removeAttribute("style"),Kc.delete(n)}}function np(n){return n.mozInputSource===0&&n.isTrusted?!0:n.detail===0&&!n.pointerType}class iA{isDefaultPrevented(){return this.nativeEvent.defaultPrevented}preventDefault(){this.defaultPrevented=!0,this.nativeEvent.preventDefault()}stopPropagation(){this.nativeEvent.stopPropagation(),this.isPropagationStopped=()=>!0}isPropagationStopped(){return!1}persist(){}constructor(e,t){this.nativeEvent=t,this.target=t.target,this.currentTarget=t.currentTarget,this.relatedTarget=t.relatedTarget,this.bubbles=t.bubbles,this.cancelable=t.cancelable,this.defaultPrevented=t.defaultPrevented,this.eventPhase=t.eventPhase,this.isTrusted=t.isTrusted,this.timeStamp=t.timeStamp,this.type=e}}function vE(n){let e=R.useRef({isFocused:!1,onBlur:n,observer:null});return e.current.onBlur=n,gi(()=>{const t=e.current;return()=>{t.observer&&(t.observer.disconnect(),t.observer=null)}},[]),R.useCallback(t=>{if(t.target instanceof HTMLButtonElement||t.target instanceof HTMLInputElement||t.target instanceof HTMLTextAreaElement||t.target instanceof HTMLSelectElement){e.current.isFocused=!0;let r=t.target,i=s=>{var o,a;e.current.isFocused=!1,r.disabled&&((a=(o=e.current).onBlur)===null||a===void 0||a.call(o,new iA("blur",s))),e.current.observer&&(e.current.observer.disconnect(),e.current.observer=null)};r.addEventListener("focusout",i,{once:!0}),e.current.observer=new MutationObserver(()=>{e.current.isFocused&&r.disabled&&(e.current.observer.disconnect(),r.dispatchEvent(new FocusEvent("blur")),r.dispatchEvent(new FocusEvent("focusout",{bubbles:!0})))}),e.current.observer.observe(r,{attributes:!0,attributeFilter:["disabled"]})}},[])}const Mu=jt.createContext(null);Mu.displayName="PressResponderContext";function sA(n){let e=R.useContext(Mu);if(e){let{register:t,...r}=e;n=Mo(r,n),t()}return n_(e,n.ref),n}function s_(n){let{onPress:e,onPressChange:t,onPressStart:r,onPressEnd:i,onPressUp:s,isDisabled:o,isPressed:a,preventFocusOnPress:c,shouldCancelOnPointerExit:u,allowTextSelectionOnPress:l,ref:d,...p}=sA(n),m=R.useRef(null);m.current={onPress:e,onPressChange:t,onPressStart:r,onPressEnd:i,onPressUp:s,isDisabled:o,shouldCancelOnPointerExit:u};let[w,S]=R.useState(!1),v=R.useRef({isPressed:!1,ignoreEmulatedMouseEvents:!1,ignoreClickAfterPress:!1,didFirePressStart:!1,activePointerId:null,target:null,isOverTarget:!1,pointerType:null}),{addGlobalListener:_,removeAllGlobalListeners:b}=Ad(),k=R.useMemo(()=>{let g=v.current,A=(x,U)=>{let{onPressStart:T,onPressChange:N,isDisabled:X}=m.current;X||g.didFirePressStart||(T&&T({type:"pressstart",pointerType:U,target:x.currentTarget,shiftKey:x.shiftKey,metaKey:x.metaKey,ctrlKey:x.ctrlKey,altKey:x.altKey}),N&&N(!0),g.didFirePressStart=!0,S(!0))},M=(x,U,T=!0)=>{let{onPressEnd:N,onPressChange:X,onPress:H,isDisabled:ne}=m.current;g.didFirePressStart&&(g.ignoreClickAfterPress=!0,g.didFirePressStart=!1,N&&N({type:"pressend",pointerType:U,target:x.currentTarget,shiftKey:x.shiftKey,metaKey:x.metaKey,ctrlKey:x.ctrlKey,altKey:x.altKey}),X&&X(!1),S(!1),H&&T&&!ne&&H({type:"press",pointerType:U,target:x.currentTarget,shiftKey:x.shiftKey,metaKey:x.metaKey,ctrlKey:x.ctrlKey,altKey:x.altKey}))},C=(x,U)=>{let{onPressUp:T,isDisabled:N}=m.current;N||T&&T({type:"pressup",pointerType:U,target:x.currentTarget,shiftKey:x.shiftKey,metaKey:x.metaKey,ctrlKey:x.ctrlKey,altKey:x.altKey})},P=x=>{g.isPressed&&(g.isOverTarget&&M(Xn(g.target,x),g.pointerType,!1),g.isPressed=!1,g.isOverTarget=!1,g.activePointerId=null,g.pointerType=null,b(),l||ga(g.target))},I={onKeyDown(x){Ih(x.nativeEvent)&&x.currentTarget.contains(x.target)&&(Hy(x.target)&&x.preventDefault(),x.stopPropagation(),!g.isPressed&&!x.repeat&&(g.target=x.currentTarget,g.isPressed=!0,A(x,"keyboard"),_(document,"keyup",$,!1)))},onKeyUp(x){Ih(x.nativeEvent)&&!x.repeat&&x.currentTarget.contains(x.target)&&C(Xn(g.target,x),"keyboard")},onClick(x){x&&!x.currentTarget.contains(x.target)||x&&x.button===0&&(x.stopPropagation(),o&&x.preventDefault(),!g.ignoreClickAfterPress&&!g.ignoreEmulatedMouseEvents&&(g.pointerType==="virtual"||np(x.nativeEvent))&&(!o&&!c&&_a(x.currentTarget),A(x,"virtual"),C(x,"virtual"),M(x,"virtual")),g.ignoreEmulatedMouseEvents=!1,g.ignoreClickAfterPress=!1)}},$=x=>{if(g.isPressed&&Ih(x)){Hy(x.target)&&x.preventDefault(),x.stopPropagation(),g.isPressed=!1;let U=x.target;M(Xn(g.target,x),"keyboard",g.target.contains(U)),b(),(g.target.contains(U)&&wE(g.target)||g.target.getAttribute("role")==="link")&&g.target.click()}};if(typeof PointerEvent<"u"){I.onPointerDown=N=>{if(!(N.button!==0||!N.currentTarget.contains(N.target))){if(cA(N.nativeEvent)){g.pointerType="virtual";return}Th(N.currentTarget)&&N.preventDefault(),g.pointerType=N.pointerType,N.stopPropagation(),g.isPressed||(g.isPressed=!0,g.isOverTarget=!0,g.activePointerId=N.pointerId,g.target=N.currentTarget,!o&&!c&&_a(N.currentTarget),l||tp(g.target),A(N,g.pointerType),_(document,"pointermove",x,!1),_(document,"pointerup",U,!1),_(document,"pointercancel",T,!1))}},I.onMouseDown=N=>{N.currentTarget.contains(N.target)&&N.button===0&&(Th(N.currentTarget)&&N.preventDefault(),N.stopPropagation())},I.onPointerUp=N=>{!N.currentTarget.contains(N.target)||g.pointerType==="virtual"||N.button===0&&ds(N,N.currentTarget)&&C(N,g.pointerType||N.pointerType)};let x=N=>{N.pointerId===g.activePointerId&&(ds(N,g.target)?g.isOverTarget||(g.isOverTarget=!0,A(Xn(g.target,N),g.pointerType)):g.isOverTarget&&(g.isOverTarget=!1,M(Xn(g.target,N),g.pointerType,!1),m.current.shouldCancelOnPointerExit&&P(N)))},U=N=>{N.pointerId===g.activePointerId&&g.isPressed&&N.button===0&&(ds(N,g.target)?M(Xn(g.target,N),g.pointerType):g.isOverTarget&&M(Xn(g.target,N),g.pointerType,!1),g.isPressed=!1,g.isOverTarget=!1,g.activePointerId=null,g.pointerType=null,b(),l||ga(g.target))},T=N=>{P(N)};I.onDragStart=N=>{N.currentTarget.contains(N.target)&&P(N)}}else{I.onMouseDown=T=>{T.button!==0||!T.currentTarget.contains(T.target)||(Th(T.currentTarget)&&T.preventDefault(),T.stopPropagation(),!g.ignoreEmulatedMouseEvents&&(g.isPressed=!0,g.isOverTarget=!0,g.target=T.currentTarget,g.pointerType=np(T.nativeEvent)?"virtual":"mouse",!o&&!c&&_a(T.currentTarget),A(T,g.pointerType),_(document,"mouseup",x,!1)))},I.onMouseEnter=T=>{T.currentTarget.contains(T.target)&&(T.stopPropagation(),g.isPressed&&!g.ignoreEmulatedMouseEvents&&(g.isOverTarget=!0,A(T,g.pointerType)))},I.onMouseLeave=T=>{T.currentTarget.contains(T.target)&&(T.stopPropagation(),g.isPressed&&!g.ignoreEmulatedMouseEvents&&(g.isOverTarget=!1,M(T,g.pointerType,!1),m.current.shouldCancelOnPointerExit&&P(T)))},I.onMouseUp=T=>{T.currentTarget.contains(T.target)&&!g.ignoreEmulatedMouseEvents&&T.button===0&&C(T,g.pointerType)};let x=T=>{if(T.button===0){if(g.isPressed=!1,b(),g.ignoreEmulatedMouseEvents){g.ignoreEmulatedMouseEvents=!1;return}ds(T,g.target)?M(Xn(g.target,T),g.pointerType):g.isOverTarget&&M(Xn(g.target,T),g.pointerType,!1),g.isOverTarget=!1}};I.onTouchStart=T=>{if(!T.currentTarget.contains(T.target))return;T.stopPropagation();let N=oA(T.nativeEvent);N&&(g.activePointerId=N.identifier,g.ignoreEmulatedMouseEvents=!0,g.isOverTarget=!0,g.isPressed=!0,g.target=T.currentTarget,g.pointerType="touch",!o&&!c&&_a(T.currentTarget),l||tp(g.target),A(T,g.pointerType),_(window,"scroll",U,!0))},I.onTouchMove=T=>{if(!T.currentTarget.contains(T.target)||(T.stopPropagation(),!g.isPressed))return;let N=jy(T.nativeEvent,g.activePointerId);N&&ds(N,T.currentTarget)?g.isOverTarget||(g.isOverTarget=!0,A(T,g.pointerType)):g.isOverTarget&&(g.isOverTarget=!1,M(T,g.pointerType,!1),m.current.shouldCancelOnPointerExit&&P(T))},I.onTouchEnd=T=>{if(!T.currentTarget.contains(T.target)||(T.stopPropagation(),!g.isPressed))return;let N=jy(T.nativeEvent,g.activePointerId);N&&ds(N,T.currentTarget)?(C(T,g.pointerType),M(T,g.pointerType)):g.isOverTarget&&M(T,g.pointerType,!1),g.isPressed=!1,g.activePointerId=null,g.isOverTarget=!1,g.ignoreEmulatedMouseEvents=!0,l||ga(g.target),b()},I.onTouchCancel=T=>{T.currentTarget.contains(T.target)&&(T.stopPropagation(),g.isPressed&&P(T))};let U=T=>{g.isPressed&&T.target.contains(g.target)&&P({currentTarget:g.target,shiftKey:!1,ctrlKey:!1,metaKey:!1,altKey:!1})};I.onDragStart=T=>{T.currentTarget.contains(T.target)&&P(T)}}return I},[_,o,c,b,l]);return R.useEffect(()=>()=>{l||ga(v.current.target)},[l]),{isPressed:a||w,pressProps:Mo(p,k)}}function wE(n){return n.tagName==="A"&&n.hasAttribute("href")}function Ih(n){const{key:e,code:t,target:r}=n,i=r,{tagName:s,isContentEditable:o}=i,a=i.getAttribute("role");return(e==="Enter"||e===" "||e==="Spacebar"||t==="Space")&&s!=="INPUT"&&s!=="TEXTAREA"&&o!==!0&&(!wE(i)||a==="button"&&e!=="Enter")&&!(a==="link"&&e!=="Enter")}function oA(n){const{targetTouches:e}=n;return e.length>0?e[0]:null}function jy(n,e){const t=n.changedTouches;for(let r=0;r<t.length;r++){const i=t[r];if(i.identifier===e)return i}return null}function Xn(n,e){return{currentTarget:n,shiftKey:e.shiftKey,ctrlKey:e.ctrlKey,metaKey:e.metaKey,altKey:e.altKey}}function aA(n){let e=n.width/2||n.radiusX||0,t=n.height/2||n.radiusY||0;return{top:n.clientY-t,right:n.clientX+e,bottom:n.clientY+t,left:n.clientX-e}}function lA(n,e){return!(n.left>e.right||e.left>n.right||n.top>e.bottom||e.top>n.bottom)}function ds(n,e){let t=e.getBoundingClientRect(),r=aA(n);return lA(t,r)}function Th(n){return!n.draggable}function Hy(n){return!((n.tagName==="INPUT"||n.tagName==="BUTTON")&&n.type==="submit")}function cA(n){return n.width===0&&n.height===0||n.width===1&&n.height===1&&n.pressure===0&&n.detail===0&&n.pointerType==="mouse"}const uA=jt.forwardRef(({children:n,...e},t)=>{let r=R.useRef();t=t??r;let{pressProps:i}=s_({...e,ref:t}),s=jt.Children.only(n);return jt.cloneElement(s,{ref:t,...Mo(s.props,i)})});var dA={};lt(dA,"PressResponder",()=>hA);const hA=jt.forwardRef(({children:n,...e},t)=>{let r=R.useRef(!1),i=R.useContext(Mu),s=Mo(i||{},{...e,ref:t||(i==null?void 0:i.ref),register(){r.current=!0,i&&i.register()}});return n_(i,t),R.useEffect(()=>{r.current||console.warn("A PressResponder was rendered without a pressable child. Either call the usePress hook, or wrap your DOM node with <Pressable> component.")},[]),jt.createElement(Mu.Provider,{value:s},n)});var fA={};lt(fA,"useFocus",()=>pA);function pA(n){let{isDisabled:e,onFocus:t,onBlur:r,onFocusChange:i}=n;const s=R.useCallback(c=>{if(c.target===c.currentTarget)return r&&r(c),i&&i(!1),!0},[r,i]),o=vE(s),a=R.useCallback(c=>{c.target===c.currentTarget&&(t&&t(c),i&&i(!0),o(c))},[i,t,o]);return{focusProps:{onFocus:!e&&(t||i||r)?a:void 0,onBlur:!e&&(r||i)?s:null}}}var xo={};lt(xo,"isFocusVisible",()=>o_);lt(xo,"getInteractionModality",()=>wA);lt(xo,"setInteractionModality",()=>bA);lt(xo,"useInteractionModality",()=>SA);lt(xo,"useFocusVisible",()=>bE);lt(xo,"useFocusVisibleListener",()=>SE);let yr=null,ul=new Set,zy=!1,rs=!1,rp=!1;const mA={Tab:!0,Escape:!0};function Pd(n,e){for(let t of ul)t(n,e)}function _A(n){return!(n.metaKey||!Dd()&&n.altKey||n.ctrlKey||n.key==="Control"||n.key==="Shift"||n.key==="Meta")}function Gy(n){rs=!0,_A(n)&&(yr="keyboard",Pd("keyboard",n))}function hs(n){yr="pointer",(n.type==="mousedown"||n.type==="pointerdown")&&(rs=!0,Pd("pointer",n))}function gA(n){np(n)&&(rs=!0,yr="virtual")}function yA(n){n.target===window||n.target===document||(!rs&&!rp&&(yr="virtual",Pd("virtual",n)),rs=!1,rp=!1)}function vA(){rs=!1,rp=!0}function xu(){if(typeof window>"u"||zy)return;let n=HTMLElement.prototype.focus;HTMLElement.prototype.focus=function(){rs=!0,n.apply(this,arguments)},document.addEventListener("keydown",Gy,!0),document.addEventListener("keyup",Gy,!0),document.addEventListener("click",gA,!0),window.addEventListener("focus",yA,!0),window.addEventListener("blur",vA,!1),typeof PointerEvent<"u"?(document.addEventListener("pointerdown",hs,!0),document.addEventListener("pointermove",hs,!0),document.addEventListener("pointerup",hs,!0)):(document.addEventListener("mousedown",hs,!0),document.addEventListener("mousemove",hs,!0),document.addEventListener("mouseup",hs,!0)),zy=!0}typeof document<"u"&&(document.readyState!=="loading"?xu():document.addEventListener("DOMContentLoaded",xu));function o_(){return yr!=="pointer"}function wA(){return yr}function bA(n){yr=n,Pd(n,null)}function SA(){xu();let[n,e]=R.useState(yr);return R.useEffect(()=>{let t=()=>{e(yr)};return ul.add(t),()=>{ul.delete(t)}},[]),n}function EA(n,e,t){return!(n&&e==="keyboard"&&t instanceof KeyboardEvent&&!mA[t.key])}function bE(n={}){let{isTextInput:e,autoFocus:t}=n,[r,i]=R.useState(t||o_());return SE(s=>{i(s)},[e],{isTextInput:e}),{isFocusVisible:r}}function SE(n,e,t){xu(),R.useEffect(()=>{let r=(i,s)=>{EA(t==null?void 0:t.isTextInput,i,s)&&n(o_())};return ul.add(r),()=>{ul.delete(r)}},e)}var kA={};lt(kA,"useFocusWithin",()=>IA);function IA(n){let{isDisabled:e,onBlurWithin:t,onFocusWithin:r,onFocusWithinChange:i}=n,s=R.useRef({isFocusWithin:!1}),o=R.useCallback(u=>{s.current.isFocusWithin&&!u.currentTarget.contains(u.relatedTarget)&&(s.current.isFocusWithin=!1,t&&t(u),i&&i(!1))},[t,i,s]),a=vE(o),c=R.useCallback(u=>{s.current.isFocusWithin||(r&&r(u),i&&i(!0),s.current.isFocusWithin=!0,a(u))},[r,i,a]);return e?{focusWithinProps:{onFocus:null,onBlur:null}}:{focusWithinProps:{onFocus:c,onBlur:o}}}var TA={};lt(TA,"useHover",()=>CA);let Au=!1,Rh=0;function ip(){Au=!0,setTimeout(()=>{Au=!1},50)}function qy(n){n.pointerType==="touch"&&ip()}function RA(){if(!(typeof document>"u"))return typeof PointerEvent<"u"?document.addEventListener("pointerup",qy):document.addEventListener("touchend",ip),Rh++,()=>{Rh--,!(Rh>0)&&(typeof PointerEvent<"u"?document.removeEventListener("pointerup",qy):document.removeEventListener("touchend",ip))}}function CA(n){let{onHoverStart:e,onHoverChange:t,onHoverEnd:r,isDisabled:i}=n,[s,o]=R.useState(!1),a=R.useRef({isHovered:!1,ignoreEmulatedMouseEvents:!1,pointerType:"",target:null}).current;R.useEffect(RA,[]);let{hoverProps:c,triggerHoverEnd:u}=R.useMemo(()=>{let l=(m,w)=>{if(a.pointerType=w,i||w==="touch"||a.isHovered||!m.currentTarget.contains(m.target))return;a.isHovered=!0;let S=m.currentTarget;a.target=S,e&&e({type:"hoverstart",target:S,pointerType:w}),t&&t(!0),o(!0)},d=(m,w)=>{if(a.pointerType="",a.target=null,w==="touch"||!a.isHovered)return;a.isHovered=!1;let S=m.currentTarget;r&&r({type:"hoverend",target:S,pointerType:w}),t&&t(!1),o(!1)},p={};return typeof PointerEvent<"u"?(p.onPointerEnter=m=>{Au&&m.pointerType==="mouse"||l(m,m.pointerType)},p.onPointerLeave=m=>{!i&&m.currentTarget.contains(m.target)&&d(m,m.pointerType)}):(p.onTouchStart=()=>{a.ignoreEmulatedMouseEvents=!0},p.onMouseEnter=m=>{!a.ignoreEmulatedMouseEvents&&!Au&&l(m,"mouse"),a.ignoreEmulatedMouseEvents=!1},p.onMouseLeave=m=>{!i&&m.currentTarget.contains(m.target)&&d(m,"mouse")}),{hoverProps:p,triggerHoverEnd:d}},[e,t,r,i,a]);return R.useEffect(()=>{i&&u({currentTarget:a.target},a.pointerType)},[i]),{hoverProps:c,isHovered:s}}var MA={};lt(MA,"useInteractOutside",()=>xA);function xA(n){let{ref:e,onInteractOutside:t,isDisabled:r,onInteractOutsideStart:i}=n,o=R.useRef({isPointerDown:!1,ignoreEmulatedMouseEvents:!1,onInteractOutside:t,onInteractOutsideStart:i}).current;o.onInteractOutside=t,o.onInteractOutsideStart=i,R.useEffect(()=>{if(r)return;let a=c=>{ic(c,e)&&o.onInteractOutside&&(o.onInteractOutsideStart&&o.onInteractOutsideStart(c),o.isPointerDown=!0)};if(typeof PointerEvent<"u"){let c=u=>{o.isPointerDown&&o.onInteractOutside&&ic(u,e)&&(o.isPointerDown=!1,o.onInteractOutside(u))};return document.addEventListener("pointerdown",a,!0),document.addEventListener("pointerup",c,!0),()=>{document.removeEventListener("pointerdown",a,!0),document.removeEventListener("pointerup",c,!0)}}else{let c=l=>{o.ignoreEmulatedMouseEvents?o.ignoreEmulatedMouseEvents=!1:o.isPointerDown&&o.onInteractOutside&&ic(l,e)&&(o.isPointerDown=!1,o.onInteractOutside(l))},u=l=>{o.ignoreEmulatedMouseEvents=!0,o.onInteractOutside&&o.isPointerDown&&ic(l,e)&&(o.isPointerDown=!1,o.onInteractOutside(l))};return document.addEventListener("mousedown",a,!0),document.addEventListener("mouseup",c,!0),document.addEventListener("touchstart",a,!0),document.addEventListener("touchend",u,!0),()=>{document.removeEventListener("mousedown",a,!0),document.removeEventListener("mouseup",c,!0),document.removeEventListener("touchstart",a,!0),document.removeEventListener("touchend",u,!0)}}},[e,o,r])}function ic(n,e){if(n.button>0)return!1;if(n.target){const t=n.target.ownerDocument;if(!t||!t.documentElement.contains(n.target))return!1}return e.current&&!e.current.contains(n.target)}var AA={};lt(AA,"useKeyboard",()=>DA);function Wy(n){if(!n)return;let e=!0;return t=>{let r={...t,preventDefault(){t.preventDefault()},isDefaultPrevented(){return t.isDefaultPrevented()},stopPropagation(){console.error("stopPropagation is now the default behavior for events in React Spectrum. You can use continuePropagation() to revert this behavior.")},continuePropagation(){e=!1}};n(r),e&&t.stopPropagation()}}function DA(n){return{keyboardProps:n.isDisabled?{}:{onKeyDown:Wy(n.onKeyDown),onKeyUp:Wy(n.onKeyUp)}}}var NA={};lt(NA,"useMove",()=>PA);function PA(n){let{onMoveStart:e,onMove:t,onMoveEnd:r}=n,i=R.useRef({didMove:!1,lastPosition:null,id:null}),{addGlobalListener:s,removeGlobalListener:o}=Ad();return{moveProps:R.useMemo(()=>{let c={},u=()=>{tp(),i.current.didMove=!1},l=(m,w,S,v)=>{S===0&&v===0||(i.current.didMove||(i.current.didMove=!0,e==null||e({type:"movestart",pointerType:w,shiftKey:m.shiftKey,metaKey:m.metaKey,ctrlKey:m.ctrlKey,altKey:m.altKey})),t({type:"move",pointerType:w,deltaX:S,deltaY:v,shiftKey:m.shiftKey,metaKey:m.metaKey,ctrlKey:m.ctrlKey,altKey:m.altKey}))},d=(m,w)=>{ga(),i.current.didMove&&(r==null||r({type:"moveend",pointerType:w,shiftKey:m.shiftKey,metaKey:m.metaKey,ctrlKey:m.ctrlKey,altKey:m.altKey}))};if(typeof PointerEvent>"u"){let m=_=>{_.button===0&&(l(_,"mouse",_.pageX-i.current.lastPosition.pageX,_.pageY-i.current.lastPosition.pageY),i.current.lastPosition={pageX:_.pageX,pageY:_.pageY})},w=_=>{_.button===0&&(d(_,"mouse"),o(window,"mousemove",m,!1),o(window,"mouseup",w,!1))};c.onMouseDown=_=>{_.button===0&&(u(),_.stopPropagation(),_.preventDefault(),i.current.lastPosition={pageX:_.pageX,pageY:_.pageY},s(window,"mousemove",m,!1),s(window,"mouseup",w,!1))};let S=_=>{let b=[..._.changedTouches].findIndex(({identifier:k})=>k===i.current.id);if(b>=0){let{pageX:k,pageY:g}=_.changedTouches[b];l(_,"touch",k-i.current.lastPosition.pageX,g-i.current.lastPosition.pageY),i.current.lastPosition={pageX:k,pageY:g}}},v=_=>{[..._.changedTouches].findIndex(({identifier:k})=>k===i.current.id)>=0&&(d(_,"touch"),i.current.id=null,o(window,"touchmove",S),o(window,"touchend",v),o(window,"touchcancel",v))};c.onTouchStart=_=>{if(_.changedTouches.length===0||i.current.id!=null)return;let{pageX:b,pageY:k,identifier:g}=_.changedTouches[0];u(),_.stopPropagation(),_.preventDefault(),i.current.lastPosition={pageX:b,pageY:k},i.current.id=g,s(window,"touchmove",S,!1),s(window,"touchend",v,!1),s(window,"touchcancel",v,!1)}}else{let m=S=>{if(S.pointerId===i.current.id){let v=S.pointerType||"mouse";l(S,v,S.pageX-i.current.lastPosition.pageX,S.pageY-i.current.lastPosition.pageY),i.current.lastPosition={pageX:S.pageX,pageY:S.pageY}}},w=S=>{if(S.pointerId===i.current.id){let v=S.pointerType||"mouse";d(S,v),i.current.id=null,o(window,"pointermove",m,!1),o(window,"pointerup",w,!1),o(window,"pointercancel",w,!1)}};c.onPointerDown=S=>{S.button===0&&i.current.id==null&&(u(),S.stopPropagation(),S.preventDefault(),i.current.lastPosition={pageX:S.pageX,pageY:S.pageY},i.current.id=S.pointerId,s(window,"pointermove",m,!1),s(window,"pointerup",w,!1),s(window,"pointercancel",w,!1))}}let p=(m,w,S)=>{u(),l(m,"keyboard",w,S),d(m,"keyboard")};return c.onKeyDown=m=>{switch(m.key){case"Left":case"ArrowLeft":m.preventDefault(),m.stopPropagation(),p(m,-1,0);break;case"Right":case"ArrowRight":m.preventDefault(),m.stopPropagation(),p(m,1,0);break;case"Up":case"ArrowUp":m.preventDefault(),m.stopPropagation(),p(m,0,-1);break;case"Down":case"ArrowDown":m.preventDefault(),m.stopPropagation(),p(m,0,1);break}},c},[i,e,t,r,s,o])}}var OA={};lt(OA,"useScrollWheel",()=>UA);function UA(n,e){let{onScroll:t,isDisabled:r}=n,i=R.useCallback(s=>{s.ctrlKey||(s.preventDefault(),s.stopPropagation(),t&&t({deltaX:s.deltaX,deltaY:s.deltaY}))},[t]);gE(e,"wheel",r?null:i)}var $A={};lt($A,"useLongPress",()=>FA);const LA=500;function FA(n){let{isDisabled:e,onLongPressStart:t,onLongPressEnd:r,onLongPress:i,threshold:s=LA,accessibilityDescription:o}=n;const a=R.useRef(null);let{addGlobalListener:c,removeGlobalListener:u}=Ad(),{pressProps:l}=s_({isDisabled:e,onPressStart(p){if((p.pointerType==="mouse"||p.pointerType==="touch")&&(t&&t({...p,type:"longpressstart"}),a.current=setTimeout(()=>{p.target.dispatchEvent(new PointerEvent("pointercancel",{bubbles:!0})),i&&i({...p,type:"longpress"}),a.current=null},s),p.pointerType==="touch")){let m=w=>{w.preventDefault()};c(p.target,"contextmenu",m,{once:!0}),c(window,"pointerup",()=>{setTimeout(()=>{u(p.target,"contextmenu",m)},30)},{once:!0})}},onPressEnd(p){a.current&&clearTimeout(a.current),r&&(p.pointerType==="mouse"||p.pointerType==="touch")&&r({...p,type:"longpressend"})}}),d=fE(i&&!e?o:null);return{longPressProps:Mo(l,d)}}const BA="/sw.js";let VA=0;function EE(n,e){const t=`atom${++VA}`,r={toString:()=>t};return typeof n=="function"?r.read=n:(r.init=n,r.read=i=>i(r),r.write=(i,s,o)=>s(r,typeof o=="function"?o(i(r)):o)),e&&(r.write=e),r}const Ch=n=>"init"in n,Mh=n=>!!n.write,Du=new WeakMap,KA=(n,e)=>{Du.set(n,e),n.catch(()=>{}).finally(()=>Du.delete(n))},Yy=(n,e)=>{const t=Du.get(n);t&&(Du.delete(n),t(e))},Xy=(n,e)=>{n.status="fulfilled",n.value=e},Jy=(n,e)=>{n.status="rejected",n.reason=e},sc=(n,e)=>"v"in n&&"v"in e&&Object.is(n.v,e.v),Qy=(n,e)=>"e"in n&&"e"in e&&Object.is(n.e,e.e),xh=n=>"v"in n&&n.v instanceof Promise,oc=n=>{if("e"in n)throw n.e;return n.v},kE=()=>{var n,e;const t=new WeakMap,r=new WeakMap,i=new Map;let s,o;((n={BASE_URL:"/",MODE:"production",DEV:!1,PROD:!0,SSR:!1})==null?void 0:n.MODE)!=="production"&&(s=new Set,o=new Set);const a=I=>t.get(I),c=(I,$)=>{var x;((x={BASE_URL:"/",MODE:"production",DEV:!1,PROD:!0,SSR:!1})==null?void 0:x.MODE)!=="production"&&Object.freeze($);const U=t.get(I);if(t.set(I,$),i.has(I)||i.set(I,U),U&&xh(U)){const T="v"in $?$.v instanceof Promise?$.v:Promise.resolve($.v):Promise.reject($.e);Yy(U.v,T)}},u=(I,$,x)=>{const U=new Map;let T=!1;x.forEach(N=>{var X;const H=N===I?$:a(N);H?(U.set(N,H),$.d.get(N)!==H&&(T=!0)):((X={BASE_URL:"/",MODE:"production",DEV:!1,PROD:!0,SSR:!1})==null?void 0:X.MODE)!=="production"&&console.warn("[Bug] atom state not found")}),(T||$.d.size!==U.size)&&($.d=U)},l=(I,$,x)=>{const U=a(I),T={d:(U==null?void 0:U.d)||new Map,v:$};return x&&u(I,T,x),U&&sc(U,T)&&U.d===T.d?U:(c(I,T),T)},d=(I,$,x)=>{const U=a(I),T={d:(U==null?void 0:U.d)||new Map,e:$};return x&&u(I,T,x),U&&Qy(U,T)&&U.d===T.d?U:(c(I,T),T)},p=I=>{const $=a(I);if($&&($.d.forEach((ne,me)=>{me!==I&&!r.has(me)&&p(me)}),Array.from($.d).every(([ne,me])=>ne===I||a(ne)===me)))return $;const x=new Set;let U=!0;const T=ne=>{if(x.add(ne),ne===I){const _e=a(ne);if(_e)return oc(_e);if(Ch(ne))return ne.init;throw new Error("no atom init")}const me=p(ne);return oc(me)};let N,X;const H={get signal(){return N||(N=new AbortController),N.signal},get setSelf(){var ne;return((ne={BASE_URL:"/",MODE:"production",DEV:!1,PROD:!0,SSR:!1})==null?void 0:ne.MODE)!=="production"&&!Mh(I)&&console.warn("setSelf function cannot be used with read-only atom"),!X&&Mh(I)&&(X=(...me)=>{var _e;if(((_e={BASE_URL:"/",MODE:"production",DEV:!1,PROD:!0,SSR:!1})==null?void 0:_e.MODE)!=="production"&&U&&console.warn("setSelf function cannot be called in sync"),!U)return k(I,...me)}),X}};try{const ne=I.read(T,H);if(ne instanceof Promise){let me;const _e=new Promise((He,O)=>{let W=!1;ne.then(j=>{W||(W=!0,l(I,_e,x),Xy(_e,j),He(j))},j=>{W||(W=!0,l(I,_e,x),Jy(_e,j),O(j))}),me=j=>{W||(W=!0,j.then(de=>Xy(_e,de),de=>Jy(_e,de)),He(j))}});return _e.status="pending",KA(_e,He=>{He&&me(He),N==null||N.abort()}),l(I,_e,x)}return l(I,ne,x)}catch(ne){return d(I,ne,x)}finally{U=!1}},m=I=>oc(p(I)),w=I=>{let $=r.get(I);return $||($=g(I)),$},S=(I,$)=>!$.l.size&&(!$.t.size||$.t.size===1&&$.t.has(I)),v=I=>{const $=r.get(I);$&&S(I,$)&&A(I)},_=I=>{const $=r.get(I);$==null||$.t.forEach(x=>{if(x!==I){const U=a(x),T=p(x);(!U||!sc(U,T))&&_(x)}})},b=(I,...$)=>{let x=!0;const U=X=>oc(p(X)),T=(X,...H)=>{let ne;if(X===I){if(!Ch(X))throw new Error("atom not writable");const me=a(X),_e=l(X,H[0]);(!me||!sc(me,_e))&&_(X)}else ne=b(X,...H);return x||C(),ne},N=I.write(U,T,...$);return x=!1,N},k=(I,...$)=>{const x=b(I,...$);return C(),x},g=(I,$)=>{var x;const U={t:new Set($&&[$]),l:new Set};if(r.set(I,U),((x={BASE_URL:"/",MODE:"production",DEV:!1,PROD:!0,SSR:!1})==null?void 0:x.MODE)!=="production"&&o.add(I),p(I).d.forEach((T,N)=>{const X=r.get(N);X?X.t.add(I):N!==I&&g(N,I)}),p(I),Mh(I)&&I.onMount){const T=I.onMount((...N)=>k(I,...N));T&&(U.u=T)}return U},A=I=>{var $,x,U;const T=($=r.get(I))==null?void 0:$.u;T&&T(),r.delete(I),((x={BASE_URL:"/",MODE:"production",DEV:!1,PROD:!0,SSR:!1})==null?void 0:x.MODE)!=="production"&&o.delete(I);const N=a(I);N?(xh(N)&&Yy(N.v),N.d.forEach((X,H)=>{if(H!==I){const ne=r.get(H);ne&&(ne.t.delete(I),S(H,ne)&&A(H))}})):((U={BASE_URL:"/",MODE:"production",DEV:!1,PROD:!0,SSR:!1})==null?void 0:U.MODE)!=="production"&&console.warn("[Bug] could not find atom state to unmount",I)},M=(I,$,x)=>{const U=new Set($.d.keys());x==null||x.forEach((T,N)=>{if(U.has(N)){U.delete(N);return}const X=r.get(N);X&&(X.t.delete(I),S(N,X)&&A(N))}),U.forEach(T=>{const N=r.get(T);N?N.t.add(I):r.has(I)&&g(T,I)})},C=()=>{for(var I;i.size;){const $=Array.from(i);i.clear(),$.forEach(([x,U])=>{var T;const N=a(x);if(N){N.d!==(U==null?void 0:U.d)&&M(x,N,U==null?void 0:U.d);const X=r.get(x);X&&!(U&&!xh(U)&&(sc(U,N)||Qy(U,N)))&&X.l.forEach(H=>H())}else((T={BASE_URL:"/",MODE:"production",DEV:!1,PROD:!0,SSR:!1})==null?void 0:T.MODE)!=="production"&&console.warn("[Bug] no atom state to flush")})}((I={BASE_URL:"/",MODE:"production",DEV:!1,PROD:!0,SSR:!1})==null?void 0:I.MODE)!=="production"&&s.forEach($=>$())},P=(I,$)=>{const x=w(I);C();const U=x.l;return U.add($),()=>{U.delete($),v(I)}};return((e={BASE_URL:"/",MODE:"production",DEV:!1,PROD:!0,SSR:!1})==null?void 0:e.MODE)!=="production"?{get:m,set:k,sub:P,dev_subscribe_state:I=>(s.add(I),()=>{s.delete(I)}),dev_get_mounted_atoms:()=>o.values(),dev_get_atom_state:I=>t.get(I),dev_get_mounted:I=>r.get(I),dev_restore_atoms:I=>{for(const[$,x]of I)Ch($)&&(l($,x),_($));C()}}:{get:m,set:k,sub:P}};let Ah;const jA=()=>(Ah||(Ah=kE()),Ah),IE=R.createContext(void 0),TE=n=>{const e=R.useContext(IE);return(n==null?void 0:n.store)||e||jA()},HA=({children:n,store:e})=>{const t=R.useRef();return!e&&!t.current&&(t.current=kE()),R.createElement(IE.Provider,{value:e||t.current},n)},zA=n=>n instanceof Promise,GA=jt.use||(n=>{if(n.status==="pending")throw n;if(n.status==="fulfilled")return n.value;throw n.status==="rejected"?n.reason:(n.status="pending",n.then(e=>{n.status="fulfilled",n.value=e},e=>{n.status="rejected",n.reason=e}),n)});function qA(n,e){const t=TE(e),[[r,i,s],o]=R.useReducer(u=>{const l=t.get(n);return Object.is(u[0],l)&&u[1]===t&&u[2]===n?u:[l,t,n]},void 0,()=>[t.get(n),t,n]);let a=r;(i!==t||s!==n)&&(o(),a=t.get(n));const c=e==null?void 0:e.delay;return R.useEffect(()=>{const u=t.sub(n,()=>{if(typeof c=="number"){setTimeout(o,c);return}o()});return o(),u},[t,n,c]),R.useDebugValue(a),zA(a)?GA(a):a}function RE(n,e){const t=TE(e);return R.useCallback((...i)=>{var s;if(((s={BASE_URL:"/",MODE:"production",DEV:!1,PROD:!0,SSR:!1})==null?void 0:s.MODE)!=="production"&&!("write"in n))throw new Error("not writable atom");return t.set(n,...i)},[t,n])}function dK(n,e){return[qA(n,e),RE(n,e)]}var Zy=/[\\\"\x00-\x1F]/g,Sr={};for(var ac=0;ac<32;++ac)Sr[String.fromCharCode(ac)]="\\U"+("0000"+ac.toString(16)).slice(-4).toUpperCase();Sr["\b"]="\\b";Sr["	"]="\\t";Sr[`
`]="\\n";Sr["\f"]="\\f";Sr["\r"]="\\r";Sr['"']='\\"';Sr["\\"]="\\\\";function CE(n){return Zy.lastIndex=0,n.replace(Zy,function(e){return Sr[e]})}function a_(n){switch(typeof n){case"string":return'"'+CE(n)+'"';case"number":return isFinite(n)?n:"null";case"boolean":return n;case"object":return n===null?"null":Array.isArray(n)?WA(n):YA(n);default:throw new Error("Cannot stringify: "+typeof n)}}function WA(n){for(var e="[",t="",r=0;r<n.length;++r)t+=e,e=",",t+=a_(n[r]);return e!=","?"[]":t+"]"}function YA(n){var e="{",t="",r=Object.keys(n);r.sort();for(var i=0;i<r.length;++i){var s=r[i];t+=e+'"'+CE(s)+'":',e=",",t+=a_(n[s])}return e!=","?"{}":t+"}"}var XA={stringify:a_};const Cl=mo(XA);var JA={exports:{}};const QA={},ZA=Object.freeze(Object.defineProperty({__proto__:null,default:QA},Symbol.toStringTag,{value:"Module"})),lc=gk(ZA);(function(n,e){// @license magnet:?xt=urn:btih:8e4f440f4c65981c5bf93c76d35135ba5064d8b7&dn=apache-2.0.txt Apache-2.0
var t=function(){var r={},i,s,o=(()=>{var c=typeof document<"u"&&document.currentScript?document.currentScript.src:void 0;return typeof __filename<"u"&&(c=c||__filename),function(u){u=u||{};var l;l||(l=typeof u<"u"?u:{});var d,p;l.ready=new Promise(function(f,h){d=f,p=h});var m;if(typeof window<"u")m=function(f){window.crypto.getRandomValues(f)};else if(n.exports){var w=lc;m=function(f){var h=w.randomBytes(f.length);f.set(h)},process=_k.process}else throw Error("Cannot find global to attach library to");if(typeof OLM_OPTIONS<"u")for(var S in OLM_OPTIONS)OLM_OPTIONS.hasOwnProperty(S)&&(l[S]=OLM_OPTIONS[S]);l.onRuntimeInitialized=function(){Ve=l._olm_error(),r.PRIVATE_KEY_LENGTH=l._olm_pk_private_key_length(),i&&i()},l.onAbort=function(f){s&&s(f)};var v=Object.assign({},l),_=typeof window=="object",b=typeof importScripts=="function",k=typeof process=="object"&&typeof process.versions=="object"&&typeof process.versions.node=="string",g="",A,M,C,P,I,$;k?(g=b?lc.dirname(g)+"/":__dirname+"/",$=()=>{I||(P=lc,I=lc)},A=function(f,h){return $(),f=I.normalize(f),P.readFileSync(f,h?void 0:"utf8")},C=f=>(f=A(f,!0),f.buffer||(f=new Uint8Array(f)),f),M=(f,h,y)=>{$(),f=I.normalize(f),P.readFile(f,function(E,D){E?y(E):h(D.buffer)})},1<process.argv.length&&process.argv[1].replace(/\\/g,"/"),process.argv.slice(2),process.on("uncaughtException",function(f){throw f}),process.on("unhandledRejection",function(f){throw f}),l.inspect=function(){return"[Emscripten Module object]"}):(_||b)&&(b?g=self.location.href:typeof document<"u"&&document.currentScript&&(g=document.currentScript.src),c&&(g=c),g.indexOf("blob:")!==0?g=g.substr(0,g.replace(/[?#].*/,"").lastIndexOf("/")+1):g="",A=f=>{var h=new XMLHttpRequest;return h.open("GET",f,!1),h.send(null),h.responseText},b&&(C=f=>{var h=new XMLHttpRequest;return h.open("GET",f,!1),h.responseType="arraybuffer",h.send(null),new Uint8Array(h.response)}),M=(f,h,y)=>{var E=new XMLHttpRequest;E.open("GET",f,!0),E.responseType="arraybuffer",E.onload=()=>{E.status==200||E.status==0&&E.response?h(E.response):y()},E.onerror=y,E.send(null)}),l.print||console.log.bind(console);var x=l.printErr||console.warn.bind(console);Object.assign(l,v),v=null;var U;l.wasmBinary&&(U=l.wasmBinary),l.noExitRuntime,typeof WebAssembly!="object"&&Gn("no native wasm support detected");var T,N=!1,X=typeof TextDecoder<"u"?new TextDecoder("utf8"):void 0;function H(f,h){if(f){var y=O,E=f+h;for(h=f;y[h]&&!(h>=E);)++h;if(16<h-f&&y.buffer&&X)f=X.decode(y.subarray(f,h));else{for(E="";f<h;){var D=y[f++];if(D&128){var K=y[f++]&63;if((D&224)==192)E+=String.fromCharCode((D&31)<<6|K);else{var Y=y[f++]&63;D=(D&240)==224?(D&15)<<12|K<<6|Y:(D&7)<<18|K<<12|Y<<6|y[f++]&63,65536>D?E+=String.fromCharCode(D):(D-=65536,E+=String.fromCharCode(55296|D>>10,56320|D&1023))}}else E+=String.fromCharCode(D)}f=E}}else f="";return f}function ne(f,h,y,E){if(!(0<E))return 0;var D=y;E=y+E-1;for(var K=0;K<f.length;++K){var Y=f.charCodeAt(K);if(55296<=Y&&57343>=Y){var ce=f.charCodeAt(++K);Y=65536+((Y&1023)<<10)|ce&1023}if(127>=Y){if(y>=E)break;h[y++]=Y}else{if(2047>=Y){if(y+1>=E)break;h[y++]=192|Y>>6}else{if(65535>=Y){if(y+2>=E)break;h[y++]=224|Y>>12}else{if(y+3>=E)break;h[y++]=240|Y>>18,h[y++]=128|Y>>12&63}h[y++]=128|Y>>6&63}h[y++]=128|Y&63}}return h[y]=0,y-D}function me(f){for(var h=0,y=0;y<f.length;++y){var E=f.charCodeAt(y);127>=E?h++:2047>=E?h+=2:55296<=E&&57343>=E?(h+=4,++y):h+=3}return h}var _e,He,O,W,j,de,ee,et;function Rt(){var f=T.buffer;_e=f,l.HEAP8=He=new Int8Array(f),l.HEAP16=W=new Int16Array(f),l.HEAP32=j=new Int32Array(f),l.HEAPU8=O=new Uint8Array(f),l.HEAPU16=new Uint16Array(f),l.HEAPU32=de=new Uint32Array(f),l.HEAPF32=ee=new Float32Array(f),l.HEAPF64=et=new Float64Array(f)}var un=[],Ut=[],Oo=[];function Ir(){var f=l.preRun.shift();un.unshift(f)}var gt=0,zn=null;function Gn(f){throw l.onAbort&&l.onAbort(f),f="Aborted("+f+")",x(f),N=!0,f=new WebAssembly.RuntimeError(f+". Build with -sASSERTIONS for more info."),p(f),f}function qn(){return tt.startsWith("data:application/octet-stream;base64,")}var tt;if(tt="olm.wasm",!qn()){var bi=tt;tt=l.locateFile?l.locateFile(bi,g):g+bi}function Uo(){var f=tt;try{if(f==tt&&U)return new Uint8Array(U);if(C)return C(f);throw"both async and sync fetching of the wasm failed"}catch(h){Gn(h)}}function $o(){if(!U&&(_||b)){if(typeof fetch=="function"&&!tt.startsWith("file://"))return fetch(tt,{credentials:"same-origin"}).then(function(f){if(!f.ok)throw"failed to load wasm binary file at '"+tt+"'";return f.arrayBuffer()}).catch(function(){return Uo()});if(M)return new Promise(function(f,h){M(tt,function(y){f(new Uint8Array(y))},h)})}return Promise.resolve().then(function(){return Uo()})}var Wn;function En(f){for(;0<f.length;)f.shift()(l)}function dn(f,h="i8"){switch(h.endsWith("*")&&(h="*"),h){case"i1":return He[f>>0];case"i8":return He[f>>0];case"i16":return W[f>>1];case"i32":return j[f>>2];case"i64":return j[f>>2];case"float":return ee[f>>2];case"double":return et[f>>3];case"*":return de[f>>2];default:Gn("invalid type for getValue: "+h)}return null}function hn(f){var h="i8";switch(h.endsWith("*")&&(h="*"),h){case"i1":He[f>>0]=0;break;case"i8":He[f>>0]=0;break;case"i16":W[f>>1]=0;break;case"i32":j[f>>2]=0;break;case"i64":Wn=[0,0],j[f>>2]=Wn[0],j[f+4>>2]=Wn[1];break;case"float":ee[f>>2]=0;break;case"double":et[f>>3]=0;break;case"*":de[f>>2]=0;break;default:Gn("invalid type for setValue: "+h)}}function Tr(f,h,y){for(var E=0;E<f.length;++E)He[h++>>0]=f.charCodeAt(E);y||(He[h>>0]=0)}function Lo(f,h,y){return y=Array(0<y?y:me(f)+1),f=ne(f,y,0,y.length),h&&(y.length=f),y}var Fo={b:function(f,h,y){O.copyWithin(f,h,h+y)},a:function(f){var h=O.length;if(f>>>=0,2147483648<f)return!1;for(var y=1;4>=y;y*=2){var E=h*(1+.2/y);E=Math.min(E,f+100663296);var D=Math;E=Math.max(f,E),D=D.min.call(D,2147483648,E+(65536-E%65536)%65536);e:{try{T.grow(D-_e.byteLength+65535>>>16),Rt();var K=1;break e}catch{}K=void 0}if(K)return!0}return!1}};(function(){function f(D){l.asm=D.exports,T=l.asm.c,Rt(),Ut.unshift(l.asm.d),gt--,l.monitorRunDependencies&&l.monitorRunDependencies(gt),gt==0&&zn&&(D=zn,zn=null,D())}function h(D){f(D.instance)}function y(D){return $o().then(function(K){return WebAssembly.instantiate(K,E)}).then(function(K){return K}).then(D,function(K){x("failed to asynchronously prepare wasm: "+K),Gn(K)})}var E={a:Fo};if(gt++,l.monitorRunDependencies&&l.monitorRunDependencies(gt),l.instantiateWasm)try{return l.instantiateWasm(E,f)}catch(D){return x("Module.instantiateWasm callback failed with error: "+D),!1}return function(){return U||typeof WebAssembly.instantiateStreaming!="function"||qn()||tt.startsWith("file://")||k||typeof fetch!="function"?y(h):fetch(tt,{credentials:"same-origin"}).then(function(D){return WebAssembly.instantiateStreaming(D,E).then(h,function(K){return x("wasm streaming compile failed: "+K),x("falling back to ArrayBuffer instantiation"),y(h)})})}().catch(p),{}})(),l.___wasm_call_ctors=function(){return(l.___wasm_call_ctors=l.asm.d).apply(null,arguments)},l._olm_get_library_version=function(){return(l._olm_get_library_version=l.asm.f).apply(null,arguments)},l._olm_error=function(){return(l._olm_error=l.asm.g).apply(null,arguments)},l._olm_account_last_error=function(){return(l._olm_account_last_error=l.asm.h).apply(null,arguments)},l.__olm_error_to_string=function(){return(l.__olm_error_to_string=l.asm.i).apply(null,arguments)},l._olm_account_last_error_code=function(){return(l._olm_account_last_error_code=l.asm.j).apply(null,arguments)},l._olm_session_last_error=function(){return(l._olm_session_last_error=l.asm.k).apply(null,arguments)},l._olm_session_last_error_code=function(){return(l._olm_session_last_error_code=l.asm.l).apply(null,arguments)},l._olm_utility_last_error=function(){return(l._olm_utility_last_error=l.asm.m).apply(null,arguments)},l._olm_utility_last_error_code=function(){return(l._olm_utility_last_error_code=l.asm.n).apply(null,arguments)},l._olm_account_size=function(){return(l._olm_account_size=l.asm.o).apply(null,arguments)},l._olm_session_size=function(){return(l._olm_session_size=l.asm.p).apply(null,arguments)},l._olm_utility_size=function(){return(l._olm_utility_size=l.asm.q).apply(null,arguments)},l._olm_account=function(){return(l._olm_account=l.asm.r).apply(null,arguments)},l._olm_session=function(){return(l._olm_session=l.asm.s).apply(null,arguments)},l._olm_utility=function(){return(l._olm_utility=l.asm.t).apply(null,arguments)},l._olm_clear_account=function(){return(l._olm_clear_account=l.asm.u).apply(null,arguments)},l._olm_clear_session=function(){return(l._olm_clear_session=l.asm.v).apply(null,arguments)},l._olm_clear_utility=function(){return(l._olm_clear_utility=l.asm.w).apply(null,arguments)},l._olm_pickle_account_length=function(){return(l._olm_pickle_account_length=l.asm.x).apply(null,arguments)},l._olm_pickle_session_length=function(){return(l._olm_pickle_session_length=l.asm.y).apply(null,arguments)},l._olm_pickle_account=function(){return(l._olm_pickle_account=l.asm.z).apply(null,arguments)},l._olm_pickle_session=function(){return(l._olm_pickle_session=l.asm.A).apply(null,arguments)},l._olm_unpickle_account=function(){return(l._olm_unpickle_account=l.asm.B).apply(null,arguments)},l._olm_unpickle_session=function(){return(l._olm_unpickle_session=l.asm.C).apply(null,arguments)},l._olm_create_account_random_length=function(){return(l._olm_create_account_random_length=l.asm.D).apply(null,arguments)},l._olm_create_account=function(){return(l._olm_create_account=l.asm.E).apply(null,arguments)},l._olm_account_identity_keys_length=function(){return(l._olm_account_identity_keys_length=l.asm.F).apply(null,arguments)},l._olm_account_identity_keys=function(){return(l._olm_account_identity_keys=l.asm.G).apply(null,arguments)},l._olm_account_signature_length=function(){return(l._olm_account_signature_length=l.asm.H).apply(null,arguments)},l._olm_account_sign=function(){return(l._olm_account_sign=l.asm.I).apply(null,arguments)},l._olm_account_one_time_keys_length=function(){return(l._olm_account_one_time_keys_length=l.asm.J).apply(null,arguments)},l._olm_account_one_time_keys=function(){return(l._olm_account_one_time_keys=l.asm.K).apply(null,arguments)},l._olm_account_mark_keys_as_published=function(){return(l._olm_account_mark_keys_as_published=l.asm.L).apply(null,arguments)},l._olm_account_max_number_of_one_time_keys=function(){return(l._olm_account_max_number_of_one_time_keys=l.asm.M).apply(null,arguments)},l._olm_account_generate_one_time_keys_random_length=function(){return(l._olm_account_generate_one_time_keys_random_length=l.asm.N).apply(null,arguments)},l._olm_account_generate_one_time_keys=function(){return(l._olm_account_generate_one_time_keys=l.asm.O).apply(null,arguments)},l._olm_account_generate_fallback_key_random_length=function(){return(l._olm_account_generate_fallback_key_random_length=l.asm.P).apply(null,arguments)},l._olm_account_generate_fallback_key=function(){return(l._olm_account_generate_fallback_key=l.asm.Q).apply(null,arguments)},l._olm_account_fallback_key_length=function(){return(l._olm_account_fallback_key_length=l.asm.R).apply(null,arguments)},l._olm_account_fallback_key=function(){return(l._olm_account_fallback_key=l.asm.S).apply(null,arguments)},l._olm_account_unpublished_fallback_key_length=function(){return(l._olm_account_unpublished_fallback_key_length=l.asm.T).apply(null,arguments)},l._olm_account_unpublished_fallback_key=function(){return(l._olm_account_unpublished_fallback_key=l.asm.U).apply(null,arguments)},l._olm_account_forget_old_fallback_key=function(){return(l._olm_account_forget_old_fallback_key=l.asm.V).apply(null,arguments)},l._olm_create_outbound_session_random_length=function(){return(l._olm_create_outbound_session_random_length=l.asm.W).apply(null,arguments)},l._olm_create_outbound_session=function(){return(l._olm_create_outbound_session=l.asm.X).apply(null,arguments)},l._olm_create_inbound_session=function(){return(l._olm_create_inbound_session=l.asm.Y).apply(null,arguments)},l._olm_create_inbound_session_from=function(){return(l._olm_create_inbound_session_from=l.asm.Z).apply(null,arguments)},l._olm_session_id_length=function(){return(l._olm_session_id_length=l.asm._).apply(null,arguments)},l._olm_session_id=function(){return(l._olm_session_id=l.asm.$).apply(null,arguments)},l._olm_session_has_received_message=function(){return(l._olm_session_has_received_message=l.asm.aa).apply(null,arguments)},l._olm_session_describe=function(){return(l._olm_session_describe=l.asm.ba).apply(null,arguments)},l._olm_matches_inbound_session=function(){return(l._olm_matches_inbound_session=l.asm.ca).apply(null,arguments)},l._olm_matches_inbound_session_from=function(){return(l._olm_matches_inbound_session_from=l.asm.da).apply(null,arguments)},l._olm_remove_one_time_keys=function(){return(l._olm_remove_one_time_keys=l.asm.ea).apply(null,arguments)},l._olm_encrypt_message_type=function(){return(l._olm_encrypt_message_type=l.asm.fa).apply(null,arguments)},l._olm_encrypt_random_length=function(){return(l._olm_encrypt_random_length=l.asm.ga).apply(null,arguments)},l._olm_encrypt_message_length=function(){return(l._olm_encrypt_message_length=l.asm.ha).apply(null,arguments)},l._olm_encrypt=function(){return(l._olm_encrypt=l.asm.ia).apply(null,arguments)},l._olm_decrypt_max_plaintext_length=function(){return(l._olm_decrypt_max_plaintext_length=l.asm.ja).apply(null,arguments)},l._olm_decrypt=function(){return(l._olm_decrypt=l.asm.ka).apply(null,arguments)},l._olm_sha256_length=function(){return(l._olm_sha256_length=l.asm.la).apply(null,arguments)},l._olm_sha256=function(){return(l._olm_sha256=l.asm.ma).apply(null,arguments)},l._olm_ed25519_verify=function(){return(l._olm_ed25519_verify=l.asm.na).apply(null,arguments)},l._olm_pk_encryption_last_error=function(){return(l._olm_pk_encryption_last_error=l.asm.oa).apply(null,arguments)},l._olm_pk_encryption_last_error_code=function(){return(l._olm_pk_encryption_last_error_code=l.asm.pa).apply(null,arguments)},l._olm_pk_encryption_size=function(){return(l._olm_pk_encryption_size=l.asm.qa).apply(null,arguments)},l._olm_pk_encryption=function(){return(l._olm_pk_encryption=l.asm.ra).apply(null,arguments)},l._olm_clear_pk_encryption=function(){return(l._olm_clear_pk_encryption=l.asm.sa).apply(null,arguments)},l._olm_pk_encryption_set_recipient_key=function(){return(l._olm_pk_encryption_set_recipient_key=l.asm.ta).apply(null,arguments)},l._olm_pk_key_length=function(){return(l._olm_pk_key_length=l.asm.ua).apply(null,arguments)},l._olm_pk_ciphertext_length=function(){return(l._olm_pk_ciphertext_length=l.asm.va).apply(null,arguments)},l._olm_pk_mac_length=function(){return(l._olm_pk_mac_length=l.asm.wa).apply(null,arguments)},l._olm_pk_encrypt_random_length=function(){return(l._olm_pk_encrypt_random_length=l.asm.xa).apply(null,arguments)},l._olm_pk_encrypt=function(){return(l._olm_pk_encrypt=l.asm.ya).apply(null,arguments)},l._olm_pk_decryption_last_error=function(){return(l._olm_pk_decryption_last_error=l.asm.za).apply(null,arguments)},l._olm_pk_decryption_last_error_code=function(){return(l._olm_pk_decryption_last_error_code=l.asm.Aa).apply(null,arguments)},l._olm_pk_decryption_size=function(){return(l._olm_pk_decryption_size=l.asm.Ba).apply(null,arguments)},l._olm_pk_decryption=function(){return(l._olm_pk_decryption=l.asm.Ca).apply(null,arguments)},l._olm_clear_pk_decryption=function(){return(l._olm_clear_pk_decryption=l.asm.Da).apply(null,arguments)},l._olm_pk_private_key_length=function(){return(l._olm_pk_private_key_length=l.asm.Ea).apply(null,arguments)},l._olm_pk_generate_key_random_length=function(){return(l._olm_pk_generate_key_random_length=l.asm.Fa).apply(null,arguments)},l._olm_pk_key_from_private=function(){return(l._olm_pk_key_from_private=l.asm.Ga).apply(null,arguments)},l._olm_pk_generate_key=function(){return(l._olm_pk_generate_key=l.asm.Ha).apply(null,arguments)},l._olm_pickle_pk_decryption_length=function(){return(l._olm_pickle_pk_decryption_length=l.asm.Ia).apply(null,arguments)},l._olm_pickle_pk_decryption=function(){return(l._olm_pickle_pk_decryption=l.asm.Ja).apply(null,arguments)},l._olm_unpickle_pk_decryption=function(){return(l._olm_unpickle_pk_decryption=l.asm.Ka).apply(null,arguments)},l._olm_pk_max_plaintext_length=function(){return(l._olm_pk_max_plaintext_length=l.asm.La).apply(null,arguments)},l._olm_pk_decrypt=function(){return(l._olm_pk_decrypt=l.asm.Ma).apply(null,arguments)},l._olm_pk_get_private_key=function(){return(l._olm_pk_get_private_key=l.asm.Na).apply(null,arguments)},l._olm_pk_signing_size=function(){return(l._olm_pk_signing_size=l.asm.Oa).apply(null,arguments)},l._olm_pk_signing=function(){return(l._olm_pk_signing=l.asm.Pa).apply(null,arguments)},l._olm_pk_signing_last_error=function(){return(l._olm_pk_signing_last_error=l.asm.Qa).apply(null,arguments)},l._olm_pk_signing_last_error_code=function(){return(l._olm_pk_signing_last_error_code=l.asm.Ra).apply(null,arguments)},l._olm_clear_pk_signing=function(){return(l._olm_clear_pk_signing=l.asm.Sa).apply(null,arguments)},l._olm_pk_signing_seed_length=function(){return(l._olm_pk_signing_seed_length=l.asm.Ta).apply(null,arguments)},l._olm_pk_signing_public_key_length=function(){return(l._olm_pk_signing_public_key_length=l.asm.Ua).apply(null,arguments)},l._olm_pk_signing_key_from_seed=function(){return(l._olm_pk_signing_key_from_seed=l.asm.Va).apply(null,arguments)},l._olm_pk_signature_length=function(){return(l._olm_pk_signature_length=l.asm.Wa).apply(null,arguments)},l._olm_pk_sign=function(){return(l._olm_pk_sign=l.asm.Xa).apply(null,arguments)},l._olm_inbound_group_session_size=function(){return(l._olm_inbound_group_session_size=l.asm.Ya).apply(null,arguments)},l._olm_inbound_group_session=function(){return(l._olm_inbound_group_session=l.asm.Za).apply(null,arguments)},l._olm_clear_inbound_group_session=function(){return(l._olm_clear_inbound_group_session=l.asm._a).apply(null,arguments)},l._olm_inbound_group_session_last_error=function(){return(l._olm_inbound_group_session_last_error=l.asm.$a).apply(null,arguments)},l._olm_inbound_group_session_last_error_code=function(){return(l._olm_inbound_group_session_last_error_code=l.asm.ab).apply(null,arguments)},l._olm_init_inbound_group_session=function(){return(l._olm_init_inbound_group_session=l.asm.bb).apply(null,arguments)},l._olm_import_inbound_group_session=function(){return(l._olm_import_inbound_group_session=l.asm.cb).apply(null,arguments)},l._olm_pickle_inbound_group_session_length=function(){return(l._olm_pickle_inbound_group_session_length=l.asm.db).apply(null,arguments)},l._olm_pickle_inbound_group_session=function(){return(l._olm_pickle_inbound_group_session=l.asm.eb).apply(null,arguments)},l._olm_unpickle_inbound_group_session=function(){return(l._olm_unpickle_inbound_group_session=l.asm.fb).apply(null,arguments)},l._olm_group_decrypt_max_plaintext_length=function(){return(l._olm_group_decrypt_max_plaintext_length=l.asm.gb).apply(null,arguments)},l._olm_group_decrypt=function(){return(l._olm_group_decrypt=l.asm.hb).apply(null,arguments)},l._olm_inbound_group_session_id_length=function(){return(l._olm_inbound_group_session_id_length=l.asm.ib).apply(null,arguments)},l._olm_inbound_group_session_id=function(){return(l._olm_inbound_group_session_id=l.asm.jb).apply(null,arguments)},l._olm_inbound_group_session_first_known_index=function(){return(l._olm_inbound_group_session_first_known_index=l.asm.kb).apply(null,arguments)},l._olm_inbound_group_session_is_verified=function(){return(l._olm_inbound_group_session_is_verified=l.asm.lb).apply(null,arguments)},l._olm_export_inbound_group_session_length=function(){return(l._olm_export_inbound_group_session_length=l.asm.mb).apply(null,arguments)},l._olm_export_inbound_group_session=function(){return(l._olm_export_inbound_group_session=l.asm.nb).apply(null,arguments)},l._olm_outbound_group_session_size=function(){return(l._olm_outbound_group_session_size=l.asm.ob).apply(null,arguments)},l._olm_outbound_group_session=function(){return(l._olm_outbound_group_session=l.asm.pb).apply(null,arguments)},l._olm_clear_outbound_group_session=function(){return(l._olm_clear_outbound_group_session=l.asm.qb).apply(null,arguments)},l._olm_outbound_group_session_last_error=function(){return(l._olm_outbound_group_session_last_error=l.asm.rb).apply(null,arguments)},l._olm_outbound_group_session_last_error_code=function(){return(l._olm_outbound_group_session_last_error_code=l.asm.sb).apply(null,arguments)},l._olm_pickle_outbound_group_session_length=function(){return(l._olm_pickle_outbound_group_session_length=l.asm.tb).apply(null,arguments)},l._olm_pickle_outbound_group_session=function(){return(l._olm_pickle_outbound_group_session=l.asm.ub).apply(null,arguments)},l._olm_unpickle_outbound_group_session=function(){return(l._olm_unpickle_outbound_group_session=l.asm.vb).apply(null,arguments)},l._olm_init_outbound_group_session_random_length=function(){return(l._olm_init_outbound_group_session_random_length=l.asm.wb).apply(null,arguments)},l._olm_init_outbound_group_session=function(){return(l._olm_init_outbound_group_session=l.asm.xb).apply(null,arguments)},l._olm_group_encrypt_message_length=function(){return(l._olm_group_encrypt_message_length=l.asm.yb).apply(null,arguments)},l._olm_group_encrypt=function(){return(l._olm_group_encrypt=l.asm.zb).apply(null,arguments)},l._olm_outbound_group_session_id_length=function(){return(l._olm_outbound_group_session_id_length=l.asm.Ab).apply(null,arguments)},l._olm_outbound_group_session_id=function(){return(l._olm_outbound_group_session_id=l.asm.Bb).apply(null,arguments)},l._olm_outbound_group_session_message_index=function(){return(l._olm_outbound_group_session_message_index=l.asm.Cb).apply(null,arguments)},l._olm_outbound_group_session_key_length=function(){return(l._olm_outbound_group_session_key_length=l.asm.Db).apply(null,arguments)},l._olm_outbound_group_session_key=function(){return(l._olm_outbound_group_session_key=l.asm.Eb).apply(null,arguments)},l._olm_sas_last_error=function(){return(l._olm_sas_last_error=l.asm.Fb).apply(null,arguments)},l._olm_sas_last_error_code=function(){return(l._olm_sas_last_error_code=l.asm.Gb).apply(null,arguments)},l._olm_sas_size=function(){return(l._olm_sas_size=l.asm.Hb).apply(null,arguments)},l._olm_sas=function(){return(l._olm_sas=l.asm.Ib).apply(null,arguments)},l._olm_clear_sas=function(){return(l._olm_clear_sas=l.asm.Jb).apply(null,arguments)},l._olm_create_sas_random_length=function(){return(l._olm_create_sas_random_length=l.asm.Kb).apply(null,arguments)},l._olm_create_sas=function(){return(l._olm_create_sas=l.asm.Lb).apply(null,arguments)},l._olm_sas_pubkey_length=function(){return(l._olm_sas_pubkey_length=l.asm.Mb).apply(null,arguments)},l._olm_sas_get_pubkey=function(){return(l._olm_sas_get_pubkey=l.asm.Nb).apply(null,arguments)},l._olm_sas_set_their_key=function(){return(l._olm_sas_set_their_key=l.asm.Ob).apply(null,arguments)},l._olm_sas_is_their_key_set=function(){return(l._olm_sas_is_their_key_set=l.asm.Pb).apply(null,arguments)},l._olm_sas_generate_bytes=function(){return(l._olm_sas_generate_bytes=l.asm.Qb).apply(null,arguments)},l._olm_sas_mac_length=function(){return(l._olm_sas_mac_length=l.asm.Rb).apply(null,arguments)},l._olm_sas_calculate_mac_fixed_base64=function(){return(l._olm_sas_calculate_mac_fixed_base64=l.asm.Sb).apply(null,arguments)},l._olm_sas_calculate_mac=function(){return(l._olm_sas_calculate_mac=l.asm.Tb).apply(null,arguments)},l._olm_sas_calculate_mac_long_kdf=function(){return(l._olm_sas_calculate_mac_long_kdf=l.asm.Ub).apply(null,arguments)},l._malloc=function(){return(l._malloc=l.asm.Vb).apply(null,arguments)},l._free=function(){return(l._free=l.asm.Wb).apply(null,arguments)};var Bo=l.stackSave=function(){return(Bo=l.stackSave=l.asm.Xb).apply(null,arguments)},ls=l.stackRestore=function(){return(ls=l.stackRestore=l.asm.Yb).apply(null,arguments)},cs=l.stackAlloc=function(){return(cs=l.stackAlloc=l.asm.Zb).apply(null,arguments)};l.intArrayFromString=Lo,l.writeAsciiToMemory=Tr,l.ALLOC_STACK=1;var $t;zn=function f(){$t||Si(),$t||(zn=f)};function Si(){function f(){if(!$t&&($t=!0,l.calledRun=!0,!N)){if(En(Ut),d(l),l.onRuntimeInitialized&&l.onRuntimeInitialized(),l.postRun)for(typeof l.postRun=="function"&&(l.postRun=[l.postRun]);l.postRun.length;){var h=l.postRun.shift();Oo.unshift(h)}En(Oo)}}if(!(0<gt)){if(l.preRun)for(typeof l.preRun=="function"&&(l.preRun=[l.preRun]);l.preRun.length;)Ir();En(un),0<gt||(l.setStatus?(l.setStatus("Running..."),setTimeout(function(){setTimeout(function(){l.setStatus("")},1),f()},1)):f())}}if(l.preInit)for(typeof l.preInit=="function"&&(l.preInit=[l.preInit]);0<l.preInit.length;)l.preInit.pop()();Si();function Lt(){var f=l._olm_outbound_group_session_size();this.ac=ge(f),this.$b=l._olm_outbound_group_session(this.ac)}function Be(f){return function(){var h=f.apply(this,arguments);if(h===Ve)throw h=H(l._olm_outbound_group_session_last_error(arguments[0])),Error("OLM."+h);return h}}Lt.prototype.free=function(){l._olm_clear_outbound_group_session(this.$b),Ee(this.$b)},Lt.prototype.pickle=q(function(f){f=Z(f);var h=Be(l._olm_pickle_outbound_group_session_length)(this.$b),y=B(f),E=B(h+1);try{Be(l._olm_pickle_outbound_group_session)(this.$b,y,f.length,E,h)}finally{for(Q(y,f.length),y=0;y<f.length;y++)f[y]=0}return H(E,h)}),Lt.prototype.unpickle=q(function(f,h){f=Z(f);var y=B(f);h=Z(h);var E=B(h);try{Be(l._olm_unpickle_outbound_group_session)(this.$b,y,f.length,E,h.length)}finally{for(Q(y,f.length),y=0;y<f.length;y++)f[y]=0}}),Lt.prototype.create=q(function(){var f=Be(l._olm_init_outbound_group_session_random_length)(this.$b),h=vt(f,m);try{Be(l._olm_init_outbound_group_session)(this.$b,h,f)}finally{Q(h,f)}}),Lt.prototype.encrypt=function(f){try{var h=me(f),y=Be(l._olm_group_encrypt_message_length)(this.$b,h),E=ge(h+1);ne(f,O,E,h+1);var D=ge(y+1);return Be(l._olm_group_encrypt)(this.$b,E,h,D,y),hn(D+y),H(D,y)}finally{E!==void 0&&(Q(E,h+1),Ee(E)),D!==void 0&&Ee(D)}},Lt.prototype.session_id=q(function(){var f=Be(l._olm_outbound_group_session_id_length)(this.$b),h=B(f+1);return Be(l._olm_outbound_group_session_id)(this.$b,h,f),H(h,f)}),Lt.prototype.session_key=q(function(){var f=Be(l._olm_outbound_group_session_key_length)(this.$b),h=B(f+1);Be(l._olm_outbound_group_session_key)(this.$b,h,f);var y=H(h,f);return Q(h,f),y}),Lt.prototype.message_index=function(){return Be(l._olm_outbound_group_session_message_index)(this.$b)},r.OutboundGroupSession=Lt;function Yt(){var f=l._olm_inbound_group_session_size();this.ac=ge(f),this.$b=l._olm_inbound_group_session(this.ac)}function Ft(f){return function(){var h=f.apply(this,arguments);if(h===Ve)throw h=H(l._olm_inbound_group_session_last_error(arguments[0])),Error("OLM."+h);return h}}Yt.prototype.free=function(){l._olm_clear_inbound_group_session(this.$b),Ee(this.$b)},Yt.prototype.pickle=q(function(f){f=Z(f);var h=Ft(l._olm_pickle_inbound_group_session_length)(this.$b),y=B(f),E=B(h+1);try{Ft(l._olm_pickle_inbound_group_session)(this.$b,y,f.length,E,h)}finally{for(Q(y,f.length),y=0;y<f.length;y++)f[y]=0}return H(E,h)}),Yt.prototype.unpickle=q(function(f,h){f=Z(f);var y=B(f);h=Z(h);var E=B(h);try{Ft(l._olm_unpickle_inbound_group_session)(this.$b,y,f.length,E,h.length)}finally{for(Q(y,f.length),y=0;y<f.length;y++)f[y]=0}}),Yt.prototype.create=q(function(f){f=Z(f);var h=B(f);try{Ft(l._olm_init_inbound_group_session)(this.$b,h,f.length)}finally{for(Q(h,f.length),h=0;h<f.length;h++)f[h]=0}}),Yt.prototype.import_session=q(function(f){f=Z(f);var h=B(f);try{Ft(l._olm_import_inbound_group_session)(this.$b,h,f.length)}finally{for(Q(h,f.length),h=0;h<f.length;h++)f[h]=0}}),Yt.prototype.decrypt=q(function(f){try{var h=ge(f.length);Tr(f,h,!0);var y=Ft(l._olm_group_decrypt_max_plaintext_length)(this.$b,h,f.length);Tr(f,h,!0);var E=ge(y+1),D=B(4),K=Ft(l._olm_group_decrypt)(this.$b,h,f.length,E,y,D);return hn(E+K),{plaintext:H(E,K),message_index:dn(D,"i32")}}finally{h!==void 0&&Ee(h),E!==void 0&&(Q(E,K),Ee(E))}}),Yt.prototype.session_id=q(function(){var f=Ft(l._olm_inbound_group_session_id_length)(this.$b),h=B(f+1);return Ft(l._olm_inbound_group_session_id)(this.$b,h,f),H(h,f)}),Yt.prototype.first_known_index=q(function(){return Ft(l._olm_inbound_group_session_first_known_index)(this.$b)}),Yt.prototype.export_session=q(function(f){var h=Ft(l._olm_export_inbound_group_session_length)(this.$b),y=B(h+1);return Be(l._olm_export_inbound_group_session)(this.$b,y,h,f),f=H(y,h),Q(y,h),f}),r.InboundGroupSession=Yt;function Xt(){var f=l._olm_pk_encryption_size();this.ac=ge(f),this.$b=l._olm_pk_encryption(this.ac)}function Ct(f){return function(){var h=f.apply(this,arguments);if(h===Ve)throw h=H(l._olm_pk_encryption_last_error(arguments[0])),Error("OLM."+h);return h}}Xt.prototype.free=function(){l._olm_clear_pk_encryption(this.$b),Ee(this.$b)},Xt.prototype.set_recipient_key=q(function(f){f=Z(f);var h=B(f);Ct(l._olm_pk_encryption_set_recipient_key)(this.$b,h,f.length)}),Xt.prototype.encrypt=q(function(f){try{var h=me(f),y=ge(h+1);ne(f,O,y,h+1);var E=Ct(l._olm_pk_encrypt_random_length)(),D=vt(E,m),K=Ct(l._olm_pk_ciphertext_length)(this.$b,h),Y=ge(K+1),ce=Ct(l._olm_pk_mac_length)(this.$b),In=B(ce+1);hn(In+ce);var De=Ct(l._olm_pk_key_length)(),Bt=B(De+1);return hn(Bt+De),Ct(l._olm_pk_encrypt)(this.$b,y,h,Y,K,In,ce,Bt,De,D,E),hn(Y+K),{ciphertext:H(Y,K),mac:H(In,ce),ephemeral:H(Bt,De)}}finally{D!==void 0&&Q(D,E),y!==void 0&&(Q(y,h+1),Ee(y)),Y!==void 0&&Ee(Y)}});function kn(){var f=l._olm_pk_decryption_size();this.ac=ge(f),this.$b=l._olm_pk_decryption(this.ac)}function yt(f){return function(){var h=f.apply(this,arguments);if(h===Ve)throw h=H(l._olm_pk_decryption_last_error(arguments[0])),Error("OLM."+h);return h}}kn.prototype.free=function(){l._olm_clear_pk_decryption(this.$b),Ee(this.$b)},kn.prototype.init_with_private_key=q(function(f){var h=B(f.length);l.HEAPU8.set(f,h);var y=yt(l._olm_pk_key_length)(),E=B(y+1);try{yt(l._olm_pk_key_from_private)(this.$b,E,y,h,f.length)}finally{Q(h,f.length)}return H(E,y)}),kn.prototype.generate_key=q(function(){var f=yt(l._olm_pk_private_key_length)(),h=vt(f,m),y=yt(l._olm_pk_key_length)(),E=B(y+1);try{yt(l._olm_pk_key_from_private)(this.$b,E,y,h,f)}finally{Q(h,f)}return H(E,y)}),kn.prototype.get_private_key=q(function(){var f=Ct(l._olm_pk_private_key_length)(),h=B(f);yt(l._olm_pk_get_private_key)(this.$b,h,f);var y=new Uint8Array(new Uint8Array(l.HEAPU8.buffer,h,f));return Q(h,f),y}),kn.prototype.pickle=q(function(f){f=Z(f);var h=yt(l._olm_pickle_pk_decryption_length)(this.$b),y=B(f),E=B(h+1);try{yt(l._olm_pickle_pk_decryption)(this.$b,y,f.length,E,h)}finally{for(Q(y,f.length),y=0;y<f.length;y++)f[y]=0}return H(E,h)}),kn.prototype.unpickle=q(function(f,h){f=Z(f);var y=B(f),E=Z(h),D=B(E);h=yt(l._olm_pk_key_length)();var K=B(h+1);try{yt(l._olm_unpickle_pk_decryption)(this.$b,y,f.length,D,E.length,K,h)}finally{for(Q(y,f.length),y=0;y<f.length;y++)f[y]=0}return H(K,h)}),kn.prototype.decrypt=q(function(f,h,y){try{var E=me(y),D=ge(E+1);ne(y,O,D,E+1);var K=Z(f),Y=B(K),ce=Z(h),In=B(ce),De=yt(l._olm_pk_max_plaintext_length)(this.$b,E),Bt=ge(De+1),Ko=yt(l._olm_pk_decrypt)(this.$b,Y,K.length,In,ce.length,D,E,Bt,De);return hn(Bt+Ko),H(Bt,Ko)}finally{Bt!==void 0&&(Q(Bt,Ko+1),Ee(Bt)),D!==void 0&&Ee(D)}});function Yn(){var f=l._olm_pk_signing_size();this.ac=ge(f),this.$b=l._olm_pk_signing(this.ac)}function Rr(f){return function(){var h=f.apply(this,arguments);if(h===Ve)throw h=H(l._olm_pk_signing_last_error(arguments[0])),Error("OLM."+h);return h}}Yn.prototype.free=function(){l._olm_clear_pk_signing(this.$b),Ee(this.$b)},Yn.prototype.init_with_seed=q(function(f){var h=B(f.length);l.HEAPU8.set(f,h);var y=Rr(l._olm_pk_signing_public_key_length)(),E=B(y+1);try{Rr(l._olm_pk_signing_key_from_seed)(this.$b,E,y,h,f.length)}finally{Q(h,f.length)}return H(E,y)}),Yn.prototype.generate_seed=q(function(){var f=Rr(l._olm_pk_signing_seed_length)(),h=vt(f,m),y=new Uint8Array(new Uint8Array(l.HEAPU8.buffer,h,f));return Q(h,f),y}),Yn.prototype.sign=q(function(f){try{var h=me(f),y=ge(h+1);ne(f,O,y,h+1);var E=Rr(l._olm_pk_signature_length)(),D=B(E+1);return Rr(l._olm_pk_sign)(this.$b,y,h,D,E),H(D,E)}finally{y!==void 0&&(Q(y,h+1),Ee(y))}});function Jt(){var f=l._olm_sas_size(),h=l._olm_create_sas_random_length(),y=vt(h,m);this.ac=ge(f),this.$b=l._olm_sas(this.ac),l._olm_create_sas(this.$b,y,h),Q(y,h)}function ct(f){return function(){var h=f.apply(this,arguments);if(h===Ve)throw h=H(l._olm_sas_last_error(arguments[0])),Error("OLM."+h);return h}}Jt.prototype.free=function(){l._olm_clear_sas(this.$b),Ee(this.$b)},Jt.prototype.get_pubkey=q(function(){var f=ct(l._olm_sas_pubkey_length)(this.$b),h=B(f+1);return ct(l._olm_sas_get_pubkey)(this.$b,h,f),H(h,f)}),Jt.prototype.set_their_key=q(function(f){f=Z(f);var h=B(f);ct(l._olm_sas_set_their_key)(this.$b,h,f.length)}),Jt.prototype.is_their_key_set=q(function(){return!!ct(l._olm_sas_is_their_key_set)(this.$b)}),Jt.prototype.generate_bytes=q(function(f,h){f=Z(f);var y=B(f),E=B(h);return ct(l._olm_sas_generate_bytes)(this.$b,y,f.length,E,h),new Uint8Array(new Uint8Array(l.HEAPU8.buffer,E,h))}),Jt.prototype.calculate_mac=q(function(f,h){f=Z(f);var y=B(f);h=Z(h);var E=B(h),D=ct(l._olm_sas_mac_length)(this.$b),K=B(D+1);return ct(l._olm_sas_calculate_mac)(this.$b,y,f.length,E,h.length,K,D),H(K,D)}),Jt.prototype.calculate_mac_fixed_base64=q(function(f,h){f=Z(f);var y=B(f);h=Z(h);var E=B(h),D=ct(l._olm_sas_mac_length)(this.$b),K=B(D+1);return ct(l._olm_sas_calculate_mac_fixed_base64)(this.$b,y,f.length,E,h.length,K,D),H(K,D)}),Jt.prototype.calculate_mac_long_kdf=q(function(f,h){f=Z(f);var y=B(f);h=Z(h);var E=B(h),D=ct(l._olm_sas_mac_length)(this.$b),K=B(D+1);return ct(l._olm_sas_calculate_mac_long_kdf)(this.$b,y,f.length,E,h.length,K,D),H(K,D)});var ge=l._malloc,Ee=l._free,Ve;function vt(f,h){var y=cs(f);return h(new Uint8Array(l.HEAPU8.buffer,y,f)),y}function B(f){return typeof f=="number"?vt(f,function(h){h.fill(0)}):vt(f.length,function(h){h.set(f)})}function Z(f){return f instanceof Uint8Array?f:Lo(f,!0)}function q(f){return function(){var h=Bo();try{return f.apply(this,arguments)}finally{ls(h)}}}function Q(f,h){for(;0<h--;)l.HEAP8[f++]=0}function ve(){var f=l._olm_account_size();this.ac=ge(f),this.$b=l._olm_account(this.ac)}function we(f){return function(){var h=f.apply(this,arguments);if(h===Ve)throw h=H(l._olm_account_last_error(arguments[0])),Error("OLM."+h);return h}}ve.prototype.free=function(){l._olm_clear_account(this.$b),Ee(this.$b)},ve.prototype.create=q(function(){var f=we(l._olm_create_account_random_length)(this.$b),h=vt(f,m);try{we(l._olm_create_account)(this.$b,h,f)}finally{Q(h,f)}}),ve.prototype.identity_keys=q(function(){var f=we(l._olm_account_identity_keys_length)(this.$b),h=B(f+1);return we(l._olm_account_identity_keys)(this.$b,h,f),H(h,f)}),ve.prototype.sign=q(function(f){var h=we(l._olm_account_signature_length)(this.$b);f=Z(f);var y=B(f),E=B(h+1);try{we(l._olm_account_sign)(this.$b,y,f.length,E,h)}finally{for(Q(y,f.length),y=0;y<f.length;y++)f[y]=0}return H(E,h)}),ve.prototype.one_time_keys=q(function(){var f=we(l._olm_account_one_time_keys_length)(this.$b),h=B(f+1);return we(l._olm_account_one_time_keys)(this.$b,h,f),H(h,f)}),ve.prototype.mark_keys_as_published=q(function(){we(l._olm_account_mark_keys_as_published)(this.$b)}),ve.prototype.max_number_of_one_time_keys=q(function(){return we(l._olm_account_max_number_of_one_time_keys)(this.$b)}),ve.prototype.generate_one_time_keys=q(function(f){var h=we(l._olm_account_generate_one_time_keys_random_length)(this.$b,f),y=vt(h,m);try{we(l._olm_account_generate_one_time_keys)(this.$b,f,y,h)}finally{Q(y,h)}}),ve.prototype.remove_one_time_keys=q(function(f){we(l._olm_remove_one_time_keys)(this.$b,f.$b)}),ve.prototype.generate_fallback_key=q(function(){var f=we(l._olm_account_generate_fallback_key_random_length)(this.$b),h=vt(f,m);try{we(l._olm_account_generate_fallback_key)(this.$b,h,f)}finally{Q(h,f)}}),ve.prototype.fallback_key=q(function(){var f=we(l._olm_account_fallback_key_length)(this.$b),h=B(f+1);return we(l._olm_account_fallback_key)(this.$b,h,f),H(h,f)}),ve.prototype.unpublished_fallback_key=q(function(){var f=we(l._olm_account_unpublished_fallback_key_length)(this.$b),h=B(f+1);return we(l._olm_account_unpublished_fallback_key)(this.$b,h,f),H(h,f)}),ve.prototype.forget_old_fallback_key=q(function(){we(l._olm_account_forget_old_fallback_key)(this.$b)}),ve.prototype.pickle=q(function(f){f=Z(f);var h=we(l._olm_pickle_account_length)(this.$b),y=B(f),E=B(h+1);try{we(l._olm_pickle_account)(this.$b,y,f.length,E,h)}finally{for(Q(y,f.length),y=0;y<f.length;y++)f[y]=0}return H(E,h)}),ve.prototype.unpickle=q(function(f,h){f=Z(f);var y=B(f);h=Z(h);var E=B(h);try{we(l._olm_unpickle_account)(this.$b,y,f.length,E,h.length)}finally{for(Q(y,f.length),y=0;y<f.length;y++)f[y]=0}});function nt(){var f=l._olm_session_size();this.ac=ge(f),this.$b=l._olm_session(this.ac)}function Ae(f){return function(){var h=f.apply(this,arguments);if(h===Ve)throw h=H(l._olm_session_last_error(arguments[0])),Error("OLM."+h);return h}}nt.prototype.free=function(){l._olm_clear_session(this.$b),Ee(this.$b)},nt.prototype.pickle=q(function(f){f=Z(f);var h=Ae(l._olm_pickle_session_length)(this.$b),y=B(f),E=B(h+1);try{Ae(l._olm_pickle_session)(this.$b,y,f.length,E,h)}finally{for(Q(y,f.length),y=0;y<f.length;y++)f[y]=0}return H(E,h)}),nt.prototype.unpickle=q(function(f,h){f=Z(f);var y=B(f);h=Z(h);var E=B(h);try{Ae(l._olm_unpickle_session)(this.$b,y,f.length,E,h.length)}finally{for(Q(y,f.length),y=0;y<f.length;y++)f[y]=0}}),nt.prototype.create_outbound=q(function(f,h,y){var E=Ae(l._olm_create_outbound_session_random_length)(this.$b),D=vt(E,m);h=Z(h),y=Z(y);var K=B(h),Y=B(y);try{Ae(l._olm_create_outbound_session)(this.$b,f.$b,K,h.length,Y,y.length,D,E)}finally{Q(D,E)}}),nt.prototype.create_inbound=q(function(f,h){h=Z(h);var y=B(h);try{Ae(l._olm_create_inbound_session)(this.$b,f.$b,y,h.length)}finally{for(Q(y,h.length),f=0;f<h.length;f++)h[f]=0}}),nt.prototype.create_inbound_from=q(function(f,h,y){h=Z(h);var E=B(h);y=Z(y);var D=B(y);try{Ae(l._olm_create_inbound_session_from)(this.$b,f.$b,E,h.length,D,y.length)}finally{for(Q(D,y.length),f=0;f<y.length;f++)y[f]=0}}),nt.prototype.session_id=q(function(){var f=Ae(l._olm_session_id_length)(this.$b),h=B(f+1);return Ae(l._olm_session_id)(this.$b,h,f),H(h,f)}),nt.prototype.has_received_message=function(){return!!Ae(l._olm_session_has_received_message)(this.$b)},nt.prototype.matches_inbound=q(function(f){f=Z(f);var h=B(f);return!!Ae(l._olm_matches_inbound_session)(this.$b,h,f.length)}),nt.prototype.matches_inbound_from=q(function(f,h){f=Z(f);var y=B(f);h=Z(h);var E=B(h);return!!Ae(l._olm_matches_inbound_session_from)(this.$b,y,f.length,E,h.length)}),nt.prototype.encrypt=q(function(f){try{var h=Ae(l._olm_encrypt_random_length)(this.$b),y=Ae(l._olm_encrypt_message_type)(this.$b),E=me(f),D=Ae(l._olm_encrypt_message_length)(this.$b,E),K=vt(h,m),Y=ge(E+1);ne(f,O,Y,E+1);var ce=ge(D+1);return Ae(l._olm_encrypt)(this.$b,Y,E,K,h,ce,D),hn(ce+D),{type:y,body:H(ce,D)}}finally{K!==void 0&&Q(K,h),Y!==void 0&&(Q(Y,E+1),Ee(Y)),ce!==void 0&&Ee(ce)}}),nt.prototype.decrypt=q(function(f,h){try{var y=ge(h.length);Tr(h,y,!0);var E=Ae(l._olm_decrypt_max_plaintext_length)(this.$b,f,y,h.length);Tr(h,y,!0);var D=ge(E+1),K=Ae(l._olm_decrypt)(this.$b,f,y,h.length,D,E);return hn(D+K),H(D,K)}finally{y!==void 0&&Ee(y),D!==void 0&&(Q(D,E),Ee(D))}}),nt.prototype.describe=q(function(){try{var f=ge(256);return Ae(l._olm_session_describe)(this.$b,f,256),H(f)}finally{f!==void 0&&Ee(f)}});function Ei(){var f=l._olm_utility_size();this.ac=ge(f),this.$b=l._olm_utility(this.ac)}function Vo(f){return function(){var h=f.apply(this,arguments);if(h===Ve)throw h=H(l._olm_utility_last_error(arguments[0])),Error("OLM."+h);return h}}return Ei.prototype.free=function(){l._olm_clear_utility(this.$b),Ee(this.$b)},Ei.prototype.sha256=q(function(f){var h=Vo(l._olm_sha256_length)(this.$b);f=Z(f);var y=B(f),E=B(h+1);try{Vo(l._olm_sha256)(this.$b,y,f.length,E,h)}finally{for(Q(y,f.length),y=0;y<f.length;y++)f[y]=0}return H(E,h)}),Ei.prototype.ed25519_verify=q(function(f,h,y){f=Z(f);var E=B(f);h=Z(h);var D=B(h);y=Z(y);var K=B(y);try{Vo(l._olm_ed25519_verify)(this.$b,E,f.length,D,h.length,K,y.length)}finally{for(Q(D,h.length),f=0;f<h.length;f++)h[f]=0}}),r.Account=ve,r.Session=nt,r.Utility=Ei,r.PkEncryption=Xt,r.PkDecryption=kn,r.PkSigning=Yn,r.SAS=Jt,r.get_library_version=q(function(){var f=B(3);return l._olm_get_library_version(f,f+1,f+2),[dn(f,"i8"),dn(f+1,"i8"),dn(f+2,"i8")]}),u.ready}})();n.exports=o;var a;return r.init=function(c){return a||(c&&(OLM_OPTIONS=c),a=new Promise(function(u,l){i=function(){u()},s=function(d){l(d)},o()}),a)},r}();typeof window<"u"&&(window.Olm=t),n.exports=t;// @license-end 
})(JA);var zi={};(function(){for(var n="ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz0123456789+/",e=new Uint8Array(256),t=0;t<n.length;t++)e[n.charCodeAt(t)]=t;zi.encode=function(r){var i=new Uint8Array(r),s,o=i.length,a="";for(s=0;s<o;s+=3)a+=n[i[s]>>2],a+=n[(i[s]&3)<<4|i[s+1]>>4],a+=n[(i[s+1]&15)<<2|i[s+2]>>6],a+=n[i[s+2]&63];return o%3===2?a=a.substring(0,a.length-1)+"=":o%3===1&&(a=a.substring(0,a.length-2)+"=="),a},zi.decode=function(r){var i=r.length*.75,s=r.length,o,a=0,c,u,l,d;r[r.length-1]==="="&&(i--,r[r.length-2]==="="&&i--);var p=new ArrayBuffer(i),m=new Uint8Array(p);for(o=0;o<s;o+=4)c=e[r.charCodeAt(o)],u=e[r.charCodeAt(o+1)],l=e[r.charCodeAt(o+2)],d=e[r.charCodeAt(o+3)],m[a++]=c<<2|u>>4,m[a++]=(u&15)<<4|l>>2,m[a++]=(l&3)<<6|d&63;return p}})();/*! @license DOMPurify 2.3.6 | (c) Cure53 and other contributors | Released under the Apache license 2.0 and Mozilla Public License 2.0 | github.com/cure53/DOMPurify/blob/2.3.6/LICENSE */function eD(n){if(Array.isArray(n)){for(var e=0,t=Array(n.length);e<n.length;e++)t[e]=n[e];return t}else return Array.from(n)}var tD=Object.hasOwnProperty,ev=Object.setPrototypeOf,nD=Object.isFrozen,rD=Object.getPrototypeOf,iD=Object.getOwnPropertyDescriptor,It=Object.freeze,Vn=Object.seal,sD=Object.create,ME=typeof Reflect<"u"&&Reflect,Nu=ME.apply,sp=ME.construct;Nu||(Nu=function(e,t,r){return e.apply(t,r)});It||(It=function(e){return e});Vn||(Vn=function(e){return e});sp||(sp=function(e,t){return new(Function.prototype.bind.apply(e,[null].concat(eD(t))))});var oD=Sn(Array.prototype.forEach),tv=Sn(Array.prototype.pop),na=Sn(Array.prototype.push),jc=Sn(String.prototype.toLowerCase),nv=Sn(String.prototype.match),Cr=Sn(String.prototype.replace),aD=Sn(String.prototype.indexOf),lD=Sn(String.prototype.trim),xt=Sn(RegExp.prototype.test),Dh=cD(TypeError);function Sn(n){return function(e){for(var t=arguments.length,r=Array(t>1?t-1:0),i=1;i<t;i++)r[i-1]=arguments[i];return Nu(n,e,r)}}function cD(n){return function(){for(var e=arguments.length,t=Array(e),r=0;r<e;r++)t[r]=arguments[r];return sp(n,t)}}function re(n,e){ev&&ev(n,null);for(var t=e.length;t--;){var r=e[t];if(typeof r=="string"){var i=jc(r);i!==r&&(nD(e)||(e[t]=i),r=i)}n[r]=!0}return n}function Ii(n){var e=sD(null),t=void 0;for(t in n)Nu(tD,n,[t])&&(e[t]=n[t]);return e}function cc(n,e){for(;n!==null;){var t=iD(n,e);if(t){if(t.get)return Sn(t.get);if(typeof t.value=="function")return Sn(t.value)}n=rD(n)}function r(i){return console.warn("fallback value for",i),null}return r}var rv=It(["a","abbr","acronym","address","area","article","aside","audio","b","bdi","bdo","big","blink","blockquote","body","br","button","canvas","caption","center","cite","code","col","colgroup","content","data","datalist","dd","decorator","del","details","dfn","dialog","dir","div","dl","dt","element","em","fieldset","figcaption","figure","font","footer","form","h1","h2","h3","h4","h5","h6","head","header","hgroup","hr","html","i","img","input","ins","kbd","label","legend","li","main","map","mark","marquee","menu","menuitem","meter","nav","nobr","ol","optgroup","option","output","p","picture","pre","progress","q","rp","rt","ruby","s","samp","section","select","shadow","small","source","spacer","span","strike","strong","style","sub","summary","sup","table","tbody","td","template","textarea","tfoot","th","thead","time","tr","track","tt","u","ul","var","video","wbr"]),Nh=It(["svg","a","altglyph","altglyphdef","altglyphitem","animatecolor","animatemotion","animatetransform","circle","clippath","defs","desc","ellipse","filter","font","g","glyph","glyphref","hkern","image","line","lineargradient","marker","mask","metadata","mpath","path","pattern","polygon","polyline","radialgradient","rect","stop","style","switch","symbol","text","textpath","title","tref","tspan","view","vkern"]),Ph=It(["feBlend","feColorMatrix","feComponentTransfer","feComposite","feConvolveMatrix","feDiffuseLighting","feDisplacementMap","feDistantLight","feFlood","feFuncA","feFuncB","feFuncG","feFuncR","feGaussianBlur","feImage","feMerge","feMergeNode","feMorphology","feOffset","fePointLight","feSpecularLighting","feSpotLight","feTile","feTurbulence"]),uD=It(["animate","color-profile","cursor","discard","fedropshadow","font-face","font-face-format","font-face-name","font-face-src","font-face-uri","foreignobject","hatch","hatchpath","mesh","meshgradient","meshpatch","meshrow","missing-glyph","script","set","solidcolor","unknown","use"]),Oh=It(["math","menclose","merror","mfenced","mfrac","mglyph","mi","mlabeledtr","mmultiscripts","mn","mo","mover","mpadded","mphantom","mroot","mrow","ms","mspace","msqrt","mstyle","msub","msup","msubsup","mtable","mtd","mtext","mtr","munder","munderover"]),dD=It(["maction","maligngroup","malignmark","mlongdiv","mscarries","mscarry","msgroup","mstack","msline","msrow","semantics","annotation","annotation-xml","mprescripts","none"]),iv=It(["#text"]),sv=It(["accept","action","align","alt","autocapitalize","autocomplete","autopictureinpicture","autoplay","background","bgcolor","border","capture","cellpadding","cellspacing","checked","cite","class","clear","color","cols","colspan","controls","controlslist","coords","crossorigin","datetime","decoding","default","dir","disabled","disablepictureinpicture","disableremoteplayback","download","draggable","enctype","enterkeyhint","face","for","headers","height","hidden","high","href","hreflang","id","inputmode","integrity","ismap","kind","label","lang","list","loading","loop","low","max","maxlength","media","method","min","minlength","multiple","muted","name","nonce","noshade","novalidate","nowrap","open","optimum","pattern","placeholder","playsinline","poster","preload","pubdate","radiogroup","readonly","rel","required","rev","reversed","role","rows","rowspan","spellcheck","scope","selected","shape","size","sizes","span","srclang","start","src","srcset","step","style","summary","tabindex","title","translate","type","usemap","valign","value","width","xmlns","slot"]),Uh=It(["accent-height","accumulate","additive","alignment-baseline","ascent","attributename","attributetype","azimuth","basefrequency","baseline-shift","begin","bias","by","class","clip","clippathunits","clip-path","clip-rule","color","color-interpolation","color-interpolation-filters","color-profile","color-rendering","cx","cy","d","dx","dy","diffuseconstant","direction","display","divisor","dur","edgemode","elevation","end","fill","fill-opacity","fill-rule","filter","filterunits","flood-color","flood-opacity","font-family","font-size","font-size-adjust","font-stretch","font-style","font-variant","font-weight","fx","fy","g1","g2","glyph-name","glyphref","gradientunits","gradienttransform","height","href","id","image-rendering","in","in2","k","k1","k2","k3","k4","kerning","keypoints","keysplines","keytimes","lang","lengthadjust","letter-spacing","kernelmatrix","kernelunitlength","lighting-color","local","marker-end","marker-mid","marker-start","markerheight","markerunits","markerwidth","maskcontentunits","maskunits","max","mask","media","method","mode","min","name","numoctaves","offset","operator","opacity","order","orient","orientation","origin","overflow","paint-order","path","pathlength","patterncontentunits","patterntransform","patternunits","points","preservealpha","preserveaspectratio","primitiveunits","r","rx","ry","radius","refx","refy","repeatcount","repeatdur","restart","result","rotate","scale","seed","shape-rendering","specularconstant","specularexponent","spreadmethod","startoffset","stddeviation","stitchtiles","stop-color","stop-opacity","stroke-dasharray","stroke-dashoffset","stroke-linecap","stroke-linejoin","stroke-miterlimit","stroke-opacity","stroke","stroke-width","style","surfacescale","systemlanguage","tabindex","targetx","targety","transform","transform-origin","text-anchor","text-decoration","text-rendering","textlength","type","u1","u2","unicode","values","viewbox","visibility","version","vert-adv-y","vert-origin-x","vert-origin-y","width","word-spacing","wrap","writing-mode","xchannelselector","ychannelselector","x","x1","x2","xmlns","y","y1","y2","z","zoomandpan"]),ov=It(["accent","accentunder","align","bevelled","close","columnsalign","columnlines","columnspan","denomalign","depth","dir","display","displaystyle","encoding","fence","frame","height","href","id","largeop","length","linethickness","lspace","lquote","mathbackground","mathcolor","mathsize","mathvariant","maxsize","minsize","movablelimits","notation","numalign","open","rowalign","rowlines","rowspacing","rowspan","rspace","rquote","scriptlevel","scriptminsize","scriptsizemultiplier","selection","separator","separators","stretchy","subscriptshift","supscriptshift","symmetric","voffset","width","xmlns"]),uc=It(["xlink:href","xml:id","xlink:title","xml:space","xmlns:xlink"]),hD=Vn(/\{\{[\s\S]*|[\s\S]*\}\}/gm),fD=Vn(/<%[\s\S]*|[\s\S]*%>/gm),pD=Vn(/^data-[\-\w.\u00B7-\uFFFF]/),mD=Vn(/^aria-[\-\w]+$/),_D=Vn(/^(?:(?:(?:f|ht)tps?|mailto|tel|callto|cid|xmpp):|[^a-z]|[a-z+.\-]+(?:[^a-z+.\-:]|$))/i),gD=Vn(/^(?:\w+script|data):/i),yD=Vn(/[\u0000-\u0020\u00A0\u1680\u180E\u2000-\u2029\u205F\u3000]/g),vD=Vn(/^html$/i),ya=typeof Symbol=="function"&&typeof Symbol.iterator=="symbol"?function(n){return typeof n}:function(n){return n&&typeof Symbol=="function"&&n.constructor===Symbol&&n!==Symbol.prototype?"symbol":typeof n};function Tn(n){if(Array.isArray(n)){for(var e=0,t=Array(n.length);e<n.length;e++)t[e]=n[e];return t}else return Array.from(n)}var wD=function(){return typeof window>"u"?null:window},bD=function(e,t){if((typeof e>"u"?"undefined":ya(e))!=="object"||typeof e.createPolicy!="function")return null;var r=null,i="data-tt-policy-suffix";t.currentScript&&t.currentScript.hasAttribute(i)&&(r=t.currentScript.getAttribute(i));var s="dompurify"+(r?"#"+r:"");try{return e.createPolicy(s,{createHTML:function(a){return a}})}catch{return console.warn("TrustedTypes policy "+s+" could not be created."),null}};function xE(){var n=arguments.length>0&&arguments[0]!==void 0?arguments[0]:wD(),e=function(h){return xE(h)};if(e.version="2.3.6",e.removed=[],!n||!n.document||n.document.nodeType!==9)return e.isSupported=!1,e;var t=n.document,r=n.document,i=n.DocumentFragment,s=n.HTMLTemplateElement,o=n.Node,a=n.Element,c=n.NodeFilter,u=n.NamedNodeMap,l=u===void 0?n.NamedNodeMap||n.MozNamedAttrMap:u,d=n.HTMLFormElement,p=n.DOMParser,m=n.trustedTypes,w=a.prototype,S=cc(w,"cloneNode"),v=cc(w,"nextSibling"),_=cc(w,"childNodes"),b=cc(w,"parentNode");if(typeof s=="function"){var k=r.createElement("template");k.content&&k.content.ownerDocument&&(r=k.content.ownerDocument)}var g=bD(m,t),A=g?g.createHTML(""):"",M=r,C=M.implementation,P=M.createNodeIterator,I=M.createDocumentFragment,$=M.getElementsByTagName,x=t.importNode,U={};try{U=Ii(r).documentMode?r.documentMode:{}}catch{}var T={};e.isSupported=typeof b=="function"&&C&&typeof C.createHTMLDocument<"u"&&U!==9;var N=hD,X=fD,H=pD,ne=mD,me=gD,_e=yD,He=_D,O=null,W=re({},[].concat(Tn(rv),Tn(Nh),Tn(Ph),Tn(Oh),Tn(iv))),j=null,de=re({},[].concat(Tn(sv),Tn(Uh),Tn(ov),Tn(uc))),ee=Object.seal(Object.create(null,{tagNameCheck:{writable:!0,configurable:!1,enumerable:!0,value:null},attributeNameCheck:{writable:!0,configurable:!1,enumerable:!0,value:null},allowCustomizedBuiltInElements:{writable:!0,configurable:!1,enumerable:!0,value:!1}})),et=null,Rt=null,un=!0,Ut=!0,Oo=!1,Ir=!1,gt=!1,zn=!1,Gn=!1,qn=!1,tt=!1,bi=!1,Uo=!0,$o=!0,Wn=!1,En={},dn=null,hn=re({},["annotation-xml","audio","colgroup","desc","foreignobject","head","iframe","math","mi","mn","mo","ms","mtext","noembed","noframes","noscript","plaintext","script","style","svg","template","thead","title","video","xmp"]),Tr=null,Lo=re({},["audio","video","img","source","image","track"]),Fo=null,Bo=re({},["alt","class","for","id","label","name","pattern","placeholder","role","summary","title","value","style","xmlns"]),ls="http://www.w3.org/1998/Math/MathML",cs="http://www.w3.org/2000/svg",$t="http://www.w3.org/1999/xhtml",Si=$t,Lt=!1,Be=void 0,Yt=["application/xhtml+xml","text/html"],Ft="text/html",Xt=void 0,Ct=null,kn=r.createElement("form"),yt=function(h){return h instanceof RegExp||h instanceof Function},Yn=function(h){Ct&&Ct===h||((!h||(typeof h>"u"?"undefined":ya(h))!=="object")&&(h={}),h=Ii(h),O="ALLOWED_TAGS"in h?re({},h.ALLOWED_TAGS):W,j="ALLOWED_ATTR"in h?re({},h.ALLOWED_ATTR):de,Fo="ADD_URI_SAFE_ATTR"in h?re(Ii(Bo),h.ADD_URI_SAFE_ATTR):Bo,Tr="ADD_DATA_URI_TAGS"in h?re(Ii(Lo),h.ADD_DATA_URI_TAGS):Lo,dn="FORBID_CONTENTS"in h?re({},h.FORBID_CONTENTS):hn,et="FORBID_TAGS"in h?re({},h.FORBID_TAGS):{},Rt="FORBID_ATTR"in h?re({},h.FORBID_ATTR):{},En="USE_PROFILES"in h?h.USE_PROFILES:!1,un=h.ALLOW_ARIA_ATTR!==!1,Ut=h.ALLOW_DATA_ATTR!==!1,Oo=h.ALLOW_UNKNOWN_PROTOCOLS||!1,Ir=h.SAFE_FOR_TEMPLATES||!1,gt=h.WHOLE_DOCUMENT||!1,qn=h.RETURN_DOM||!1,tt=h.RETURN_DOM_FRAGMENT||!1,bi=h.RETURN_TRUSTED_TYPE||!1,Gn=h.FORCE_BODY||!1,Uo=h.SANITIZE_DOM!==!1,$o=h.KEEP_CONTENT!==!1,Wn=h.IN_PLACE||!1,He=h.ALLOWED_URI_REGEXP||He,Si=h.NAMESPACE||$t,h.CUSTOM_ELEMENT_HANDLING&&yt(h.CUSTOM_ELEMENT_HANDLING.tagNameCheck)&&(ee.tagNameCheck=h.CUSTOM_ELEMENT_HANDLING.tagNameCheck),h.CUSTOM_ELEMENT_HANDLING&&yt(h.CUSTOM_ELEMENT_HANDLING.attributeNameCheck)&&(ee.attributeNameCheck=h.CUSTOM_ELEMENT_HANDLING.attributeNameCheck),h.CUSTOM_ELEMENT_HANDLING&&typeof h.CUSTOM_ELEMENT_HANDLING.allowCustomizedBuiltInElements=="boolean"&&(ee.allowCustomizedBuiltInElements=h.CUSTOM_ELEMENT_HANDLING.allowCustomizedBuiltInElements),Be=Yt.indexOf(h.PARSER_MEDIA_TYPE)===-1?Be=Ft:Be=h.PARSER_MEDIA_TYPE,Xt=Be==="application/xhtml+xml"?function(y){return y}:jc,Ir&&(Ut=!1),tt&&(qn=!0),En&&(O=re({},[].concat(Tn(iv))),j=[],En.html===!0&&(re(O,rv),re(j,sv)),En.svg===!0&&(re(O,Nh),re(j,Uh),re(j,uc)),En.svgFilters===!0&&(re(O,Ph),re(j,Uh),re(j,uc)),En.mathMl===!0&&(re(O,Oh),re(j,ov),re(j,uc))),h.ADD_TAGS&&(O===W&&(O=Ii(O)),re(O,h.ADD_TAGS)),h.ADD_ATTR&&(j===de&&(j=Ii(j)),re(j,h.ADD_ATTR)),h.ADD_URI_SAFE_ATTR&&re(Fo,h.ADD_URI_SAFE_ATTR),h.FORBID_CONTENTS&&(dn===hn&&(dn=Ii(dn)),re(dn,h.FORBID_CONTENTS)),$o&&(O["#text"]=!0),gt&&re(O,["html","head","body"]),O.table&&(re(O,["tbody"]),delete et.tbody),It&&It(h),Ct=h)},Rr=re({},["mi","mo","mn","ms","mtext"]),Jt=re({},["foreignobject","desc","title","annotation-xml"]),ct=re({},Nh);re(ct,Ph),re(ct,uD);var ge=re({},Oh);re(ge,dD);var Ee=function(h){var y=b(h);(!y||!y.tagName)&&(y={namespaceURI:$t,tagName:"template"});var E=jc(h.tagName),D=jc(y.tagName);if(h.namespaceURI===cs)return y.namespaceURI===$t?E==="svg":y.namespaceURI===ls?E==="svg"&&(D==="annotation-xml"||Rr[D]):!!ct[E];if(h.namespaceURI===ls)return y.namespaceURI===$t?E==="math":y.namespaceURI===cs?E==="math"&&Jt[D]:!!ge[E];if(h.namespaceURI===$t){if(y.namespaceURI===cs&&!Jt[D]||y.namespaceURI===ls&&!Rr[D])return!1;var K=re({},["title","style","font","a","script"]);return!ge[E]&&(K[E]||!ct[E])}return!1},Ve=function(h){na(e.removed,{element:h});try{h.parentNode.removeChild(h)}catch{try{h.outerHTML=A}catch{h.remove()}}},vt=function(h,y){try{na(e.removed,{attribute:y.getAttributeNode(h),from:y})}catch{na(e.removed,{attribute:null,from:y})}if(y.removeAttribute(h),h==="is"&&!j[h])if(qn||tt)try{Ve(y)}catch{}else try{y.setAttribute(h,"")}catch{}},B=function(h){var y=void 0,E=void 0;if(Gn)h="<remove></remove>"+h;else{var D=nv(h,/^[\r\n\t ]+/);E=D&&D[0]}Be==="application/xhtml+xml"&&(h='<html xmlns="http://www.w3.org/1999/xhtml"><head></head><body>'+h+"</body></html>");var K=g?g.createHTML(h):h;if(Si===$t)try{y=new p().parseFromString(K,Be)}catch{}if(!y||!y.documentElement){y=C.createDocument(Si,"template",null);try{y.documentElement.innerHTML=Lt?"":K}catch{}}var Y=y.body||y.documentElement;return h&&E&&Y.insertBefore(r.createTextNode(E),Y.childNodes[0]||null),Si===$t?$.call(y,gt?"html":"body")[0]:gt?y.documentElement:Y},Z=function(h){return P.call(h.ownerDocument||h,h,c.SHOW_ELEMENT|c.SHOW_COMMENT|c.SHOW_TEXT,null,!1)},q=function(h){return h instanceof d&&(typeof h.nodeName!="string"||typeof h.textContent!="string"||typeof h.removeChild!="function"||!(h.attributes instanceof l)||typeof h.removeAttribute!="function"||typeof h.setAttribute!="function"||typeof h.namespaceURI!="string"||typeof h.insertBefore!="function")},Q=function(h){return(typeof o>"u"?"undefined":ya(o))==="object"?h instanceof o:h&&(typeof h>"u"?"undefined":ya(h))==="object"&&typeof h.nodeType=="number"&&typeof h.nodeName=="string"},ve=function(h,y,E){T[h]&&oD(T[h],function(D){D.call(e,y,E,Ct)})},we=function(h){var y=void 0;if(ve("beforeSanitizeElements",h,null),q(h)||nv(h.nodeName,/[\u0080-\uFFFF]/))return Ve(h),!0;var E=Xt(h.nodeName);if(ve("uponSanitizeElement",h,{tagName:E,allowedTags:O}),!Q(h.firstElementChild)&&(!Q(h.content)||!Q(h.content.firstElementChild))&&xt(/<[/\w]/g,h.innerHTML)&&xt(/<[/\w]/g,h.textContent)||E==="select"&&xt(/<template/i,h.innerHTML))return Ve(h),!0;if(!O[E]||et[E]){if(!et[E]&&Ae(E)&&(ee.tagNameCheck instanceof RegExp&&xt(ee.tagNameCheck,E)||ee.tagNameCheck instanceof Function&&ee.tagNameCheck(E)))return!1;if($o&&!dn[E]){var D=b(h)||h.parentNode,K=_(h)||h.childNodes;if(K&&D)for(var Y=K.length,ce=Y-1;ce>=0;--ce)D.insertBefore(S(K[ce],!0),v(h))}return Ve(h),!0}return h instanceof a&&!Ee(h)||(E==="noscript"||E==="noembed")&&xt(/<\/no(script|embed)/i,h.innerHTML)?(Ve(h),!0):(Ir&&h.nodeType===3&&(y=h.textContent,y=Cr(y,N," "),y=Cr(y,X," "),h.textContent!==y&&(na(e.removed,{element:h.cloneNode()}),h.textContent=y)),ve("afterSanitizeElements",h,null),!1)},nt=function(h,y,E){if(Uo&&(y==="id"||y==="name")&&(E in r||E in kn))return!1;if(!(Ut&&!Rt[y]&&xt(H,y))){if(!(un&&xt(ne,y))){if(!j[y]||Rt[y]){if(!(Ae(h)&&(ee.tagNameCheck instanceof RegExp&&xt(ee.tagNameCheck,h)||ee.tagNameCheck instanceof Function&&ee.tagNameCheck(h))&&(ee.attributeNameCheck instanceof RegExp&&xt(ee.attributeNameCheck,y)||ee.attributeNameCheck instanceof Function&&ee.attributeNameCheck(y))||y==="is"&&ee.allowCustomizedBuiltInElements&&(ee.tagNameCheck instanceof RegExp&&xt(ee.tagNameCheck,E)||ee.tagNameCheck instanceof Function&&ee.tagNameCheck(E))))return!1}else if(!Fo[y]){if(!xt(He,Cr(E,_e,""))){if(!((y==="src"||y==="xlink:href"||y==="href")&&h!=="script"&&aD(E,"data:")===0&&Tr[h])){if(!(Oo&&!xt(me,Cr(E,_e,"")))){if(E)return!1}}}}}}return!0},Ae=function(h){return h.indexOf("-")>0},Ei=function(h){var y=void 0,E=void 0,D=void 0,K=void 0;ve("beforeSanitizeAttributes",h,null);var Y=h.attributes;if(Y){var ce={attrName:"",attrValue:"",keepAttr:!0,allowedAttributes:j};for(K=Y.length;K--;){y=Y[K];var In=y,De=In.name,Bt=In.namespaceURI;if(E=lD(y.value),D=Xt(De),ce.attrName=D,ce.attrValue=E,ce.keepAttr=!0,ce.forceKeepAttr=void 0,ve("uponSanitizeAttribute",h,ce),E=ce.attrValue,!ce.forceKeepAttr&&(vt(De,h),!!ce.keepAttr)){if(xt(/\/>/i,E)){vt(De,h);continue}Ir&&(E=Cr(E,N," "),E=Cr(E,X," "));var Ko=Xt(h.nodeName);if(nt(Ko,D,E))try{Bt?h.setAttributeNS(Bt,De,E):h.setAttribute(De,E),tv(e.removed)}catch{}}}ve("afterSanitizeAttributes",h,null)}},Vo=function f(h){var y=void 0,E=Z(h);for(ve("beforeSanitizeShadowDOM",h,null);y=E.nextNode();)ve("uponSanitizeShadowNode",y,null),!we(y)&&(y.content instanceof i&&f(y.content),Ei(y));ve("afterSanitizeShadowDOM",h,null)};return e.sanitize=function(f,h){var y=void 0,E=void 0,D=void 0,K=void 0,Y=void 0;if(Lt=!f,Lt&&(f="<!-->"),typeof f!="string"&&!Q(f)){if(typeof f.toString!="function")throw Dh("toString is not a function");if(f=f.toString(),typeof f!="string")throw Dh("dirty is not a string, aborting")}if(!e.isSupported){if(ya(n.toStaticHTML)==="object"||typeof n.toStaticHTML=="function"){if(typeof f=="string")return n.toStaticHTML(f);if(Q(f))return n.toStaticHTML(f.outerHTML)}return f}if(zn||Yn(h),e.removed=[],typeof f=="string"&&(Wn=!1),Wn){if(f.nodeName){var ce=Xt(f.nodeName);if(!O[ce]||et[ce])throw Dh("root node is forbidden and cannot be sanitized in-place")}}else if(f instanceof o)y=B("<!---->"),E=y.ownerDocument.importNode(f,!0),E.nodeType===1&&E.nodeName==="BODY"||E.nodeName==="HTML"?y=E:y.appendChild(E);else{if(!qn&&!Ir&&!gt&&f.indexOf("<")===-1)return g&&bi?g.createHTML(f):f;if(y=B(f),!y)return qn?null:bi?A:""}y&&Gn&&Ve(y.firstChild);for(var In=Z(Wn?f:y);D=In.nextNode();)D.nodeType===3&&D===K||we(D)||(D.content instanceof i&&Vo(D.content),Ei(D),K=D);if(K=null,Wn)return f;if(qn){if(tt)for(Y=I.call(y.ownerDocument);y.firstChild;)Y.appendChild(y.firstChild);else Y=y;return j.shadowroot&&(Y=x.call(t,Y,!0)),Y}var De=gt?y.outerHTML:y.innerHTML;return gt&&O["!doctype"]&&y.ownerDocument&&y.ownerDocument.doctype&&y.ownerDocument.doctype.name&&xt(vD,y.ownerDocument.doctype.name)&&(De="<!DOCTYPE "+y.ownerDocument.doctype.name+`>
`+De),Ir&&(De=Cr(De,N," "),De=Cr(De,X," ")),g&&bi?g.createHTML(De):De},e.setConfig=function(f){Yn(f),zn=!0},e.clearConfig=function(){Ct=null,zn=!1},e.isValidAttribute=function(f,h,y){Ct||Yn({});var E=Xt(f),D=Xt(h);return nt(E,D,y)},e.addHook=function(f,h){typeof h=="function"&&(T[f]=T[f]||[],na(T[f],h))},e.removeHook=function(f){T[f]&&tv(T[f])},e.removeHooks=function(f){T[f]&&(T[f]=[])},e.removeAllHooks=function(){T={}},e}var SD=xE(),AE={exports:{}},ED=function(n){var e={};function t(r){if(e[r])return e[r].exports;var i=e[r]={i:r,l:!1,exports:{}};return n[r].call(i.exports,i,i.exports,t),i.l=!0,i.exports}return t.m=n,t.c=e,t.d=function(r,i,s){t.o(r,i)||Object.defineProperty(r,i,{enumerable:!0,get:s})},t.r=function(r){typeof Symbol<"u"&&Symbol.toStringTag&&Object.defineProperty(r,Symbol.toStringTag,{value:"Module"}),Object.defineProperty(r,"__esModule",{value:!0})},t.t=function(r,i){if(1&i&&(r=t(r)),8&i||4&i&&typeof r=="object"&&r&&r.__esModule)return r;var s=Object.create(null);if(t.r(s),Object.defineProperty(s,"default",{enumerable:!0,value:r}),2&i&&typeof r!="string")for(var o in r)t.d(s,o,function(a){return r[a]}.bind(null,o));return s},t.n=function(r){var i=r&&r.__esModule?function(){return r.default}:function(){return r};return t.d(i,"a",i),i},t.o=function(r,i){return Object.prototype.hasOwnProperty.call(r,i)},t.p="",t(t.s=0)}([function(n,e,t){function r(u){let l,d;const p={light:function(){return!w()},dark:w,lighten:_,darken:v,saturate:b,desaturate:function(g=0){return b(g*=-1)},increaseContrast:function(g=0){return k(g*=-1)},decreaseContrast:k,active:function(){return k(.123)},highlight:function(){return k(.1)},selected:function(){return k(.066)},text:function(){return d=S()?i("#333333"):i("#FFFFFF"),p},shadow:function(){return d=S()?i("#000000"):i("#FFFFFF"),p},hex:function(){const g=d;return d=l,"#"+g.map(A=>parseInt(A+"",10).toString(16).padStart(2,"0")).join("")},rgb:function(){const g=d;return d=l,`rgb(${g.join()})`},rgba:function(g=1){const A=d;return d=l,`rgba(${A.join()}, ${g})`},setHex:m,setRgb:function(g=[0,0,0]){let[A,M,C]=g;return A=c(A,0,255),M=c(M,0,255),C=c(C,0,255),l=[A,M,C],d=[A,M,C],p}};function m(g="#000000"){return l=i(g),d=l,p}function w(){const[g,A,M]=d;return d=l,(299*g+587*A+114*M)/1e3<128}function S(){const[g,A,M]=d;return(299*g+587*A+114*M)/1e3>=128}function v(g=0){return _(g*=-1)}function _(g=0){let[A,M,C]=a(d);return C=c(C+g,0,1),d=s([A,M,C]),p}function b(g=0){let[A,M,C]=a(d);return M=c(M+g,0,1),d=s([A,M,C]),p}function k(g=0){return S()?v(g):_(g)}return m(u),p}function i(u){if(typeof u!="string")throw new TypeError("Expected a string");(u=u.replace(/^#/,"")).length===3&&(u=u[0]+u[0]+u[1]+u[1]+u[2]+u[2]);var l=parseInt(u,16);return[l>>16,l>>8&255,255&l]}function s(u){const[l,d,p]=u;let m,w,S;if(d===0)m=w=S=p;else{const v=function(k,g,A){return A<0&&(A+=1),A>1&&(A-=1),A<.16666666666666666?k+6*(g-k)*A:A<.5?g:A<.6666666666666666?k+(g-k)*(.6666666666666666-A)*6:k},_=p<.5?p*(1+d):p+d-p*d,b=2*p-_;m=c(v(b,_,l+1/3),0,1),w=c(v(b,_,l),0,1),S=c(v(b,_,l-1/3),0,1)}return[Math.round(255*m),Math.round(255*w),Math.round(255*S)]}t.r(e),t.d(e,"offColor",function(){return r}),t.d(e,"hexRgb",function(){return i}),t.d(e,"hslToRgb",function(){return s}),t.d(e,"color",function(){return o}),t.d(e,"rgbToHsl",function(){return a});const o=r;function a(u){const l=u[0]/255,d=u[1]/255,p=u[2]/255,m=Math.max(l,d,p),w=Math.min(l,d,p);let S=(m+w)/2,v=(m+w)/2;const _=(m+w)/2;if(m===w)S=v=0;else{const b=m-w;switch(v=_>.5?b/(2-m-w):b/(m+w),m){case l:S=(d-p)/b+(d<p?6:0);break;case d:S=(p-l)/b+2;break;case p:S=(l-d)/b+4}S/=6}return[S,v,_]}function c(u,l,d){return u=(u=u<=d?u:d)>=l?u:l}}]);AE.exports=ED;var l_=AE.exports;const DE=mo(l_);var kD=Object.defineProperty,ID=Object.defineProperties,TD=Object.getOwnPropertyDescriptors,Pu=Object.getOwnPropertySymbols,NE=Object.prototype.hasOwnProperty,PE=Object.prototype.propertyIsEnumerable,av=(n,e,t)=>e in n?kD(n,e,{enumerable:!0,configurable:!0,writable:!0,value:t}):n[e]=t,lo=(n,e)=>{for(var t in e||(e={}))NE.call(e,t)&&av(n,t,e[t]);if(Pu)for(var t of Pu(e))PE.call(e,t)&&av(n,t,e[t]);return n},OE=(n,e)=>ID(n,TD(e)),RD=(n,e)=>{var t={};for(var r in n)NE.call(n,r)&&e.indexOf(r)<0&&(t[r]=n[r]);if(n!=null&&Pu)for(var r of Pu(n))e.indexOf(r)<0&&PE.call(n,r)&&(t[r]=n[r]);return t},lv,cv,tn=(n=>(n[n.All=1]="All",n[n.Debug=2]="Debug",n[n.Detail=3]="Detail",n[n.Info=4]="Info",n[n.Warn=5]="Warn",n[n.Error=6]="Error",n[n.Fatal=7]="Fatal",n[n.Off=8]="Off",n))(tn||{});class Ou{constructor(e){this._parentFilter=e}filter(e,t){return!(this._parentFilter&&!this._parentFilter.filter(e,t)||this._min!==void 0&&!Array.isArray(t)&&e.logLevel<this._min)}minLevel(e){return this._min=e,this}}class Gs{constructor(e,t,r,i){this._discard=!1,this._logger=r,this.start=r._now(),this._values=typeof e=="string"?{l:e}:e,this.logLevel=t,this._filterCreator=i}discard(){this._discard=!0}runDetached(e,t,r,i){return this._logger.runDetached(e,t,r,i)}wrapDetached(e,t,r,i){this.refDetached(this.runDetached(e,t,r,i))}refDetached(e,t){e.ensureRefId(),this.log({ref:e.values.refId},t)}ensureRefId(){this._values.refId||this.set("refId",this._logger._createRefId())}wrap(e,t,r,i){return this.child(e,r,i).run(t)}get duration(){if(this.end)return this.end-this.start}durationWithoutType(e){const t=this.durationOfType(e);if(this.duration&&t)return this.duration-t}durationOfType(e){return this._values.t===e?this.duration:this._children?this._children.reduce((t,r)=>{const i=r.durationOfType(e);return t+(i??0)},0):0}log(e,t){const r=this.child(e,t);return r.end=r.start,r}set(e,t){if(typeof e=="object"){const r=e;Object.assign(this._values,r)}else this._values[e]=t;return this}serialize(e,t,r){if(this._discard)return;if(this._filterCreator)try{e=this._filterCreator(new Ou(e),this)}catch(o){console.error("Error creating log filter",o)}let i=null;if(this._children&&(i=this._children.reduce((o,a)=>{const c=a.serialize(e,this.start,!1);return c&&(o===null&&(o=[]),o.push(c)),o},null)),e&&!e.filter(this,i))return;const s={s:typeof t=="number"?this.start-t:this.start,d:this.duration,v:this._values,l:this.logLevel};return this.error&&(s.e={stack:this.error.stack,name:this.error.name,message:this.error.message.split(`
`)[0]}),r&&(s.f=!0),i&&(s.c=i),s}run(e){try{const t=e(this);return t instanceof Promise?t.then(r=>(this.finish(),r),r=>{throw this.catch(r)}):(this.finish(),t)}catch(t){throw this.catch(t)}}finish(){if(this.end===void 0){if(this._children)for(const e of this._children)e.finish();this.end=this._logger._now()}}forceFinish(){this.finish()}get level(){return tn}catch(e){return this.error=e,this.logLevel=tn.Error,this.finish(),e}child(e,t,r){t||(t=this.logLevel||tn.Info);const i=new Gs(e,t,this._logger,r);return this._children||(this._children=[]),this._children.push(i),i}get logger(){return this._logger}get values(){return this._values}get children(){return this._children}}class CD{constructor({platform:e}){this._openItems=new Set,this.reporters=[],this._platform=e}log(e,t=tn.Info){const r=new Gs(e,t,this);return r.end=r.start,this._persistItem(r,void 0,!1),r}child(e,t=tn.Info,r){const i=new MD(e,t,this,r);return this._openItems.add(i),i}wrapOrRun(e,t,r,i,s){return e?e.wrap(t,r,i,s):this.run(t,r,i,s)}runDetached(e,t,r,i){r||(r=tn.Info);const s=new Gs(e,r,this);return this._run(s,t,r,!1,i),s}run(e,t,r,i){r===void 0&&(r=tn.Info);const s=new Gs(e,r,this);return this._run(s,t,r,!0,i)}_run(e,t,r,i,s){this._openItems.add(e);const o=()=>{let a=new Ou;if(s)try{a=s(a,e)}catch(c){console.error("Error while creating log filter",c)}else a=a.minLevel(r);try{this._persistItem(e,a,!1)}catch(c){console.error("Could not persist log item",c)}this._openItems.delete(e)};try{let a=e.run(t);if(a instanceof Promise){if(a=a.then(c=>(o(),c),c=>{if(o(),i)throw c}),i)return a}else if(o(),i)return a}catch(a){if(o(),i)throw a}}addReporter(e){e.setLogger(this),this.reporters.push(e)}getOpenRootItems(){return this._openItems}forceFinish(){for(const e of this._openItems){e.forceFinish();try{this._persistItem(e,new Ou,!0)}catch(t){console.error("Could not serialize log item",t)}}this._openItems.clear()}_removeItemFromOpenList(e){this._openItems.delete(e)}_persistItem(e,t,r){for(var i=0;i<this.reporters.length;i+=1)this.reporters[i].reportItem(e,t,r)}get level(){return tn}_now(){return this._platform.clock.now()}_createRefId(){return Math.round(this._platform.random()*Number.MAX_SAFE_INTEGER)}}class MD extends Gs{finish(){super.finish(),this._logger._persistItem(this,void 0,!1),this._logger._removeItemFromOpenList(this)}forceFinish(){super.finish()}}var Ie=(n=>(n.session="session",n.roomState="roomState",n.roomSummary="roomSummary",n.archivedRoomSummary="archivedRoomSummary",n.invites="invites",n.roomMembers="roomMembers",n.timelineEvents="timelineEvents",n.timelineRelations="timelineRelations",n.timelineFragments="timelineFragments",n.pendingEvents="pendingEvents",n.userIdentities="userIdentities",n.deviceKeys="deviceKeys",n.olmSessions="olmSessions",n.inboundGroupSessions="inboundGroupSessions",n.outboundGroupSessions="outboundGroupSessions",n.groupSessionDecryptions="groupSessionDecryptions",n.operations="operations",n.accountData="accountData",n.calls="calls",n.crossSigningKeys="crossSigningKeys",n))(Ie||{});const dl=Object.values(Ie);class ur extends Error{constructor(e,t=null){super(e),t&&(this.errcode=t.name),this.cause=t}get name(){return"StorageError"}}const Le={get minStorageKey(){return 0},get middleStorageKey(){return 2147483647},get maxStorageKey(){return 4294967295}};function xD(n){return"objectStore"in n?`${n.objectStore.name}.${n.name}`:n.name}function AD(n){var e,t,r,i,s;return"objectStore"in n?(r=(t=(e=n.objectStore)==null?void 0:e.transaction)==null?void 0:t.db)==null?void 0:r.name:(s=(i=n.transaction)==null?void 0:i.db)==null?void 0:s.name}class UE extends ur{constructor(e,t,r=null){const i=t&&"source"in t?t.source:t,s=i?xD(i):"",o=i?AD(i):"";let a=`${e} on ${o}.${s}`;r&&(a+=": ",typeof r.name=="string"&&(a+=`(name: ${r.name}) `),typeof r.code=="number"&&(a+=`(code: ${r.code}) `)),r&&(a+=r.message),super(a,r),this.storeName=s,this.databaseName=o}}class c_ extends UE{constructor(e){const t=e.target,r=t.source,i=t.error;super("IDBRequest failed",r,i),this.errorEvent=e}preventTransactionAbort(){this.errorEvent.preventDefault()}}class Jn extends UE{constructor(e,t,r,i){super(`${e}(${i.map(s=>JSON.stringify(s)).join(", ")}) failed`,t,r)}}class ln extends Error{get name(){return"AbortError"}}const uv={done:!0},vr={done:!1};function Uu(n){const e=n.toString(16);return"0".repeat(8-e.length)+e}function op(n){return parseInt(n,16)}function u_(n,e,t,r=window.indexedDB){const i=r.open(n,t);return i.onupgradeneeded=async s=>{const o=s.target,a=o.result,c=o.transaction,u=s.oldVersion;try{await e(a,c,u,t)}catch{try{c.abort()}catch{}}},Et(i)}function Et(n){return new Promise((e,t)=>{n.addEventListener("success",r=>{e(r.target.result)}),n.addEventListener("error",r=>{const i=new c_(r);t(i)})})}function hl(n){return new Promise((e,t)=>{n.addEventListener("complete",()=>{e()}),n.addEventListener("abort",r=>{t(new ln)})})}function Ge(n,e){return new Promise((t,r)=>{n.onerror=i=>{r(new c_(i))},n.onsuccess=i=>{const s=i.target.result;if(!s){t(!1);return}const o=e(s.value,s.key,s),a=o==null?void 0:o.done,c=o==null?void 0:o.jumpTo;a?t(!0):c?s.continue(c):s.continue()}}).catch(t=>{throw new ur("iterateCursor failed",t)})}async function DD(n,e){const t=[];return await Ge(n,r=>(t.push(r),{done:e(t)})),t}class ND{constructor(e){var t;this.options=e,this._queuedItems=this._loadQueuedItems(),window.addEventListener("pagehide",this,!1),this._flushInterval=this.options.platform.clock.createInterval(()=>this._tryFlush(),(t=this.options.flushInterval)!=null?t:60*1e3)}setLogger(e){this.logger=e}reportItem(e,t,r){const i=this.prepareItemForQueue(e,t,r);i&&this._queuedItems.push(i)}async export(){const e=await this._openDB();try{const r=e.transaction(["logs"],"readonly").objectStore("logs"),i=await DD(r.openCursor(),()=>!1),s=this.getSerializedOpenItems(),o=i.concat(this._queuedItems).concat(s);return new PD(o,this,this.options.platform)}finally{try{e.close()}catch{}}}dispose(){window.removeEventListener("pagehide",this,!1),this._flushInterval.dispose()}handleEvent(e){e.type==="pagehide"&&this._finishAllAndFlush()}async _tryFlush(){var e;const t=await this._openDB();try{const r=t.transaction(["logs"],"readwrite"),i=r.objectStore("logs"),s=this._queuedItems.length;for(const c of this._queuedItems)i.add(c);const o=await Et(i.count()),a=(e=this.options.limit)!=null?e:3e3;if(o>a){let c=o-a+Math.round(.1*a);await Ge(i.openCursor(),(u,l,d)=>(d.delete(),c-=1,{done:c===0}))}await hl(r),this._queuedItems.splice(0,s)}catch(r){console.error("Could not flush logs",r)}finally{try{t.close()}catch{}}}_finishAllAndFlush(){this.logger&&(this.logger.log({l:"pagehide, closing logs",t:"navigation"}),this.logger.forceFinish()),this._persistQueuedItems(this._queuedItems)}_loadQueuedItems(){const e=`${this.options.name}_queuedItems`;try{const t=window.localStorage.getItem(e);if(t)return window.localStorage.removeItem(e),JSON.parse(t)}catch(t){console.error("Could not load queued log items",t)}return[]}_openDB(){return u_(this.options.name,e=>e.createObjectStore("logs",{keyPath:"id",autoIncrement:!0}),1)}prepareItemForQueue(e,t,r){let i=e.serialize(t,void 0,r);if(i)return this.options.serializedTransformer&&(i=this.options.serializedTransformer(i)),{json:JSON.stringify(i)}}_persistQueuedItems(e){try{window.localStorage.setItem(`${this.options.name}_queuedItems`,JSON.stringify(e))}catch(t){console.error("Could not persist queued log items in localStorage, they will likely be lost",t)}}async removeItems(e){const t=await this._openDB();try{const r=t.transaction(["logs"],"readwrite"),i=r.objectStore("logs");for(const s of e)if(typeof s.id=="number")i.delete(s.id);else{const o=this._queuedItems.indexOf(s);o===-1&&this._queuedItems.splice(o,1)}await hl(r)}finally{try{t.close()}catch{}}}getSerializedOpenItems(){const e=[];if(!this.logger)return e;const t=new Ou;for(const r of this.logger.getOpenRootItems()){const i=this.prepareItemForQueue(r,t,!1);i&&e.push(i)}return e}}class PD{constructor(e,t,r){this._items=e,this._logger=t,this._platform=r}get count(){return this._items.length}removeFromStore(){return this._logger.removeItems(this._items)}asBlob(){const e=this.toJSON(),t=this._platform.encoding.utf8.encode(e);return this._platform.createBlob(t,"application/json")}toJSON(){var e;const t={formatVersion:1,appVersion:(e=this._platform.updateService)==null?void 0:e.version,platform:this._platform.description,items:this._items.map(i=>JSON.parse(i.json))};return JSON.stringify(t)}}class OD{reportItem(e){LE(e)}setLogger(e){this.logger=e}printOpenItems(){if(this.logger)for(const e of this.logger.getOpenRootItems())this.reportItem(e)}}const UD=["l","id"];function $D(n){return Object.entries(n).filter(([e])=>!UD.includes(e)).reduce((e,[t,r])=>(e=e||{},e[t]=r,e),null)}function $E(n){if(n.error)return!0;if(n.children){for(const e of n.children)if($E(e))return!0}return!1}function LE(n){const e=`${LD(n)} (@${n.start}ms, duration: ${n.duration}ms)`,t=$D(n.values),r=n.children||t;if(r?($E(n)?console.group(e):console.groupCollapsed(e),n.error&&console.error(n.error)):n.error?console.error(n.error):console.log(e),t&&console.table(t),n.children)for(const i of n.children)LE(i);r&&console.groupEnd()}function LD(n){return n.values.t==="network"?`${n.values.method} ${n.values.url}`:n.values.l&&typeof n.values.id<"u"?`${n.values.l} ${n.values.id}`:n.values.l&&typeof n.values.status<"u"?`${n.values.l} (${n.values.status})`:n.values.l&&typeof n.values.type<"u"?`${n.values.l} (${n.values.type})`:n.values.l&&n.error?`${n.values.l} failed`:typeof n.values.ref<"u"?`ref ${n.values.ref}`:n.values.l||n.values.type}class FE extends Error{constructor(e,t){super(`${e}: ${t.message}`),this.cause=t}get name(){return"WrappedError"}}class BE extends Error{constructor(e,t,r,i){super(`${r?r.error:i} on ${e} ${t}`),this.errcode=r?r.errcode:null,this.retry_after_ms=r?r.retry_after_ms:0,this.statusCode=i}get name(){return"HomeServerError"}}class dr extends Error{constructor(e,t){super(e||"ConnectionError"),this.isTimeout=t}get name(){return"ConnectionError"}}class Ml{constructor(){this._handlers=new Set}onSubscribeFirst(){}onUnsubscribeLast(){}subscribe(e){return this._handlers.add(e),this._handlers.size===1&&this.onSubscribeFirst(),()=>this.unsubscribe(e)}unsubscribe(e){e&&(this._handlers.delete(e),this._handlers.size===0&&this.onUnsubscribeLast())}unsubscribeAll(){this._handlers.size!==0&&(this._handlers.clear(),this.onUnsubscribeLast())}get hasSubscriptions(){return this._handlers.size!==0}}class vi extends Ml{emit(e){for(const t of this._handlers)t(e)}waitFor(e){return e(this.get())?new BD(Promise.resolve(this.get())):new FD(this,e)}flatMap(e){return new VD(this,e)}}class FD{constructor(e,t){this._promise=new Promise((r,i)=>{this._reject=i,this._subscription=e.subscribe(s=>{t(s)&&(this._reject=null,r(s),this.dispose())})})}get promise(){return this._promise}dispose(){this._subscription&&(this._subscription(),this._subscription=null),this._reject&&(this._reject(new ln),this._reject=null)}}class BD{constructor(e){this.promise=e}dispose(){}}class hr extends vi{constructor(e){super(),this._value=e}get(){return this._value}set(e){e!==this._value&&(this._value=e,this.emit(this._value))}}class VD extends vi{constructor(e,t){super(),this.source=e,this.mapper=t}onUnsubscribeLast(){super.onUnsubscribeLast(),this.sourceSubscription=this.sourceSubscription(),this.targetSubscription&&(this.targetSubscription=this.targetSubscription())}onSubscribeFirst(){super.onSubscribeFirst(),this.sourceSubscription=this.source.subscribe(()=>{this.updateTargetSubscription(),this.emit(this.get())}),this.updateTargetSubscription()}updateTargetSubscription(){const e=this.source.get();if(e){const t=this.mapper(e);if(t){this.targetSubscription||(this.targetSubscription=t.subscribe(()=>this.emit(this.get())));return}}this.targetSubscription&&(this.targetSubscription=this.targetSubscription())}get(){const e=this.source.get();if(!e)return;const t=this.mapper(e);return t==null?void 0:t.get()}}class fl extends hr{constructor(e,t,r=()=>{}){super(e),this.freeCallback=t,this.startCallback=r}onSubscribeFirst(){this.startCallback()}onUnsubscribeLast(){super.onUnsubscribeLast(),this.freeCallback()}}class Ao extends Ml{emitReset(){for(let e of this._handlers)e.onReset(this)}emitAdd(e,t){for(let r of this._handlers)r.onAdd(e,t,this)}emitUpdate(e,t,r){for(let i of this._handlers)i.onUpdate(e,t,r,this)}emitRemove(e,t){for(let r of this._handlers)r.onRemove(e,t,this)}emitMove(e,t,r){for(let i of this._handlers)i.onMove(e,t,r,this)}}/**
 * @license
 * Based off baseSortedIndex function in Lodash <https://lodash.com/>
 * Copyright JS Foundation and other contributors <https://js.foundation/>
 * Released under MIT license <https://lodash.com/license>
 * Based on Underscore.js 1.8.3 <http://underscorejs.org/LICENSE>
 * Copyright Jeremy Ashkenas, DocumentCloud and Investigative Reporters & Editors
 */function fr(n,e,t){let r=0,i=n.length;for(;r<i;){let s=r+i>>>1,o=t(e,n[s]);o>0?r=s+1:o<0?i=s:r=i=s}return i}class KD extends Ao{constructor(e=[]){super(),this._items=e}append(e){this._items.push(e),this.emitAdd(this._items.length-1,e)}remove(e){const[t]=this._items.splice(e,1);this.emitRemove(e,t)}insertMany(e,t){for(let r of t)this.insert(e,r),e+=1}insert(e,t){this._items.splice(e,0,t),this.emitAdd(e,t)}move(e,t){if(e<this._items.length&&t<this._items.length){const[r]=this._items.splice(e,1);this._items.splice(t,0,r),this.emitMove(e,t,r)}}update(e,t,r=null){e<this._items.length&&(this._items[e]=t,this.emitUpdate(e,t,r))}get array(){return this._items}at(e){if(this._items&&e>=0&&e<this._items.length)return this._items[e]}get length(){return this._items.length}[Symbol.iterator](){return this._items.values()}}function VE(n,e,t,r){const i=e.findIndex(n);if(i!==-1){const s=e[i],o=r(s);return o!==!1&&t.emitUpdate(i,s,o),!0}return!1}class KE extends Ao{constructor(e){super(),this._items=[],this._comparator=e}setManyUnsorted(e){this.setManySorted(e)}setManySorted(e){for(let t of e)this.set(t)}findAndUpdate(e,t){return VE(e,this._items,this,t)}getAndUpdate(e,t,r=null){const i=this.indexOf(e);if(i!==-1){const s=this._items[i],o=t(s,e);this._items[i]=o,this.emitUpdate(i,o,r)}}update(e,t=null){const r=this.indexOf(e);r!==-1&&(this._items[r]=e,this.emitUpdate(r,e,t))}indexOf(e){const t=fr(this._items,e,this._comparator);return t<this._items.length&&this._comparator(this._items[t],e)===0?t:-1}_getNext(e){let t=fr(this._items,e,this._comparator);for(;t<this._items.length&&this._comparator(this._items[t],e)<=0;)t+=1;return this.get(t)}set(e,t=null){const r=fr(this._items,e,this._comparator);r>=this._items.length||this._comparator(this._items[r],e)!==0?(this._items.splice(r,0,e),this.emitAdd(r,e)):(this._items[r]=e,this.emitUpdate(r,e,t))}get(e){return this._items[e]}remove(e){const t=this._items[e];this._items.splice(e,1),this.emitRemove(e,t)}get array(){return this._items}get length(){return this._items.length}[Symbol.iterator](){return new jD(this)}}class jD{constructor(e){this._consumed=!1,this._sortedArray=e,this._current=null}next(){return this._consumed?{value:void 0,done:!0}:(this._current=this._current?this._sortedArray._getNext(this._current):this._sortedArray.get(0),this._current||(this._consumed=!0),{value:this._current,done:this._consumed})}}class HD extends Ao{constructor(e,t,r,i){super(),this._sourceUnsubscribe=null,this._mappedValues=null,this._sourceList=e,this._mapper=t,this._updater=r,this._removeCallback=i}findAndUpdate(e,t){return VE(e,this._mappedValues,this,t)}get length(){return this._mappedValues.length}[Symbol.iterator](){return this._mappedValues.values()}}function zD(n,e,t){n._mappedValues.splice(e,0,t),n.emitAdd(e,t)}function GD(n,e,t,r){const i=n._mappedValues[e];n._updater&&n._updater(i,r,t),n.emitUpdate(e,i,r)}function qD(n,e){const t=n._mappedValues[e];n._mappedValues.splice(e,1),n._removeCallback&&n._removeCallback(t),n.emitRemove(e,t)}function WD(n,e,t){const r=n._mappedValues[e];n._mappedValues.splice(e,1),n._mappedValues.splice(t,0,r),n.emitMove(e,t,r)}function YD(n){n._mappedValues=[],n.emitReset()}class XD extends HD{constructor(){super(...arguments),this._eventQueue=null,this._flushing=!1}onSubscribeFirst(){this._sourceUnsubscribe=this._sourceList.subscribe(this),this._eventQueue=[],this._mappedValues=[];let e=0;for(const t of this._sourceList)this._eventQueue.push(new dv(e,t)),e+=1;this._flush()}async _flush(){if(!this._flushing){this._flushing=!0;try{for(;this._eventQueue.length;)await this._eventQueue.shift().run(this)}finally{this._flushing=!1}}}onReset(){this._eventQueue&&(this._eventQueue.push(new eN),this._flush())}onAdd(e,t){this._eventQueue&&(this._eventQueue.push(new dv(e,t)),this._flush())}onUpdate(e,t,r){this._eventQueue&&(this._eventQueue.push(new JD(e,t,r)),this._flush())}onRemove(e){this._eventQueue&&(this._eventQueue.push(new QD(e)),this._flush())}onMove(e,t){this._eventQueue&&(this._eventQueue.push(new ZD(e,t)),this._flush())}onUnsubscribeLast(){this._sourceUnsubscribe(),this._eventQueue=null,this._mappedValues=null}}class dv{constructor(e,t){this.index=e,this.value=t}async run(e){const t=await e._mapper(this.value);zD(e,this.index,t)}}class JD{constructor(e,t,r){this.index=e,this.value=t,this.params=r}async run(e){GD(e,this.index,this.value,this.params)}}class QD{constructor(e){this.index=e}async run(e){qD(e,this.index)}}class ZD{constructor(e,t){this.fromIdx=e,this.toIdx=t}async run(e){WD(e,this.fromIdx,this.toIdx)}}class eN{async run(e){YD(e)}}class tN extends Ao{constructor(...e){super(),this._sourceUnsubscribes=null,this._sourceLists=e}_offsetForSource(e){const t=this._sourceLists.indexOf(e);let r=0;for(let i=0;i<t;++i)r+=this._sourceLists[i].length;return r}onSubscribeFirst(){this._sourceUnsubscribes=this._sourceLists.map(e=>e.subscribe(this))}onUnsubscribeLast(){for(const e of this._sourceUnsubscribes)e()}onReset(){this.emitReset();let e=0;for(const t of this)this.emitAdd(e,t),e+=1}onAdd(e,t,r){this.emitAdd(this._offsetForSource(r)+e,t)}onUpdate(e,t,r,i){this._sourceUnsubscribes&&this.emitUpdate(this._offsetForSource(i)+e,t,r)}onRemove(e,t,r){this.emitRemove(this._offsetForSource(r)+e,t)}onMove(e,t,r,i){const s=this._offsetForSource(i);this.emitMove(s+e,s+t,r)}get length(){let e=0;for(let t=0;t<this._sourceLists.length;++t)e+=this._sourceLists[t].length;return e}[Symbol.iterator](){let e=0,t=this._sourceLists[0][Symbol.iterator]();return{next:()=>{let r=t.next();for(;r.done;){if(e+=1,e>=this._sourceLists.length)return r;t=this._sourceLists[e][Symbol.iterator](),r=t.next()}return r}}}}class nN extends Ao{constructor(e,t){super(),this._sourceMap=e,this._comparator=(r,i)=>t(r.value,i.value),this._sortedPairs=null,this._mapSubscription=null}onAdd(e,t){const r={key:e,value:t},i=fr(this._sortedPairs,r,this._comparator);this._sortedPairs.splice(i,0,r),this.emitAdd(i,t)}onRemove(e,t){const r={key:e,value:t},i=fr(this._sortedPairs,r,this._comparator);this._sortedPairs.splice(i,1),this.emitRemove(i,t)}onUpdate(e,t,r){if(!this._sortedPairs)return;const i=this._sortedPairs.findIndex(a=>a.key===e);this._sortedPairs.splice(i,1);const s={key:e,value:t},o=fr(this._sortedPairs,s,this._comparator);this._sortedPairs.splice(o,0,s),i!==o&&this.emitMove(i,o,t),this.emitUpdate(o,t,r)}onReset(){this._sortedPairs=[],this.emitReset()}onSubscribeFirst(){this._mapSubscription=this._sourceMap.subscribe(this),this._sortedPairs=new Array(this._sourceMap.size);let e=0;for(let[t,r]of this._sourceMap)this._sortedPairs[e]={key:t,value:r},++e;this._sortedPairs.sort(this._comparator),super.onSubscribeFirst()}onUnsubscribeLast(){super.onUnsubscribeLast(),this._sortedPairs=null,this._mapSubscription=this._mapSubscription()}get(e){return this._sortedPairs[e].value}get length(){return this._sourceMap.size}[Symbol.iterator](){const e=this._sortedPairs.values();return{next(){const t=e.next();return t.value&&(t.value=t.value.value),t}}}}class Od extends Ml{constructor(){super()}emitReset(){for(let e of this._handlers)e.onReset()}emitAdd(e,t){for(let r of this._handlers)r.onAdd(e,t)}emitUpdate(e,t,r){for(let i of this._handlers)i.onUpdate(e,t,r)}emitRemove(e,t){for(let r of this._handlers)r.onRemove(e,t)}join(...e){return new sN([this].concat(e))}mapValues(e,t){return new lN(this,e,t)}sortValues(e){return new nN(this,e)}filterValues(e){return new rN(this,e)}observeSize(){return new cN(this)}}class rN extends Od{constructor(e,t){super(),this._source=e,this._filter=t}setFilter(e){this._filter=e,this._subscription&&this._reapplyFilter()}_reapplyFilter(e=!1){if(this._filter){const t=this._included;this._included=this._included||new Map;for(const[r,i]of this._source){const s=this._filter(i,r);if(this._included.set(r,s),!e){const o=t?t.get(r):!0;this._emitForUpdate(o,s,r,i)}}}else{if(this._included&&!e)for(const[t,r]of this._source)this._included.get(t)||this.emitAdd(t,r);this._included=void 0}}onAdd(e,t){if(this._filter)if(this._included){const r=this._filter(t,e);if(this._included.set(e,r),!r)return}else throw new Error("Internal logic error: FilteredMap._included used before initialized");this.emitAdd(e,t)}onRemove(e,t){var r;const i=!this._filter||((r=this._included)==null?void 0:r.get(e));if(this._included)this._included.delete(e),i&&this.emitRemove(e,t);else throw new Error("Internal logic error: FilteredMap._included used before initialized")}onUpdate(e,t,r){if(this._included)if(this._filter){const i=this._included.get(e),s=this._filter(t,e);this._included.set(e,s),this._emitForUpdate(i,s,e,t,r)}else this.emitUpdate(e,t,r)}_emitForUpdate(e,t,r,i,s=null){e&&!t?this.emitRemove(r,i):!e&&t?this.emitAdd(r,i):e&&t&&this.emitUpdate(r,i,s)}onSubscribeFirst(){this._subscription=this._source.subscribe(this),this._reapplyFilter(!0),super.onSubscribeFirst()}onUnsubscribeLast(){super.onUnsubscribeLast(),this._included=void 0,this._subscription&&(this._subscription=this._subscription())}onReset(){this._reapplyFilter(),this.emitReset()}[Symbol.iterator](){return new iN(this._source,this._included)}get size(){var e;let t=0;return(e=this._included)==null||e.forEach(r=>{r&&(t+=1)}),t}get(e){const t=this._source.get(e);if(t&&this._filter(t,e))return t}}class iN{constructor(e,t){this._included=t,this._sourceIterator=e[Symbol.iterator]()}next(){for(var e;;){const t=this._sourceIterator.next();if(t.done)return t;const r=t.value[0];if((e=this._included)!=null&&e.get(r))return t}}}class sN extends Od{constructor(e){super(),this._sources=e}onAdd(e,t,r){if(!this._isKeyAtSourceOccluded(e,t)){const i=this._getValueFromOccludedSources(e,t);i!==void 0&&this.emitRemove(t,i),this.emitAdd(t,r)}}onRemove(e,t,r){if(!this._isKeyAtSourceOccluded(e,t)){this.emitRemove(t,r);const i=this._getValueFromOccludedSources(e,t);i!==void 0&&this.emitAdd(t,i)}}onUpdate(e,t,r,i){this._subscriptions&&(this._isKeyAtSourceOccluded(e,t)||this.emitUpdate(t,r,i))}onReset(){this.emitReset()}onSubscribeFirst(){this._subscriptions=this._sources.map(e=>new aN(e,this).subscribe()),super.onSubscribeFirst()}_isKeyAtSourceOccluded(e,t){const r=this._sources.indexOf(e);for(let i=0;i<r;i+=1)if(this._sources[i].get(t)!==void 0)return!0;return!1}_getValueFromOccludedSources(e,t){const r=this._sources.indexOf(e);for(let i=r+1;i<this._sources.length;i+=1){const o=this._sources[i].get(t);if(o!==void 0)return o}}onUnsubscribeLast(){if(super.onUnsubscribeLast(),this._subscriptions)for(const e of this._subscriptions)e.dispose()}[Symbol.iterator](){return new oN(this._sources)}get size(){return this._sources.reduce((e,t)=>e+t.size,0)}get(e){for(const t of this._sources){const r=t.get(e);if(r)return r}}}class oN{constructor(e){this._sourceIndex=-1,this._encounteredKeys=new Set,this._sources=e}next(){var e;let t;for(;!t;){if(!this._currentIterator){if(this._sourceIndex+=1,this._sources.length<=this._sourceIndex)return{done:!0,value:null};this._currentIterator=this._sources[this._sourceIndex][Symbol.iterator]()}const r=(e=this._currentIterator)==null?void 0:e.next();if(!r||r.done){this._currentIterator=void 0;continue}else{const i=r.value[0];this._encounteredKeys.has(i)||(this._encounteredKeys.add(i),t=r)}}return t}}class aN{constructor(e,t){this._source=e,this._joinedMap=t,this._subscription=void 0}subscribe(){return this._subscription=this._source.subscribe(this),this}dispose(){this._subscription&&(this._subscription=this._subscription())}onAdd(e,t){this._joinedMap.onAdd(this._source,e,t)}onRemove(e,t){this._joinedMap.onRemove(this._source,e,t)}onUpdate(e,t,r){this._joinedMap.onUpdate(this._source,e,t,r)}onReset(){this._joinedMap.onReset()}}class lN extends Od{constructor(e,t,r){super(),this._source=e,this._mapper=t,this._updater=r,this._mappedValues=new Map}_emitSpontaneousUpdate(e,t){const r=this._mappedValues.get(e);r&&this.emitUpdate(e,r,t)}onAdd(e,t){const r=this._emitSpontaneousUpdate.bind(this,e),i=this._mapper(t,r);this._mappedValues.set(e,i),this.emitAdd(e,i)}onRemove(e){const t=this._mappedValues.get(e);this._mappedValues.delete(e)&&t&&this.emitRemove(e,t)}onUpdate(e,t,r){var i;if(!this._mappedValues)return;const s=this._mappedValues.get(e);s!==void 0&&((i=this._updater)==null||i.call(this,r,s,t),this.emitUpdate(e,s,r))}onSubscribeFirst(){this._subscription=this._source.subscribe(this);for(let[e,t]of this._source){const r=this._emitSpontaneousUpdate.bind(this,e),i=this._mapper(t,r);this._mappedValues.set(e,i)}super.onSubscribeFirst()}onUnsubscribeLast(){super.onUnsubscribeLast(),this._subscription&&(this._subscription=this._subscription()),this._mappedValues.clear()}onReset(){this._mappedValues.clear(),this.emitReset()}[Symbol.iterator](){return this._mappedValues.entries()}get size(){return this._mappedValues.size}get(e){return this._mappedValues.get(e)}}class pr extends Od{constructor(e){super(),this._values=new Map(e)}update(e,t){const r=this._values.get(e);return r!==void 0?(this._values.set(e,r),this.emitUpdate(e,r,t),!0):!1}add(e,t){return this._values.has(e)?!1:(this._values.set(e,t),this.emitAdd(e,t),!0)}remove(e){const t=this._values.get(e);return t!==void 0?(this._values.delete(e),this.emitRemove(e,t),!0):!1}set(e,t){return this._values.has(e)?(this._values.set(e,t),this.update(e,void 0)):this.add(e,t)}reset(){this._values.clear(),this.emitReset()}get(e){return this._values.get(e)}get size(){return this._values.size}[Symbol.iterator](){return this._values.entries()}values(){return this._values.values()}keys(){return this._values.keys()}}class cN extends vi{constructor(e){super(),this.map=e}onSubscribeFirst(){this.subscription=this.map.subscribe({onAdd:(e,t)=>{this.emit(this.get())},onRemove:(e,t)=>{this.emit(this.get())},onUpdate:(e,t)=>{},onReset:()=>{this.emit(this.get())}})}onUnsubscribeLast(){var e;this.subscription=(e=this.subscription)==null?void 0:e.call(this)}get(){return this.map.size}}function uN(n,e,t,r){const i=n(e);let s=!1;return i.elapsed().then(()=>{s=!0,t.abort()},()=>{}),r.then(o=>(i.abort(),o),o=>{throw i.abort(),o.name==="AbortError"&&s?new dr(`Request timed out after ${e}ms`,!0):o})}function jE(n,e=Math.random){return n.includes("?")?n=n+"&":n=n+"?",n+`_cacheBuster=${Math.ceil(e()*Number.MAX_SAFE_INTEGER)}`}function HE(n){var e;const t=new FormData;for(const[r,i]of n)(e=i.blob)!=null&&e.nativeBlob&&i.name?t.set(r,i.blob.nativeBlob,i.name):t.set(r,i);return t}class dN{constructor(e,t){this._promise=e,this._xhr=t}abort(){this._xhr.abort()}response(){return this._promise}}function hN(n,{method:e,headers:t,timeout:r,format:i,uploadProgress:s}){const o=new XMLHttpRequest;if(s&&o.upload.addEventListener("progress",a=>s(a.loaded)),o.open(e,n),i==="buffer"&&(o.responseType="arraybuffer"),t)for(const[a,c]of t.entries())try{o.setRequestHeader(a,c)}catch(u){console.info(`Could not set ${a} header: ${u.message}`)}return r&&(o.timeout=r),o}function fN(n,e,t){return new Promise((r,i)=>{n.addEventListener("load",()=>r(n)),n.addEventListener("abort",()=>i(new ln)),n.addEventListener("error",()=>i(new dr(`Error ${e} ${t}`))),n.addEventListener("timeout",()=>i(new dr(`Timeout ${e} ${t}`,!0)))})}function zE(n,e){let{cache:t,format:r,body:i,method:s}=e;t||(n=jE(n));const o=hN(n,e),a=fN(o,s,n).then(c=>{const{status:u}=c;let l=null;return r==="buffer"?l=c.response:c.getResponseHeader("Content-Type")==="application/json"&&(l=JSON.parse(c.responseText)),{status:u,body:l}});return i!=null&&i.nativeBlob&&(i=i.nativeBlob),i instanceof Map&&(i=HE(i)),o.send(i||null),new dN(a,o)}class hv{constructor(e,t){if(t)this.promise=e,this._controller=t;else{const r=new Promise((i,s)=>{this._controller={abort(){const o=new Error("fetch request aborted");o.name="AbortError",s(o)}}});this.promise=Promise.race([e,r])}}abort(){this._controller.abort()}response(){return this.promise}}function pN(n,e){return function(r,i){if(e!=null&&e.haltRequests)return new hv(new Promise(()=>{}),{});if(i!=null&&i.uploadProgress)return zE(r,i);let{method:s,headers:o,body:a,timeout:c,format:u,cache:l=!1}=i;const d=typeof AbortController=="function"?new AbortController:null;a!=null&&a.nativeBlob&&(a=a.nativeBlob),a instanceof Map&&(a=HE(a));let p={method:s,body:a};if(d&&(p=Object.assign(p,{signal:d.signal})),l||(r=jE(r)),p=Object.assign(p,{mode:"cors",credentials:"omit",referrer:"no-referrer",cache:"default"}),o){const S=new Headers;for(const[v,_]of o.entries())S.append(v,_);p.headers=S}const m=fetch(r,p).then(async S=>{const{status:v}=S;let _;try{u==="json"?_=await S.json():u==="buffer"?_=await S.arrayBuffer():u==="text"&&(_=await S.text())}catch(b){if(!(b.name==="SyntaxError"&&v>=400))throw b}return{status:v,body:_}},S=>{throw S.name==="AbortError"?new ln:S instanceof TypeError?new dr(`${s} ${r}: ${S.message}`):S}),w=new hv(m,d);return c&&(w.promise=uN(n,c,w,w.promise)),w}}function $u(){}class mN{constructor(){this.item=new _N(this)}log(e){return this.item}addReporter(){}get reporters(){return[]}getOpenRootItems(){return[]}forceFinish(){}child(e){return this.item}run(e,t){return t(this.item)}wrapOrRun(e,t,r){return e?e.wrap(t,r):this.run(t,r)}runDetached(e,t){return new Promise(r=>r(t(this.item))).then($u,$u),this.item}get level(){return tn}}class _N{constructor(e){this.logger=e}discard(){}wrap(e,t){return this.run(t)}run(e){return e(this)}log(e){return this}set(e){return this}runDetached(e,t){return new Promise(r=>r(t(this))).then($u,$u),this}wrapDetached(e,t){return this.refDetached()}refDetached(){}ensureRefId(){}get level(){return tn}get duration(){return 0}catch(e){return e}child(){return this}finish(){}forceFinish(){}serialize(){}}const gN=new mN;class fv{constructor(e,t){this._target=e,this._transaction=t}get idbFactory(){return this._transaction.idbFactory}get IDBKeyRange(){return this._transaction.IDBKeyRange}get databaseName(){return this._transaction.databaseName}_openCursor(e,t){return e&&t?this._target.openCursor(e,t):e?this._target.openCursor(e):t?this._target.openCursor(null,t):this._target.openCursor()}supports(e){return this._target.supports(e)}count(e){return Et(this._target.count(e))}get(e){return Et(this._target.get(e))}getKey(e){return this._target.supports("getKey")?Et(this._target.getKey(e)):Et(this._target.get(e)).then(t=>{if(t){let r=this._target.keyPath;return typeof r=="string"&&(r=[r]),r.reduce((i,s)=>i[s],t)}})}reduce(e,t,r){return this._reduce(e,t,r,"next")}reduceReverse(e,t,r){return this._reduce(e,t,r,"prev")}selectLimit(e,t){return this._selectLimit(e,t,"next")}selectLimitReverse(e,t){return this._selectLimit(e,t,"prev")}selectWhile(e,t){return this._selectWhile(e,t,"next")}selectWhileReverse(e,t){return this._selectWhile(e,t,"prev")}async selectAll(e,t){const r=this._openCursor(e,t),i=[];return await Ge(r,s=>(i.push(s),vr)),i}selectFirst(e){return this._find(e,()=>!0,"next")}selectLast(e){return this._find(e,()=>!0,"prev")}find(e,t){return this._find(e,t,"next")}findReverse(e,t){return this._find(e,t,"prev")}async findMaxKey(e){const t=this._target.openKeyCursor(e,"prev");let r;return await Ge(t,(i,s)=>(r=s,uv)),r}async iterateValues(e,t){const r=this._target.openCursor(e,"next");await Ge(r,(i,s,o)=>({done:t(i,s,o)}))}async iterateKeys(e,t){const r=this._target.openKeyCursor(e,"next");await Ge(r,(i,s,o)=>({done:t(s,o)}))}async findExistingKeys(e,t,r){const i=(d,p)=>t?-this.idbFactory.cmp(d,p):this.idbFactory.cmp(d,p),s=e.slice().sort(i),o=s[0],a=s[s.length-1],c=t?"prev":"next",u=this._target.openKeyCursor(this.IDBKeyRange.bound(o,a),c);let l=0;await Ge(u,(d,p,m)=>{for(;l<s.length&&i(s[l],p)<0;)l+=1;let w=!1;if(s[l]===p){const S=m.primaryKey;w=r(p,S),l+=1}return w||l>=s.length?uv:{done:!1,jumpTo:s[l]}})}_reduce(e,t,r,i){let s=r;const o=this._openCursor(e,i);return Ge(o,a=>(s=t(s,a),vr))}_selectLimit(e,t,r){return this._selectUntil(e,i=>i.length===t,r)}async _selectUntil(e,t,r){const i=this._openCursor(e,r),s=[];return await Ge(i,o=>(s.push(o),{done:t(s,o)})),s}async _selectWhile(e,t,r){const i=this._openCursor(e,r),s=[];return await Ge(i,o=>{const a=t(o);return a&&s.push(o),{done:!a}}),s}async iterateWhile(e,t){const r=this._openCursor(e,"next");await Ge(r,i=>({done:!t(i)}))}async _find(e,t,r){const i=this._openCursor(e,r);let s;if(await Ge(i,a=>{const c=t(a);return c&&(s=a),{done:c}}))return s}}const Mr=!1;function xr(n,e,t){var r,i;const s=t==null?void 0:t.name,o=(i=(r=t==null?void 0:t.transaction)==null?void 0:r.db)==null?void 0:i.name;console.info(`${o}.${s}.${n}(${e.map(a=>JSON.stringify(a)).join(", ")})`)}class pv{constructor(e){this._qt=e}get keyPath(){return this._qtStore.keyPath}get _qtStore(){return"objectStore"in this._qt?this._qt.objectStore:this._qt}supports(e){return!!this._qt[e]}openKeyCursor(e,t){try{return this._qt.openKeyCursor?(Mr&&xr("openKeyCursor",[e,t],this._qt),this._qt.openKeyCursor(e,t)):(Mr&&xr("openCursor",[e,t],this._qt),this.openCursor(e,t))}catch(r){throw new Jn("openKeyCursor",this._qt,r,[e,t])}}openCursor(e,t){try{return Mr&&xr("openCursor",[],this._qt),this._qt.openCursor(e,t)}catch(r){throw new Jn("openCursor",this._qt,r,[e,t])}}put(e,t){try{return Mr&&xr("put",[e,t],this._qt),this._qtStore.put(e,t)}catch(r){throw new Jn("put",this._qt,r,[e,t])}}add(e,t){try{return Mr&&xr("add",[e,t],this._qt),this._qtStore.add(e,t)}catch(r){throw new Jn("add",this._qt,r,[e,t])}}get(e){try{return Mr&&xr("get",[e],this._qt),this._qt.get(e)}catch(t){throw new Jn("get",this._qt,t,[e])}}getKey(e){try{return Mr&&xr("getKey",[e],this._qt),this._qt.getKey(e)}catch(t){throw new Jn("getKey",this._qt,t,[e])}}delete(e){try{return Mr&&xr("delete",[e],this._qt),this._qtStore.delete(e)}catch(t){throw new Jn("delete",this._qt,t,[e])}}count(e){try{return this._qt.count(e)}catch(t){throw new Jn("count",this._qt,t,[e])}}index(e){try{return this._qtStore.index(e)}catch(t){throw new Jn("index",this._qt,t,[e])}}get indexNames(){return Array.from(this._qtStore.indexNames)}}class GE extends fv{constructor(e,t){super(new pv(e),t)}get _idbStore(){return this._target}index(e){return new fv(new pv(this._idbStore.index(e)),this._transaction)}put(e,t){const r=this._idbStore.put(e);this._prepareErrorLog(r,t,"put",void 0,e)}add(e,t){const r=this._idbStore.add(e);this._prepareErrorLog(r,t,"add",void 0,e)}async tryAdd(e,t){try{return await Et(this._idbStore.add(e)),!0}catch(r){if(r instanceof c_)return t.log({l:"could not write",id:this._getKeys(e),e:r},t.level.Warn),r.preventTransactionAbort(),!1;throw r}}delete(e,t){const r=this._idbStore.delete(e);this._prepareErrorLog(r,t,"delete",e,void 0)}_prepareErrorLog(e,t,r,i,s){t&&t.ensureRefId(),Et(e).catch(o=>{let a;s?a=this._getKeys(s):i&&(a=[i]),this._transaction.addWriteError(o,t,r,a)})}_getKeys(e){const t=[],{keyPath:r}=this._idbStore;try{t.push(this._readKeyPath(e,r))}catch{console.warn("could not read keyPath",r)}for(const i of this._idbStore.indexNames)try{const s=this._idbStore.index(i);t.push(this._readKeyPath(e,s.keyPath))}catch{console.warn("could not read index",i)}return t}_readKeyPath(e,t){if(Array.isArray(t)){let r=e;for(const i of t)if(typeof r=="object")r=r[i];else break;return r}else return e[t]}}var zr=(n=>(n[n.Sync=0]="Sync",n[n.Timeline=1]="Timeline",n[n.Retry=2]="Retry",n))(zr||{});const nn="e2ee:",d_="m.olm.v1.curve25519-aes-sha2",Kn="m.megolm.v1.aes-sha2";class ut extends Error{constructor(e,t,r){super(`Decryption error ${e}${r?": "+JSON.stringify(r):""}`),this.code=e,this.event=t,this.detailsObj=r}}const yN="ed25519";function Gi(n){return n.keys[`ed25519:${n.device_id}`]}function nr(n){return n.keys[`curve25519:${n.device_id}`]}function vN(n,e,t){var r,i;return(i=(r=n==null?void 0:n.signatures)==null?void 0:r[e])==null?void 0:i[`${yN}:${t}`]}var Ue=(n=>(n[n.Valid=0]="Valid",n[n.Invalid=1]="Invalid",n[n.NotSigned=2]="NotSigned",n))(Ue||{});function h_(n,e,t,r,i,s){const o=vN(i,e,t);if(!o)return s==null||s.set("no_signature",!0),2;const a=Object.assign({},i);delete a.unsigned,delete a.signatures;const c=Cl.stringify(a);try{return n.ed25519_verify(r,c,o),0}catch(u){if(s){const l=s.log({l:"Invalid signature, ignoring.",ed25519Key:r,canonicalJson:c,signature:o});l.error=u,l.logLevel=s.level.Warn}return 1}}function wN(){return{type:"m.room.encryption",state_key:"",content:{algorithm:Kn,rotation_period_ms:6048e5,rotation_period_msgs:100}}}function dc(n,e){switch(e){case"world_readable":return!0;case"shared":return n!==void 0;case"joined":return n==="join";case"invited":return n==="invite"||n==="join";default:return!1}}function bN(n){return JSON.stringify(qE(n))}function SN(n){return WE(JSON.parse(n))}function qE(n){if(typeof n=="object"&&n!==null&&!Array.isArray(n)){if(n.byteLength)return{_type:n.constructor.name,value:Array.from(n)};let e={};for(const t in n)n.hasOwnProperty(t)&&(e[t]=qE(n[t]));return e}else return n}function WE(n){if(typeof n=="object"&&n!==null&&!Array.isArray(n)){if(typeof n._type=="string")switch(n._type){case"Int8Array":return Int8Array.from(n.value);case"Uint8Array":return Uint8Array.from(n.value);case"Uint8ClampedArray":return Uint8ClampedArray.from(n.value);case"Int16Array":return Int16Array.from(n.value);case"Uint16Array":return Uint16Array.from(n.value);case"Int32Array":return Int32Array.from(n.value);case"Uint32Array":return Uint32Array.from(n.value);case"Float32Array":return Float32Array.from(n.value);case"Float64Array":return Float64Array.from(n.value);case"BigInt64Array":return BigInt64Array.from(n.value);case"BigUint64Array":return BigUint64Array.from(n.value);default:return n.value}let e={};for(const t in n)n.hasOwnProperty(t)&&(e[t]=WE(n[t]));return e}else return n}function YE(n){return`${n}.session.`}function EN(n,e){const t=[];for(let r=0;r<n.length;r++){const i=n.key(r);i!=null&&i.startsWith(YE(e))&&t.push(i)}for(const r of t)n.removeItem(r)}class f_{constructor(e,t){this._sessionStore=e,this._localStorage=t}get _localStorageKeyPrefix(){return YE(this._sessionStore.databaseName)}async get(e){const t=await this._sessionStore.get(e);if(t)return t.value}_writeKeyToLocalStorage(e,t){try{const r=this._localStorageKeyPrefix+e,i=bN(t);this._localStorage.setItem(r,i)}catch(r){console.error("could not write to localStorage",r)}}writeE2EEIdentityToLocalStorage(){this._sessionStore.iterateValues(void 0,(e,t)=>(t.startsWith(nn)&&this._writeKeyToLocalStorage(t,e.value),!1))}async tryRestoreE2EEIdentityFromLocalStorage(e){let t=!1;const r=this._localStorageKeyPrefix,i=r+nn;for(let s=0;s<this._localStorage.length;s+=1){const o=this._localStorage.key(s);if(o.startsWith(i)){const a=SN(this._localStorage.getItem(o)),c=o.substr(r.length),u=await this._sessionStore.getKey(c)===c;e.set(c,!u),u||(this._sessionStore.put({key:c,value:a}),t=!0)}}return t}set(e,t){e.startsWith(nn)&&this._writeKeyToLocalStorage(e,t),this._sessionStore.put({key:e,value:t})}add(e,t){e.startsWith(nn)&&this._writeKeyToLocalStorage(e,t),this._sessionStore.add({key:e,value:t})}remove(e){e.startsWith(nn)&&this._localStorage.removeItem(this._localStorageKeyPrefix+e),this._sessionStore.delete(e)}}class mv{constructor(e){this._summaryStore=e}getAll(){return this._summaryStore.selectAll()}set(e){this._summaryStore.put(e)}get(e){return this._summaryStore.get(e)}async has(e){const t=await this._summaryStore.getKey(e);return e===t}remove(e){this._summaryStore.delete(e)}}class kN{constructor(e){this._inviteStore=e}getAll(){return this._inviteStore.selectAll()}set(e){this._inviteStore.put(e)}remove(e){this._inviteStore.delete(e)}}class We{constructor(e,t){this.fragmentId=e,this.eventIndex=t}nextFragmentKey(){return new We(this.fragmentId+1,Le.middleStorageKey)}nextKeyForDirection(e){return e.isForward?this.nextKey():this.previousKey()}previousKey(){return new We(this.fragmentId,this.eventIndex-1)}nextKey(){return new We(this.fragmentId,this.eventIndex+1)}static get maxKey(){return new We(Le.maxStorageKey,Le.maxStorageKey)}static get minKey(){return new We(Le.minStorageKey,Le.minStorageKey)}static get defaultLiveKey(){return We.defaultFragmentKey(Le.minStorageKey)}static defaultFragmentKey(e){return new We(e,Le.middleStorageKey)}toString(){return`[${this.fragmentId}/${this.eventIndex}]`}equals(e){return this.fragmentId===(e==null?void 0:e.fragmentId)&&this.eventIndex===(e==null?void 0:e.eventIndex)}}function XE(n,e,t){return{fragmentId:n.fragmentId,eventIndex:n.eventIndex,roomId:e,event:t}}function La(n,e,t){t.isForward?n.push(e):n.unshift(e)}function IN(n,e,t){return t.isForward?n.concat(e):e.concat(n)}function mn(n,e,t){return`${n}|${Uu(e)}|${Uu(t)}`}function TN(n){const[e,t,r]=n.split("|");return{roomId:e,eventKey:new We(op(t),op(r))}}function hc(n,e){return`${n}|${e}`}function _v(n){const[e,t]=n.split("|");return{roomId:e,eventId:t}}class fc{constructor(e,t,r,i,s=!1,o=!1){this._IDBKeyRange=e,this._only=t,this._lower=r,this._upper=i,this._lowerOpen=s,this._upperOpen=o}asIDBKeyRange(e){try{if(this._only)return this._IDBKeyRange.only(mn(e,this._only.fragmentId,this._only.eventIndex));if(this._lower&&!this._upper)return this._IDBKeyRange.bound(mn(e,this._lower.fragmentId,this._lower.eventIndex),mn(e,this._lower.fragmentId,Le.maxStorageKey),this._lowerOpen,!1);if(!this._lower&&this._upper)return this._IDBKeyRange.bound(mn(e,this._upper.fragmentId,Le.minStorageKey),mn(e,this._upper.fragmentId,this._upper.eventIndex),!1,this._upperOpen);if(this._lower&&this._upper)return this._IDBKeyRange.bound(mn(e,this._lower.fragmentId,this._lower.eventIndex),mn(e,this._upper.fragmentId,this._upper.eventIndex),this._lowerOpen,this._upperOpen)}catch(t){throw new ur("IDBKeyRange failed with data: "+JSON.stringify(this),t)}}}class RN{constructor(e){this._timelineStore=e}onlyRange(e){return new fc(this._timelineStore.IDBKeyRange,e)}upperBoundRange(e,t=!1){return new fc(this._timelineStore.IDBKeyRange,void 0,void 0,e,void 0,t)}lowerBoundRange(e,t=!1){return new fc(this._timelineStore.IDBKeyRange,void 0,e,void 0,t)}boundRange(e,t,r=!1,i=!1){return new fc(this._timelineStore.IDBKeyRange,void 0,e,t,r,i)}async lastEvents(e,t,r){const i=We.maxKey;return i.fragmentId=t,this.eventsBefore(e,i,r)}async firstEvents(e,t,r){const i=We.minKey;return i.fragmentId=t,this.eventsAfter(e,i,r)}eventsAfter(e,t,r){const i=this.lowerBoundRange(t,!0).asIDBKeyRange(e);return this._timelineStore.selectLimit(i,r)}async eventsBefore(e,t,r){const i=this.upperBoundRange(t,!0).asIDBKeyRange(e),s=await this._timelineStore.selectLimitReverse(i,r);return s.reverse(),s}async getEventKeysForIds(e,t){const r=this._timelineStore.index("byEventId"),i=t.map(o=>hc(e,o)),s=new Map;return await r.findExistingKeys(i,!1,(o,a)=>{const{eventId:c}=_v(o),{eventKey:u}=TN(a);return s.set(c,u),!1}),s}async findFirstOccurringEventId(e,t){const r=this._timelineStore.index("byEventId"),i=t.map(c=>hc(e,c)),s=new Array(i.length);let o;function a(){for(let c=0;c<s.length;++c){if(s[c]===void 0)return;if(s[c]===!0)return i[c]}}return await r.findExistingKeys(i,!1,(c,u)=>{const l=i.indexOf(c);return s[l]=u,o=a(),!!o}),o&&_v(o).eventId}tryInsert(e,t){return e.key=mn(e.roomId,e.fragmentId,e.eventIndex),e.eventIdKey=hc(e.roomId,e.event.event_id),this._timelineStore.tryAdd(e,t)}update(e){this._timelineStore.put(e)}get(e,t){return this._timelineStore.get(mn(e,t.fragmentId,t.eventIndex))}getByEventId(e,t){return this._timelineStore.index("byEventId").get(hc(e,t))}removeAllForRoom(e){const t=mn(e,Le.minStorageKey,Le.minStorageKey),r=mn(e,Le.maxStorageKey,Le.maxStorageKey),i=this._timelineStore.IDBKeyRange.bound(t,r);this._timelineStore.delete(i)}}const Ke="\0",$e="";function Rn(n,e,t,r){return`${n}|${e}|${t}|${r}`}function gv(n){const[e,t,r,i]=n.split("|");return{roomId:e,targetEventId:t,relType:r,sourceEventId:i}}class CN{constructor(e){this._store=e}add(e,t,r,i){this._store.add({key:Rn(e,t,r,i)})}remove(e,t,r,i){this._store.delete(Rn(e,t,r,i))}removeAllForTarget(e,t){const r=this._store.IDBKeyRange.bound(Rn(e,t,Ke,Ke),Rn(e,t,$e,$e),!0,!0);this._store.delete(r)}removeAllForRoom(e){const t=this._store.IDBKeyRange.bound(Rn(e,Ke,Ke,Ke),Rn(e,$e,$e,$e),!0,!0);this._store.delete(t)}async getForTargetAndType(e,t,r){const i=this._store.IDBKeyRange.bound(Rn(e,t,r,Ke),Rn(e,t,r,$e),!0,!0);return(await this._store.selectAll(i)).map(o=>gv(o.key))}async getAllForTarget(e,t){const r=this._store.IDBKeyRange.bound(Rn(e,t,Ke,Ke),Rn(e,t,$e,$e),!0,!0);return(await this._store.selectAll(r)).map(s=>gv(s.key))}}function pc(n,e,t){return`${n}|${e}|${t}`}class MN{constructor(e){this._roomStateStore=e}get(e,t,r){const i=pc(e,t,r);return this._roomStateStore.get(i)}getAllForType(e,t){const r=this._roomStateStore.IDBKeyRange.bound(pc(e,t,""),pc(e,t,$e),!1,!0);return this._roomStateStore.selectAll(r)}set(e,t){const r=pc(e,t.type,t.state_key),i={roomId:e,event:t,key:r};this._roomStateStore.put(i)}removeAllForRoom(e){const t=this._roomStateStore.IDBKeyRange.bound(e,`${e}|${$e}`,!0,!0);this._roomStateStore.delete(t)}}function mc(n,e){return`${n}|${e}`}function xN(n){const[e,t]=n.split("|");return{roomId:e,userId:t}}class JE{constructor(e){this._roomMembersStore=e}get(e,t){return this._roomMembersStore.get(mc(e,t))}set(e){e.key=mc(e.roomId,e.userId),this._roomMembersStore.put(e)}getAll(e){const t=this._roomMembersStore.IDBKeyRange.lowerBound(mc(e,""));return this._roomMembersStore.selectWhile(t,r=>r.roomId===e)}async getAllUserIds(e){const t=[],r=this._roomMembersStore.IDBKeyRange.lowerBound(mc(e,""));return await this._roomMembersStore.iterateKeys(r,i=>{const s=xN(i);return s.roomId===e?(t.push(s.userId),!1):!0}),t}removeAllForRoom(e){const t=this._roomMembersStore.IDBKeyRange.bound(e,`${e}|${$e}`,!0,!0);this._roomMembersStore.delete(t)}}function _c(n,e){return`${n}|${Uu(e)}`}class AN{constructor(e){this._store=e}_allRange(e){try{return this._store.IDBKeyRange.bound(_c(e,Le.minStorageKey),_c(e,Le.maxStorageKey))}catch(t){throw new ur(`error from IDBKeyRange with roomId ${e}`,t)}}all(e){return this._store.selectAll(this._allRange(e))}liveFragment(e){return this._store.findReverse(this._allRange(e),t=>typeof t.nextId!="number"&&typeof t.nextToken!="string")}add(e){e.key=_c(e.roomId,e.id),this._store.add(e)}update(e){this._store.put(e)}get(e,t){return this._store.get(_c(e,t))}removeAllForRoom(e){this._store.delete(this._allRange(e))}}function Ti(n,e){return`${n}|${Uu(e)}`}function DN(n){const[e,t]=n.split("|"),r=op(t);return{roomId:e,queueIndex:r}}class NN{constructor(e){this._eventStore=e}async getMaxQueueIndex(e){const t=this._eventStore.IDBKeyRange.bound(Ti(e,Le.minStorageKey),Ti(e,Le.maxStorageKey),!1,!1),r=await this._eventStore.findMaxKey(t);if(r)return DN(r).queueIndex}remove(e,t){const r=this._eventStore.IDBKeyRange.only(Ti(e,t));this._eventStore.delete(r)}async exists(e,t){const r=this._eventStore.IDBKeyRange.only(Ti(e,t));return!!await this._eventStore.getKey(r)}add(e){e.key=Ti(e.roomId,e.queueIndex),this._eventStore.add(e)}update(e){this._eventStore.put(e)}getAll(){return this._eventStore.selectAll()}removeAllForRoom(e){const t=Ti(e,Le.minStorageKey),r=Ti(e,Le.maxStorageKey),i=this._eventStore.IDBKeyRange.bound(t,r);this._eventStore.delete(i)}}class PN{constructor(e){this._store=e}get(e){return this._store.get(e)}set(e){this._store.put(e)}remove(e){this._store.delete(e)}}function Ri(n,e){return`${n}|${e}`}function ON(n){const[e,t]=n.split("|");return{userId:e,deviceId:t}}class UN{constructor(e){this._store=e}async getAllForUserId(e){const t=this._store.IDBKeyRange.lowerBound(Ri(e,Ke));return(await this._store.selectWhile(t,i=>i.deviceKey.user_id===e)).map(i=>i.deviceKey)}async getAllDeviceIds(e){const t=[],r=this._store.IDBKeyRange.lowerBound(Ri(e,Ke));return await this._store.iterateKeys(r,i=>{const s=ON(i);return s.userId===e?(t.push(s.deviceId),!1):!0}),t}async get(e,t){var r;return(r=await this._store.get(Ri(e,t)))==null?void 0:r.deviceKey}set(e){this._store.put({key:Ri(e.user_id,e.device_id),curve25519Key:nr(e),deviceKey:e})}async getByCurve25519Key(e){const t=await this._store.index("byCurve25519Key").get(e);return t==null?void 0:t.deviceKey}remove(e,t){this._store.delete(Ri(e,t))}removeAllForUser(e){const t=this._store.IDBKeyRange.bound(Ri(e,Ke),Ri(e,$e),!0,!0);this._store.delete(t)}}function ra(n,e){return`${n}|${e}`}class $N{constructor(e){this._store=e}async get(e,t){var r;return(r=await this._store.get(ra(e,t)))==null?void 0:r.crossSigningKey}set(e){this._store.put({key:ra(e.user_id,e.usage[0]),crossSigningKey:e})}remove(e,t){this._store.delete(ra(e,t))}removeAllForUser(e){const t=this._store.IDBKeyRange.bound(ra(e,Ke),ra(e,$e),!0,!0);this._store.delete(t)}}function ia(n,e){return`${n}|${e}`}function LN(n){const[e,t]=n.split("|");return{senderKey:e,sessionId:t}}class FN{constructor(e){this._store=e}async getSessionIds(e){const t=[],r=this._store.IDBKeyRange.lowerBound(ia(e,""));return await this._store.iterateKeys(r,i=>{const s=LN(i);return s.senderKey===e?(t.push(s.sessionId),!1):!0}),t}getAll(e){const t=this._store.IDBKeyRange.lowerBound(ia(e,""));return this._store.selectWhile(t,r=>r.senderKey===e)}get(e,t){return this._store.get(ia(e,t))}set(e){e.key=ia(e.senderKey,e.sessionId),this._store.put(e)}remove(e,t){this._store.delete(ia(e,t))}}var Ud=(n=>(n[n.NotBackedUp=0]="NotBackedUp",n[n.BackedUp=1]="BackedUp",n))(Ud||{}),xl=(n=>(n[n.DeviceMessage=1]="DeviceMessage",n[n.Backup=2]="Backup",n[n.Outbound=3]="Outbound",n))(xl||{});function fs(n,e,t){return`${n}|${e}|${t}`}class BN{constructor(e){this._store=e}async has(e,t,r){const i=fs(e,t,r),s=await this._store.getKey(i);return i===s}get(e,t,r){return this._store.get(fs(e,t,r))}set(e){const t=e;t.key=fs(e.roomId,e.senderKey,e.sessionId),this._store.put(t)}removeAllForRoom(e){const t=this._store.IDBKeyRange.bound(fs(e,Ke,Ke),fs(e,$e,$e));this._store.delete(t)}countNonBackedUpSessions(){return this._store.index("byBackup").count(this._store.IDBKeyRange.only(0))}getFirstNonBackedUpSessions(e){return this._store.index("byBackup").selectLimit(this._store.IDBKeyRange.only(0),e)}async markAsBackedUp(e,t,r){const i=await this._store.get(fs(e,t,r));i&&(i.backup=1,this._store.put(i))}async markAllAsNotBackedUp(){const e=this._store.IDBKeyRange.only(1);let t=0;return await this._store.index("byBackup").iterateValues(e,(r,i,s)=>(r.backup=0,s.update(r),t+=1,!1)),t}}class VN{constructor(e){this._store=e}remove(e){this._store.delete(e)}get(e){return this._store.get(e)}set(e){this._store.put(e)}}function gc(n,e,t){return`${n}|${e}|${t}`}class KN{constructor(e){this._store=e}get(e,t,r){return this._store.get(gc(e,t,r))}set(e,t,r,i){i.key=gc(e,t,r),this._store.put(i)}removeAllForRoom(e){const t=this._store.IDBKeyRange.bound(gc(e,Ke,Ke),gc(e,$e,$e));this._store.delete(t)}}function va(n,e){return`${n}|${e}`}class jN{constructor(e){this._store=e}getAll(){return this._store.selectAll()}async getAllByTypeAndScope(e,t){const r=va(t,e),i=[];return await this._store.index("byScopeAndType").iterateWhile(r,s=>s.scopeTypeKey!==r?!1:(i.push(s),!0)),i}add(e){e.scopeTypeKey=va(e.scope,e.type),this._store.add(e)}update(e){this._store.put(e)}remove(e){this._store.delete(e)}async removeAllForScope(e){const t=this._store.IDBKeyRange.bound(va(e,Ke),va(e,$e));await this._store.index("byScopeAndType").iterateValues(t,(i,s,o)=>(o.delete(),!0))}}class HN{constructor(e){this._store=e}async get(e){return await this._store.get(e)}set(e){this._store.put(e)}async getAll(){return await this._store.selectAll()}}function ps(n,e,t){return`${n}|${e}|${t}`}function yv(n){const[e,t,r]=n.key.split("|");return{intent:e,roomId:t,callId:r,timestamp:n.timestamp}}class zN{constructor(e){this._callStore=e}async getByIntent(e){const t=this._callStore.IDBKeyRange.bound(ps(e,Ke,Ke),ps(e,$e,$e),!0,!0);return(await this._callStore.selectAll(t)).map(i=>yv(i))}async getByIntentAndRoom(e,t){const r=this._callStore.IDBKeyRange.bound(ps(e,t,Ke),ps(e,t,$e),!0,!0);return(await this._callStore.selectAll(r)).map(s=>yv(s))}add(e){const t={key:ps(e.intent,e.roomId,e.callId),timestamp:e.timestamp};this._callStore.add(t)}remove(e,t,r){this._callStore.delete(ps(e,t,r))}}class GN{constructor(e,t,r,i){this.error=e,this.refItem=t,this.operationName=r,this.keys=i}}class vv{constructor(e,t,r){this._txn=e,this._allowedStoreNames=t,this._stores={},this._storage=r,this._writeErrors=[]}get idbFactory(){return this._storage.idbFactory}get IDBKeyRange(){return this._storage.IDBKeyRange}get databaseName(){return this._storage.databaseName}get logger(){return this._storage.logger}_idbStore(e){if(!this._allowedStoreNames.includes(e))throw new ur(`Invalid store for transaction: ${e}, only ${this._allowedStoreNames.join(", ")} are allowed.`);return new GE(this._txn.objectStore(e),this)}_store(e,t){if(!this._stores[e]){const r=this._idbStore(e);this._stores[e]=t(r)}return this._stores[e]}get session(){return this._store(Ie.session,e=>new f_(e,this._storage.localStorage))}get roomSummary(){return this._store(Ie.roomSummary,e=>new mv(e))}get archivedRoomSummary(){return this._store(Ie.archivedRoomSummary,e=>new mv(e))}get invites(){return this._store(Ie.invites,e=>new kN(e))}get timelineFragments(){return this._store(Ie.timelineFragments,e=>new AN(e))}get timelineEvents(){return this._store(Ie.timelineEvents,e=>new RN(e))}get timelineRelations(){return this._store(Ie.timelineRelations,e=>new CN(e))}get roomState(){return this._store(Ie.roomState,e=>new MN(e))}get roomMembers(){return this._store(Ie.roomMembers,e=>new JE(e))}get pendingEvents(){return this._store(Ie.pendingEvents,e=>new NN(e))}get userIdentities(){return this._store(Ie.userIdentities,e=>new PN(e))}get deviceKeys(){return this._store(Ie.deviceKeys,e=>new UN(e))}get crossSigningKeys(){return this._store(Ie.crossSigningKeys,e=>new $N(e))}get olmSessions(){return this._store(Ie.olmSessions,e=>new FN(e))}get inboundGroupSessions(){return this._store(Ie.inboundGroupSessions,e=>new BN(e))}get outboundGroupSessions(){return this._store(Ie.outboundGroupSessions,e=>new VN(e))}get groupSessionDecryptions(){return this._store(Ie.groupSessionDecryptions,e=>new KN(e))}get operations(){return this._store(Ie.operations,e=>new jN(e))}get accountData(){return this._store(Ie.accountData,e=>new HN(e))}get calls(){return this._store(Ie.calls,e=>new zN(e))}async complete(e){try{await hl(this._txn)}catch(t){throw this._writeErrors.length?(this._logWriteErrors(e),this._writeErrors[0].error):t}}getCause(e){return e instanceof ur&&e.errcode==="AbortError"&&this._writeErrors.length?this._writeErrors[0].error:e}abort(e){try{this._txn.abort()}catch{e==null||e.set("couldNotAbortTxn",!0)}this._writeErrors.length&&this._logWriteErrors(e)}addWriteError(e,t,r,i){(e.errcode!=="AbortError"||this._writeErrors.length===0)&&this._writeErrors.push(new GN(e,t,r,i))}_logWriteErrors(e){const t=i=>{e||i.set("allowedStoreNames",this._allowedStoreNames);for(const s of this._writeErrors)i.wrap({l:s.operationName,id:s.keys},o=>{s.refItem&&o.refDetached(s.refItem),o.catch(s.error)})},r=`${this._writeErrors.length} storage write operation(s) failed`;e?e.wrap(r,t):this.logger.run(r,t)}}const wv="782rh281re38-boguskey";class qN{constructor(e,t,r,i,s,o){this._db=e,this.idbFactory=t,this.IDBKeyRange=r,this._hasWebkitEarlyCloseTxnBug=i,this.storeNames=Ie,this.localStorage=s,this.logger=o}_validateStoreNames(e){const t=e.findIndex(r=>!dl.includes(r));if(t!==-1)throw new ur(`Tried top, a transaction unknown store ${e[t]}`)}async readTxn(e){this._validateStoreNames(e);try{const t=this._db.transaction(e,"readonly");return this._hasWebkitEarlyCloseTxnBug&&await Et(t.objectStore(e[0]).get(wv)),new vv(t,e,this)}catch(t){throw new ur("readTxn failed",t)}}async readWriteTxn(e){this._validateStoreNames(e);try{const t=this._db.transaction(e,"readwrite");return this._hasWebkitEarlyCloseTxnBug&&await Et(t.objectStore(e[0]).get(wv)),new vv(t,e,this)}catch(t){throw new ur("readWriteTxn failed",t)}}close(){this._db.close()}get databaseName(){return this._db.name}}async function WN(n){const e=n.transaction(dl,"readonly"),t={};return await Promise.all(dl.map(async r=>{const i=t[r]=[],s=e.objectStore(r);await Ge(s.openCursor(),o=>(i.push(o),vr))})),t}async function YN(n,e){const t=n.transaction(dl,"readwrite");for(const r of dl){const i=t.objectStore(r);for(const s of e[r])i.add(s)}await hl(t)}function ap(n){var e;return((e=n.unsigned)==null?void 0:e.prev_content)||n.prev_content}const Ln="m.room.redaction";function lp(n){var e;return!!((e=n==null?void 0:n.unsigned)!=null&&e.redacted_because)}var wt=(n=>(n[n.None=1]="None",n[n.BeingCreated=2]="BeingCreated",n[n.Invited=4]="Invited",n[n.Joined=8]="Joined",n[n.Replaced=16]="Replaced",n[n.Archived=32]="Archived",n))(wt||{}),Fn=(n=>(n[n.DirectMessage=0]="DirectMessage",n[n.Private=1]="Private",n[n.Public=2]="Public",n))(Fn||{}),Lu=(n=>(n[n.World=0]="World",n[n.Profile=1]="Profile",n))(Lu||{});function qs(n,e){var t,r;let i;const s=c=>{const u=e(c);u instanceof Promise&&(i=i??[],i.push(u))},o=(t=n.state)==null?void 0:t.events;if(o)for(let c=0;c<o.length;c++)s(o[c]);let a=(r=n.timeline)==null?void 0:r.events;if(a)for(let c=0;c<a.length;c++){const u=a[c];typeof u.state_key=="string"&&s(u)}if(i)return Promise.all(i).then(()=>{})}const zt="m.room.member";class ye{constructor(e){this._data=e}static fromUserId(e,t,r){return new ye({roomId:e,userId:t,membership:r})}static fromMemberEvent(e,t){const r=t==null?void 0:t.state_key;if(typeof r!="string")return;const i=t.content,s=ap(t),o=i==null?void 0:i.membership,a=(i==null?void 0:i.displayname)||(s==null?void 0:s.displayname),c=(i==null?void 0:i.avatar_url)||(s==null?void 0:s.avatar_url);return this._validateAndCreateMember(e,r,o,a,c)}static fromReplacingMemberEvent(e,t){const r=t&&t.state_key;if(typeof r!="string")return;const i=ap(t);return this._validateAndCreateMember(e,r,i==null?void 0:i.membership,i==null?void 0:i.displayname,i==null?void 0:i.avatar_url)}static _validateAndCreateMember(e,t,r,i,s){if(typeof r=="string")return new ye({roomId:e,userId:t,membership:r,avatarUrl:s,displayName:i})}get membership(){return this._data.membership}get displayName(){return this._data.displayName}get name(){return this._data.displayName||this._data.userId}get avatarUrl(){return this._data.avatarUrl}get roomId(){return this._data.roomId}get userId(){return this._data.userId}serialize(){return this._data}equals(e){const t=this._data,r=e._data;return t.roomId===r.roomId&&t.userId===r.userId&&t.membership===r.membership&&t.displayName===r.displayName&&t.avatarUrl===r.avatarUrl}}class QE{constructor(e,t){this.member=e,this.previousMembership=t}get roomId(){return this.member.roomId}get userId(){return this.member.userId}get membership(){return this.member.membership}get wasInvited(){return this.previousMembership==="invite"&&this.membership!=="invite"}get hasLeft(){return this.previousMembership==="join"&&this.membership!=="join"}get hasJoined(){return this.previousMembership!=="join"&&this.membership==="join"}}function XN(n,e,t,r,i){let s=!1;if(t instanceof Uint8Array){const c=new n.PkSigning;i=c.init_with_seed(t),t=c,s=!0}const o=e.signatures||{};delete e.signatures;const a=e.unsigned;e.unsigned&&delete e.unsigned;try{const c=o[r]||{};return o[r]=c,c["ed25519:"+i]=t.sign(Cl.stringify(e))}finally{e.signatures=o,a&&(e.unsigned=a),s&&t.free()}}class Er{constructor(e){this.options=e,this.ourUserId=e.ourUserId,this.ourUserDeviceId=e.ourUserDeviceId,this.otherUserId=e.otherUserId,this.log=e.log,this.olmSAS=e.olmSas,this.olmUtil=e.olmUtil,this.channel=e.channel,this.e2eeAccount=e.e2eeAccount,this.deviceTracker=e.deviceTracker,this.hsApi=e.hsApi,this.eventEmitter=e.eventEmitter}setNextStage(e){this._nextStage=e}get nextStage(){return this._nextStage}get otherUserDeviceId(){const e=this.channel.otherUserDeviceId;if(!e)throw new Error("Accessed otherUserDeviceId before it was set in channel!");return e}}var ae=(n=>(n.Request="m.key.verification.request",n.Ready="m.key.verification.ready",n.Start="m.key.verification.start",n.Accept="m.key.verification.accept",n.Key="m.key.verification.key",n.Cancel="m.key.verification.cancel",n.Mac="m.key.verification.mac",n.Done="m.key.verification.done",n))(ae||{}),te=(n=>(n.UserCancelled="m.user",n.TimedOut="m.timeout",n.UnknownTransaction="m.unknown_transaction",n.UnknownMethod="m.unknown_method",n.UnexpectedMessage="m.unexpected_message",n.KeyMismatch="m.key_mismatch",n.UserMismatch="m.user_mismatch",n.InvalidMessage="m.invalid_message",n.OtherDeviceAccepted="m.accepted",n.MismatchedCommitment="m.mismatched_commitment",n.MismatchedSAS="m.mismatched_sas",n))(te||{});const ZE=["curve25519-hkdf-sha256","curve25519"],e0=["sha256"],t0=["hkdf-hmac-sha256.v2","org.matrix.msc3783.hkdf-hmac-sha256","hkdf-hmac-sha256","hmac-sha256"],n0=["decimal","emoji"],JN=new Set(n0),QN=[["","dog"],["","cat"],["","lion"],["","horse"],["","unicorn"],["","pig"],["","elephant"],["","rabbit"],["","panda"],["","rooster"],["","penguin"],["","turtle"],["","fish"],["","octopus"],["","butterfly"],["","flower"],["","tree"],["","cactus"],["","mushroom"],["","globe"],["","moon"],["","cloud"],["","fire"],["","banana"],["","apple"],["","strawberry"],["","corn"],["","pizza"],["","cake"],["","heart"],["","smiley"],["","robot"],["","hat"],["","glasses"],["","spanner"],["","santa"],["","thumbs up"],["","umbrella"],["","hourglass"],["","clock"],["","gift"],["","light bulb"],["","book"],["","pencil"],["","paperclip"],["","scissors"],["","lock"],["","key"],["","hammer"],["","telephone"],["","flag"],["","train"],["","bicycle"],["","aeroplane"],["","rocket"],["","trophy"],["","ball"],["","guitar"],["","trumpet"],["","bell"],["","anchor"],["","headphones"],["","folder"],["","pin"]];function ZN(n){return[n[0]>>2,(n[0]&3)<<4|n[1]>>4,(n[1]&15)<<2|n[2]>>6,n[2]&63,n[3]>>2,(n[3]&3)<<4|n[4]>>4,(n[4]&15)<<2|n[5]>>6].map(t=>QN[t])}const eP={"hkdf-hmac-sha256":"calculate_mac","org.matrix.msc3783.hkdf-hmac-sha256":"calculate_mac_fixed_base64","hkdf-hmac-sha256.v2":"calculate_mac_fixed_base64","hmac-sha256":"calculate_mac_long_kdf"};function r0(n,e){return function(t,r,i){return i.wrap({l:"calculate MAC",method:e},()=>n[eP[e]](t,r))}}class tP extends Er{async completeStage(){await this.log.wrap("SendDoneStage.completeStage",async e=>{await this.channel.send(ae.Done,{},e),await this.channel.waitForEvent(ae.Done),this.eventEmitter.emit("VerificationCompleted",this.otherUserDeviceId)})}}class nP extends Er{async completeStage(){await this.log.wrap("VerifyMacStage.completeStage",async e=>{const r=this.channel.acceptMessage.content.message_authentication_code,i=r0(this.olmSAS,r);await this.checkMAC(i,e),this.setNextStage(new tP(this.options))})}async checkMAC(e,t){const{content:r}=this.channel.getReceivedMessage(ae.Mac),i="MATRIX_KEY_VERIFICATION_MAC"+this.otherUserId+this.otherUserDeviceId+this.ourUserId+this.ourUserDeviceId+this.channel.id,s=e(Object.keys(r.mac).sort().join(","),i+"KEY_IDS",t);if(r.keys!==s){t.log({l:"MAC verification failed for keys field",keys:r.keys,calculated:s}),this.channel.cancelVerification(te.KeyMismatch);return}await this.verifyKeys(r.mac,(o,a,c)=>{const u=e(a,i+o,t),l=c===u;return l||(t.log({l:"Mac verification failed for key",keyMac:c,calculatedMAC:u,keyId:o,key:a}),this.channel.cancelVerification(te.KeyMismatch)),l},t)}async verifyKeys(e,t,r){const i=this.otherUserId;for(const[s,o]of Object.entries(e)){const a=s.split(":",2)[1],c=await this.deviceTracker.deviceForId(i,a,this.hsApi,r);if(c)t(s,Gi(c),o)&&await r.wrap("signing device",async u=>{const l=await this.options.crossSigning.signDevice(c.device_id,u);u.set("success",!!l)});else{const u=await this.deviceTracker.getCrossSigningKeyForUser(i,rr.Master,this.hsApi,r);if(!u)throw r.log({l:"Fetching msk failed",userId:i}),new Error("Fetching MSK for user failed!");const l=Ws(u);l&&t(s,l,o)&&await r.wrap("signing user",async d=>{const p=await this.options.crossSigning.signUser(i,d);d.set("success",!!p)})}}}}class rP extends Er{async completeStage(){await this.log.wrap("SendMacStage.completeStage",async e=>{const r=this.channel.acceptMessage.content.message_authentication_code,i=r0(this.olmSAS,r);await this.sendMAC(i,e),await this.channel.waitForEvent(ae.Mac),this.setNextStage(new nP(this.options))})}async sendMAC(e,t){const r={},i=[],s="MATRIX_KEY_VERIFICATION_MAC"+this.ourUserId+this.ourUserDeviceId+this.otherUserId+this.otherUserDeviceId+this.channel.id,o=`ed25519:${this.ourUserDeviceId}`,a=this.e2eeAccount.getUnsignedDeviceKey();r[o]=e(a.keys[o],s+o,t),i.push(o);const c=await this.deviceTracker.getCrossSigningKeyForUser(this.ourUserId,rr.Master,this.hsApi,t);if(!c)throw t.log({l:"Fetching msk failed",userId:this.ourUserId}),new Error("Fetching MSK for user failed!");const u=Ws(c);if(u){const d=`ed25519:${u}`;r[d]=e(u,s+d,t),i.push(d)}const l=e(i.sort().join(","),s+"KEY_IDS",t);await this.channel.send(ae.Mac,{mac:r,keys:l},t)}}class As extends Error{get name(){return"VerificationCancelledError"}get message(){return"Verification is cancelled!"}}const iP={"curve25519-hkdf-sha256":function(n,e,t){const r=`${n.our.userId}|${n.our.deviceId}|${n.our.publicKey}|`,i=`${n.their.userId}|${n.their.deviceId}|${n.their.publicKey}|`,s="MATRIX_KEY_VERIFICATION_SAS|"+(n.initiatedByMe?r+i:i+r)+n.id;return e.generate_bytes(s,t)},curve25519:function(n,e,t){const r=`${n.our.userId}${n.our.deviceId}`,i=`${n.their.userId}${n.their.deviceId}`,s="MATRIX_KEY_VERIFICATION_SAS"+(n.initiatedByMe?r+i:i+r)+n.id;return e.generate_bytes(s,t)}};class sP extends Er{async completeStage(){await this.log.wrap("CalculateSASStage.completeStage",async e=>{if(this.channel.initiatedByUs&&!await this.verifyHashCommitment(e))return;const t=new Promise((i,s)=>{this.resolve=i,this.reject=s});this.olmSAS.set_their_key(this.theirKey);const r=this.generateSASBytes();this.emoji=ZN(Array.from(r)),this.eventEmitter.emit("EmojiGenerated",this),await t,this.setNextStage(new rP(this.options))})}async verifyHashCommitment(e){return await e.wrap("CalculateSASStage.verifyHashCommitment",async()=>{const t=this.channel.getReceivedMessage(ae.Accept).content,i=this.channel.getReceivedMessage(ae.Key).content.key+Cl.stringify(this.channel.startMessage.content),s=t.commitment,o=this.olmUtil.sha256(i);return o!==s?(e.log({l:"Commitment mismatched!",received:s,calculated:o}),await this.channel.cancelVerification(te.MismatchedCommitment),!1):!0})}generateSASBytes(){const e=this.channel.acceptMessage.content.key_agreement_protocol,t=this.otherUserDeviceId;return iP[e]({our:{userId:this.ourUserId,deviceId:this.ourUserDeviceId,publicKey:this.olmSAS.get_pubkey()},their:{userId:this.otherUserId,deviceId:t,publicKey:this.theirKey},id:this.channel.id,initiatedByMe:this.channel.initiatedByUs},this.olmSAS,6)}async setEmojiMatch(e){e?this.resolve():(await this.channel.cancelVerification(te.MismatchedSAS),this.reject(new As))}get theirKey(){const{content:e}=this.channel.getReceivedMessage(ae.Key);return e.key}}class i0 extends Er{async completeStage(){await this.log.wrap("SendKeyStage.completeStage",async e=>{const t=this.olmSAS.get_pubkey();await this.channel.send(ae.Key,{key:t},e),await this.channel.waitForEvent(ae.Key),this.setNextStage(new sP(this.options))})}}function yc(n,e){return Array.isArray(n)?n.filter(t=>e.has(t)):[]}class oP extends Er{async completeStage(){await this.log.wrap("SendAcceptVerificationStage.completeStage",async e=>{const{content:t}=this.channel.startMessage,r=yc(ZE,new Set(t.key_agreement_protocols))[0],i=yc(e0,new Set(t.hashes))[0],s=yc(t0,new Set(t.message_authentication_codes))[0],o=yc(t.short_authentication_string,JN);if(!r||!i||!s||!o.length){await this.channel.cancelVerification(te.UnknownMethod);return}const c=this.olmSAS.get_pubkey()+Cl.stringify(t),u={key_agreement_protocol:r,hash:i,message_authentication_code:s,short_authentication_string:o,commitment:this.olmUtil.sha256(c)};await this.channel.send(ae.Accept,u,e),await this.channel.waitForEvent(ae.Key),this.setNextStage(new i0(this.options))})}}class p_ extends Er{constructor(){super(...arguments),this.hasSentStartMessage=!1,this.allowSelection=!0}async completeStage(){await this.log.wrap("SelectVerificationMethodStage.completeStage",async e=>{await this.findDeviceName(e),this.eventEmitter.emit("SelectVerificationStage",this);const t=this.channel.waitForEvent(ae.Start),r=this.channel.waitForEvent(ae.Accept),{content:i}=await Promise.race([t,r]);i.method?(this.allowSelection=!1,this.hasSentStartMessage?await this.resolveStartConflict(e):this.channel.setStartMessage(this.channel.getReceivedMessage(ae.Start))):this.channel.setStartMessage(this.channel.getSentMessage(ae.Start)),this.channel.initiatedByUs?(await r,this.setNextStage(new i0(this.options))):this.setNextStage(new oP(this.options))})}async resolveStartConflict(e){await e.wrap("resolveStartConflict",async()=>{const t=this.channel.getReceivedMessage(ae.Start),r=this.channel.getSentMessage(ae.Start);if(t.content.method!==r.content.method){e.log({l:"Methods don't match for the start messages",received:t.content.method,sent:r.content.method}),await this.channel.cancelVerification(te.UnexpectedMessage);return}const i=this.ourUserId===this.otherUserId?this.ourUserDeviceId:this.ourUserId,s=this.ourUserId===this.otherUserId?this.otherUserDeviceId:this.otherUserId,o=i<s?r:t;e.log({l:"Start message resolved",message:o,our:i,their:s}),this.channel.setStartMessage(o)})}async findDeviceName(e){await e.wrap("SelectVerificationMethodStage.findDeviceName",async()=>{var t;const r=await this.options.deviceTracker.deviceForId(this.otherUserId,this.otherUserDeviceId,this.options.hsApi,e);if(!r)throw e.log({l:"Cannot find device",userId:this.otherUserId,deviceId:this.otherUserDeviceId}),new Error("Cannot find device");this.otherDeviceName=(t=r.unsigned.device_display_name)!=null?t:r.device_id})}async selectEmojiMethod(e){if(!this.allowSelection)return;const t={method:"m.sas.v1",from_device:this.ourUserDeviceId,key_agreement_protocols:ZE,hashes:e0,message_authentication_codes:t0,short_authentication_string:n0};await this.channel.send(ae.Start,t,e),this.hasSentStartMessage=!0}}class aP extends Er{async completeStage(){await this.log.wrap("SendRequestVerificationStage.completeStage",async e=>{const t={from_device:this.ourUserDeviceId,methods:["m.sas.v1"]};await this.channel.send(ae.Request,t,e),this.setNextStage(new p_(this.options)),await this.channel.waitForEvent(ae.Ready)})}}class lP extends Er{async completeStage(){await this.log.wrap("SendReadyStage.completeStage",async e=>{const t={from_device:this.ourUserDeviceId,methods:["m.sas.v1"]};await this.channel.send(ae.Ready,t,e),this.setNextStage(new p_(this.options))})}}class kr{constructor(){this._handlersByName={}}emit(e,t){const r=this._handlersByName[e];r&&r.forEach(i=>i(t))}disposableOn(e,t){return this.on(e,t),()=>{this.off(e,t)}}on(e,t){let r=this._handlersByName[e];r||(this.onFirstSubscriptionAdded(e),this._handlersByName[e]=r=new Set),r.add(t)}off(e,t){const r=this._handlersByName[e];r&&(r.delete(t),r.size===0&&(delete this._handlersByName[e],this.onLastSubscriptionRemoved(e)))}onFirstSubscriptionAdded(e){}onLastSubscriptionRemoved(e){}}class cP extends kr{constructor(e){super(),this.finished=!1;const{olm:t,channel:r,clock:i}=e,s=new t.SAS;this.olmSas=s,this.channel=r,this.setupCancelAfterTimeout(i);const o=OE(lo({},e),{olmSas:s,eventEmitter:this});r.getReceivedMessage(ae.Start)?this.startStage=new p_(o):r.getReceivedMessage(ae.Request)?this.startStage=new lP(o):this.startStage=new aP(o)}async setupCancelAfterTimeout(e){try{this.timeout=e.createTimeout(6e5),await this.timeout.elapsed(),await this.channel.cancelVerification(te.TimedOut)}catch{}}async abort(){await this.channel.cancelVerification(te.UserCancelled)}async start(){try{let e=this.startStage;do await e.completeStage(),e=e.nextStage;while(e)}catch(e){if(!(e instanceof As))throw e}finally{this.channel.isCancelled&&this.emit("VerificationCancelled",this.channel.cancellation),this.olmSas.free(),this.timeout.abort(),this.finished=!0}}}function co(n,e){return m_(n,e,()=>[],(t,r)=>t.push(r))}function m_(n,e,t,r){return n.reduce((i,s)=>{const o=e(s);let a=i.get(o);return a||(a=t(),i.set(o,a)),r(a,s),i},new Map)}function bv(n,e){return n.reduce((t,r)=>{const i=e(r);return t[i]?t[i]+=1:t[i]=1,t},{})}function An(){return Fu("t")}function Fu(n){const t=Math.floor(Math.random()*Number.MAX_SAFE_INTEGER).toString(16);return n+"0".repeat(14-t.length)+t}function Sv(n){return n.startsWith("t")&&n.length===15}function cp(n){const e=co(n,r=>r.device.user_id);return{messages:Array.from(e.entries()).reduce((r,[i,s])=>(r[i]=s.reduce((o,a)=>(o[a.device.device_id]=a.content,o),{}),r),{})}}function $h(n){typeof n=="function"?n():n.dispose()}function uP(n){return n&&(typeof n=="function"||typeof n.dispose=="function")}class Al{constructor(){this._disposables=[]}track(e){if(!uP(e))throw new Error("Not a disposable");return this.isDisposed?(console.warn("Disposables already disposed, disposing new value"),$h(e),e):(this._disposables.push(e),e)}untrack(e){if(!this._disposables)return;const t=this._disposables.indexOf(e);t>=0&&this._disposables.splice(t,1)}dispose(){if(this._disposables){for(const e of this._disposables)$h(e);this._disposables=void 0}}get isDisposed(){return this._disposables===void 0}disposeTracked(e){if(e==null||this.isDisposed)return;const t=this._disposables.indexOf(e);if(t!==-1){const[r]=this._disposables.splice(t,1);$h(r)}else console.warn("disposable not found, did it leak?",e)}}class up{constructor(){let e,t;this.promise=new Promise((r,i)=>{e=r,t=i}),this.resolve=r=>{this._value=r,e(r)},this.reject=t}get value(){return this._value}}const Ev={[te.UserCancelled]:"User declined",[te.InvalidMessage]:"Invalid Message.",[te.KeyMismatch]:"Key Mismatch.",[te.OtherDeviceAccepted]:"Another device has accepted this request.",[te.TimedOut]:"Timed Out",[te.UnexpectedMessage]:"Unexpected Message.",[te.UnknownMethod]:"Unknown method.",[te.UnknownTransaction]:"Unknown Transaction.",[te.UserMismatch]:"User Mismatch",[te.MismatchedCommitment]:"Hash commitment does not match.",[te.MismatchedSAS]:"Emoji/decimal does not match."};class dP extends Al{constructor(e,t){super(),this.sentMessages=new Map,this.receivedMessages=new Map,this.waitMap=new Map,this.hsApi=e.hsApi,this.deviceTracker=e.deviceTracker,this.otherUserId=e.otherUserId,this.ourDeviceId=e.ourUserDeviceId,this.clock=e.clock,this.log=e.log,this.deviceMessageHandler=e.deviceMessageHandler,this.track(this.deviceMessageHandler.disposableOn("message",async({unencrypted:r})=>await this.handleDeviceMessage(r))),this.track(()=>{this.waitMap.forEach(r=>{r.reject(new As)})}),t&&(this.id=t.content.transaction_id,this.receivedMessages.set(t.type,t),this.otherUserDeviceId=t.content.from_device)}get cancellation(){return this._cancellation}get isCancelled(){return!!this._cancellation}async send(e,t,r){await r.wrap("ToDeviceChannel.send",async()=>{if(this.isCancelled)throw new As;if(e===ae.Request){await this.handleRequestEventSpecially(e,t,r);return}Object.assign(t,{transaction_id:this.id});const i={messages:{[this.otherUserId]:{[this.otherUserDeviceId]:t}}};await this.hsApi.sendToDevice(e,i,An(),{log:r}).response(),this.sentMessages.set(e,{content:t})})}async handleRequestEventSpecially(e,t,r){await r.wrap("ToDeviceChannel.handleRequestEventSpecially",async()=>{const i=this.clock.now(),s=An();this.id=s,Object.assign(t,{timestamp:i,transaction_id:s});const o={messages:{[this.otherUserId]:{"*":t}}};await this.hsApi.sendToDevice(e,o,An(),{log:r}).response(),this.sentMessages.set(e,{content:t})})}getReceivedMessage(e){return this.receivedMessages.get(e)}getSentMessage(e){return this.sentMessages.get(e)}get acceptMessage(){var e;return(e=this.receivedMessages.get(ae.Accept))!=null?e:this.sentMessages.get(ae.Accept)}async handleDeviceMessage(e){await this.log.wrap("ToDeviceChannel.handleDeviceMessage",async t=>{if(e.type.startsWith("m.key.verification.")){if(e.content.transaction_id!==this.id){console.log("Received event with unknown transaction id: ",e),await this.cancelVerification(te.UnknownTransaction);return}if(console.log("event",e),t.log({l:"event",event:e}),this.resolveAnyWaits(e),this.receivedMessages.set(e.type,e),e.type===ae.Ready){this.handleReadyMessage(e,t);return}if(e.type===ae.Cancel){this._cancellation={code:e.content.code,cancelledByUs:!1},this.dispose();return}}})}async handleReadyMessage(e,t){const r=e.content.from_device;this.otherUserDeviceId=r;const s=(await this.deviceTracker.devicesForUsers([this.otherUserId],this.hsApi,t)).filter(u=>u.device_id!==r&&u.device_id!==this.ourDeviceId),o={code:te.OtherDeviceAccepted,reason:Ev[te.OtherDeviceAccepted],transaction_id:this.id},a=s.reduce((u,l)=>(u[l.device_id]=o,u),{}),c={messages:{[this.otherUserId]:a}};await this.hsApi.sendToDevice(ae.Cancel,c,An(),{log:t}).response()}async cancelVerification(e){await this.log.wrap("Channel.cancelVerification",async t=>{var r;if(this.isCancelled)throw new As;const i={messages:{[this.otherUserId]:{[(r=this.otherUserDeviceId)!=null?r:"*"]:{code:e,reason:Ev[e],transaction_id:this.id}}}};await this.hsApi.sendToDevice(ae.Cancel,i,An(),{log:t}).response(),this._cancellation={code:e,cancelledByUs:!0},this.dispose()})}resolveAnyWaits(e){const{type:t}=e,r=this.waitMap.get(t);r&&(r.resolve(e),this.waitMap.delete(t))}waitForEvent(e){if(this.isCancelled)throw new As;const t=this.receivedMessages.get(e);if(t)return Promise.resolve(t);const r=this.waitMap.get(e);if(r)return r.promise;const i=new up;return this.waitMap.set(e,i),i.promise}setStartMessage(e){this.startMessage=e,this._initiatedByUs=e.content.from_device===this.ourDeviceId}get initiatedByUs(){return this._initiatedByUs}}class Lh{constructor(e){this.startingMessage=e}get deviceId(){return this.startingMessage.content.from_device}get sender(){return this.startingMessage.sender}get id(){return this.startingMessage.content.transaction_id}}var rr=(n=>(n.Master="master",n.SelfSigning="self_signing",n.UserSigning="user_signing",n))(rr||{});class hP{constructor(e){this._isMasterKeyTrusted=!1,this.observedUsers=new Map,this.receivedSASVerifications=new pr,this.storage=e.storage,this.secretStorage=e.secretStorage,this.platform=e.platform,this.deviceTracker=e.deviceTracker,this.olm=e.olm,this.olmUtil=e.olmUtil,this.hsApi=e.hsApi,this.ownUserId=e.ownUserId,this.deviceId=e.deviceId,this.e2eeAccount=e.e2eeAccount,this.deviceMessageHandler=e.deviceMessageHandler,this.handleSASDeviceMessage=this.handleSASDeviceMessage.bind(this),this.deviceMessageHandler.on("message",this.handleSASDeviceMessage)}async load(e){return await this.verifyMSKFrom4S(!1,e)!==0}async start(e){this.isMasterKeyTrusted||await this.verifyMSKFrom4S(!0,e)}async verifyMSKFrom4S(e,t){return await t.wrap("CrossSigning.verifyMSKFrom4S",async r=>{const i=await this.getSigningKey("master");if(!i)return r.set("failure","no_priv_msk"),0;const s=new this.olm.PkSigning;let o;try{o=s.init_with_seed(i)}finally{s.free()}const a=await this.deviceTracker.getCrossSigningKeyForUser(this.ownUserId,"master",e?this.hsApi:void 0,r);if(!a)return r.set("failure","no_pub_msk"),1;const c=a&&Ws(a);return r.set({publishedMasterKey:c,derivedPublicKey:o}),this._isMasterKeyTrusted=!!c&&c===o,this._isMasterKeyTrusted?3:(r.set("failure","mismatch"),2)})}get isMasterKeyTrusted(){return this._isMasterKeyTrusted}startVerification(e,t){if(this.sasVerificationInProgress&&!this.sasVerificationInProgress.finished)return;const r=e instanceof Lh?e.sender:e,i=e instanceof Lh?e.startingMessage:void 0,s=new dP({deviceTracker:this.deviceTracker,hsApi:this.hsApi,otherUserId:r,clock:this.platform.clock,deviceMessageHandler:this.deviceMessageHandler,ourUserDeviceId:this.deviceId,log:t},i);return this.sasVerificationInProgress=new cP({olm:this.olm,olmUtil:this.olmUtil,ourUserId:this.ownUserId,ourUserDeviceId:this.deviceId,otherUserId:r,log:t,channel:s,e2eeAccount:this.e2eeAccount,deviceTracker:this.deviceTracker,hsApi:this.hsApi,clock:this.platform.clock,crossSigning:this}),this.sasVerificationInProgress}handleSASDeviceMessage({unencrypted:e}){var t;const r=e.content.transaction_id;if(((t=this.sasVerificationInProgress)==null?void 0:t.channel.id)!==r)switch(e.type){case ae.Cancel:this.receivedSASVerifications.remove(r);return;case ae.Request:case ae.Start:this.platform.logger.run("Create SASRequest",()=>{this.receivedSASVerifications.set(r,new Lh(e))});return;default:return}}async signOwnDevice(e){return e.wrap("CrossSigning.signOwnDevice",async t=>{if(!this._isMasterKeyTrusted){t.set("mskNotTrusted",!0);return}const r=this.e2eeAccount.getUnsignedDeviceKey();return this.signDeviceKey(r,t)})}async signDevice(e,t){return t.wrap("CrossSigning.signDevice",async r=>{if(r.set("id",e),!this._isMasterKeyTrusted){r.set("mskNotTrusted",!0);return}const i=await this.deviceTracker.deviceForId(this.ownUserId,e,this.hsApi,r);if(i)return delete i.signatures,this.signDeviceKey(i,r)})}async signUser(e,t){return t.wrap("CrossSigning.signUser",async r=>{if(r.set("id",e),!this._isMasterKeyTrusted){r.set("mskNotTrusted",!0);return}if(e===this.ownUserId)return;const i=await this.deviceTracker.getCrossSigningKeyForUser(e,"master",this.hsApi,r);if(!i)return;const s=await this.getSigningKey("user_signing");if(!s)return;delete i.signatures,this.signKey(i,s);const o={[i.user_id]:{[Ws(i)]:i}};return await this.hsApi.uploadSignatures(o,{log:r}).response(),await this.deviceTracker.invalidateUserKeys(e),this.emitUserTrustUpdate(e,r),i})}getUserTrust(e,t){return t.wrap("CrossSigning.getUserTrust",async r=>{r.set("id",e);const i=w=>(r.set("result",w),w);if(!this.isMasterKeyTrusted)return i(7);const s=await r.wrap("get our msk",w=>this.deviceTracker.getCrossSigningKeyForUser(this.ownUserId,"master",this.hsApi,w));if(!s)return i(7);const o=await r.wrap("get our usk",w=>this.deviceTracker.getCrossSigningKeyForUser(this.ownUserId,"user_signing",this.hsApi,w));if(!o||r.wrap("verify our usk",w=>this.hasValidSignatureFrom(o,s,w))!==Ue.Valid)return i(7);const c=await r.wrap("get their msk",w=>this.deviceTracker.getCrossSigningKeyForUser(e,"master",this.hsApi,w));if(!c)return i(2);const u=r.wrap("verify their msk",w=>this.hasValidSignatureFrom(c,o,w));if(u!==Ue.Valid)return u===Ue.NotSigned?i(2):i(3);const l=await r.wrap("get their ssk",w=>this.deviceTracker.getCrossSigningKeyForUser(e,"self_signing",this.hsApi,w));if(!l||r.wrap("verify their ssk",w=>this.hasValidSignatureFrom(l,c,w))!==Ue.Valid)return i(6);const m=(await r.wrap("get their devices",w=>this.deviceTracker.devicesForUsers([e],this.hsApi,w))).reduce((w,S)=>r.wrap({l:"verify device",id:S.device_id},v=>{const _=this.hasValidSignatureFrom(S,l,v);return w===Ue.Invalid||_===Ue.Invalid?Ue.Invalid:w===Ue.NotSigned||_===Ue.NotSigned?Ue.NotSigned:w===Ue.Valid||_===Ue.Valid?Ue.Valid:Ue.Invalid}),Ue.Valid);return m!==Ue.Valid?m===Ue.NotSigned?i(4):i(5):i(1)})}dispose(){this.deviceMessageHandler.off("message",this.handleSASDeviceMessage)}observeUserTrust(e,t){const r=this.observedUsers.get(e);if(r)return r;const i=new fl(void 0,()=>{this.observedUsers.delete(e)});return this.observedUsers.set(e,i),t.wrapDetached("get user trust",async s=>{i.get()===void 0&&i.set(await this.getUserTrust(e,s))}),i}async signDeviceKey(e,t){const r=await this.getSigningKey("self_signing");if(!r)return;this.signKey(e,r);const i={[e.user_id]:{[e.device_id]:e}};return await this.hsApi.uploadSignatures(i,{log:t}).response(),await this.deviceTracker.invalidateUserKeys(this.ownUserId),this.emitUserTrustUpdate(this.ownUserId,t),e}async getSigningKey(e){const t=await this.secretStorage.readSecret(`m.cross_signing.${e}`);if(t)return new Uint8Array(this.platform.encoding.base64.decode(t))}signKey(e,t){XN(this.olm,e,t,this.ownUserId,"")}hasValidSignatureFrom(e,t,r){const i=Ws(t);return i?h_(this.olmUtil,t.user_id,i,i,e,r):Ue.NotSigned}emitUserTrustUpdate(e,t){const r=this.observedUsers.get(e);r&&r.get()!==void 0&&(r.set(void 0),t.wrapDetached("update user trust",async i=>{r.set(await this.getUserTrust(e,i))}))}}function fP(n){if(!Array.isArray(n.usage)||n.usage.length!==1)return;const e=n.usage[0];if(!(e!=="master"&&e!=="self_signing"&&e!=="user_signing"))return e}const pP="ed25519",mP=`${pP}:`;function Ws(n){const e=Object.keys(n.keys).filter(i=>i.startsWith(mP));if(e.length!==1)return;const t=e[0];return n.keys[t]}function kv(n){return n.user_id}var s0=(n=>(n[n.Outdated=0]="Outdated",n[n.UpToDate=1]="UpToDate",n))(s0||{});function o0(n,e){return{userId:n,roomIds:e?[e]:[],keysTrackingStatus:0}}function _P(n,e,t){if(n){if(!n.roomIds.includes(t))return n.roomIds.push(t),n}else return n=o0(e,t),n}class gP{constructor(e){this._storage=e.storage,this._getSyncToken=e.getSyncToken,this._olmUtil=e.olmUtil,this._ownUserId=e.ownUserId,this._ownDeviceId=e.ownDeviceId}async writeDeviceChanges(e,t,r){const{userIdentities:i}=t;r.set("changed",e.length),await Promise.all(e.map(async s=>{const o=await i.get(s);o&&(r.log({l:"outdated",id:s}),o.keysTrackingStatus=0,i.set(o))}))}async writeMemberChanges(e,t,r,i){const s=[],o=[];return await Promise.all(Array.from(t.values()).map(async a=>{if(dc(a.membership,r))await this._addRoomToUserIdentity(a.roomId,a.userId,i)&&s.push(a.userId);else if(dc(a.previousMembership,r)){const{roomId:c}=a;if(a.userId===this._ownUserId){const u=await i.roomMembers.getAllUserIds(c);await Promise.all(u.map(l=>this._removeRoomFromUserIdentity(c,l,i)))}else await this._removeRoomFromUserIdentity(c,a.userId,i);o.push(a.userId)}})),{added:s,removed:o}}async trackRoom(e,t,r){if(e.isTrackingMembers||!e.isEncrypted)return;const i=await e.loadMemberList(void 0,r),s=await this._storage.readWriteTxn([this._storage.storeNames.roomSummary,this._storage.storeNames.userIdentities,this._storage.storeNames.deviceKeys]);try{let o;try{o=e.writeIsTrackingMembers(!0,s);const a=Array.from(i.members.values());r.set("members",a.length),await Promise.all(a.map(async c=>{dc(c.membership,t)?await this._addRoomToUserIdentity(c.roomId,c.userId,s):await this._removeRoomFromUserIdentity(c.roomId,c.userId,s)}))}catch(a){throw s.abort(),a}await s.complete(),e.applyIsTrackingMembersChanges(o)}finally{i.release()}}async invalidateUserKeys(e){const t=await this._storage.readWriteTxn([this._storage.storeNames.userIdentities]),r=await t.userIdentities.get(e);r&&(r.keysTrackingStatus=0,t.userIdentities.set(r)),await t.complete()}async getCrossSigningKeyForUser(e,t,r,i){return await i.wrap({l:"DeviceTracker.getCrossSigningKeyForUser",id:e,usage:t},async s=>{const o=await this._storage.readTxn([this._storage.storeNames.userIdentities,this._storage.storeNames.crossSigningKeys]),a=await o.userIdentities.get(e);if(a&&a.keysTrackingStatus!==0)return await o.crossSigningKeys.get(e,t);if(!r)return;const c=await this._queryKeys([e],r,s);switch(t){case rr.Master:return c.masterKeys.get(e);case rr.SelfSigning:return c.selfSigningKeys.get(e);case rr.UserSigning:return c.userSigningKeys.get(e)}})}async writeHistoryVisibility(e,t,r,i){const s=[],o=[];return e.isTrackingMembers&&e.isEncrypted&&await i.wrap("rewriting userIdentities",async a=>{const c=await e.loadMemberList(r,a);try{const u=Array.from(c.members.values());a.set("members",u.length),await Promise.all(u.map(async l=>{dc(l.membership,t)?await this._addRoomToUserIdentity(l.roomId,l.userId,r)&&s.push(l.userId):await this._removeRoomFromUserIdentity(l.roomId,l.userId,r)&&o.push(l.userId)}))}finally{c.release()}}),{added:s,removed:o}}async _addRoomToUserIdentity(e,t,r){const{userIdentities:i}=r,s=await i.get(t),o=_P(s,t,e);return o?(i.set(o),!0):!1}async _removeRoomFromUserIdentity(e,t,r){const{userIdentities:i,deviceKeys:s}=r,o=await i.get(t);return o?(o.roomIds=o.roomIds.filter(a=>a!==e),o.roomIds.length===0?(i.remove(t),s.removeAllForUser(t)):i.set(o),!0):!1}async _queryKeys(e,t,r){const i=await t.queryKeys({timeout:1e4,device_keys:e.reduce((l,d)=>(l[d]=[],l),{}),token:this._getSyncToken()},{log:r}).response(),s=r.wrap("master keys",l=>this._filterVerifiedCrossSigningKeys(i.master_keys,rr.Master,l)),o=r.wrap("self-signing keys",l=>this._filterVerifiedCrossSigningKeys(i.self_signing_keys,rr.SelfSigning,l)),a=r.wrap("user-signing keys",l=>this._filterVerifiedCrossSigningKeys(i.user_signing_keys,rr.UserSigning,l)),c=r.wrap("device keys",l=>this._filterVerifiedDeviceKeys(i.device_keys,l)),u=await this._storage.readWriteTxn([this._storage.storeNames.userIdentities,this._storage.storeNames.deviceKeys,this._storage.storeNames.crossSigningKeys]);try{for(const d of s.values())u.crossSigningKeys.set(d);for(const d of o.values())u.crossSigningKeys.set(d);for(const d of a.values())u.crossSigningKeys.set(d);let l=0;await Promise.all(Array.from(c.keys()).map(async d=>{let p=c.get(d);l+=p.length,p=await this._storeQueriedDevicesForUserId(d,p,u),c.set(d,p)})),r.set("devices",l)}catch(l){throw u.abort(),l}return await u.complete(),{deviceKeys:c,masterKeys:s,selfSigningKeys:o,userSigningKeys:a}}async _storeQueriedDevicesForUserId(e,t,r){const i=await r.deviceKeys.getAllDeviceIds(e);for(const c of i)t.every(u=>u.device_id!==c)&&r.deviceKeys.remove(e,c);const s=[],o=[];await Promise.all(t.map(async c=>{if(i.includes(c.device_id)){const u=await r.deviceKeys.get(c.user_id,c.device_id);if(u&&Gi(u)!==Gi(c)){s.push(u);return}}s.push(c),o.push(c)}));for(const c of o)r.deviceKeys.set(c);let a=await r.userIdentities.get(e);return a||(a=o0(e)),a.keysTrackingStatus=1,r.userIdentities.set(a),s}_filterVerifiedCrossSigningKeys(e,t,r){const i=new Map;if(!e)return i;for(const[s,o]of Object.entries(e))r.wrap({l:s},a=>{this._validateCrossSigningKey(s,o,t,a)&&i.set(kv(o),o)});return i}_validateCrossSigningKey(e,t,r,i){return kv(t)!==e?(i.log({l:"user_id mismatch",userId:t.user_id}),!1):fP(t)!==r?(i.log({l:"usage mismatch",usage:t.usage}),!1):Ws(t)?!0:(i.log({l:"no ed25519 key",keys:t.keys}),!1)}_filterVerifiedDeviceKeys(e,t){const r=new Set,i=new Map;if(!e)return i;for(const[s,o]of Object.entries(e))t.wrap(s,a=>{const u=Object.entries(o).filter(([l,d])=>a.wrap(l,p=>{if(this._validateDeviceKey(s,l,d,p)){const m=nr(d);return r.has(m)?(t.log({l:"ignore device with duplicate curve25519 key",keys:d},t.level.Warn),!1):(r.add(m),!0)}else return!1})).map(([,l])=>l);i.set(s,u)});return i}_validateDeviceKey(e,t,r,i){const s=r.device_id,o=r.user_id;if(o!==e)return i.log("user_id mismatch"),!1;if(s!==t)return i.log("device_id mismatch"),!1;const a=Gi(r),c=nr(r);if(typeof a!="string"||typeof c!="string")return i.log("ed25519 and/or curve25519 key invalid").set({deviceKey:r}),!1;const u=h_(this._olmUtil,o,s,a,r,i)===Ue.Valid;return u||i.log({l:"ignore device with invalid signature",keys:r},i.level.Warn),u}async devicesForTrackedRoom(e,t,r){const i=await this._storage.readTxn([this._storage.storeNames.roomMembers,this._storage.storeNames.userIdentities]),s=await i.roomMembers.getAllUserIds(e);return await this._devicesForUserIdsInTrackedRoom(e,s,i,t,r)}async devicesForRoomMembers(e,t,r,i){const s=await this._storage.readTxn([this._storage.storeNames.userIdentities]);return await this._devicesForUserIdsInTrackedRoom(e,t,s,r,i)}async devicesForUsers(e,t,r){const i=await this._storage.readTxn([this._storage.storeNames.userIdentities]),s=[],o=[];return await Promise.all(e.map(async a=>{const c=await i.userIdentities.get(a);c&&c.keysTrackingStatus===1?s.push(c):(!c||c.keysTrackingStatus===0)&&o.push(a)})),this._devicesForUserIdentities(s,o,t,r)}async deviceForId(e,t,r,i){var s;let a=await(await this._storage.readTxn([this._storage.storeNames.deviceKeys])).deviceKeys.get(e,t);if(a)i.set("existingDevice",!0);else{const c=await r.queryKeys({timeout:1e4,device_keys:{[e]:[t]},token:this._getSyncToken()},{log:i}).response(),l=(s=i.wrap("verify",m=>this._filterVerifiedDeviceKeys(c.device_keys,m)).get(e))==null?void 0:s.find(m=>m.device_id===t);if(!l)return;const d=await this._storage.readWriteTxn([this._storage.storeNames.deviceKeys]),p=await d.deviceKeys.get(e,t);if(p)a=p,i.set("existingDeviceAfterFetch",!0);else{try{d.deviceKeys.set(l),a=l,i.set("newDevice",!0)}catch(m){throw d.abort(),m}await d.complete()}}return a}async _devicesForUserIdsInTrackedRoom(e,t,r,i,s){const a=(await Promise.all(t.map(d=>r.userIdentities.get(d)))).filter(d=>d&&d.roomIds.includes(e)),c=a.filter(d=>d.keysTrackingStatus===1),u=a.filter(d=>d.keysTrackingStatus===0).map(d=>d.userId);let l=await this._devicesForUserIdentities(c,u,i,s);return l=l.filter(d=>!(d.user_id===this._ownUserId&&d.device_id===this._ownDeviceId)),l}async _devicesForUserIdentities(e,t,r,i){i.set("uptodate",e.length),i.set("outdated",t.length);let s;if(t.length){const{deviceKeys:u}=await this._queryKeys(t,r,i);s=u}const o=await this._storage.readTxn([this._storage.storeNames.deviceKeys]);let c=(await Promise.all(e.map(u=>o.deviceKeys.getAllForUserId(u.userId)))).reduce((u,l)=>u.concat(l),[]);if(s&&s.size)for(const u of s.values())c=c.concat(u);return c}async getDeviceByCurve25519Key(e,t){return await t.deviceKeys.getByCurve25519Key(e)}}const a0=[vP,wP,bP,SP,EP,kP,IP,TP,RP,CP,MP,xP,AP,DP,NP,PP,OP,UP];function yP(n){return{databaseName:n.name,get idbFactory(){throw new Error("unused")},get IDBKeyRange(){throw new Error("unused")},addWriteError(){}}}function vP(n){n.createObjectStore("session",{keyPath:"key"}),n.createObjectStore("roomSummary",{keyPath:"roomId"}),n.createObjectStore("timelineFragments",{keyPath:"key"}),n.createObjectStore("timelineEvents",{keyPath:"key"}).createIndex("byEventId","eventIdKey",{unique:!0}),n.createObjectStore("roomState",{keyPath:"key"}),n.createObjectStore("pendingEvents",{keyPath:"key"})}async function wP(n,e){const t=new JE(n.createObjectStore("roomMembers",{keyPath:"key"})),r=e.objectStore("roomState");await Ge(r.openCursor(),i=>{if(i.event.type===zt){r.delete(i.key);const s=ye.fromMemberEvent(i.roomId,i.event);s&&t.set(s.serialize())}return vr})}async function bP(n,e,t){const r=e.objectStore("session");try{const s=await Et(r.get(1));if(s){r.delete(1);const{syncToken:o,syncFilterId:a,serverVersions:c}=s.value,u=new f_(r,t);u.set("sync",{token:o,filterId:a}),u.set("serverVersions",c)}}catch(i){e.abort(),console.error("could not migrate session",i.stack)}}function SP(n){n.createObjectStore("userIdentities",{keyPath:"userId"}),n.createObjectStore("deviceIdentities",{keyPath:"key"}).createIndex("byCurve25519Key","curve25519Key",{unique:!0}),n.createObjectStore("olmSessions",{keyPath:"key"}),n.createObjectStore("inboundGroupSessions",{keyPath:"key"}),n.createObjectStore("outboundGroupSessions",{keyPath:"roomId"}),n.createObjectStore("groupSessionDecryptions",{keyPath:"key"}),n.createObjectStore("operations",{keyPath:"id"}).createIndex("byTypeAndScope","typeScopeKey",{unique:!1})}async function EP(n,e){var t;const r=e.objectStore("roomSummary"),i=e.objectStore("roomState"),s=[];await Ge(r.openCursor(),o=>(s.push(o),vr));for(const o of s){const a=await Et(i.get(`${o.roomId}|m.room.encryption|`));a&&(o.encryption=(t=a==null?void 0:a.event)==null?void 0:t.content,delete o.isEncrypted,r.put(o))}}function kP(n){n.createObjectStore("accountData",{keyPath:"type"})}function IP(n){n.createObjectStore("invites",{keyPath:"roomId"})}function TP(n){n.createObjectStore("archivedRoomSummary",{keyPath:"summary.roomId"})}async function RP(n,e){try{const t=e.objectStore("operations");t.deleteIndex("byTypeAndScope"),await Ge(t.openCursor(),(r,i,s)=>{const{typeScopeKey:o}=r;delete r.typeScopeKey;const[a,c]=o.split("|");return r.scopeTypeKey=va(c,a),s.update(r),vr}),t.createIndex("byScopeAndType","scopeTypeKey",{unique:!1})}catch(t){e.abort(),console.error("could not migrate operations",t.stack)}}function CP(n){n.createObjectStore("timelineRelations",{keyPath:"key"})}function MP(){}async function xP(n,e){const t=e.objectStore("session"),r=await Et(t.get("ssssKey"));r&&t.put({key:`${nn}ssssKey`,value:r.value})}async function AP(n,e,t,r){const i=e.objectStore("session"),s=new f_(new GE(i,yP(n)),t);s.writeE2EEIdentityToLocalStorage();const o=await s.tryRestoreE2EEIdentityFromLocalStorage(r);r.set("restored",o)}async function DP(n,e){for(const t of n.objectStoreNames){const r=e.objectStore(t);switch(t){case"inboundGroupSessions":case"outboundGroupSessions":case"olmSessions":case"operations":continue;case"session":{await Ge(r.openCursor(),(i,s,o)=>(s.startsWith(nn)||o.delete(),vr));break}default:{r.clear();break}}}}async function NP(n,e,t,r){e.objectStore("inboundGroupSessions").createIndex("byBackup","backup",{unique:!1})}async function PP(n,e,t,r){const i=e.objectStore("inboundGroupSessions");let s=0,o=0;await Ge(i.openCursor(),(a,c,u)=>(a.session?(a.backup=Ud.NotBackedUp,a.source=xl.DeviceMessage,u.update(a),s+=1):o+=1,vr)),r.set("countWithoutSession",o),r.set("countWithSession",s)}function OP(n){n.createObjectStore("calls",{keyPath:"key"})}async function UP(n,e,t,r){n.createObjectStore("crossSigningKeys",{keyPath:"key"}),n.deleteObjectStore("deviceIdentities"),n.createObjectStore("deviceKeys",{keyPath:"key"}).createIndex("byCurve25519Key","curve25519Key",{unique:!0});const s=e.objectStore("userIdentities");let o=0;await Ge(s.openCursor(),(a,c,u)=>(delete a.deviceTrackingStatus,delete a.crossSigningKeys,a.keysTrackingStatus=s0.Outdated,u.update(a),o+=1,vr)),r.set("marked_outdated",o)}async function $P(n){const e="hydrogen_webkit_test_inactive_txn_bug";try{const t=await u_(e,s=>{s.createObjectStore("test",{keyPath:"key"})},1,n),r=t.transaction(["test"],"readonly");await Et(r.objectStore("test").get("somekey")),await new Promise(s=>setTimeout(s,0));const i=t.transaction(["test"],"readwrite");await Promise.resolve(),i.objectStore("test").add({key:"somekey",value:"foo"}),await hl(i),t.close()}catch(t){if(t.name==="TransactionInactiveError")return!0}return!1}const l0=n=>`hydrogen_session_${n}`,Fh=function(n,e,t,r){const i=(s,o,a,c)=>BP(s,o,a,c,t,r);return u_(l0(n),i,a0.length,e)};async function LP(){var n,e;const t=this;if((e=(n=t==null?void 0:t.navigator)==null?void 0:n.storage)!=null&&e.persist)return await t.navigator.storage.persist();if(t!=null&&t.document.requestStorageAccess)try{return await t.document.requestStorageAccess(),!0}catch(r){return console.warn("requestStorageAccess threw an error:",r),!1}else return!1}class FP{constructor(e,t=window.indexedDB,r=window.IDBKeyRange,i=window.localStorage){this._serviceWorkerHandler=e,this._idbFactory=t,this._IDBKeyRange=r,this._localStorage=i}async create(e,t){var r;await((r=this._serviceWorkerHandler)==null?void 0:r.preventConcurrentSessionAccess(e)),LP().then(o=>{o||t.log("no persisted storage, database can be evicted by browser",t.level.Warn)});const i=await $P(this._idbFactory),s=await Fh(e,this._idbFactory,this._localStorage,t);return new qN(s,this._idbFactory,this._IDBKeyRange,i,this._localStorage,t.logger)}async delete(e){const t=l0(e);try{EN(this._localStorage,t)}catch{}try{const r=this._idbFactory.deleteDatabase(t);await Et(r)}catch{}}async export(e,t){const r=await Fh(e,this._idbFactory,this._localStorage,t);return await WN(r)}async import(e,t,r){const i=await Fh(e,this._idbFactory,this._localStorage,r);return await YN(i,t)}}async function BP(n,e,t,r,i,s){const o=t||0;return s.wrap({l:"storage migration",oldVersion:t,version:r},async a=>{for(let c=o;c<r;++c){const u=a0[c];await a.wrap(`v${c+1}`,l=>u(n,e,i,l))}})}class VP{constructor(e){this._name=e}getAll(){const e=localStorage.getItem(this._name);if(e){const t=JSON.parse(e);if(Array.isArray(t))return Promise.resolve(t)}return Promise.resolve([])}async updateLastUsed(e,t){const r=await this.getAll();if(r){const i=r.find(s=>s.id===e);i&&(i.lastUsed=t,localStorage.setItem(this._name,JSON.stringify(r)))}}async updateToken(e,t,r,i){const s=await this.getAll();if(s){const o=s.find(a=>a.id===e);o&&(o.accessToken=t,o.accessTokenExpiresAt=r,o.refreshToken=i,localStorage.setItem(this._name,JSON.stringify(s)))}}async get(e){const t=await this.getAll();if(t)return t.find(r=>r.id===e)}async add(e){const t=await this.getAll();t.push(e),localStorage.setItem(this._name,JSON.stringify(t))}async delete(e){let t=await this.getAll();t=t.filter(r=>r.id!==e),localStorage.setItem(this._name,JSON.stringify(t))}}class KP{constructor(e){this._prefix=e}async setInt(e,t){this._set(e,t)}async getInt(e,t=0){const r=window.localStorage.getItem(`${this._prefix}${e}`);return typeof r=="string"?parseInt(r,10):t}async setBool(e,t){this._set(e,t)}async getBool(e,t=!1){const r=window.localStorage.getItem(`${this._prefix}${e}`);return typeof r=="string"?r==="true":t}async setString(e,t){this._set(e,t)}async getString(e){return window.localStorage.getItem(`${this._prefix}${e}`)}async remove(e){window.localStorage.removeItem(`${this._prefix}${e}`)}async _set(e,t){window.localStorage.setItem(`${this._prefix}${e}`,t)}}class jP{constructor(){this._encoder=null,this._decoder=null}encode(e){return this._encoder||(this._encoder=new TextEncoder),this._encoder.encode(e)}decode(e){return this._decoder||(this._decoder=new TextDecoder),this._decoder.decode(e)}}class HP{encodeUnpadded(e){const t=zi.encode(e),r=t.indexOf("=");return r!==-1?t.substr(0,r):t}encode(e){return zi.encode(e)}decode(e){return zi.decode(e)}}function zP(n){if(n.__esModule)return n;var e=Object.defineProperty({},"__esModule",{value:!0});return Object.keys(n).forEach(function(t){var r=Object.getOwnPropertyDescriptor(n,t);Object.defineProperty(e,t,r.get?r:{enumerable:!0,get:function(){return n[t]}})}),e}var c0={isBuffer:function(n){return n instanceof Uint8Array},from:function(n){return n},allocUnsafe:function(n){return c0.alloc(n)},alloc:function(n){return new Uint8Array(n)}},GP=Object.freeze(Object.defineProperty({__proto__:null,Buffer:c0},Symbol.toStringTag,{value:"Module"})),qP=zP(GP),vc=qP.Buffer;function WP(n){if(n.length>=255)throw new TypeError("Alphabet too long");for(var e=new Uint8Array(256),t=0;t<e.length;t++)e[t]=255;for(var r=0;r<n.length;r++){var i=n.charAt(r),s=i.charCodeAt(0);if(e[s]!==255)throw new TypeError(i+" is ambiguous");e[s]=r}var o=n.length,a=n.charAt(0),c=Math.log(o)/Math.log(256),u=Math.log(256)/Math.log(o);function l(m){if((Array.isArray(m)||m instanceof Uint8Array)&&(m=vc.from(m)),!vc.isBuffer(m))throw new TypeError("Expected Buffer");if(m.length===0)return"";for(var w=0,S=0,v=0,_=m.length;v!==_&&m[v]===0;)v++,w++;for(var b=(_-v)*u+1>>>0,k=new Uint8Array(b);v!==_;){for(var g=m[v],A=0,M=b-1;(g!==0||A<S)&&M!==-1;M--,A++)g+=256*k[M]>>>0,k[M]=g%o>>>0,g=g/o>>>0;if(g!==0)throw new Error("Non-zero carry");S=A,v++}for(var C=b-S;C!==b&&k[C]===0;)C++;for(var P=a.repeat(w);C<b;++C)P+=n.charAt(k[C]);return P}function d(m){if(typeof m!="string")throw new TypeError("Expected String");if(m.length===0)return vc.alloc(0);var w=0;if(m[w]!==" "){for(var S=0,v=0;m[w]===a;)S++,w++;for(var _=(m.length-w)*c+1>>>0,b=new Uint8Array(_);m[w];){var k=e[m.charCodeAt(w)];if(k===255)return;for(var g=0,A=_-1;(k!==0||g<v)&&A!==-1;A--,g++)k+=o*b[A]>>>0,b[A]=k%256>>>0,k=k/256>>>0;if(k!==0)throw new Error("Non-zero carry");v=g,w++}if(m[w]!==" "){for(var M=_-v;M!==_&&b[M]===0;)M++;var C=vc.allocUnsafe(S+(_-M));C.fill(0,0,S);for(var P=S;M!==_;)C[P++]=b[M++];return C}}}function p(m){var w=d(m);if(w)return w;throw new Error("Non-base"+o+" character")}return{encode:l,decodeUnsafe:d,decode:p}}var YP=WP,XP=YP,JP="123456789ABCDEFGHJKLMNPQRSTUVWXYZabcdefghijkmnopqrstuvwxyz",Iv=XP(JP);class QP{encode(e){return Iv.encode(e)}decode(e){return Iv.decode(e)}}class ZP{constructor(){this.utf8=new jP,this.base64=new HP,this.base58=new QP}}class eO{constructor(e){this._workerPool=e}megolmDecrypt(e,t){const r=e.export_session(e.first_known_index());return this._workerPool.send({type:"megolm_decrypt",ciphertext:t,sessionKey:r})}async createAccountAndOTKs(e,t){let r;window.msCrypto&&(r=[window.msCrypto.getRandomValues(new Uint8Array(64)),window.msCrypto.getRandomValues(new Uint8Array(t*32))]);const i=await this._workerPool.send({type:"olm_create_account_otks",randomValues:r,otkAmount:t}).response();e.unpickle("",i)}async createOutboundOlmSession(e,t,r,i){const s=e.pickle("");let o;window.msCrypto&&(o=[window.msCrypto.getRandomValues(new Uint8Array(64))]);const a=await this._workerPool.send({type:"olm_create_outbound",accountPickle:s,theirIdentityKey:r,theirOneTimeKey:i,randomValues:o}).response();t.unpickle("",a)}dispose(){this._workerPool.dispose()}}function u0(n){return typeof n!="object"||"nodeType"in n||Array.isArray(n)}function uo(n,e){return Object.entries(n).reduce((t,[r,i])=>(typeof i=="function"&&(i=i(e)),i?t+(t.length?" ":"")+r:t),"")}function Ys(n,e,t){e==="className"&&(e="class"),t===!1?n.removeAttribute(e):(t===!0&&(t=e),n.setAttribute(e,t))}function tO(n,e,t){return d0(__,n,e,t)}function d0(n,e,t,r){t&&u0(t)&&(r=t,t=void 0);const i=document.createElementNS(n,e);if(t)for(let[s,o]of Object.entries(t))typeof o=="object"&&(o=o!==null&&s==="className"?uo(o,void 0):!1),Ys(i,s,o);if(r){Array.isArray(r)||(r=[r]);for(let s of r)typeof s=="string"&&(s=mr(s)),i.appendChild(s)}return i}function mr(n){return document.createTextNode(n)}const __="http://www.w3.org/1999/xhtml",nO="http://www.w3.org/2000/svg",h0={[__]:["br","a","ol","ul","li","div","h1","h2","h3","h4","h5","h6","p","strong","em","span","img","section","header","main","footer","dialog","article","aside","del","blockquote","details","summary","table","thead","tbody","tr","th","td","hr","pre","code","button","time","input","textarea","select","option","optgroup","label","form","progress","output","video","style"],[nO]:["svg","g","path","circle","ellipse","rect","use"]},oe={};for(const[n,e]of Object.entries(h0))for(const t of e)oe[t]=function(r,i){return d0(n,t,r,i)};function pl(n,e){let t;try{t=n.mount(e)}catch(r){console.error(r),t=rO(r)}return t}function rO(n){const e=new Error().stack;let t=null;return e&&(t=e.split(`
`)[1]),oe.div([oe.h2("Something went wrong"),oe.h3(n.message),oe.p(`This occurred while running ${t}.`),oe.pre(n.stack)])}function Tv(n,e,t){if(e===n.childElementCount)n.appendChild(t);else{const i=n.children[e];n.insertBefore(t,i)}}function iO(n){n.innerHTML=""}function Bu(n){return async e=>{var t,r;(t=e.target)==null||t.setAttribute("disabled","disabled"),await n(e),(r=e.target)==null||r.removeAttribute("disabled")}}class wi{constructor({list:e,onItemClick:t,className:r,tagName:i="ul",parentProvidesUpdates:s=!0},o){this._onItemClick=t,this._list=e,this._className=r,this._tagName=i,this._root=void 0,this._subscription=void 0,this._childCreator=o,this._childInstances=void 0,this._mountArgs={parentProvidesUpdates:s}}root(){return this._root}update(e){if(e.list){if(this._subscription)for(this._unloadList();this._root.lastChild;)this._root.lastChild.remove();this._list=e.list,this.loadList()}}mount(){const e={};this._className&&(e.className=this._className);const t=this._root=tO(this._tagName,e);return this.loadList(),this._onItemClick&&t.addEventListener("click",this),t}handleEvent(e){e.type==="click"&&this._handleClick(e)}unmount(){this._list&&this._unloadList()}_handleClick(e){if(e.target===this._root||!this._onItemClick)return;let t=e.target;for(;t.parentNode!==this._root;)t=t.parentNode;const r=Array.prototype.indexOf.call(this._root.childNodes,t),i=this._childInstances[r];i&&this._onItemClick(i,e)}_unloadList(){this._subscription=this._subscription();for(let e of this._childInstances)e.unmount();this._childInstances=void 0}loadList(){if(!this._list)return;this._subscription=this._list.subscribe(this),this._childInstances=[];const e=document.createDocumentFragment();for(let t of this._list){const r=this._childCreator(t);this._childInstances.push(r),e.appendChild(pl(r,this._mountArgs))}this._root.appendChild(e)}onReset(){for(const e of this._childInstances)e.root().remove(),e.unmount();this._childInstances.length=0}onAdd(e,t){this.addChild(e,t)}onRemove(e,t){this.removeChild(e)}onMove(e,t,r){this.moveChild(e,t)}onUpdate(e,t,r){this.updateChild(e,t,r)}addChild(e,t){const r=this._childCreator(t);this._childInstances.splice(e,0,r),Tv(this._root,e,pl(r,this._mountArgs))}removeChild(e){const[t]=this._childInstances.splice(e,1);t.root().remove(),t.unmount()}moveChild(e,t){const[r]=this._childInstances.splice(e,1);this._childInstances.splice(t,0,r),r.root().remove(),Tv(this._root,t,r.root())}updateChild(e,t,r){if(this._childInstances){const i=this._childInstances[e];i&&i.update(t,r)}}recreateItem(e,t){if(this._childInstances){const r=this._childCreator(t);if(!r)this.onRemove(e,t);else{const[i]=this._childInstances.splice(e,1,r);this._root.replaceChild(r.mount(this._mountArgs),i.root()),i.unmount()}}}getChildInstanceByIndex(e){var t;return(t=this._childInstances)==null?void 0:t[e]}}class f0{constructor(e){this._value=e,this._boundUpdateFromValue=null}subscribeOnMount(e){e&&e.parentProvidesUpdates||this._subscribe()}unmount(){this._unsubscribe()}get value(){return this._value}_updateFromValue(e){this.update(this._value,e)}_subscribe(){var e;typeof((e=this._value)==null?void 0:e.on)=="function"&&(this._boundUpdateFromValue=this._updateFromValue.bind(this),this._value.on("change",this._boundUpdateFromValue))}_unsubscribe(){this._boundUpdateFromValue&&(typeof this._value.off=="function"&&this._value.off("change",this._boundUpdateFromValue),this._boundUpdateFromValue=null)}}function sO(n){for(const e of Object.values(n))if(typeof e=="function")return!0;return!1}class G extends f0{constructor(){super(...arguments),this._eventListeners=void 0,this._bindings=void 0,this._root=void 0,this._subViews=void 0}_attach(){if(this._eventListeners)for(let{node:e,name:t,fn:r,useCapture:i}of this._eventListeners)e.addEventListener(t,r,i)}_detach(){if(this._eventListeners)for(let{node:e,name:t,fn:r,useCapture:i}of this._eventListeners)e.removeEventListener(t,r,i)}mount(e){const t=new p0(this);try{this._root=this.render(t,this._value)}finally{t.close()}return this.subscribeOnMount(e),this._attach(),this._root}unmount(){if(this._detach(),super.unmount(),this._subViews)for(const e of this._subViews)e.unmount()}root(){return this._root}update(e,t){if(this._value=e,this._bindings)for(const r of this._bindings)r()}_addEventListener(e,t,r,i=!1){this._eventListeners||(this._eventListeners=[]),this._eventListeners.push({node:e,name:t,fn:r,useCapture:i})}_addBinding(e){this._bindings||(this._bindings=[]),this._bindings.push(e)}addSubView(e){this._subViews||(this._subViews=[]),this._subViews.push(e)}removeSubView(e){if(!this._subViews)return;const t=this._subViews.indexOf(e);t!==-1&&this._subViews.splice(t,1)}updateSubViews(e,t){if(this._subViews)for(const r of this._subViews)r.update(e,t)}}class p0{constructor(e){this._closed=!1,this._templateView=e}close(){this._closed=!0}_addBinding(e){this._closed&&console.trace("Adding a binding after render will likely cause memory leaks"),this._templateView._addBinding(e)}get _value(){return this._templateView.value}addEventListener(e,t,r,i=!1){this._templateView._addEventListener(e,t,r,i)}_addAttributeBinding(e,t,r){let i;const s=()=>{const o=r(this._value);i!==o&&(i=o,Ys(e,t,o))};this._addBinding(s),s()}_addClassNamesBinding(e,t){this._addAttributeBinding(e,"className",r=>uo(t,r))}_addTextBinding(e){const t=e(this._value)+"",r=mr(t);let i=t;const s=()=>{const o=e(this._value)+"";i!==o&&(i=o,r.textContent=o)};return this._addBinding(s),r}_isEventHandler(e,t){return e.startsWith("on")&&e.length>2&&typeof t=="function"}_setNodeAttributes(e,t){for(let[r,i]of Object.entries(t))if(typeof i=="object"){if(r!=="className"||i===null)continue;sO(i)?this._addClassNamesBinding(e,i):Ys(e,r,uo(i,this._value))}else if(this._isEventHandler(r,i)){const s=r.substr(2,1).toLowerCase()+r.substr(3),o=i;this._templateView._addEventListener(e,s,o)}else typeof i=="function"?this._addAttributeBinding(e,r,i):Ys(e,r,i)}_setNodeChildren(e,t){Array.isArray(t)||(t=[t]);for(let r of t)typeof r=="function"?r=this._addTextBinding(r):typeof r=="string"&&(r=mr(r)),e.appendChild(r)}_addReplaceNodeBinding(e,t){let r=e(this._value),i=t(null);const s=()=>{const o=e(this._value);if(r!==o){r=o;const a=t(i);i.parentNode&&i.parentNode.replaceChild(a,i),i=a}};return this._addBinding(s),i}el(e,t,r){return this.elNS(__,e,t,r)}elNS(e,t,r,i){let s;r&&(u0(r)?i=r:s=r);const o=document.createElementNS(e,t);return s&&this._setNodeAttributes(o,s),i&&this._setNodeChildren(o,i),o}view(e,t){return this._templateView.addSubView(e),pl(e,t)}mapView(e,t){return this._addReplaceNodeBinding(e,r=>{if(r&&r.nodeType!==Node.COMMENT_NODE){const s=this._templateView._subViews;if(s){const o=s.findIndex(a=>a.root()===r);if(o!==-1){const[a]=s.splice(o,1);a.unmount()}}}const i=t(e(this._value));return i?this.view(i):document.createComment("node binding placeholder")})}map(e,t){return this.mapView(e,r=>new Vu(this._value,(i,s)=>{const o=t(r,i,s);return o||document.createComment("map placeholder")}))}ifView(e,t){return this.mapView(r=>!!e(r),r=>r?t(this._value):null)}if(e,t){return this.ifView(e,r=>new Vu(r,t))}mapSideEffect(e,t){let r=e(this._value);const i=()=>{const s=e(this._value);r!==s&&(t(s,r,this._value),r=s)};this._addBinding(i),t(r,void 0,this._value)}}for(const[n,e]of Object.entries(h0))for(const t of e)p0.prototype[t]=function(r,i){return this.elNS(n,t,r,i)};class Vu extends G{constructor(e,t){super(e),this._render=t}render(e,t){return this._render(e,t)}}function Vi(n,e,t=void 0){const r=!!n.avatarUrl(e);let i=uo({avatar:!0,[`size-${e}`]:!0,[`usercolor${n.avatarColorNumber}`]:!r});t&&(i+=` ${t}`);const s=r?m0(n,e):mr(n.avatarLetter),o=oe.div({className:i,title:n.avatarTitle,"data-testid":"avatar"},[s]);return r&&(Ys(o,"data-avatar-letter",n.avatarLetter),Ys(o,"data-avatar-color",n.avatarColorNumber)),o}function m0(n,e){const t=e.toString();return oe.img({src:n.avatarUrl(e),width:t,height:t,title:n.avatarTitle})}function oO(n){const e=n.target,t=e.parentElement;return e.tagName==="IMG"&&t.classList.contains("avatar")}function Rv(n){if(!oO(n))return;const e=n.target.parentElement,t=e.getAttribute("data-avatar-color");e.classList.add(`usercolor${t}`);const r=e.getAttribute("data-avatar-letter");e.textContent=r}class Hn extends f0{constructor(e,t){super(e),this._root=null,this._avatarUrl=null,this._avatarTitle=null,this._avatarLetter=null,this._size=t}_avatarUrlChanged(){return this.value.avatarUrl(this._size)!==this._avatarUrl?(this._avatarUrl=this.value.avatarUrl(this._size),!0):!1}_avatarTitleChanged(){return this.value.avatarTitle!==this._avatarTitle?(this._avatarTitle=this.value.avatarTitle,!0):!1}_avatarLetterChanged(){return this.value.avatarLetter!==this._avatarLetter?(this._avatarLetter=this.value.avatarLetter,!0):!1}mount(e){return this._avatarUrlChanged(),this._avatarLetterChanged(),this._avatarTitleChanged(),this._root=Vi(this.value,this._size),this.subscribeOnMount(e),this._root}root(){return this._root}update(e){if(this._avatarUrlChanged()){const r=`usercolor${e.avatarColorNumber}`;e.avatarUrl(this._size)?(this._root.replaceChild(m0(e,this._size),this._root.firstChild),this._root.classList.remove(r)):(this._root.textContent=e.avatarLetter,this._root.classList.add(r))}const t=!!e.avatarUrl(this._size);if(this._avatarTitleChanged()&&t){const r=this._root.firstChild;r.tagName==="IMG"&&r.setAttribute("title",e.avatarTitle)}this._avatarLetterChanged()&&!t&&(this._root.textContent=e.avatarLetter)}}let wc;function Ot(n,e=void 0){wc===void 0&&(wc=document.querySelector(".hydrogen"));const t=Object.assign({spinner:!0},e);return wc!=null&&wc.classList.contains("legacy")?n.div({className:t},[n.div(),n.div(),n.div(),n.div()]):n.svg({className:t,viewBox:"0 0 100 100"},n.circle({cx:"50%",cy:"50%",r:"45%",pathLength:"100"}))}class aO extends G{render(e,t){const r={active:i=>i.isOpen,hidden:i=>i.hidden};return e.li({className:r},[e.a({href:t.url},[e.view(new Hn(t,32),{parentProvidesUpdates:!0}),e.div({className:"description"},[e.div({className:{name:!0,unread:i=>i.isUnread}},i=>i.name),e.map(i=>i.busy,i=>i?Ot(e):e.div({className:{badge:!0,highlighted:s=>s.isHighlighted,hidden:s=>!s.badgeCount}},s=>s.badgeCount))])])])}update(e,t){super.update(e),this.updateSubViews(e,t)}}class je extends G{static option(e,t){return new lO(e,t)}constructor(e){super(),this._options=e}render(e){return e.ul({className:"menu",role:"menu"},this._options.map(t=>t.toDOM(e)))}}class lO{constructor(e,t){this.label=e,this.callback=t,this.icon=null,this.destructive=!1}setIcon(e){return this.icon=e,this}setDestructive(){return this.destructive=!0,this}toDOM(e){const t={destructive:this.destructive};return this.icon&&(t.icon=!0,t[this.icon]=!0),e.li({className:t},e.button({className:"menu-item",onClick:this.callback},this.label))}}class $d{constructor(e,t=null){this._view=e,this._target=null,this._arrangement=null,this._scroller=null,this._fakeRoot=null,this._trackingTemplateView=null,this._closeCallback=t}_getPopupContainer(){const e=this._target.closest(".hydrogen");let t=e.querySelector(".popupContainer");return t||(t=oe.div({className:"popupContainer"}),e.appendChild(t)),t}trackInTemplateView(e){this._trackingTemplateView=e,this._trackingTemplateView.addSubView(this)}showRelativeTo(e,t=0){this._target=e,this._verticalPadding=t,this._scroller=cO(this._target),this._view.mount(),this._getPopupContainer().appendChild(this._popup),this._position(),this._scroller&&document.body.addEventListener("scroll",this,!0),setTimeout(()=>{document.body.addEventListener("click",this,!1)},10)}get isOpen(){return!!this._view}close(){this._view&&(this._view.unmount(),this._trackingTemplateView.removeSubView(this),this._scroller&&document.body.removeEventListener("scroll",this,!0),document.body.removeEventListener("click",this,!1),this._popup.remove(),this._view=null,this._closeCallback&&this._closeCallback())}get _popup(){return this._view.root()}handleEvent(e){e.type==="scroll"?this._position()||this.close():e.type==="click"&&this._onClick(e)}_onClick(){this.close()}_position(){const e=this._target.getBoundingClientRect(),t=this._popup.clientWidth,r=this._popup.clientHeight,i=(this._scroller?this._scroller:document.documentElement).getBoundingClientRect();if(e.top>i.bottom||e.left>i.right||e.bottom<i.top||e.right<i.left)return!1;if(i.bottom>=e.bottom+r)this._popup.style.top=`${e.bottom+this._verticalPadding}px`;else if(i.top<=e.top-r)this._popup.style.top=`${e.top-r-this._verticalPadding}px`;else return!1;if(i.right>=e.right+t)this._popup.style.left=`${e.left}px`;else if(i.left<=e.left-t)this._popup.style.left=`${e.right-t}px`;else return!1;return!0}root(){return this._fakeRoot}mount(){return this._fakeRoot=document.createComment("popup"),this._fakeRoot}unmount(){this.close()}update(){}}function cO(n){let e=n;do if(e=e.parentElement,e.scrollHeight>e.clientHeight){const r=window.getComputedStyle(e).getPropertyValue("overflow-y");if(r==="auto"||r==="scroll")return e}while(e!==document.body)}class uO extends G{render(e,t){const r=()=>{i.value="",i.blur(),s.blur(),t.clear()},i=e.input({type:"text",placeholder:t==null?void 0:t.label,"aria-label":t==null?void 0:t.label,autocomplete:t==null?void 0:t.autocomplete,enterkeyhint:"search",name:t==null?void 0:t.name,onInput:o=>t.set(o.target.value),onKeydown:o=>{(o.key==="Escape"||o.key==="Esc")&&r()},onFocus:()=>i.select()}),s=e.button({onClick:r,title:t.i18n`Clear`,"aria-label":t.i18n`Clear`});return e.div({className:"FilterField"},[i,s])}}class dO extends G{constructor(e){super(e),this._createMenuPopup=null}render(e,t){const r=o=>o.gridEnabled?o.i18n`Show single room`:o.i18n`Enable grid layout`,i=e.view(new wi({className:"RoomList",list:t.tileViewModels},o=>new aO(o))),s=e.div({className:"utilities"},[e.a({className:"button-utility close-session",href:t.closeUrl,"aria-label":t.i18n`Back to account list`,title:t.i18n`Back to account list`}),e.view(new uO({i18n:t.i18n,label:t.i18n`Filter rooms`,name:"room-filter",autocomplete:!0,set:o=>{t.setFilter(o)&&(i.scrollTop=0)},clear:()=>t.clearFilter()})),e.button({onClick:()=>t.toggleGrid(),className:{"button-utility":!0,grid:!0,on:o=>o.gridEnabled},title:r,"aria-label":r}),e.a({className:"button-utility settings",href:t.settingsUrl,"aria-label":t.i18n`Settings`,title:t.i18n`Settings`}),e.button({className:"button-utility create","aria-label":t.i18n`Create room`,onClick:o=>this._toggleCreateMenu(o)})]);return e.div({className:"LeftPanel"},[s,i])}_toggleCreateMenu(e){if(this._createMenuPopup&&this._createMenuPopup.isOpen)this._createMenuPopup.close();else{const t=this.value,r=[];r.push(je.option(t.i18n`Create Room`,()=>t.showCreateRoomView())),r.push(je.option(t.i18n`Join Room`,()=>t.showJoinRoomView())),this._createMenuPopup=new $d(new je(r)),this._createMenuPopup.trackInTemplateView(this),this._createMenuPopup.showRelativeTo(e.target,10)}}}function Cv(n){return n.offsetTop+n.clientHeight}function Mv(n,e,t=n.children.length-1){for(var r=t;r>=0;r--)if(n.children[r].offsetTop<e)return r;return 0}class hO extends G{constructor(e,t){super(e),this.viewClassForTile=t,this.anchoredBottom=0,this.stickToBottom=!0}render(e,t){requestAnimationFrame(()=>{this.restoreScrollPosition()}),this.tilesView=new fO(t.tiles,()=>this.restoreScrollPosition(),this.viewClassForTile);const r=e.div({className:"Timeline"},[e.div({className:"Timeline_scroller bottom-aligned-scroll",onScroll:()=>this.onScroll()},e.view(this.tilesView)),e.button({className:{Timeline_jumpDown:!0,hidden:i=>!i.showJumpDown},title:"Jump down",onClick:()=>this.jumpDown()})]);return typeof ResizeObserver=="function"&&(this.resizeObserver=new ResizeObserver(()=>{this.restoreScrollPosition()}),this.resizeObserver.observe(r)),r}get scrollNode(){return this.root().firstElementChild}get tilesNode(){return this.tilesView.root()}jumpDown(){const{scrollNode:e}=this;this.stickToBottom=!0,e.scrollTop=e.scrollHeight}unmount(){super.unmount(),this.resizeObserver&&(this.resizeObserver.unobserve(this.root()),this.resizeObserver=void 0)}restoreScrollPosition(){const{scrollNode:e,tilesNode:t}=this,r=e.clientHeight-t.clientHeight;if(r>0){t.style.setProperty("margin-top",`${r}px`);const i=this.value.tiles.length;this.updateVisibleRange(0,i-1)}else if(t.style.removeProperty("margin-top"),this.stickToBottom)e.scrollTop=e.scrollHeight;else if(this.anchoredNode){const i=Cv(this.anchoredNode);if(i!==this.anchoredBottom){const s=i-this.anchoredBottom;typeof e.scrollBy=="function"?e.scrollBy(0,s):e.scrollTop=e.scrollTop+s,this.anchoredBottom=i}}}onScroll(){const{scrollNode:e,tilesNode:t}=this,{scrollHeight:r,scrollTop:i,clientHeight:s}=e;let o;if(this.stickToBottom=Math.abs(r-(i+s))<1,this.stickToBottom)o=this.value.tiles.length-1;else{const c=i+s,u=Mv(t,c);this.anchoredNode=t.childNodes[u],this.anchoredBottom=Cv(this.anchoredNode),o=u}let a=Mv(t,i,o);this.updateVisibleRange(a,o)}updateVisibleRange(e,t){const r=this.tilesView.getChildInstanceByIndex(e),i=this.tilesView.getChildInstanceByIndex(t);this.value.setVisibleTileRange(r==null?void 0:r.value,i==null?void 0:i.value)}}class fO extends wi{constructor(e,t,r){super({list:e,onItemClick:(i,s)=>i.onClick(s)},i=>{const s=r(i);return new s(i,r)}),this.viewClassForTile=r,this.onChanged=t}onReset(){super.onReset(),this.onChanged()}onUpdate(e,t,r){if(r==="shape"){const i=this.viewClassForTile(t),s=this.getChildInstanceByIndex(e);if(!i||!(s instanceof i)){super.recreateItem(e,t);return}}super.onUpdate(e,t,r),this.onChanged()}onAdd(e,t){super.onAdd(e,t),this.onChanged()}onRemove(e,t){super.onRemove(e,t),this.onChanged()}onMove(e,t,r){super.onMove(e,t,r),this.onChanged()}}class pO extends G{render(e,t){return e.div({className:"TimelineLoadingView"},[Ot(e),e.div(t.isEncrypted?t.i18n`Loading encrypted messages`:t.i18n`Loading messages`)])}}class mO extends G{constructor(e,t){super(e),this._viewClassForTile=t,this._input=null,this._attachmentPopup=null,this._focusInput=null,this._rafResizeHandle=void 0}render(e,t){this._input=e.textarea({onKeydown:s=>this._onKeyDown(s),onInput:()=>{t.setInput(this._input.value),this._input.value?this._adjustHeight():this._clearHeight()},placeholder:s=>s.isEncrypted?"Send an encrypted message":"Send a message",rows:"1"}),this._focusInput=()=>this._input.focus(),this.value.on("focus",this._focusInput);const r=e.map(s=>s.replyViewModel,(s,o)=>{const a=s&&this._viewClassForTile(s);return a?o.div({className:"MessageComposer_replyPreview"},[o.span({className:"replying"},"Replying"),o.button({className:"cancel",onClick:()=>this._clearReplyingTo()},"Close"),o.view(new a(s,this._viewClassForTile,{interactive:!1},"div"))]):null}),i=e.div({className:"MessageComposer_input"},[this._input,e.button({className:"sendFile",title:t.i18n`Pick attachment`,onClick:s=>this._toggleAttachmentMenu(s)},t.i18n`Send file`),e.button({className:"send",title:t.i18n`Send`,onClick:()=>this._trySend()},t.i18n`Send`)]);return e.div({className:{MessageComposer:!0,MessageComposer_canSend:s=>s.canSend}},[r,i])}unmount(){this._focusInput&&this.value.off("focus",this._focusInput),super.unmount()}_clearReplyingTo(){this.value.clearReplyingTo()}async _trySend(){this._input.focus();const{value:e}=this._input,t=()=>{this._input.value=e,this._adjustHeight()};this._input.value="",this._clearHeight();try{await this.value.sendMessage(e)||t()}catch(r){t(),console.error(r)}}_onKeyDown(e){e.key==="Enter"&&!e.shiftKey&&(e.preventDefault(),this._trySend())}_toggleAttachmentMenu(e){if(this._attachmentPopup&&this._attachmentPopup.isOpen)this._attachmentPopup.close();else{const t=this.value;this._attachmentPopup=new $d(new je([je.option(t.i18n`Send video`,()=>t.sendVideo()).setIcon("video"),je.option(t.i18n`Send picture`,()=>t.sendPicture()).setIcon("picture"),je.option(t.i18n`Send file`,()=>t.sendFile()).setIcon("file")])),this._attachmentPopup.trackInTemplateView(this),this._attachmentPopup.showRelativeTo(e.target,12)}}_adjustHeight(){this._rafResizeHandle||(this._rafResizeHandle=window.requestAnimationFrame(()=>{const e=this._input.scrollHeight;this._input.style.height=`${e}px`,this._rafResizeHandle=void 0}))}_clearHeight(){this._input.style.removeProperty("height")}}class _O extends G{render(e){return e.div({className:"DisabledComposerView"},e.h3(t=>t.description))}}class Do extends G{constructor(e,t={inline:!1}){super(e),this.options=t}render(e,t){const r=e.button({className:"ErrorView_submit",onClick:Bu(async s=>{s.stopPropagation(),await t.submitLogs()?alert("Logs submitted!"):alert("Could not submit logs")})},"Submit logs"),i=e.button({className:"ErrorView_close",onClick:s=>{s.stopPropagation(),t.close()},title:"Dismiss error"});return e.div({className:{ErrorView:!0,ErrorView_inline:this.options.inline,ErrorView_block:!this.options.inline}},[e.p({className:"ErrorView_message"},t.message),r,i])}}class gO extends G{render(e,t){const r=e.view(new wi({className:"CallView_members",list:t.memberViewModels},i=>new yO(i)));return this.bindMembersCssClasses(e,r),e.div({class:"CallView"},[r,e.div({class:"CallView_buttons"},[e.button({className:{CallView_mutedMicrophone:i=>i.isMicrophoneMuted,CallView_unmutedMicrophone:i=>!i.isMicrophoneMuted},onClick:Bh(()=>t.toggleMicrophone())}),e.button({className:{CallView_mutedCamera:i=>i.isCameraMuted,CallView_unmutedCamera:i=>!i.isCameraMuted},onClick:Bh(()=>t.toggleCamera())}),e.button({className:"CallView_hangup",onClick:Bh(()=>t.hangup())})]),e.if(i=>!!i.errorViewModel,i=>i.div({className:"CallView_error"},i.view(new Do(t.errorViewModel))))])}bindMembersCssClasses(e,t){if(e.mapSideEffect(r=>r.memberCount,r=>{t.classList.forEach((i,s,o)=>{i.startsWith("size")&&o.remove(i)}),t.classList.add(`size${r}`)}),typeof ResizeObserver=="function"){const r=(i,s)=>{s?t.classList.add(i):t.classList.remove(i)};this.resizeObserver=new ResizeObserver(()=>{const i=t.clientWidth/t.clientHeight,s=i<.5,o=!s&&i<1.8,a=!s&&!o;r("tall",s),r("square",o),r("wide",a)}),this.resizeObserver.observe(t)}}unmount(){this.resizeObserver&&(this.resizeObserver.unobserve(this.root().querySelector(".CallView_members")),this.resizeObserver=void 0),super.unmount()}}class yO extends G{render(e,t){const r=e.video({autoplay:!0,disablePictureInPicture:!0,className:{hidden:i=>i.isCameraMuted}});return e.mapSideEffect(i=>i.stream,i=>{r.srcObject=i}),e.div({className:"StreamView"},[r,e.div({className:{StreamView_avatar:!0,hidden:i=>!i.isCameraMuted}},e.view(new Hn(t,96),{parentProvidesUpdates:!0})),e.div({className:{StreamView_muteStatus:!0,hidden:i=>!i.isCameraMuted&&!i.isMicrophoneMuted,microphoneMuted:i=>i.isMicrophoneMuted&&!i.isCameraMuted,cameraMuted:i=>i.isCameraMuted}}),e.if(i=>!!i.errorViewModel,i=>i.div({className:"StreamView_error"},i.view(new Do(t.errorViewModel))))])}update(e,t){super.update(e),this.updateSubViews(e,t)}}function Bh(n){return async e=>{var t,r;(t=e.target)==null||t.setAttribute("disabled","disabled"),await n(e),(r=e.target)==null||r.removeAttribute("disabled")}}class _0 extends G{constructor(e,t){super(e),this._viewClassForTile=t,this._optionsPopup=null}render(e,t){return e.main({className:"RoomView middle"},[e.div({className:"RoomHeader middle-header"},[e.a({className:"button-utility close-middle",href:t.closeUrl,title:t.i18n`Close room`}),e.view(new Hn(t,32)),e.div({className:"room-description"},[e.h2(r=>r.name)]),e.button({className:"button-utility room-options","aria-label":t.i18n`Room options`,onClick:r=>this._toggleOptionsMenu(r)})]),e.div({className:"RoomView_body"},[e.if(r=>r.errorViewModel,r=>r.div({className:"RoomView_error"},r.view(new Do(t.errorViewModel)))),e.mapView(r=>r.callViewModel,r=>r?new gO(r):null),e.mapView(r=>r.timelineViewModel,r=>r?new hO(r,this._viewClassForTile):new pO(t)),e.mapView(r=>r.composerViewModel,r=>{switch(r==null?void 0:r.kind){case"composer":return new mO(t.composerViewModel,this._viewClassForTile);case"disabled":return new _O(t.composerViewModel)}})])])}_toggleOptionsMenu(e){if(this._optionsPopup&&this._optionsPopup.isOpen)this._optionsPopup.close();else{const t=this.value,r=[];if(r.push(je.option(t.i18n`Room details`,()=>t.openDetailsPanel())),t.features.calls&&r.push(je.option(t.i18n`Start call`,()=>t.startCall())),t.canLeave&&r.push(je.option(t.i18n`Leave room`,()=>this._confirmToLeaveRoom()).setDestructive()),t.canForget&&r.push(je.option(t.i18n`Forget room`,()=>t.forgetRoom()).setDestructive()),t.canRejoin&&r.push(je.option(t.i18n`Rejoin room`,()=>t.rejoinRoom())),!r.length)return;this._optionsPopup=new $d(new je(r)),this._optionsPopup.trackInTemplateView(this),this._optionsPopup.showRelativeTo(e.target,10)}}_confirmToLeaveRoom(){confirm(this.value.i18n`Are you sure you want to leave "${this.value.name}"?`)&&this.value.leaveRoom()}}class vO extends G{render(e,t){return e.main({className:"UnknownRoomView middle"},e.div([e.h2([t.i18n`You are currently not in ${t.roomIdOrAlias}.`,e.br(),t.i18n`Want to join it?`]),e.button({className:"button-action primary",onClick:()=>t.join(),disabled:r=>r.busy},t.i18n`Join room`),e.if(r=>r.error,r=>r.p({className:"error"},t.error))]))}}class ho{constructor(e,t=void 0){typeof e=="function"&&!t&&(t=e,e=null),this._root=t?t(oe,e):this.render(oe,e)}mount(){return this._root}root(){return this._root}unmount(){}update(){}}class g0 extends ho{constructor(e="Loading"){super(e,(t,r)=>t.div({className:"LoadingView"},[Ot(t),r]))}}class y0 extends G{render(e,t){return e.main({className:"RoomView middle"},[e.div({className:"RoomHeader middle-header"},[e.a({className:"button-utility close-middle",href:t.closeUrl,title:t.i18n`Close room`}),e.view(new Hn(t,32)),e.div({className:"room-description"},[e.h2(r=>r.name)])]),e.div({className:"RoomView_body"},[e.mapView(r=>r.error,r=>r?new wO(t):new g0(t.i18n`Setting up the room`))])])}}class wO extends G{render(e,t){return e.div({className:"RoomBeingCreated_error centered-column"},[e.h3(t.i18n`Could not create the room, something went wrong:`),e.div({className:"RoomView_error form-group"},t.error),e.div({className:"button-row"},e.button({className:"button-action primary destructive",onClick:()=>t.cancel()},t.i18n`Cancel`))])}}class v0 extends G{render(e,t){var r;let i=[];t.isDirectMessage&&i.push(Vi(t,128,"InviteView_dmAvatar"));let s;return t.isDirectMessage?s=[e.strong(t.name),` (${(r=t.inviter)==null?void 0:r.id}) wants to chat with you.`]:t.inviter?s=[Vi(t.inviter,24),e.strong(t.inviter.name),` (${t.inviter.id}) invited you.`]:s="You were invited to join.",i.push(e.p({className:"InviteView_inviter"},s)),t.isDirectMessage||i.push(e.div({className:"InviteView_roomProfile"},[Vi(t,64,"InviteView_roomAvatar"),e.h3(t.name),e.p({className:"InviteView_roomDescription"},t.roomDescription)])),e.main({className:"InviteView middle"},[e.div({className:"RoomHeader middle-header"},[e.a({className:"button-utility close-middle",href:t.closeUrl,title:t.i18n`Close invite`}),Vi(t,32),e.div({className:"room-description"},[e.h2(o=>o.name)])]),e.if(o=>o.error,o=>o.div({className:"RoomView_error"},a=>a.error)),e.div({className:"InviteView_body"},[e.div({className:"InviteView_invite"},[...i,e.div({className:"InviteView_buttonRow"},e.button({className:"button-action primary",disabled:o=>o.busy,onClick:()=>t.accept()},t.i18n`Accept`)),e.div({className:"InviteView_buttonRow"},e.button({className:"button-action primary destructive",disabled:o=>o.busy,onClick:()=>t.reject()},t.i18n`Reject`))])])])}}class bO extends G{render(e,t){const r=e.a({href:t.closeUrl,title:t.i18n`Close`,className:"close"}),i=e.div({role:"img","aria-label":c=>c.name,title:c=>c.name,className:{picture:!0,hidden:c=>!c.imageUrl},style:c=>`background-image: url('${c.imageUrl}'); max-width: ${c.imageWidth}px; max-height: ${c.imageHeight}px;`}),s=e.div({className:{loading:!0,hidden:c=>!!c.imageUrl}},[Ot(e),e.div(t.i18n`Loading image`)]),o=e.div({className:"details"},[e.strong(c=>c.name),e.br(),"uploaded by ",e.strong(c=>c.sender),c=>` at ${c.time} on ${c.date}.`]),a=e.div({role:"dialog",className:"lightbox",onClick:c=>this.clickToClose(c),onKeydown:c=>this.closeOnEscKey(c)},[i,s,o,r]);return SO(e,a),a}clickToClose(e){e.target===this.root()&&this.value.close()}closeOnEscKey(e){(e.key==="Escape"||e.key==="Esc")&&this.value.close()}}function SO(n,e){const t=EO(e),r=t[0],i=t[t.length-1];n.addEventListener(e,"keydown",s=>{s.key==="Tab"&&(s.shiftKey?document.activeElement===r&&(i.focus(),s.preventDefault()):document.activeElement===i&&(r.focus(),s.preventDefault()))},!0),Promise.resolve().then(()=>{r.focus()})}function EO(n){return n.querySelectorAll("a[href], button, textarea, input, select")}class kO extends G{render(e,t){return e.div({className:{SessionStatusView:!0,hidden:r=>!r.isShown}},[Ot(e,{hidden:r=>!r.isWaiting}),e.p(r=>r.statusLabel),e.if(r=>r.isConnectNowShown,r=>r.button({className:"link",onClick:()=>t.connectNow()},"Retry now")),e.if(r=>r.isSecretStorageShown,r=>r.a({href:t.setupKeyBackupUrl},"Go to settings")),e.if(r=>r.canDismiss,r=>r.div({className:"end"},r.button({className:"dismiss",onClick:()=>t.dismiss()})))])}}class IO extends G{constructor(e,t){super(e),this._viewClassForTile=t}render(e,t){const r=[];for(let i=0;i<t.height*t.width;i+=1)r.push(e.div({onClick:()=>t.focusTile(i),onFocusin:()=>t.focusTile(i),className:{container:!0,[`tile${i}`]:!0,focused:s=>s.focusIndex===i}},e.mapView(s=>s.roomViewModelAt(i),s=>s?s.kind==="roomBeingCreated"?new y0(s):s.kind==="invite"?new v0(s):new _0(s,this._viewClassForTile):new ho(o=>o.div({className:"room-placeholder"},[o.h2({className:"focused"},t.i18n`Select a room on the left`),o.h2({className:"unfocused"},t.i18n`Click to select this tile`)])))));return r.push(e.div({className:i=>`focus-ring tile${i.focusIndex}`})),e.div({className:"RoomGridView middle layout3x2"},r)}}class Dl extends kr{constructor(e){super(),this._isDisposed=!1,this._options=e}childOptions(e){return Object.assign({},this._options,e)}get options(){return this._options}getOption(e){return this._options[e]}observeNavigation(e,t){const i=this.navigation.observe(e).subscribe(s=>{t(s,e)});this.track(i)}track(e){return this.disposables||(this.disposables=new Al),this.disposables.track(e)}untrack(e){if(this.disposables)return this.disposables.untrack(e)}dispose(){this.disposables&&this.disposables.dispose(),this._isDisposed=!0}get isDisposed(){return this._isDisposed}disposeTracked(e){if(this.disposables)return this.disposables.disposeTracked(e)}i18n(e,...t){let r="";for(let i=0;i<e.length;++i)r=r+e[i],i<t.length&&(r=r+t[i]);return r}emitChange(e){this._options.emitChange?this._options.emitChange(e):this.emit("change",e)}get platform(){return this._options.platform}get clock(){return this._options.platform.clock}get logger(){return this.platform.logger}get urlRouter(){return this._options.urlRouter}get features(){return this._options.features}get navigation(){return this._options.navigation}get timeFormatter(){return this._options.platform.timeFormatter}}class g_{constructor(e,t){this._id=e,this._keyDescription=t}get id(){return this._id}get passphraseParams(){var e;return(e=this._keyDescription)==null?void 0:e.passphrase}get algorithm(){var e;return(e=this._keyDescription)==null?void 0:e.algorithm}async isCompatible(e,t){if(this.algorithm==="m.secret_storage.v1.aes-hmac-sha2"){const r=this._keyDescription;if(r.mac){const i=await TO(e.binaryKey,r.iv,t);return r.mac===i}else if(r.passphrase){const i=e.description._keyDescription;return i.passphrase?r.passphrase.algorithm===i.passphrase.algorithm&&r.passphrase.iterations===i.passphrase.iterations&&r.passphrase.salt===i.passphrase.salt:!1}}return!1}}class Nl{constructor(e,t){this._keyDescription=e,this._binaryKey=t}withDescription(e){return new Nl(e,this._binaryKey)}get description(){return this._keyDescription}get id(){return this._keyDescription.id}get binaryKey(){return this._binaryKey}get algorithm(){return this._keyDescription.algorithm}}async function TO(n,e,t){const{crypto:r,encoding:i}=t,{utf8:s,base64:o}=i,{derive:a,aes:c,hmac:u}=r,l=o.decode(e),d=new Uint8Array(8),p="\0\0\0\0\0\0\0\0\0\0\0\0\0\0\0\0\0\0\0\0\0\0\0\0\0\0\0\0\0\0\0\0",m=s.encode(""),w=await a.hkdf(n,d,m,"SHA-256",512),S=w.slice(0,32),v=w.slice(32),_=await c.encryptCTR({key:S,iv:l,data:s.encode(p)}),b=await u.compute(v,_,"SHA-256");return o.encode(b)}const RO=5e5,CO=256;async function MO(n,e,t){const{passphraseParams:r}=n;if(!r)throw new Error("not a passphrase key");if(r.algorithm!=="m.pbkdf2")throw new Error(`Unsupported passphrase algorithm: ${r.algorithm}`);const{utf8:i}=t.encoding,s=await t.crypto.derive.pbkdf2(i.encode(e),r.iterations||RO,i.encode(r.salt),"SHA-512",r.bits||CO);return new Nl(n,s)}const sa=[139,1];function xO(n,e,t,r){const i=r.encoding.base58.decode(e.replace(/ /g,""));let s=0;for(const a of i)s^=a;if(s!==0)throw new Error("Incorrect parity");for(let a=0;a<sa.length;++a)if(i[a]!==sa[a])throw new Error("Incorrect prefix");if(i.length!==sa.length+t.PRIVATE_KEY_LENGTH+1)throw new Error("Incorrect length");const o=Uint8Array.from(i.slice(sa.length,sa.length+t.PRIVATE_KEY_LENGTH));return new Nl(n,o)}const y_=`${nn}ssssKey`,xv=`${nn}keyBackupVersion`;async function w0(n){var e;const t=await n.readTxn([n.storeNames.accountData]),r=await t.accountData.get("m.secret_storage.default_key"),i=(e=r==null?void 0:r.content)==null?void 0:e.key;if(!i)return;const s=await t.accountData.get(`m.secret_storage.key.${i}`);if(s)return new g_(i,s.content)}async function AO(n,e,t){const r=await t.session.get(xv);return t.session.set(xv,e),t.session.set(y_,{id:n.id,binaryKey:n.binaryKey}),r}async function DO(n){const e=await n.session.get(y_);if(!e)return;const t=await n.accountData.get(`m.secret_storage.key.${e.id}`);if(t)return new Nl(new g_(e.id,t.content),e.binaryKey)}async function NO(n){n.session.remove(y_)}async function PO(n,e,t,r,i){const s=await w0(t);if(!s)throw new Error("Could not find a default secret storage key in account data");return await b0(n,e,s,r,i)}async function b0(n,e,t,r,i){let s;if(n===1)s=await MO(t,e,r);else if(n===0)s=xO(t,e,i,r);else throw new Error(`Invalid type: ${n}`);return s}async function OO(n,e,t){const r=await w0(e);if(await(r==null?void 0:r.isCompatible(n,t)))return n.withDescription(r)}var vs=(n=>(n[n.Enabled=0]="Enabled",n[n.SetupWithPassphrase=1]="SetupWithPassphrase",n[n.SetupWithRecoveryKey=2]="SetupWithRecoveryKey",n[n.Pending=3]="Pending",n[n.NewVersionAvailable=4]="NewVersionAvailable",n))(vs||{}),Hc=(n=>(n[n.Writing=0]="Writing",n[n.Stopped=1]="Stopped",n[n.Done=2]="Done",n[n.Pending=3]="Pending",n))(Hc||{});class S0 extends G{render(e,t){return e.div([e.map(r=>r.status,(r,i,s)=>{switch(r){case vs.Enabled:return UO(i,s);case vs.NewVersionAvailable:return $O(i,s);case vs.SetupWithPassphrase:return FO(i,s);case vs.SetupWithRecoveryKey:return LO(i,s);case vs.Pending:return i.p(s.i18n`Waiting to go online`)}}),e.map(r=>r.backupWriteStatus,(r,i,s)=>{switch(r){case Hc.Writing:{const o=i.progress({min:"0",max:"100",value:a=>a.backupPercentage});return i.div(["Backup in progress ",o," ",a=>a.backupInProgressLabel])}case Hc.Stopped:{let o;return s.backupError?o=`Backup has stopped because of an error: ${s.backupError}`:o="Backup has stopped",i.p([o," ",i.button({onClick:()=>s.startBackup()},"Backup now")])}case Hc.Done:return i.p("All keys are backed up.");default:return}}),e.if(r=>r.isMasterKeyTrusted,r=>r.p("Cross-signing master key found and trusted.")),e.if(r=>r.canSignOwnDevice,r=>r.div([r.button({onClick:Bu(async i=>{await t.signOwnDevice()})},"Sign own device"),r.button({onClick:Bu(async()=>{t.navigateToVerification()})},"Verify by emoji")]))])}}function UO(n,e){const t=[n.p([e.i18n`Key backup is enabled, using backup version ${e.backupVersion}. `,n.button({onClick:()=>e.disable()},e.i18n`Disable`)])];return e.dehydratedDeviceId&&t.push(n.p(e.i18n`A dehydrated device id was set up with id ${e.dehydratedDeviceId} which you can use during your next login with your secret storage key.`)),n.div(t)}function $O(n,e){const t=[n.p([e.i18n`A new backup version has been created from another device. Disable key backup and enable it again with the new key.`,n.button({onClick:()=>e.disable()},e.i18n`Disable`)])];return n.div(t)}function LO(n,e){const t=n.button({className:"link",onClick:()=>e.showPhraseSetup()},e.i18n`use a security phrase`);return n.div([n.p(e.i18n`Enter your secret storage security key below to ${e.purpose}, which will enable you to decrypt messages received before you logged into this session. The security key is a code of 12 groups of 4 characters separated by a space that Element created for you when setting up security.`),k0(n),E0(n,e,e.i18n`Security key`,(r,i)=>e.enterSecurityKey(r,i)),n.p([e.i18n`Alternatively, you can `,t,e.i18n` if you have one.`])])}function FO(n,e){const t=n.button({className:"link",onClick:()=>e.showKeySetup()},e.i18n`use your security key`);return n.div([n.p(e.i18n`Enter your secret storage security phrase below to ${e.purpose}, which will enable you to decrypt messages received before you logged into this session. The security phrase is a freeform secret phrase you optionally chose when setting up security in Element. It is different from your password to login, unless you chose to set them to the same value.`),k0(n),E0(n,e,e.i18n`Security phrase`,(r,i)=>e.enterSecurityPhrase(r,i)),n.p([e.i18n`You can also `,t,e.i18n`.`])])}function E0(n,e,t,r){let i;const s=()=>r(o.value,(i==null?void 0:i.checked)||!1),o=n.input({type:"password",disabled:c=>c.isBusy,placeholder:t}),a=[n.p([o,n.button({disabled:c=>c.isBusy,onClick:s},e.decryptAction)])];if(e.offerDehydratedDeviceSetup){i=n.input({type:"checkbox",id:"enable-dehydrated-device"});const c=n.a({href:"https://github.com/uhoreg/matrix-doc/blob/dehydration/proposals/2697-device-dehydration.md",target:"_blank",rel:"noopener"},"more info");a.push(n.p([i,n.label({for:i.id},[e.i18n`Back up my device as well (`,c,")"])]))}return n.div({className:"row"},[n.div({className:"label"},t),n.div({className:"content"},a)])}function k0(n){return n.if(e=>e.error!==void 0,(e,t)=>e.div([e.p({className:"error"},r=>r.i18n`Could not enable key backup: ${r.error}.`),e.p(t.i18n`Try double checking that you did not mix up your security key, security phrase and login password as explained above.`)]))}class BO extends G{render(e,t){return e.div({className:"FeaturesView"},[e.p("Enable experimental features here that are still in development. These are not yet ready for primetime, so expect bugs."),e.ul(t.featureViewModels.map(r=>e.li(e.view(new VO(r)))))])}}class VO extends G{render(e,t){let r=`feature_${t.id}`;return e.div({className:"FeatureView"},[e.input({type:"checkbox",id:r,checked:i=>i.enabled,onChange:i=>t.enableFeature(i.target.checked)}),e.div({class:"FeatureView_container"},[e.h4(e.label({for:r},t.name)),e.p(t.description)])])}}class KO extends G{render(e,t){let r=t.version;t.showUpdateButton&&(r=e.span([t.version,e.button({onClick:()=>t.checkForUpdate()},t.i18n`Check for updates`)]));const i=(a,c,u,l="")=>a.div({className:`row ${l}`},[a.div({className:"label"},c),a.div({className:"content"},u)]),s=[];s.push(e.h3("Session"),i(e,t.i18n`User ID`,t.userId),i(e,t.i18n`Session ID`,t.deviceId,"code"),i(e,t.i18n`Session key`,t.fingerprintKey,"code"),i(e,"",e.button({onClick:()=>t.logout(),disabled:a=>a.isLoggingOut},t.i18n`Log out`))),s.push(e.if(a=>a.accountManagementUrl,a=>{const c=new URL(t.accountManagementUrl);return a.div([a.h3("Account"),a.p([t.i18n`Your account details are managed separately at `,a.code(c.hostname),"."]),a.button({onClick:()=>window.open(t.accountManagementUrl,"_blank")},t.i18n`Manage account`)])})),s.push(e.h3("Key backup & security"),e.view(new S0(t.keyBackupViewModel))),s.push(e.h3("Notifications"),e.map(a=>a.pushNotifications.supported,(a,c)=>{if(a===null)return c.p(t.i18n`Loading`);if(a){const u=d=>d.pushNotifications.enabled?d.i18n`Push notifications are enabled`:d.i18n`Push notifications are disabled`,l=d=>d.pushNotifications.enabled?d.i18n`Disable`:d.i18n`Enable`;return i(c,u,c.button({onClick:()=>t.togglePushNotifications(),disabled:d=>d.pushNotifications.updating},l))}else return c.p(t.i18n`Push notifications are not supported on this browser`)}),e.if(a=>a.pushNotifications.supported&&a.pushNotifications.enabled,a=>a.div([a.p(["If you think push notifications are not being delivered, ",a.button({className:"link",onClick:()=>t.checkPushEnabledOnServer()},"check")," if they got disabled on the server"]),a.map(c=>c.pushNotifications.enabledOnServer,(c,u)=>{if(c===!0)return u.p("Push notifications are still enabled on the server, so everything should be working. Sometimes notifications can get dropped if they can't be delivered within a given time.");if(c===!1)return u.p("Push notifications have been disabled on the server, likely due to a bug. Please re-enable them by clicking Disable and then Enable again above.")}),a.map(c=>c.pushNotifications.serverError,(c,u)=>{if(c)return u.p("Couldn't not check on server: "+c.message)})]))),s.push(e.h3("Preferences"),i(e,t.i18n`Scale down images when sending`,this._imageCompressionRange(e,t)),e.if(a=>a.activeTheme,(a,c)=>i(a,c.i18n`Use the following theme`,this._themeOptions(a,c))));const o=[];return t.canSendLogsToServer&&o.push(e.button({onClick:Bu(()=>t.sendLogsToServer())},`Submit logs to ${t.logsServer}`)),o.push(e.button({onClick:()=>t.exportLogs()},"Download logs")),s.push(e.h3("Experimental features"),e.view(new BO(t.featuresViewModel))),s.push(e.h3("Application"),i(e,t.i18n`Version`,r),i(e,t.i18n`Storage usage`,a=>`${a.storageUsage} / ${a.storageQuota}`),i(e,t.i18n`Debug logs`,o),e.p({className:{hidden:a=>!a.logsFeedbackMessage}},a=>a.logsFeedbackMessage),e.p(["Debug logs contain application usage data including your username, the IDs or aliases of the rooms or groups you have visited, the usernames of other users and the names of files you send. They do not contain messages. For more information, review our ",e.a({href:"https://element.io/privacy",target:"_blank",rel:"noopener"},"privacy policy"),"."]),e.p([])),e.main({className:"Settings middle"},[e.div({className:"middle-header"},[e.a({className:"button-utility close-middle",href:t.closeUrl,title:t.i18n`Close settings`}),e.h2("Settings")]),e.div({className:"SettingsBody"},s)])}_imageCompressionRange(e,t){const i=Math.ceil(t.minSentImageSizeLimit/32)*32,s=(Math.floor(t.maxSentImageSizeLimit/32)+1)*32,o=a=>t.setSentImageSizeLimit(parseInt(a.target.value,10));return[e.input({type:"range",step:32,min:i,max:s,value:a=>a.sentImageSizeLimit||s,onInput:o,onChange:o})," ",e.output(a=>a.sentImageSizeLimit?a.i18n`resize to ${a.sentImageSizeLimit}px`:a.i18n`no resizing`)]}_themeOptions(e,t){const{themeName:r,themeVariant:i}=t.activeTheme,s=[];for(const w of Object.keys(t.themeMapping))s.push(e.option({value:w,selected:w===r},w));const o=e.select({onChange:w=>{const S=w.target.value;if(!("id"in t.themeMapping[S])){const v=l.checked?"dark":p.checked?"light":"default";a(v);return}t.changeThemeOption(S)}},s),a=w=>{const S=o.options[o.selectedIndex].value;t.changeThemeOption(S,w)},c=i==="dark",u=i==="light",l=e.input({type:"radio",name:"radio-chooser",value:"dark",id:"dark",checked:c}),d=e.input({type:"radio",name:"radio-chooser",value:"default",id:"default",checked:!(c||u)}),p=e.input({type:"radio",name:"radio-chooser",value:"light",id:"light",checked:u}),m=e.form({className:{hidden:()=>{const w=o.options[o.selectedIndex].value;return"id"in t.themeMapping[w]}},onChange:w=>a(w.target.value)},[d,e.label({for:"default"},"Match system theme"),l,e.label({for:"dark"},"dark"),p,e.label({for:"light"},"light")]);return e.div({className:"theme-chooser"},[o,m])}}class jO extends G{render(e,t){return e.main({className:"middle"},e.div({className:"CreateRoomView centered-column"},[e.h2("Create room"),e.form({className:"CreateRoomView_detailsForm form",onChange:r=>this.onFormChange(r),onSubmit:r=>this.onSubmit(r)},[e.div({className:"vertical-layout"},[e.button({type:"button",className:"CreateRoomView_selectAvatar",onClick:()=>t.selectAvatar()},e.mapView(r=>r.hasAvatar,r=>r?new Hn(t,64):new ho(void 0,i=>i.div({className:"CreateRoomView_selectAvatarPlaceholder"})))),e.div({className:"stretch form-row text"},[e.label({for:"name"},t.i18n`Room name`),e.input({onInput:r=>t.setName(r.target.value),type:"text",name:"name",id:"name",placeholder:t.i18n`Enter a room name`})])]),e.div({className:"form-row text"},[e.label({for:"topic"},t.i18n`Topic (optional)`),e.textarea({onInput:r=>t.setTopic(r.target.value),name:"topic",id:"topic",placeholder:t.i18n`Topic`})]),e.div({className:"form-group"},[e.div({className:"form-row check"},[e.input({type:"radio",name:"isPublic",id:"isPrivate",value:"false",checked:!t.isPublic}),e.label({for:"isPrivate"},t.i18n`Private room, only upon invitation.`)]),e.div({className:"form-row check"},[e.input({type:"radio",name:"isPublic",id:"isPublic",value:"true",checked:t.isPublic}),e.label({for:"isPublic"},t.i18n`Public room, anyone can join`)])]),e.div({className:{"form-row check":!0,hidden:r=>r.isPublic}},[e.input({type:"checkbox",name:"isEncrypted",id:"isEncrypted",checked:t.isEncrypted}),e.label({for:"isEncrypted"},t.i18n`Enable end-to-end encryption`)]),e.div({className:{"form-row text":!0,hidden:r=>!r.isPublic}},[e.label({for:"roomAlias"},t.i18n`Room alias`),e.input({onInput:r=>t.setRoomAlias(r.target.value),type:"text",name:"roomAlias",id:"roomAlias",placeholder:t.i18n`Room alias (<alias>, or #<alias> or #<alias>:hs.tld`})]),e.div({className:"form-group"},[e.div(e.button({className:"link",type:"button",onClick:()=>t.toggleAdvancedShown()},r=>r.isAdvancedShown?r.i18n`Hide advanced settings`:r.i18n`Show advanced settings`)),e.div({className:{"form-row check":!0,hidden:r=>!r.isAdvancedShown}},[e.input({type:"checkbox",name:"isFederationDisabled",id:"isFederationDisabled",checked:t.isFederationDisabled}),e.label({for:"isFederationDisabled"},[t.i18n`Disable federation`,e.p({className:"form-row-description"},t.i18n`Can't be changed later. This will prevent people on other homeservers from joining the room. This is typically used when only people from your own organisation (if applicable) should be allowed in the room, and is otherwise not needed.`)])])]),e.div({className:"button-row"},[e.button({className:"button-action primary",type:"submit",disabled:r=>!r.canCreate},t.i18n`Create room`)])])]))}onFormChange(e){switch(e.target.name){case"isEncrypted":this.value.setEncrypted(e.target.checked);break;case"isPublic":this.value.setPublic(e.currentTarget.isPublic.value==="true");break;case"isFederationDisabled":this.value.setFederationDisabled(e.target.checked);break}}onSubmit(e){e.preventDefault(),this.value.create()}}class HO extends G{render(e,t){const r=()=>t.isEncrypted?t.i18n`On`:t.i18n`Off`;return e.div({className:"RoomDetailsView"},[e.div({className:"RoomDetailsView_avatar"},[e.view(new Hn(t,52)),e.mapView(i=>i.isEncrypted,i=>new zO(i))]),e.div({className:"RoomDetailsView_name"},[e.h2(i=>i.name)]),this._createRoomAliasDisplay(t),e.div({className:"RoomDetailsView_rows"},[this._createRightPanelButtonRow(e,t.i18n`People`,{MemberCount:!0},i=>i.memberCount,()=>t.openPanel("members")),this._createRightPanelRow(e,t.i18n`Encryption`,{EncryptionStatus:!0},r)])])}_createRoomAliasDisplay(e){return e.canonicalAlias?oe.div({className:"RoomDetailsView_id"},[e.canonicalAlias]):""}_createRightPanelRow(e,t,r,i){const s=uo(lo({RoomDetailsView_label:!0},r));return e.div({className:"RoomDetailsView_row"},[e.div({className:s},[t]),e.div({className:"RoomDetailsView_value"},i)])}_createRightPanelButtonRow(e,t,r,i,s){const o=uo(lo({RoomDetailsView_label:!0},r));return e.button({className:"RoomDetailsView_row",onClick:s},[e.div({className:o},[t]),e.div({className:"RoomDetailsView_value"},i)])}}class zO extends G{render(e,t){return e.div({className:"EncryptionIconView"},[e.div({className:t?"EncryptionIconView_encrypted":"EncryptionIconView_unencrypted"})])}}class GO{constructor(e,t){this.start=e,this.end=t}get length(){return this.end-this.start}contains(e){return e.start>=this.start&&e.end<=this.end}containsIndex(e){return e>=this.start&&e<this.end}toLocalIndex(e){return e-this.start}intersects(e){return e.start<this.end&&this.start<e.end}forEachInIterator(e,t){let r=0;for(r=0;r<this.start;r+=1)e.next();for(r=0;r<this.length;r+=1){const i=e.next();if(i.done)break;t(i.value,this.start+r)}}[Symbol.iterator](){return new qO(this)}reverseIterable(){return new WO(this)}clampIndex(e,t=this.end-1){return Math.min(Math.max(this.start,e),t)}getIndexZone(e){return e<this.start?qi.Before:e<this.end?qi.Inside:qi.After}}var qi=(n=>(n[n.Before=1]="Before",n[n.Inside=2]="Inside",n[n.After=3]="After",n))(qi||{});class qO{constructor(e){this.range=e,this.idx=e.start-1}next(){return this.idx<this.range.end-1?(this.idx+=1,{value:this.idx,done:!1}):{value:void 0,done:!0}}}class WO{constructor(e){this.range=e,this.idx=e.end}[Symbol.iterator](){return this}next(){return this.idx>this.range.start?(this.idx-=1,{value:this.idx,done:!1}):{value:void 0,done:!0}}}function YO(n,e){let t=0;for(;t<e;)if(t+=1,n.next().done)return!1;return!0}function bc(n,e){if(YO(n,e)){const t=n.next();if(!t.done)return t.value}}var ws=(n=>(n[n.Move=0]="Move",n[n.Add=1]="Add",n[n.Remove=2]="Remove",n[n.RemoveAndAdd=3]="RemoveAndAdd",n[n.UpdateRange=4]="UpdateRange",n))(ws||{});class Fa extends GO{constructor(e,t,r,i=t-e){super(e,t),this._totalLength=r,this._viewportItemCount=i}expand(e){if(this.length===0)return this;const t=Math.max(0,this.start-e),r=Math.min(this.totalLength,this.end+e);return new Fa(t,r,this.totalLength,this._viewportItemCount)}get totalLength(){return this._totalLength}get viewportItemCount(){return this._viewportItemCount}static fromViewport(e,t,r,i){const s=Math.min(Math.max(0,Math.floor(i/t)),e),o=e-s,a=r!==0?Math.ceil(r/t):0,c=Math.min(a,o);return new Fa(s,s+c,e,a)}queryAdd(e,t,r){const i=this.viewportItemCount>this.length?this.end:this.end-1;if(e<=i){const s=this.clampIndex(e,i),o=s===e?t:bc(r[Symbol.iterator](),s);return this.createAddResult(s,o)}else return{type:4,newRange:this.deriveRange(1,0)}}queryRemove(e,t){if(e<this.end){const r=this.clampIndex(e);return this.createRemoveResult(r,t)}else return{type:4,newRange:this.deriveRange(-1,0)}}queryMove(e,t,r,i){const s=this.getIndexZone(e),o=this.getIndexZone(t);if(s===o){if(s===qi.Before||s===qi.After)return;if(s===qi.Inside)return{type:0,fromIdx:e,toIdx:t}}else{const a=this.clampIndex(t),c=this.clampIndex(e),u=a===t?r:bc(i[Symbol.iterator](),a);return{type:3,removeIdx:c,addIdx:a,value:u}}}createAddResult(e,t){return this.viewportItemCount>this.length?{type:1,addIdx:e,value:t,newRange:this.deriveRange(1,1)}:{type:3,removeIdx:this.clampIndex(Number.MAX_SAFE_INTEGER),addIdx:e,value:t,newRange:this.deriveRange(1,0)}}createRemoveResult(e,t){if(this.end<this.totalLength){const r=this.clampIndex(Number.MAX_SAFE_INTEGER),i=bc(t[Symbol.iterator](),r);return{type:3,removeIdx:e,value:i,addIdx:r,newRange:this.deriveRange(-1,0)}}else if(this.start!==0){const r=this.deriveRange(-1,0,1),i=r.start,s=bc(t[Symbol.iterator](),i);return{type:3,removeIdx:e,value:s,addIdx:i,newRange:r}}else return{type:2,removeIdx:e,newRange:this.deriveRange(-1,0)}}deriveRange(e,t,r=0){const i=this.start-r,s=this.totalLength+e,o=Math.min(Math.max(i,this.end-r+t),s);return new Fa(i,o,s,this.viewportItemCount)}}class XO extends wi{constructor(e,t){var r=e,{itemHeight:i,overflowItems:s=20}=r,o=RD(r,["itemHeight","overflowItems"]);super(o,t),this.itemHeight=i,this.overflowItems=s}handleEvent(e){e.type==="scroll"?this.handleScroll():super.handleEvent(e)}handleScroll(){const e=this._getVisibleRange();if(e.length!==0&&!this.renderRange.contains(e)){const t=this.renderRange;this.renderRange=e.expand(this.overflowItems),this.renderUpdate(t,this.renderRange)}}async loadList(){if(await new Promise(t=>requestAnimationFrame(t)),await new Promise(t=>requestAnimationFrame(t)),!this._list)return;this._subscription=this._list.subscribe(this);const e=this._getVisibleRange();this.renderRange=e.expand(this.overflowItems),this._childInstances=[],this.reRenderFullRange(this.renderRange)}_getVisibleRange(){const{clientHeight:e,scrollTop:t}=this.root();if(e===0)throw new Error("LazyListView height is 0");return Fa.fromViewport(this._list.length,this.itemHeight,e,t)}reRenderFullRange(e){iO(this._listElement);const t=document.createDocumentFragment(),r=this._list[Symbol.iterator]();this._childInstances.length=0,e.forEachInIterator(r,i=>{const s=this._childCreator(i);this._childInstances.push(s),t.appendChild(pl(s,this._mountArgs))}),this._listElement.appendChild(t),this.adjustPadding(e)}renderUpdate(e,t){if(t.intersects(e)){for(const r of e.reverseIterable())if(!t.containsIndex(r)){const i=r-e.start;this.removeChild(i)}t.forEachInIterator(this._list[Symbol.iterator](),(r,i)=>{if(!e.containsIndex(i)){const s=i-t.start;this.addChild(s,r)}}),this.adjustPadding(t)}else this.reRenderFullRange(t)}adjustPadding(e){const t=e.start*this.itemHeight,r=(e.totalLength-e.end)*this.itemHeight,i=this._listElement.style;i.paddingTop=`${t}px`,i.paddingBottom=`${r}px`}mount(){const e=super.mount();return this.scrollContainer=oe.div({className:"LazyListParent"},e),this.scrollContainer.addEventListener("scroll",this),this.scrollContainer}unmount(){this.root().removeEventListener("scroll",this),this.scrollContainer=void 0,super.unmount()}root(){return this.scrollContainer}get _listElement(){return super.root()}onAdd(e,t){const r=this.renderRange.queryAdd(e,t,this._list);this.applyRemoveAddResult(r)}onRemove(e,t){const r=this.renderRange.queryRemove(e,this._list);this.applyRemoveAddResult(r)}onMove(e,t,r){const i=this.renderRange.queryMove(e,t,r,this._list);i&&(i.type===ws.Move?this.moveChild(this.renderRange.toLocalIndex(i.fromIdx),this.renderRange.toLocalIndex(i.toIdx)):this.applyRemoveAddResult(i))}onUpdate(e,t,r){this.renderRange.containsIndex(e)&&this.updateChild(this.renderRange.toLocalIndex(e),t,r)}applyRemoveAddResult(e){(e.type===ws.Remove||e.type===ws.RemoveAndAdd)&&this.removeChild(this.renderRange.toLocalIndex(e.removeIdx)),e.newRange&&(this.renderRange=e.newRange,this.adjustPadding(this.renderRange)),(e.type===ws.Add||e.type===ws.RemoveAndAdd)&&this.addChild(this.renderRange.toLocalIndex(e.addIdx),e.value)}}class JO extends G{render(e,t){return e.li({className:"MemberTileView"},e.a({href:t.detailsUrl},[e.view(new Hn(t,32)),e.div({className:"MemberTileView_name"},r=>r.name)]))}}class QO extends XO{constructor(e){super({list:e.memberTileViewModels,className:"MemberListView",itemHeight:40},t=>new JO(t))}}class ZO extends G{render(e,t){const r=[e.p(t.isEncrypted?t.i18n`Messages in this room are end-to-end encrypted.`:t.i18n`Messages in this room are not end-to-end encrypted.`)];return t.features.crossSigning&&r.push(e.div({className:"MemberDetailsView_shield_container"},[e.span({className:i=>`MemberDetailsView_shield_${i.trustShieldColor}`}),e.p({className:"MemberDetailsView_shield_description"},i=>i.trustDescription)])),e.div({className:"MemberDetailsView"},[e.view(new Hn(t,128)),e.div({className:"MemberDetailsView_name"},e.h2(i=>i.name)),e.div({className:"MemberDetailsView_id"},t.userId),this._createSection(e,t.i18n`Role`,i=>i.role),this._createSection(e,t.i18n`Security`,r),this._createOptions(e,t)])}_createSection(e,t,r){return e.div({className:"MemberDetailsView_section"},[e.div({className:"MemberDetailsView_label"},t),e.div({className:"MemberDetailsView_value"},r)])}_createOptions(e,t){const r=[e.a({href:t.linkToUser,target:"_blank",rel:"noopener"},t.i18n`Open Link to User`),e.button({className:"text",onClick:()=>t.openDirectMessage()},t.i18n`Open direct message`)];if(t.features.crossSigning){const i=()=>{confirm("You don't want to do this with any account but a test account. This will cross-sign this user without verifying their keys first. You won't be able to undo this apart from resetting your cross-signing keys.")&&t.signUser()};r.push(e.button({className:"text",onClick:i},t.i18n`Cross-sign user (DO NOT USE, TESTING ONLY)`))}return e.div({className:"MemberDetailsView_section"},[e.div({className:"MemberDetailsView_label"},t.i18n`Options`),e.div({className:"MemberDetailsView_options"},r)])}}class eU extends G{render(e){return e.div({className:"RightPanelView"},[e.ifView(t=>t.activeViewModel,t=>new tU(t)),e.mapView(t=>t.activeViewModel,t=>this._viewFromType(t))])}_viewFromType(e){switch(e==null?void 0:e.type){case"room-details":return new HO(e);case"member-list":return new QO(e);case"member-details":return new ZO(e);default:return new g0}}}class tU extends G{render(e,t){return e.div({className:"RightPanelView_buttons"},[e.button({className:{back:!0,"button-utility":!0,hide:!t.activeViewModel.shouldShowBackButton},onClick:()=>t.showPreviousPanel()}),e.button({className:"close button-utility",onClick:()=>t.closePanel()})])}}class nU extends wi{constructor(e){const t={className:"Timeline_messageReactions",tagName:"div",list:e.reactions,onItemClick:r=>r.onClick()};super(t,r=>new rU(r))}}class rU extends G{render(e,t){return e.button({className:{active:r=>r.isActive,pending:r=>r.isPending}},[t.key," ",r=>`${r.count}`])}onClick(){this.value.toggle()}}class No extends G{constructor(e,t,r,i="li"){super(e),this._menuPopup=null,this._tagName=i,this._viewClassForTile=t,this._renderFlags=r}get _interactive(){var e,t;return(t=(e=this._renderFlags)==null?void 0:e.interactive)!=null?t:!0}get _isReplyPreview(){var e;return(e=this._renderFlags)==null?void 0:e.reply}render(e,t){const r=[this.renderMessageBody(e,t)];this._interactive&&r.push(e.button({className:"Timeline_messageOptions"},""));const i=e.el(this._tagName,{className:{Timeline_message:!0,own:t.isOwn,unsent:t.isUnsent,unverified:o=>o.isUnverified,disabled:!this._interactive,continuation:o=>o.isContinuation},"data-event-id":t.eventId},r);e.mapSideEffect(o=>o.isContinuation,(o,a)=>{if(o&&a===!1)i.removeChild(i.querySelector(".Timeline_messageAvatar")),i.removeChild(i.querySelector(".Timeline_messageSender"));else if(!o&&!this._isReplyPreview){const c=oe.a({href:t.memberPanelLink,className:"Timeline_messageAvatar"},[Vi(t,30)]),u=oe.div({className:`Timeline_messageSender usercolor${t.avatarColorNumber}`,title:t.sender},t.displayName);i.insertBefore(c,i.firstChild),i.insertBefore(u,i.firstChild)}});let s=null;return e.mapSideEffect(o=>o.reactions,o=>{o&&this._interactive&&!s?(s=new nU(o),this.addSubView(s),i.appendChild(pl(s))):!o&&s&&(i.removeChild(s.root()),s.unmount(),this.removeSubView(s),s=null)}),i}onClick(e){e.target.className==="Timeline_messageOptions"&&this._toggleMenu(e.target)}_toggleMenu(e){if(this._menuPopup&&this._menuPopup.isOpen)this._menuPopup.close();else{const t=this.createMenuOptions(this.value);if(!t.length)return;this.root().classList.add("menuOpen");const r=()=>this.root().classList.remove("menuOpen");this._menuPopup=new $d(new je(t),r),this._menuPopup.trackInTemplateView(this),this._menuPopup.showRelativeTo(e,2)}}createMenuOptions(e){const t=[];return e.canReact&&e.shape!=="redacted"&&!e.isPending&&(t.push(new iU(e)),t.push(je.option(e.i18n`Reply`,()=>e.startReply()))),e.canAbortSending?t.push(je.option(e.i18n`Cancel`,()=>e.abortSending())):e.canRedact&&t.push(je.option(e.i18n`Delete`,()=>e.redact()).setDestructive()),t.push(je.option(e.i18n`Copy matrix.to permalink`,()=>e.copyPermalink())),t}renderMessageBody(){}}class iU{constructor(e){this._vm=e}toDOM(e){const t=["","","","","","","",""].map(i=>e.button({onClick:()=>this._vm.react(i)},i)),r=e.button({onClick:()=>{const i=prompt("Enter your reaction (emoji)");i&&this._vm.react(i)}},"");return e.li({className:"quick-reactions"},[...t,r])}}class sU extends G{constructor(e,t){super(e),this._viewClassForTile=t}render(e,t){const r=this._viewClassForTile(t);if(!r)throw new Error(`Shape ${t.shape} is unrecognized.`);const i=new r(t,this._viewClassForTile,{reply:!0,interactive:!1});return e.div({className:"ReplyPreviewView"},e.blockquote([e.a({className:"link",href:t.permaLink},"In reply to"),e.a({className:"pill",href:t.senderProfileLink},[Vi(t,12,void 0),t.displayName]),e.br(),e.view(i)]))}}class oU extends G{render(e){return e.blockquote({className:"ReplyPreviewView"},[e.div({className:"Timeline_messageBody statusMessage"},"This reply could not be found.")])}}class aU extends No{renderMessageBody(e,t){const r=e.time({className:{hidden:!t.time}},t.time),i=e.div({className:{Timeline_messageBody:!0,statusMessage:o=>o.shape==="message-status"}},e.mapView(o=>o.replyTile,o=>this._isReplyPreview?null:t.isReply&&!o?new oU:o?new sU(o,this._viewClassForTile):null)),s=o=>(o==null?void 0:o.nodeType)!==Node.COMMENT_NODE&&o.className!=="ReplyPreviewView";return e.mapSideEffect(o=>o.body,o=>{for(;s(i.lastChild);)i.removeChild(i.lastChild);for(const a of o.parts)i.appendChild(I0(a));i.appendChild(r)}),i}}function lU(n){const e=n.items.map(r=>oe.li(Wi(r))),t=n.startOffset;return t?oe.ol({start:t},e):oe.ul(e)}function cU(n){const e={src:n.src};return n.width&&(e.width=n.width),n.height&&(e.height=n.height),n.alt&&(e.alt=n.alt),n.title&&(e.title=n.title),oe.img(e)}function uU(n){const e=`avatar size-12 usercolor${n.avatarColorNumber}`,t=oe.div({class:e},mr(n.avatarInitials)),r=Wi(n.children);return r.unshift(t),oe.a({class:"pill",href:n.href,rel:"noopener",target:"_blank"},r)}function dU(n){const e=[];if(n.head){const r=n.head.map(i=>oe.th(Wi(i)));e.push(oe.thead(oe.tr(r)))}const t=[];for(const r of n.body){const i=r.map(s=>oe.td(Wi(s)));t.push(oe.tr(i))}return e.push(oe.tbody(t)),oe.table(e)}const hU={header:n=>oe["h"+Math.min(6,n.level)](Wi(n.inlines)),codeblock:n=>oe.pre(oe.code(mr(n.text))),table:n=>dU(n),code:n=>oe.code(mr(n.text)),text:n=>mr(n.text),link:n=>oe.a({href:n.url,className:"link",target:"_blank",rel:"noopener"},Wi(n.inlines)),pill:uU,format:n=>oe[n.format](Wi(n.children)),rule:()=>oe.hr(),list:lU,image:cU,newline:()=>oe.br()};function I0(n){const e=hU[n.type];return e?e(n):mr(`[unknown part type ${n.type}]`)}function Wi(n){return Array.from(n,I0)}class T0 extends No{renderMessageBody(e,t){let i=`padding-top: ${t.height/t.width*100}%;`;t.platform.isIE11&&(i=`height: ${t.height}px`);const s=[e.div({className:"spacer",style:i}),this.renderMedia(e,t),e.time(t.time)],o=e.div({className:{status:!0,hidden:a=>!a.status}},a=>a.status);if(s.push(o),t.isPending){const a=e.progress({min:0,max:100,value:c=>c.uploadPercentage,className:{hidden:c=>!c.isUploading}});s.push(a)}return e.div({className:"Timeline_messageBody"},[e.div({className:"media",style:`max-width: ${t.width}px`,"data-testid":"media"},s),e.if(a=>a.error,a=>a.p({className:"error"},t.error))])}createMenuOptions(e){const t=super.createMenuOptions(e);if(!e.isPending){let r;switch(e.shape){case"image":r=e.i18n`Download image`;break;case"video":r=e.i18n`Download video`;break;default:r=e.i18n`Download media`;break}t.push(je.option(r,()=>e.downloadMedia()))}return t}}class fU extends T0{renderMedia(e,t){const r=e.img({src:i=>i.thumbnailUrl,alt:i=>i.label,title:i=>i.label,style:`max-width: ${t.width}px; max-height: ${t.height}px;`});return t.isPending||!t.lightboxUrl?r:e.a({href:t.lightboxUrl},r)}}function Ku(n,e){return new Promise((t,r)=>{let i;const s=a=>{i(),r(a.target.error)},o=()=>{i(),t()};i=()=>{n.removeEventListener(e,o),n.removeEventListener("error",s)},n.addEventListener(e,o),n.addEventListener("error",s)})}async function pU(n){var e;try{if((e=navigator==null?void 0:navigator.clipboard)!=null&&e.writeText)return await navigator.clipboard.writeText(n),!0;{const t=document.createElement("textarea");t.value=n,t.style.top="0",t.style.left="0",t.style.position="fixed",document.body.appendChild(t);const r=document.getSelection();if(!r)return console.error("copyPlaintext: Unable to copy text to clipboard in fallback mode because `selection` was null/undefined"),!1;const i=document.createRange();i.selectNode(t),r.removeAllRanges(),r.addRange(i);const s=document.execCommand("copy");return r.removeAllRanges(),document.body.removeChild(t),s||console.error("copyPlaintext: Unable to copy text to clipboard in fallback mode because the `copy` command is unsupported or disabled"),s}}catch(t){console.error("copyPlaintext: Ran into an error",t)}return!1}class mU extends T0{renderMedia(e){const t=e.video({src:r=>r.videoUrl||`data:${r.mimeType},`,title:r=>r.label,controls:!0,preload:"none",poster:r=>r.thumbnailUrl,onPlay:this._onPlay.bind(this),style:r=>`max-width: ${r.width}px; max-height: ${r.height}px;${r.isPending?"z-index: -1":""}`});return t.addEventListener("error",this._onError.bind(this)),t}async _onPlay(e){const t=this.value;if(!t.videoUrl)try{const r=e.target;await t.loadVideo();const i=Ku(r,"loadeddata");r.load(),await i,r.play()}catch{}}_onError(e){const t=this.value,r=e.target,i=r.error;if(i instanceof window.MediaError&&i.code===4)if(!r.src.startsWith("data:"))t.setViewError(new Error(`this browser does not support videos of type ${t.mimeType}.`));else return;else t.setViewError(i)}}class _U extends No{renderMessageBody(e,t){const r=[];return t.isPending?r.push(i=>i.label):r.push(e.button({className:"link",onClick:()=>t.download()},i=>i.label),e.time(t.time)),e.p({className:"Timeline_messageBody statusMessage"},r)}}class gU extends No{renderMessageBody(e,t){return e.p({className:"Timeline_messageBody statusMessage"},[e.span(t.label),e.a({className:"Timeline_locationLink",href:t.mapsLink,target:"_blank",rel:"noopener"},t.i18n`Open in maps`),e.time(t.time)])}}class yU extends No{renderMessageBody(e,t){return e.p({className:"Timeline_messageBody statusMessage"},t.label)}}class vU extends G{constructor(e){super(e)}render(e,t){return e.li({className:"AnnouncementView","data-event-id":t.eventId},e.div(r=>r.announcement))}onClick(){}}class wU extends No{renderMessageBody(e){return e.p({className:"Timeline_messageBody statusMessage"},t=>t.description)}createMenuOptions(e){const t=super.createMenuOptions(e);return e.isRedacting&&t.push(je.option(e.i18n`Cancel`,()=>e.abortPendingRedaction())),t}}var rt=(n=>(n.Message="message",n.MessageStatus="message-status",n.Announcement="announcement",n.File="file",n.Gap="gap",n.Image="image",n.Location="location",n.MissingAttachment="missing-attachment",n.Redacted="redacted",n.Video="video",n.DateHeader="date-header",n.Call="call",n))(rt||{});class bU extends G{constructor(e){super(e)}render(e,t){const r={GapView:!0,isLoading:i=>i.isLoading,isAtTop:i=>i.isAtTop};return e.li({className:r},[e.div({class:"GapView_container"},[e.if(i=>i.showSpinner,i=>Ot(i)),e.span(i=>i.status)]),e.if(i=>!!i.errorViewModel,i=>i.view(new Do(t.errorViewModel,{inline:!0})))])}onClick(){}}class SU extends G{render(e,t){return e.li({className:"CallTileView AnnouncementView"},e.div([e.if(r=>r.errorViewModel,r=>r.div({className:"CallTileView_error"},r.view(new Do(t.errorViewModel,{inline:!0})))),e.div([e.div({className:"CallTileView_title"},r=>r.title),e.div({className:"CallTileView_subtitle"},[t.typeLabel,"  ",e.span({className:"CallTileView_memberCount"},r=>r.memberCount)]),e.view(new wi({className:"CallTileView_members",tagName:"div",list:t.memberViewModels},r=>new Hn(r,24))),e.div(r=>r.duration),e.div([e.button({className:"CallTileView_join button-action primary",hidden:r=>!r.canJoin},"Join"),e.button({className:"CallTileView_leave button-action primary destructive",hidden:r=>!r.canLeave},"Leave")])])]))}onClick(e){e.target.classList.contains("CallTileView_join")?this.value.join():e.target.classList.contains("CallTileView_leave")&&this.value.leave()}}class EU extends G{constructor(e){super(e)}render(e,t){return e.h2({className:"DateHeader"},e.time({dateTime:t.machineReadableDate},t.relativeDate))}onClick(){}}function Av(n){switch(n.shape){case rt.Gap:return bU;case rt.Announcement:return vU;case rt.Message:case rt.MessageStatus:return aU;case rt.Image:return fU;case rt.Video:return mU;case rt.File:return _U;case rt.Location:return gU;case rt.MissingAttachment:return yU;case rt.Redacted:return wU;case rt.Call:return SU;case rt.DateHeader:return EU;default:throw new Error(`Tiles of shape "${n.shape}" are not supported, check the tileClassForEntry function in the view model`)}}class kU extends G{render(e,t){const r=e.input({type:"text",name:"id",id:"id",placeholder:t.i18n`Enter a room id or alias`,disabled:i=>i.joinInProgress});return e.main({className:"middle"},e.div({className:"JoinRoomView centered-column"},[e.h2("Join room"),e.form({className:"JoinRoomView_detailsForm form",onSubmit:i=>this.onSubmit(i,r.value)},[e.div({className:"vertical-layout"},[e.div({className:"stretch form-row text"},[e.label({for:"id"},t.i18n`Room id`),r])]),e.div({className:"button-row"},[e.button({className:"button-action primary",type:"submit",disabled:i=>i.joinInProgress},t.i18n`Join`)]),e.map(i=>i.status,(i,s)=>s.div({className:"JoinRoomView_status"},[Ot(s,{hidden:o=>!o.joinInProgress}),s.span(i)]))])]))}onSubmit(e,t){e.preventDefault(),this.value.join(t)}}class IU extends G{render(e,t){return e.div({className:"WaitingForOtherUserView"},[e.div({className:"WaitingForOtherUserView__heading"},[Ot(e),e.h2({className:"WaitingForOtherUserView__title"},t.i18n`Waiting for any of your device to accept the verification request`)]),e.p({className:"WaitingForOtherUserView__description"},t.i18n`Accept the request from the device you wish to verify!`),e.div({className:"WaitingForOtherUserView__actions"},e.button({className:{"button-action":!0,primary:!0,destructive:!0},onclick:()=>t.cancel()},"Cancel"))])}}class TU extends G{render(e,t){const r=t.isCancelledByUs?"You":"The other device";return e.div({className:"VerificationCancelledView"},[e.h2({className:"VerificationCancelledView__title"},t.i18n`${r} cancelled the verification!`),e.p({className:"VerificationCancelledView__description"},t.i18n`${this.getDescriptionFromCancellationCode(t.cancelCode,t.isCancelledByUs)}`),e.div({className:"VerificationCancelledView__actions"},[e.button({className:{"button-action":!0,primary:!0},onclick:()=>t.gotoSettings()},"Got it")])])}getDescriptionFromCancellationCode(e,t){var r;const i={[te.InvalidMessage]:"You other device sent an invalid message.",[te.KeyMismatch]:"The key could not be verified.",[te.TimedOut]:"The verification process timed out.",[te.UnexpectedMessage]:"Your other device sent an unexpected message.",[te.UnknownMethod]:"Your other device is using an unknown method for verification.",[te.UnknownTransaction]:"Your other device sent a message with an unknown transaction id.",[te.UserMismatch]:"The expected user did not match the user verified.",[te.MismatchedCommitment]:"The hash commitment does not match.",[te.MismatchedSAS]:"The emoji/decimal did not match."},s={[te.UserCancelled]:"Your other device cancelled the verification!",[te.InvalidMessage]:"Invalid message sent to the other device.",[te.KeyMismatch]:"The other device could not verify our keys",[te.TimedOut]:"The verification process timed out.",[te.UnexpectedMessage]:"Unexpected message sent to the other device.",[te.UnknownMethod]:"Your other device does not understand the method you chose",[te.UnknownTransaction]:"Your other device rejected our message.",[te.UserMismatch]:"The expected user did not match the user verified.",[te.MismatchedCommitment]:"Your other device was not able to verify the hash commitment",[te.MismatchedSAS]:"The emoji/decimal did not match."};return(r=(t?i:s)[e])!=null?r:""}}class RU extends G{render(e){return e.div({className:"SelectMethodView"},[e.map(t=>t.hasProceeded,(t,r,i)=>t?Ot(r):r.div([r.div({className:"SelectMethodView__heading"},[r.h2({className:"SelectMethodView__title"},i.i18n`Verify device '${i.deviceName}' by comparing emojis?`)]),r.p({className:"SelectMethodView__description"},i.i18n`You are about to verify your other device by comparing emojis.`),r.div({className:"SelectMethodView__actions"},[r.button({className:{"button-action":!0,primary:!0,destructive:!0},onclick:()=>i.cancel()},"Cancel"),r.button({className:{"button-action":!0,primary:!0},onclick:()=>i.proceed()},"Proceed")])]))])}}class CU extends G{render(e,t){const r=t.emojis.reduce((s,[o,a])=>{const c=e.div({className:"EmojiContainer"},[e.div({className:"EmojiContainer__emoji"},o),e.div({className:"EmojiContainer__name"},a)]);return s.push(c),s},[]),i=e.div({className:"EmojiCollection"},r);return e.div({className:"VerifyEmojisView"},[e.div({className:"VerifyEmojisView__heading"},[e.h2({className:"VerifyEmojisView__title"},t.i18n`Do the emojis match?`)]),e.p({className:"VerifyEmojisView__description"},t.i18n`Confirm the emoji below are displayed on both devices, in the same order:`),e.div({className:"VerifyEmojisView__emojis"},i),e.map(s=>s.isWaiting,(s,o,a)=>s?o.div({className:"VerifyEmojisView__waiting"},[Ot(o),o.span(a.i18n`Waiting for you to verify on your other device`)]):o.div({className:"VerifyEmojisView__actions"},[o.button({className:{"button-action":!0,primary:!0,destructive:!0},onclick:()=>a.setEmojiMatch(!1)},a.i18n`They don't match`),o.button({className:{"button-action":!0,primary:!0},onclick:()=>a.setEmojiMatch(!0)},a.i18n`They match`)]))])}}class MU extends G{render(e,t){return e.div({className:"VerificationCompleteView"},[e.div({className:"VerificationCompleteView__icon"}),e.div({className:"VerificationCompleteView__heading"},[e.h2({className:"VerificationCompleteView__title"},t.i18n`Verification completed successfully!`)]),e.p({className:"VerificationCompleteView__description"},t.i18n`You successfully verified device ${t.otherDeviceId}`),e.div({className:"VerificationCompleteView__actions"},[e.button({className:{"button-action":!0,primary:!0},onclick:()=>t.gotoSettings()},"Got it")])])}}class xU extends G{render(e){return e.div({className:{middle:!0,DeviceVerificationView:!0}},[e.mapView(t=>t.currentStageViewModel,t=>{switch(t==null?void 0:t.kind){case"waiting-for-user":return new IU(t);case"verification-cancelled":return new TU(t);case"select-method":return new RU(t);case"verify-emojis":return new CU(t);case"verification-completed":return new MU(t);default:return null}})])}}class AU extends G{render(e,t){return e.div({className:"CallToastNotificationView"},[e.div({className:"CallToastNotificationView__top"},[e.view(new Hn(t,24)),e.span({className:"CallToastNotificationView__name"},r=>r.roomName),e.button({className:"button-action CallToastNotificationView__dismiss-btn",onClick:()=>t.dismiss()})]),e.div({className:"CallToastNotificationView__description"},[e.span(t.i18n`Video call started`)]),e.div({className:"CallToastNotificationView__info"},[e.span({className:"CallToastNotificationView__call-type"},t.i18n`Video`),e.span({className:"CallToastNotificationView__member-count"},r=>r.memberCount)]),e.div({className:"CallToastNotificationView__action"},[e.button({className:"button-action primary",onClick:()=>t.join()},t.i18n`Join`)]),e.if(r=>!!r.errorViewModel,r=>r.div({className:"CallView_error"},r.view(new Do(t.errorViewModel))))])}}class DU extends G{render(e,t){return e.div({className:"VerificationToastNotificationView"},[e.div({className:"VerificationToastNotificationView__top"},[e.span({className:"VerificationToastNotificationView__title"},t.i18n`Device Verification`),e.button({className:"button-action VerificationToastNotificationView__dismiss-btn",onClick:()=>t.dismiss()})]),e.div({className:"VerificationToastNotificationView__description"},[e.span(t.i18n`Do you want to verify device ${t.otherDeviceId}?`)]),e.div({className:"VerificationToastNotificationView__action"},[e.button({className:"button-action primary destructive",onClick:()=>t.dismiss()},t.i18n`Ignore`),e.button({className:"button-action primary",onClick:()=>t.accept()},t.i18n`Accept`)])])}}function NU(n){switch(n.kind){case"calls":return new AU(n);case"verification":return new DU(n);default:throw new Error(`Cannot find view class for notification kind ${n.kind}`)}}class PU extends G{render(e,t){return e.div({className:"ToastCollectionView"},[e.ifView(r=>!!r.toastViewModels,r=>new wi({list:t.toastViewModels,parentProvidesUpdates:!1},i=>NU(i)))])}}let OU=class extends G{render(e,t){return e.div({className:{SessionView:!0,"middle-shown":r=>!!r.activeMiddleViewModel,"right-shown":r=>!!r.rightPanelViewModel}},[e.view(new PU(t.toastCollectionViewModel)),e.view(new kO(t.sessionStatusViewModel)),e.view(new dO(t.leftPanelViewModel)),e.mapView(r=>r.activeMiddleViewModel,()=>t.roomGridViewModel?new IO(t.roomGridViewModel,Av):t.settingsViewModel?new KO(t.settingsViewModel):t.createRoomViewModel?new jO(t.createRoomViewModel):t.joinRoomViewModel?new kU(t.joinRoomViewModel):t.verificationViewModel?new xU(t.verificationViewModel):t.currentRoomViewModel?t.currentRoomViewModel.kind==="invite"?new v0(t.currentRoomViewModel):t.currentRoomViewModel.kind==="room"?new _0(t.currentRoomViewModel,Av):t.currentRoomViewModel.kind==="roomBeingCreated"?new y0(t.currentRoomViewModel):new vO(t.currentRoomViewModel):new ho(r=>r.div({className:"room-placeholder"},r.h2(t.i18n`Choose a room on the left side.`)))),e.mapView(r=>r.lightboxViewModel,r=>r?new bO(r):null),e.mapView(r=>r.rightPanelViewModel,r=>r?new eU(r):null)])}};function R0(n){return n.a({target:"_blank",href:"https://github.com/vector-im/hydrogen-web"},"Hydrogen on Github")}class UU extends G{render(e,t){const r=o=>!!o.isBusy,i=e.input({id:"username",type:"text",placeholder:t.i18n`Username`,disabled:r}),s=e.input({id:"password",type:"password",placeholder:t.i18n`Password`,disabled:r});return e.div({className:"PasswordLoginView form"},[e.if(o=>o.error,o=>o.div({className:"error"},a=>a.error)),e.form({onSubmit:o=>{o.preventDefault(),t.login(i.value,s.value)}},[e.if(o=>o.errorMessage,(o,a)=>o.p({className:"error"},a.i18n(a.errorMessage))),e.div({className:"form-row text"},[e.label({for:"username"},t.i18n`Username`),i]),e.div({className:"form-row text"},[e.label({for:"password"},t.i18n`Password`),s]),e.div({className:"button-row"},[e.button({className:"button-action primary",type:"submit",disabled:r},t.i18n`Log In`)])])])}}class $U extends G{render(e,t){return e.div({className:"Settings"},[e.h3(t.i18n`Restore your encrypted history?`),e.ifView(r=>r.decryptDehydratedDeviceViewModel,r=>new S0(r.decryptDehydratedDeviceViewModel)),e.map(r=>r.deviceDecrypted,(r,i)=>r?i.p(t.i18n`That worked out, you're good to go!`):i.p(t.i18n`This will claim the dehydrated device ${t.dehydratedDeviceId}, and will set up a new one.`)),e.div({className:"button-row"},[e.button({className:"button-action primary",onClick:()=>{t.finish()},type:"button"},r=>r.deviceDecrypted?r.i18n`Continue`:r.i18n`Continue without restoring`)])])}}class Ld extends G{render(e){const t=e.if(i=>i.hasError,(i,s)=>i.button({onClick:()=>s.exportLogs()},s.i18n`Export logs`)),r=e.if(i=>i.hasError,(i,s)=>i.button({onClick:()=>s.logout()},s.i18n`Log out`));return e.div({className:"SessionLoadStatusView"},[e.p({className:"status"},[Ot(e,{hidden:i=>!i.loading}),e.p(i=>i.loadLabel),t,r]),e.ifView(i=>i.accountSetupViewModel,i=>new $U(i.accountSetupViewModel))])}}class LU extends G{render(e){return e.div({className:"CompleteSSOView"},[e.p({className:"CompleteSSOView_title"},"Finishing up your SSO Login"),e.if(t=>t.errorMessage,(t,r)=>t.p({className:"error"},r.i18n(r.errorMessage))),e.mapView(t=>t.loadViewModel,t=>t?new Ld(t):null)])}}let FU=class extends G{render(e,t){const r=i=>i.isBusy;return e.div({className:"PreSessionScreen"},[e.button({className:"button-utility LoginView_back",onClick:()=>t.goBack(),disabled:r}),e.div({className:"logo"}),e.h1([t.i18n`Sign In`]),e.mapView(i=>i.completeSSOLoginViewModel,i=>i?new LU(i):null),e.if(i=>i.showHomeserver,(i,s)=>i.div({className:"LoginView_sso form-row text"},[i.label({for:"homeserver"},s.i18n`Homeserver`),i.input({id:"homeserver",type:"text",placeholder:s.i18n`Your matrix homeserver`,value:s.homeserver,disabled:r,onInput:o=>s.setHomeserver(o.target.value),onChange:()=>s.queryHomeserver()}),i.p({className:{LoginView_forwardInfo:!0,hidden:o=>!o.resolvedHomeserver}},o=>o.i18n`You will connect to ${o.resolvedHomeserver}.`),i.if(o=>o.errorMessage,(o,a)=>o.p({className:"error"},a.i18n(a.errorMessage)))])),e.if(i=>i.isFetchingLoginOptions,i=>i.div({className:"LoginView_query-spinner"},[Ot(i),i.p("Fetching available login options...")])),e.mapView(i=>i.passwordLoginViewModel,i=>i?new UU(i):null),e.if(i=>i.passwordLoginViewModel&&i.startSSOLoginViewModel,i=>i.p({className:"LoginView_separator"},t.i18n`or`)),e.mapView(i=>i.startSSOLoginViewModel,i=>i?new BU(i):null),e.mapView(i=>i.startOIDCLoginViewModel,i=>i?new VU(i):null),e.if(i=>i.startOIDCLoginViewModel&&i.startOIDCGuestLoginViewModel,i=>i.p({className:"LoginView_separator"},t.i18n`or`)),e.mapView(i=>i.startOIDCGuestLoginViewModel,i=>i?new KU(i):null),e.mapView(i=>i.loadViewModel,i=>i?new Ld(i):null),e.p(R0(e))])}};class BU extends G{render(e,t){return e.div({className:"StartSSOLoginView"},e.button({className:"StartSSOLoginView_button button-action secondary",type:"button",onClick:()=>t.startSSOLogin(),disabled:r=>r.isBusy},t.i18n`Log in with SSO`))}}class VU extends G{render(e,t){return e.div({className:"StartOIDCLoginView"},e.a({className:"StartOIDCLoginView_button button-action primary",type:"button",onClick:()=>t.startOIDCLogin(),disabled:r=>r.isBusy},t.i18n`Continue`))}}class KU extends G{render(e,t){return e.div({className:"StartOIDCGuestLoginView"},e.a({className:"StartOIDCGuestLoginView_button button-action primary",type:"button",onClick:()=>t.startOIDCLogin(),disabled:r=>r.isBusy},t.i18n`Continue as Guest`))}}class jU extends G{render(e,t){const r=new Vu(t,s=>s.div([s.p("Are you sure you want to log out?"),s.div({className:"button-row"},[s.a({className:"button-action",type:"submit",href:t.cancelUrl},["Cancel"]),s.button({className:"button-action primary destructive",type:"submit",onClick:()=>t.logout()},t.i18n`Log out`)])])),i=new Vu(t,s=>s.p({className:"status",hidden:o=>!o.showStatus},[Ot(s,{hidden:o=>!o.busy}),s.span(o=>o.status)]));return e.div({className:"LogoutScreen"},[e.div({className:"content"},[e.mapView(s=>s.showConfirm,s=>s?r:i)])])}}class HU extends G{render(e){return e.div({className:"LogoutScreen"},[e.div({className:"content"},e.map(t=>t.showStatus,(t,r,i)=>t?r.p({className:"status"},[Ot(r,{hidden:s=>!s.showSpinner}),r.span(s=>s.status)]):r.div([r.p("Your access token is no longer valid! You can reauthenticate in the next screen."),r.div({className:"button-row"},[r.button({className:"button-action primary",type:"submit",onClick:()=>i.proceed()},i.i18n`Proceed`)])])))])}}class zU extends G{render(e,t){return e.div({className:"PreSessionScreen"},[e.div({className:"logo"}),e.div({className:"SessionLoadView"},[e.view(new Ld(t))]),e.div({className:{"button-row":!0,hidden:r=>r.loading}},e.a({className:"button-action primary",href:t.backUrl},t.i18n`Go back`))])}}class GU extends G{_onDeleteClick(){confirm("Are you sure?")&&this.value.delete()}_onClearClick(){confirm("Are you sure?")&&this.value.clear()}render(e,t){return e.li([e.a({className:"session-info",href:t.openUrl},[e.div({className:`avatar usercolor${t.avatarColorNumber}`},r=>r.avatarInitials),e.div({className:"user-id"},r=>r.label)])])}}class qU extends G{render(e,t){const r=new wi({list:t.sessions,parentProvidesUpdates:!1},i=>new GU(i));return e.div({className:"PreSessionScreen"},[e.div({className:"logo"}),e.div({className:"SessionPickerView"},[e.h1(["Continue as "]),e.view(r),e.div({className:"button-row"},[e.a({className:"button-action primary",href:t.cancelUrl},t.i18n`Sign In`)]),e.ifView(i=>i.loadViewModel,()=>new Ld(t.loadViewModel)),e.p(R0(e))])])}}class WU extends G{render(e,t){return e.mapView(r=>r.activeSection,r=>{switch(r){case"error":return new ho(i=>i.div({className:"StatusView"},[i.h1("Something went wrong"),i.p(t.errorText)]));case"session":return new OU(t.sessionViewModel);case"login":return new FU(t.loginViewModel);case"logout":return new jU(t.logoutViewModel);case"forced-logout":return new HU(t.forcedLogoutViewModel);case"picker":return new qU(t.sessionPickerViewModel);case"redirecting":return new ho(i=>i.p("Redirecting..."));case"loading":return new zU(t.sessionLoadViewModel);default:throw new Error(`Unknown section: ${t.activeSection}`)}})}}class YU{constructor(e){this._reject=null,this._handle=null,this._promise=new Promise((t,r)=>{this._reject=r,this._handle=setTimeout(()=>{this._reject=null,t()},e)})}elapsed(){return this._promise}abort(){this._reject&&(this._reject(new ln),clearTimeout(this._handle),this._handle=null,this._reject=null)}dispose(){this.abort()}}class XU{constructor(e,t){this._handle=setInterval(t,e)}dispose(){this._handle&&(clearInterval(this._handle),this._handle=null)}}class JU{constructor(){this._start=window.performance.now()}measure(){return window.performance.now()-this._start}}class QU{createMeasure(){return new JU}createTimeout(e){return new YU(e)}createInterval(e,t){return new XU(t,e)}now(){return Date.now()}}class ZU{constructor(){this._waitingForReply=new Map,this._messageIdCounter=0,this._navigation=null,this._registration=null,this._registrationPromise=null,this._currentController=null,this.haltRequests=!1}setNavigation(e){this._navigation=e}registerAndStart(e){this._registrationPromise=(async()=>{navigator.serviceWorker.addEventListener("message",this),navigator.serviceWorker.addEventListener("controllerchange",this),this._registration=await navigator.serviceWorker.register(e),await navigator.serviceWorker.ready,this._currentController=navigator.serviceWorker.controller,this._registration.addEventListener("updatefound",this),this._registrationPromise=null,this._registration.waiting&&this._registration.active&&this._proposeUpdate(),console.log("Service Worker registered")})()}_onMessage(e){const{data:t}=e,r=t.replyTo;if(r){const i=this._waitingForReply.get(r);i&&(this._waitingForReply.delete(r),i(t.payload))}if(t.type==="hasSessionOpen"){const i=this._navigation.observe("session").get()===t.payload.sessionId;e.source.postMessage({replyTo:t.id,payload:i})}else if(t.type==="hasRoomOpen"){const i=this._navigation.observe("session").get()===t.payload.sessionId,s=this._navigation.observe("room").get()===t.payload.roomId;e.source.postMessage({replyTo:t.id,payload:i&&s})}else if(t.type==="closeSession"){const{sessionId:i}=t.payload;this._closeSessionIfNeeded(i).finally(()=>{e.source.postMessage({replyTo:t.id})})}else t.type==="haltRequests"?(this.haltRequests=!0,e.source.postMessage({replyTo:t.id})):t.type==="openRoom"&&this._navigation.push("room",t.payload.roomId)}_closeSessionIfNeeded(e){var t;const r=(t=this._navigation)==null?void 0:t.path.get("session");return e&&(r==null?void 0:r.value)===e?new Promise(i=>{const s=this._navigation.pathObservable.subscribe(o=>{const a=o.get("session");(!a||a.value!==e)&&(s(),i())});this._navigation.push("session")}):Promise.resolve()}async _proposeUpdate(){if(document.hidden)return;const e=await this._sendAndWaitForReply("version",null,this._registration.waiting);confirm(`Version ${e.version} (${e.buildHash}) is available. Reload to apply?`)&&(await this._sendAndWaitForReply("haltRequests"),this._send("skipWaiting",null,this._registration.waiting))}handleEvent(e){switch(e.type){case"message":this._onMessage(e);break;case"updatefound":this._registration.installing.addEventListener("statechange",this);break;case"statechange":{e.target.state==="installed"&&(this._proposeUpdate(),e.target.removeEventListener("statechange",this));break}case"controllerchange":this._currentController?document.location.reload():this._currentController=navigator.serviceWorker.controller;break}}async _send(e,t,r=void 0){this._registrationPromise&&await this._registrationPromise,r||(r=this._registration.active),r.postMessage({type:e,payload:t})}async _sendAndWaitForReply(e,t,r=void 0){this._registrationPromise&&await this._registrationPromise,r||(r=this._registration.active),this._messageIdCounter+=1;const i=this._messageIdCounter,s=new Promise(o=>{this._waitingForReply.set(i,o)});return r.postMessage({type:e,id:i,payload:t}),await s}async checkForUpdate(){this._registrationPromise&&await this._registrationPromise,this._registration.update()}get version(){return"0.3.8"}get buildHash(){return null}async preventConcurrentSessionAccess(e){return this._sendAndWaitForReply("closeSession",{sessionId:e})}async getRegistration(){return this._registrationPromise&&await this._registrationPromise,this._registration}}class e${constructor(e,t){this._serviceWorkerHandler=e,this._pushConfig=t}async enablePush(e,t){var r;const i=await((r=this._serviceWorkerHandler)==null?void 0:r.getRegistration());if(i!=null&&i.pushManager){const o=(await i.pushManager.subscribe({userVisibleOnly:!0,applicationServerKey:this._pushConfig.applicationServerKey})).toJSON(),a=o.keys.p256dh,c={endpoint:o.endpoint,auth:o.keys.auth,events_only:!0,default_payload:t};return e.httpPusher(this._pushConfig.gatewayUrl,this._pushConfig.appId,a,c)}}async disablePush(){var e;const t=await((e=this._serviceWorkerHandler)==null?void 0:e.getRegistration());if(t!=null&&t.pushManager){const r=await t.pushManager.getSubscription();r&&await r.unsubscribe()}}async isPushEnabled(){var e;const t=await((e=this._serviceWorkerHandler)==null?void 0:e.getRegistration());return t!=null&&t.pushManager?!!await t.pushManager.getSubscription():!1}async supportsPush(){var e;if(!this._pushConfig)return!1;const t=await((e=this._serviceWorkerHandler)==null?void 0:e.getRegistration());return t&&"pushManager"in t}async enableNotifications(){return"Notification"in window?await Notification.requestPermission()==="granted":!1}async supportsNotifications(){return"Notification"in window}async areNotificationsEnabled(){return"Notification"in window?Notification.permission==="granted":!1}async showNotification(e,t=void 0){var r;if("Notification"in window){new Notification(e,{body:t});return}const i=await((r=this._serviceWorkerHandler)==null?void 0:r.getRegistration());i==null||i.showNotification(e,{body:t})}}class t$ extends vi{constructor(){super(),this._lastSessionHash=void 0}handleEvent(e){e.type==="hashchange"&&(this.emit(this.get()),this._storeHash(this.get()))}get(){return document.location.search.includes("loginToken")?document.location.search:document.location.hash}replaceUrlSilently(e){window.history.replaceState(null,null,e),this._storeHash(e)}pushUrlSilently(e){window.history.pushState(null,null,e),this._storeHash(e)}pushUrl(e){document.location.hash=e}urlAsPath(e){return e.startsWith("#")?e.substr(1):e}pathAsUrl(e){return`#${e}`}onSubscribeFirst(){var e;this._lastSessionHash=(e=window.localStorage)==null?void 0:e.getItem("hydrogen_last_url_hash"),window.addEventListener("hashchange",this)}onUnsubscribeLast(){window.removeEventListener("hashchange",this)}_storeHash(e){var t;(t=window.localStorage)==null||t.setItem("hydrogen_last_url_hash",e)}getLastSessionUrl(){return this._lastSessionHash}}class n$ extends vi{constructor(){super(),this._onOffline=this._onOffline.bind(this),this._onOnline=this._onOnline.bind(this)}_onOffline(){this.emit(!1)}_onOnline(){this.emit(!0)}get(){return navigator.onLine}onSubscribeFirst(){window.addEventListener("offline",this._onOffline),window.addEventListener("online",this._onOnline)}onUnsubscribeLast(){window.removeEventListener("offline",this._onOffline),window.removeEventListener("online",this._onOnline)}}function St(n,e){return n instanceof Promise?n:new Promise((t,r)=>{n.oncomplete=i=>t(i.target.result),n.onerror=()=>r(new Error("Crypto error on "+e))})}class r${constructor(e){this._subtleCrypto=e}async verify(e,t,r,i){const s={name:"HMAC",hash:{name:Yi(i)}},o=await St(this._subtleCrypto.importKey("raw",e,s,!1,["verify"]),"importKey");return await St(this._subtleCrypto.verify(s,o,t,r),"verify")}async compute(e,t,r){const i={name:"HMAC",hash:{name:Yi(r)}},s=await St(this._subtleCrypto.importKey("raw",e,i,!1,["sign"]),"importKey"),o=await St(this._subtleCrypto.sign(i,s,t),"sign");return new Uint8Array(o)}}class i${constructor(e,t,r){this._subtleCrypto=e,this._crypto=t,this._cryptoExtras=r}async pbkdf2(e,t,r,i,s){if(!this._subtleCrypto.deriveBits)throw new Error("PBKDF2 is not supported");const o=await St(this._subtleCrypto.importKey("raw",e,{name:"PBKDF2"},!1,["deriveBits"]),"importKey"),a=await St(this._subtleCrypto.deriveBits({name:"PBKDF2",salt:r,iterations:t,hash:Yi(i)},o,s),"deriveBits");return new Uint8Array(a)}async hkdf(e,t,r,i,s){if(!this._subtleCrypto.deriveBits)return this._cryptoExtras.hkdf(this._crypto,e,t,r,i,s);const o=await St(this._subtleCrypto.importKey("raw",e,{name:"HKDF"},!1,["deriveBits"]),"importKey"),a=await St(this._subtleCrypto.deriveBits({name:"HKDF",salt:t,info:r,hash:Yi(i)},o,s),"deriveBits");return new Uint8Array(a)}}class s${constructor(e,t){this._subtleCrypto=e,this._crypto=t}async decryptCTR({key:e,jwkKey:t,iv:r,data:i,counterLength:s=64}){const o={name:"AES-CTR",counter:r,length:s};let a;try{const c=e||t,u=t?"jwk":"raw";a=await St(this._subtleCrypto.importKey(u,c,o,!1,["decrypt"]),"importKey")}catch(c){throw new Error(`Could not import key for AES-CTR decryption: ${c.message}`)}try{const c=await St(this._subtleCrypto.decrypt(o,a,i),"decrypt");return new Uint8Array(c)}catch(c){throw new Error(`Could not decrypt with AES-CTR: ${c.message}`)}}async encryptCTR({key:e,jwkKey:t,iv:r,data:i}){const s={name:"AES-CTR",counter:r,length:64};let o;const a=e||t,c=t?"jwk":"raw";try{o=await St(this._subtleCrypto.importKey(c,a,s,!1,["encrypt"]),"importKey")}catch(u){throw new Error(`Could not import key for AES-CTR encryption: ${u.message}`)}try{const u=await St(this._subtleCrypto.encrypt(s,o,i),"encrypt");return new Uint8Array(u)}catch(u){throw new Error(`Could not encrypt with AES-CTR: ${u.message}`)}}async generateKey(e,t=256){const r=await St(this._subtleCrypto.generateKey({name:"AES-CTR",length:t},!0,["encrypt","decrypt"]));return St(this._subtleCrypto.exportKey(e,r))}async generateIV(){return C0(this._crypto)}}function C0(n){const e=n.getRandomValues(new Uint8Array(8)),t=new Uint8Array(16);for(let r=0;r<e.length;r+=1)t[r]=e[r];return t}function Dv(n){if(n.alg!=="A256CTR")throw new Error(`Unknown algorithm: ${n.alg}`);if(!n.key_ops.includes("decrypt"))throw new Error("decrypt missing from key_ops");if(n.kty!=="oct")throw new Error(`Invalid key type, "oct" expected: ${n.kty}`);const t=n.k.replace(/-/g,"+").replace(/_/g,"/");return zi.decode(t)}function o$(n){const e=zi.encode(n),t=e.indexOf("=");return t!==-1?e.substr(0,t):e}function a$(n){return o$(n).replace(/\+/g,"-").replace(/\//g,"_")}function l$(n){return{alg:"A256CTR",ext:!0,k:a$(n),key_ops:["encrypt","decrypt"],kty:"oct"}}class c${constructor(e,t){this._aesjs=e,this._crypto=t}async decryptCTR({key:e,jwkKey:t,iv:r,data:i,counterLength:s=64}){if(s!==64)throw new Error(`Unsupported counter length: ${s}`);t&&(e=Dv(t));const o=this._aesjs;var a=new o.ModeOfOperation.ctr(new Uint8Array(e),new o.Counter(new Uint8Array(r)));return a.decrypt(new Uint8Array(i))}async encryptCTR({key:e,jwkKey:t,iv:r,data:i}){t&&(e=Dv(t));const s=this._aesjs;var o=new s.ModeOfOperation.ctr(new Uint8Array(e),new s.Counter(new Uint8Array(r)));return o.encrypt(new Uint8Array(i))}async generateKey(e,t=256){let r=crypto.getRandomValues(new Uint8Array(t/8));return e==="jwk"&&(r=l$(r)),r}async generateIV(){return C0(this._crypto)}}function Yi(n){if(n!=="SHA-256"&&n!=="SHA-512")throw new Error(`Invalid hash name: ${n}`);return n}class u${constructor(e){const t=window.crypto||window.msCrypto,r=t.subtle||t.webkitSubtle;this._subtleCrypto=r,!r.deriveBits&&(e!=null&&e.aesjs)?this.aes=new c$(e.aesjs,t):this.aes=new s$(r,t),this.hmac=new r$(r),this.derive=new i$(r,this,e)}async digest(e,t){return await St(this._subtleCrypto.digest(Yi(e),t))}digestSize(e){switch(Yi(e)){case"SHA-512":return 64;case"SHA-256":return 32;default:throw new Error(`Not implemented for ${Yi(e)}`)}}}async function d$(){var n;if((n=navigator==null?void 0:navigator.storage)!=null&&n.estimate){const{quota:e,usage:t}=await navigator.storage.estimate();return{quota:e,usage:t}}else return{quota:null,usage:null}}class h${constructor(e){this.worker=e,this.busy=!1}attach(e){this.worker.addEventListener("message",e),this.worker.addEventListener("error",e)}detach(e){this.worker.removeEventListener("message",e),this.worker.removeEventListener("error",e)}}class f${constructor(e,t){this._promise=new Promise((r,i)=>{this._resolve=r,this._reject=i}),this._message=e,this._pool=t,this._worker=null}abort(){this._isNotDisposed&&(this._pool._abortRequest(this),this._dispose())}response(){return this._promise}_dispose(){this._reject=null,this._resolve=null}get _isNotDisposed(){return this._resolve&&this._reject}}class p${constructor(e,t){this._workers=[];for(let r=0;r<t;++r){const i=new h$(new Worker(e));i.attach(this),this._workers[r]=i}this._requests=new Map,this._counter=0,this._pendingFlag=!1,this._init=null}init(){const e=new Promise((t,r)=>{this._init={resolve:t,reject:r}});return this.sendAll({type:"ping"}).then(this._init.resolve,this._init.reject).finally(()=>{this._init=null}),e}handleEvent(e){if(e.type==="message"){const t=e.data,r=this._requests.get(t.replyToId);if(r){if(r._worker.busy=!1,r._isNotDisposed){if(t.type==="success")r._resolve(t.payload);else if(t.type==="error"){const i=new Error(t.message);i.stack=t.stack,r._reject(i)}r._dispose()}this._requests.delete(t.replyToId)}this._sendPending()}else e.type==="error"&&(this._init&&this._init.reject(new Error("worker error during init")),console.error("worker error",e))}_getPendingRequest(){for(const e of this._requests.values())if(!e._worker)return e}_getFreeWorker(){for(const e of this._workers)if(!e.busy)return e}_sendPending(){this._pendingFlag=!1;let e;do{e=!1;const t=this._getPendingRequest();if(t){const r=this._getFreeWorker();r&&(this._sendWith(t,r),e=!0)}}while(e)}_sendWith(e,t){e._worker=t,t.busy=!0,t.worker.postMessage(e._message)}_enqueueRequest(e){this._counter+=1,e.id=this._counter;const t=new f$(e,this);return this._requests.set(e.id,t),t}send(e){const t=this._enqueueRequest(e),r=this._getFreeWorker();return r&&this._sendWith(t,r),t}sendAll(e){const t=this._workers.map(r=>{const i=this._enqueueRequest(Object.assign({},e));return this._sendWith(i,r),i.response()});return Promise.all(t)}dispose(){for(const e of this._workers)e.detach(this),e.worker.terminate()}_trySendPendingInNextTick(){this._pendingFlag||(this._pendingFlag=!0,Promise.resolve().then(()=>{this._sendPending()}))}_abortRequest(e){e._reject(new ln),e._worker&&(e._worker.busy=!1),this._requests.delete(e._message.id),this._trySendPendingInNextTick()}}const m$={"image/jpeg":!0,"image/gif":!0,"image/png":!0,"video/mp4":!0,"video/webm":!0,"video/ogg":!0,"video/quicktime":!0,"video/VP8":!0,"audio/mp4":!0,"audio/webm":!0,"audio/aac":!0,"audio/mpeg":!0,"audio/ogg":!0,"audio/wave":!0,"audio/wav":!0,"audio/x-wav":!0,"audio/x-pn-wav":!0,"audio/flac":!0,"audio/x-flac":!0},Nv="application/octet-stream";class si{constructor(e,t=null){this._blob=e,this._buffer=t,this._url=null}static fromBufferUnsafe(e,t){return new si(new Blob([e],{type:t}),e)}static fromBuffer(e,t){return t=t?t.split(";")[0].trim():"",m$[t]||(t=Nv),new si(new Blob([e],{type:t}),e)}static fromBlobUnsafe(e){return new si(e)}get nativeBlob(){return this._blob}async readAsBuffer(){if(this._buffer)return this._buffer;{const e=new FileReader,t=new Promise((r,i)=>{e.addEventListener("load",s=>r(s.target.result)),e.addEventListener("error",s=>i(s.target.error))});return e.readAsArrayBuffer(this._blob),t}}get url(){return this._url||(this._url=URL.createObjectURL(this._blob)),this._url}get size(){return this._blob.size}get mimeType(){return this._blob.type||Nv}dispose(){this._url&&(URL.revokeObjectURL(this._url),this._url=null)}}class ml{static async fromBlob(e){const t=await Pv(e),{width:r,height:i}=t;return new ml(e,r,i,t)}constructor(e,t,r,i){this.blob=e,this.width=t,this.height=r,this._domElement=i}get maxDimension(){return Math.max(this.width,this.height)}async _getDomElement(){return this._domElement||(this._domElement=await Pv(this.blob)),this._domElement}async scale(e){const t=this.width/this.height,r=Math.min(1,e/(t>=1?this.width:this.height)),i=Math.round(this.width*r),s=Math.round(this.height*r),o=document.createElement("canvas");o.width=i,o.height=s;const a=o.getContext("2d"),c=await this._getDomElement();a.drawImage(c,0,0,i,s);let u=this.blob.mimeType==="image/jpeg"?"image/jpeg":"image/png",l;if(o.toBlob)l=await new Promise(p=>o.toBlob(p,u));else if(o.msToBlob)u="image/png",l=o.msToBlob();else throw new Error("canvas can't be turned into blob");const d=si.fromBlobUnsafe(l);return new ml(d,i,s,null)}dispose(){this.blob.dispose()}}class v_ extends ml{get duration(){if(typeof this._domElement.duration=="number")return Math.round(this._domElement.duration*1e3)}static async fromBlob(e){const t=await g$(e),{videoWidth:r,videoHeight:i}=t;return new v_(e,r,i,t)}}function _$(){const n=document.createElement("canvas");n.width=1,n.height=1;const e=n.getContext("2d"),t=[Math.round(Math.random()*255),Math.round(Math.random()*255),Math.round(Math.random()*255)];e.fillStyle=`rgb(${t[0]}, ${t[1]}, ${t[2]})`,e.fillRect(0,0,1,1);const r=e.getImageData(0,0,1,1).data;return r[0]===t[0]&&r[1]===t[1]&&r[2]===t[2]}async function Pv(n){const e=document.createElement("img"),t=Ku(e,"load");return e.src=n.url,await t,e}async function g$(n){const e=document.createElement("video");e.muted=!0;const t=Ku(e,"loadedmetadata");e.src=n.url,e.load(),await t;const r=Ku(e,"seeked");return await new Promise(i=>setTimeout(i,200)),e.currentTime=.1,await r,e}async function y$(n,e,t,r,i){let s=n.querySelector("iframe.downloadSandbox");if(!s){s=document.createElement("iframe"),s.setAttribute("sandbox","allow-scripts allow-downloads allow-downloads-without-user-activation"),s.setAttribute("src",e),s.className="hidden downloadSandbox",n.appendChild(s);let o;await new Promise((a,c)=>{o=()=>{s.removeEventListener("load",a),s.removeEventListener("error",c)},s.addEventListener("load",a),s.addEventListener("error",c)}),o()}if(i){const o=await t.readAsBuffer();s.contentWindow.postMessage({type:"downloadBuffer",buffer:o,mimeType:t.mimeType,filename:r},"*")}else s.contentWindow.postMessage({type:"downloadBlob",blob:t.nativeBlob,filename:r},"*")}class v${constructor(e){this._bodyNode=e}get rootNodes(){return Array.from(this._bodyNode.childNodes)}getChildNodes(e){return Array.from(e.childNodes)}getAttributeNames(e){return Array.from(e.getAttributeNames())}getAttributeValue(e,t){return e.getAttribute(t)}isTextNode(e){return e.nodeType===Node.TEXT_NODE}getNodeText(e){return e.textContent}isElementNode(e){return e.nodeType===Node.ELEMENT_NODE}getNodeElementName(e){return e.tagName}}const w$={ALLOWED_URI_REGEXP:/^(?:(?:(?:f|ht)tps?|mailto|tel|callto|cid|xmpp|xxx|mxc):|[^a-z]|[a-z+.-]+(?:[^a-z+.-:]|$))/i,FORBID_TAGS:["mx-reply"],KEEP_CONTENT:!1};function b$(n){const e=SD.sanitize(n,w$),t=new DOMParser().parseFromString(`<!DOCTYPE html><html><body>${e}</body></html>`,"text/html").body;return new v$(t)}const S$=200,E$=-60,k$=8;class I${constructor(e){this.mediaDevices=e}enumerate(){return this.mediaDevices.enumerateDevices()}async getMediaTracks(e,t){const r=await this.mediaDevices.getUserMedia(this.getUserMediaContraints(e,t));return r.addEventListener("removetrack",i=>{console.log(`removing track ${i.track.id} (${i.track.kind}) from stream ${r.id}`)}),r}async getScreenShareTrack(){return await this.mediaDevices.getDisplayMedia(this.getScreenshareContraints())}getUserMediaContraints(e,t){const r=!!navigator.webkitGetUserMedia;return{audio:e?{deviceId:typeof e!="boolean"?{ideal:e.deviceId}:void 0}:!1,video:t?{deviceId:typeof t!="boolean"?{ideal:t.deviceId}:void 0,width:r?{exact:640}:{ideal:640},height:r?{exact:360}:{ideal:360}}:!1}}getScreenshareContraints(){return{audio:!1,video:!0}}createVolumeMeasurer(e,t){return new T$(e,t)}}class T${constructor(e,t){this.measuringVolumeActivity=!1,this.speakingThreshold=E$,this.speaking=!1,this.volumeLooper=()=>{if(!this.analyser||!this.measuringVolumeActivity)return;this.analyser.getFloatFrequencyData(this.frequencyBinCount);let r=-1/0;for(let s=0;s<this.frequencyBinCount.length;s++)this.frequencyBinCount[s]>r&&(r=this.frequencyBinCount[s]);this.speakingVolumeSamples.shift(),this.speakingVolumeSamples.push(r),this.callback();let i=!1;for(let s=0;s<this.speakingVolumeSamples.length;s++)if(this.speakingVolumeSamples[s]>this.speakingThreshold){i=!0;break}this.speaking!==i&&(this.speaking=i,this.callback()),this.volumeLooperTimeout=setTimeout(this.volumeLooper,S$)},this.stream=e,this.callback=t,this.speakingVolumeSamples=new Array(k$).fill(-1/0),this.initVolumeMeasuring(),this.measureVolumeActivity(!0)}get isSpeaking(){return this.speaking}measureVolumeActivity(e){if(e){if(!this.audioContext||!this.analyser||!this.frequencyBinCount)return;this.measuringVolumeActivity=!0,this.volumeLooper()}else this.measuringVolumeActivity=!1,this.speakingVolumeSamples.fill(-1/0),this.callback()}initVolumeMeasuring(){const e=window.AudioContext||window.webkitAudioContext;if(!e)return;this.audioContext=new e,this.analyser=this.audioContext.createAnalyser(),this.analyser.fftSize=512,this.analyser.smoothingTimeConstant=.1,this.audioContext.createMediaStreamSource(this.stream).connect(this.analyser),this.frequencyBinCount=new Float32Array(this.analyser.frequencyBinCount)}setSpeakingThreshold(e){this.speakingThreshold=e}stop(){var e;clearTimeout(this.volumeLooperTimeout),this.analyser.disconnect(),(e=this.audioContext)==null||e.close()}}var se=(n=>(n.GroupCall="org.matrix.msc3401.call",n.GroupCallMember="org.matrix.msc3401.call.member",n.Invite="m.call.invite",n.Candidates="m.call.candidates",n.Answer="m.call.answer",n.Hangup="m.call.hangup",n.Reject="m.call.reject",n.SelectAnswer="m.call.select_answer",n.Negotiate="m.call.negotiate",n.SDPStreamMetadataChanged="m.call.sdp_stream_metadata_changed",n.SDPStreamMetadataChangedPrefix="org.matrix.call.sdp_stream_metadata_changed",n.Replaces="m.call.replaces",n.AssertedIdentity="m.call.asserted_identity",n.AssertedIdentityPrefix="org.matrix.call.asserted_identity",n))(se||{});const Cn="org.matrix.msc3077.sdp_stream_metadata";var Nr=(n=>(n.Usermedia="m.usermedia",n.Screenshare="m.screenshare",n))(Nr||{}),Te=(n=>(n.UserHangup="user_hangup",n.LocalOfferFailed="local_offer_failed",n.NoUserMedia="no_user_media",n.UnknownDevices="unknown_devices",n.SendInvite="send_invite",n.CreateAnswer="create_answer",n.SendAnswer="send_answer",n.SetRemoteDescription="set_remote_description",n.SetLocalDescription="set_local_description",n.AnsweredElsewhere="answered_elsewhere",n.IceFailed="ice_failed",n.InviteTimeout="invite_timeout",n.Replaced="replaced",n.SignallingFailed="signalling_timeout",n.UserBusy="user_busy",n.Transfered="transferred",n.NewSession="new_session",n))(Te||{}),_l=(n=>(n.Ring="m.ring",n.Prompt="m.prompt",n.Room="m.room",n))(_l||{});class R${createPeerConnection(e,t,r){const i=new RTCPeerConnection({iceTransportPolicy:e?"relay":void 0,iceServers:t,iceCandidatePoolSize:r});return new Proxy(i,{get(s,o,a){const c=s[o];return typeof c=="function"?c.bind(s):c}})}prepareSenderForPurpose(e,t,r){r===Nr.Screenshare&&this.getRidOfRTXCodecs(e,t)}getRidOfRTXCodecs(e,t){var r,i,s,o,a,c;if(!RTCRtpReceiver.getCapabilities||!RTCRtpSender.getCapabilities)return;const u=(i=(r=RTCRtpReceiver.getCapabilities("video"))==null?void 0:r.codecs)!=null?i:[],d=[...(o=(s=RTCRtpSender.getCapabilities("video"))==null?void 0:s.codecs)!=null?o:[],...u];for(const m of d)if(m.mimeType==="video/rtx"){const w=d.indexOf(m);d.splice(w,1)}const p=e.getTransceivers().find(m=>m.sender===t);p&&(((a=p.sender.track)==null?void 0:a.kind)==="video"||((c=p.receiver.track)==null?void 0:c.kind)==="video")&&p.setCodecPreferences(d)}}var Fr=(n=>(n[n.Dark=0]="Dark",n[n.Light=1]="Light",n))(Fr||{});function C$(n,e,t){let r=n.replaceAll("#ff00ff",e);if(r=r.replaceAll("#00ffff",t),n===r)throw new Error("svg-colorizer made no color replacements! The input svg should only contain colors #ff00ff (primary, case-sensitive) and #00ffff (secondary, case-sensitive).");return r}class M${constructor(e,t,r,i){this._platform=e,this._iconVariables=t,this._resolvedVariables=r,this._manifestLocation=i}async toVariables(){const{parsedStructure:e,promises:t}=await this._fetchAndParseIcons();return await Promise.all(t),this._produceColoredIconVariables(e)}async _fetchAndParseIcons(){const e=[],t={};for(const[r,i]of Object.entries(this._iconVariables)){const s=new URL(`https://${i}`),o=s.hostname,a=new URL(o,new URL(this._manifestLocation,window.location.origin)),c=this._platform.request(a,{method:"GET",format:"text",cache:!0}).response();e.push(c);const u=s.searchParams;t[r]={svg:c,primary:u.get("primary"),secondary:u.get("secondary")}}return{parsedStructure:t,promises:e}}async _produceColoredIconVariables(e){let t={};for(const[r,{svg:i,primary:s,secondary:o}]of Object.entries(e)){const{body:a}=await i;if(!s)throw new Error(`Primary color variable ${s} not in list of variables!`);const c=this._resolvedVariables[s],u=this._resolvedVariables[o],l=C$(a,c,u),d=`url('data:image/svg+xml;utf8,${encodeURIComponent(l)}')`;t[r]=d}return t}}const Vh=(lv=l_.offColor)!=null?lv:DE.offColor;function Ov(n,e,t,r){const i=parseInt(t);switch(r&&(e==="darker"?e="lighter":e==="lighter"&&(e="darker")),e){case"darker":return Vh(n).darken(i/100).hex();case"lighter":return Vh(n).lighten(i/100).hex();case"alpha":return Vh(n).rgba(i/100)}}class x${constructor(e,t,r){this._aliases={},this._derivedAliases=[],this._baseVariables=e,this._variablesToDerive=t,this._isDark=r}toVariables(){var e;const t={};this._detectAliases();for(const r of this._variablesToDerive){const i=this._derive(r);i&&(t[r]=i)}for(const[r,i]of Object.entries(this._aliases))t[r]=(e=this._baseVariables[i])!=null?e:t[i];for(const r of this._derivedAliases){const i=this._deriveAlias(r,t);i&&(t[r]=i)}return t}_detectAliases(){const e=[];for(const t of this._variablesToDerive){const[r,i]=t.split("=");i?this._aliases[r]=i:e.push(t)}this._variablesToDerive=e}_derive(e){const t=/(.+)--(.+)-(.+)/,r=e.match(t);if(r){const[,i,s,o]=r,a=this._baseVariables[i];if(!a)if(this._aliases[i]){this._derivedAliases.push(e);return}else throw new Error(`Cannot find value for base variable "${i}"!`);return Ov(a,s,o,this._isDark)}}_deriveAlias(e,t){const r=/(.+)--(.+)-(.+)/,i=e.match(r);if(i){const[,s,o,a]=i,c=t[s];if(!c)throw new Error(`Cannot find value for alias "${s}" when trying to derive ${e}!`);return Ov(c,o,a,this._isDark)}}}(cv=l_.offColor)!=null||DE.offColor;class A${constructor(e,t){this._themeMapping={},this._preferredColorScheme=t,this._platform=e}async parse(e,t,r,i){await i.wrap("RuntimeThemeParser.parse",async()=>{var s;const{cssLocation:o,derivedVariables:a,icons:c}=this._getSourceData(t,r,i),u=e.name;if(!u)throw new Error("Theme name not found in manifest!");let l={},d={};for(const[p,m]of Object.entries((s=e.values)==null?void 0:s.variants))try{const w=`${e.id}-${p}`,{name:S,default:v,dark:_,variables:b}=m,k=new x$(b,a,_).toVariables();Object.assign(b,k);const g=await new M$(this._platform,c,b,r).toVariables();Object.assign(b,k,g);const A=`${u} ${S}`;if(v){Object.assign(_?l:d,{variantName:S,id:w,cssLocation:o,variables:b});continue}this._themeMapping[A]={cssLocation:o,id:w,variables:b}}catch(w){console.error(w);continue}if(l.id&&d.id){const p=this._preferredColorScheme===Fr.Dark?l:d;this._themeMapping[u]={dark:l,light:d,default:p}}else{const p=l.id?l:d;this._themeMapping[`${u} ${p.variantName}`]={id:p.id,cssLocation:p.cssLocation}}})}_getSourceData(e,t,r){return r.wrap("getSourceData",()=>{var i,s,o;const a=(i=e.source)==null?void 0:i["runtime-asset"];if(!a)throw new Error(`Run-time asset not found in source section for theme at ${t}`);const c=new URL(a,new URL(t,window.location.origin)).href,u=(s=e.source)==null?void 0:s["derived-variables"];if(!u)throw new Error(`Derived variables not found in source section for theme at ${t}`);const l=(o=e.source)==null?void 0:o.icon;if(!l)throw new Error(`Icon mapping not found in source section for theme at ${t}`);return{cssLocation:c,derivedVariables:u,icons:l}})}get themeMapping(){return this._themeMapping}}class D${constructor(e){this._themeMapping={},this._preferredColorScheme=e}parse(e,t,r){r.wrap("BuiltThemeParser.parse",()=>{var i,s,o;const a=(i=e.source)==null?void 0:i["built-assets"],c=e.name;if(!c)throw new Error(`Theme name not found in manifest at ${t}`);let u={},l={};for(let[d,p]of Object.entries(a)){try{p=new URL(p,new URL(t,window.location.origin)).href}catch{continue}const m=(s=d.match(/.+-(.+)/))==null?void 0:s[1],w=(o=e.values)==null?void 0:o.variants[m];if(!w)throw new Error(`Variant ${m} is missing in manifest at ${t}`);const{name:S,default:v,dark:_}=w,b=`${c} ${S}`;if(v){const k=_?u:l;k.variantName=S,k.id=d,k.cssLocation=p;continue}this._themeMapping[b]={cssLocation:p,id:d}}if(u.id&&l.id){const d=this._preferredColorScheme===Fr.Dark?u:l;this._themeMapping[c]={dark:u,light:l,default:d}}else{const d=u.id?u:l;this._themeMapping[`${c} ${d.variantName}`]={id:d.id,cssLocation:d.cssLocation}}})}get themeMapping(){return this._themeMapping}}class N${constructor(e){this._platform=e}async init(e,t){await this._platform.logger.wrapOrRun(t,"ThemeLoader.init",async r=>{let i=!0;const s=[],o=[],a=await Promise.all(e.map(d=>this._platform.request(d,{method:"GET",format:"json",cache:!0}).response())),c=new A$(this._platform,this.preferredColorScheme),u=new D$(this.preferredColorScheme),l=[];for(let d=0;d<a.length;++d){const p=a[d],{status:m,body:w}=p;if(!(m>=200&&m<=299)){console.error(`Failed to load manifest at ${e[d]}, status: ${m}`),r.log({l:"Manifest fetch failed",location:e[d],status:m},tn.Error),s.push(e[d]);continue}i=!1;try{if(w.extends){const S=a.findIndex(k=>"value"in k&&k.value.body.id===w.extends);if(S===-1)throw new Error(`Base manifest for derived theme at ${e[d]} not found!`);const{body:v}=a[S].value,_=e[S],b=c.parse(w,v,_,r);l.push(b)}else u.parse(w,e[d],r)}catch(S){console.error(S),o.push(S.message)}}if(await Promise.all(l),this._themeMapping=lo(lo({},u.themeMapping),c.themeMapping),i)throw new Error(`All configured theme manifests failed to load, the following were tried: ${s.join(", ")}`);if(Object.keys(this._themeMapping).length===0&&o.length)throw new Error(`Failed to parse theme manifests, the following errors were encountered: ${o.join(", ")}`);this._addDefaultThemeToMapping(r),r.log({l:"Preferred colorscheme",scheme:this.preferredColorScheme===Fr.Dark?"dark":"light"}),r.log({l:"Result",themeMapping:this._themeMapping})})}async setTheme(e,t,r){await this._platform.logger.wrapOrRun(r,{l:"change theme",name:e,variant:t},async i=>{let s,o,a=this._themeMapping[e];if("id"in a)s=a.cssLocation,o=a.variables;else{if(!t)throw new Error("themeVariant is undefined!");s=a[t].cssLocation,o=a[t].variables}await this._platform.replaceStylesheet(s,i),o?(r==null||r.log({l:"Derived Theme",variables:o}),this._injectCSSVariables(o)):this._removePreviousCSSVariables(),this._platform.settingsStorage.setString("theme-name",e),t?this._platform.settingsStorage.setString("theme-variant",t):this._platform.settingsStorage.remove("theme-variant")})}_injectCSSVariables(e){const t=document.documentElement;for(const[r,i]of Object.entries(e))t.style.setProperty(`--${r}`,i);this._injectedVariables=e}_removePreviousCSSVariables(){if(!this._injectedVariables)return;const e=document.documentElement;for(const t of Object.keys(this._injectedVariables))e.style.removeProperty(`--${t}`);this._injectedVariables=void 0}get themeMapping(){return this._themeMapping}async getActiveTheme(){let e=await this._platform.settingsStorage.getString("theme-name"),t=await this._platform.settingsStorage.getString("theme-variant");return(!e||!this._themeMapping[e])&&(e="Default"in this._themeMapping?"Default":Object.keys(this._themeMapping)[0],this._themeMapping[e][t]||(t="default"in this._themeMapping[e]?"default":void 0)),{themeName:e,themeVariant:t}}getDefaultTheme(){var e,t;switch(this.preferredColorScheme){case Fr.Dark:return(e=this._platform.config.defaultTheme)==null?void 0:e.dark;case Fr.Light:return(t=this._platform.config.defaultTheme)==null?void 0:t.light}}_findThemeDetailsFromId(e){var t,r;for(const[i,s]of Object.entries(this._themeMapping)){if("id"in s&&s.id===e)return{themeName:i,themeData:s};if("light"in s&&((t=s.light)==null?void 0:t.id)===e)return{themeName:i,themeData:s.light};if("dark"in s&&((r=s.dark)==null?void 0:r.id)===e)return{themeName:i,themeData:s.dark}}}_addDefaultThemeToMapping(e){e.wrap("addDefaultThemeToMapping",t=>{const r=this.getDefaultTheme();if(r){const i=this._findThemeDetailsFromId(r);if(i){this._themeMapping.Default={id:"default",cssLocation:i.themeData.cssLocation};const s=i.themeData.variables;s&&(this._themeMapping.Default.variables=s)}}t.log({l:"Default Theme",theme:r})})}get preferredColorScheme(){if(window.matchMedia("(prefers-color-scheme: dark)").matches)return Fr.Dark;if(window.matchMedia("(prefers-color-scheme: light)").matches)return Fr.Light}}var M0=(n=>(n[n.Minute=6e4]="Minute",n[n.Hours=36e5]="Hours",n[n.Day=864e5]="Day",n))(M0||{});function P$(n){let e=0,t=0,r=0;n>=864e5&&(e=Math.floor(n/864e5),n-=e*864e5),n>=36e5&&(t=Math.floor(n/36e5),n-=t*36e5),n>=6e4&&(r=Math.floor(n/6e4),n-=r*6e4);const i=Math.floor(n/1e3);let s="";return e&&(s=`${e}d `),(t||e)&&(s+=`${t}h `),(r||t||e)&&(s+=`${r}m `),s+=`${i}s`,s}class O${constructor(e){this.clock=e,this.todayMidnight=new Date,this.todayMidnight.setHours(0,0,0,0),this.relativeDayFormatter=new Intl.RelativeTimeFormat(void 0,{numeric:"auto"}),this.weekdayFormatter=new Intl.DateTimeFormat(void 0,{weekday:"long"}),this.currentYearFormatter=new Intl.DateTimeFormat(void 0,{weekday:"long",month:"long",day:"numeric"}),this.otherYearFormatter=new Intl.DateTimeFormat(void 0,{weekday:"long",year:"numeric",month:"long",day:"numeric"}),this.timeFormatter=new Intl.DateTimeFormat(void 0,{hour:"numeric",minute:"2-digit"})}formatTime(e){return this.timeFormatter.format(e)}formatMachineReadableDate(e){return`${e.getFullYear()}-${e.getMonth()+1}-${e.getDate()}`}formatRelativeDate(e){let t=Math.floor((e.getTime()-this.todayMidnight.getTime())/M0.Day);return t>=-1&&t<=1?U$(this.relativeDayFormatter.format(t,"day")):t>-7&&t<0?this.weekdayFormatter.format(e):this.todayMidnight.getFullYear()===e.getFullYear()?this.currentYearFormatter.format(e):this.otherYearFormatter.format(e)}formatDuration(e){return P$(e)}}function U$(n){return n.slice(0,1).toLocaleUpperCase()+n.slice(1)}function Uv(n){return new Promise(function(e,t){var r=document.createElement("script");r.setAttribute("src",n),r.onload=e,r.onerror=t,document.body.appendChild(r)})}async function $$(n){return window.msCrypto&&!window.crypto&&(window.crypto=window.msCrypto),n?(window.WebAssembly?(await Uv(n.wasmBundle),await window.Olm.init({locateFile:()=>n.wasm})):(await Uv(n.legacyBundle),await window.Olm.init()),window.Olm):null}function L$(n){return n.startsWith("/")?n:new URL(n,document.location.href).pathname}async function F$(n){const e=new p$(n.worker,4);return await e.init(),await e.sendAll({type:"load_olm",path:L$(n.olm.legacyBundle)}),new eO(e)}function B$(n){if(!window.visualViewport)return;const e=()=>{const t=n.querySelector(".SessionView");if(!t)return;const r=n.querySelector(".bottom-aligned-scroll");let i,s,o;r&&(i=r.scrollTop,s=r.offsetHeight);const a=t.offsetTop+t.offsetHeight-window.visualViewport.height;n.style.setProperty("--ios-viewport-height",window.visualViewport.height.toString()+"px"),n.style.setProperty("--ios-viewport-top",a.toString()+"px"),r&&(o=r.offsetHeight,r.scrollTop=i+s-o)};return window.visualViewport.addEventListener("resize",e),()=>{window.visualViewport.removeEventListener("resize",e)}}class V${constructor({container:e,assetPaths:t,config:r,configURL:i,logger:s,options:o=null,cryptoExtras:a=null}){this._container=e,this._assetPaths=t,this._config=r,this._configURL=i,this.settingsStorage=new KP("hydrogen_setting_v1_"),this.clock=new QU,this.encoding=new ZP,this.random=Math.random,this.logger=s??this._createLogger(o==null?void 0:o.development),this.history=new t$,this.onlineStatus=new n$,this.timeFormatter=new O$,this._serviceWorkerHandler=null,t.serviceWorker&&"serviceWorker"in navigator&&(this._serviceWorkerHandler=new ZU,this._serviceWorkerHandler.registerAndStart(t.serviceWorker)),this.notificationService=void 0,this._assetPaths.olm&&(this.crypto=new u$(a)),this.storageFactory=new FP(this._serviceWorkerHandler),this.sessionInfoStorage=new VP("hydrogen_sessions_v1"),this.estimateStorageUsage=d$,typeof fetch=="function"?this.request=pN(this.clock.createTimeout,this._serviceWorkerHandler):this.request=zE;const c=!!window.MSInputMethodContext&&!!document.documentMode;this.isIE11=c;const u=/iPad|iPhone|iPod/.test(navigator.platform)||navigator.platform==="MacIntel"&&navigator.maxTouchPoints>1&&!window.MSStream;this.isIOS=u,this._disposables=new Al,this._olmPromise=void 0,this._workerPromise=void 0,this.mediaDevices=new I$(navigator.mediaDevices),this.webRTC=new R$,this._themeLoader=new N$(this)}async init(){try{await this.logger.run("Platform init",async e=>{var t;if(!this._config){if(!this._configURL)throw new Error("Neither config nor configURL was provided!");const{status:r,body:i}=await this.request(this._configURL,{method:"GET",format:"json",cache:!0}).response();if(r===404)throw new Error(`Could not find ${this._configURL}. Did you copy over config.sample.json?`);if(r>=400)throw new Error(`Got status ${r} while trying to fetch ${this._configURL}`);this._config=i}if(this.notificationService=new e$(this._serviceWorkerHandler,this._config.push),this._themeLoader){const r=this.config.themeManifests;await((t=this._themeLoader)==null?void 0:t.init(r,e));const{themeName:i,themeVariant:s}=await this._themeLoader.getActiveTheme();e.log({l:"Active theme",name:i,variant:s}),await this._themeLoader.setTheme(i,s,e)}})}catch(e){throw this._container.innerText=e.message,e}}_createLogger(e){const t=new CD({platform:this}),r=s=>{var o;return(o=s.e)!=null&&o.stack&&(s.e.stack=s.e.stack.replace(/\/\?loginToken=(.+)/,"?loginToken=<snip>")),s},i=new ND({name:"hydrogen_logs",platform:this,serializedTransformer:r});return t.addReporter(i),e&&t.addReporter(new OD),t}get updateService(){return this._serviceWorkerHandler}loadOlm(){return this._olmPromise||(this._olmPromise=$$(this._assetPaths.olm)),this._olmPromise}get config(){return this._config}async loadOlmWorker(){if(!window.WebAssembly)return this._workerPromise||(this._workerPromise=F$(this._assetPaths)),this._workerPromise}createAndMountRootView(e){if(this.isIE11&&(this._container.className+=" legacy"),this.isIOS){this._container.className+=" ios";const r=B$(this._container);r&&this._disposables.track(r)}this._container.addEventListener("error",Rv,!0),this._disposables.track(()=>this._container.removeEventListener("error",Rv,!0)),window.__hydrogenViewModel=e;const t=new WU(e);this._container.appendChild(t.mount())}setNavigation(e){var t;(t=this._serviceWorkerHandler)==null||t.setNavigation(e)}createBlob(e,t){return si.fromBuffer(e,t)}saveFileAs(e,t){navigator.msSaveBlob?navigator.msSaveBlob(e.nativeBlob,t):y$(this._container,this._assetPaths.downloadSandbox,e,t,this.isIOS)}async copyPlaintext(e){return await pU(e)}restart(){document.location.reload()}openFile(e=null){const t=document.createElement("input");t.setAttribute("type","file"),t.className="hidden",e&&t.setAttribute("accept",e);const r=new Promise(i=>{const s=()=>{t.removeEventListener("change",s,!0);const o=t.files[0];this._container.removeChild(t),o?i({name:o.name,blob:si.fromBlobUnsafe(o)}):i()};t.addEventListener("change",s,!0)});return this._container.appendChild(t),t.click(),r}openUrl(e){location.href=e}parseHTML(e){return b$(e)}async loadImage(e){return ml.fromBlob(e)}async loadVideo(e){return v_.fromBlob(e)}hasReadPixelPermission(){return _$()}get devicePixelRatio(){return window.devicePixelRatio||1}get version(){return"0.3.8"}get themeLoader(){return this._themeLoader}async replaceStylesheet(e,t){const r=await this.logger.wrapOrRun(t,{l:"replaceStylesheet",location:e},async i=>{let s;const o=document.querySelector("head");document.querySelectorAll(".theme").forEach(u=>u.remove());const a=document.createElement("link");a.href=e,a.rel="stylesheet",a.type="text/css",a.className="theme";const c=new Promise(u=>{a.onerror=()=>{s=new Error(`Failed to load stylesheet from ${e}`),i.catch(s),u()},a.onload=()=>{u()}});return o.appendChild(a),await c,s});if(r)throw r}get description(){var e;return"web-"+((e=navigator.userAgent)!=null?e:"<unknown>")}dispose(){this._disposables.dispose()}}var x0=(n=>(n[n.Calls=1]="Calls",n[n.CrossSigning=2]="CrossSigning",n))(x0||{});class Xs{constructor(e=0){this.flags=e}withFeature(e){return new Xs(this.flags|e)}withoutFeature(e){return new Xs(this.flags^e)}isFeatureEnabled(e){return(this.flags&e)!==0}get calls(){return this.isFeatureEnabled(1)}get crossSigning(){return this.isFeatureEnabled(2)}static async load(e){const t=await e.getInt("enabled_features")||0;return new Xs(t)}async store(e){await e.setInt("enabled_features",this.flags)}}function Po(...n){const e={};for(const t of n)e[t]=t;return Object.freeze(e)}function $v(n){try{return new URL(n).origin}catch{return new URL(`https://${n}`).origin}}async function K$(n,e){const t={format:"json",timeout:3e4,method:"GET"};try{const r=`${n}/.well-known/matrix/client`;return await e(r,t).response()}catch(r){if(r.name==="ConnectionError")return null;throw r}}async function j$(n,e){var t,r,i;n=$v(n);let s=null,o=null;const a=await K$(n,e);if(a&&a.status===200){const{body:c}=a,u=(t=c["m.homeserver"])==null?void 0:t.base_url;typeof u=="string"&&(n=$v(u));const l=(r=c["org.matrix.msc2965.authentication"])==null?void 0:r.issuer;typeof l=="string"&&(s=l);const d=(i=c["org.matrix.msc2965.authentication"])==null?void 0:i.account;typeof d=="string"&&(o=d)}return{homeserver:n,issuer:s,account:o}}class A0 extends kr{constructor(e){super(),this._abortable=void 0;const t=i=>(this._abortable=i,i);this._progress=void 0;const r=i=>{this._progress=i,this.emit("change","progress")};this.result=e(t,r)}get progress(){return this._progress}abort(){var e;(e=this._abortable)==null||e.abort(),this._abortable=void 0}}function D0(n){return Object.entries(n||{}).filter(([,e])=>e!==void 0).map(([e,t])=>(typeof t=="object"&&(t=JSON.stringify(t)),`${encodeURIComponent(e)}=${encodeURIComponent(t)}`)).join("&")}function H$(n){if(n instanceof si){const e=n;return{mimeType:e.mimeType,body:e}}else{if(n instanceof Map)return{mimeType:"multipart/form-data",body:n};if(typeof n=="object")return{mimeType:"application/json",body:JSON.stringify(n)};throw new Error("Unknown body type: "+n)}}class z${constructor(e,t,r,i){let s;if(i!=null&&i.log){const o=i==null?void 0:i.log;s=o.child({t:"network",url:t,method:e},o.level.Info)}this._log=s,this._sourceRequest=r,this._promise=r.response().then(o=>{var a,c;if(s==null||s.set("status",o.status),o.status>=200&&o.status<300||(a=i==null?void 0:i.allowedStatusCodes)!=null&&a.includes(o.status))return s==null||s.finish(),o.body;if(o.status>=500){const u=new dr("Internal Server Error");throw s==null||s.catch(u),u}else if(o.status>=400&&!((c=o.body)!=null&&c.errcode)){const u=new dr(`HTTP error status ${o.status} without errcode in body, assume this is a load balancer complaining the server is offline.`);throw s==null||s.catch(u),u}else{const u=new BE(e,t,o.body,o.status);throw s==null||s.set("errcode",u.errcode),s==null||s.catch(u),u}},o=>{if(o.name==="AbortError"&&this._sourceRequest){const a=new dr("Service worker aborted, either updating or hit #187.");throw s==null||s.catch(a),a}else throw o.name==="ConnectionError"&&(s==null||s.set("timeout",o.isTimeout)),s==null||s.catch(o),o})}abort(){var e;this._sourceRequest&&((e=this._log)==null||e.set("aborted",!0),this._sourceRequest.abort(),this._sourceRequest=void 0)}response(){return this._promise}async responseCode(){return(await this._sourceRequest.response()).status}}const Sc="/_matrix/client/r0",G$="/_matrix/client/v3",Kh="/_matrix/client/unstable/org.matrix.msc2697.v2";class Di{constructor({homeserver:e,accessToken:t,request:r,reconnector:i}){this._homeserver=e,this._accessToken=t,this._requestFn=r,this._reconnector=i}_url(e,t=Sc){return this._homeserver+t+e}_baseRequest(e,t,r,i,s,o){const a=D0(r);t=`${t}?${a}`;let c;const u=new Map;let l=null;if(s!=null&&s.accessTokenOverride?l=s.accessTokenOverride:o&&(l=o.get()),l&&u.set("Authorization",`Bearer ${l}`),u.set("Accept","application/json"),i){const m=H$(i);u.set("Content-Type",m.mimeType),c=m.body}const d=this._requestFn(t,{method:e,headers:u,body:c,timeout:s==null?void 0:s.timeout,uploadProgress:s==null?void 0:s.uploadProgress,format:"json",cache:e!=="GET"}),p=new z$(e,t,d,s);return this._reconnector&&p.response().catch(m=>{m.name==="ConnectionError"&&this._reconnector.onRequestFailed(this)}),p}_unauthedRequest(e,t,r,i,s){return this._baseRequest(e,t,r,i,s)}_authedRequest(e,t,r,i,s){return this._baseRequest(e,t,r,i,s,this._accessToken)}_post(e,t,r,i){return this._authedRequest("POST",this._url(e,(i==null?void 0:i.prefix)||Sc),t,r,i)}_put(e,t,r,i){return this._authedRequest("PUT",this._url(e,(i==null?void 0:i.prefix)||Sc),t,r,i)}_get(e,t,r,i){return this._authedRequest("GET",this._url(e,(i==null?void 0:i.prefix)||Sc),t,r,i)}sync(e,t,r,i){return this._get("/sync",{since:e,timeout:r,filter:t},void 0,i)}context(e,t,r,i){return this._get(`/rooms/${encodeURIComponent(e)}/context/${encodeURIComponent(t)}`,{filter:i,limit:r})}messages(e,t,r){return this._get(`/rooms/${encodeURIComponent(e)}/messages`,t,void 0,r)}members(e,t,r){return this._get(`/rooms/${encodeURIComponent(e)}/members`,t,void 0,r)}send(e,t,r,i,s){return this._put(`/rooms/${encodeURIComponent(e)}/send/${encodeURIComponent(t)}/${encodeURIComponent(r)}`,{},i,s)}event(e,t,r){return this._get(`/rooms/${encodeURIComponent(e)}/event/${encodeURIComponent(t)}`,void 0,void 0,r)}redact(e,t,r,i,s){return this._put(`/rooms/${encodeURIComponent(e)}/redact/${encodeURIComponent(t)}/${encodeURIComponent(r)}`,{},i,s)}receipt(e,t,r,i){return this._post(`/rooms/${encodeURIComponent(e)}/receipt/${encodeURIComponent(t)}/${encodeURIComponent(r)}`,{},{},i)}state(e,t,r,i){return this._get(`/rooms/${encodeURIComponent(e)}/state/${encodeURIComponent(t)}/${encodeURIComponent(r)}`,{},void 0,i)}sendState(e,t,r,i,s){return this._put(`/rooms/${encodeURIComponent(e)}/state/${encodeURIComponent(t)}/${encodeURIComponent(r)}`,{},i,s)}getLoginFlows(){return this._unauthedRequest("GET",this._url("/login"))}register(e,t,r,i,s=!1,o={}){o.allowedStatusCodes=[401];const a={auth:i,password:t,initial_device_displayname:r,inhibit_login:s};return e&&(a.username=e),this._unauthedRequest("POST",this._url("/register",G$),void 0,a,o)}passwordLogin(e,t,r,i){return this._unauthedRequest("POST",this._url("/login"),void 0,{type:"m.login.password",identifier:{type:"m.id.user",user:e},password:t,initial_device_display_name:r},i)}tokenLogin(e,t,r,i){return this._unauthedRequest("POST",this._url("/login"),void 0,{type:"m.login.token",identifier:{type:"m.id.user"},token:e,txn_id:t,initial_device_display_name:r},i)}createFilter(e,t,r){return this._post(`/user/${encodeURIComponent(e)}/filter`,{},t,r)}versions(e){return this._unauthedRequest("GET",`${this._homeserver}/_matrix/client/versions`,void 0,void 0,e)}uploadKeys(e,t,r){let i="/keys/upload";return e&&(i=i+`/${encodeURIComponent(e)}`),this._post(i,{},t,r)}uploadSignatures(e,t){return this._post("/keys/signatures/upload",{},e,t)}queryKeys(e,t){return this._post("/keys/query",{},e,t)}claimKeys(e,t){return this._post("/keys/claim",{},e,t)}sendToDevice(e,t,r,i){return this._put(`/sendToDevice/${encodeURIComponent(e)}/${encodeURIComponent(r)}`,{},t,i)}roomKeysVersion(e,t){let r="";return e&&(r=`/${encodeURIComponent(e)}`),this._get(`/room_keys/version${r}`,void 0,void 0,t)}roomKeyForRoomAndSession(e,t,r,i){return this._get(`/room_keys/keys/${encodeURIComponent(t)}/${encodeURIComponent(r)}`,{version:e},void 0,i)}uploadRoomKeysToBackup(e,t,r){return this._put("/room_keys/keys",{version:e},t,r)}uploadAttachment(e,t,r){return this._authedRequest("POST",`${this._homeserver}/_matrix/media/r0/upload`,{filename:t},e,r)}setPusher(e,t){return this._post("/pushers/set",{},e,t)}getPushers(e){return this._get("/pushers",void 0,void 0,e)}join(e,t){return this._post(`/rooms/${encodeURIComponent(e)}/join`,{},{},t)}joinIdOrAlias(e,t){return this._post(`/join/${encodeURIComponent(e)}`,{},{},t)}invite(e,t,r){return this._post(`/rooms/${encodeURIComponent(e)}/invite`,{},{user_id:t},r)}leave(e,t){return this._post(`/rooms/${encodeURIComponent(e)}/leave`,{},{},t)}forget(e,t){return this._post(`/rooms/${encodeURIComponent(e)}/forget`,{},{},t)}kick(e,t,r,i){return this._post(`/rooms/${encodeURIComponent(e)}/kick`,{},{user_id:t,reason:r},i)}ban(e,t,r,i){return this._post(`/rooms/${encodeURIComponent(e)}/ban`,{},{user_id:t,reason:r},i)}unban(e,t,r,i){return this._post(`/rooms/${encodeURIComponent(e)}/unban`,{},{user_id:t,reason:r},i)}logout(e){return this._post("/logout",{},{},e)}whoami(e){return this._get("/account/whoami",void 0,void 0,e)}getDehydratedDevice(e={}){return e.prefix=Kh,this._get("/dehydrated_device",void 0,void 0,e)}createDehydratedDevice(e,t={}){return t.prefix=Kh,this._put("/dehydrated_device",{},e,t)}claimDehydratedDevice(e,t={}){return t.prefix=Kh,this._post("/dehydrated_device/claim",{},{device_id:e},t)}searchProfile(e,t,r){return this._post("/user_directory/search",{},{limit:t??10,search_term:e},r)}profile(e,t){return this._get(`/profile/${encodeURIComponent(e)}`)}setProfileDisplayName(e,t,r){return this._put(`/profile/${encodeURIComponent(e)}/displayname`,{},{displayname:t},r)}setProfileAvatarUrl(e,t,r){return this._put(`/profile/${encodeURIComponent(e)}/avatar_url`,{},{avatar_url:t},r)}createRoom(e,t){return this._post("/createRoom",{},e,t)}accountData(e,t,r){return this._get(`/user/${encodeURIComponent(e)}/account_data/${encodeURIComponent(t)}`,void 0,void 0,r)}setAccountData(e,t,r,i){return this._put(`/user/${encodeURIComponent(e)}/account_data/${encodeURIComponent(t)}`,{},r,i)}roomAccountData(e,t,r,i){return this._get(`/user/${encodeURIComponent(e)}/rooms/${encodeURIComponent(t)}/account_data/${encodeURIComponent(r)}`,void 0,void 0,i)}setRoomAccountData(e,t,r,i,s){return this._put(`/user/${encodeURIComponent(e)}/rooms/${encodeURIComponent(t)}/account_data/${encodeURIComponent(r)}`,{},i,s)}getTurnServer(e){return this._get("/voip/turnServer",void 0,void 0,e)}}const q$=".well-known/openid-configuration",Lv="ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz0123456789",W$=()=>Lv.charAt(Math.floor(Math.random()*1e10)%Lv.length),Ec=n=>Array.from({length:n},W$).join(""),Fv=n=>typeof n=="object"&&n.token_type==="Bearer"&&typeof n.access_token=="string"&&(!("refresh_token"in n)||typeof n.refresh_token=="string")&&(!("expires_in"in n)||typeof n.expires_in=="number");function Qn(n,e){if(!n)throw new Error(`Assertion failed: ${e}`)}class zc{constructor({issuer:e,request:t,encoding:r,crypto:i,urlRouter:s,clientId:o,staticClients:a={}}){this._issuer=e,this._requestFn=t,this._encoding=r,this._crypto=i,this._urlRouter=s,this._staticClients=a,o&&(this._registrationPromise=Promise.resolve({client_id:o}))}get clientMetadata(){return{client_name:"Hydrogen Web",logo_uri:this._urlRouter.absoluteUrlForAsset("icon.png"),client_uri:this._urlRouter.absoluteAppUrl(),tos_uri:"https://element.io/terms-of-service",policy_uri:"https://element.io/privacy",response_types:["code"],grant_types:["authorization_code","refresh_token"],redirect_uris:[this._urlRouter.createOIDCRedirectURL()],id_token_signed_response_alg:"RS256",token_endpoint_auth_method:"none",post_logout_redirect_uris:[this._urlRouter.createOIDCPostLogoutRedirectURL()]}}get metadataUrl(){return new URL(q$,`${this._issuer}${this._issuer.endsWith("/")?"":"/"}`).toString()}get issuer(){return this._issuer}async clientId(){return(await this.registration()).client_id}registration(){return this._registrationPromise||(this._registrationPromise=(async()=>{const e=`${this.issuer}${this.issuer.endsWith("/")?"":"/"}`;if(this._staticClients[e])return this._staticClients[e];const t=new Map;t.set("Accept","application/json"),t.set("Content-Type","application/json");const i=await this._requestFn(await this.registrationEndpoint(),{method:"POST",headers:t,format:"json",body:JSON.stringify(this.clientMetadata)}).response();if(i.status>=400)throw new Error("failed to register client");return i.body})()),this._registrationPromise}metadata(){return this._metadataPromise||(this._metadataPromise=(async()=>{const e=new Map;e.set("Accept","application/json");const r=await this._requestFn(this.metadataUrl,{method:"GET",headers:e,format:"json"}).response();if(r.status>=400)throw new Error("failed to request metadata");return r.body})()),this._metadataPromise}async validate(){const e=await this.metadata();Qn(typeof e.authorization_endpoint=="string","Has an authorization endpoint"),Qn(typeof e.token_endpoint=="string","Has a token endpoint"),Qn(typeof e.registration_endpoint=="string","Has a registration endpoint"),Qn(Array.isArray(e.response_types_supported)&&e.response_types_supported.includes("code"),"Supports the code response type"),Qn(Array.isArray(e.response_modes_supported)&&e.response_modes_supported.includes("fragment"),"Supports the fragment response mode"),Qn(typeof e.authorization_endpoint=="string"||Array.isArray(e.grant_types_supported)&&e.grant_types_supported.includes("authorization_code"),"Supports the authorization_code grant type"),Qn(Array.isArray(e.code_challenge_methods_supported)&&e.code_challenge_methods_supported.includes("S256"),"Supports the authorization_code grant type")}async _generateCodeChallenge(e){const t=this._encoding.utf8.encode(e),r=await this._crypto.digest("SHA-256",t);return this._encoding.base64.encode(r).replace(/\+/g,"-").replace(/\//g,"_").replace(/=/g,"")}async authorizationEndpoint({state:e,redirectUri:t,scope:r,nonce:i,codeVerifier:s}){const o=await this.metadata(),a=new URL(o.authorization_endpoint);return a.searchParams.append("response_mode","fragment"),a.searchParams.append("response_type","code"),a.searchParams.append("redirect_uri",t),a.searchParams.append("client_id",await this.clientId()),a.searchParams.append("state",e),a.searchParams.append("scope",r),i&&a.searchParams.append("nonce",i),s&&(a.searchParams.append("code_challenge_method","S256"),a.searchParams.append("code_challenge",await this._generateCodeChallenge(s))),a.toString()}async tokenEndpoint(){return(await this.metadata()).token_endpoint}async registrationEndpoint(){return(await this.metadata()).registration_endpoint}async revocationEndpoint(){return(await this.metadata()).revocation_endpoint}async endSessionEndpoint({idTokenHint:e,logoutHint:t,redirectUri:r,state:i}){const o=(await this.metadata()).end_session_endpoint;if(!o)return;r||(r=this._urlRouter.createOIDCPostLogoutRedirectURL());const a=new URL(o);return a.searchParams.append("client_id",await this.clientId()),a.searchParams.append("post_logout_redirect_uri",r),e&&a.searchParams.append("id_token_hint",e),t&&a.searchParams.append("logout_hint",t),i&&a.searchParams.append("state",i),a.href}async isGuestAvailable(){var e;return(e=(await this.metadata()).scopes_supported)==null?void 0:e.includes("urn:matrix:org.matrix.msc2967.client:api:guest")}generateDeviceScope(){return`urn:matrix:org.matrix.msc2967.client:device:${Ec(10)}`}generateParams({scope:e,redirectUri:t}){return{scope:e,redirectUri:t,state:Ec(8),nonce:Ec(8),codeVerifier:Ec(64)}}async completeAuthorizationCodeGrant({codeVerifier:e,code:t,redirectUri:r}){const i=new URLSearchParams;i.append("grant_type","authorization_code"),i.append("client_id",await this.clientId()),i.append("code_verifier",e),i.append("redirect_uri",r),i.append("code",t);const s=i.toString(),o=new Map;o.set("Content-Type","application/x-www-form-urlencoded");const c=await this._requestFn(await this.tokenEndpoint(),{method:"POST",headers:o,format:"json",body:s}).response();if(c.status>=400)throw new Error("failed to exchange authorization code");const u=c.body;return Qn(Fv(u),"Got back a valid bearer token"),u}async refreshToken({refreshToken:e}){const t=new URLSearchParams;t.append("grant_type","refresh_token"),t.append("client_id",await this.clientId()),t.append("refresh_token",e);const r=t.toString(),i=new Map;i.set("Content-Type","application/x-www-form-urlencoded");const o=await this._requestFn(await this.tokenEndpoint(),{method:"POST",headers:i,format:"json",body:r}).response();if(o.status>=400)throw new Error("failed to use refresh token");const a=o.body;return Qn(Fv(a),"Got back a valid bearer token"),a}async revokeToken({token:e,type:t}){const r=await this.revocationEndpoint();if(!r)return;const i=new URLSearchParams;i.append("token_type",t),i.append("token",e),i.append("client_id",await this.clientId());const s=i.toString(),o=new Map;if(o.set("Content-Type","application/x-www-form-urlencoded"),(await this._requestFn(r,{method:"POST",headers:o,body:s}).response()).status>=400)throw new Error("failed to revoke token")}}class w_ extends Ml{emit(e){for(const t of this._handlers)t(e)}waitFor(e){return e(this.get())?new X$(Promise.resolve(this.get())):new Y$(this,e)}flatMap(e){return new Q$(this,e)}map(e){return new Z$(this,e)}}class Y${constructor(e,t){this._promise=new Promise((r,i)=>{this._reject=i,this._subscription=e.subscribe(s=>{t(s)&&(this._reject=null,r(s),this.dispose())})})}get promise(){return this._promise}dispose(){this._subscription&&(this._subscription(),this._subscription=null),this._reject&&(this._reject(new ln),this._reject=null)}}class X${constructor(e){this.promise=e}dispose(){}}class J$ extends w_{constructor(e){super(),this._value=e}get(){return this._value}set(e){e!==this._value&&(this._value=e,this.emit(this._value))}}class Q$ extends w_{constructor(e,t){super(),this.source=e,this.mapper=t}onUnsubscribeLast(){super.onUnsubscribeLast(),this.sourceSubscription=this.sourceSubscription(),this.targetSubscription&&(this.targetSubscription=this.targetSubscription())}onSubscribeFirst(){super.onSubscribeFirst(),this.sourceSubscription=this.source.subscribe(()=>{this.updateTargetSubscription(),this.emit(this.get())}),this.updateTargetSubscription()}updateTargetSubscription(){const e=this.source.get();if(e){const t=this.mapper(e);if(t){this.targetSubscription||(this.targetSubscription=t.subscribe(()=>this.emit(this.get())));return}}this.targetSubscription&&(this.targetSubscription=this.targetSubscription())}get(){const e=this.source.get();if(!e)return;const t=this.mapper(e);return t==null?void 0:t.get()}}class Z$ extends w_{constructor(e,t){super(),this.source=e,this.mapper=t}onUnsubscribeLast(){super.onUnsubscribeLast(),this.sourceSubscription=this.sourceSubscription()}onSubscribeFirst(){super.onSubscribeFirst(),this.sourceSubscription=this.source.subscribe(()=>{this.emit(this.get())})}get(){const e=this.source.get();return this.mapper(e)}}class eL{constructor({oidcApi:e,refreshToken:t,accessToken:r,accessTokenExpiresAt:i,anticipation:s,clock:o}){this._token=new J$({accessToken:r,accessTokenExpiresAt:i,refreshToken:t}),this._accessToken=this._token.map(a=>a.accessToken),this._anticipation=s,this._oidcApi=e,this._clock=o}async start(){this.needsRenewing&&await this.renew(),this._running=!0,this._renewingLoop()}stop(){this._running=!1,this._timeout&&this._timeout.dispose()}get needsRenewing(){return this._token.get().accessTokenExpiresAt-this._clock.now()-this._anticipation<0}async _renewingLoop(){for(;this._running;){const t=this._token.get().accessTokenExpiresAt-this._clock.now()-this._anticipation;if(t>0){this._timeout=this._clock.createTimeout(t);try{await this._timeout.elapsed()}catch{return}}await this.renew()}}async renew(){let e=this._token.get().refreshToken;const t=await this._oidcApi.refreshToken({refreshToken:e});if(typeof t.expires_in!="number")throw new Error("Refreshed access token does not expire");t.refresh_token&&(e=t.refresh_token),this._token.set({refreshToken:e,accessToken:t.access_token,accessTokenExpiresAt:this._clock.now()+t.expires_in*1e3})}get accessToken(){return this._accessToken}get token(){return this._token}}class N0{constructor(e){this._start=2e3,this._current=2e3;const t=2e3;this._start=t,this._current=t,this._createTimeout=e,this._max=60*5*1e3}async waitForRetry(){this._timeout=this._createTimeout(this._current);try{await this._timeout.elapsed();const e=2*this._current;this._current=Math.min(this._max,e)}catch(e){if(!(e instanceof ln))throw e}finally{this._timeout=void 0}}abort(){this._timeout&&this._timeout.abort()}reset(){this._current=this._start,this.abort()}get nextValue(){return this._current}}var b_=(n=>(n[n.Waiting=0]="Waiting",n[n.Reconnecting=1]="Reconnecting",n[n.Online=2]="Online",n))(b_||{});class tL{constructor({retryDelay:e,createMeasure:t,onlineStatus:r}){this._onlineStatus=r,this._retryDelay=e,this._createTimeMeasure=t,this._state=new hr(2),this._isReconnecting=!1}get lastVersionsResponse(){return this._versionsResponse}get connectionStatus(){return this._state}get retryIn(){return this._state.get()===0?this._retryDelay.nextValue-this._stateSince.measure():0}async onRequestFailed(e){if(!this._isReconnecting){this._isReconnecting=!0;const t=this._onlineStatus&&this._onlineStatus.subscribe(r=>{r&&this.tryNow()});try{await this._reconnectLoop(e)}catch(r){console.error(r)}finally{t&&t(),this._isReconnecting=!1}}}tryNow(){this._retryDelay&&this._retryDelay.abort()}_setState(e){e!==this._state.get()&&(e===0?this._stateSince=this._createTimeMeasure():this._stateSince=null,this._state.set(e))}async _reconnectLoop(e){for(this._versionsResponse=void 0,this._retryDelay.reset();!this._versionsResponse;)try{this._setState(1);const t=e.versions({timeout:3e4});this._versionsResponse=await t.response(),this._setState(2)}catch(t){if(t.name==="ConnectionError")this._setState(0),await this._retryDelay.waitForRetry();else throw t}}}async function nL(n,e,t){if(t===void 0||t.key===void 0||t.iv===void 0||t.hashes===void 0||t.hashes.sha256===void 0)throw new Error("Invalid info. Missing info.key, info.iv or info.hashes.sha256 key");const{crypto:r}=n,{base64:i}=n.encoding;var s=i.decode(t.iv),o=i.encode(i.decode(t.hashes.sha256));const a=await r.digest("SHA-256",e);if(i.encode(new Uint8Array(a))!=o)throw new Error("Mismatched SHA-256 digest");var c;return t.v=="v1"||t.v=="v2"?c=64:c=128,await r.aes.decryptCTR({jwkKey:t.key,iv:s,data:e,counterLength:c})}async function rL(n,e){const{crypto:t}=n,{base64:r}=n.encoding,i=await t.aes.generateIV(),s=await t.aes.generateKey("jwk",256),o=await e.readAsBuffer(),a=await t.aes.encryptCTR({jwkKey:s,iv:i,data:o}),c=await t.digest("SHA-256",a);return{blob:n.createBlob(a,"application/octet-stream"),info:{v:"v2",key:s,iv:r.encodeUnpadded(i),hashes:{sha256:r.encodeUnpadded(c)}}}}class iL{constructor({homeserver:e,platform:t}){this._homeserver=e,this._platform=t}mxcUrlThumbnail(e,t,r,i){const s=this._parseMxcUrl(e);if(s){const[o,a]=s;return`${this._homeserver}/_matrix/media/r0/thumbnail/${encodeURIComponent(o)}/${encodeURIComponent(a)}`+"?"+D0({width:Math.round(t),height:Math.round(r),method:i})}}mxcUrl(e){const t=this._parseMxcUrl(e);if(t){const[r,i]=t;return`${this._homeserver}/_matrix/media/r0/download/${encodeURIComponent(r)}/${encodeURIComponent(i)}`}}_parseMxcUrl(e){const t="mxc://";if(e.startsWith(t))return e.substr(t.length).split("/",2)}async downloadEncryptedFile(e,t=!1){const r=this.mxcUrl(e.url),{body:i}=await this._platform.request(r,{method:"GET",format:"buffer",cache:t}).response(),s=await nL(this._platform,i,e);return this._platform.createBlob(s,e.mimetype)}async downloadPlaintextFile(e,t,r=!1){const i=this.mxcUrl(e),{body:s}=await this._platform.request(i,{method:"GET",format:"buffer",cache:r}).response();return this._platform.createBlob(s,t)}async downloadAttachment(e,t=!1){var r;return e.file?this.downloadEncryptedFile(e.file,t):this.downloadPlaintextFile(e.url,(r=e.info)==null?void 0:r.mimetype,t)}}let sL=class{constructor(e,t){this.methodName=e,this.args=t,this._responsePromise=new Promise((r,i)=>{this.responseResolve=r,this.responseReject=i})}abort(){var e;this._requestResult?this._requestResult.abort():(this.responseReject(new ln),(e=this.responseCodeReject)==null||e.call(this,new ln))}response(){return this._responsePromise}responseCode(){return this.requestResult?this.requestResult.responseCode():(this._responseCodePromise||(this._responseCodePromise=new Promise((e,t)=>{this.responseCodeResolve=e,this.responseCodeReject=t})),this._responseCodePromise)}async setRequestResult(e){var t,r,i;this._requestResult=e;const s=await((t=this._requestResult)==null?void 0:t.response());this.responseResolve(s);const o=await((r=this._requestResult)==null?void 0:r.responseCode());(i=this.responseCodeResolve)==null||i.call(this,o)}get requestResult(){return this._requestResult}};class P0{constructor(e){this._scheduler=e}}for(const n of Object.getOwnPropertyNames(Di.prototype))n!=="constructor"&&!n.startsWith("_")&&(P0.prototype[n]=function(...e){return this._scheduler._hsApiRequest(n,e)});class oL{constructor({hsApi:e,clock:t}){this._requests=new Set,this._stopped=!1,this._wrapper=new P0(this),this._hsApi=e,this._clock=t}get hsApi(){return this._wrapper}stop(){this._stopped=!0;for(const e of this._requests)e.abort();this._requests.clear()}start(){this._stopped=!1}_hsApiRequest(e,t){const r=new sL(e,t);return this._doSend(r),r}async _doSend(e){this._requests.add(e);try{let t;for(;!this._stopped;)try{const r=this._hsApi[e.methodName].apply(this._hsApi,e.args);await e.setRequestResult(r);return}catch(r){if(r instanceof BE&&r.errcode==="M_LIMIT_EXCEEDED")Number.isSafeInteger(r.retry_after_ms)?await this._clock.createTimeout(r.retry_after_ms).elapsed():(t||(t=new N0(this._clock.createTimeout)),await t.waitForRetry());else{e.responseReject(r);return}}this._stopped&&e.abort()}finally{this._requests.delete(e)}}}const aL=3e4,ze=Po("InitialSync","CatchupSync","Syncing","Stopped");function lL(n){var e;try{const t=(e=n==null?void 0:n.timeline)==null?void 0:e.events;return Array.isArray(t)&&t.length===0}catch{return!0}}class cL{constructor({hsApi:e,session:t,storage:r,logger:i}){this._hsApi=e,this._logger=i,this._session=t,this._storage=r,this._currentRequest=null,this._status=new hr(ze.Stopped),this._error=null}get status(){return this._status}get error(){return this._error}start(){if(this._status.get()!==ze.Stopped)return;this._error=null;let e=this._session.syncToken;e?this._status.set(ze.CatchupSync):this._status.set(ze.InitialSync),this._syncLoop(e)}async _syncLoop(e){for(;this._status.get()!==ze.Stopped;){let t,r,i=this._status.get()===ze.CatchupSync||this._status.get()===ze.InitialSync;await this._logger.run("sync",async s=>{s.set("token",e),s.set("status",this._status.get());try{const o=this._status.get()===ze.Syncing?aL:0,a=await this._syncRequest(e,o,s);e=a.syncToken,t=a.roomStates,r=a.sessionChanges,this._status.get()!==ze.Syncing&&a.hadToDeviceMessages?this._status.set(ze.CatchupSync):this._status.set(ze.Syncing)}catch(o){if(o.name==="ConnectionError"&&o.isTimeout)return;this._error=o,o.name!=="AbortError"&&(s.error=o,s.logLevel=s.level.Fatal),s.set("stopping",!0),this._status.set(ze.Stopped)}this._status.get()!==ze.Stopped&&await s.wrap("afterSyncCompleted",o=>this._runAfterSyncCompleted(r,t,o))},this._logger.level.Info,(s,o)=>o.durationWithoutType("network")>=2e3||o.error||i?s.minLevel(o.level.Detail):s.minLevel(o.level.Info))}}async _runAfterSyncCompleted(e,t,r){const i=this._status.get()===ze.CatchupSync,s=(async()=>{try{await r.wrap("session",a=>this._session.afterSyncCompleted(e,i,a))}catch{}})(),o=t.map(async a=>{try{await a.room.afterSyncCompleted(a.changes,r)}catch{}});await Promise.all(o.concat(s))}async _syncRequest(e,t,r){var i;let{syncFilterId:s}=this._session;if(typeof s!="string")try{this._currentRequest=this._hsApi.createFilter(this._session.user.id,{room:{state:{lazy_load_members:!0}}},{log:r}),s=(await this._currentRequest.response()).filter_id}catch{r.log("Sync filters aren't available, falling back to no filter"),s="filteringNotAvailable"}const o=t+80*1e3;this._currentRequest=this._hsApi.sync(e,s==="filteringNotAvailable"?void 0:s,t,{timeout:o,log:r});const a=await this._currentRequest.response(),c=!e,u=new uL,l=this._parseInvites(a.rooms),{roomStates:d,archivedRoomStates:p}=await this._parseRoomsResponse(a.rooms,l,c,r);try{u.lock=await r.wrap("obtainSyncLock",()=>this._session.obtainSyncLock(a)),await r.wrap("prepare",w=>this._prepareSync(u,d,a,w)),await r.wrap("afterPrepareSync",w=>Promise.all(d.map(S=>S.room.afterPrepareSync(S.preparation,w)))),await r.wrap("write",async w=>this._writeSync(u,l,d,p,a,s,c,w))}finally{u.dispose()}r.wrap("after",w=>this._afterSync(u,l,d,p,w));const m=(i=a.to_device)==null?void 0:i.events;return{syncToken:a.next_batch,roomStates:d,sessionChanges:u.changes,hadToDeviceMessages:Array.isArray(m)&&m.length>0}}_openPrepareSyncTxn(){const e=this._storage.storeNames;return this._storage.readTxn([e.deviceKeys,e.olmSessions,e.inboundGroupSessions,e.timelineFragments,e.timelineEvents])}async _prepareSync(e,t,r,i){var s,o;const a=await this._openPrepareSyncTxn();e.preparation=await i.wrap("session",u=>this._session.prepareSync(r,e.lock,a,u));const c=(s=e.preparation)==null?void 0:s.newKeysByRoom;if(c){const{hasOwnProperty:u}=Object.prototype;for(const l of c.keys())if(!(((o=r.rooms)==null?void 0:o.join)&&u.call(r.rooms.join,l))){let p=this._session.rooms.get(l);p&&t.push(new Bv(p,!1,{},p.membership))}}await Promise.all(t.map(async u=>{const l=c==null?void 0:c.get(u.room.id);u.preparation=await i.wrap("room",async d=>(u.isNewRoom&&await u.room.load(null,a,d),u.room.prepareSync(u.roomResponse,u.membership,l,a,d)),i.level.Detail)})),await a.complete()}async _writeSync(e,t,r,i,s,o,a,c){const u=await this._openSyncTxn();try{e.changes=await c.wrap("session",l=>this._session.writeSync(s,o,e.preparation,u,l)),await Promise.all(t.map(async l=>{l.changes=await c.wrap("invite",d=>l.invite.writeSync(l.membership,l.roomResponse,u,d))})),await Promise.all(r.map(async l=>{l.changes=await c.wrap("room",d=>l.room.writeSync(l.roomResponse,a,l.preparation,u,d))})),await Promise.all(i.map(async l=>{var d;const p=(d=l.roomState)==null?void 0:d.summaryChanges;l.changes=await c.wrap("archivedRoom",m=>l.archivedRoom.writeSync(p,l.roomResponse,l.membership,u,m))}))}catch(l){throw u.abort(c),u.getCause(l)}await u.complete(c)}_afterSync(e,t,r,i,s){s.wrap("session",o=>this._session.afterSync(e.changes,o),s.level.Detail);for(let o of i)s.wrap("archivedRoom",a=>{o.archivedRoom.afterSync(o.changes,a),o.archivedRoom.release()},s.level.Detail);for(let o of r)s.wrap("room",a=>o.room.afterSync(o.changes,a),s.level.Detail);for(let o of t)s.wrap("invite",a=>o.invite.afterSync(o.changes,a),s.level.Detail);this._session.applyRoomCollectionChangesAfterSync(t,r,i,s)}_openSyncTxn(){const e=this._storage.storeNames;return this._storage.readWriteTxn([e.session,e.roomSummary,e.archivedRoomSummary,e.invites,e.roomState,e.roomMembers,e.timelineEvents,e.timelineRelations,e.timelineFragments,e.pendingEvents,e.userIdentities,e.groupSessionDecryptions,e.deviceKeys,e.outboundGroupSessions,e.operations,e.accountData,e.olmSessions,e.inboundGroupSessions,e.calls])}async _parseRoomsResponse(e,t,r,i){const s=[],o=[];if(e){const a=["join","leave"];for(const c of a){const u=e[c];if(u)for(const[l,d]of Object.entries(u)){if(r&&lL(d))continue;const p=this._session.invites.get(l);p&&t.push(new Vv(p,!1,null,c));const m=this._createRoomSyncState(l,d,c,r);m&&s.push(m);const w=await this._createArchivedRoomSyncState(l,m,d,c,r,i);w&&o.push(w)}}}return{roomStates:s,archivedRoomStates:o}}_createRoomSyncState(e,t,r,i){let s=!1,o=this._session.rooms.get(e);if(!o&&(r==="join"||i&&r==="leave")&&(o=this._session.createJoinedRoom(e),s=!0),o)return new Bv(o,s,t,r)}async _createArchivedRoomSyncState(e,t,r,i,s,o){let a;if(t!=null&&t.shouldAdd&&!s?a=this._session.createOrGetArchivedRoomForSync(e):i==="leave"&&(t?a=this._session.createOrGetArchivedRoomForSync(e):a=await this._session.loadArchivedRoom(e,o)),a)return new dL(a,t,r,i)}_parseInvites(e){const t=[];if(e!=null&&e.invite)for(const[r,i]of Object.entries(e.invite)){let s=this._session.invites.get(r),o=!1;s||(s=this._session.createInvite(r),o=!0),t.push(new Vv(s,o,i,"invite"))}return t}stop(){this._status.get()!==ze.Stopped&&(this._status.set(ze.Stopped),this._currentRequest&&(this._currentRequest.abort(),this._currentRequest=null))}}class uL{constructor(){this.lock=null,this.preparation=null,this.changes=null}dispose(){var e;(e=this.lock)==null||e.release()}}class Bv{constructor(e,t,r,i){this.room=e,this.isNewRoom=t,this.roomResponse=r,this.membership=i,this.preparation=null,this.changes=null}get id(){return this.room.id}get shouldAdd(){return this.isNewRoom&&this.membership==="join"}get shouldRemove(){return!this.isNewRoom&&this.membership!=="join"}get summaryChanges(){var e;return(e=this.changes)==null?void 0:e.summaryChanges}}class dL{constructor(e,t,r,i,s){this.archivedRoom=e,this.roomState=t,this.roomResponse=r,this.membership=i,this.isInitialSync=s,this.changes=null}get id(){return this.archivedRoom.id}get shouldAdd(){return(this.roomState||this.isInitialSync)&&this.membership==="leave"}get shouldRemove(){return this.membership==="join"}}class Vv{constructor(e,t,r,i){this.invite=e,this.isNewInvite=t,this.membership=i,this.roomResponse=r,this.changes=null}get id(){return this.invite.id}get shouldAdd(){return this.isNewInvite}get shouldRemove(){return this.membership!=="invite"}}function hL(n,e,t,r,i){return e.length&&(n=e.reduce((s,o)=>_L(s,o,t,r,i),n)),n}function fL(n,e,t,r){e.summary&&(n=gL(n,e.summary)),t!==n.membership&&(n=n.cloneIfNeeded(),n.membership=t),e.account_data&&(n=e.account_data.events.reduce(mL,n)),qs(e,s=>{n=O0(n,s,r)});const i=e.unread_notifications;return i&&(n=pL(n,i)),n}function pL(n,e){const t=e.highlight_count||0;t!==n.highlightCount&&(n=n.cloneIfNeeded(),n.highlightCount=t);const r=e.notification_count;return r!==n.notificationCount&&(n=n.cloneIfNeeded(),n.notificationCount=r),n}function mL(n,e){var t;if((e==null?void 0:e.type)==="m.tag"){let r=(t=e==null?void 0:e.content)==null?void 0:t.tags;(!r||Array.isArray(r)||typeof r!="object")&&(r=null),n=n.cloneIfNeeded(),n.tags=r}return n}function O0(n,e,t){var r,i,s,o,a;if(e.type==="m.room.create")n=n.cloneIfNeeded(),n.lastMessageTimestamp=e.origin_server_ts,n.type=(i=(r=e.content)==null?void 0:r.type)!=null?i:null;else if(e.type==="m.room.encryption"){const c=(s=e.content)==null?void 0:s.algorithm;!n.encryption&&c===Kn&&(n=n.cloneIfNeeded(),n.encryption=e.content)}else if(e.type==="m.room.name"){const c=(o=e.content)==null?void 0:o.name;c!==n.name&&(n=n.cloneIfNeeded(),n.name=c)}else if(e.type==="m.room.avatar"){const c=(a=e.content)==null?void 0:a.url;c!==n.avatarUrl&&(n=n.cloneIfNeeded(),n.avatarUrl=c)}else if(e.type==="m.room.canonical_alias"){const c=e.content;n=n.cloneIfNeeded(),n.canonicalAlias=c.alias}else if(e.type==="m.room.member"){const c=e.content;if(c.is_direct===!0&&c.membership==="invite"&&!n.isDirectMessage){let u;e.sender===t?u=e.state_key:e.state_key===t&&(u=e.sender),u&&(n=n.cloneIfNeeded(),n.isDirectMessage=!0,n.dmUserId=u)}else c.membership==="leave"&&n.isDirectMessage&&n.dmUserId===e.state_key&&(n=n.cloneIfNeeded(),n.isDirectMessage=!1,n.dmUserId=null)}return n}function _L(n,e,t,r,i){return e.eventType==="m.room.message"&&((!n.lastMessageTimestamp||e.timestamp>n.lastMessageTimestamp)&&(n=n.cloneIfNeeded(),n.lastMessageTimestamp=e.timestamp),!t&&e.sender!==i&&r&&(n=n.cloneIfNeeded(),n.isUnread=!0)),n}function gL(n,e){const t=e["m.heroes"],r=e["m.joined_member_count"],i=e["m.invited_member_count"];return t&&Array.isArray(t)&&(n=n.cloneIfNeeded(),n.heroes=t),Number.isInteger(i)&&(n=n.cloneIfNeeded(),n.inviteCount=i),Number.isInteger(r)&&(n=n.cloneIfNeeded(),n.joinCount=r),n}class sr{constructor(e,t){this.roomId=e?e.roomId:t,this.name=e?e.name:null,this.type=e?e.type:null,this.lastMessageTimestamp=e?e.lastMessageTimestamp:null,this.isUnread=e?e.isUnread:!1,this.encryption=e?e.encryption:null,this.membership=e?e.membership:null,this.inviteCount=e?e.inviteCount:0,this.joinCount=e?e.joinCount:0,this.heroes=e?e.heroes:null,this.canonicalAlias=e?e.canonicalAlias:null,this.hasFetchedMembers=e?e.hasFetchedMembers:!1,this.isTrackingMembers=e?e.isTrackingMembers:!1,this.avatarUrl=e?e.avatarUrl:null,this.notificationCount=e?e.notificationCount:0,this.highlightCount=e?e.highlightCount:0,this.tags=e?e.tags:null,this.isDirectMessage=e?e.isDirectMessage:!1,this.dmUserId=e?e.dmUserId:null,this.cloned=!!e}changedKeys(e){return Object.getOwnPropertyNames(this).filter(r=>r!=="cloned"&&this[r]!==e[r])}cloneIfNeeded(){return this.cloned?this:new sr(this)}serialize(){return Object.entries(this).reduce((e,[t,r])=>(t!=="cloned"&&r!==null&&(e[t]=r),e),{})}applyTimelineEntries(e,t,r,i){return hL(this,e,t,r,i)}applySyncResponse(e,t,r){return fL(this,e,t,r)}get needsHeroes(){return!this.name&&!this.canonicalAlias&&this.heroes&&this.heroes.length>0}isNewJoin(e){return this.membership==="join"&&e.membership!=="join"}}class yL{constructor(e){this._data=null,this.applyChanges(new sr(null,e))}get data(){return this._data}writeClearUnread(e){const t=new sr(this._data);return t.isUnread=!1,t.notificationCount=0,t.highlightCount=0,e.roomSummary.set(t.serialize()),t}writeHasFetchedMembers(e,t){const r=new sr(this._data);return r.hasFetchedMembers=e,t.roomSummary.set(r.serialize()),r}writeIsTrackingMembers(e,t){const r=new sr(this._data);return r.isTrackingMembers=e,t.roomSummary.set(r.serialize()),r}writeData(e,t){if(e!==this._data)return t.roomSummary.set(e.serialize()),e}writeArchivedData(e,t){if(e!==this._data)return t.archivedRoomSummary.set(e.serialize()),e}async writeAndApplyData(e,t){if(e===this._data)return!1;const r=await t.readWriteTxn([t.storeNames.roomSummary]);try{r.roomSummary.set(e.serialize())}catch(i){throw r.abort(),i}return await r.complete(),this.applyChanges(e),!0}applyChanges(e){this._data=e,this._data.cloned=!1}async load(e){this.applyChanges(new sr(e))}}const dp=Number.MAX_SAFE_INTEGER;class U0{constructor(e){this._fragmentIdComparer=e}compare(e){return this.fragmentId===e.fragmentId?this.entryIndex-e.entryIndex:this.fragmentId===dp?1:e.fragmentId===dp?-1:this._fragmentIdComparer.compare(this.fragmentId,e.fragmentId)}asEventKey(){return new We(this.fragmentId,this.entryIndex)}}const vL="m.reaction",oi="m.annotation";function wL(n,e){return{"m.relates_to":{event_id:n,key:e,rel_type:oi}}}function S_(n){var e;return n.event_id||((e=n["m.in_reply_to"])==null?void 0:e.event_id)}function $0(n,e){n.event_id!==void 0?n.event_id=e:n["m.in_reply_to"]&&(n["m.in_reply_to"].event_id=e)}function bL(n){if(n.type===Ln)return n.redacts;{const e=Pr(n);if(e)return S_(e)}return null}function fi(n){return n==null?void 0:n["m.relates_to"]}function Pr(n){return fi(n.content)}class SL{constructor(){this._entries=[]}get firstTimestamp(){return this._entries.reduce((e,t)=>t.isRedaction?e:Math.min(t.timestamp,e),Number.MAX_SAFE_INTEGER)}get annotationEntry(){return this._entries.find(e=>!e.isRedaction)}get redactionEntry(){return this._entries.find(e=>e.isRedaction)}get count(){return this._entries.reduce((e,t)=>e+(t.isRedaction?-1:1),0)}add(e){this._entries.push(e)}remove(e){const t=this._entries.indexOf(e);return t===-1?!1:(this._entries.splice(t,1),!0)}get willAnnotate(){const e=this._entries.reduce((t,r)=>!t||r.pendingEvent.queueIndex>t.pendingEvent.queueIndex?r:t,null);return e?!e.isRedaction:!1}get isEmpty(){return this._entries.length===0}}function Kv(n){return n.replace(/&/g,"&amp;").replace(/</g,"&lt;").replace(/>/g,"&gt;")}function EL(n){switch(n){case"m.file":return"sent a file.";case"m.image":return"sent an image.";case"m.video":return"sent a video.";case"m.audio":return"sent an audio file."}return null}function kL(n){return n==="m.emote"?"* ":""}function IL(n,e,t,r){return{msgtype:e,body:t,format:"org.matrix.custom.html",formatted_body:r,"m.relates_to":{"m.in_reply_to":{event_id:n}}}}function TL(n,e,t){const r=EL(n.content.msgtype),i=kL(n.content.msgtype),s=n.sender,o=n.displayName||s,a=r||n.content.formatted_body||n.content.body&&Kv(n.content.body)||"",c=`<mx-reply><blockquote>In reply to ${i}<a href="https://matrix.to/#/${s}">${o}</a><br />${a}</blockquote></mx-reply>`,l=(r||n.content.body||"").split(`
`);l[0]=`> ${i}<${s}> ${l[0]}`;const p=l.join(`
> `)+`

`+t,m=c+Kv(t);return IL(n.id,e,p,m)}class L0 extends U0{constructor(e){super(e),this._pendingRedactions=null,this._pendingAnnotations=null,this._contextEntry=null,this._contextForEntries=null}get isReply(){var e;return!!((e=this.relation)!=null&&e["m.in_reply_to"])}get isRedacting(){return!!this._pendingRedactions}get isRedacted(){return this.isRedacting}get isRedaction(){return this.eventType===Ln}get redactionReason(){var e;return this._pendingRedactions?(e=this._pendingRedactions[0].content)==null?void 0:e.reason:null}setContextEntry(e){this._contextEntry=e,e._setAsContextOf(this)}_setAsContextOf(e){this._contextForEntries||(this._contextForEntries=[]),this._contextForEntries.push(e)}get contextForEntries(){return this._contextForEntries}get contextEntry(){return this._contextEntry}addLocalRelation(e){if(e.eventType===Ln&&e.isRelatedToId(this.id)){if(this._pendingRedactions||(this._pendingRedactions=[]),this._pendingRedactions.push(e),this._pendingRedactions.length===1)return"isRedacted"}else{const t=e.redactingEntry||e;if(t.isRelatedToId(this.id)&&t.relation.rel_type===oi&&this._addPendingAnnotation(e))return"pendingAnnotations"}}removeLocalRelation(e){var t;if(e.eventType===Ln&&e.isRelatedToId(this.id)&&this._pendingRedactions){const r=this._pendingRedactions.length;if(this._pendingRedactions=this._pendingRedactions.filter(i=>i!==e),this._pendingRedactions.length===0&&(this._pendingRedactions=null,r!==0))return"isRedacted"}else{const r=e.redactingEntry||e;if(r.isRelatedToId(this.id)&&((t=r.relation)==null?void 0:t.rel_type)===oi&&this._pendingAnnotations&&this._removePendingAnnotation(e))return"pendingAnnotations"}}_addPendingAnnotation(e){this._pendingAnnotations||(this._pendingAnnotations=new Map);const{key:t}=(e.redactingEntry||e).relation;if(t){let r=this._pendingAnnotations.get(t);return r||(r=new SL,this._pendingAnnotations.set(t,r)),r.add(e),!0}return!1}_removePendingAnnotation(e){const{key:t}=(e.redactingEntry||e).relation;if(t){let r=this._pendingAnnotations.get(t);return r.remove(e)&&r.isEmpty&&this._pendingAnnotations.delete(t),this._pendingAnnotations.size===0&&(this._pendingAnnotations=null),!0}return!1}async abortPendingRedaction(){if(this._pendingRedactions)for(const e of this._pendingRedactions)await e.pendingEvent.abort()}get pendingRedaction(){return this._pendingRedactions?this._pendingRedactions[0]:null}annotate(e){return wL(this.id,e)}createReplyContent(e,t){return TL(this,e,t)}isRelatedToId(e){return e&&this.relatedEventId===e}haveAnnotation(e){var t,r,i;const s=((r=(t=this.annotations)==null?void 0:t[e])==null?void 0:r.me)||!1,o=(i=this.pendingAnnotations)==null?void 0:i.get(e),a=(o==null?void 0:o.willAnnotate)||!1;return s&&(!o||a)||!s&&a}get relation(){return fi(this.content)}get pendingAnnotations(){return this._pendingAnnotations}get annotations(){return null}}class RL extends L0{constructor({pendingEvent:e,member:t,clock:r,redactingEntry:i}){super(null),this._pendingEvent=e,this._member=t,this._timestamp=r.now()-(100-e.queueIndex),this._redactingEntry=i}get fragmentId(){return dp}get entryIndex(){return this._pendingEvent.queueIndex}get content(){return this._pendingEvent.content}get event(){return null}get eventType(){return this._pendingEvent.eventType}get stateKey(){return null}get sender(){var e;return(e=this._member)==null?void 0:e.userId}get displayName(){var e;return(e=this._member)==null?void 0:e.name}get avatarUrl(){var e;return(e=this._member)==null?void 0:e.avatarUrl}get timestamp(){return this._timestamp}get isPending(){return!0}get id(){return this._pendingEvent.txnId}get pendingEvent(){return this._pendingEvent}notifyUpdate(){}isRelatedToId(e){return e&&e===this._pendingEvent.relatedTxnId?!0:super.isRelatedToId(e)}get relatedEventId(){return this._pendingEvent.relatedEventId}get redactingEntry(){return this._redactingEntry}get contextEventId(){var e;return this.isReply?(e=this._pendingEvent.relatedEventId)!=null?e:this._pendingEvent.relatedTxnId:null}}const qe=Po("Waiting","EncryptingAttachments","UploadingAttachments","Encrypting","Sending","Sent","Error"),jv=["m.relates_to"];class CL{constructor({data:e,remove:t,emitUpdate:r,attachments:i}){this._data=e,this._attachments=i,this._emitUpdate=r,this._removeFromQueueCallback=t,this._aborted=!1,this._status=qe.Waiting,this._sendRequest=null,this._attachmentsTotalBytes=0,this._attachments&&(this._attachmentsTotalBytes=Object.values(this._attachments).reduce((s,o)=>s+o.size,0))}get roomId(){return this._data.roomId}get queueIndex(){return this._data.queueIndex}get eventType(){return this._data.eventType}get txnId(){return this._data.txnId}get remoteId(){return this._data.remoteId}get content(){return this._data.content}get relatedTxnId(){return this._data.relatedTxnId}get relatedEventId(){const e=fi(this.content);return e?S_(e):this._data.relatedEventId}setRelatedEventId(e){const t=fi(this.content);t?$0(t,e):this._data.relatedEventId=e}get data(){return this._data}getAttachment(e){return this._attachments&&this._attachments[e]}get needsSending(){return!this.remoteId&&!this.aborted}get needsEncryption(){return this._data.needsEncryption&&!this.aborted}get needsUpload(){return this._data.needsUpload&&!this.aborted}get isMissingAttachments(){return this.needsUpload&&!this._attachments}setEncrypting(){this._status=qe.Encrypting,this._emitUpdate("status")}get contentForEncryption(){const e=Object.assign({},this._data.content);for(const t of jv)delete e[t];return e}_preserveContentFields(e){const t=this._data.content;for(const r of jv)t[r]!==void 0&&(e[r]=t[r])}setEncrypted(e,t){this._preserveContentFields(t),this._data.encryptedEventType=e,this._data.encryptedContent=t,this._data.needsEncryption=!1}setError(e){this._status=qe.Error,this._error=e,this._emitUpdate("status")}setWaiting(){this._status=qe.Waiting,this._emitUpdate("status")}get status(){return this._status}get error(){return this._error}get hasStartedSending(){return this._status===qe.Sending||this._status===qe.Sent}get attachmentsTotalBytes(){return this._attachmentsTotalBytes}get attachmentsSentBytes(){return this._attachments&&Object.values(this._attachments).reduce((e,t)=>e+t.sentBytes,0)}async uploadAttachments(e,t){if(!this.needsUpload)return;if(!this._attachments)throw new Error("attachments missing");if(this.needsEncryption){this._status=qe.EncryptingAttachments,this._emitUpdate("status");for(const i of Object.values(this._attachments))if(await t.wrap("encrypt",()=>(t.set("size",i.size),i.encrypt())),this.aborted)throw new ln}this._status=qe.UploadingAttachments,this._emitUpdate("status");const r=Object.entries(this._attachments);r.sort(([,i],[,s])=>i.size-s.size);for(const[i,s]of r)await t.wrap("upload",o=>(o.set("size",s.size),s.upload(e,()=>{this._emitUpdate("attachmentsSentBytes")},o))),s.applyToContent(i,this.content);this._data.needsUpload=!1}async abort(){var e;if(!this._aborted){if(this._aborted=!0,this._attachments)for(const t of Object.values(this._attachments))t.abort();(e=this._sendRequest)==null||e.abort(),await this._removeFromQueueCallback()}}get aborted(){return this._aborted}async send(e,t){this._status=qe.Sending,this._emitUpdate("status");const r=this._data.encryptedEventType||this._data.eventType,i=this._data.encryptedContent||this._data.content;r===Ln?this._sendRequest=e.redact(this.roomId,this._data.relatedEventId,this.txnId,i,{log:t}):this._sendRequest=e.send(this.roomId,r,this.txnId,i,{log:t});const s=await this._sendRequest.response();this._sendRequest=null,this._data.remoteId=s.event_id,t.set("id",this._data.remoteId),this._status=qe.Sent,this._emitUpdate("status")}dispose(){if(this._attachments)for(const e of Object.values(this._attachments))e.dispose()}}class sn extends L0{constructor(e,t){super(t),this._eventEntry=e,this._decryptionError=null,this._decryptionResult=null}clone(){const e=new sn(this._eventEntry,this._fragmentIdComparer);return e.updateFrom(this),e}updateFrom(e){e._decryptionResult&&(this._decryptionResult=e._decryptionResult),e._decryptionError&&(this._decryptionError=e._decryptionError),this._contextForEntries=e.contextForEntries,this._contextEntry=e.contextEntry}get event(){return this._eventEntry.event}get fragmentId(){return this._eventEntry.fragmentId}get entryIndex(){return this._eventEntry.eventIndex}get content(){var e,t;return((t=(e=this._decryptionResult)==null?void 0:e.event)==null?void 0:t.content)||this._eventEntry.event.content}get prevContent(){return ap(this._eventEntry.event)}get eventType(){var e,t;return((t=(e=this._decryptionResult)==null?void 0:e.event)==null?void 0:t.type)||this._eventEntry.event.type}get stateKey(){return this._eventEntry.event.state_key}get sender(){return this._eventEntry.event.sender}get displayName(){return this._eventEntry.displayName}get avatarUrl(){return this._eventEntry.avatarUrl}get timestamp(){return this._eventEntry.event.origin_server_ts}get id(){return this._eventEntry.event.event_id}setDecryptionResult(e){this._decryptionResult=e}get isEncrypted(){return this._eventEntry.event.type==="m.room.encrypted"}get isDecrypted(){var e;return!!((e=this._decryptionResult)!=null&&e.event)}get isVerified(){var e;return this.isEncrypted&&((e=this._decryptionResult)==null?void 0:e.isVerified)}get isUnverified(){var e;return this.isEncrypted&&((e=this._decryptionResult)==null?void 0:e.isUnverified)}setDecryptionError(e){this._decryptionError=e}get decryptionError(){return this._decryptionError}get relatedEventId(){return bL(this.event)}get isRedacted(){return super.isRedacted||lp(this._eventEntry.event)}get redactionReason(){var e,t;const r=(e=this._eventEntry.event.unsigned)==null?void 0:e.redacted_because;return r?(t=r.content)==null?void 0:t.reason:super.redactionReason}get annotations(){return this._eventEntry.annotations}get relation(){const e=this._eventEntry.event.content;return e&&fi(e)||fi(this.content)}get contextEventId(){return this.isReply?this.relatedEventId:null}}function E_(n){return typeof n=="number"}const ML=["event_id","type","room_id","user_id","sender","state_key","prev_state","content","unsigned","origin_server_ts"].reduce(function(n,e){return n[e]=1,n},{}),xL={"m.room.member":{membership:1},"m.room.create":{creator:1},"m.room.join_rules":{join_rule:1},"m.room.power_levels":{ban:1,events:1,events_default:1,kick:1,redact:1,state_default:1,users:1,users_default:1},"m.room.aliases":{aliases:1}};function AL(n,e){for(const i of Object.keys(e))ML[i]||delete e[i];const{content:t}=e,r=xL[e.type];for(const i of Object.keys(t))r!=null&&r[i]||delete t[i];e.unsigned=e.unsigned||{},e.unsigned.redacted_because=n}function DL(n,e){const t=[];for(;E_(n.previousId);){const r=e.get(n.previousId);if(!r)break;if(r.nextId!==n.id)throw new Error(`Previous fragment ${r.id} doesn't point back to ${n.id}`);e.delete(n.previousId),t.unshift(r),n=r}return t}function NL(n,e){const t=[];for(;E_(n.nextId);){const r=e.get(n.nextId);if(!r)break;if(r.previousId!==n.id)throw new Error(`Next fragment ${r.id} doesn't point back to ${n.id}`);e.delete(n.nextId),t.push(r),n=r}return t}function PL(n){const e=new Map;for(let r of n)e.set(r.id,r);const t=[];for(;e.size;){const r=e.values().next().value;e.delete(r.id);const i=DL(r,e),s=NL(r,e),o=i.concat(r,s);t.push(o)}return t.map(r=>new OL(r))}class jh{constructor(e,t,r){this.id=e,this.previousId=t,this.nextId=r}}class OL{constructor(e){this._idToSortIndex=new Map,e.forEach((t,r)=>{this._idToSortIndex.set(t.id,r)})}compare(e,t){const r=this._idToSortIndex.get(e);if(r===void 0)throw new Error(`first id ${e} isn't part of this island`);const i=this._idToSortIndex.get(t);if(i===void 0)throw new Error(`second id ${t} isn't part of this island`);return r-i}get fragmentIds(){return this._idToSortIndex.keys()}}class Hv extends Error{get name(){return"CompareError"}}class UL{constructor(e){this._fragmentsById=e.reduce((t,r)=>(t.set(r.id,r),t),new Map),this.rebuild(e)}_getIsland(e){const t=this._idToIsland.get(e);if(t===void 0)throw new Hv(`Unknown fragment id ${e}`);return t}compare(e,t){if(e===t)return 0;const r=this._getIsland(e),i=this._getIsland(t);if(r!==i)throw new Hv(`${e} and ${t} are on different islands, can't tell order`);return r.compare(e,t)}rebuild(e){const t=PL(e);this._idToIsland=new Map;for(let r of t)for(let i of r.fragmentIds)this._idToIsland.set(i,r)}add(e){const t=new jh(e.id,e.previousId,e.nextId);this._fragmentsById.set(e.id,t),this.rebuild(this._fragmentsById.values())}append(e,t){const r=new jh(e,t,null),i=this._fragmentsById.get(t);i&&(i.nextId=e),this._fragmentsById.set(e,r),this.rebuild(this._fragmentsById.values())}prepend(e,t){const r=new jh(e,null,t),i=this._fragmentsById.get(t);i&&(i.previousId=e),this._fragmentsById.set(e,r),this.rebuild(this._fragmentsById.values())}}class F0{constructor({roomId:e,ownUserId:t,fragmentIdComparer:r}){this._roomId=e,this._ownUserId=t,this._fragmentIdComparer=r}async writeRelation(e,t,r){const{relatedEventId:i}=e;if(i){const s=Pr(e.event);s&&s.rel_type&&t.timelineRelations.add(this._roomId,s.event_id,s.rel_type,e.id);const o=await t.timelineEvents.getByEventId(this._roomId,i);if(o){const a=await this._applyRelation(e,o,t,r);if(a)return a.map(c=>(t.timelineEvents.update(c),new sn(c,this._fragmentIdComparer)))}}return null}async writeGapRelation(e,t,r,i){const s=new sn(e,this._fragmentIdComparer),o=await this.writeRelation(s,r,i);if(t.isBackward&&!lp(e.event)){const a=await r.timelineRelations.getAllForTarget(this._roomId,s.id);if(a.length)for(const c of a){const u=await r.timelineEvents.getByEventId(this._roomId,c.sourceEventId);if(u){const l=new sn(u,this._fragmentIdComparer);await this._applyRelation(l,e,r,i)}}}return o}async _applyRelation(e,t,r,i){if(e.eventType===Ln)return i.wrap("redact",async s=>{const o=t.event,a=Pr(o);if(this._applyRedaction(e.event,t,r,s)){const u=[t];if(a){const l=await this._reaggregateRelation(o,a,r,s);l&&u.push(l)}return u}return null});{const s=Pr(e.event);if(s&&!lp(t.event)&&s.rel_type===oi&&i.wrap("react",c=>this._aggregateAnnotation(e.event,t,c)))return[t]}return null}_applyRedaction(e,t,r,i){const s=t.event;i.set("redactionId",e.event_id),i.set("id",s.event_id);const o=Pr(s);return o&&o.rel_type&&r.timelineRelations.remove(this._roomId,o.event_id,o.rel_type,s.event_id),r.timelineRelations.removeAllForTarget(this._roomId,s.event_id),AL(e,s),delete t.annotations,!0}_aggregateAnnotation(e,t){const r=Pr(e);if(!r)return!1;let{annotations:i}=t;i||(t.annotations=i={});let s=i[r.key];s||(i[r.key]=s={count:0,me:!1,firstTimestamp:Number.MAX_SAFE_INTEGER});const o=e.sender===this._ownUserId;return s.me=s.me||o,s.count+=1,s.firstTimestamp=Math.min(s.firstTimestamp,e.origin_server_ts),!0}async _reaggregateRelation(e,t,r,i){return t.rel_type===oi?i.wrap("reaggregate annotations",s=>this._reaggregateAnnotation(t.event_id,t.key,r,s)):null}async _reaggregateAnnotation(e,t,r,i){const s=await r.timelineEvents.getByEventId(this._roomId,e);if(!s||!s.annotations)return null;i.set("id",e);const o=await r.timelineRelations.getForTargetAndType(this._roomId,e,oi);return i.set("relations",o.length),delete s.annotations[t],$L(s.annotations)&&delete s.annotations,await Promise.all(o.map(async a=>{const c=await r.timelineEvents.getByEventId(this._roomId,a.sourceEventId);c||i.log({l:"missing annotation",id:a.sourceEventId}),Pr(c.event).key===t&&this._aggregateAnnotation(c.event,s,i)})),s}}function $L(n){for(const e in n)if(n.hasOwnProperty(e))return!1;return!0}class wr{constructor(e){this.isForward=e}get isBackward(){return!this.isForward}asApiString(){return this.isForward?"f":"b"}reverse(){return this.isForward?wr.Backward:wr.Forward}static get Forward(){return LL}static get Backward(){return FL}}const LL=new wr(!0),FL=new wr(!1);class yn extends U0{constructor(e,t,r){super(r),this._fragment=e,this._isFragmentStart=t}static start(e,t){return new yn(e,!0,t)}static end(e,t){return new yn(e,!1,t)}get started(){return this._isFragmentStart}get hasEnded(){return!this.started}get fragment(){return this._fragment}get fragmentId(){return this._fragment.id}get entryIndex(){return this.started?Le.minStorageKey:Le.maxStorageKey}get isGap(){return!!this.token&&!this.edgeReached}get token(){return this.started?this.fragment.previousToken:this.fragment.nextToken}set token(e){this.started?this.fragment.previousToken=e:this.fragment.nextToken=e}get edgeReached(){return this.started?this.fragment.startReached:this.fragment.endReached}set edgeReached(e){this.started?this.fragment.startReached=e:this.fragment.endReached=e}get linkedFragmentId(){return this.started?this.fragment.previousId:this.fragment.nextId}set linkedFragmentId(e){this.started?this.fragment.previousId=e:this.fragment.nextId=e}get hasLinkedFragment(){return E_(this.linkedFragmentId)}get direction(){return this.started?wr.Backward:wr.Forward}withUpdatedFragment(e){return new yn(e,this._isFragmentStart,this._fragmentIdComparer)}createNeighbourEntry(e){return new yn(e,!this._isFragmentStart,this._fragmentIdComparer)}addLocalRelation(){}removeLocalRelation(){}}function BL(n){const e=new Set;return n.filter(t=>e.has(t.event_id)?!1:(e.add(t.event_id),!0))}class VL{constructor({roomId:e,fragmentIdComparer:t,memberWriter:r,relationWriter:i}){this._roomId=e,this._memberWriter=r,this._relationWriter=i,this._fragmentIdComparer=t,this._lastLiveKey=null}async load(e,t){const r=await e.timelineFragments.liveFragment(this._roomId);if(r){const[i]=await e.timelineEvents.lastEvents(this._roomId,r.id,1),s=i?i.eventIndex:We.defaultLiveKey.eventIndex;this._lastLiveKey=new We(r.id,s)}this._lastLiveKey&&t.set("live key",this._lastLiveKey.toString())}async _createLiveFragment(e,t){const r=await e.timelineFragments.liveFragment(this._roomId);if(r)return r;{t||(t=null);const i={roomId:this._roomId,id:We.defaultLiveKey.fragmentId,previousId:null,nextId:null,previousToken:t,nextToken:null};return e.timelineFragments.add(i),this._fragmentIdComparer.add(i),i}}async _replaceLiveFragment(e,t,r,i){const s=await i.timelineFragments.get(this._roomId,e);if(!s)throw new Error(`old live fragment doesn't exist: ${e}`);s.nextId=t,i.timelineFragments.update(s);const o={roomId:this._roomId,id:t,previousId:e,nextId:null,previousToken:r,nextToken:null};return i.timelineFragments.add(o),this._fragmentIdComparer.append(t,e),{oldFragment:s,newFragment:o}}async _ensureLiveFragment(e,t,r,i,s){if(e){if(r.limited){const o=e.fragmentId;e=e.nextFragmentKey();const{oldFragment:a,newFragment:c}=await this._replaceLiveFragment(o,e.fragmentId,r.prev_batch,i);t.push(yn.end(a,this._fragmentIdComparer)),t.push(yn.start(c,this._fragmentIdComparer)),s.log({l:"live fragment",limited:!0,id:e.fragmentId})}}else{let o=await this._createLiveFragment(i,r.prev_batch);e=new We(o.id,We.defaultLiveKey.eventIndex),t.push(yn.start(o,this._fragmentIdComparer)),s.log({l:"live fragment",first:!0,id:e.fragmentId})}return e}async _writeStateEvents(e,t,r){let i=0;for(const s of e)s.type!==zt&&(t.roomState.set(this._roomId,s),i+=1);r.set("stateEvents",i)}async _writeTimeline(e,t,r,i,s,o){const a=[],c=[];if(e!=null&&e.length){i=await this._ensureLiveFragment(i,a,t,s,o),o.set("timelineEvents",e.length);let u=0;for(const l of e){i=i.nextKey();const d=XE(i,this._roomId,l);let p=await r.lookupMemberAtEvent(l.sender,l,s);if(p&&(d.displayName=p.displayName,d.avatarUrl=p.avatarUrl),!await s.timelineEvents.tryInsert(d,o))continue;const w=new sn(d,this._fragmentIdComparer);a.push(w);const S=await this._relationWriter.writeRelation(w,s,o);S&&c.push(...S),typeof l.state_key=="string"&&l.type!==zt&&(u+=1,s.roomState.set(this._roomId,l))}o.set("timelineStateEventCount",u)}return{currentKey:i,entries:a,updatedEntries:c}}async _handleRejoinOverlap(e,t,r){if(this._lastLiveKey){const{fragmentId:i}=this._lastLiveKey,[s]=await t.timelineEvents.lastEvents(this._roomId,i,1);if(s){const o=s.event.event_id,{events:a}=e,c=a.findIndex(u=>u.event_id===o);if(c!==-1)return r.set("overlap_event_id",o),Object.assign({},e,{limited:!1,events:a.slice(c+1)})}}return e.limited?e:(r.set("force_limited_without_overlap",!0),Object.assign({},e,{limited:!0}))}async writeSync(e,t,r,i,s){let{timeline:o}=e;s.set("isRejoin",t),t&&(o=await this._handleRejoinOverlap(o,i,s));let a;Array.isArray(o==null?void 0:o.events)&&(a=BL(o.events));const{state:c}=e;let u;Array.isArray(c==null?void 0:c.events)&&(u=c.events);const l=this._memberWriter.prepareMemberSync(u,a,r);u&&await this._writeStateEvents(u,i,s);const{currentKey:d,entries:p,updatedEntries:m}=await this._writeTimeline(a,o,l,this._lastLiveKey,i,s),w=await l.write(i);return{entries:p,updatedEntries:m,newLiveKey:d,memberChanges:w,memberSync:l}}afterSync(e){this._lastLiveKey=e}get lastMessageKey(){return this._lastLiveKey}}class B0{constructor(e){this.limit=e,this._entries=[]}get size(){return this._entries.length}_get(e){return this._getByIndexAndMoveUp(this._entries.findIndex(e))}_getByIndexAndMoveUp(e){if(e!==-1){const t=this._entries[e];return e>0&&(this._entries.splice(e,1),this._entries.unshift(t)),t}}_set(e,t){let r=t?this._entries.findIndex(t):-1;this._entries.unshift(e),r===-1?this._entries.length>this.limit&&(r=this._entries.length-1):r+=1,r!==-1&&(this.onEvictEntry(this._entries[r]),this._entries.splice(r,1))}onEvictEntry(e){}}class V0 extends B0{constructor(e,t){super(e),this._keyFn=t}get(e){return this._get(t=>this._keyFn(t)===e)}set(e){const t=this._keyFn(e);this._set(e,r=>this._keyFn(r)===t)}}class KL{constructor(e){this._roomId=e,this._cache=new V0(5,t=>t.userId)}prepareMemberSync(e,t,r){return new jL(this,e,t,r)}async _writeMember(e,t){let r=this._cache.get(e.userId);if(!r){const i=await t.roomMembers.get(this._roomId,e.userId);i&&(r=new ye(i))}if(!r||!r.equals(e))return t.roomMembers.set(e.serialize()),this._cache.set(e),new QE(e,r==null?void 0:r.membership)}async lookupMember(e,t){let r=this._cache.get(e);if(!r){const i=await t.roomMembers.get(this._roomId,e);i&&(r=new ye(i),this._cache.set(r))}return r}}class jL{constructor(e,t,r,i){this._memberWriter=e,this._timelineEvents=r,this._hasFetchedMembers=i,this._newStateMembers=null,t&&(this._newStateMembers=this._stateEventsToMembers(t))}get _roomId(){return this._memberWriter._roomId}_stateEventsToMembers(e){let t;for(const r of e)if(r.type===zt){const i=ye.fromMemberEvent(this._roomId,r);i&&(t||(t=new Map),t.set(i.userId,i))}return t}_timelineEventsToMembers(e){let t;for(let r=e.length-1;r>=0;r--){const i=e[r],s=i.state_key;if(i.type===zt&&!(t!=null&&t.has(s))){const o=ye.fromMemberEvent(this._roomId,i);o&&(t||(t=new Map),t.set(o.userId,o))}}return t}async lookupMemberAtEvent(e,t,r){var i;let s;return this._timelineEvents&&(s=this._findPrecedingMemberEventInTimeline(e,t),s)||(s=(i=this._newStateMembers)==null?void 0:i.get(e),s)?s:await this._memberWriter.lookupMember(e,r)}async write(e){const t=new Map;let r;if(this._timelineEvents&&(r=this._timelineEventsToMembers(this._timelineEvents)),this._newStateMembers){for(const i of this._newStateMembers.values())if(!(r!=null&&r.has(i.userId))){const s=await this._memberWriter._writeMember(i,e);s&&(!this._hasFetchedMembers&&!s.previousMembership&&(s.previousMembership=i.membership),t.set(s.userId,s))}}if(r)for(const i of r.values()){const s=await this._memberWriter._writeMember(i,e);s&&t.set(s.userId,s)}return t}_findPrecedingMemberEventInTimeline(e,t){let r=-1;for(let i=this._timelineEvents.length-1;i>=0;i--)if(this._timelineEvents[i].event_id===t.event_id){r=i;break}for(let i=r-1;i>=0;i--){const s=this._timelineEvents[i];if(s.type===zt&&s.state_key===e){const o=ye.fromMemberEvent(this._roomId,s);if(o)return o}}}}class HL{constructor({roomId:e,storage:t,fragmentIdComparer:r,relationWriter:i}){this._roomId=e,this._storage=t,this._fragmentIdComparer=r,this._relationWriter=i}async _findOverlappingEvents(e,t,r,i){const s=t.map(u=>u.event_id),o=await r.timelineEvents.getEventKeysForIds(this._roomId,s);i.set("existingEvents",o.size);const a=t.filter(u=>!o.has(u.event_id));i.set("nonOverlappingEvents",a.length);let c;if(e.hasLinkedFragment){i.set("linkedFragmentId",e.linkedFragmentId);for(const u of o.values())if(u.fragmentId===e.linkedFragmentId){i.set("foundLinkedFragment",!0);const l=await r.timelineFragments.get(this._roomId,e.linkedFragmentId);c=e.createNeighbourEntry(l);break}}return{nonOverlappingEvents:a,neighbourFragmentEntry:c}}async _findFragmentEdgeEventKey(e,t){const{fragmentId:r,direction:i}=e,s=await this._findFragmentEdgeEvent(r,i,t);return s?new We(s.fragmentId,s.eventIndex):We.defaultFragmentKey(e.fragmentId)}async _findFragmentEdgeEvent(e,t,r){if(t.isBackward){const[i]=await r.timelineEvents.firstEvents(this._roomId,e,1);return i}else{const[i]=await r.timelineEvents.lastEvents(this._roomId,e,1);return i}}async _storeEvents(e,t,r,i,s,o){const a=[],c=[];let u=t;for(let l=0;l<e.length;++l){const d=e[l];u=u.nextKeyForDirection(r);const p=XE(u,this._roomId,d),m=this._findMember(d.sender,i,e,l,r);m&&(p.displayName=m.displayName,p.avatarUrl=m.avatarUrl);const w=await this._relationWriter.writeGapRelation(p,r,s,o);if(w&&c.push(...w),await s.timelineEvents.tryInsert(p,o)){const S=new sn(p,this._fragmentIdComparer);La(a,S,r)}}return{entries:a,updatedEntries:c}}_findMember(e,t,r,i,s){function o(u){return u.type===zt&&u.state_key===e}const a=s.isBackward?1:-1;for(let u=i+a;u>=0&&u<r.length;u+=a){const l=r[u];if(o(l))return ye.fromMemberEvent(this._roomId,l)}for(let u=i;u>=0&&u<r.length;u-=a){const l=r[u];if(o(l))return ye.fromReplacingMemberEvent(this._roomId,l)}const c=t==null?void 0:t.find(o);if(c)return ye.fromMemberEvent(this._roomId,c)}async _updateFragments(e,t,r,i,s,o){const{direction:a}=e,c=[];return La(i,e,a),t?(o.set("closedGapWith",t.fragmentId),t.token=null,e.token=null,s.timelineFragments.update(t.fragment),La(i,t,a),c.push(e.fragment),c.push(t.fragment)):e.token=r,s.timelineFragments.update(e.fragment),c}async writeFragmentFill(e,t,r,i,s){const{fragmentId:o,direction:a}=e,{chunk:c,state:u}=t;let{end:l}=t;if(!Array.isArray(c))throw new Error("Invalid chunk in response");if(typeof l!="string"&&typeof l<"u")throw new Error("Invalid end token in response");const d=await i.timelineFragments.get(this._roomId,o);if(!d)throw new Error(`Unknown fragment: ${o}`);if(e=e.withUpdatedFragment(d),e.token!==r)throw new Error("The pagination token has changed locally while fetching messages.");if(c.length===0)return e.edgeReached=!0,await i.timelineFragments.update(e.fragment),{entries:[e],updatedEntries:[],fragments:[]};let p=await this._findFragmentEdgeEventKey(e,i);s.set("lastKey",p.toString());const{nonOverlappingEvents:m,neighbourFragmentEntry:w}=await this._findOverlappingEvents(e,c,i,s),{entries:S,updatedEntries:v}=await this._storeEvents(m,p,a,u,i,s),_=await this._updateFragments(e,w,l,S,i,s);return{entries:S,updatedEntries:v,fragments:_}}}class zv{constructor(e,t){this.decryptRequest=null,this._promise=e(this,t)}complete(){return this._promise}dispose(){this.decryptRequest&&(this.decryptRequest.dispose(),this.decryptRequest=null)}}async function zL(n,e,t,r,i,s){let o=[];const a=s.timelineEvents,c=s.timelineFragments;for(;o.length<r&&e;){let u;t.isForward?u=await a.eventsAfter(n,e,r):u=await a.eventsBefore(n,e,r);let l=u.map(d=>new sn(d,i));if(o=IN(o,l,t),o.length<r){const d=await c.get(n,e.fragmentId);let p=new yn(d,t.isBackward,i);if(La(o,p,t),!p.token&&p.hasLinkedFragment){const m=await c.get(n,p.linkedFragmentId);i.add(m);const w=new yn(m,t.isForward,i);La(o,w,t),e=w.asEventKey()}else e=null}}return o}class K0{constructor({roomId:e,storage:t,fragmentIdComparer:r}){this._roomId=e,this._storage=t,this._fragmentIdComparer=r,this._decryptEntries=null}enableEncryption(e){this._decryptEntries=e}get readTxnStores(){const e=[this._storage.storeNames.timelineEvents,this._storage.storeNames.timelineFragments];return this._decryptEntries&&e.push(this._storage.storeNames.inboundGroupSessions),e}readFrom(e,t,r,i){return new zv(async(s,o)=>{const a=await this._storage.readTxn(this.readTxnStores);return await this._readFrom(e,t,r,s,a,o)},i)}readFromEnd(e,t=null,r){return new zv(async(i,s)=>{const o=t||await this._storage.readTxn(this.readTxnStores),a=await o.timelineFragments.liveFragment(this._roomId);let c;if(!a)c=[];else{this._fragmentIdComparer.add(a);const u=yn.end(a,this._fragmentIdComparer),l=u.asEventKey();c=await this._readFrom(l,wr.Backward,e,i,o,s),c.unshift(u)}return c},r)}async readById(e,t){let r=[this._storage.storeNames.timelineEvents];this._decryptEntries&&r.push(this._storage.storeNames.inboundGroupSessions);const i=await this._storage.readTxn(r),s=await i.timelineEvents.getByEventId(this._roomId,e);if(s){const o=new sn(s,this._fragmentIdComparer);return this._decryptEntries&&await this._decryptEntries([o],i,t).complete(),o}}async _readFrom(e,t,r,i,s,o){const a=await zL(this._roomId,e,t,r,this._fragmentIdComparer,s);if(this._decryptEntries){i.decryptRequest=this._decryptEntries(a,s,o);try{await i.decryptRequest.complete()}finally{i.decryptRequest=null}}return a}}class GL extends sn{get fragmentId(){throw new Error("Cannot access fragmentId for non-persisted EventEntry")}get entryIndex(){throw new Error("Cannot access entryIndex for non-persisted EventEntry")}get isNonPersisted(){return!0}get isRedacting(){return!1}get isRedacted(){return super.isRedacting}}class qL{constructor(e){this._userId=e}get id(){return this._userId}}class ju{constructor({roomId:e,storage:t,closeCallback:r,fragmentIdComparer:i,pendingEvents:s,clock:o,powerLevelsObservable:a,hsApi:c}){this._roomId=e,this._storage=t,this._closeCallback=r,this._fragmentIdComparer=i,this._disposables=new Al,this._pendingEvents=s,this._clock=o,this._remoteEntries=new KE((u,l)=>u.compare(l)),this._ownMember=null,this._timelineReader=new K0({roomId:this._roomId,storage:this._storage,fragmentIdComparer:this._fragmentIdComparer}),this._readerRequest=null,this._allEntries=null,this._contextEntriesNotInTimeline=new Map,this._decryptEntries=null,this._hsApi=c,this.initializePowerLevels(a)}initializePowerLevels(e){e&&(this._powerLevels=e.get(),this._disposables.track(e.subscribe(t=>this._powerLevels=t)))}async load(e,t,r){const i=await this._storage.readTxn(this._timelineReader.readTxnStores.concat(this._storage.storeNames.roomMembers,this._storage.storeNames.roomState)),s=await i.roomMembers.get(this._roomId,e.id);s?this._ownMember=new ye(s):this._ownMember=ye.fromUserId(this._roomId,e.id,t);const o=this._disposables.track(this._timelineReader.readFromEnd(20,i,r));try{const a=await o.complete();this._loadContextEntriesWhereNeeded(a),this._setupEntries(a)}finally{this._disposables.disposeTracked(o)}}_setupEntries(e){this._remoteEntries.setManySorted(e),this._pendingEvents?this._localEntries=new XD(this._pendingEvents,t=>this._mapPendingEventToEntry(t),(t,r)=>{t.notifyUpdate(r)},t=>this._applyAndEmitLocalRelationChange(t,r=>r.removeLocalRelation(t))):this._localEntries=new KD,this._allEntries=new tN(this._remoteEntries,this._localEntries)}async _mapPendingEventToEntry(e){let t;e.eventType===Ln&&(t=await this._getOrLoadEntry(e.relatedTxnId,e.relatedEventId));const r=new RL({pendingEvent:e,member:this._ownMember,clock:this._clock,redactingEntry:t});return this._loadContextEntriesWhereNeeded([r]),this._applyAndEmitLocalRelationChange(r,i=>i.addLocalRelation(r)),r}_applyAndEmitLocalRelationChange(e,t){var r,i;const s=o=>{const a=t(o);return a||!1};if(this._findAndUpdateEntryById(e.pendingEvent.relatedTxnId,e.relatedEventId,s),e.redactingEntry){const o=(r=e.redactingEntry.pendingEvent)==null?void 0:r.relatedTxnId;this._findAndUpdateEntryById(o,e.redactingEntry.relatedEventId,s),(i=e.redactingEntry.contextForEntries)==null||i.forEach(a=>this._emitUpdateForEntry(a,"contextEntry"))}}_findAndUpdateEntryById(e,t,r){let i=!1;e&&(i=this._localEntries.findAndUpdate(s=>s.id===e,r)),!i&&t&&this._remoteEntries.findAndUpdate(s=>s.id===t,r)}async getOwnAnnotationEntry(e,t){const r=await this._storage.readWriteTxn([this._storage.storeNames.timelineEvents,this._storage.storeNames.timelineRelations]),i=await r.timelineRelations.getForTargetAndType(this._roomId,e,oi);for(const s of i){const o=await r.timelineEvents.getByEventId(this._roomId,s.sourceEventId);if(o&&o.event.sender===this._ownMember.userId&&Pr(o.event).key===t){const a=new sn(o,this._fragmentIdComparer);return this._addLocalRelationsToNewRemoteEntries([a]),a}}return null}updateOwnMember(e){this._ownMember=e}_addLocalRelationsToNewRemoteEntries(e){var t;if((t=this._localEntries)!=null&&t.hasSubscriptions)for(const r of this._localEntries){if(r.relatedEventId){const i=e.find(s=>s.id===r.relatedEventId);i==null||i.addLocalRelation(r)}if(r.redactingEntry){const i=r.redactingEntry.relatedEventId,s=e.find(o=>o.id===i);s==null||s.addLocalRelation(r)}}}static _entryUpdater(e,t){var r;return(r=e.contextForEntries)==null||r.forEach(i=>i.setContextEntry(t)),t.updateFrom(e),t}replaceEntries(e){var t;this._addLocalRelationsToNewRemoteEntries(e);for(const r of e)try{this._remoteEntries.getAndUpdate(r,ju._entryUpdater);const i=this._contextEntriesNotInTimeline.get(r.id);i&&(ju._entryUpdater(i,r),this._contextEntriesNotInTimeline.set(r.id,r)),(t=r.contextForEntries)==null||t.forEach(s=>this._emitUpdateForEntry(s,"contextEntry"))}catch(i){if(i.name==="CompareError")continue;throw i}}addEntries(e){this._addLocalRelationsToNewRemoteEntries(e),this._updateEntriesFetchedFromHomeserver(e),this._moveEntryToRemoteEntries(e),this._loadContextEntriesWhereNeeded(e),this._remoteEntries.setManySorted(e)}_updateEntriesFetchedFromHomeserver(e){var t;for(const r of e){const i=this._contextEntriesNotInTimeline.get(r.relatedEventId);i!=null&&i.isNonPersisted&&(i!=null&&i.addLocalRelation(r))&&((t=i.contextForEntries)==null||t.forEach(s=>this._emitUpdateForEntry(s,"contextEntry")))}}_moveEntryToRemoteEntries(e){for(const t of e){const r=this._contextEntriesNotInTimeline.get(t.id);r&&(r.contextForEntries.forEach(i=>{i.setContextEntry(t),this._emitUpdateForEntry(i,"contextEntry")}),this._contextEntriesNotInTimeline.delete(t.id))}}_emitUpdateForEntry(e,t){const r=e.isPending?e.id:null,i=e.isPending?null:e.id;this._findAndUpdateEntryById(r,i,()=>t)}async _loadContextEntriesWhereNeeded(e){for(const t of e){if(!t.contextEventId)continue;const r=t.contextEventId;let i=e.find(s=>s.id===r);i||(i=this._findLoadedEventById(r)),i?t.setContextEntry(i):this._loadContextEntryNotInTimeline(t)}}async _loadContextEntryNotInTimeline(e){const t=e.contextEventId;let r=await this._getEventFromStorage(t);r||(r=await this._getEventFromHomeserver(t)),r&&(this._contextEntriesNotInTimeline.set(t,r),e.setContextEntry(r),this._emitUpdateForEntry(e,"contextEntry"))}_findLoadedEventById(e){var t;return(t=this.getByEventId(e))!=null?t:this._contextEntriesNotInTimeline.get(e)}async _getEventFromStorage(e){return await this._timelineReader.readById(e)}async _getEventFromHomeserver(e){const t=await this._hsApi.context(this._roomId,e,0).response(),r=t.event.sender,i=t.state.find(a=>a.type===zt&&a.user_id===r),s={event:t.event,displayName:i.content.displayname,avatarUrl:i.content.avatar_url},o=new GL(s,this._fragmentIdComparer);return this._decryptEntries&&await this._decryptEntries([o]).complete(),o}async loadAtTop(e){if(this._disposables.isDisposed)return!0;const t=this._remoteEntries.array.find(i=>!!i.eventType);if(!t)return!0;const r=this._disposables.track(this._timelineReader.readFrom(t.asEventKey(),wr.Backward,e));try{const i=await r.complete();return this.addEntries(i),i.length<e}finally{this._disposables.disposeTracked(r)}}async _getOrLoadEntry(e,t){var r;if(e){for(const i of this._localEntries)if(i.id===e)return i}return t?(r=this.getByEventId(t))!=null?r:await this._getEventFromStorage(t):null}getByEventId(e){for(let t=0;t<this._remoteEntries.length;t+=1){const r=this._remoteEntries.get(t);if(r.id===e)return r}return null}get entries(){return this._allEntries}get remoteEntries(){return this._remoteEntries.array}dispose(){this._closeCallback&&(this._disposables.dispose(),this._closeCallback(),this._closeCallback=null)}enableEncryption(e){this._decryptEntries=e,this._timelineReader.enableEncryption(e)}get powerLevels(){return this._powerLevels}get me(){return this._ownMember}}async function WL({roomId:n,storage:e,txn:t}){return t||(t=await e.readTxn([e.storeNames.roomMembers])),(await t.roomMembers.getAll(n)).map(i=>new ye(i))}async function YL({summary:n,syncToken:e,roomId:t,hsApi:r,storage:i,setChangedMembersMap:s},o){const a=new Map;s(a);const c=await r.members(t,{at:e},{log:o}).response(),u=await i.readWriteTxn([i.storeNames.roomSummary,i.storeNames.roomMembers]);let l,d;try{l=n.writeHasFetchedMembers(!0,u);const{roomMembers:p}=u,m=c.chunk;if(!Array.isArray(m))throw new Error("malformed");o.set("members",m.length),d=await Promise.all(m.map(async w=>{const S=w==null?void 0:w.state_key;if(!S)throw new Error("malformed");const v=a.get(S);if(v)return v;{const _=ye.fromMemberEvent(t,w);return _&&p.set(_.serialize()),_}}))}catch(p){throw u.abort(),p}finally{s(null)}return await u.complete(),n.applyChanges(l),d}async function XL(n,e){const{summary:t}=n;return t.data.hasFetchedMembers?WL(n):e.wrapOrRun(n.log,"fetchMembers",r=>YL(n,r))}async function JL(n,e){const t=await QL(n),{summary:r}=n;return!r.data.hasFetchedMembers&&!t?e.wrapOrRun(n.log,"fetchMember",i=>ZL(n,i)):t}async function QL({roomId:n,userId:e,storage:t}){const i=await(await t.readTxn([t.storeNames.roomMembers])).roomMembers.get(n,e);return i?new ye(i):null}async function ZL({roomId:n,userId:e,hsApi:t,storage:r},i){let s;try{s=await t.state(n,"m.room.member",e,{log:i}).response()}catch(c){if(c.name==="HomeServerError"&&c.errcode==="M_NOT_FOUND")return null;throw c}const o=new ye({roomId:n,userId:e,membership:s.membership,avatarUrl:s.avatar_url,displayName:s.displayname}),a=await r.readWriteTxn([r.storeNames.roomMembers]);try{a.roomMembers.set(o.serialize())}catch(c){throw a.abort(),c}return await a.complete(),o}class eF{constructor(e){this._retentionCount=1,this._freeCallback=e}retain(){this._retentionCount+=1}release(){this._retentionCount-=1,this._retentionCount===0&&this._freeCallback()}}class tF extends eF{constructor({members:e,closeCallback:t}){super(t),this._members=new pr;for(const r of e)this._members.add(r.userId,r)}afterSync(e){for(const[t,r]of e.entries())this._members.set(t,r.member)}get members(){return this._members}}function hp(n,e,t){const r=e.joinCount+e.inviteCount-1;if(n.length>=r)if(n.length>1){const i=n[n.length-1];return n.slice(0,n.length-1).map(o=>o.name).join(", ")+" and "+i.name}else{const i=n[0];return i?i.name:(t.log({l:"could get get other member name",length:n.length,otherMember:!!i,otherMemberMembership:i==null?void 0:i.membership}),"Unknown DM Name")}else return n.length<r?n.map(i=>i.name).join(", ")+` and ${r} others`:null}class k_{constructor(e){this._roomId=e,this._members=new Map}async calculateChanges(e,t,r){const i=new Map,s=[];for(const o of this._members.keys())e.indexOf(o)===-1&&s.push(o);for(const[o,a]of t.entries())(this._members.has(o)||e.indexOf(o)!==-1)&&i.set(o,a.member);for(const o of e)if(!this._members.has(o)&&!i.has(o)){const a=await r.roomMembers.get(this._roomId,o);if(a){const c=new ye(a);i.set(c.userId,c)}}return{updatedHeroMembers:i.values(),removedUserIds:s}}applyChanges({updatedHeroMembers:e,removedUserIds:t},r,i){for(const o of t)this._members.delete(o);for(const o of e)t.includes(o.userId)||this._members.set(o.userId,o);const s=Array.from(this._members.values()).sort((o,a)=>o.name.localeCompare(a.name));this._roomName=hp(s,r,i)}get roomName(){return this._roomName}get roomAvatarUrl(){if(this._members.size===1)for(const e of this._members.values())return e.avatarUrl;return null}get roomAvatarColorId(){if(this._members.size===1)for(const e of this._members.keys())return e;return null}}class nF{constructor(e){this._map=new Map,this._notifyEmpty=e}observe(e,t=null){let r=this._map.get(e);return r||(r=new rF(this,t,e),this._map.set(e,r)),r}updateEvents(e){for(let t=0;t<e.length;t+=1){const r=e[t],i=this._map.get(r.id);i==null||i.update(r)}}_remove(e){this._map.delete(e),this._map.size===0&&this._notifyEmpty()}}class rF extends vi{constructor(e,t,r){super(),this._eventMap=e,this._entry=t,this._id=r,Promise.resolve().then(()=>{this.hasSubscriptions||(this._eventMap._remove(this._id),this._eventMap=null)})}subscribe(e){if(!this._eventMap)throw new Error("ObservedEvent expired, subscribe right after calling room.observeEvent()");return super.subscribe(e)}onUnsubscribeLast(){this._eventMap._remove(this._id),this._eventMap=null,super.onUnsubscribeLast()}update(e){this._entry=e,this.emit(this._entry)}get(){return this._entry}}function iF(n){return n||gN.item}const sF="m.room.power_levels",oF=50;class Gc{constructor({powerLevelEvent:e,createEvent:t,ownUserId:r,membership:i}){this._plEvent=e,this._createEvent=t,this._ownUserId=r,this._membership=i}canRedactFromSender(e){return e===this._ownUserId&&this._membership==="join"?!0:this.canRedact}canSendType(e){return this._myLevel>=this._getEventTypeLevel(e)}get canRedact(){return this._myLevel>=this._getActionLevel("redact")}get _myLevel(){return this._membership!=="join"?Number.MIN_SAFE_INTEGER:this.getUserLevel(this._ownUserId)}getUserLevel(e){var t,r,i,s;if(this._plEvent){let o=(r=(t=this._plEvent.content)==null?void 0:t.users)==null?void 0:r[e];if(typeof o!="number"&&(o=(i=this._plEvent.content)==null?void 0:i.users_default),typeof o=="number")return o}else if(this._createEvent&&e===((s=this._createEvent.content)==null?void 0:s.creator))return 100;return 0}_getActionLevel(e){var t,r;const i=(r=(t=this._plEvent)==null?void 0:t.content)==null?void 0:r[e];return typeof i=="number"?i:oF}_getEventTypeLevel(e){var t,r,i,s,o;const a=(i=(r=(t=this._plEvent)==null?void 0:t.content)==null?void 0:r.events)==null?void 0:i[e];if(typeof a=="number")return a;{const c=(o=(s=this._plEvent)==null?void 0:s.content)==null?void 0:o.events_default;return typeof c=="number"?c:0}}}class aF extends pr{constructor(e){super(),this.type=e}async load(e,t){const r=await t.roomState.getAllForType(e,this.type);for(let i=0;i<r.length;++i){const{event:s}=r[i];this.add(s.state_key,s)}}handleStateEvent(e){e.type===this.type&&this.set(e.state_key,e)}setRemoveCallback(e){this.removeCallback=e}onUnsubscribeLast(){var e;(e=this.removeCallback)==null||e.call(this)}}class lF extends vi{constructor(e,t){super(),this.type=e,this.stateKey=t}async load(e,t){var r;this.event=(r=await t.roomState.get(e,this.type,this.stateKey))==null?void 0:r.event}handleStateEvent(e){e.type===this.type&&e.state_key===this.stateKey&&(this.event=e,this.emit(this.get()))}get(){return this.event}setRemoveCallback(e){this.removeCallback=e}onUnsubscribeLast(){var e;(e=this.removeCallback)==null||e.call(this)}}const cF="m.room.encrypted";class j0 extends kr{constructor({roomId:e,storage:t,hsApi:r,mediaRepository:i,emitCollectionChange:s,user:o,createRoomEncryption:a,getSyncToken:c,platform:u}){super(),this._roomId=e,this._storage=t,this._hsApi=r,this._mediaRepository=i,this._summary=new yL(e),this._fragmentIdComparer=new UL([]),this._emitCollectionChange=s,this._timeline=null,this._openTimelinePromise=null,this._user=o,this._changedMembersDuringSync=null,this._memberList=null,this._createRoomEncryption=a,this._roomEncryption=null,this._getSyncToken=c,this._platform=u,this._observedEvents=null,this._roomStateObservers=new Set,this._powerLevels=null,this._powerLevelLoading=null,this._observedMembers=null}async observeStateType(e,t=void 0){const r=new aF(e);return await this._addStateObserver(r,t),r}async observeStateTypeAndKey(e,t,r=void 0){const i=new lF(e,t);return await this._addStateObserver(i,r),i}async getStateEvent(e,t=""){return(await this._storage.readTxn(["roomState"])).roomState.get(this.id,e,t)}async _addStateObserver(e,t){t||(t=await this._storage.readTxn([this._storage.storeNames.roomState])),await e.load(this.id,t),this._roomStateObservers.add(e),e.setRemoveCallback(()=>{this._roomStateObservers.delete(e)})}async _eventIdsToEntries(e,t){const r=[];return await Promise.all(e.map(async i=>{const s=await t.timelineEvents.getByEventId(this._roomId,i);s&&r.push(new sn(s,this._fragmentIdComparer))})),r}_getAdditionalTimelineRetryEntries(e,t){let r=this._roomEncryption.filterUndecryptedEventEntriesForKeys(this._timeline.remoteEntries,t);const i=e.reduce((s,o)=>(s.add(o.id),s),new Set);return r=r.filter(s=>!i.has(s.id)),r}async notifyRoomKey(e,t,r){var i;if(!this._roomEncryption)return;const s=await this._storage.readTxn([this._storage.storeNames.timelineEvents,this._storage.storeNames.inboundGroupSessions]);let o=await this._eventIdsToEntries(t,s);if(this._timeline){const a=this._getAdditionalTimelineRetryEntries(o,[e]);o=o.concat(a)}if(o.length){await this._decryptEntries(zr.Retry,o,s,r).complete(),(i=this._timeline)==null||i.replaceEntries(o);const c=this._summary.data.applyTimelineEntries(o,!1,!1);await this._summary.writeAndApplyData(c,this._storage)&&this._emitUpdate()}}_setEncryption(e){return e&&!this._roomEncryption?(this._roomEncryption=e,this._timeline&&this._timeline.enableEncryption(this._decryptEntries.bind(this,zr.Timeline)),!0):!1}_decryptEntries(e,t,r,i=null){return new uF(async(o,a)=>{if(r||(r=await this._storage.readTxn([this._storage.storeNames.inboundGroupSessions])),o.cancelled)return;const c=t.filter(w=>w.eventType===cF).map(w=>w.event);if(o.preparation=await this._roomEncryption.prepareDecryptAll(c,null,e,r),o.cancelled)return;const u=await o.preparation.decrypt();if(o.preparation=null,o.cancelled)return;const l=[this._storage.storeNames.groupSessionDecryptions],d=this._isTimelineOpen;d&&l.push(this._storage.storeNames.deviceKeys);const p=await this._storage.readWriteTxn(l);let m;try{m=await u.write(p,a),d&&await m.verifyKnownSenders(p)}catch(w){throw p.abort(),w}await p.complete(),m.applyToEntries(t),this._observedEvents&&this._observedEvents.updateEvents(t),d&&m.hasUnverifiedSenders&&a.wrapDetached("fetch unknown senders keys",async w=>{var S,v;const _=await m.fetchAndVerifyRemainingSenders(this._hsApi,w),b=[];_.applyToEntries(t,k=>b.push(k)),(S=this._timeline)==null||S.replaceEntries(b),(v=this._observedEvents)==null||v.updateEvents(b)})},iF(i))}async _getSyncRetryDecryptEntries(e,t,r){let s=(await Promise.all(e.map(async o=>{const a=await t.getEventIdsForMissingKey(o,r);if(a)return this._eventIdsToEntries(a,r)}))).reduce((o,a)=>a?o.concat(a):o,[]);if(this._timeline){const a=this._getAdditionalTimelineRetryEntries(s,e).map(c=>c.clone());s=s.concat(a)}return s}async load(e,t,r){r.set("id",this.id);try{if(e&&this._summary.load(e),this._summary.data.encryption){const i=this._createRoomEncryption(this,this._summary.data.encryption);this._setEncryption(i)}if(this._summary.data.needsHeroes){this._heroes=new k_(this._roomId);const i=await this._heroes.calculateChanges(this._summary.data.heroes,[],t);this._heroes.applyChanges(i,this._summary.data,r)}}catch(i){throw new FE(`Could not load room ${this._roomId}`,i)}}async observeMember(e){this._observedMembers||(this._observedMembers=new Map);const t=this._observedMembers.get(e);if(t)return t;const r=await JL({summary:this._summary,roomId:this._roomId,userId:e,storage:this._storage,hsApi:this._hsApi},this._platform.logger);if(!r)return null;const i=new fl(r,()=>this._observedMembers.delete(e));return this._observedMembers.set(e,i),i}async loadMemberList(e=void 0,t=null){if(this._memberList)return this._memberList.retain(),this._memberList;{const r=await XL({summary:this._summary,roomId:this._roomId,hsApi:this._hsApi,storage:this._storage,txn:e,syncToken:this._getSyncToken(),setChangedMembersMap:i=>this._changedMembersDuringSync=i,log:t},this._platform.logger);return this._memberList=new tF({members:r,closeCallback:()=>{this._memberList=null}}),this._memberList}}fillGap(e,t,r=null){return this._platform.logger.wrapOrRun(r,"fillGap",async i=>{if(i.set("id",this.id),i.set("fragment",e.fragmentId),i.set("dir",e.direction.asApiString()),e.edgeReached){i.set("edgeReached",!0);return}const s=await this._hsApi.messages(this._roomId,{from:e.token,dir:e.direction.asApiString(),limit:t,filter:{lazy_load_members:!0,include_redundant_members:!0}},{log:i}).response(),o=await this._storage.readWriteTxn([this._storage.storeNames.pendingEvents,this._storage.storeNames.timelineEvents,this._storage.storeNames.timelineRelations,this._storage.storeNames.timelineFragments]);let a,c;try{a=await this._writeGapFill(s.chunk,o,i);const u=new F0({roomId:this._roomId,fragmentIdComparer:this._fragmentIdComparer,ownUserId:this._user.id});c=await new HL({roomId:this._roomId,storage:this._storage,fragmentIdComparer:this._fragmentIdComparer,relationWriter:u}).writeFragmentFill(e,s,e.token,o,i)}catch(u){throw o.abort(),u}await o.complete(),this._roomEncryption&&await this._decryptEntries(zr.Timeline,c.entries,null,i).complete();for(const u of c.fragments)this._fragmentIdComparer.add(u);a&&this._applyGapFill(a),this._timeline&&(this._timeline.replaceEntries(c.updatedEntries),this._timeline.addEntries(c.entries))})}async _writeGapFill(e,t,r){}_applyGapFill(){}get name(){if(this._heroes)return this._heroes.roomName;const e=this._summary.data;return e.name?e.name:e.canonicalAlias?e.canonicalAlias:null}get id(){return this._roomId}get avatarUrl(){return this._summary.data.avatarUrl?this._summary.data.avatarUrl:this._heroes?this._heroes.roomAvatarUrl:null}get avatarColorId(){return this._roomId}get type(){var e;return(e=this._summary.data.type)!=null?e:void 0}get lastMessageTimestamp(){return this._summary.data.lastMessageTimestamp}get isLowPriority(){const e=this._summary.data.tags;return!!(e&&e["m.lowpriority"])}get isEncrypted(){return!!this._summary.data.encryption}get isJoined(){return this.membership==="join"}get isLeft(){return this.membership==="leave"}get canonicalAlias(){return this._summary.data.canonicalAlias}get joinedMemberCount(){return this._summary.data.joinCount}get mediaRepository(){return this._mediaRepository}get membership(){return this._summary.data.membership}get isDirectMessage(){return this._summary.data.isDirectMessage}get user(){return this._user}isDirectMessageForUserId(e){if(this._summary.data.dmUserId===e)return!0;{const{heroes:t,joinCount:r,inviteCount:i}=this._summary.data;if(t&&t.includes(e)&&r+i===2)return!0}return!1}async _loadPowerLevels(){const e=await this._storage.readTxn([this._storage.storeNames.roomState]),t=await e.roomState.get(this._roomId,"m.room.power_levels","");if(t)return new Gc({powerLevelEvent:t.event,ownUserId:this._user.id,membership:this.membership});const r=await e.roomState.get(this._roomId,"m.room.create","");if(r)return new Gc({createEvent:r.event,ownUserId:this._user.id,membership:this.membership});{const i=this.membership;return new Gc({ownUserId:this._user.id,membership:i})}}async observePowerLevels(){this._powerLevelLoading&&await this._powerLevelLoading;let e=this._powerLevels;if(!e){this._powerLevelLoading=this._loadPowerLevels();const t=await this._powerLevelLoading;e=new fl(t,()=>{this._powerLevels=null}),this._powerLevels=e,this._powerLevelLoading=null}return e}enableKeyBackup(e){var t;(t=this._roomEncryption)==null||t.enableKeyBackup(e),this._timeline&&e&&this._platform.logger.run("enableKeyBackup",r=>this._roomEncryption.restoreMissingSessionsFromBackup(this._timeline.remoteEntries,r))}get _isTimelineOpen(){return!!this._timeline}_emitUpdate(){this.emit("change"),this._emitCollectionChange(this)}openTimeline(e=null){return this._openTimelinePromise?this._openTimelinePromise:(this._openTimelinePromise=this._platform.logger.wrapOrRun(e,"open timeline",async t=>{if(t.set("id",this.id),this._timeline)throw new Error("not dealing with load race here for now");this._timeline=new ju({roomId:this.id,storage:this._storage,fragmentIdComparer:this._fragmentIdComparer,pendingEvents:this._getPendingEvents(),closeCallback:()=>{this._timeline=null,this._openTimelinePromise=null,this._roomEncryption&&this._roomEncryption.notifyTimelineClosed()},clock:this._platform.clock,logger:this._platform.logger,powerLevelsObservable:await this.observePowerLevels(),hsApi:this._hsApi});try{this._roomEncryption&&this._timeline.enableEncryption(this._decryptEntries.bind(this,zr.Timeline)),await this._timeline.load(this._user,this.membership,t)}catch(r){throw this._timeline.dispose(),r}return this._timeline}),this._openTimelinePromise)}_getPendingEvents(){return null}observeEvent(e){this._observedEvents||(this._observedEvents=new nF(()=>{this._observedEvents=null}));let t=null;this._timeline&&(t=this._timeline.getByEventId(e));const r=this._observedEvents.observe(e,t);return t||this._readEventById(e).then(i=>{r.update(i)}).catch(i=>{console.warn(`could not load event ${e} from storage`,i)}),r}async _readEventById(e){return await new K0({roomId:this._roomId,storage:this._storage,fragmentIdComparer:this._fragmentIdComparer}).readById(e)}dispose(){var e,t;(e=this._roomEncryption)==null||e.dispose(),(t=this._timeline)==null||t.dispose()}}class uF{constructor(e,t){this._cancelled=!1,this.preparation=null,this._promise=t.wrap("decryptEntries",r=>e(this,r))}complete(){return this._promise}get cancelled(){return this._cancelled}dispose(){this._cancelled=!0,this.preparation&&this.preparation.dispose()}}class dF{constructor({roomId:e,storage:t,hsApi:r,pendingEvents:i}){i=i||[],this._roomId=e,this._storage=t,this._hsApi=r,this._pendingEvents=new KE((s,o)=>s.queueIndex-o.queueIndex),this._pendingEvents.setManyUnsorted(i.map(s=>this._createPendingEvent(s))),this._isSending=!1,this._offline=!1,this._roomEncryption=null,this._currentQueueIndex=0}_createPendingEvent(e,t=null){const r=new CL({data:e,remove:()=>this._removeEvent(r),emitUpdate:i=>this._pendingEvents.update(r,i),attachments:t});return r}enableEncryption(e){this._roomEncryption=e}_sendLoop(e){this._isSending=!0,this._sendLoopLogItem=e.runDetached("send queue flush",async t=>{try{for(const r of this._pendingEvents)await t.wrap("send event",async i=>{i.set("queueIndex",r.queueIndex);try{this._currentQueueIndex=r.queueIndex,await this._sendEvent(r,i)}catch(s){s instanceof dr?(this._offline=!0,i.set("offline",!0),r.setWaiting()):(i.catch(s),s.name==="HomeServerError"&&(s.statusCode===400||s.statusCode===403||s.statusCode===404)?(i.set("remove",!0),await r.abort()):r.setError(s))}finally{this._currentQueueIndex=0}})}finally{this._isSending=!1,this._sendLoopLogItem=null}})}async _sendEvent(e,t){if(e.needsUpload&&(await t.wrap("upload attachments",r=>e.uploadAttachments(this._hsApi,r)),await this._tryUpdateEvent(e)),e.needsEncryption){e.setEncrypting();const r=e.contentForEncryption,{type:i,content:s}=await t.wrap("encrypt",o=>this._roomEncryption.encrypt(e.eventType,r,this._hsApi,o));e.setEncrypted(i,s),await this._tryUpdateEvent(e)}if(e.needsSending){await e.send(this._hsApi,t);const r=await this._storage.readWriteTxn([this._storage.storeNames.pendingEvents]);try{await this._tryUpdateEventWithTxn(e,r),await this._resolveRemoteIdInPendingRelations(e.txnId,e.remoteId,r)}catch(i){throw r.abort(),i}await r.complete()}}async _resolveRemoteIdInPendingRelations(e,t,r){const i=this._pendingEvents.array.filter(s=>s.relatedTxnId===e&&s.relatedEventId!==t);for(const s of i)s.setRelatedEventId(t),await this._tryUpdateEventWithTxn(s,r);return i}async removeRemoteEchos(e,t,r){const i=[];for(const s of e){const o=s.unsigned&&s.unsigned.transaction_id;let a;if(o?a=this._pendingEvents.array.findIndex(c=>c.txnId===o):a=this._pendingEvents.array.findIndex(c=>c.remoteId===s.event_id),a!==-1){const c=this._pendingEvents.get(a),u=s.event_id;r.log({l:"removeRemoteEcho",queueIndex:c.queueIndex,remoteId:u,txnId:o}),t.pendingEvents.remove(c.roomId,c.queueIndex),i.push(c),await this._resolveRemoteIdInPendingRelations(o,u,t)}}return i}async _removeEvent(e){if(this._pendingEvents.array.indexOf(e)!==-1){const r=await this._storage.readWriteTxn([this._storage.storeNames.pendingEvents]);try{r.pendingEvents.remove(e.roomId,e.queueIndex)}catch{r.abort()}await r.complete();const i=this._pendingEvents.array.indexOf(e);i!==-1&&this._pendingEvents.remove(i)}e.dispose()}emitRemovals(e){for(const t of e){const r=this._pendingEvents.array.indexOf(t);r!==-1&&this._pendingEvents.remove(r),t.dispose()}}resumeSending(e){this._offline=!1,this._pendingEvents.length&&e.wrap("resumeSending",t=>{t.set("id",this._roomId),t.set("pendingEvents",this._pendingEvents.length),this._isSending||this._sendLoop(t),this._sendLoopLogItem&&t.refDetached(this._sendLoopLogItem)})}async enqueueEvent(e,t,r,i){const s=fi(t);let o=null;if(s){const a=S_(s);if(Sv(a)&&(o=a,$0(s,null)),s.rel_type===oi&&this._pendingEvents.array.some(u=>{const l=fi(u.content);return u.eventType===e&&l&&l.key===s.key&&(u.relatedTxnId===o||l.event_id===s.event_id)})){i.set("already_annotating",!0);return}}await this._enqueueEvent(e,t,r,o,null,i)}async _enqueueEvent(e,t,r,i,s,o){const a=await this._createAndStoreEvent(e,t,i,s,r);this._pendingEvents.set(a),o.set("queueIndex",a.queueIndex),o.set("pendingEvents",this._pendingEvents.length),!this._isSending&&!this._offline&&this._sendLoop(o),this._sendLoopLogItem&&o.refDetached(this._sendLoopLogItem)}async enqueueRedaction(e,t,r){if(this._pendingEvents.array.some(a=>a.eventType===Ln&&(a.relatedTxnId===e||a.relatedEventId===e))){r.set("already_redacting",!0);return}let s,o;if(Sv(e)){s=e;const a=e,c=this._pendingEvents.array.find(u=>u.txnId===a);if(c&&!c.remoteId&&c.status!==qe.Sending){r.set("remove",s),await c.abort();return}else if(c)o=c.remoteId;else return}else{o=e;const a=this._pendingEvents.array.find(c=>c.remoteId===o);a&&(s=a.txnId)}r.set("relatedTxnId",s),r.set("relatedEventId",o),await this._enqueueEvent(Ln,{reason:t},null,s,o,r)}get pendingEvents(){return this._pendingEvents}async _tryUpdateEvent(e){const t=await this._storage.readWriteTxn([this._storage.storeNames.pendingEvents]);try{this._tryUpdateEventWithTxn(e,t)}catch(r){throw t.abort(),r}await t.complete()}async _tryUpdateEventWithTxn(e,t){await t.pendingEvents.exists(e.roomId,e.queueIndex)&&t.pendingEvents.update(e.data)}async _createAndStoreEvent(e,t,r,i,s){const o=await this._storage.readWriteTxn([this._storage.storeNames.pendingEvents]);let a;try{const c=o.pendingEvents,u=await c.getMaxQueueIndex(this._roomId)||0,d=Math.max(u,this._currentQueueIndex)+1,p=e!==Ln&&e!==vL&&!!this._roomEncryption;a=this._createPendingEvent({roomId:this._roomId,queueIndex:d,eventType:e,content:t,relatedTxnId:r,relatedEventId:i,txnId:An(),needsEncryption:p,needsUpload:!!s},s),c.add(a.data)}catch(c){throw o.abort(),c}return await o.complete(),a}dispose(){for(const e of this._pendingEvents)e.dispose()}}class H0{constructor({filename:e,blob:t,platform:r}){this._filename=e,this._unencryptedBlob=t,this._transferredBlob=this._unencryptedBlob,this._platform=r,this._mxcUrl=null,this._encryptionInfo=null,this._uploadRequest=null,this._aborted=!1,this._error=null,this._sentBytes=0}get size(){return this._transferredBlob.size}get sentBytes(){return this._sentBytes}abort(){var e;(e=this._uploadRequest)==null||e.abort()}get localPreview(){return this._unencryptedBlob}async encrypt(){if(this._encryptionInfo)throw new Error("already encrypted");const{info:e,blob:t}=await rL(this._platform,this._transferredBlob);this._transferredBlob=t,this._encryptionInfo=e}async upload(e,t,r){this._uploadRequest=e.uploadAttachment(this._transferredBlob,this._filename,{uploadProgress:s=>{this._sentBytes=s,t()},log:r});const{content_uri:i}=await this._uploadRequest.response();this._mxcUrl=i}applyToContent(e,t){if(!this._mxcUrl)throw new Error("upload has not finished");let r=e.substr(0,e.lastIndexOf("url"));kc(`${r}info.size`,t,this._transferredBlob.size),kc(`${r}info.mimetype`,t,this._unencryptedBlob.mimeType),this._encryptionInfo?kc(`${r}file`,t,Object.assign(this._encryptionInfo,{mimetype:this._unencryptedBlob.mimeType,url:this._mxcUrl})):kc(`${r}url`,t,this._mxcUrl)}dispose(){this._unencryptedBlob.dispose(),this._transferredBlob.dispose()}}function kc(n,e,t){const r=n.split(".");let i=e;for(let o=0;o<r.length-1;o+=1){const a=r[o];i[a]||(i[a]={}),i=i[a]}const s=r[r.length-1];i[s]=t}const hF="m.room.encrypted";class fF extends j0{constructor(e){super(e),this._roomStateHandler=e.roomStateHandler;const{pendingEvents:t}=e,r=new F0({roomId:this.id,fragmentIdComparer:this._fragmentIdComparer,ownUserId:this._user.id});this._syncWriter=new VL({roomId:this.id,fragmentIdComparer:this._fragmentIdComparer,relationWriter:r,memberWriter:new KL(this.id)}),this._sendQueue=new dF({roomId:this.id,storage:this._storage,hsApi:this._hsApi,pendingEvents:t})}_setEncryption(e){return super._setEncryption(e)?(this._sendQueue.enableEncryption(this._roomEncryption),!0):!1}async prepareSync(e,t,r,i,s){var o;s.set("id",this.id),r&&s.set("newKeys",r.length);let a=this._summary.data.applySyncResponse(e,t,this._user.id),c=this._roomEncryption;!c&&a.encryption&&(s.set("enableEncryption",!0),c=this._createRoomEncryption(this,a.encryption));let u,l;if(c){let d=((o=e==null?void 0:e.timeline)==null?void 0:o.events)||[];r&&(u=await this._getSyncRetryDecryptEntries(r,c,i),u.length&&(s.set("retry",u.length),d=d.concat(u.map(p=>p.event)))),d=d.filter(p=>(p==null?void 0:p.type)===hF),d.length&&(l=await c.prepareDecryptAll(d,r,zr.Sync,i))}return{roomEncryption:c,summaryChanges:a,decryptPreparation:l,decryptChanges:null,retryEntries:u}}async afterPrepareSync(e,t){e.decryptPreparation&&await t.wrap("decrypt",async r=>{r.set("id",this.id),e.decryptChanges=await e.decryptPreparation.decrypt(),e.decryptPreparation=null},t.level.Detail)}async writeSync(e,t,{summaryChanges:r,decryptChanges:i,roomEncryption:s,retryEntries:o},a,c){var u;c.set("id",this.id);const l=r.isNewJoin(this._summary.data);l&&(a.roomState.removeAllForRoom(this.id),a.roomMembers.removeAllForRoom(this.id));const{entries:d,updatedEntries:p,newLiveKey:m,memberChanges:w,memberSync:S}=await c.wrap("syncWriter",M=>this._syncWriter.writeSync(e,l,r.hasFetchedMembers,a,M),c.level.Detail);let v;i&&(v=await c.wrap("decryptChanges",M=>i.write(a,M)),c.set("decryptionResults",v.results.size),c.set("decryptionErrors",v.errors.size),this._isTimelineOpen&&await v.verifyKnownSenders(a),v.applyToEntries(d),o!=null&&o.length&&(v.applyToEntries(o),p.push(...o))),c.set("newEntries",d.length),c.set("updatedEntries",p.length);let _;s&&(_=await s.writeSync(e,w,a,c),c.set("shouldFlushKeyShares",_.shouldFlush));const b=d.concat(p);r=r.applyTimelineEntries(b,t,!this._isTimelineOpen,this._user.id),r.membership!=="join"?a.roomSummary.remove(this.id):r=this._summary.writeData(r,a),r&&c.set("summaryChanges",r.changedKeys(this._summary.data));let k;r!=null&&r.needsHeroes&&(this._heroes||(this._heroes=new k_(this._roomId)),k=await this._heroes.calculateChanges(r.heroes,w,a));let g;Array.isArray((u=e.timeline)==null?void 0:u.events)&&(g=await this._sendQueue.removeRemoteEchos(e.timeline.events,a,c));const A=this._getPowerLevelsEvent(e);return await this._runRoomStateHandlers(e,S,a,c),{roomResponse:e,summaryChanges:r,roomEncryption:s,newEntries:d,updatedEntries:p,newLiveKey:m,removedPendingEvents:g,memberChanges:w,heroChanges:k,powerLevelsEvent:A,encryptionChanges:_,decryption:v}}afterSync(e,t){const{summaryChanges:r,newEntries:i,updatedEntries:s,newLiveKey:o,removedPendingEvents:a,memberChanges:c,powerLevelsEvent:u,heroChanges:l,roomEncryption:d,roomResponse:p,encryptionChanges:m}=e;if(t.set("id",this.id),this._syncWriter.afterSync(o),this._setEncryption(d),this._roomEncryption&&this._roomEncryption.afterSync(m),c.size){if(this._changedMembersDuringSync)for(const[S,v]of c.entries())this._changedMembersDuringSync.set(S,v.member);if(this._memberList&&this._memberList.afterSync(c),this._roomStateHandler.updateRoomMembers(this,c),this._observedMembers&&this._updateObservedMembers(c),this._timeline){for(const[S,v]of c.entries())if(S===this._user.id){this._timeline.updateOwnMember(v.member);break}}}let w=!1;if(r&&(this._summary.applyChanges(r),this._summary.data.needsHeroes||(this._heroes=null),w=!0),this._heroes&&l){const S=this.name;this._heroes.applyChanges(l,this._summary.data,t),S!==this.name&&(w=!0)}u&&this._updatePowerLevels(u),w&&this._emitUpdate(),this._timeline&&(this._timeline.replaceEntries(s),this._timeline.addEntries(i)),this._observedEvents&&(this._observedEvents.updateEvents(s),this._observedEvents.updateEvents(i)),a&&this._sendQueue.emitRemovals(a),this._emitSyncRoomState(p)}_updateObservedMembers(e){for(const[t,r]of e){const i=this._observedMembers.get(t);i&&i.set(r.member)}}_getPowerLevelsEvent(e){let t;return qs(e,r=>{r.state_key===""&&r.type===sF&&(t=r)}),t}_updatePowerLevels(e){if(this._powerLevels){const t=new Gc({powerLevelEvent:e,ownUserId:this._user.id,membership:this.membership});this._powerLevels.set(t)}}async afterSyncCompleted({encryptionChanges:e,decryption:t,newEntries:r,updatedEntries:i},s){const o=e==null?void 0:e.shouldFlush,a=this._isTimelineOpen&&(t==null?void 0:t.hasUnverifiedSenders);(o||a)&&await s.wrap({l:"room",id:this.id},async c=>{const u=[];if(o&&u.push(this._roomEncryption.flushPendingRoomKeyShares(this._hsApi,null,c)),a){const l=c.wrap("verify senders",async d=>{var p,m;const w=await t.fetchAndVerifyRemainingSenders(this._hsApi,d),S=[],v=_=>S.push(_);w.applyToEntries(r,v),w.applyToEntries(i,v),d.set("verifiedEntries",S.length),(p=this._timeline)==null||p.replaceEntries(S),(m=this._observedEvents)==null||m.updateEvents(S)});u.push(l)}await Promise.all(u)})}start(e,t){if(this._roomEncryption){const r=e==null?void 0:e.get("share_room_key");r&&t.wrapDetached("flush room keys",i=>(i.set("id",this.id),this._roomEncryption.flushPendingRoomKeyShares(this._hsApi,r,i)))}this._sendQueue.resumeSending(t)}async load(e,t,r){try{await super.load(e,t,r),await this._syncWriter.load(t,r)}catch(i){throw new FE(`Could not load room ${this._roomId}`,i)}}async _writeGapFill(e,t,r){return await this._sendQueue.removeRemoteEchos(e,t,r)}_applyGapFill(e){this._sendQueue.emitRemovals(e)}sendEvent(e,t,r,i=null){return this._platform.logger.wrapOrRun(i,"send",s=>(s.set("id",this.id),this._sendQueue.enqueueEvent(e,t,r,s)))}sendRedaction(e,t,r=null){return this._platform.logger.wrapOrRun(r,"redact",i=>(i.set("id",this.id),this._sendQueue.enqueueRedaction(e,t,i)))}async ensureMessageKeyIsShared(e=null){if(this._roomEncryption)return this._platform.logger.wrapOrRun(e,"ensureMessageKeyIsShared",t=>(t.set("id",this.id),this._roomEncryption.ensureMessageKeyIsShared(this._hsApi,t)))}get avatarColorId(){var e;return((e=this._heroes)==null?void 0:e.roomAvatarColorId)||this._roomId}get isUnread(){return this._summary.data.isUnread}get notificationCount(){return this._summary.data.notificationCount}get highlightCount(){return this._summary.data.highlightCount}get isTrackingMembers(){return this._summary.data.isTrackingMembers}async _getLastEventId(){var e;const t=this._syncWriter.lastMessageKey;if(t){const i=await(await this._storage.readTxn([this._storage.storeNames.timelineEvents])).timelineEvents.get(this._roomId,t);return(e=i==null?void 0:i.event)==null?void 0:e.event_id}}async clearUnread(e=null){if(this.isUnread||this.notificationCount)return await this._platform.logger.wrapOrRun(e,"clearUnread",async t=>{t.set("id",this.id);const r=await this._storage.readWriteTxn([this._storage.storeNames.roomSummary]);let i;try{i=this._summary.writeClearUnread(r)}catch(s){throw r.abort(),s}await r.complete(),this._summary.applyChanges(i),this._emitUpdate();try{const s=await this._getLastEventId();s&&await this._hsApi.receipt(this._roomId,"m.read",s)}catch(s){if(s.name!=="ConnectionError")throw s}})}leave(e=null){return this._platform.logger.wrapOrRun(e,"leave room",async t=>{t.set("id",this.id),await this._hsApi.leave(this.id,{log:t}).response()})}_getPendingEvents(){return this._sendQueue.pendingEvents}_runRoomStateHandlers(e,t,r,i){const s=[];return qs(e,o=>{s.push(this._roomStateHandler.handleRoomState(this,o,t,r,i))}),Promise.all(s)}_emitSyncRoomState(e){qs(e,t=>{for(const r of this._roomStateObservers)r.handleStateEvent(t)})}writeIsTrackingMembers(e,t){return this._summary.writeIsTrackingMembers(e,t)}applyIsTrackingMembersChanges(e){this._summary.applyChanges(e)}createAttachment(e,t){return new H0({blob:e,filename:t,platform:this._platform})}dispose(){super.dispose(),this._sendQueue.dispose()}}class pF extends j0{constructor(e){super(e),this._releaseCallback=e.releaseCallback,this._forgetCallback=e.forgetCallback,this._retentionCount=1,this._kickDetails=null,this._kickedBy=null}retain(){this._retentionCount+=1}release(){this._retentionCount-=1,this._retentionCount===0&&this._releaseCallback()}async _getKickAuthor(e,t){const r=await t.roomMembers.get(this.id,e);return r?new ye(r):ye.fromUserId(this.id,e,"join")}async load(e,t,r){const{summary:i,kickDetails:s}=e;return this._kickDetails=s,this._kickDetails&&(this._kickedBy=await this._getKickAuthor(this._kickDetails.sender,t)),super.load(i,t,r)}async writeSync(e,t,r,i,s){if(s.set("id",this.id),r==="leave"){const o=mF(t,this._user.id);if(o||e){const a=o||this._kickDetails;let c;o&&(c=await this._getKickAuthor(o.sender,i));const u=e||this._summary.data;return i.archivedRoomSummary.set({summary:u.serialize(),kickDetails:a}),{kickDetails:a,kickedBy:c,summaryData:u}}}else r==="join"&&i.archivedRoomSummary.remove(this.id);return{}}afterSync({summaryData:e,kickDetails:t,kickedBy:r},i){i.set("id",this.id),e&&this._summary.applyChanges(e),t&&(this._kickDetails=t),r&&(this._kickedBy=r),this._emitUpdate()}get isKicked(){var e;return((e=this._kickDetails)==null?void 0:e.membership)==="leave"}get isBanned(){var e;return((e=this._kickDetails)==null?void 0:e.membership)==="ban"}get kickedBy(){return this._kickedBy}get kickReason(){var e;return(e=this._kickDetails)==null?void 0:e.reason}isArchived(){return!0}forget(e=null){return this._platform.logger.wrapOrRun(e,"forget room",async t=>{t.set("id",this.id),await this._hsApi.forget(this.id,{log:t}).response();const r=this._storage.storeNames,i=await this._storage.readWriteTxn([r.roomState,r.archivedRoomSummary,r.roomMembers,r.timelineEvents,r.timelineFragments,r.timelineRelations,r.pendingEvents,r.inboundGroupSessions,r.groupSessionDecryptions,r.operations]);i.roomState.removeAllForRoom(this.id),i.archivedRoomSummary.remove(this.id),i.roomMembers.removeAllForRoom(this.id),i.timelineEvents.removeAllForRoom(this.id),i.timelineFragments.removeAllForRoom(this.id),i.timelineRelations.removeAllForRoom(this.id),i.pendingEvents.removeAllForRoom(this.id),i.inboundGroupSessions.removeAllForRoom(this.id),i.groupSessionDecryptions.removeAllForRoom(this.id),await i.operations.removeAllForScope(this.id),await i.complete(),this._retentionCount=0,this._releaseCallback(),this._forgetCallback(this.id)})}join(e=null){return this._platform.logger.wrapOrRun(e,"rejoin archived room",async t=>{await this._hsApi.join(this.id,{log:t}).response()})}}function mF(n,e){var t,r;let i;if(qs(n,s=>{s.type===zt&&s.state_key===e&&s.sender!==s.state_key&&(i=s)}),i)return{membership:(t=i.content)==null?void 0:t.membership,reason:(r=i.content)==null?void 0:r.reason,sender:i.sender}}async function _F(n,e,t){const r=await Promise.all(n.map(async i=>{const s=await e.profile(i,{log:t}).response();return new gF(i,s.displayname,s.avatar_url)}));return r.sort((i,s)=>i.name.localeCompare(s.name)),r}class gF{constructor(e,t,r){this.userId=e,this.displayName=t,this.avatarUrl=r}get name(){return this.displayName||this.userId}}class yF{constructor(e){this.userId=e}get displayName(){}get name(){return this.userId}get avatarUrl(){}}function vF(n){switch(n){case Fn.DirectMessage:case Fn.Private:return!0;case Fn.Public:return!1}}function wF(n){switch(n){case Fn.DirectMessage:return"trusted_private_chat";case Fn.Private:return"private_chat";case Fn.Public:return"public_chat"}}class bF extends kr{constructor(e,t,r,i,s,o){var a;if(super(),this.id=e,this.options=t,this.updateCallback=r,this.mediaRepository=i,this.platform=s,this.profiles=[],this._isCancelled=!1,this.isEncrypted=t.isEncrypted===void 0?vF(t.visibility):t.isEncrypted,t.name)this._calculatedName=t.name;else{const c={joinCount:1,inviteCount:((a=t.invites)==null?void 0:a.length)||0},u=(t.invites||[]).map(l=>new yF(l));this._calculatedName=hp(u,c,o)}}async create(e,t){try{let r;if(this.options.avatar){const{avatar:o}=this.options;if(r={info:o.info},"blob"in o){const a=new H0({filename:o.name,blob:o.blob,platform:this.platform});await a.upload(e,()=>{},t),a.applyToContent("url",r)}else r.url=o.url}const i={is_direct:this.options.visibility===Fn.DirectMessage,preset:wF(this.options.visibility),initial_state:[]};if(this.options.name&&(i.name=this.options.name),this.options.topic&&(i.topic=this.options.topic),this.options.invites&&(i.invite=this.options.invites),this.options.alias&&(i.room_alias_name=this.options.alias),this.options.type!==void 0){let o;this.options.type===Lu.World&&(o="org.matrix.msc3815.world"),this.options.type===Lu.Profile&&(o="org.matrix.msc3815.profile"),i.creation_content={type:o}}this.options.isFederationDisabled===!0&&(i.creation_content===void 0&&(i.creation_content={}),i.creation_content["m.federate"]=!1),this.isEncrypted&&i.initial_state.push(wN()),r&&i.initial_state.push({type:"m.room.avatar",state_key:"",content:r}),this.options.powerLevelContentOverride&&(i.power_level_content_override=this.options.powerLevelContentOverride),this.options.initialState&&i.initial_state.push(...this.options.initialState);const s=await e.createRoom(i,{log:t}).response();this._roomId=s.room_id}catch(r){this._error=r}this.emitChange()}async loadProfiles(e,t){try{if(!this.options.name&&this.options.invites){this.profiles=await _F(this.options.invites,e,t);const r={joinCount:1,inviteCount:this.options.invites.length};this._calculatedName=hp(this.profiles,r,t),this.emitChange()}}catch{}}emitChange(e){this.updateCallback(this,e),this.emit("change")}get avatarColorId(){var e,t,r;return(r=(t=(e=this.options.invites)==null?void 0:e[0])!=null?t:this._roomId)!=null?r:this.id}get avatarUrl(){var e,t;return(t=(e=this.profiles)==null?void 0:e[0])==null?void 0:t.avatarUrl}get avatarBlobUrl(){const e=this.options.avatar;if(!(!e||!("blob"in e)))return e.blob.url}get roomId(){return this._roomId}get name(){return this._calculatedName}get isBeingCreated(){return!0}get error(){return this._error}cancel(){this._isCancelled||(this.dispose(),this._isCancelled=!0,this.emitChange("isCancelled"))}get isCancelled(){return this._isCancelled}dispose(){this.options.avatar&&"blob"in this.options.avatar&&this.options.avatar.blob.dispose()}async adjustDirectMessageMapIfNeeded(e,t,r,i){if(!this.options.invites||this.options.visibility!==Fn.DirectMessage)return;const s=this.options.invites[0],o="m.direct";await i.wrap("set "+o,async a=>{try{const c=await t.readWriteTxn([t.storeNames.accountData]);let u;try{u=await c.accountData.get(o),u||(u={type:o,content:{}});const l=u.content;let d=l[s];d||(l[s]=d=[]),d.push(this._roomId),c.accountData.set(u),await c.complete()}catch(l){throw c.abort(),l}await r.setAccountData(e.id,o,u.content,{log:a}).response()}catch(c){a.catch(c)}})}}class SF extends kr{constructor({roomId:e,user:t,hsApi:r,mediaRepository:i,emitCollectionRemove:s,emitCollectionUpdate:o,platform:a}){super(),this._roomId=e,this._user=t,this._hsApi=r,this._emitCollectionRemove=s,this._emitCollectionUpdate=o,this._mediaRepository=i,this._platform=a,this._inviteData=null,this._accepting=!1,this._rejecting=!1,this._accepted=!1,this._rejected=!1}get isInvite(){return!0}get id(){return this._roomId}get name(){return this._inviteData.name||this._inviteData.canonicalAlias}get isDirectMessage(){return this._inviteData.isDirectMessage}get avatarUrl(){return this._inviteData.avatarUrl}get avatarColorId(){return this._inviteData.avatarColorId||this.id}get type(){var e;return(e=this._inviteData.type)!=null?e:void 0}get timestamp(){return this._inviteData.timestamp}get isEncrypted(){return this._inviteData.isEncrypted}get inviter(){return this._inviter}isDirectMessageForUserId(e){return this.isDirectMessage&&this._inviter.userId===e}get isPublic(){return this._inviteData.joinRule==="public"}get canonicalAlias(){return this._inviteData.canonicalAlias}async accept(e=null){await this._platform.logger.wrapOrRun(e,"acceptInvite",async t=>{var r;this._accepting=!0,this._emitChange("accepting"),await this._hsApi.joinIdOrAlias((r=this.canonicalAlias)!=null?r:this._roomId,{log:t}).response()})}async reject(e=null){await this._platform.logger.wrapOrRun(e,"rejectInvite",async t=>{this._rejecting=!0,this._emitChange("rejecting"),await this._hsApi.leave(this._roomId,{log:t}).response()})}get accepting(){return this._accepting}get accepted(){return this._accepted}get rejecting(){return this._rejecting}get rejected(){return this._rejected}get mediaRepository(){return this._mediaRepository}_emitChange(e){this.emit("change"),this._emitCollectionUpdate(this,e)}load(e,t){t.set("id",this.id),this._inviteData=e,this._inviter=e.inviter?new ye(e.inviter):null}async writeSync(e,t,r,i){var s;if(e==="invite"){i.set("id",this.id),i.set("add",!0);const o=(s=t.invite_state)==null?void 0:s.events;if(!Array.isArray(o))return null;const a=this._createSummaryData(o);let c;!a.name&&!a.canonicalAlias&&(c=await this._createHeroes(o,i));const u=this._getMyInvite(o);if(!u)return null;const l=this._getInviter(u,o),d=this._createData(o,u,l,a,c);return r.invites.set(d),{inviteData:d,inviter:l}}else return i.set("id",this.id),i.set("membership",e),r.invites.remove(this.id),{removed:!0,membership:e}}afterSync(e,t){t.set("id",this.id),e&&(e.removed?(this._accepting=!1,this._rejecting=!1,e.membership==="join"?this._accepted=!0:this._rejected=!0,this.emit("change")):(this._inviteData=e.inviteData,this._inviter=e.inviter))}_createData(e,t,r,i,s){const o=s?s.roomName:i.name,a=s?s.roomAvatarUrl:i.avatarUrl,c=(s==null?void 0:s.roomAvatarColorId)||this.id;return{roomId:this.id,isEncrypted:!!i.encryption,isDirectMessage:i.isDirectMessage,type:i.type,name:o,avatarUrl:a,avatarColorId:c,canonicalAlias:i.canonicalAlias,timestamp:this._platform.clock.now(),joinRule:this._getJoinRule(e),inviter:r==null?void 0:r.serialize()}}_createSummaryData(e){return e.reduce((t,r)=>O0(t,r,this._user.id),new sr(null,this.id))}async _createHeroes(e,t){const r=e.filter(l=>l.type===zt),i=r.filter(l=>l.state_key!==this._user.id),s=i.reduce((l,d)=>{const p=ye.fromMemberEvent(this.id,d);return l.set(p.userId,new QE(p,null)),l},new Map),o=i.map(l=>l.state_key),a=new k_(this.id),c=await a.calculateChanges(o,s,null),u=new sr(null,this.id);return u.joinCount=r.reduce((l,d)=>{var p;return l+(((p=d.content)==null?void 0:p.membership)==="join"?1:0)},0),u.inviteCount=r.reduce((l,d)=>{var p;return l+(((p=d.content)==null?void 0:p.membership)==="invite"?1:0)},0),a.applyChanges(c,u,t),a}_getMyInvite(e){return e.find(t=>t.type===zt&&t.state_key===this._user.id)}_getInviter(e,t){const r=t.find(i=>i.type===zt&&i.state_key===e.sender);if(r)return ye.fromMemberEvent(this.id,r)}_getJoinRule(e){var t;const r=e.find(i=>i.type==="m.room.join_rules");return r?(t=r.content)==null?void 0:t.join_rule:null}}class Ni{constructor(e){this._description=e}static httpPusher(e,t,r,i){return new Ni({kind:"http",append:!0,data:Object.assign({},i,{url:e+"/_matrix/push/v1/notify"}),pushkey:r,app_id:t,app_display_name:"Hydrogen",device_display_name:"Hydrogen",lang:"en"})}static createDefaultPayload(e){return{session_id:e}}async enable(e,t){try{t.set("endpoint",new URL(this._description.data.endpoint).host)}catch{t.set("endpoint",null)}await e.setPusher(this._description,{log:t}).response()}async disable(e,t){const r=Object.assign({},this._description,{kind:null});await e.setPusher(r,{log:t}).response()}serialize(){return this._description}equals(e){return this._description.app_id!==e._description.app_id||this._description.pushkey!==e._description.pushkey?!1:JSON.stringify(this._description.data)===JSON.stringify(e._description.data)}}class EF extends kr{constructor({storage:e,callHandler:t}){super(),this._storage=e,this._olmDecryption=null,this._megolmDecryption=null,this._callHandler=t,this._senderDeviceCache=new V0(10,r=>r.curve25519Key)}enableEncryption({olmDecryption:e,megolmDecryption:t}){this._olmDecryption=e,this._megolmDecryption=t}obtainSyncLock(e){var t;return(t=this._olmDecryption)==null?void 0:t.obtainDecryptionLock(e)}async prepareSync(e,t,r,i){i.set("messageTypes",bv(e,a=>a.type));const s=e.filter(a=>a.type==="m.room.encrypted");if(this._emitUnencryptedEvents(e),!this._olmDecryption){i.log("can't decrypt, encryption not enabled",i.level.Warn);return}const o=s.filter(a=>{var c;return((c=a.content)==null?void 0:c.algorithm)===d_});if(o.length){const a=await this._olmDecryption.decryptAll(o,t,r);i.set("decryptedTypes",bv(a.results,u=>{var l;return(l=u.event)==null?void 0:l.type}));for(const u of a.errors)i.child("decrypt_error").catch(u);const c=this._megolmDecryption.roomKeysFromDeviceMessages(a.results,i);return new kF(a,c)}}async writeSync(e,t){return e.olmDecryptChanges.write(t),{hasNewRoomKeys:(await Promise.all(e.newRoomKeys.map(s=>this._megolmDecryption.writeRoomKey(s,t)))).some(s=>!!s),decryptionResults:e.olmDecryptChanges.results}}async afterSyncCompleted(e,t,r,i){if(this._emitEncryptedEvents(e),this._callHandler){const s=e.filter(o=>{var a;return this._callHandler.handlesDeviceMessageEventType((a=o.event)==null?void 0:a.type)});s.length&&await i.wrap("process call signalling messages",async o=>{for(const a of s){const c=await t.deviceForId(a.event.sender,a.event.content.device_id,r,o);a.setDevice(c),a.isVerified?this._callHandler.handleDeviceMessage(a.event,a.userId,a.deviceId,o):o.log({l:"could not verify olm fingerprint key matches, ignoring",ed25519Key:a.device.ed25519Key,claimedEd25519Key:a.claimedEd25519Key,deviceId:c.deviceId,userId:c.userId})}})}}_emitUnencryptedEvents(e){const t=e.filter(r=>r.type!=="m.room.encrypted");for(const r of t)this.emit("message",{unencrypted:r})}_emitEncryptedEvents(e){}}class kF{constructor(e,t){this.olmDecryptChanges=e,this.newRoomKeys=t,this.newKeysByRoom=co(t,r=>r.roomId)}}const wa=nn+"olmAccount",fp=nn+"areDeviceKeysUploaded",qc=nn+"serverOTKCount";async function Gv(n,e,t,r,i){const s=n.pickle(e),o=await i.readWriteTxn([i.storeNames.session]);try{o.session.add(wa,s),o.session.add(fp,t),o.session.add(qc,r)}catch(a){throw o.abort(),a}await o.complete()}class Xi{static async load({olm:e,pickleKey:t,hsApi:r,userId:i,deviceId:s,olmWorker:o,txn:a}){const c=await a.session.get(wa);if(c){const u=new e.Account,l=await a.session.get(fp);u.unpickle(t,c);const d=await a.session.get(qc);return new Xi({pickleKey:t,hsApi:r,account:u,userId:i,deviceId:s,areDeviceKeysUploaded:l,serverOTKCount:d,olm:e,olmWorker:o})}}static async adoptDehydratedDevice({olm:e,dehydratedDevice:t,pickleKey:r,hsApi:i,userId:s,olmWorker:o,storage:a}){const c=t.adoptUnpickledOlmAccount(),u=JSON.parse(c.one_time_keys()),d=Object.entries(u.curve25519).length,p=!0;return await Gv(c,r,p,d,a),new Xi({pickleKey:r,hsApi:i,account:c,userId:s,deviceId:t.deviceId,areDeviceKeysUploaded:p,serverOTKCount:d,olm:e,olmWorker:o})}static async create({olm:e,pickleKey:t,hsApi:r,userId:i,deviceId:s,olmWorker:o,storage:a}){const c=new e.Account;o?await o.createAccountAndOTKs(c,c.max_number_of_one_time_keys()):(c.create(),c.generate_one_time_keys(c.max_number_of_one_time_keys()));const u=!1,l=0;return a&&await Gv(c,t,u,l,a),new Xi({pickleKey:t,hsApi:r,account:c,userId:i,deviceId:s,areDeviceKeysUploaded:u,serverOTKCount:l,olm:e,olmWorker:o})}constructor({pickleKey:e,hsApi:t,account:r,userId:i,deviceId:s,areDeviceKeysUploaded:o,serverOTKCount:a,olm:c,olmWorker:u}){this._olm=c,this._pickleKey=e,this._hsApi=t,this._account=r,this._userId=i,this._deviceId=s,this._areDeviceKeysUploaded=o,this._serverOTKCount=a,this._olmWorker=u,this._identityKeys=JSON.parse(this._account.identity_keys())}get identityKeys(){return this._identityKeys}setDeviceId(e){this._deviceId=e}async uploadKeys(e,t,r){var i;const s=JSON.parse(this._account.one_time_keys()),o=Object.entries(s.curve25519);if(o.length||!this._areDeviceKeysUploaded){const a={};if(!this._areDeviceKeysUploaded){r.set("identity",!0);const l=JSON.parse(this._account.identity_keys());a.device_keys=this._deviceKeysPayload(l)}o.length&&(r.set("otks",!0),a.one_time_keys=this._oneTimeKeysPayload(o));const c=t?this._deviceId:void 0,u=await this._hsApi.uploadKeys(c,a,{log:r}).response();this._serverOTKCount=(i=u==null?void 0:u.one_time_key_counts)==null?void 0:i.signed_curve25519,r.set("serverOTKCount",this._serverOTKCount),await this._updateSessionStorage(e,l=>{o.length&&(this._account.mark_keys_as_published(),l==null||l.set(wa,this._account.pickle(this._pickleKey)),l==null||l.set(qc,this._serverOTKCount)),this._areDeviceKeysUploaded||(this._areDeviceKeysUploaded=!0,l==null||l.set(fp,this._areDeviceKeysUploaded))})}}async generateOTKsIfNeeded(e,t){const r=this._account.max_number_of_one_time_keys(),i=Math.floor(r/2);if(this._serverOTKCount<i){const s=JSON.parse(this._account.one_time_keys()),a=Object.entries(s.curve25519).length,c=i-a-this._serverOTKCount;return c>0&&await t.wrap("generate otks",u=>{u.set("max",r),u.set("server",this._serverOTKCount),u.set("unpublished",a),u.set("new",c),u.set("limit",i),this._account.generate_one_time_keys(c),this._updateSessionStorage(e,l=>{l.set(wa,this._account.pickle(this._pickleKey))})}),!0}return!1}createInboundOlmSession(e,t){const r=new this._olm.Session;try{return r.create_inbound_from(this._account,e,t),r}catch(i){throw r.free(),i}}async createOutboundOlmSession(e,t){const r=new this._olm.Session;try{return this._olmWorker?await this._olmWorker.createOutboundOlmSession(this._account,r,e,t):r.create_outbound(this._account,e,t),r}catch(i){throw r.free(),i}}writeRemoveOneTimeKey(e,t){this._account.remove_one_time_keys(e),t.session.set(wa,this._account.pickle(this._pickleKey))}writeSync(e,t,r){const i=e.signed_curve25519;if(Number.isSafeInteger(i)&&i!==this._serverOTKCount)return t.session.set(qc,i),r.set("otkCount",i),i}afterSync(e){Number.isSafeInteger(e)&&(this._serverOTKCount=e)}_keysAsSignableObject(e){const t={user_id:this._userId,device_id:this._deviceId,algorithms:[d_,Kn],keys:{}};for(const[r,i]of Object.entries(e))t.keys[`${r}:${this._deviceId}`]=i;return t}getUnsignedDeviceKey(){const e=JSON.parse(this._account.identity_keys());return this._keysAsSignableObject(e)}_deviceKeysPayload(e){const t=this._keysAsSignableObject(e);return this.signObject(t),t}_oneTimeKeysPayload(e){const t={};for(const[r,i]of e){const s={key:i};this.signObject(s),t[`signed_curve25519:${r}`]=s}return t}async _updateSessionStorage(e,t){if(e){const r=await e.readWriteTxn([e.storeNames.session]);try{await t(r.session)}catch(i){throw r.abort(),i}await r.complete()}else await t(void 0)}signObject(e){const t=e.signatures||{},r=e.unsigned;delete e.signatures,delete e.unsigned,t[this._userId]=t[this._userId]||{},t[this._userId]["ed25519:"+this._deviceId]=this._account.sign(Cl.stringify(e)),e.signatures=t,r!==void 0&&(e.unsigned=r)}pickleWithKey(e){return this._account.pickle(e)}dispose(){this._account.free(),this._account=void 0}}const z0="org.matrix.msc2697.v1.olm.libolm_pickle";async function IF(n,e,t,r){try{const i=await n.getDehydratedDevice({log:r}).response();if(i.device_data.algorithm===z0)return new RF(i,e,t)}catch(i){i.name!=="HomeServerError"&&(r.error=i);return}}async function TF(n,e,t,r,i){var s;const a=(await e.createDehydratedDevice({device_data:{algorithm:z0,account:n.pickleWithKey(t.binaryKey.slice()),passphrase:((s=t.description)==null?void 0:s.passphraseParams)||{}},initial_device_display_name:r}).response()).device_id;return n.setDeviceId(a),await n.uploadKeys(void 0,!0,i),a}class RF{constructor(e,t,r){this._dehydratedDevice=e,this._olm=t,this._platform=r}async decrypt(e,t){const r=new g_("dehydrated_device",this._dehydratedDevice.device_data.passphrase),i=await b0(e,t,r,this._platform,this._olm),s=new this._olm.Account;try{const o=this._dehydratedDevice.device_data.account;return s.unpickle(i.binaryKey.slice(),o),new CF(this._dehydratedDevice,s,i)}catch(o){if(s.free(),o.message==="OLM.BAD_ACCOUNT_KEY")return;throw o}}get deviceId(){return this._dehydratedDevice.device_id}}class CF{constructor(e,t,r){this._dehydratedDevice=e,this._account=t,this._key=r}async claim(e,t){try{return(await e.claimDehydratedDevice(this.deviceId,{log:t}).response()).success}catch{return!1}}adoptUnpickledOlmAccount(){const e=this._account;return this._account=void 0,e}get deviceId(){return this._dehydratedDevice.device_id}get key(){return this._key}dispose(){var e;(e=this._account)==null||e.free(),this._account=void 0}}class G0{tryTake(){return this._promise?!1:(this._promise=new Promise(e=>{this._resolve=e}),!0)}async take(){for(;!this.tryTake();)await this.released()}get isTaken(){return!!this._promise}release(){if(this._resolve){this._promise=void 0;const e=this._resolve;this._resolve=void 0,e()}}released(){return this._promise}}class q0{constructor(e){this.locks=e}release(){for(const e of this.locks)e.release()}}function W0(n,e,t,r){return{session:n.pickle(r),sessionId:n.session_id(),senderKey:e,lastUsed:t}}class Hu{constructor(e,t,r,i=!1){this.data=e,this.pickleKey=t,this.olm=r,this.isNew=i,this.isModified=i}static create(e,t,r,i,s){const o=W0(t,e,s,i);return new Hu(o,i,r,!0)}get id(){return this.data.sessionId}load(){const e=new this.olm.Session;return e.unpickle(this.pickleKey,this.data.session),e}unload(e){e.free()}save(e){this.data.session=e.pickle(this.pickleKey),this.isModified=!0}}class Y0{constructor(e,t,r,i){this.event=e,this.senderCurve25519Key=t,this.claimedEd25519Key=r,this.encryptedEvent=i}setDevice(e){this.device=e}get isVerified(){return this.device?Gi(this.device)===this.claimedEd25519Key:!1}get isUnverified(){return this.device?!this.isVerified:!0}get userId(){var e;return(e=this.device)==null?void 0:e.user_id}get deviceId(){var e;return(e=this.device)==null?void 0:e.device_id}get isVerificationUnknown(){return!this.device}}var zu=(n=>(n[n.PreKey=0]="PreKey",n[n.Normal=1]="Normal",n))(zu||{});const qv=4;function X0(n){n.sort((e,t)=>t.data.lastUsed-e.data.lastUsed)}class MF{constructor(e,t,r,i,s,o){this.account=e,this.pickleKey=t,this.now=r,this.ownUserId=i,this.olm=s,this.senderKeyLock=o}async obtainDecryptionLock(e){var t;const r=new Set;for(const s of e){const o=(t=s.content)==null?void 0:t.sender_key;o&&r.add(o)}const i=await Promise.all(Array.from(r).map(s=>this.senderKeyLock.takeLock(s)));return new q0(i)}async decryptAll(e,t,r){try{const i=co(e,l=>{var d;return(d=l.content)==null?void 0:d.sender_key}),s=this.now(),o=await Promise.all(Array.from(i.entries()).map(([l,d])=>this._decryptAllForSenderKey(l,d,s,r))),a=o.reduce((l,d)=>l.concat(d.results),[]),c=o.reduce((l,d)=>l.concat(d.errors),[]),u=o.map(l=>l.senderKeyDecryption);return new AF(u,a,c,this.account,t)}catch(i){throw t.release(),i}}async _decryptAllForSenderKey(e,t,r,i){const s=await this._getSessions(e,i),o=new xF(e,s,r),a=[],c=[];for(const u of t)try{const l=this._decryptForSenderKey(o,u,r);a.push(l)}catch(l){c.push(l)}return{results:a,errors:c,senderKeyDecryption:o}}_decryptForSenderKey(e,t,r){const i=e.senderKey,s=this._getMessageAndValidateEvent(t);let o;try{o=e.decrypt(s)}catch(a){throw new ut("OLM_BAD_ENCRYPTED_MESSAGE",t,{senderKey:i,error:a.message})}if(typeof o!="string"&&s.type===zu.PreKey){let a;try{a=this._createSessionAndDecrypt(i,s,r)}catch(c){throw new ut(`Could not create inbound olm session: ${c.message}`,t,{senderKey:i,error:c})}e.addNewSession(a.session),o=a.plaintext}if(typeof o=="string"){let a;try{a=JSON.parse(o)}catch(c){throw new ut("PLAINTEXT_NOT_JSON",t,{plaintext:o,error:c})}return this._validatePayload(a,t),new Y0(a,i,a.keys.ed25519)}else throw new ut("OLM_NO_MATCHING_SESSION",t,{knownSessionIds:e.sessions.map(a=>a.id)})}_createSessionAndDecrypt(e,t,r){let i;const s=this.account.createInboundOlmSession(e,t.body);try{i=s.decrypt(t.type,t.body);const o=Hu.create(e,s,this.olm,this.pickleKey,r);return o.unload(s),{session:o,plaintext:i}}catch(o){throw s.free(),o}}_getMessageAndValidateEvent(e){var t;const r=(t=e.content)==null?void 0:t.ciphertext;if(!r)throw new ut("OLM_MISSING_CIPHERTEXT",e);const i=r==null?void 0:r[this.account.identityKeys.curve25519];if(!i)throw new ut("OLM_NOT_INCLUDED_IN_RECIPIENTS",e);return i}async _getSessions(e,t){const i=(await t.olmSessions.getAll(e)).map(s=>new Hu(s,this.pickleKey,this.olm));return X0(i),i}_validatePayload(e,t){var r,i,s;if(e.sender!==t.sender)throw new ut("OLM_FORWARDED_MESSAGE",t,{sentBy:t.sender,encryptedBy:e.sender});if(e.recipient!==this.ownUserId)throw new ut("OLM_BAD_RECIPIENT",t,{recipient:e.recipient});if(((r=e.recipient_keys)==null?void 0:r.ed25519)!==this.account.identityKeys.ed25519)throw new ut("OLM_BAD_RECIPIENT_KEY",t,{key:(i=e.recipient_keys)==null?void 0:i.ed25519});if(!e.type)throw new ut("missing type on payload",t,{payload:e});if(typeof((s=e.keys)==null?void 0:s.ed25519)!="string")throw new ut("Missing or invalid claimed ed25519 key on payload",t,{payload:e})}}class xF{constructor(e,t,r){this.senderKey=e,this.sessions=t,this.timestamp=r}addNewSession(e){this.sessions.unshift(e)}decrypt(e){for(const t of this.sessions){const r=this.decryptWithSession(t,e);if(typeof r=="string")return X0(this.sessions),r}}getModifiedSessions(){return this.sessions.filter(e=>e.isModified)}get hasNewSessions(){return this.sessions.some(e=>e.isNew)}decryptWithSession(e,t){if(t.type===void 0||t.body===void 0)throw new Error("Invalid message without type or body");const r=e.load();try{if(t.type===zu.PreKey&&!r.matches_inbound(t.body))return;try{const i=r.decrypt(t.type,t.body);return e.save(r),e.data.lastUsed=this.timestamp,i}catch(i){if(t.type===zu.PreKey)throw new Error(`Error decrypting prekey message with existing session id ${e.id}: ${i.message}`);return}}finally{e.unload(r)}}}class AF{constructor(e,t,r,i,s){this.senderKeyDecryptions=e,this.results=t,this.errors=r,this.account=i,this.lock=s}get hasNewSessions(){return this.senderKeyDecryptions.some(e=>e.hasNewSessions)}write(e){try{for(const t of this.senderKeyDecryptions){for(const r of t.getModifiedSessions())if(e.olmSessions.set(r.data),r.isNew){const i=r.load();try{this.account.writeRemoveOneTimeKey(i,e)}finally{r.unload(i)}}if(t.sessions.length>qv){const{senderKey:r,sessions:i}=t;for(let s=i.length-1;s>=qv;s-=1){const o=i[s];e.olmSessions.remove(r,o.id)}}}}finally{this.lock.release()}}}function DF(n){return n.reduce((e,t)=>!e||t<e?t:e,null)}const Wv="signed_curve25519",Ic=20;class NF{constructor(e,t,r,i,s,o,a,c){this.account=e,this.pickleKey=t,this.olm=r,this.storage=i,this.now=s,this.ownUserId=o,this.olmUtil=a,this.senderKeyLock=c,this._batchLocks=new Array(Ic);for(let u=0;u<Ic;u+=1)this._batchLocks[u]=new G0}async _takeBatchLock(e){const t=this._batchLocks.filter(r=>!r.isTaken).slice(0,e);if(t.length<e){const r=this._batchLocks.filter(i=>i.isTaken).slice(0,e-t.length);t.push(...r)}return await Promise.all(t.map(r=>r.take())),new q0(t)}async encrypt(e,t,r,i,s){let o=[];for(let a=0;a<r.length;a+=Ic){const c=r.slice(a,a+Ic),u=await this._takeBatchLock(c.length);try{const l=await this._encryptForMaxDevices(e,t,c,i,s);o=o.concat(l)}finally{u.release()}}return o}async _encryptForMaxDevices(e,t,r,i,s){const o=await Promise.all(r.map(a=>this.senderKeyLock.takeLock(nr(a))));try{const{devicesWithoutSession:a,existingEncryptionTargets:c}=await this._findExistingSessions(r),u=this.now();let l=[];try{if(a.length){const m=await s.wrap("create sessions",w=>this._createNewSessions(a,i,u,w));l=l.concat(m)}await this._loadSessions(c),l=l.concat(c);const d={l:"encrypt",targets:l.length},p=s.wrap(d,()=>l.map(m=>{const w=this._encryptForDevice(e,t,m);return new PF(w,m.device)}));return await this._storeSessions(l,u),p}finally{for(const d of l)d.dispose()}}finally{for(const a of o)a.release()}}async _findExistingSessions(e){const t=await this.storage.readTxn([this.storage.storeNames.olmSessions]),r=await Promise.all(e.map(async o=>await t.olmSessions.getSessionIds(nr(o)))),i=e.filter((o,a)=>{const c=r[a];return!(c!=null&&c.length)}),s=e.map((o,a)=>{const c=r[a];if((c==null?void 0:c.length)>0){const u=DF(c);return gl.fromSessionId(o,u)}}).filter(o=>!!o);return{devicesWithoutSession:i,existingEncryptionTargets:s}}_encryptForDevice(e,t,r){const{session:i,device:s}=r,o=JSON.stringify(this._buildPlainTextMessageForDevice(e,t,s)),a=i.encrypt(o);return{algorithm:d_,sender_key:this.account.identityKeys.curve25519,ciphertext:{[nr(s)]:a}}}_buildPlainTextMessageForDevice(e,t,r){return{keys:{ed25519:this.account.identityKeys.ed25519},recipient_keys:{ed25519:Gi(r)},recipient:r.user_id,sender:this.ownUserId,content:t,type:e}}async _createNewSessions(e,t,r,i){const s=await i.wrap("claim",o=>this._claimOneTimeKeys(t,e,o));try{for(const o of s){const{device:a,oneTimeKey:c}=o;o.session=await this.account.createOutboundOlmSession(nr(a),c)}await this._storeSessions(s,r)}catch(o){for(const a of s)a.dispose();throw o}return s}async _claimOneTimeKeys(e,t,r){const i=m_(t,c=>c.user_id,()=>new Map,(c,u)=>c.set(u.device_id,u)),s=Array.from(i.entries()).reduce((c,[u,l])=>(c[u]=Array.from(l.values()).reduce((d,p)=>(d[p.device_id]=Wv,d),{}),c),{}),o=await e.claimKeys({timeout:1e4,one_time_keys:s},{log:r}).response();Object.keys(o.failures).length&&r.log({l:"failures",servers:Object.keys(o.failures)},r.level.Warn);const a=o==null?void 0:o.one_time_keys;return this._verifyAndCreateOTKTargets(a,i,r)}_verifyAndCreateOTKTargets(e,t,r){var i;const s=[];for(const[o,a]of Object.entries(e))for(const[c,u]of Object.entries(a)){const[l,d]=Object.entries(u)[0],[p]=l.split(":");if(p===Wv){const m=(i=t.get(o))==null?void 0:i.get(c);if(m&&h_(this.olmUtil,o,c,Gi(m),d,r)===Ue.Valid){const S=gl.fromOTK(m,d.key);s.push(S)}}}return s}async _loadSessions(e){const t=await this.storage.readTxn([this.storage.storeNames.olmSessions]);let r=!1;try{await Promise.all(e.map(async i=>{const s=await t.olmSessions.get(nr(i.device),i.sessionId);if(s&&!r){const o=new this.olm.Session;o.unpickle(this.pickleKey,s.session),i.session=o}}))}catch(i){r=!0;for(const s of e)s.dispose();throw i}}async _storeSessions(e,t){const r=await this.storage.readWriteTxn([this.storage.storeNames.olmSessions]);try{for(const i of e){const s=W0(i.session,nr(i.device),t,this.pickleKey);r.olmSessions.set(s)}}catch(i){throw r.abort(),i}await r.complete()}}class gl{constructor(e,t,r){this.device=e,this.oneTimeKey=t,this.sessionId=r,this.session=null}static fromOTK(e,t){return new gl(e,t,null)}static fromSessionId(e,t){return new gl(e,null,t)}dispose(){this.session&&this.session.free()}}class PF{constructor(e,t){this.content=e,this.device=t}}class OF{constructor(e,t,r,i){this._roomId=e,this._results=t,this._errors=r,this._replayEntries=i}async write(e){return await Promise.all(this._replayEntries.map(async t=>{try{this._handleReplayAttack(this._roomId,t,e)}catch(r){this._errors.set(t.eventId,r)}})),{results:this._results,errors:this._errors}}async _handleReplayAttack(e,t,r){const{messageIndex:i,sessionId:s,eventId:o,timestamp:a}=t,c=await r.groupSessionDecryptions.get(e,s,i);if(c&&c.eventId!==o){const l=c.timestamp<a?o:c.eventId;throw this._results.delete(o),new ut("MEGOLM_REPLAYED_INDEX",event,{messageIndex:i,badEventId:l,otherEventId:c.eventId})}c||r.groupSessionDecryptions.set(e,s,i,{eventId:o,timestamp:a})}}function pp(n,e){if(n)for(const[t,r]of n.entries())e.set(t,r)}class UF{constructor(e,t,r){this._roomId=e,this._sessionDecryptions=t,this._initialErrors=r}async decrypt(){try{const e=this._initialErrors,t=new Map,r=[];return await Promise.all(this._sessionDecryptions.map(async i=>{const s=await i.decryptAll();pp(s.errors,e),pp(s.results,t),r.push(...s.replayEntries)})),new OF(this._roomId,t,e,r)}finally{this.dispose()}}dispose(){for(const e of this._sessionDecryptions)e.dispose()}}class $F{constructor(e,t,r){this.sessionId=e,this.messageIndex=t,this.event=r}get eventId(){return this.event.event_id}get timestamp(){return this.event.origin_server_ts}}class LF{constructor(e,t,r,i){this.key=e,this.events=t,this.olmWorker=r,this.keyLoader=i,this.decryptionRequests=r?[]:void 0}async decryptAll(){const e=[],t=new Map;let r;return await this.keyLoader.useKey(this.key,async i=>{for(const s of this.events)try{const o=s.content.ciphertext;let a;if(this.olmWorker){const d=this.olmWorker.megolmDecrypt(i,o);this.decryptionRequests.push(d),a=await d.response()}else a=i.decrypt(o);const{plaintext:c}=a;let u;try{u=JSON.parse(c)}catch(d){throw new ut("PLAINTEXT_NOT_JSON",s,{plaintext:c,err:d})}if(u.room_id!==this.key.roomId)throw new ut("MEGOLM_WRONG_ROOM",s,{encryptedRoomId:u.room_id,eventRoomId:this.key.roomId});e.push(new $F(this.key.sessionId,a.message_index,s));const l=new Y0(u,this.key.senderKey,this.key.claimedEd25519Key,s);t.set(s.event_id,l)}catch(o){if(o.name==="AbortError")return;r||(r=new Map),r.set(s.event_id,o)}}),{results:t,errors:r,replayEntries:e}}dispose(){if(this.decryptionRequests)for(const e of this.decryptionRequests)e.abort()}}function I_(n){var e;return(e=n.content)==null?void 0:e.sender_key}function T_(n){var e;return(e=n.content)==null?void 0:e.session_id}function FF(n){var e;return(e=n.content)==null?void 0:e.ciphertext}function BF(n){return typeof I_(n)=="string"&&typeof T_(n)=="string"&&typeof FF(n)=="string"}class VF{constructor(){this.events=[]}get senderKey(){return I_(this.events[0])}get sessionId(){return T_(this.events[0])}}function mp(n){return m_(n,e=>`${I_(e)}|${T_(e)}`,()=>new VF,(e,t)=>e.events.push(t))}class J0{isForSession(e,t,r){return this.roomId===e&&this.senderKey===t&&this.sessionId===r}get isBetter(){return this._isBetter}set isBetter(e){this._isBetter=e}}function Q0(n,e){return n.first_known_index()<e.first_known_index()}class R_ extends J0{checkBetterThanKeyInStorage(e,t){return this._checkBetterThanKeyInStorage(e,void 0,t)}async write(e,t){let r;if(this.isBetter===void 0&&await this._checkBetterThanKeyInStorage(e,(s,o)=>{r=s.pickle(o)},t),this.isBetter===!1)return!1;r||(r=await e.useKey(this,(s,o)=>s.pickle(o)));const i={roomId:this.roomId,senderKey:this.senderKey,sessionId:this.sessionId,session:r,backup:this.backupStatus,source:this.keySource,claimedKeys:{ed25519:this.claimedEd25519Key}};return t.inboundGroupSessions.set(i),!0}get eventIds(){return this._eventIds}async _checkBetterThanKeyInStorage(e,t,r){if(this.isBetter!==void 0)return this.isBetter;let i=e.getCachedKey(this.roomId,this.senderKey,this.sessionId);if(!i){const s=await tk(this.roomId,this.senderKey,this.sessionId,r);s&&(s.hasSession?i=s:s.eventIds&&(this._eventIds=s.eventIds))}if(i){const s=i;await e.useKey(this,async o=>{await e.useKey(s,(a,c)=>{this.isBetter=Q0(o,a),s.isBetter=!this.isBetter,this.isBetter&&t&&t(o,c)})})}else this.isBetter=!0;return this.isBetter}get backupStatus(){return Ud.NotBackedUp}}class KF extends R_{constructor(e){super(),this._decryptionResult=e}get roomId(){var e;return(e=this._decryptionResult.event.content)==null?void 0:e.room_id}get senderKey(){return this._decryptionResult.senderCurve25519Key}get sessionId(){var e;return(e=this._decryptionResult.event.content)==null?void 0:e.session_id}get claimedEd25519Key(){return this._decryptionResult.claimedEd25519Key}get serializationKey(){var e;return(e=this._decryptionResult.event.content)==null?void 0:e.session_key}get serializationType(){return"create"}get keySource(){return xl.DeviceMessage}loadInto(e){e.create(this.serializationKey)}}class jF extends R_{constructor(e,t,r){super(),this._roomId=e,this.outboundSession=t,this.identityKeys=r,this.isBetter=!0,this._sessionKey=this.outboundSession.session_key()}get roomId(){return this._roomId}get senderKey(){return this.identityKeys.curve25519}get sessionId(){return this.outboundSession.session_id()}get claimedEd25519Key(){return this.identityKeys.ed25519}get serializationKey(){return this._sessionKey}get serializationType(){return"create"}get keySource(){return xl.Outbound}loadInto(e){e.create(this.serializationKey)}}class HF extends R_{constructor(e,t,r){super(),this._roomId=e,this._sessionId=t,this._backupInfo=r}get roomId(){return this._roomId}get senderKey(){return this._backupInfo.sender_key}get sessionId(){return this._sessionId}get claimedEd25519Key(){var e;return(e=this._backupInfo.sender_claimed_keys)==null?void 0:e.ed25519}get serializationKey(){return this._backupInfo.session_key}get serializationType(){return"import_session"}get keySource(){return xl.Backup}loadInto(e){e.import_session(this.serializationKey)}get backupStatus(){return Ud.BackedUp}}class Z0 extends J0{constructor(e){super(),this.isBetter=!0,this.storageEntry=e}get roomId(){return this.storageEntry.roomId}get senderKey(){return this.storageEntry.senderKey}get sessionId(){return this.storageEntry.sessionId}get claimedEd25519Key(){return this.storageEntry.claimedKeys.ed25519}get eventIds(){return this.storageEntry.eventIds}get serializationKey(){return this.storageEntry.session||""}get serializationType(){return"unpickle"}loadInto(e,t){e.unpickle(t,this.serializationKey)}get hasSession(){return!!this.serializationKey}}function zF(n){var e;const t=(e=n.event.content)==null?void 0:e.session_key,r=new KF(n);if(typeof r.roomId=="string"&&typeof r.sessionId=="string"&&typeof r.senderKey=="string"&&typeof t=="string")return r}function ek(n,e,t){var r;const i=t.session_key,s=t.sender_key,o=(r=t.sender_claimed_keys)==null?void 0:r.ed25519;if(typeof n=="string"&&typeof e=="string"&&typeof s=="string"&&typeof i=="string"&&typeof o=="string")return new HF(n,e,t)}async function tk(n,e,t,r){const i=await r.inboundGroupSessions.get(n,e,t);if(i)return new Z0(i)}class GF{constructor(e,t){this.keyLoader=e,this.olmWorker=t}async addMissingKeyEventIds(e,t,r,i,s){let o=await s.inboundGroupSessions.get(e,t,r);if(!(o!=null&&o.session)){if(o){const a=new Set(o.eventIds);for(const c of i)a.add(c);o.eventIds=Array.from(a)}else o={roomId:e,senderKey:t,sessionId:r,eventIds:i};s.inboundGroupSessions.set(o)}}async getEventIdsForMissingKey(e,t,r,i){const s=await i.inboundGroupSessions.get(e,t,r);if(s&&!s.session)return s.eventIds}async hasSession(e,t,r,i){const s=await i.inboundGroupSessions.get(e,t,r);return typeof(s==null?void 0:s.session)=="string"}async prepareDecryptAll(e,t,r,i){const s=new Map,o=[];for(const u of t)BF(u)?o.push(u):s.set(u.event_id,new ut("MEGOLM_INVALID_EVENT",u));const a=mp(o),c=[];return await Promise.all(Array.from(a.values()).map(async u=>{const l=await this.getRoomKey(e,u.senderKey,u.sessionId,r,i);if(l)c.push(new LF(l,u.events,this.olmWorker,this.keyLoader));else for(const d of u.events)s.set(d.event_id,new ut("MEGOLM_NO_SESSION",d))})),new UF(e,c,s)}async getRoomKey(e,t,r,i,s){if(i){const c=i.find(u=>u.isForSession(e,t,r));if(c&&await c.checkBetterThanKeyInStorage(this.keyLoader,s))return c}const o=this.keyLoader.getCachedKey(e,t,r);if(o)return o;const a=await tk(e,t,r,s);if(a&&a.serializationKey)return a}writeRoomKey(e,t){return e.write(this.keyLoader,t)}roomKeysFromDeviceMessages(e,t){var r,i;const s=[];for(const o of e)((r=o.event)==null?void 0:r.type)!=="m.room_key"||((i=o.event.content)==null?void 0:i.algorithm)!==Kn||t.wrap("room_key",a=>{const c=zF(o);c?(a.set("roomId",c.roomId),a.set("id",c.sessionId),s.push(c)):(a.logLevel=a.level.Warn,a.set("invalid",!0))},t.level.Detail);return s}roomKeyFromBackup(e,t,r){return ek(e,t,r)}dispose(){this.keyLoader.dispose()}}class qF extends B0{constructor(e,t,r){super(r),this.pickleKey=t,this.olm=e}getCachedKey(e,t,r){const i=this.findCachedKeyIndex(e,t,r);if(i!==-1)return this._getByIndexAndMoveUp(i).key}async useKey(e,t){const r=await this.allocateOperation(e);try{return await t(r.session,this.pickleKey)}finally{this.releaseOperation(r)}}get running(){return this._entries.some(e=>e.refCount!==0)}dispose(){for(let e=0;e<this._entries.length;e+=1)this._entries[e].dispose();this._entries.splice(0,this._entries.length)}async allocateOperation(e){let t;for(;(t=this.findIndexForAllocation(e))===-1;)await this.operationBecomesUnused();if(t<this.size){const r=this._getByIndexAndMoveUp(t);return r.isForKey(e)?(r.refCount+=1,r):(r.refCount=1,r.key=e,e.loadInto(r.session,this.pickleKey),r)}else{const r=new this.olm.InboundGroupSession;e.loadInto(r,this.pickleKey);const i=new WF(e,r);return this._set(i),i}}releaseOperation(e){e.refCount-=1,e.refCount<=0&&this.resolveUnusedOperation&&(this.resolveUnusedOperation(),this.operationBecomesUnusedPromise=this.resolveUnusedOperation=void 0)}operationBecomesUnused(){return this.operationBecomesUnusedPromise||(this.operationBecomesUnusedPromise=new Promise(e=>{this.resolveUnusedOperation=e})),this.operationBecomesUnusedPromise}findIndexForAllocation(e){let t=this.findIndexSameKey(e);return t===-1&&(this.size<this.limit?t=this.size:(t=this.findIndexSameSessionUnused(e),t===-1&&(t=this.findIndexOldestUnused()))),t}findCachedKeyIndex(e,t,r){return this._entries.reduce((i,s,o,a)=>{const c=i===-1?void 0:a[i];return s.isBest===!0&&s.isForSameSession(e,t,r)&&(!c||s.isBetter(c))?o:i},-1)}findIndexSameKey(e){return this._entries.findIndex(t=>t.isForSameSession(e.roomId,e.senderKey,e.sessionId)&&t.isForKey(e))}findIndexSameSessionUnused(e){return this._entries.reduce((t,r,i,s)=>{const o=t===-1?void 0:s[t];return r.refCount===0&&r.isForSameSession(e.roomId,e.senderKey,e.sessionId)&&(!o||!r.isBetter(o))?i:t},-1)}findIndexOldestUnused(){for(let e=this._entries.length-1;e>=0;e-=1)if(this._entries[e].refCount===0)return e;return-1}}class WF{constructor(e,t){this.key=e,this.session=t,this.refCount=1}isForSameSession(e,t,r){return this.key.roomId===e&&this.key.senderKey===t&&this.key.sessionId===r}isBetter(e){return Q0(this.session,e.session)}isForKey(e){return this.key.serializationKey===e.serializationKey&&this.key.serializationType===e.serializationType}dispose(){this.session.free(),this.session=void 0}get isBest(){return this.key.isBetter}}const YF="m.megolm_backup.v1.curve25519-aes-sha2";class C_{constructor(e,t){this.encryption=e,this.decryption=t}static fromAuthData(e,t,r){const i=e.public_key,s=new r.PkDecryption,o=new r.PkEncryption;try{const a=s.init_with_private_key(t);if(a!==i)throw new Error(`Bad backup key, public key does not match. Calculated ${a} but expected ${i}`);o.set_recipient_key(a)}catch(a){throw s.free(),o.free(),a}return new C_(o,s)}decryptRoomKey(e){const t=this.decryption.decrypt(e.ephemeral,e.mac,e.ciphertext);return JSON.parse(t)}encryptRoomKey(e,t){const r={algorithm:Kn,sender_key:e.senderKey,sender_claimed_keys:{ed25519:e.claimedEd25519Key},forwarding_curve25519_key_chain:[],session_key:t};return this.encryption.encrypt(JSON.stringify(r))}dispose(){var e,t;(e=this.decryption)==null||e.free(),this.decryption=void 0,(t=this.encryption)==null||t.free(),this.encryption=void 0}}const XF=200;class JF{constructor(e,t){this.info=e,this.crypto=t}}class QF extends kr{constructor(e,t,r,i,s,o=1e4){super(),this.hsApi=e,this.olm=t,this.keyLoader=r,this.storage=i,this.platform=s,this.maxDelay=o,this._stopped=!1,this._needsNewKey=!1,this._hasBackedUpAllKeys=!1,this.backupConfigDeferred=new up,this.backupConfigDeferred=new up}get hasStopped(){return this._stopped}get error(){return this._error}get version(){var e,t;return(t=(e=this.backupConfigDeferred.value)==null?void 0:e.info)==null?void 0:t.version}get needsNewKey(){return this._needsNewKey}get hasBackedUpAllKeys(){return this._hasBackedUpAllKeys}get operationInProgress(){return this._operationInProgress}async getRoomKey(e,t,r){if(this.needsNewKey)return;const i=await this.backupConfigDeferred.promise;if(!i)return;const s=await this.hsApi.roomKeyForRoomAndSession(i.info.version,e,t,{log:r}).response();if(!s.session_data)return;const o=i.crypto.decryptRoomKey(s.session_data);if((o==null?void 0:o.algorithm)===Kn)return ek(e,t,o);o!=null&&o.algorithm&&r.set("unknown algorithm",o.algorithm)}markAllForBackup(e){return e.inboundGroupSessions.markAllAsNotBackedUp()}async load(e,t){const r=await e.readSecret("m.megolm_backup.v1");return r?(this.privateKey=new Uint8Array(this.platform.encoding.base64.decode(r)),!0):(this.backupConfigDeferred.resolve(void 0),!1)}async start(e){await e.wrap("KeyBackup.start",async t=>{if(this.privateKey&&!this.backupInfoRequest){let r;try{this.backupInfoRequest=this.hsApi.roomKeysVersion(void 0,{log:t}),r=await this.backupInfoRequest.response()}catch(i){if(i.name==="AbortError"){t.set("aborted",!0);return}else throw i}finally{this.backupInfoRequest=void 0}if(r.algorithm===YF){const i=C_.fromAuthData(r.auth_data,this.privateKey,this.olm);this.backupConfigDeferred.resolve(new JF(r,i)),this.emit("change")}else this.backupConfigDeferred.resolve(void 0),t.log({l:"Unknown backup algorithm",algorithm:r.algorithm});this.privateKey=void 0}this.flush(t)})}flush(e){this._operationInProgress||e.wrapDetached("flush key backup",async t=>{if(this._needsNewKey){t.set("needsNewKey",this._needsNewKey);return}this._stopped=!1,this._error=void 0,this._hasBackedUpAllKeys=!1;const r=this._runFlushOperation(t);this._operationInProgress=r,this.emit("change");try{await r.result,this._hasBackedUpAllKeys=!0}catch(i){this._stopped=!0,i.name==="HomeServerError"&&(i.errcode==="M_WRONG_ROOM_KEYS_VERSION"||i.errcode==="M_NOT_FOUND")?(t.set("wrong_version",!0),this._needsNewKey=!0):(i.name!=="AbortError"||i.name==="StorageError"&&i.errcode==="AbortError")&&(this._error=i),t.catch(i)}this._operationInProgress=void 0,this.emit("change")})}_runFlushOperation(e){return new A0(async(t,r)=>{const i=await this.backupConfigDeferred.promise;if(!i)return;let s=0,o=0;for(;;){const a=this.platform.random()*this.maxDelay,c=this.platform.clock.createTimeout(a);t(c),await c.elapsed();const u=await this.storage.readTxn([Ie.inboundGroupSessions]);t(u),s=o+await u.inboundGroupSessions.countNonBackedUpSessions(),r(new Yv(s,o));const l=(await u.inboundGroupSessions.getFirstNonBackedUpSessions(XF)).map(m=>new Z0(m));if(l.length===0){e.set("total",s);return}const d=await this.encodeKeysForBackup(l,i.crypto),p=this.hsApi.uploadRoomKeysToBackup(i.info.version,d,{log:e});t(p),await p.response(),await this.markKeysAsBackedUp(l,t),o+=l.length,r(new Yv(s,o))}})}async encodeKeysForBackup(e,t){const r={rooms:{}},i=r.rooms;for(const s of e){let o=i[s.roomId];o||(o=i[s.roomId]={sessions:{}}),o.sessions[s.sessionId]=await this.encodeRoomKey(s,t)}return r}async markKeysAsBackedUp(e,t){const r=await this.storage.readWriteTxn([Ie.inboundGroupSessions]);t(r);try{await Promise.all(e.map(i=>r.inboundGroupSessions.markAsBackedUp(i.roomId,i.senderKey,i.sessionId)))}catch(i){throw r.abort(),i}await r.complete()}async encodeRoomKey(e,t){return await this.keyLoader.useKey(e,r=>{const i=r.first_known_index(),s=r.export_session(i);return{first_message_index:i,forwarded_count:0,is_verified:!1,session_data:t.encryptRoomKey(e,s)}})}dispose(){var e,t,r;(e=this.backupInfoRequest)==null||e.abort(),(r=(t=this.backupConfigDeferred.value)==null?void 0:t.crypto)==null||r.dispose()}}class Yv{constructor(e,t){this.total=e,this.finished=t}}class ZF{constructor({pickleKey:e,olm:t,account:r,keyLoader:i,storage:s,now:o,ownDeviceId:a}){this._pickleKey=e,this._olm=t,this._account=r,this._keyLoader=i,this._storage=s,this._now=o,this._ownDeviceId=a}discardOutboundSession(e,t){t.outboundGroupSessions.remove(e)}async createRoomKeyMessage(e,t){let r=await t.outboundGroupSessions.get(e);if(r){const i=new this._olm.OutboundGroupSession;try{return i.unpickle(this._pickleKey,r.session),this._createRoomKeyMessage(i,e)}finally{i.free()}}}createWithheldMessage(e,t,r){return{algorithm:e.algorithm,code:t,reason:r,room_id:e.room_id,sender_key:this._account.identityKeys.curve25519,session_id:e.session_id}}async ensureOutboundSession(e,t){let r=new this._olm.OutboundGroupSession;try{const i=await this._storage.readWriteTxn([this._storage.storeNames.inboundGroupSessions,this._storage.storeNames.outboundGroupSessions]);let s;try{let o=await i.outboundGroupSessions.get(e);s=await this._readOrCreateSession(r,o,e,t,i),s&&this._writeSession(this._now(),r,e,i)}catch(o){throw i.abort(),o}return await i.complete(),s}finally{r.free()}}async _readOrCreateSession(e,t,r,i,s){if(t&&e.unpickle(this._pickleKey,t.session),!t||this._needsToRotate(e,t.createdAt,i)){t&&(e.free(),e=new this._olm.OutboundGroupSession),e.create();const o=this._createRoomKeyMessage(e,r);return await new jF(r,e,this._account.identityKeys).write(this._keyLoader,s),o}}_writeSession(e,t,r,i){i.outboundGroupSessions.set({roomId:r,session:t.pickle(this._pickleKey),createdAt:e})}async encrypt(e,t,r,i){let s=new this._olm.OutboundGroupSession;try{const o=await this._storage.readWriteTxn([this._storage.storeNames.inboundGroupSessions,this._storage.storeNames.outboundGroupSessions]);let a,c;try{let u=await o.outboundGroupSessions.get(e);a=await this._readOrCreateSession(s,u,e,i,o),c=this._encryptContent(e,s,t,r);const l=a?this._now():u.createdAt;this._writeSession(l,s,e,o)}catch(u){throw o.abort(),u}return await o.complete(),new eB(c,a)}finally{s&&s.free()}}_needsToRotate(e,t,r){let i=6048e5;Number.isSafeInteger(r==null?void 0:r.rotation_period_ms)&&(i=r==null?void 0:r.rotation_period_ms);let s=100;if(Number.isSafeInteger(r==null?void 0:r.rotation_period_msgs)&&(s=r==null?void 0:r.rotation_period_msgs),this._now()>t+i||e.message_index()>=s)return!0}_encryptContent(e,t,r,i){const s=JSON.stringify({room_id:e,type:r,content:i}),o=t.encrypt(s);return{algorithm:Kn,sender_key:this._account.identityKeys.curve25519,ciphertext:o,session_id:t.session_id(),device_id:this._ownDeviceId}}_createRoomKeyMessage(e,t){return{room_id:t,session_id:e.session_id(),session_key:e.session_key(),algorithm:Kn,chain_index:e.message_index()}}}class eB{constructor(e,t){this.content=e,this.roomKeyMessage=t}}const Xv="m.room.encrypted",Jv="m.room.history_visibility",tB=60*1e3;class nB{constructor({room:e,deviceTracker:t,olmEncryption:r,megolmEncryption:i,megolmDecryption:s,encryptionParams:o,storage:a,keyBackup:c,notifyMissingMegolmSession:u,clock:l}){this._room=e,this._deviceTracker=t,this._olmEncryption=r,this._megolmEncryption=i,this._megolmDecryption=s,this._encryptionParams=o,this._senderDeviceCache=new Map,this._storage=a,this._keyBackup=c,this._notifyMissingMegolmSession=u,this._clock=l,this._isFlushingRoomKeyShares=!1,this._lastKeyPreShareTime=null,this._keySharePromise=null,this._historyVisibility=void 0,this._disposed=!1}enableKeyBackup(e){this._keyBackup&&e||(this._keyBackup=e)}async restoreMissingSessionsFromBackup(e,t){const r=e.filter(l=>l.isEncrypted&&!l.isDecrypted&&l.event).map(l=>l.event),i=mp(r),s=Array.from(i.values()),o=await this._storage.readTxn([this._storage.storeNames.inboundGroupSessions]),a=await Promise.all(s.map(async l=>this._megolmDecryption.hasSession(this._room.id,l.senderKey,l.sessionId,o))),c=s.filter((l,d)=>!a[d]);if(c.length)for(var u=c.length-1;u>=0;u--){const l=c[u];await t.wrap("session",d=>this._requestMissingSessionFromBackup(l.senderKey,l.sessionId,d))}}notifyTimelineClosed(){this._senderDeviceCache=new Map}async writeSync(e,t,r,i){let s=await this._loadHistoryVisibilityIfNeeded(this._historyVisibility,r);const o=[],a=[];if(await qs(e,u=>{var l;if(u.state_key===""&&u.type===Jv){const d=(l=u==null?void 0:u.content)==null?void 0:l.history_visibility;if(d!==s)return i.wrap({l:"history_visibility changed",from:s,to:d},async p=>{s=d;const m=await this._deviceTracker.writeHistoryVisibility(this._room,s,r,p);o.push(...m.added),a.push(...m.removed)})}}),t.size){const u=await this._deviceTracker.writeMemberChanges(this._room,t,s,r);o.push(...u.added),a.push(...u.removed)}a.length&&(i.log({l:"discardOutboundSession",leftUsers:a}),this._megolmEncryption.discardOutboundSession(this._room.id,r));let c=!1;return o.length&&(c=await this._addShareRoomKeyOperationForMembers(o,r,i)),{shouldFlush:c,historyVisibility:s}}afterSync({historyVisibility:e}){this._historyVisibility=e}async _loadHistoryVisibilityIfNeeded(e,t=void 0){var r,i;if(!e){t||(t=await this._storage.readTxn([this._storage.storeNames.roomState]));const s=await t.roomState.get(this._room.id,Jv,"");if(s)return(i=(r=s.event)==null?void 0:r.content)==null?void 0:i.history_visibility}return e}async prepareDecryptAll(e,t,r,i){var s,o,a;const c=new Map,u=[];for(const d of e)d.redacted_because||(s=d.unsigned)!=null&&s.redacted_because||(((o=d.content)==null?void 0:o.algorithm)!==Kn&&c.set(d.event_id,new Error("Unsupported algorithm: "+((a=d.content)==null?void 0:a.algorithm))),u.push(d));const l=await this._megolmDecryption.prepareDecryptAll(this._room.id,u,t,i);return new rB(l,c,r,this,e)}async _processDecryptionResults(e,t,r,i,s,o){const a=e.filter(u=>{const l=r.get(u.event_id);return(l==null?void 0:l.code)==="MEGOLM_NO_SESSION"});if(!a.length)return;const c=mp(a);i===zr.Sync&&await Promise.all(Array.from(c.values()).map(async u=>{const l=u.events.map(d=>d.event_id);return this._megolmDecryption.addMissingKeyEventIds(this._room.id,u.senderKey,u.sessionId,l,s)})),this._keyBackup&&o.wrapDetached("check key backup",async u=>{if(u.set("source",i),u.set("events",a.length),u.set("sessions",c.size),i===zr.Sync){if(await this._clock.createTimeout(1e4).elapsed(),this._disposed)return;const l=await this._storage.readTxn([this._storage.storeNames.inboundGroupSessions]);await Promise.all(Array.from(c).map(async([d,p])=>{await this._megolmDecryption.hasSession(this._room.id,p.senderKey,p.sessionId,l)&&c.delete(d)}))}await Promise.all(Array.from(c.values()).map(l=>u.wrap("session",d=>this._requestMissingSessionFromBackup(l.senderKey,l.sessionId,d))))})}async _verifyDecryptionResults(e,t){await Promise.all(e.map(async r=>{let i=this._senderDeviceCache.get(r.senderCurve25519Key);i||(i=await this._deviceTracker.getDeviceByCurve25519Key(r.senderCurve25519Key,t),this._senderDeviceCache.set(r.senderCurve25519Key,i)),i&&r.setDevice(i)}))}async _fetchKeyAndVerifyDecryptionResults(e,t,r){const i=e.filter(s=>s.isVerificationUnknown);return i.length?r.wrap("fetch unverified senders",async s=>{const o=Array.from(i.reduce((l,d)=>l.add(d.encryptedEvent.sender),new Set));s.set("senders",o),await this._deviceTracker.devicesForUsers(o,t,s);const a=await this._storage.readTxn([this._storage.storeNames.deviceKeys]);await this._verifyDecryptionResults(i,a);const u=i.filter(l=>!l.isVerificationUnknown).reduce((l,d)=>(l.set(d.encryptedEvent.event_id,d),l),new Map);return new _p(u,new Map,this)}):new _p(new Map,new Map,this)}async _requestMissingSessionFromBackup(e,t,r){if(!this._keyBackup){r.set("enabled",!1),this._notifyMissingMegolmSession();return}r.set("id",t),r.set("senderKey",e);try{const i=await this._keyBackup.getRoomKey(this._room.id,t,r);if(i){if(i.senderKey!==e){r.set("wrong_sender_key",i.senderKey),r.logLevel=r.level.Warn;return}let s=!1,o;const a=await this._storage.readWriteTxn([this._storage.storeNames.inboundGroupSessions]);try{s=await this._megolmDecryption.writeRoomKey(i,a),r.set("isBetter",s),s&&(o=i.eventIds)}catch(c){throw a.abort(),c}await a.complete(),s&&await r.wrap("retryDecryption",c=>this._room.notifyRoomKey(i,o||[],c))}}catch(i){i.name==="HomeServerError"&&i.errcode==="M_NOT_FOUND"?(r.error=i,r.logLevel=r.level.Error):r.set("not_found",!0)}}getEventIdsForMissingKey(e,t){return this._megolmDecryption.getEventIdsForMissingKey(this._room.id,e.senderKey,e.sessionId,t)}async ensureMessageKeyIsShared(e,t){var r;if(!(((r=this._lastKeyPreShareTime)==null?void 0:r.measure())<tB)){this._lastKeyPreShareTime=this._clock.createMeasure();try{this._keySharePromise=(async()=>{var i;const s=await this._megolmEncryption.ensureOutboundSession(this._room.id,this._encryptionParams);s&&((i=this._keyBackup)==null||i.flush(t),await t.wrap("share key",o=>this._shareNewRoomKey(s,e,o)))})(),await this._keySharePromise}finally{this._keySharePromise=null}}}async encrypt(e,t,r,i){var s;this._keySharePromise&&(i.set("waitForRunningKeyShare",!0),await this._keySharePromise);const o=await i.wrap("megolm encrypt",()=>this._megolmEncryption.encrypt(this._room.id,e,t,this._encryptionParams));return o.roomKeyMessage&&((s=this._keyBackup)==null||s.flush(i),await i.wrap("share key",a=>this._shareNewRoomKey(o.roomKeyMessage,r,a))),{type:Xv,content:o.content}}needsToShareKeys(e){for(const t of e.values())if(t.hasJoined)return!0;return!1}async _shareNewRoomKey(e,t,r){this._historyVisibility=await this._loadHistoryVisibilityIfNeeded(this._historyVisibility),await this._deviceTracker.trackRoom(this._room,this._historyVisibility,r);const i=await this._deviceTracker.devicesForTrackedRoom(this._room.id,t,r),s=Array.from(i.reduce((c,u)=>c.add(u.user_id),new Set));let o=await this._storage.readWriteTxn([this._storage.storeNames.operations]),a;try{a=this._writeRoomKeyShareOperation(e,s,o)}catch(c){throw o.abort(),c}await this._processShareRoomKeyOperation(a,t,r)}async _addShareRoomKeyOperationForMembers(e,t,r){const i=await this._megolmEncryption.createRoomKeyMessage(this._room.id,t);return i?(r.log({l:"share key for new members",userIds:e,id:i.session_id,chain_index:i.chain_index}),this._writeRoomKeyShareOperation(i,e,t),!0):!1}async flushPendingRoomKeyShares(e,t,r){if(!this._isFlushingRoomKeyShares){this._isFlushingRoomKeyShares=!0;try{t||(t=await(await this._storage.readTxn([this._storage.storeNames.operations])).operations.getAllByTypeAndScope("share_room_key",this._room.id));for(const i of t)i.type==="share_room_key"&&await r.wrap("operation",s=>this._processShareRoomKeyOperation(i,e,s))}finally{this._isFlushingRoomKeyShares=!1}}}_writeRoomKeyShareOperation(e,t,r){const s={id:Math.floor(Math.random()*Number.MAX_SAFE_INTEGER).toString(),type:"share_room_key",scope:this._room.id,userIds:t,roomKeyMessage:e};return r.operations.add(s),s}async _processShareRoomKeyOperation(e,t,r){r.set("id",e.id),this._historyVisibility=await this._loadHistoryVisibilityIfNeeded(this._historyVisibility),await this._deviceTracker.trackRoom(this._room,this._historyVisibility,r);const i=await this._deviceTracker.devicesForRoomMembers(this._room.id,e.userIds,t,r),s=await r.wrap("olm encrypt",a=>this._olmEncryption.encrypt("m.room_key",e.roomKeyMessage,i,t,a)),o=i.filter(a=>!s.some(c=>c.device===a));await r.wrap("send",a=>this._sendMessagesToDevices(Xv,s,t,a)),o.length&&await r.wrap("missingDevices",async a=>{a.set("devices",o.map(l=>l.device_id));const c=e.userIds.filter(l=>o.some(d=>d.user_id===l));a.set("unsentUserIds",c),e.userIds=c,await this._updateOperationsStore(l=>l.update(e));const u=this._megolmEncryption.createWithheldMessage(e.roomKeyMessage,"m.no_olm","OTKs exhausted");await this._sendSharedMessageToDevices("org.matrix.room_key.withheld",u,o,t,a)}),await this._updateOperationsStore(a=>a.remove(e.id))}async _updateOperationsStore(e){const t=await this._storage.readWriteTxn([this._storage.storeNames.operations]);try{e(t.operations)}catch(r){throw t.abort(),r}await t.complete()}async _sendSharedMessageToDevices(e,t,r,i,s){const o=co(r,u=>u.user_id),a={messages:Array.from(o.entries()).reduce((u,[l,d])=>(u[l]=d.reduce((p,m)=>(p[m.device_id]=t,p),{}),u),{})},c=An();await i.sendToDevice(e,a,c,{log:s}).response()}async _sendMessagesToDevices(e,t,r,i){i.set("messages",t.length);const s=cp(t),o=An();await r.sendToDevice(e,s,o,{log:i}).response()}filterUndecryptedEventEntriesForKeys(e,t){return e.filter(r=>{var i,s;if(r.isEncrypted&&!r.isDecrypted){const{event:o}=r;if(o){const a=(i=o.content)==null?void 0:i.sender_key,c=(s=o.content)==null?void 0:s.session_id;return t.some(u=>a===u.senderKey&&c===u.sessionId)}}return!1})}dispose(){this._disposed=!0}}class rB{constructor(e,t,r,i,s){this._megolmDecryptionPreparation=e,this._extraErrors=t,this._source=r,this._roomEncryption=i,this._events=s}async decrypt(){return new iB(await this._megolmDecryptionPreparation.decrypt(),this._extraErrors,this._source,this._roomEncryption,this._events)}dispose(){this._megolmDecryptionPreparation.dispose()}}class iB{constructor(e,t,r,i,s){this._megolmDecryptionChanges=e,this._extraErrors=t,this._source=r,this._roomEncryption=i,this._events=s}async write(e,t){const{results:r,errors:i}=await this._megolmDecryptionChanges.write(e);return pp(this._extraErrors,i),await this._roomEncryption._processDecryptionResults(this._events,r,i,this._source,e,t),new _p(r,i,this._roomEncryption)}}class _p{constructor(e,t,r){this.results=e,this.errors=t,this._roomEncryption=r}applyToEntries(e,t=void 0){for(const r of e){const i=this.results.get(r.id);if(i)r.setDecryptionResult(i),t==null||t(r);else{const s=this.errors.get(r.id);s&&(r.setDecryptionError(s),t==null||t(r))}}}verifyKnownSenders(e){return this._roomEncryption._verifyDecryptionResults(Array.from(this.results.values()),e)}get hasUnverifiedSenders(){for(const e of this.results.values())if(e.isVerificationUnknown)return!0;return!1}fetchAndVerifyRemainingSenders(e,t){return this._roomEncryption._fetchKeyAndVerifyDecryptionResults(Array.from(this.results.values()),e,t)}}class sB{constructor(){this._map=new Map}async takeLock(e){let t=this._map.get(e);return t?await t.take():(t=new G0,t.tryTake(),this._map.set(e,t)),t.released().then(()=>{Promise.resolve().then(()=>{t.isTaken||this._map.delete(e)})}),t}}class Tc extends Error{constructor(e,t){super(e),this.reason=t}}class oB{constructor({key:e,platform:t,storage:r}){this._key=e,this._platform=t,this._storage=r}async hasValidKeyForAnyAccountData(){const t=await(await this._storage.readTxn([this._storage.storeNames.accountData])).accountData.getAll();for(const r of t)try{const i=await this._decryptAccountData(r);return!0}catch(i){if(i instanceof Tc&&i.reason!==0)throw i;continue}return!1}async readSecret(e){const r=await(await this._storage.readTxn([this._storage.storeNames.accountData])).accountData.get(e);if(r)return await this._decryptAccountData(r)}async _decryptAccountData(e){var t,r;const i=(r=(t=e==null?void 0:e.content)==null?void 0:t.encrypted)==null?void 0:r[this._key.id];if(!i)throw new Tc(`Secret ${e.type} is not encrypted for key ${this._key.id}`,0);if(this._key.algorithm==="m.secret_storage.v1.aes-hmac-sha2")return await this._decryptAESSecret(e.type,i);throw new Tc(`Unsupported algorithm for key ${this._key.id}: ${this._key.algorithm}`,2)}async _decryptAESSecret(e,t){const{base64:r,utf8:i}=this._platform.encoding,s=await this._platform.crypto.derive.hkdf(this._key.binaryKey,new Uint8Array(8).buffer,i.encode(e),"SHA-256",512),o=s.slice(0,32),a=s.slice(32),c=r.decode(t.ciphertext);if(!await this._platform.crypto.hmac.verify(a,r.decode(t.mac),c,"SHA-256"))throw new Tc("Bad MAC",1);const l=await this._platform.crypto.aes.decryptCTR({key:o,iv:r.decode(t.iv),data:c});return i.decode(l)}}function nk(n,e,t=!1){for(const[r,i]of Object.entries(e)){if(n[r]instanceof Object&&i){nk(n[r],i);continue}if(i!=null||!t){n[r]=i;continue}}return n}/*! *****************************************************************************
Copyright (c) Microsoft Corporation. All rights reserved.
Licensed under the Apache License, Version 2.0 (the "License"); you may not use
this file except in compliance with the License. You may obtain a copy of the
License at http://www.apache.org/licenses/LICENSE-2.0
THIS CODE IS PROVIDED ON AN *AS IS* BASIS, WITHOUT WARRANTIES OR CONDITIONS OF ANY
KIND, EITHER EXPRESS OR IMPLIED, INCLUDING WITHOUT LIMITATION ANY IMPLIED
WARRANTIES OR CONDITIONS OF TITLE, FITNESS FOR A PARTICULAR PURPOSE,
MERCHANTABLITY OR NON-INFRINGEMENT.
See the Apache Version 2.0 License for specific language governing permissions
and limitations under the License.
***************************************************************************** */var gp=(n=>(n.Video="video",n.Audio="audio",n))(gp||{});function Ji(n){return n==null?void 0:n.getAudioTracks()[0]}function Gr(n){return n==null?void 0:n.getVideoTracks()[0]}function yp(n,e,t){return t.wrap("mute",r=>{r.set("cameraMuted",e.camera),r.set("microphoneMuted",e.microphone);const i=Ji(n.userMedia);if(i){const o=!e.microphone;r.set("microphone enabled",o),i.enabled=o}const s=Gr(n.userMedia);if(s){const o=!e.camera;r.set("camera enabled",o),s.enabled=o}})}class fo{constructor(e=!1,t=!1,r=!1,i=!1){this.isMicrophoneMuted=e,this.isCameraMuted=t,this.hasMicrophoneTrack=r,this.hasCameraTrack=i}updateTrackInfo(e){this.hasMicrophoneTrack=!!Ji(e),this.hasCameraTrack=!!Gr(e)}get microphone(){return!this.hasMicrophoneTrack||this.isMicrophoneMuted}get camera(){return!this.hasCameraTrack||this.isCameraMuted}toggleCamera(){return new fo(this.microphone,!this.camera,this.hasMicrophoneTrack,this.hasCameraTrack)}toggleMicrophone(){return new fo(!this.microphone,this.camera,this.hasMicrophoneTrack,this.hasCameraTrack)}equals(e){return this.microphone===e.microphone&&this.camera===e.camera}}const Ci="call",Hh=3600*1e3;var vp=(n=>(n[n.InviteGlare=0]="InviteGlare",n[n.Handle=1]="Handle",n[n.Ignore=2]="Ignore",n))(vp||{});class aB{constructor(e,t){this.userMedia=e,this.screenShare=t}}class lB{constructor(e,t,r){this.callId=e,this.options=t,this.logItem=r,this._state=ie.Fledgling,this.candidateSendQueue=[],this.remoteCandidateBuffer=new Map,this.disposables=new Al,this.statePromiseMap=new Map,this._remoteTrackToStreamId=new Map,this._remoteStreams=new Map,this.makingOffer=!1,this.ignoreOffer=!1,this.sentEndOfCandidates=!1,this._remoteMuteSettings=new fo,this.onIceConnectionStateChange=async(s,o)=>{var a,c;if(this._state===ie.Ended)return;let u=!1;if(s=="connected")(a=this.iceDisconnectedTimeout)==null||a.abort(),this.iceDisconnectedTimeout=void 0,this.setState(ie.Connected,o);else if(s=="failed")u=!0,(c=this.iceDisconnectedTimeout)==null||c.abort(),this.iceDisconnectedTimeout=void 0,await this._hangup(Te.IceFailed,o);else if(s=="disconnected"){u=!0,this.iceDisconnectedTimeout=this.options.createTimeout(30*1e3);try{await this.iceDisconnectedTimeout.elapsed(),await this._hangup(Te.IceFailed,o)}catch(l){if(!(l instanceof ln))throw l}}if(u){const l=await this.peerConnection.getStats(),d={};l.forEach((p,m)=>{d[m]=p}),o.set("peerConnectionStats",d)}},r.log({l:"create PeerCall",id:e}),this._remoteMedia=new aB,this.peerConnection=t.webRTC.createPeerConnection(this.options.forceTURN,[this.options.turnServer.get()],0),this.disposables.track(this.options.turnServer.subscribe(s=>{this.logItem.log({l:"updating turn server",turnServer:s}),this.peerConnection.setConfiguration({iceServers:[s]})}));const i=(s,o,a)=>{const c=l=>{this.options.errorBoundary.try(()=>o(l))};this.peerConnection.addEventListener(s,c);const u=()=>{this.peerConnection.removeEventListener(s,c)};this.disposables.track(u)};i("iceconnectionstatechange",async()=>{const s=this.peerConnection.iceConnectionState;await r.wrap({l:"onIceConnectionStateChange",status:s},async o=>{await this.onIceConnectionStateChange(s,o)})}),i("icecandidate",async s=>{await r.wrap("onLocalIceCandidate",async o=>{s.candidate&&await this.handleLocalIceCandidate(s.candidate,o)})}),i("icegatheringstatechange",async()=>{const s=this.peerConnection.iceGatheringState;await r.wrap({l:"onIceGatheringStateChange",status:s},async o=>{await this.handleIceGatheringState(s,o)})}),i("track",s=>{r.wrap("onRemoteTrack",o=>{this.onRemoteTrack(s.track,s.streams,o)})}),i("datachannel",s=>{r.wrap("onRemoteDataChannel",o=>{this._dataChannel=s.channel,this.options.emitUpdate(this,void 0,o)})}),i("negotiationneeded",()=>{var s,o;const a=this.peerConnection.signalingState,c=()=>r.wrap({l:"onNegotiationNeeded",signalingState:a},u=>this.handleNegotiation(u));this.responsePromiseChain=(o=(s=this.responsePromiseChain)==null?void 0:s.then(c))!=null?o:c(),this.responsePromiseChain.catch(u=>this.options.errorBoundary.reportError(u))})}get dataChannel(){return this._dataChannel}get state(){return this._state}get hangupReason(){return this._hangupReason}get remoteMedia(){return this._remoteMedia}get remoteMuteSettings(){return this._remoteMuteSettings}call(e,t,r){return r.wrap("call",async i=>{var s;this._state===ie.Fledgling&&(i.set("signalingState",this.peerConnection.signalingState),this.direction=ba.Outbound,this.setState(ie.CreateOffer,i),this.localMuteSettings=t,await this.updateLocalMedia(e,i),(s=this.localMedia)!=null&&s.dataChannelOptions&&(this._dataChannel=this.peerConnection.createDataChannel("channel",this.localMedia.dataChannelOptions)),await this.waitForState([ie.InviteSent,ie.CreateAnswer]))})}answer(e,t,r){return r.wrap("answer",async i=>{if(this._state!==ie.Ringing)return;this.setState(ie.CreateAnswer,i),this.localMuteSettings=t,await this.updateLocalMedia(e,i);let s;try{s=await this.peerConnection.createAnswer()}catch(o){await i.wrap("Failed to create answer",a=>{a.catch(o),this.terminate(At.Local,Te.CreateAnswer,a)});return}try{await this.peerConnection.setLocalDescription(s),this.setState(ie.Connecting,i)}catch(o){await i.wrap("Error setting local description!",a=>{a.catch(o),this.terminate(At.Local,Te.SetLocalDescription,a)});return}try{await this.delay(200)}catch{return}await this.sendAnswer(i)})}setMedia(e,t){return t.wrap("setMedia",async r=>{r.set("userMedia_audio",!!Ji(e.userMedia)),r.set("userMedia_video",!!Gr(e.userMedia)),r.set("screenShare_video",!!Gr(e.screenShare)),r.set("datachannel",!!e.dataChannelOptions),await this.updateLocalMedia(e,r);const i={call_id:this.callId,version:1,[Cn]:this.getSDPMetadata()};await this.sendSignallingMessage({type:se.SDPStreamMetadataChangedPrefix,content:i},r)})}setMuted(e,t){return t.wrap("setMuted",async r=>{if(this.localMuteSettings=e,r.set("cameraMuted",e.camera),r.set("microphoneMuted",e.microphone),this.localMedia){yp(this.localMedia,e,r);const i={call_id:this.callId,version:1,[Cn]:this.getSDPMetadata()};await this.sendSignallingMessage({type:se.SDPStreamMetadataChangedPrefix,content:i},r)}})}hangup(e,t){return t.wrap("hangup",r=>this._hangup(e,r))}async _hangup(e,t){this._state===ie.Ended||this._state===ie.Ending||(this.setState(ie.Ending,t),await this.sendHangupWithCallId(this.callId,e,t),this.terminate(At.Local,e,t))}getMessageAction(e){const t=this.callId===e.content.call_id;return e.type===se.Invite&&!t?0:t?1:2}handleIncomingSignallingMessage(e,t,r){let i;return r.wrap({l:"receive signalling message",type:e.type,callId:e.content.call_id,payload:e.content},async s=>{var o;if(i=s,this.getMessageAction(e)!==1){s.set("wrongCallId",!0);return}switch(e.type){case se.Invite:await this.handleFirstInvite(e.content,t,s);break;case se.Answer:await this.handleAnswer(e.content,t,s);break;case se.Negotiate:await this.onNegotiateReceived(e.content,s);break;case se.Candidates:await this.handleRemoteIceCandidates(e.content,t,s);break;case se.SDPStreamMetadataChanged:case se.SDPStreamMetadataChangedPrefix:this.updateRemoteSDPStreamMetadata(e.content[Cn],s);break;case se.Hangup:s.set("reason",e.content.reason),this.terminate(At.Remote,(o=e.content.reason)!=null?o:Te.UserHangup,s);break;default:s.log(`Unknown event type for call: ${e.type}`);break}}),i}sendHangupWithCallId(e,t,r){const i={call_id:e,version:1};return t&&(i.reason=t),this.sendSignallingMessage({type:se.Hangup,content:i},r)}async handleNegotiation(e){this.makingOffer=!0;try{try{await this.peerConnection.setLocalDescription()}catch(r){e.log("Error setting local description!").catch(r),this.terminate(At.Local,Te.SetLocalDescription,e);return}if(this.peerConnection.iceGatheringState==="gathering")try{await this.delay(200)}catch{return}if(this._state===ie.Ended)return;const t=this.peerConnection.localDescription;if(e.set("includedCandidates",this.candidateSendQueue.length),this.candidateSendQueue=[],this._state===ie.CreateOffer){const r={call_id:this.callId,offer:t,[Cn]:this.getSDPMetadata(),version:1,lifetime:oa};await this.sendSignallingMessage({type:se.Invite,content:r},e),this.setState(ie.InviteSent,e)}else if(this._state===ie.Connected||this._state===ie.Connecting){const r={call_id:this.callId,description:t,[Cn]:this.getSDPMetadata(),version:1,lifetime:oa};await this.sendSignallingMessage({type:se.Negotiate,content:r},e)}}finally{this.makingOffer=!1}if(this.sendCandidateQueue(e),this._state===ie.InviteSent){const t=this.logItem.child("invite timeout");e.refDetached(t),await t.run(async r=>{try{await this.delay(oa)}catch{return}this._state===ie.InviteSent&&await this._hangup(Te.InviteTimeout,r)})}}handleInviteGlare(e,t,r){if(e.type!==se.Invite)return{shouldReplace:!1};const{content:i}=e,s=i.call_id,o=this.callId>s;let a;return r.wrap("handling call glare",async c=>{a=c,o?(c.log("Glare detected: answering incoming call "+s+" and canceling outgoing call "),this._state!==ie.Fledgling&&this._state!==ie.CreateOffer&&await this.sendHangupWithCallId(this.callId,Te.Replaced,c),this.close(Te.Replaced,c),this.dispose()):(c.log("Glare detected: rejecting incoming call "+s+" and keeping outgoing call "),await this.sendHangupWithCallId(s,Te.Replaced,c))}),{shouldReplace:o,log:a}}handleHangupReceived(e,t){this.terminate(At.Remote,e.reason||Te.UserHangup,t)}async handleFirstInvite(e,t,r){this._state!==ie.Fledgling||this.opponentPartyId!==void 0||await this.handleInvite(e,t,r)}async handleInvite(e,t,r){var i;this.opponentPartyId=t,this.direction=ba.Inbound;const s=e[Cn];s?this.updateRemoteSDPStreamMetadata(s,r):r.log("Call did not get any SDPStreamMetadata! Can not send/receive multiple streams");try{await this.peerConnection.setRemoteDescription(e.offer),await this.addBufferedIceCandidates(r)}catch(o){await r.wrap("Call failed to set remote description",async a=>(a.catch(o),this.terminate(At.Local,Te.SetRemoteDescription,a)));return}if(this.peerConnection.getReceivers().length===0){await r.wrap("Call no remote stream or no tracks after setting remote description!",async o=>this.terminate(At.Local,Te.SetRemoteDescription,o));return}this.setState(ie.Ringing,r);try{await this.delay((i=e.lifetime)!=null?i:oa)}catch{return}this._state===ie.Ringing&&(r.log("Invite has expired. Hanging up."),this.hangupParty=At.Remote,this.setState(ie.Ended,r),this.peerConnection.signalingState!="closed"&&this.peerConnection.close())}async handleAnswer(e,t,r){if(this._state===ie.Ended){r.log("Ignoring answer because call has ended");return}if(this.opponentPartyId!==void 0){r.log(`Ignoring answer: we already have an answer/reject from ${this.opponentPartyId}`);return}this.opponentPartyId=t,await this.addBufferedIceCandidates(r),this.setState(ie.Connecting,r);const i=e[Cn];i?this.updateRemoteSDPStreamMetadata(i,r):r.log("Did not get any SDPStreamMetadata! Can not send/receive multiple streams");try{await this.peerConnection.setRemoteDescription(e.answer)}catch(s){await r.wrap("Failed to set remote description",o=>{o.catch(s),this.terminate(At.Local,Te.SetRemoteDescription,o)});return}}async handleIceGatheringState(e,t){if(e==="complete"&&!this.sentEndOfCandidates){const r={candidate:""};await this.queueCandidate(r,t),this.sentEndOfCandidates=!0}}async handleLocalIceCandidate(e,t){t.set("sdpMid",e.sdpMid),t.set("candidate",e.candidate),this._state!==ie.Ended&&(e.candidate!==""||!this.sentEndOfCandidates)&&(await this.queueCandidate(e,t),e.candidate===""&&(this.sentEndOfCandidates=!0))}async handleRemoteIceCandidates(e,t,r){if(this.state===ie.Ended){r.log("Ignoring remote ICE candidate because call has ended");return}const i=e.candidates;if(!i){r.log("Ignoring candidates event with no candidates!");return}const s=e.version===0?null:t||null;if(this.opponentPartyId===void 0){r.log(`Buffering ${i.length} candidates until we pick an opponent`);const o=this.remoteCandidateBuffer.get(s)||[];o.push(...i),this.remoteCandidateBuffer.set(s,o);return}if(this.opponentPartyId!==t){r.log(`Ignoring candidates from party ID ${t}: we have chosen party ID ${this.opponentPartyId}`);return}await this.addIceCandidates(i,r)}async onNegotiateReceived(e,t){const r=e.description;if(!r||!r.sdp||!r.type){t.log("Ignoring invalid m.call.negotiate event");return}const i=this.direction===ba.Inbound,s=r.type==="offer"&&(this.makingOffer||this.peerConnection.signalingState!=="stable");if(this.ignoreOffer=!i&&s,this.ignoreOffer){t.log("Ignoring colliding negotiate event because we're impolite");return}const o=e[Cn];o?this.updateRemoteSDPStreamMetadata(o,t):t.log("Received negotiation event without SDPStreamMetadata!");try{if(await this.peerConnection.setRemoteDescription(r),r.type==="offer"){await this.peerConnection.setLocalDescription();const a={call_id:this.callId,description:this.peerConnection.localDescription,[Cn]:this.getSDPMetadata(),version:1,lifetime:oa};await this.sendSignallingMessage({type:se.Negotiate,content:a},t)}}catch(a){t.log("Failed to complete negotiation").catch(a)}}async sendAnswer(e){const t=this.peerConnection.localDescription,r={call_id:this.callId,version:1,answer:{sdp:t.sdp,type:t.type},[Cn]:this.getSDPMetadata()};e.log(`Discarding ${this.candidateSendQueue.length} candidates that will be sent in answer`),this.candidateSendQueue=[];try{await this.sendSignallingMessage({type:se.Answer,content:r},e)}catch(i){throw this.terminate(At.Local,Te.SendAnswer,e),i}this.sendCandidateQueue(e)}async queueCandidate(e,t){var r;if(this.candidateSendQueue.push(e),this._state===ie.Ringing)return;this.flushCandidatesLog=(r=this.flushCandidatesLog)!=null?r:this.logItem.child("flush candidate queue"),t.refDetached(this.flushCandidatesLog);const{flushCandidatesLog:i}=this;try{await this.delay(this.direction===ba.Inbound?500:2e3)}catch{return}this.sendCandidateQueue(i),this.flushCandidatesLog=void 0}async sendCandidateQueue(e){if(this.candidateSendQueue.length===0||this._state===ie.Ended)return;const t=this.candidateSendQueue;return this.candidateSendQueue=[],e.wrap({l:"send candidates",size:t.length},async r=>{try{await this.sendSignallingMessage({type:se.Candidates,content:{call_id:this.callId,version:1,candidates:t}},r),await this.sendCandidateQueue(r)}catch(i){r.catch(i),this.terminate(At.Local,Te.SignallingFailed,r)}})}updateRemoteSDPStreamMetadata(e,t){this.remoteSDPStreamMetadata=nk(this.remoteSDPStreamMetadata||{},e,!0),this.updateRemoteMedia(t)}async addBufferedIceCandidates(e){if(this.remoteCandidateBuffer&&this.opponentPartyId){const t=this.remoteCandidateBuffer.get(this.opponentPartyId);t&&(e.log(`Adding ${t.length} buffered candidates for opponent ${this.opponentPartyId}`),await this.addIceCandidates(t,e)),this.remoteCandidateBuffer=void 0}}async addIceCandidates(e,t){for(const r of e){let i;(r.sdpMid===null||r.sdpMid===void 0)&&(r.sdpMLineIndex===null||r.sdpMLineIndex===void 0)?i=t.log("Got remote end-of-ICE candidates"):i=t.log(`Adding remote ICE ${r.sdpMid} candidate: ${r.candidate}`);try{await this.peerConnection.addIceCandidate(r)}catch(s){this.ignoreOffer||i.catch(s)}}}setState(e,t){if(e!==this._state){t.log({l:"change state",status:e,oldState:this._state}),this._state,this._state=e;let r=this.statePromiseMap.get(e);r&&(r.resolve(),this.statePromiseMap.delete(e)),this.options.emitUpdate(this,void 0,t)}}waitForState(e){return Promise.race(e.map(t=>{let r=this.statePromiseMap.get(t);if(!r){let i;const s=new Promise(o=>{i=o});r={resolve:i,promise:s},this.statePromiseMap.set(t,r)}return r.promise}))}terminate(e,t,r){this._state!==ie.Ended&&(this.hangupParty=e,this._hangupReason=t,this.setState(ie.Ended,r),this.localMedia=void 0,this.peerConnection&&this.peerConnection.signalingState!=="closed"&&this.peerConnection.close())}getSDPMetadata(){var e,t,r,i,s,o;const a={};if((e=this.localMedia)!=null&&e.userMedia){const c=this.localMedia.userMedia.id;a[c]={purpose:Nr.Usermedia,audio_muted:(r=(t=this.localMuteSettings)==null?void 0:t.microphone)!=null?r:!1,video_muted:(s=(i=this.localMuteSettings)==null?void 0:i.camera)!=null?s:!1}}if((o=this.localMedia)!=null&&o.screenShare){const c=this.localMedia.screenShare.id;a[c]={purpose:Nr.Screenshare}}return a}findReceiverForStream(e,t){return this.peerConnection.getReceivers().find(r=>r.track.kind===e&&this._remoteTrackToStreamId.get(r.track.id)===t)}findTransceiverForTrack(e){return this.peerConnection.getTransceivers().find(t=>{var r;return((r=t.sender.track)==null?void 0:r.id)===e.id})}onRemoteTrack(e,t,r){if(r.set("kind",e.kind),r.set("id",e.id),r.set("streams",t.map(s=>s.id)),t.length===0){r.log({l:`ignoring ${e.kind} streamless track`,id:e.id});return}const i=t[0];if(this._remoteTrackToStreamId.set(e.id,i.id),!this._remoteStreams.has(i.id)){const s=a=>{this.logItem.wrap({l:"removetrack",id:a.track.id},c=>{const u=this._remoteTrackToStreamId.get(a.track.id);if(u){this._remoteTrackToStreamId.delete(a.track.id);const l=this._remoteStreams.get(u);l&&l.stream.getTracks().length===0&&(this.disposables.disposeTracked(o),this._remoteStreams.delete(i.id),this.updateRemoteMedia(c))}})};i.addEventListener("removetrack",s);const o=()=>{i.removeEventListener("removetrack",s)};this.disposables.track(o),this._remoteStreams.set(i.id,{disposeListener:o,stream:i})}this.updateRemoteMedia(r)}updateRemoteMedia(e){e.wrap("reevaluating remote media",t=>{var r,i;if(this._remoteMedia.userMedia=void 0,this._remoteMedia.screenShare=void 0,this.remoteSDPStreamMetadata)for(const s of this._remoteStreams.values()){const{stream:o}=s,a=this.remoteSDPStreamMetadata[o.id];if(a)if(a.purpose===Nr.Usermedia){this._remoteMedia.userMedia=o;const c=this.findReceiverForStream(gp.Audio,o.id);c&&(c.track.enabled=!a.audio_muted);const u=this.findReceiverForStream(gp.Video,o.id);u&&(u.track.enabled=!a.video_muted),this._remoteMuteSettings=new fo((r=a.audio_muted)!=null?r:!1,(i=a.video_muted)!=null?i:!1,!!(c!=null&&c.track),!!(u!=null&&u.track)),t.log({l:"setting userMedia",micMuted:this._remoteMuteSettings.microphone,cameraMuted:this._remoteMuteSettings.camera})}else a.purpose===Nr.Screenshare&&(this._remoteMedia.screenShare=o,t.log("setting screenShare"));else t.log({l:"no metadata yet for stream, ignoring for now",id:o.id})}this.options.emitUpdate(this,void 0,t)})}updateLocalMedia(e,t){return t.wrap("updateLocalMedia",async r=>{var i,s;const o=this.peerConnection.getSenders(),a=async(c,u,l)=>{const d=async(p,m)=>{const w=o.find(v=>v.track===p),S=c??u;if(S!==u&&(p&&(S.removeTrack(p),p.stop()),m&&S.addTrack(m)),m&&w)try{await r.wrap(`attempting to replace ${l} ${m.kind} track`,v=>w.replaceTrack(m));return}catch{}w&&r.wrap(`removing ${l} ${w.track.kind} track`,v=>{this.peerConnection.removeTrack(w)}),m&&r.wrap(`adding ${l} ${m.kind} track`,v=>{const _=this.peerConnection.addTrack(m,S);this.options.webRTC.prepareSenderForPurpose(this.peerConnection,_,l)})};!c&&!u||(await d(Ji(c),Ji(u)),await d(Gr(c),Gr(u)))};await a((i=this.localMedia)==null?void 0:i.userMedia,e==null?void 0:e.userMedia,Nr.Usermedia),await a((s=this.localMedia)==null?void 0:s.screenShare,e==null?void 0:e.screenShare,Nr.Screenshare),this.localMedia||(this.localMedia=e)})}async delay(e){const t=this.disposables.track(this.options.createTimeout(e));try{await t.elapsed()}finally{this.disposables.untrack(t)}}sendSignallingMessage(e,t){return t.wrap({l:"send",id:e.type},async r=>this.options.sendSignallingMessage(e,r))}dispose(){var e;this.disposables.dispose(),(e=this.iceDisconnectedTimeout)==null||e.abort(),this.peerConnection.close(),this.options.emitUpdate=(t,r,i)=>{i.log("emitting update from PeerCall after disposal",this.logItem.level.Error)}}close(e,t){e===void 0&&(e=Te.UserHangup),this.terminate(At.Local,e,t)}}var At=(n=>(n.Local="local",n.Remote="remote",n))(At||{}),ie=(n=>(n.Fledgling="fledgling",n.CreateOffer="create_offer",n.InviteSent="invite_sent",n.CreateAnswer="create_answer",n.Connecting="connecting",n.Connected="connected",n.Ringing="ringing",n.Ending="ending",n.Ended="ended",n))(ie||{}),ba=(n=>(n.Inbound="inbound",n.Outbound="outbound",n))(ba||{});const oa=6e4;function cB(n){return n===se.Invite||n===se.Candidates||n===se.Answer||n===se.Hangup||n===se.SDPStreamMetadataChanged||n===se.SDPStreamMetadataChangedPrefix||n===se.Negotiate}class rk{constructor(e){this.errorCallback=e}try(e,t){try{let r=e();return r instanceof Promise&&(r=r.catch(i=>(this._error=i,this.reportError(i),t))),r}catch(r){return this._error=r,this.reportError(r),t}}reportError(e){try{this.errorCallback(e)}catch(t){console.error("error in ErrorBoundary callback",t)}}get error(){return this._error}}const uB=[Te.UserHangup,Te.AnsweredElsewhere,Te.Replaced,Te.UserBusy,Te.Transfered,Te.NewSession];class dB{constructor(e,t,r,i){this.localMedia=e,this.localMuteSettings=t,this.turnServer=r,this.logItem=i,this.retryCount=0,this.queuedSignallingMessages=[],this.outboundSeqCounter=0}get canDequeueNextSignallingMessage(){if(this.queuedSignallingMessages.length===0)return!1;const t=this.queuedSignallingMessages[0].content.seq;return this.lastIgnoredSeqNr!==void 0&&t===this.lastIgnoredSeqNr+1?!0:this.lastProcessedSeqNr===void 0?t===0:t<=this.lastProcessedSeqNr+1}dispose(){var e;(e=this.peerCall)==null||e.dispose(),this.localMedia.dispose(),this.logItem.finish()}}class hB{constructor(e,t,r,i,s,o){this.member=e,this.callDeviceMembership=t,this._deviceIndex=r,this._eventTimestamp=i,this.options=s,this.errorBoundary=new rk(a=>{this.emitMemberUpdate(this,"error"),this.connection&&this.connection.logItem.log("error at boundary").catch(a)}),this.emitUpdateFromPeerCall=async(a,c,u)=>{const l=this.connection;if(a.state===ie.Ringing)l.logItem.wrap("ringing, answer peercall",d=>(u.refDetached(d),a.answer(l.localMedia,l.localMuteSettings,d)));else if(a.state===ie.Ended){const d=a.hangupReason;if(a.dispose(),l.peerCall=void 0,d&&!uB.includes(d)){l.retryCount+=1;const{retryCount:p}=l;await l.logItem.wrap({l:"retry connection",retryCount:p},async m=>{if(u.refDetached(m),p<=3)await this.callIfNeeded(m);else{const w=await this.disconnect(!1);w&&m.refDetached(w)}})}}this.emitMemberUpdate(this,c)},this.sendSignallingMessage=async(a,c)=>{const u=a;u.content.seq=this.connection.outboundSeqCounter++,u.content.conf_id=this.options.confId,u.content.device_id=this.options.ownDeviceId,u.content.party_id=this.options.ownDeviceId,u.content.sender_session_id=this.options.sessionId,u.content.dest_session_id=this.sessionId;let l,d=a.type;const p=await this.options.encryptDeviceMessage(this.member.userId,this.deviceId,u,c);p?(l=cp(p),d="m.room.encrypted"):l=cp([{content:u.content,device:this}]),c.set("payload",u.content),await this.options.hsApi.sendToDevice(d,l,An(),{log:c}).response()},this.emitMemberUpdate=this.options.emitUpdate,this._renewExpireTimeout(o)}get error(){return this.errorBoundary.error}get usesFoci(){const e=this.callDeviceMembership["m.foci.active"];return Array.isArray(e)&&e.length>0}_renewExpireTimeout(e){var t;(t=this.expireTimeout)==null||t.dispose(),this.expireTimeout=void 0;const r=Gu(this.callDeviceMembership);if(typeof r!="number")return;const i=Math.max(0,r-this.options.clock.now());e==null||e.set("expiresIn",i),this.expireTimeout=this.options.clock.createTimeout(i+10),this.expireTimeout.elapsed().then(()=>{this.emitMemberUpdate(this,"isExpired")},s=>{})}get logItem(){var e;return(e=this.connection)==null?void 0:e.logItem}get remoteMedia(){var e,t;return(t=(e=this.connection)==null?void 0:e.peerCall)==null?void 0:t.remoteMedia}get isExpired(){return!this.isConnected&&wp(this.callDeviceMembership,this.options.clock.now())}get remoteMuteSettings(){var e,t;return(t=(e=this.connection)==null?void 0:e.peerCall)==null?void 0:t.remoteMuteSettings}get isConnected(){var e,t;return((t=(e=this.connection)==null?void 0:e.peerCall)==null?void 0:t.state)===ie.Connected}get userId(){return this.member.userId}get deviceId(){return this.callDeviceMembership.device_id}get user_id(){return this.userId}get device_id(){return this.deviceId}get sessionId(){return this.callDeviceMembership.session_id}get dataChannel(){var e,t;return(t=(e=this.connection)==null?void 0:e.peerCall)==null?void 0:t.dataChannel}get deviceIndex(){return this._deviceIndex}get eventTimestamp(){return this._eventTimestamp}connect(e,t,r,i){return this.errorBoundary.try(async()=>{if(this.connection)return;const s=new dB(e.clone(),t,r,i);this.connection=s;let o;return await s.logItem.wrap("connect",async a=>{o=a,await this.callIfNeeded(a)}),o})}callIfNeeded(e){return e.wrap("callIfNeeded",async t=>{let r;if(this.member.userId===this.options.ownUserId?r=this.deviceId>this.options.ownDeviceId:r=this.member.userId>this.options.ownUserId,r){const i=this.connection;i.peerCall=this._createPeerCall(Fu("c")),await i.peerCall.call(i.localMedia,i.localMuteSettings,t)}else t.set("wait_for_invite",!0)})}disconnect(e){return this.errorBoundary.try(async()=>{const{connection:t}=this;if(!t)return;let r;return await t.logItem.wrap("disconnect",async i=>{r=i,e&&t.peerCall&&await t.peerCall.hangup(Te.UserHangup,i)}),t.dispose(),this.connection=void 0,r})}updateCallInfo(e,t,r,i){this.errorBoundary.try(()=>{this.callDeviceMembership=e,this._deviceIndex=t,this._eventTimestamp=r,this._renewExpireTimeout(i),this.connection&&this.connection.logItem.refDetached(i)})}updateRoomMember(e){this.member=e,this.emitMemberUpdate(this)}handleDeviceMessage(e,t){this.errorBoundary.try(()=>{var r;t.wrap({l:"Member.handleDeviceMessage",type:e.type,seq:(r=e.content)==null?void 0:r.seq},i=>{const{connection:s}=this;if(s){const o=e.content.dest_session_id;if(o!==this.options.sessionId){const u=s.logItem.log({l:"ignoring to_device event with wrong session_id",destSessionId:o,type:e.type});i.refDetached(u);return}if(s.peerCall&&s.peerCall.getMessageAction(e)===vp.InviteGlare){const{shouldReplace:l,log:d}=s.peerCall.handleInviteGlare(e,this.deviceId,s.logItem);d&&d.refDetached(d),l&&(s.peerCall.dispose(),s.peerCall=void 0)}e.type===se.Invite&&!s.peerCall&&(s.peerCall=this._createPeerCall(e.content.call_id));const a=fr(s.queuedSignallingMessages,e,(u,l)=>u.content.seq-l.content.seq);s.queuedSignallingMessages.splice(a,0,e);let c=!1;s.peerCall&&(c=this.dequeueSignallingMessages(s,s.peerCall,e,i)),c||i.refDetached(s.logItem.log({l:"queued message",type:e.type,seq:e.content.seq,idx:a}))}else t.log({l:"member not connected",userId:this.userId,deviceId:this.deviceId})})})}dequeueSignallingMessages(e,t,r,i){let s=!1;for(;e.canDequeueNextSignallingMessage;){const o=e.queuedSignallingMessages.shift(),a=o===r;s=s||a,i.wrap(a?"process message":"dequeue message",c=>{var u;const l=(u=o.content)==null?void 0:u.seq;if(c.set("seq",l),c.set("type",o.type),t.getMessageAction(o)===vp.Handle){const p=t.handleIncomingSignallingMessage(o,this.deviceId,e.logItem);c.refDetached(p),e.lastProcessedSeqNr=l}else c.set("ignored",!0),e.lastIgnoredSeqNr=l})}return s}async setMedia(e,t){return this.errorBoundary.try(async()=>{var r;const{connection:i}=this;i&&(i.localMedia=e.replaceClone(i.localMedia,t),await((r=i.peerCall)==null?void 0:r.setMedia(i.localMedia,i.logItem)))})}async setMuted(e){return this.errorBoundary.try(async()=>{var t;const{connection:r}=this;r&&(r.localMuteSettings=e,await((t=r.peerCall)==null?void 0:t.setMuted(e,r.logItem)))})}_createPeerCall(e){const t=this.connection;return new lB(e,Object.assign({},this.options,{errorBoundary:this.errorBoundary,emitUpdate:this.emitUpdateFromPeerCall,sendSignallingMessage:this.sendSignallingMessage,turnServer:t.turnServer}),t.logItem)}dispose(){var e,t;(e=this.connection)==null||e.dispose(),this.connection=void 0,(t=this.expireTimeout)==null||t.dispose(),this.expireTimeout=void 0,this.emitMemberUpdate=()=>{}}}function Gu(n){const e=n.expires_ts;if(Number.isSafeInteger(e))return e}function wp(n,e,t=0){const r=Gu(n);return typeof r=="number"?r+t<=e:!0}function ms(n,e){return JSON.stringify(n)+","+JSON.stringify(e)}function Qv(n,e){return n.startsWith(JSON.stringify(e)+",")}function fB(n){return JSON.parse(`[${n}]`)[1]}class pB{constructor(e,t,r,i,s,o){this.logItem=e,this.membersLogItem=t,this.localMedia=r,this.localPreviewMedia=i,this.localMuteSettings=s,this.turnServer=o}dispose(){var e;this.localMedia.dispose(),this.localPreviewMedia.dispose(),this.logItem.finish(),(e=this.renewMembershipTimeout)==null||e.dispose()}}class zh extends kr{constructor(e,t,r,i,s,o,a){super(),this.id=e,this.isLoadedFromStorage=t,this.startTime=i,this.callContent=s,this.roomId=o,this.options=a,this._members=new pr,this.bufferedDeviceMessages=new Map,this.errorBoundary=new rk(c=>{this.emitChange(),this.joinedData&&(this.joinedData.logItem.log("error at boundary").catch(c),console.error(c))}),this._state=r?"fledgling":"created",this._memberOptions=Object.assign({},a,{confId:this.id,emitUpdate:c=>{var u;const l=ms(c.userId,c.deviceId);if(c.isExpired&&!c.isConnected){const d=this.options.logger.log({l:"removing expired member from call",memberKey:l,callId:this.id});(u=c.logItem)==null||u.refDetached(d),c.dispose(),this._members.remove(l)}else this._members.update(l)},encryptDeviceMessage:(c,u,l,d)=>this.options.encryptDeviceMessage(this.roomId,c,u,l,d)})}get localMedia(){var e;return(e=this.joinedData)==null?void 0:e.localMedia}get localPreviewMedia(){var e;return(e=this.joinedData)==null?void 0:e.localPreviewMedia}get members(){return this._members}get isTerminated(){var e;return!!((e=this.callContent)!=null&&e["m.terminated"])}get usesFoci(){for(const e of this._members.values())if(e.usesFoci)return!0;return!1}get duration(){if(typeof this.startTime=="number")return this.options.clock.now()-this.startTime}get isRinging(){return this._state==="created"&&this.intent==="m.ring"&&!this.isMember(this.options.ownUserId)}get name(){var e;return(e=this.callContent)==null?void 0:e["m.name"]}get intent(){var e;return(e=this.callContent)==null?void 0:e["m.intent"]}get deviceIndex(){return this._deviceIndex}get eventTimestamp(){return this._eventTimestamp}get type(){var e;return(e=this.callContent)==null?void 0:e["m.type"]}get logItem(){var e;return(e=this.joinedData)==null?void 0:e.logItem}get error(){return this.errorBoundary.error}join(e,t){return this.options.logger.wrapOrRun(t,"Call.join",async r=>{if(this._state!=="created"||this.joinedData||this.usesFoci){e.dispose();return}const i=this.options.logger.child({l:"Call.connection",t:Ci,id:this.id,ownSessionId:this.options.sessionId}),s=await this.options.turnServerSource.getSettings(i),o=i.child("member connections"),a=new fo;a.updateTrackInfo(e.userMedia);const c=e.asPreview(),u=new pB(i,o,e,c,a,s);this.joinedData=u,await u.logItem.wrap("join",async l=>{r.refDetached(l),this._state="joining",this.emitChange(),await l.wrap("update member state",async d=>{const p=await this._createMemberPayload(!0);d.set("payload",p),await this.options.hsApi.sendState(this.roomId,se.GroupCallMember,this.options.ownUserId,p,{log:d}).response(),this.emitChange()});for(const d of this._members.values())this.connectToMember(d,u,l)})})}async setMedia(e){var t;if((this._state==="joining"||this._state==="joined")&&this.joinedData){const r=this.joinedData.localMedia;this.joinedData.localMedia=e,(t=this.joinedData.localPreviewMedia)==null||t.dispose(),this.joinedData.localPreviewMedia=e.asPreview(),this.joinedData.localMuteSettings.updateTrackInfo(e.userMedia),this.emitChange(),await Promise.all(Array.from(this._members.values()).map(i=>i.setMedia(e,r))),r==null||r.dispose()}}async setMuted(e){const{joinedData:t}=this;if(!t)return;const r=t.localMuteSettings;e.updateTrackInfo(t.localMedia.userMedia),t.localMuteSettings=e,r.equals(e)||(this.localPreviewMedia&&yp(this.localPreviewMedia,e,this.joinedData.logItem),this.localMedia&&yp(this.localMedia,e,this.joinedData.logItem),await Promise.all(Array.from(this._members.values()).map(i=>i.setMuted(t.localMuteSettings))),this.emitChange())}get muteSettings(){var e;return(e=this.joinedData)==null?void 0:e.localMuteSettings}get hasJoined(){return this._state==="joining"||this._state==="joined"}async leave(e){await this.options.logger.wrapOrRun(e,"Call.leave",async t=>{var r;const{joinedData:i}=this;if(i)try{(r=i.renewMembershipTimeout)==null||r.dispose(),i.renewMembershipTimeout=void 0;const s=await this._createMemberPayload(!1);s?(await this.options.hsApi.sendState(this.roomId,se.GroupCallMember,this.options.ownUserId,s,{log:t}).response(),(this.intent===_l.Ring||this.intent===_l.Prompt)&&this._members.size===0&&await this.terminate(t)):t.set("already_left",!0)}finally{if(!this.disconnect(t))throw this.errorBoundary.error}})}terminate(e){return this.options.logger.wrapOrRun(e,{l:"terminate call",t:Ci},async t=>{if(this._state==="fledgling")return;await this.options.hsApi.sendState(this.roomId,se.GroupCall,this.id,Object.assign({},this.callContent,{"m.terminated":!0}),{log:t}).response()})}create(e,t){return t.wrap({l:"create call",t:Ci},async r=>{if(this._state!=="fledgling")return;this._state="creating",this.emitChange(),this.callContent=Object.assign({"m.type":e},this.callContent),await this.options.hsApi.sendState(this.roomId,se.GroupCall,this.id,this.callContent,{log:r}).response(),this._state="created",this.emitChange()})}updateCallEvent(e,t){this.errorBoundary.try(()=>{t.wrap({l:"update call",t:Ci,id:this.id},r=>{typeof this.startTime!="number"&&(this.startTime=e.origin_server_ts),this.callContent=e.content,this._state==="creating"&&(this._state="created"),r.set("status",this._state),this.emitChange()})})}updateRoomMembers(e){this.errorBoundary.try(()=>{for(const t of e.values()){const{member:r}=t;for(const i of this._members.values())i.userId===r.userId&&i.updateRoomMember(r)}})}updateMembership(e,t,r,i,s){this.errorBoundary.try(async()=>{await s.wrap({l:"update call membership",t:Ci,id:this.id,userId:e},async o=>{const a=this.options.clock.now(),c=r["m.devices"],u=this.getDeviceIdsForUserId(e);for(let d=0;d<c.length;d++){const p=c[d],m=p.device_id,w=ms(e,m);e===this.options.ownUserId&&m===this.options.ownDeviceId?(this._deviceIndex=d,this._eventTimestamp=i,o.wrap("update own membership",S=>{this.hasJoined&&(this.joinedData&&this.joinedData.logItem.refDetached(S),this._setupRenewMembershipTimeout(p,S)),this._state==="joining"&&(S.set("joined",!0),this._state="joined",this.emitChange())})):await o.wrap({l:"update device membership",id:w,sessionId:p.session_id},async S=>{if(wp(p,a)){S.set("expired",!0);const b=this._members.get(w);b?(b.dispose(),this._members.remove(w),S.set("removed",!0)):S.discard();return}let v=this._members.get(w);const _=v&&v.sessionId!==p.session_id;if(v&&!_)S.set("update",!0),v.updateCallInfo(p,d,i,S);else{if(v&&_){S.set("removedSessionId",v.sessionId);const b=await v.disconnect(!1);b&&S.refDetached(b),v.dispose(),this._members.remove(w),v=void 0}S.set("add",!0),v=new hB(t,p,d,i,this._memberOptions,S),this._members.add(w,v),this.joinedData&&this.connectToMember(v,this.joinedData,S)}this.flushPendingIncomingDeviceMessages(v,S)})}const l=new Set(c.map(d=>d.device_id));for(const d of u)l.has(d)||this.removeMemberDevice(e,d,o);e===this.options.ownUserId&&!l.has(this.options.ownDeviceId)&&this.removeOwnDevice(o)})})}removeMembership(e,t){this.errorBoundary.try(()=>{const r=this.getDeviceIdsForUserId(e);t.wrap({l:"remove call member",t:Ci,id:this.id,userId:e},i=>{for(const s of r)this.removeMemberDevice(e,s,i);e===this.options.ownUserId&&this.removeOwnDevice(i)})})}flushPendingIncomingDeviceMessages(e,t){const r=ms(e.userId,e.deviceId),i=this.bufferedDeviceMessages.get(r);if(i){for(const s of i)s.content.sender_session_id===e.sessionId&&(e.handleDeviceMessage(s,t),i.delete(s));i.size===0&&this.bufferedDeviceMessages.delete(r)}}getDeviceIdsForUserId(e){return Array.from(this._members.keys()).filter(t=>Qv(t,e)).map(t=>fB(t))}isMember(e){return Array.from(this._members.keys()).some(t=>Qv(t,e))}removeOwnDevice(e){e.wrap("remove own membership",t=>{this.disconnect(t)})}disconnect(e){return this.errorBoundary.try(async()=>{var t;if(this.hasJoined){for(const r of this._members.values()){const i=await r.disconnect(!0);i&&e.refDetached(i)}this._state="created"}(t=this.joinedData)==null||t.dispose(),this.joinedData=void 0,this.emitChange()},!1)||!0}async removeMemberDevice(e,t,r){const i=ms(e,t);await r.wrap({l:"remove device member",id:i},async s=>{const o=this._members.get(i);if(o){s.set("leave",!0);const a=await o.disconnect(!1);a&&s.refDetached(a),o.dispose(),this._members.remove(i)}})}handleDeviceMessage(e,t,r,i){this.errorBoundary.try(()=>{const s=ms(t,r);let o=this._members.get(s);if(o&&e.content.sender_session_id===o.sessionId)o.handleDeviceMessage(e,i);else{i.log({l:"call: buffering to_device message, member not found",t:Ci,id:this.id,userId:t,deviceId:r,sessionId:e.content.sender_session_id,type:e.type});let a=this.bufferedDeviceMessages.get(s);a||(a=new Set,this.bufferedDeviceMessages.set(s,a)),a.add(e)}})}async _createMemberPayload(e){var t,r;const{storage:i}=this.options,o=await(await i.readTxn([i.storeNames.roomState])).roomState.get(this.roomId,se.GroupCallMember,this.options.ownUserId),a=(r=(t=o==null?void 0:o.event)==null?void 0:t.content)!=null?r:{["m.calls"]:[]};let c=a["m.calls"],u=c.find(d=>d["m.call_id"]===this.id);u||(u={["m.call_id"]:this.id,["m.devices"]:[]},c.push(u));const l=this.options.clock.now();return u["m.devices"]=u["m.devices"].filter(d=>!(d.device_id===this.options.ownDeviceId||Gu(d)===void 0||wp(d,l,Hh))),e&&(u["m.devices"].push({device_id:this.options.ownDeviceId,session_id:this.options.sessionId,expires_ts:l+Hh,feeds:[{purpose:"m.usermedia"}]}),this._deviceIndex=u["m.devices"].length,this._eventTimestamp=Date.now()),a["m.calls"]=c.filter(d=>d["m.devices"].length!==0),a}async connectToMember(e,t,r){const i=ms(e.userId,e.deviceId),s=t.membersLogItem.child({l:"member",id:i,sessionId:e.sessionId});await r.wrap({l:"connect",id:i},async o=>{const a=await e.connect(t.localMedia,t.localMuteSettings,t.turnServer,s);a&&o.refDetached(a)})}emitChange(){this.emit("change"),this.options.emitUpdate(this)}_setupRenewMembershipTimeout(e,t){var r;const{joinedData:i}=this;if(!i)return;(r=i.renewMembershipTimeout)==null||r.dispose(),i.renewMembershipTimeout=void 0;const s=Gu(e);if(typeof s!="number")return;const o=s-this.options.clock.now(),a=Math.max(1e4,Math.ceil((.2+this.options.random()*.8)*(.08333*Hh))),c=Math.max(0,o-a);t.set("expiresIn",o),t.set("renewIn",c),i.renewMembershipTimeout=this.options.clock.createTimeout(c),i.renewMembershipTimeout.elapsed().then(()=>{i.logItem.wrap("renew membership",async u=>{const l=await this._createMemberPayload(!0);u.set("payload",l),await this.options.hsApi.sendState(this.roomId,se.GroupCallMember,this.options.ownUserId,l,{log:u}).response()})},()=>{})}dispose(){var e;(e=this.joinedData)==null||e.dispose();for(const t of this._members.values())t.dispose()}}const Zv=5*60,mB={urls:["stun:turn.matrix.org"],username:"",credential:""};class _B{constructor(e,t,r=mB){this.hsApi=e,this.clock=t,this.defaultSettings=r,this.isPolling=!1}getSettings(e){return e.wrap("get turn server",async t=>{if(!this.isPolling){const r=await this.doRequest(t),i=r?ew(r):this.defaultSettings;t.set("iceServer",i),this.currentObservable?this.currentObservable.set(i):this.currentObservable=new fl(i,()=>{this.stopPollLoop()},()=>{var s;this.runLoop((s=r==null?void 0:r.ttl)!=null?s:Zv)})}return this.currentObservable})}async runLoop(e){let t=e;for(this.isPolling=!0;this.isPolling;)try{this.pollTimeout=this.clock.createTimeout(t*1e3),await this.pollTimeout.elapsed(),this.pollTimeout=void 0;const r=await this.doRequest(void 0);if(r){const i=ew(r);gB(this.currentObservable,i)&&this.currentObservable.set(i),r.ttl>0?t=r.ttl:this.stopPollLoop()}else t=Zv}catch(r){r.name}}async doRequest(e){try{return this.pollRequest=this.hsApi.getTurnServer({log:e}),await this.pollRequest.response()}catch(t){if(t.name==="HomeServerError")return;throw t}finally{this.pollRequest=void 0}}stopPollLoop(){var e,t;this.isPolling=!1,this.currentObservable=void 0,(e=this.pollTimeout)==null||e.dispose(),this.pollTimeout=void 0,(t=this.pollRequest)==null||t.abort(),this.pollRequest=void 0}dispose(){this.stopPollLoop()}}function gB(n,e){const t=n.get();if(!t)return!0;const r=Array.isArray(t.urls)?t.urls:[t.urls],i=Array.isArray(e.urls)?e.urls:[e.urls];return!(r.length===i.length&&!i.some(o=>!r.includes(o)))||e.username!==t.username||e.credential!==t.credential}function ew(n){return{urls:n.uris,username:n.username,credential:n.password,credentialType:"password"}}function yB(n,e){return JSON.stringify(n)+","+JSON.stringify(e)}class vB{constructor(e){this.options=e,this._calls=new pr,this.roomMemberToCallIds=new Map,this.sessionId=Fu("s"),this.groupCallOptions=Object.assign({},this.options,{turnServerSource:new _B(this.options.hsApi,this.options.clock),emitUpdate:(t,r)=>this._calls.update(t.id,r),createTimeout:this.options.clock.createTimeout,sessionId:this.sessionId})}loadCalls(e,t){return this.options.logger.wrapOrRun(t,"CallHandler.loadCalls",async r=>{e||(e=_l.Ring),r.set("intent",e);const i=await this._getLoadTxn(),s=await i.calls.getByIntent(e);await this._loadCallEntries(s,i,r)})}loadCallsForRoom(e,t,r){return this.options.logger.wrapOrRun(r,"CallHandler.loadCallsForRoom",async i=>{i.set("intent",e),i.set("roomId",t);const s=await this._getLoadTxn(),o=await s.calls.getByIntentAndRoom(e,t);await this._loadCallEntries(o,s,i)})}async _getLoadTxn(){const e=this.options.storage.storeNames;return await this.options.storage.readTxn([e.calls,e.roomState])}async _loadCallEntries(e,t,r){r.set("entries",e.length),await Promise.all(e.map(async s=>{if(this._calls.get(s.callId))return;const o=await t.roomState.get(s.roomId,se.GroupCall,s.callId);if(o){const a=new zh(o.event.state_key,!0,!1,s.timestamp,o.event.content,o.roomId,this.groupCallOptions);this._calls.set(a.id,a)}}));const i=Array.from(new Set(e.map(s=>s.roomId)));await Promise.all(i.map(async s=>{const o=await t.roomState.getAllForType(s,se.GroupCallMember);await Promise.all(o.map(async a=>{const c=a.event.sender,u=await t.roomState.get(s,zt,c);let l;u&&(l=ye.fromMemberEvent(u.event)),l||(l=ye.fromUserId(s,c,"join")),this.handleCallMemberEvent(a.event,l,s,r)}))})),r.set("newSize",this._calls.size)}createCall(e,t,r,i,s){return this.options.logger.wrapOrRun(s,"CallHandler.createCall",async o=>{i||(i=_l.Ring);const a=new zh(Fu("conf-"),!1,!0,void 0,{"m.name":r,"m.intent":i},e,this.groupCallOptions);this._calls.set(a.id,a);try{await a.create(t,o);const c=await this.options.storage.readWriteTxn([this.options.storage.storeNames.calls]);c.calls.add({intent:a.intent,callId:a.id,timestamp:this.options.clock.now(),roomId:e}),await c.complete()}catch(c){throw this._calls.remove(a.id),c}return a})}get calls(){return this._calls}async handleRoomState(e,t,r,i,s){if(t.type===se.GroupCall&&this.handleCallEvent(t,e.id,i,s),t.type===se.GroupCallMember){let o=await r.lookupMemberAtEvent(t.sender,t,i);o||(o=ye.fromUserId(e.id,t.sender,"join")),this.handleCallMemberEvent(t,o,e.id,s)}}updateRoomMembers(e,t){for(const r of this._calls.values())r.roomId===e.id&&r.updateRoomMembers(t)}handlesDeviceMessageEventType(e){return cB(e)}handleDeviceMessage(e,t,r,i){const s=this._calls.get(e.content.conf_id);s==null||s.handleDeviceMessage(e,t,r,i)}handleCallEvent(e,t,r,i){const s=e.state_key;let o=this._calls.get(s);o?(o.updateCallEvent(e,i),o.isTerminated&&(o.disconnect(i),this._calls.remove(o.id),r.calls.remove(o.intent,t,o.id))):e.content["m.terminated"]||(o=new zh(e.state_key,!1,!1,e.origin_server_ts,e.content,t,this.groupCallOptions),this._calls.set(o.id,o),r.calls.add({intent:o.intent,callId:o.id,timestamp:e.origin_server_ts,roomId:t}))}handleCallMemberEvent(e,t,r,i){var s;const o=e.state_key,a=yB(r,o),c=(s=e.content["m.calls"])!=null?s:[],u=e.origin_server_ts;for(const p of c){const m=p["m.call_id"],w=this._calls.get(m);w==null||w.updateMembership(o,t,p,u,i)}const l=new Set(c.map(p=>p["m.call_id"]));let d=this.roomMemberToCallIds.get(a);if(d){for(const p of d)if(!l.has(p)){const m=this._calls.get(p);m==null||m.removeMembership(o,i)}}l.size===0?this.roomMemberToCallIds.delete(a):this.roomMemberToCallIds.set(a,l)}dispose(){this.groupCallOptions.turnServerSource.dispose();for(const e of this._calls.values())e.dispose()}}class wB extends Ml{async handleRoomState(e,t,r,i,s){const o=[];for(let a of this._handlers)o.push(a.handleRoomState(e,t,r,i,s));await Promise.all(o)}updateRoomMembers(e,t){for(let r of this._handlers)r.updateRoomMembers(e,t)}}const Mi="DEFAULT_KEY",aa="pusher";class bB{constructor({storage:e,hsApi:t,sessionInfo:r,olm:i,olmWorker:s,platform:o,mediaRepository:a,features:c}){this._platform=o,this._storage=e,this._hsApi=t,this._mediaRepository=a,this._features=c,this._syncInfo=null,this._sessionInfo=r,this._rooms=new pr,this._roomUpdateCallback=(u,l)=>this._rooms.update(u.id,l),this._activeArchivedRooms=new Map,this._invites=new pr,this._inviteUpdateCallback=(u,l)=>this._invites.update(u.id,l),this._roomsBeingCreatedUpdateCallback=(u,l)=>{u.isCancelled?this._roomsBeingCreated.remove(u.id):this._roomsBeingCreated.update(u.id,l)},this._roomsBeingCreated=new pr,this._user=new qL(r.userId),this._roomStateHandler=new wB,c.calls&&this._setupCallHandler(),this._deviceMessageHandler=new EF({storage:e,callHandler:this._callHandler}),this._olm=i,this._olmUtil=null,this._e2eeAccount=null,this._deviceTracker=null,this._olmEncryption=null,this._keyLoader=null,this._megolmEncryption=null,this._megolmDecryption=null,this._getSyncToken=()=>this.syncToken,this._olmWorker=s,this._keyBackup=new hr(void 0),this._crossSigning=new hr(void 0),this._observedRoomStatus=new Map,i&&(this._olmUtil=new i.Utility,this._deviceTracker=new gP({storage:e,getSyncToken:this._getSyncToken,olmUtil:this._olmUtil,ownUserId:r.userId,ownDeviceId:r.deviceId})),this._createRoomEncryption=this._createRoomEncryption.bind(this),this._forgetArchivedRoom=this._forgetArchivedRoom.bind(this),this.needsKeyBackup=new hr(!1)}get hsApi(){return this._hsApi}get sessionInfo(){return this._sessionInfo}get fingerprintKey(){var e;return(e=this._e2eeAccount)==null?void 0:e.identityKeys.ed25519}get hasSecretStorageKey(){return this._hasSecretStorageKey}get deviceId(){return this._sessionInfo.deviceId}get userId(){return this._sessionInfo.userId}get callHandler(){return this._callHandler}_setupCallHandler(){this._callHandler=new vB({clock:this._platform.clock,random:this._platform.random,hsApi:this._hsApi,encryptDeviceMessage:async(e,t,r,i,s)=>{if(!this._deviceTracker||!this._olmEncryption){s.set("encryption_disabled",!0);return}const o=await s.wrap("get device key",async a=>{const c=this._deviceTracker.deviceForId(t,r,this._hsApi,a);return c||a.set("not_found",!0),c});if(o)return await this._olmEncryption.encrypt(i.type,i.content,[o],this._hsApi,s)},storage:this._storage,webRTC:this._platform.webRTC,ownDeviceId:this._sessionInfo.deviceId,ownUserId:this._sessionInfo.userId,logger:this._platform.logger,forceTURN:!1}),this.observeRoomState(this._callHandler)}_setupEncryption(){const e=new sB,t=new MF(this._e2eeAccount,Mi,this._platform.clock.now,this._user.id,this._olm,e);this._olmEncryption=new NF(this._e2eeAccount,Mi,this._olm,this._storage,this._platform.clock.now,this._user.id,this._olmUtil,e),this._keyLoader=new qF(this._olm,Mi,20),this._megolmEncryption=new ZF({account:this._e2eeAccount,pickleKey:Mi,olm:this._olm,storage:this._storage,keyLoader:this._keyLoader,now:this._platform.clock.now,ownDeviceId:this._sessionInfo.deviceId}),this._megolmDecryption=new GF(this._keyLoader,this._olmWorker),this._deviceMessageHandler.enableEncryption({olmDecryption:t,megolmDecryption:this._megolmDecryption})}_createRoomEncryption(e,t){var r;if(!this._olmEncryption)throw new Error("creating room encryption before encryption got globally enabled");return t.algorithm!==Kn?null:new nB({room:e,deviceTracker:this._deviceTracker,olmEncryption:this._olmEncryption,megolmEncryption:this._megolmEncryption,megolmDecryption:this._megolmDecryption,storage:this._storage,keyBackup:(r=this._keyBackup)==null?void 0:r.get(),encryptionParams:t,notifyMissingMegolmSession:()=>{this._keyBackup.get()||this.needsKeyBackup.set(!0)},clock:this._platform.clock})}enableSecretStorage(e,t,r=void 0){return this._platform.logger.wrapOrRun(r,"enable secret storage",async i=>{var s,o;if(!this._olm)throw new Error("olm required");this._keyBackup.get()&&(this._keyBackup.get().dispose(),this._keyBackup.set(void 0));const a=this._crossSigning.get();a&&(a.dispose(),this._crossSigning.set(void 0));const c=await PO(e,t,this._storage,this._platform,this._olm);if(await this._tryLoadSecretStorage(c,i))return await this._writeSSSSKey(c,i),await((s=this._keyBackup.get())==null?void 0:s.start(i)),await((o=this._crossSigning.get())==null?void 0:o.start(i)),c;throw new Error("Could not read key backup with the given key")})}async _writeSSSSKey(e,t){const r=this._keyBackup.get();if(!r)return;const i=r.version,s=await this._storage.readWriteTxn([this._storage.storeNames.session,this._storage.storeNames.inboundGroupSessions]);try{const o=await AO(e,i,s);if(t.set("previousBackupVersion",o),t.set("backupVersion",i),o&&o!==i){const a=await r.markAllForBackup(s);t.set("amountMarkedForBackup",a)}}catch(o){throw s.abort(),o}await s.complete()}async disableSecretStorage(){const e=await this._storage.readWriteTxn([this._storage.storeNames.session]);try{NO(e)}catch(r){throw e.abort(),r}if(await e.complete(),this._keyBackup.get()){for(const r of this._rooms.values())r.isEncrypted&&r.enableKeyBackup(void 0);this._keyBackup.get().dispose(),this._keyBackup.set(void 0)}const t=this._crossSigning.get();t&&(t.dispose(),this._crossSigning.set(void 0))}_tryLoadSecretStorage(e,t){return t.wrap("enable secret storage",async r=>{const i=new oB({key:e,platform:this._platform,storage:this._storage}),s=await i.hasValidKeyForAnyAccountData();return r.set("isValid",s),s&&await this._loadSecretStorageServices(i,r),s})}async _loadSecretStorageServices(e,t){try{await t.wrap("enable key backup",async r=>{const i=new QF(this._hsApi,this._olm,this._keyLoader,this._storage,this._platform);if(await i.load(e,r)){for(const s of this._rooms.values())s.isEncrypted&&s.enableKeyBackup(i);return this._keyBackup.set(i),!0}else r.set("no_backup",!0)}),this._features.crossSigning&&await t.wrap("enable cross-signing",async r=>{const i=new hP({storage:this._storage,secretStorage:e,platform:this._platform,olm:this._olm,olmUtil:this._olmUtil,deviceTracker:this._deviceTracker,deviceMessageHandler:this._deviceMessageHandler,hsApi:this._hsApi,ownUserId:this.userId,e2eeAccount:this._e2eeAccount,deviceId:this.deviceId});await i.load(r)?this._crossSigning.set(i):i.dispose()})}catch(r){t.catch(r)}}get keyBackup(){return this._keyBackup}get crossSigning(){return this._crossSigning}get hasIdentity(){return!!this._e2eeAccount}async createIdentity(e){this._olm&&(this._e2eeAccount||(this._e2eeAccount=await this._createNewAccount(this._sessionInfo.deviceId,this._storage),e.set("keys",this._e2eeAccount.identityKeys),this._setupEncryption()),await this._e2eeAccount.generateOTKsIfNeeded(this._storage,e),await e.wrap("uploadKeys",t=>this._e2eeAccount.uploadKeys(this._storage,!1,t)))}async dehydrateIdentity(e,t){return t.set("deviceId",e.deviceId),this._olm?e.deviceId!==this.deviceId?(t.set("wrong_device",!0),!1):this._e2eeAccount?(t.set("account_already_setup",!0),!1):await e.claim(this._hsApi,t)?(this._e2eeAccount=await Xi.adoptDehydratedDevice({dehydratedDevice:e,hsApi:this._hsApi,olm:this._olm,pickleKey:Mi,userId:this._sessionInfo.userId,olmWorker:this._olmWorker,deviceId:this.deviceId,storage:this._storage}),t.set("keys",this._e2eeAccount.identityKeys),this._setupEncryption(),!0):(t.set("already_claimed",!0),!1):(t.set("no_olm",!0),!1)}_createNewAccount(e,t=void 0){return Xi.create({hsApi:this._hsApi,olm:this._olm,pickleKey:Mi,userId:this._sessionInfo.userId,olmWorker:this._olmWorker,deviceId:e,storage:t})}setupDehydratedDevice(e,t=null){return this._platform.logger.wrapOrRun(t,"setupDehydratedDevice",async r=>{const i=await this._createNewAccount("temp-device-id");try{const s=await TF(i,this._hsApi,e,"Dehydrated device",r);return r.set("deviceId",s),s}finally{i.dispose()}})}async load(e){const t=await this._storage.readTxn([this._storage.storeNames.session,this._storage.storeNames.roomSummary,this._storage.storeNames.invites,this._storage.storeNames.roomMembers,this._storage.storeNames.timelineEvents,this._storage.storeNames.timelineFragments,this._storage.storeNames.pendingEvents,this._storage.storeNames.accountData,this._storage.storeNames.crossSigningKeys]);this._syncInfo=await t.session.get("sync"),this._olm&&(this._e2eeAccount=await Xi.load({hsApi:this._hsApi,olm:this._olm,pickleKey:Mi,userId:this._sessionInfo.userId,deviceId:this._sessionInfo.deviceId,olmWorker:this._olmWorker,txn:t}),this._e2eeAccount&&e.set("keys",this._e2eeAccount.identityKeys),this._setupEncryption());const r=await this._getPendingEventsByRoom(t),i=await t.invites.getAll(),s=Promise.all(i.map(async c=>{const u=this.createInvite(c.roomId);e.wrap("invite",l=>u.load(c,l)),this._invites.add(u.id,u)})),o=await t.roomSummary.getAll(),a=Promise.all(o.map(async c=>{const u=this.createJoinedRoom(c.roomId,r.get(c.roomId));await e.wrap("room",l=>u.load(c,t,l)),this._rooms.add(u.id,u)}));await Promise.all([s,a]);for(const[c,u]of this.invites){const l=this.rooms.get(c);l&&l.setInvite(u)}if(this._olm&&this._e2eeAccount){const c=await DO(t);c&&await this._tryLoadSecretStorage(c,e)}}dispose(){var e,t,r,i,s,o;(e=this._olmWorker)==null||e.dispose(),this._olmWorker=void 0,(t=this._keyBackup.get())==null||t.dispose(),this._keyBackup.set(void 0),(r=this._megolmDecryption)==null||r.dispose(),this._megolmDecryption=void 0,(i=this._e2eeAccount)==null||i.dispose(),this._e2eeAccount=void 0,(s=this._callHandler)==null||s.dispose(),this._callHandler=void 0,(o=this._crossSigning.get())==null||o.dispose();for(const a of this._rooms.values())a.dispose();this._rooms=void 0}async start(e,t,r){var i,s;if(e){const u=await this._storage.readWriteTxn([this._storage.storeNames.session]);u.session.set("serverVersions",e),await u.complete()}t&&await r.wrap("SSSSKeyFromDehydratedDeviceKey",async u=>{const l=await OO(t.key,this._storage,this._platform);l&&await this._tryLoadSecretStorage(l,u)&&(u.set("success",!0),await this._writeSSSSKey(l))}),await((i=this._keyBackup.get())==null?void 0:i.start(r)),await((s=this._crossSigning.get())==null?void 0:s.start(r));const a=await(await this._storage.readWriteTxn([this._storage.storeNames.operations])).operations.getAll(),c=co(a,u=>u.scope);for(const u of this._rooms.values()){let l;const d=c.get(u.id);d&&(l=co(d,p=>p.type)),u.start(l,r)}}async _getPendingEventsByRoom(e){return(await e.pendingEvents.getAll()).reduce((r,i)=>{const s=r.get(i.roomId);return s?s.push(i):r.set(i.roomId,[i]),r},new Map)}get rooms(){return this._rooms}findDirectMessageForUserId(e){for(const[,t]of this._rooms)if(t.isDirectMessageForUserId(e))return t;for(const[,t]of this._invites)if(t.isDirectMessageForUserId(e))return t}createJoinedRoom(e,t){return new fF({roomId:e,getSyncToken:this._getSyncToken,storage:this._storage,emitCollectionChange:this._roomUpdateCallback,hsApi:this._hsApi,mediaRepository:this._mediaRepository,pendingEvents:t,user:this._user,createRoomEncryption:this._createRoomEncryption,platform:this._platform,roomStateHandler:this._roomStateHandler})}_createArchivedRoom(e){const t=new pF({roomId:e,getSyncToken:this._getSyncToken,storage:this._storage,emitCollectionChange:()=>{},releaseCallback:()=>this._activeArchivedRooms.delete(e),forgetCallback:this._forgetArchivedRoom,hsApi:this._hsApi,mediaRepository:this._mediaRepository,user:this._user,createRoomEncryption:this._createRoomEncryption,platform:this._platform});return this._activeArchivedRooms.set(e,t),t}get invites(){return this._invites}createInvite(e){return new SF({roomId:e,hsApi:this._hsApi,emitCollectionUpdate:this._inviteUpdateCallback,mediaRepository:this._mediaRepository,user:this._user,platform:this._platform})}get roomsBeingCreated(){return this._roomsBeingCreated}createRoom(e){let t;return this._platform.logger.runDetached("create room",async r=>{const i=`local-${Math.floor(this._platform.random()*Number.MAX_SAFE_INTEGER)}`;t=new bF(i,e,this._roomsBeingCreatedUpdateCallback,this._mediaRepository,this._platform,r),this._roomsBeingCreated.set(i,t);const s=[t.create(this._hsApi,r)];e.loadProfiles!==!1&&s.push(t.loadProfiles(this._hsApi,r)),await Promise.all(s),t.roomId&&(this.rooms.get(t.roomId)&&this._tryReplaceRoomBeingCreated(t.roomId,r),await t.adjustDirectMessageMapIfNeeded(this._user,this._storage,this._hsApi,r))}),t}async obtainSyncLock(e){var t;const r=(t=e.to_device)==null?void 0:t.events;if(Array.isArray(r)&&r.length)return await this._deviceMessageHandler.obtainSyncLock(r)}async prepareSync(e,t,r,i){var s;const o=(s=e.to_device)==null?void 0:s.events;if(Array.isArray(o)&&o.length)return await i.wrap("deviceMsgs",a=>this._deviceMessageHandler.prepareSync(o,t,r,a))}async writeSync(e,t,r,i,s){const o={syncInfo:null,e2eeAccountChanges:null,hasNewRoomKeys:!1,deviceMessageDecryptionResults:null},a=e.next_batch;if(a!==this.syncToken){const d={token:a,filterId:t};i.session.set("sync",d),o.syncInfo=d}const c=e.device_one_time_keys_count;this._e2eeAccount&&c&&(o.e2eeAccountChanges=this._e2eeAccount.writeSync(c,i,s));const u=e.device_lists;if(this._deviceTracker&&Array.isArray(u==null?void 0:u.changed)&&u.changed.length&&await s.wrap("deviceLists",d=>this._deviceTracker.writeDeviceChanges(u.changed,i,d)),r){const{hasNewRoomKeys:d,decryptionResults:p}=await s.wrap("deviceMsgs",m=>this._deviceMessageHandler.writeSync(r,i,m));o.hasNewRoomKeys=d,o.deviceMessageDecryptionResults=p}const l=e.account_data;if(Array.isArray(l==null?void 0:l.events))for(const d of l.events)typeof d.type=="string"&&i.accountData.set(d);return o}afterSync({syncInfo:e,e2eeAccountChanges:t}){e&&(this._syncInfo=e),this._e2eeAccount&&this._e2eeAccount.afterSync(t)}async afterSyncCompleted(e,t,r){var i;this._e2eeAccount&&!t&&await this._e2eeAccount.generateOTKsIfNeeded(this._storage,r)&&await r.wrap("uploadKeys",o=>this._e2eeAccount.uploadKeys(this._storage,!1,o)),e.hasNewRoomKeys&&((i=this._keyBackup.get())==null||i.flush(r)),e.deviceMessageDecryptionResults&&await this._deviceMessageHandler.afterSyncCompleted(e.deviceMessageDecryptionResults,this._deviceTracker,this._hsApi,r)}_tryReplaceRoomBeingCreated(e,t){for(const[,r]of this._roomsBeingCreated)if(r.roomId===e){const i=this._observedRoomStatus.get(r.id);i&&(t.log("replacing room being created").set("localId",r.id).set("roomId",r.roomId),i.set(i.get()|wt.Replaced)),r.dispose(),this._roomsBeingCreated.remove(r.id);return}}async applyRoomCollectionChangesAfterSync(e,t,r,i){var s,o;for(const a of t)a.shouldAdd?(this._rooms.add(a.id,a.room),this._tryReplaceRoomBeingCreated(a.id,i)):a.shouldRemove&&this._rooms.remove(a.id);for(const a of e)a.shouldAdd?this._invites.add(a.id,a.invite):a.shouldRemove&&this._invites.remove(a.id);if(this._observedRoomStatus.size!==0){for(const a of r)a.shouldAdd&&((s=this._observedRoomStatus.get(a.id))==null||s.set(wt.Archived));for(const a of t)a.shouldAdd&&((o=this._observedRoomStatus.get(a.id))==null||o.set(wt.Joined));for(const a of e){const c=this._observedRoomStatus.get(a.id);if(c){const u=c.get()|wt.Invited;if(a.shouldAdd)c.set(u);else if(a.shouldRemove){const l=u^wt.Invited;c.set(l)}}}}}_forgetArchivedRoom(e){const t=this._observedRoomStatus.get(e);t&&t.set((t.get()|wt.Archived)^wt.Archived)}get syncToken(){var e;return(e=this._syncInfo)==null?void 0:e.token}get syncFilterId(){var e;return(e=this._syncInfo)==null?void 0:e.filterId}get user(){return this._user}get mediaRepository(){return this._mediaRepository}enablePushNotifications(e){return e?this._enablePush():this._disablePush()}async _enablePush(){return this._platform.logger.run("enablePush",async e=>{const t=Ni.createDefaultPayload(this._sessionInfo.id),r=await this._platform.notificationService.enablePush(Ni,t);if(!r)return e.set("no_pusher",!0),!1;await r.enable(this._hsApi,e);const i=await this._storage.readWriteTxn([this._storage.storeNames.session]);return i.session.set(aa,r.serialize()),await i.complete(),!0})}async _disablePush(){return this._platform.logger.run("disablePush",async e=>{await this._platform.notificationService.disablePush();const r=await(await this._storage.readTxn([this._storage.storeNames.session])).session.get(aa);if(!r)return!0;await new Ni(r).disable(this._hsApi,e);const s=await this._storage.readWriteTxn([this._storage.storeNames.session]);return s.session.remove(aa),await s.complete(),!0})}async arePushNotificationsEnabled(){return await this._platform.notificationService.isPushEnabled()?!!await(await this._storage.readTxn([this._storage.storeNames.session])).session.get(aa):!1}async checkPusherEnabledOnHomeserver(){const t=await(await this._storage.readTxn([this._storage.storeNames.session])).session.get(aa);if(!t)return!1;const r=new Ni(t),i=await this._hsApi.getPushers().response();return((i==null?void 0:i.pushers)||[]).map(o=>new Ni(o)).some(o=>o.equals(r))}async getRoomStatus(e){if(!!this._roomsBeingCreated.get(e))return wt.BeingCreated;if(!!this._rooms.get(e))return wt.Joined;{const i=!!this._invites.get(e),o=await(await this._storage.readTxn([this._storage.storeNames.archivedRoomSummary])).archivedRoomSummary.has(e);return i&&o?wt.Invited|wt.Archived:i?wt.Invited:o?wt.Archived:wt.None}}async observeRoomStatus(e){let t=this._observedRoomStatus.get(e);if(!t){let r;t=new fl(r,()=>{this._observedRoomStatus.delete(e)}),this._observedRoomStatus.set(e,t),r=await this.getRoomStatus(e),t.get()===void 0&&t.set(r)}return t}observeRoomState(e){return this._roomStateHandler.subscribe(e)}async setAccountData(e,t){const r=await this._storage.readWriteTxn([this._storage.storeNames.accountData]);r&&(r.accountData.set({type:e,content:t}),await r.complete()),await this.hsApi.setAccountData(this.userId,e,t).response()}async getAccountData(e){const t=await this._storage.readWriteTxn([this._storage.storeNames.accountData]),r=await t.accountData.get(e);if(r)return await t.complete(),r.content;try{const i=await this.hsApi.accountData(this.userId,e).response();return i&&(t.accountData.set({type:e,content:i}),await t.complete()),i}catch{t.abort();return}}createOrGetArchivedRoomForSync(e){let t=this._activeArchivedRooms.get(e);return t?t.retain():t=this._createArchivedRoom(e),t}loadArchivedRoom(e,t=null){return this._platform.logger.wrapOrRun(t,"loadArchivedRoom",async r=>{r.set("id",e);const i=this._activeArchivedRooms.get(e);if(i)return i.retain(),i;const s=await this._storage.readTxn([this._storage.storeNames.archivedRoomSummary,this._storage.storeNames.roomMembers]),o=await s.archivedRoomSummary.get(e);if(o){const a=this._createArchivedRoom(e);return await a.load(o,s,r),a}})}joinRoom(e,t=null){return this._platform.logger.wrapOrRun(t,"joinRoom",async r=>(await this._hsApi.joinIdOrAlias(e,{log:r}).response()).room_id)}}class SB{constructor({username:e,password:t,homeserver:r}){this._username=e,this._password=t,this.homeserver=r}async login(e,t,r){return await e.passwordLogin(this._username,this._password,t,{log:r}).response()}}class EB{constructor({homeserver:e,loginToken:t}){this.homeserver=e,this._loginToken=t}async login(e,t,r){return await e.tokenLogin(this._loginToken,An(),t,{log:r}).response()}}class kB{constructor(e){this._homeserver=e}get homeserver(){return this._homeserver}createSSORedirectURL(e){return`${this._homeserver}/_matrix/client/r0/login/sso/redirect?redirectUrl=${encodeURIComponent(e)}`}}class M_{constructor(e,t){this._session=e,this._params=t}setNextStage(e){this._nextStage=e}get nextStage(){return this._nextStage}}class IB extends M_{generateAuthenticationData(){return{session:this._session,type:this.type}}get type(){return"m.login.dummy"}}class TB extends M_{generateAuthenticationData(){return{session:this._session,type:this.type}}get type(){return"m.login.terms"}get privacyPolicy(){var e;return(e=this._params)==null?void 0:e.policies.privacy_policy}get termsOfService(){var e;return(e=this._params)==null?void 0:e.policies.terms_of_service}}class RB extends M_{constructor(e,t,r){super(e,t),this._type=r}generateAuthenticationData(){if(!this._token)throw new Error("No token provided for TokenAuth");return{session:this._session,type:this._type,token:this._token}}setToken(e){this._token=e}get type(){return this._type}}class CB{constructor(e,t,r,i){this.homeserver=e,this._hsApi=t,this._accountDetails=r,this._flowSelector=i??(s=>s[0])}async start(){const e=await this._hsApi.register(this._accountDetails.username,this._accountDetails.password,this._accountDetails.initialDeviceDisplayName,void 0,this._accountDetails.inhibitLogin).response();return this.parseStagesFromResponse(e)}async submitStage(e){const t=e.generateAuthenticationData(),{username:r,password:i,initialDeviceDisplayName:s,inhibitLogin:o}=this._accountDetails,a=this._hsApi.register(r,i,s,t,o),c=await a.response(),u=await a.responseCode(),l=OE(lo({},c),{status:u});return this.parseRegistrationResponse(l,e)}parseStagesFromResponse(e){const{session:t,params:r}=e,i=this._flowSelector(e.flows);if(!i)throw new Error("flowSelector did not return any flow!");let s,o;for(const a of i.stages){const c=this._createRegistrationStage(a,t,r);s?(o.setNextStage(c),o=c):(s=c,o=c)}return s}async parseRegistrationResponse(e,t){var r;switch(e.status){case 200:this._registerResponse=e;return;case 401:if((r=e.completed)!=null&&r.includes(t.type))return t.nextStage;throw new Error("This stage could not be completed!")}}_createRegistrationStage(e,t,r){switch(e){case"m.login.dummy":return new IB(t,r==null?void 0:r[e]);case"m.login.terms":return new TB(t,r==null?void 0:r[e]);case"org.matrix.msc3231.login.registration_token":case"m.login.registration_token":return new RB(t,r==null?void 0:r[e],e);default:throw new Error(`Unknown stage: ${e}`)}}get authData(){if(this._registerResponse)return{accessToken:this._registerResponse.access_token,homeserver:this.homeserver,userId:this._registerResponse.user_id,deviceId:this._registerResponse.device_id}}}const be=Po("NotLoading","Login","LoginFailed","QueryAccount","AccountSetup","Loading","SessionSetup","Migrating","FirstSync","Error","Ready"),Js=Po("Connection","Credentials","Unknown");class MB{constructor(e,t=new Xs(0),r={}){this._platform=e,this._sessionStartedByReconnector=!1,this._status=new hr(be.NotLoading),this._error=null,this._loginFailure=null,this._reconnector=null,this._session=null,this._sync=null,this._sessionId=null,this._storage=null,this._requestScheduler=null,this._olmPromise=e.loadOlm(),this._workerPromise=e.loadOlmWorker(),this._accountSetup=void 0,this._deviceName=(r==null?void 0:r.deviceName)||"Hydrogen",this._features=t}createNewSessionId(){return Math.floor(this._platform.random()*Number.MAX_SAFE_INTEGER).toString()}get sessionId(){return this._sessionId}async startWithExistingSession(e){this._status.get()===be.NotLoading&&(this._status.set(be.Loading),await this._platform.logger.run("load session",async t=>{t.set("id",e);try{const r=await this._platform.sessionInfoStorage.get(e);if(!r)throw new Error("Invalid session id: "+e);await this._loadSessionInfo(r,null,t),t.set("status",this._status.get())}catch(r){t.catch(r),this._error=r,this._status.set(be.Error)}}))}_parseLoginOptions(e,t){const r=e.flows,i={homeserver:t};for(const s of r)s.type==="m.login.password"?i.password=(o,a)=>new SB({homeserver:t,username:o,password:a}):s.type==="m.login.sso"&&r.find(o=>o.type==="m.login.token")?i.sso=new kB(t):s.type==="m.login.token"&&(i.token=o=>new EB({homeserver:t,loginToken:o}));return i}queryLogin(e){return new A0(async t=>{const{homeserver:r,issuer:i,account:s}=await j$(e,(c,u)=>t(this._platform.request(c,u)));if(i)try{const c=new zc({issuer:i,request:this._platform.request,encoding:this._platform.encoding,crypto:this._platform.crypto,staticClients:this._platform.config.staticOidcClients});await c.validate();const u=await c.isGuestAvailable();return{homeserver:r,oidc:{issuer:i,account:s,guestAvailable:u}}}catch(c){console.log(c)}const o=new Di({homeserver:r,request:this._platform.request}),a=await t(o.getLoginFlows()).response();return this._parseLoginOptions(a,r)})}async startRegistration(e,t,r,i,s){const o=this._platform.request,a=new Di({homeserver:e,request:o});return new CB(e,a,{username:t,password:r,initialDeviceDisplayName:i},s)}async startWithAuthData({accessToken:e,deviceId:t,userId:r,homeserver:i}){await this._platform.logger.run("startWithAuthData",async s=>{await this._createSessionAfterAuth({accessToken:e,deviceId:t,userId:r,homeserver:i},!0,s)})}async startWithLogin(e,{inspectAccountSetup:t}={}){const r=this._status.get();r!==be.LoginFailed&&r!==be.NotLoading&&r!==be.Error||(this._resetStatus(),await this._platform.logger.run("login",async i=>{this._status.set(be.Login),this._platform.clock;let s;try{const o=this._platform.request,a=new Di({homeserver:e.homeserver,request:o}),c=await e.login(a,this._deviceName,i),u=this.createNewSessionId();s={deviceId:c.device_id,userId:c.user_id,homeserver:e.homeserver,accessToken:c.access_token},c.refresh_token&&(s.refreshToken=c.refresh_token),c.expires_in&&(s.expiresIn=c.expires_in),c.id_token&&(s.idToken=c.id_token),c.oidc_issuer&&(s.oidcIssuer=c.oidc_issuer,s.oidcClientId=c.oidc_client_id,s.accountManagementUrl=c.oidc_account_management_url)}catch(o){this._error=o,o.name==="HomeServerError"?(o.errcode==="M_FORBIDDEN"?this._loginFailure=Js.Credentials:this._loginFailure=Js.Unknown,i.set("loginFailure",this._loginFailure),this._status.set(be.LoginFailed)):o.name==="ConnectionError"?(this._loginFailure=Js.Connection,this._status.set(be.LoginFailed)):this._status.set(be.Error);return}await this._createSessionAfterAuth(s,t,i)}))}async _createSessionAfterAuth({deviceId:e,userId:t,accessToken:r,refreshToken:i,homeserver:s,expiresIn:o,idToken:a,oidcIssuer:c,oidcClientId:u,accountManagementUrl:l},d,p){const m=this.createNewSessionId(),w=this._platform.clock.now(),S={id:m,deviceId:e,userId:t,homeServer:s,homeserver:s,accessToken:r,lastUsed:w,refreshToken:i,oidcIssuer:c,oidcClientId:u,accountManagementUrl:l,idToken:a};o&&(S.accessTokenExpiresAt=w+o*1e3);let v;d&&(v=await this._inspectAccountAfterLogin(S,p),v&&(S.deviceId=v.deviceId)),p.set("id",m),await this._platform.sessionInfoStorage.add(S);try{await this._loadSessionInfo(S,v,p),p.set("status",this._status.get())}catch(_){p.catch(_),v==null||v.dispose(),this._error=_,this._status.set(be.Error)}}async _loadSessionInfo(e,t,r){r.set("appVersion",this._platform.version);const i=this._platform.clock;this._sessionStartedByReconnector=!1,this._status.set(be.Loading),this._reconnector=new tL({onlineStatus:this._platform.onlineStatus,retryDelay:new N0(i.createTimeout),createMeasure:i.createMeasure});let s;if(e.oidcIssuer){const d=new zc({issuer:e.oidcIssuer,staticClients:this._platform.config.staticOidcClients,clientId:e.oidcClientId,request:this._platform.request,encoding:this._platform.encoding,crypto:this._platform.crypto});this._tokenRefresher=new eL({oidcApi:d,clock:this._platform.clock,accessToken:e.accessToken,accessTokenExpiresAt:e.accessTokenExpiresAt,refreshToken:e.refreshToken,anticipation:30*1e3}),this._tokenRefresher.token.subscribe(p=>{this._platform.sessionInfoStorage.updateToken(e.id,p.accessToken,p.accessTokenExpiresAt,p.refreshToken)}),await this._tokenRefresher.start(),s=this._tokenRefresher.accessToken}else s=new hr(e.accessToken);const o=new Di({homeserver:e.homeServer,accessToken:s,request:this._platform.request,reconnector:this._reconnector});this._sessionId=e.id,this._storage=await this._platform.storageFactory.create(e.id,r);const a={id:e.id,deviceId:e.deviceId,userId:e.userId,homeserver:e.homeServer};e.accountManagementUrl&&(a.accountManagementUrl=e.accountManagementUrl);const c=await this._olmPromise;let u=null;this._workerPromise&&(u=await this._workerPromise),this._requestScheduler=new oL({hsApi:o,clock:i}),this._requestScheduler.start();const l=new iL({homeserver:e.homeServer,platform:this._platform});if(this._session=new bB({storage:this._storage,sessionInfo:a,hsApi:this._requestScheduler.hsApi,olm:c,olmWorker:u,mediaRepository:l,platform:this._platform,features:this._features}),await this._session.load(r),t?(await r.wrap("dehydrateIdentity",d=>this._session.dehydrateIdentity(t,d)),await this._session.setupDehydratedDevice(t.key,r)):this._session.hasIdentity||(this._status.set(be.SessionSetup),await r.wrap("createIdentity",d=>this._session.createIdentity(d))),this._sync=new cL({hsApi:this._requestScheduler.hsApi,storage:this._storage,session:this._session,logger:this._platform.logger}),this._reconnectSubscription=this._reconnector.connectionStatus.subscribe(d=>{d===b_.Online&&this._platform.logger.runDetached("reconnect",async p=>{this._requestScheduler.start(),this._sync.start(),this._sessionStartedByReconnector=!0;const m=t;t=void 0,await p.wrap("session start",w=>this._session.start(this._reconnector.lastVersionsResponse,m,w))})}),await r.wrap("wait first sync",()=>this._waitForFirstSync()),!this._isDisposed&&(this._status.set(be.Ready),!this._sessionStartedByReconnector)){const d=await o.versions({timeout:1e4,log:r}).response();if(this._isDisposed)return;const p=t;t=void 0,await r.wrap("session start",m=>this._session.start(d,p,m))}}async _waitForFirstSync(){this._sync.start(),this._status.set(be.FirstSync),this._waitForFirstSyncHandle=this._sync.status.waitFor(e=>{var t;return e===ze.Stopped?((t=this._sync.error)==null?void 0:t.name)!=="ConnectionError":e===ze.Syncing});try{if(await this._waitForFirstSyncHandle.promise,this._sync.status.get()===ze.Stopped&&this._sync.error)throw this._sync.error}catch(e){if(e.name==="AbortError")return;throw e}finally{this._waitForFirstSyncHandle=null}}_inspectAccountAfterLogin(e,t){return t.wrap("inspectAccount",async r=>{var i;this._status.set(be.QueryAccount);const s=new Di({homeserver:e.homeServer,accessToken:e.accessToken,request:this._platform.request}),o=await this._olmPromise;let a;try{a=await IF(s,o,this._platform,r)}catch(c){if(c.name==="HomeServerError")r.set("not_supported",!0);else throw c}if(a){let c;const u=new Promise(d=>c=d);this._accountSetup=new xB(a,c),this._status.set(be.AccountSetup),await u;const l=(i=this._accountSetup)==null?void 0:i._dehydratedDevice;return this._accountSetup=null,l}})}get accountSetup(){return this._accountSetup}get loadStatus(){return this._status}get loadError(){return this._error}get loginFailure(){return this._loginFailure}get sync(){return this._sync}get session(){return this._session}get reconnector(){return this._reconnector}get _isDisposed(){return!this._reconnector}startLogout(e,t){return this._platform.logger.run("logout",async r=>{this._sessionId=e,r.set("id",this._sessionId);const i=await this._platform.sessionInfoStorage.get(this._sessionId);if(!i)throw new Error(`Could not find session for id ${this._sessionId}`);let s;try{if(i.oidcClientId){const o=new zc({issuer:i.oidcIssuer,staticClients:this._platform.config.staticOidcClients,clientId:i.oidcClientId,request:this._platform.request,encoding:this._platform.encoding,crypto:this._platform.crypto,urlRouter:t});await o.revokeToken({token:i.accessToken,type:"access"}),i.refreshToken&&await o.revokeToken({token:i.refreshToken,type:"refresh"}),s=await o.endSessionEndpoint({idTokenHint:i.idToken,logoutHint:i.userId})}else await new Di({homeserver:i.homeServer,accessToken:i.accessToken,request:this._platform.request}).logout({log:r}).response()}catch(o){console.error(o)}await this.deleteSession(r),s&&this._platform.openUrl(s)})}startForcedLogout(e){return this._platform.logger.run("forced-logout",async t=>{this._sessionId=e,t.set("id",this._sessionId),await this.deleteSession(t)})}dispose(){this._reconnectSubscription&&(this._reconnectSubscription(),this._reconnectSubscription=null),this._reconnector=null,this._requestScheduler&&(this._requestScheduler.stop(),this._requestScheduler=null),this._sync&&(this._sync.stop(),this._sync=null),this._tokenRefresher&&(this._tokenRefresher.stop(),this._tokenRefresher=null),this._session&&(this._session.dispose(),this._session=null),this._waitForFirstSyncHandle&&(this._waitForFirstSyncHandle.dispose(),this._waitForFirstSyncHandle=null),this._storage&&(this._storage.close(),this._storage=null)}async deleteSession(e){this._sessionId&&(this.dispose(),await Promise.all([e.wrap("storageFactory",()=>this._platform.storageFactory.delete(this._sessionId)),e.wrap("sessionInfoStorage",()=>this._platform.sessionInfoStorage.delete(this._sessionId))]),this._sessionId=null)}_resetStatus(){this._status.set(be.NotLoading),this._error=null,this._loginFailure=null}}class xB{constructor(e,t){this._encryptedDehydratedDevice=e,this._dehydratedDevice=void 0,this._finishStage=t}get encryptedDehydratedDevice(){return this._encryptedDehydratedDevice}finish(e){this._dehydratedDevice=e,this._finishStage()}}class AB{constructor({nonce:e,codeVerifier:t,code:r,homeserver:i,redirectUri:s,oidcApi:o,accountManagementUrl:a}){this._oidcApi=o,this._code=r,this._codeVerifier=t,this._nonce=e,this._redirectUri=s,this.homeserver=i,this._accountManagementUrl=a}async login(e,t,r){const{access_token:i,refresh_token:s,expires_in:o,id_token:a}=await this._oidcApi.completeAuthorizationCodeGrant({code:this._code,codeVerifier:this._codeVerifier,redirectUri:this._redirectUri}),{user_id:c,device_id:u}=await e.whoami({log:r,accessTokenOverride:i}).response(),l=this._oidcApi.issuer,d=await this._oidcApi.clientId();return{oidc_issuer:l,oidc_client_id:d,access_token:i,refresh_token:s,expires_in:o,id_token:a,user_id:c,device_id:u,oidc_account_management_url:this._accountManagementUrl}}}async function DB(n,e,t,r){const i=new Map;n.text&&i.set("text",n.text),i.set("user_agent",n.userAgent),i.set("app",n.app),i.set("version",n.version),n.label&&i.set("label",n.label),i.set("file",{name:"logs.json",blob:e});const s=new Map;s.set("Accept","application/json");const o=r(t,{method:"POST",body:i,headers:s});let a;try{a=await o.response()}catch(l){throw new Error(`Could not submit logs to ${t}, got error ${l.message}`)}const{status:c,body:u}=a;if(c<200||c>=300)throw new Error(`Could not submit logs to ${t}, got status code ${c} with body ${u}`)}async function NB(n,e){const{bugReportEndpointUrl:t}=e.config;if(!t)throw new Error("no server configured to submit logs");const i=e.logger.reporters.find(o=>!!o.export);if(!i)throw new Error("No logger that can export configured");const s=await i.export();await DB({app:"hydrogen",userAgent:e.description,version:e.version,text:`Submit logs from settings for user ${n.userId} on device ${n.deviceId}`},s.asBlob(),t,e.request)}class PB{constructor(e){this._observables=new Map,this._allowsChild=e,this._path=new or([],e),this._pathObservable=new hr(this._path)}get pathObservable(){return this._pathObservable}get path(){return this._path}push(e,...t){const r=this.path.with(new tw(e,...t));r&&this.applyPath(r)}applyPath(e){const t=this._path;this._path=e;for(let r=t.segments.length-1;r>=0;r-=1){const i=t.segments[r];if(!this._path.get(i.type)){const s=this._observables.get(i.type);s==null||s.emitIfChanged()}}for(const r of this._path.segments){const i=this._observables.get(r.type);i==null||i.emitIfChanged()}this._pathObservable.set(this._path)}observe(e){let t=this._observables.get(e);return t||(t=new UB(this,e),this._observables.set(e,t)),t}pathFrom(e){let t,r;for(r=0;r<e.length;r+=1){if(!this._allowsChild(t,e[r]))return new or(e.slice(0,r),this._allowsChild);t=e[r]}return new or(e,this._allowsChild)}segment(e,...t){return new tw(e,...t)}}function OB(n,e){if(n===e)return!0;if(Array.isArray(n)&&Array.isArray(e)){const t=Math.max(n.length,e.length);for(let r=0;r<t;r+=1)if(n[r]!==e[r])return!1;return!0}return!1}class tw{constructor(e,...t){this.type=e,this.value=t[0]===void 0?!0:t[0]}}class or{constructor(e=[],t){this._segments=e,this._allowsChild=t}clone(){return new or(this._segments.slice(),this._allowsChild)}with(e){let t=this._segments.length-1;do{if(this._allowsChild(this._segments[t],e)){const r=this._segments.slice(0,t+1);return r.push(e),new or(r,this._allowsChild)}t-=1}while(t>=-1)}until(e){const t=this._segments.findIndex(r=>r.type===e);return t!==-1?new or(this._segments.slice(0,t+1),this._allowsChild):new or([],this._allowsChild)}get(e){return this._segments.find(t=>t.type===e)}replace(e){const t=this._segments.findIndex(r=>r.type===e.type);if(t!==-1){const r=this._segments[t-1];if(this._allowsChild(r,e)){const i=this._segments[t+1];if(!i||this._allowsChild(e,i)){const s=this._segments.slice();return s[t]=e,new or(s,this._allowsChild)}}}}get segments(){return this._segments}}class UB extends vi{constructor(e,t){var r;super(),this._navigation=e,this._type=t,this._lastSetValue=(r=e.path.get(t))==null?void 0:r.value}get(){const t=this._navigation.path.get(this._type);return t==null?void 0:t.value}emitIfChanged(){const e=this.get();OB(e,this._lastSetValue)||(this._lastSetValue=e,this.emit(e))}}function ik(n){let e=n.charAt(0);return(e==="!"||e==="@"||e==="#")&&(e=n.charAt(1)),e.toUpperCase()}function $B(n){let e=0,t,r;if(n.length===0)return e;for(t=0;t<n.length;t++)r=n.charCodeAt(t),e=(e<<5)-e+r,e|=0;return Math.abs(e)}function sk(n){return $B(n)%8+1}function LB(n,e,t,r){if(n){const i=e*t.devicePixelRatio;return r.mxcUrlThumbnail(n,i,i,"crop")}}class vn{constructor(e,t,r,i){this._remove=e,this._update=t,this._replace=r,this._updateParams=i}get shouldReplace(){return this._replace}get shouldRemove(){return this._remove}get shouldUpdate(){return this._update}get updateParams(){return this._updateParams}static Remove(){return new vn(!0,!1,!1,null)}static Update(e){return new vn(!1,!0,!1,e)}static Nothing(){return new vn(!1,!1,!1,null)}static Replace(e){return new vn(!1,!1,!0,e)}}class FB extends Ao{constructor(e,t){super(),this._entries=e,this._tiles=null,this._entrySubscription=null,this._tileOptions=t,this._emitSpontanousUpdate=this._emitSpontanousUpdate.bind(this)}_createTile(e){const t=this._tileOptions.tileClassForEntry(e,this._tileOptions);if(t)return new t(e,this._tileOptions)}_emitSpontanousUpdate(e,t){const r=e.lowerEntry,i=this._findTileIdx(r);this.emitUpdate(i,e,t)}onSubscribeFirst(){this._entrySubscription=this._entries.subscribe(this),this._populateTiles()}_populateTiles(){this._silent=!0,this._tiles=[];let e=null;for(let r of this._entries)(!e||!e.tryIncludeEntry(r))&&(e=this._createTile(r),e&&this._tiles.push(e));let t=null;for(let r of this._tiles)t&&t.updateNextSibling(r),r.updatePreviousSibling(t),t=r;t&&t.updateNextSibling(null);for(let r=0;r<this._tiles.length;r+=1){const i=this._tiles[r];i.needsDateSeparator&&(this._addTileAt(r,i.createDateSeparator(),!0),r+=1)}for(const r of this._tiles)r.setUpdateEmit(this._emitSpontanousUpdate);this._silent=!1}_findTileIdx(e){return fr(this._tiles,e,(t,r)=>-r.compareEntry(t))}_findTileAtIdx(e,t){const r=this._getTileAtIdx(t);if(r&&r.compareEntry(e)===0)return r}_getTileAtIdx(e){return e>=0&&e<this._tiles.length?this._tiles[e]:null}onUnsubscribeLast(){this._entrySubscription=this._entrySubscription();for(let e=0;e<this._tiles.length;e+=1)this._tiles[e].dispose();this._tiles=null}onReset(){this._buildInitialTiles(),this.emitReset()}onAdd(e,t){const r=this._findTileIdx(t),i=this._getTileAtIdx(r-1);if(i&&i.tryIncludeEntry(t)){this.emitUpdate(r-1,i);return}const s=this._getTileAtIdx(r);if(s&&s.tryIncludeEntry(t)){this.emitUpdate(r,s);return}const o=this._createTile(t);o&&(this._addTileAt(r,o),this._evaluateDateHeaderAtIdx(r))}_evaluateDateHeaderAtIdx(e){for(let t=0;t<3;t+=1){const r=e+t;if(r>=this._tiles.length)break;const i=this._tiles[r],s=r>0?this._tiles[r-1]:void 0,o=(s==null?void 0:s.shape)===rt.DateHeader;i.needsDateSeparator&&!o?(e+=1,this._addTileAt(r,i.createDateSeparator())):!i.needsDateSeparator&&o&&this._removeTile(r-1,s)}}_addTileAt(e,t,r=!1){const i=e>0?this._tiles[e-1]:void 0,s=this._tiles[e];i==null||i.updateNextSibling(t),t.updatePreviousSibling(i),t.updateNextSibling(s),s==null||s.updatePreviousSibling(t),this._tiles.splice(e,0,t),r||this.emitAdd(e,t),t.setUpdateEmit(this._emitSpontanousUpdate)}onUpdate(e,t,r){if(!this._tiles)return;const i=this._findTileIdx(t),s=this._findTileAtIdx(t,i);if(s){const o=s.updateEntry(t,r);if(o.shouldReplace){const a=this._createTile(t);a?(this._replaceTile(i,s,a,o.updateParams),a.setUpdateEmit(this._emitSpontanousUpdate)):this._removeTile(i,s)}o.shouldRemove&&this._removeTile(i,s),o.shouldUpdate&&this.emitUpdate(i,s,o.updateParams)}}_replaceTile(e,t,r,i){t.dispose();const s=this._getTileAtIdx(e-1),o=this._getTileAtIdx(e+1);this._tiles[e]=r,s==null||s.updateNextSibling(r),r.updatePreviousSibling(s),r.updateNextSibling(o),o==null||o.updatePreviousSibling(r),this.emitUpdate(e,r,i)}_removeTile(e,t){const r=this._getTileAtIdx(e-1),i=this._getTileAtIdx(e+1);this._tiles.splice(e,1),t.dispose(),this.emitRemove(e,t),r==null||r.updateNextSibling(i),i==null||i.updatePreviousSibling(r),r&&r.shape===rt.DateHeader&&(!i||!i.needsDateSeparator)&&this._removeTile(e-1,r)}onRemove(e,t){const r=this._findTileIdx(t),i=this._findTileAtIdx(t,r);i&&(i.removeEntry(t)?this._removeTile(r,i):this.emitUpdate(r,i))}onMove(){}[Symbol.iterator](){return this._tiles.values()}get length(){return this._tiles.length}getFirst(){return this._tiles[0]}getTileIndex(e){const t=fr(this._tiles,e,(i,s)=>i.compare(s)),r=this._tiles[t];return(r==null?void 0:r.compare(e))===0?t:-1}sliceIterator(e,t){return this._tiles.slice(e,t)[Symbol.iterator]()}}class mK extends Dl{constructor(e){super(e);const{timeline:t,tileOptions:r}=e;this._timeline=this.track(t),this._tiles=new FB(t.entries,r),this._startTile=null,this._endTile=null,this._topLoadingPromise=null,this._requestedStartTile=null,this._requestedEndTile=null,this._requestScheduled=!1,this._showJumpDown=!1}setVisibleTileRange(e,t){this._requestedStartTile=e,this._requestedEndTile=t,this._requestScheduled||(Promise.resolve().then(()=>{this._setVisibleTileRange(this._requestedStartTile,this._requestedEndTile),this._requestScheduled=!1}),this._requestScheduled=!0)}_setVisibleTileRange(e,t){let r;if(e&&t){this._startTile=e,this._endTile=t;const i=this._tiles.getTileIndex(this._startTile),s=this._tiles.getTileIndex(this._endTile);for(const o of this._tiles.sliceIterator(i,s+1))o.notifyVisible();r=i<10,this._setShowJumpDown(s<this._tiles.length-1)}else r=!0,this._setShowJumpDown(!1);r&&!this._topLoadingPromise&&(this._topLoadingPromise=this._timeline.loadAtTop(10).then(i=>{this._topLoadingPromise=null,i||this.setVisibleTileRange(this._requestedStartTile,this._requestedEndTile)}))}get tiles(){return this._tiles}_setShowJumpDown(e){this._showJumpDown!==e&&(this._showJumpDown=e,this.emitChange("showJumpDown"))}get showJumpDown(){return this._showJumpDown}}class _K extends Dl{constructor(e){super(e.options),this._roomVM=e,this._isEmpty=!0,this._replyVM=null}setReplyingTo(e){var t;(new Boolean(e)!==new Boolean(this._replyVM)||!((t=this._replyVM)!=null&&t.id.equals(e.asEventKey())))&&(this._replyVM=this.disposeTracked(this._replyVM),e&&(this._replyVM=this.track(this._roomVM._createTile(e)),this._replyVM.notifyVisible()),this.emitChange("replyViewModel"),this.emit("focus"))}clearReplyingTo(){this.setReplyingTo(null)}get replyViewModel(){return this._replyVM}get isEncrypted(){return this._roomVM.isEncrypted}async sendMessage(e){const t=await this._roomVM._sendMessage(e,this._replyVM);return t&&(this._isEmpty=!0,this.emitChange("canSend"),this.clearReplyingTo()),t}sendPicture(){this._roomVM._pickAndSendPicture()}sendFile(){this._roomVM._pickAndSendFile()}sendVideo(){this._roomVM._pickAndSendVideo()}get canSend(){return!this._isEmpty}async setInput(e){const t=this._isEmpty;this._isEmpty=e.length===0,t&&!this._isEmpty&&this._roomVM._room.ensureMessageKeyIsShared(),t!==this._isEmpty&&this.emitChange("canSend")}get kind(){return"composer"}}class BB extends Dl{get message(){return this.error.message}get error(){return this.getOption("error")}close(){this.getOption("onClose")()}async submitLogs(){try{return await NB(this.getOption("session"),this.platform),!0}catch{return!1}}}class VB extends Dl{get errorViewModel(){return this._errorViewModel}reportError(e){var t;((t=this._errorViewModel)==null?void 0:t.error)!==e&&(this.disposeTracked(this._errorViewModel),this._errorViewModel=this.track(new BB(this.childOptions({error:e,onClose:()=>{this._errorViewModel=this.disposeTracked(this._errorViewModel),this.emitChange("errorViewModel")}}))),this.emitChange("errorViewModel"))}logAndCatch(e,t,r=void 0){try{let i=this.logger.run(e,t);return i instanceof Promise&&(i=i.catch(s=>(this.reportError(s),r))),i}catch(i){return this.reportError(i),r}}}class bs{constructor(e,t,r){this.userMedia=e,this.screenShare=t,this.dataChannelOptions=r}withUserMedia(e){var t;return new bs(e,(t=this.screenShare)==null?void 0:t.clone(),this.dataChannelOptions)}withScreenShare(e){var t;return new bs((t=this.userMedia)==null?void 0:t.clone(),e,this.dataChannelOptions)}withDataChannel(e){var t,r;return new bs((t=this.userMedia)==null?void 0:t.clone(),(r=this.screenShare)==null?void 0:r.clone(),e)}asPreview(){const e=this.clone(),t=e.userMedia;if(t&&t.getVideoTracks().length>0){const r=Ji(t);r&&(r.stop(),t.removeTrack(r))}return e}replaceClone(e,t){const r=(i,s,o)=>(i==null?void 0:i.id)===(o==null?void 0:o.id)?s:o==null?void 0:o.clone();return new bs(r(t==null?void 0:t.userMedia,e==null?void 0:e.userMedia,this.userMedia),r(t==null?void 0:t.screenShare,e==null?void 0:e.screenShare,this.screenShare),this.dataChannelOptions)}clone(){var e,t;return new bs((e=this.userMedia)==null?void 0:e.clone(),(t=this.screenShare)==null?void 0:t.clone(),this.dataChannelOptions)}dispose(){var e,t,r;(e=Ji(this.userMedia))==null||e.stop(),(t=Gr(this.userMedia))==null||t.stop(),(r=Gr(this.screenShare))==null||r.stop()}}class KB extends Dl{constructor(e,t){super(t),this._firstTileInDay=e}setUpdateEmit(e){this._emitUpdate=e}get upperEntry(){return this.refEntry}get lowerEntry(){return this.refEntry}get refEntry(){return this._firstTileInDay.lowerEntry}compare(e){return this.compareEntry(e.upperEntry)}get relativeDate(){return this._dateString||(this._dateString=this.timeFormatter.formatRelativeDate(new Date(this.refEntry.timestamp))),this._dateString}get machineReadableDate(){return this._machineReadableString||(this._machineReadableString=this.timeFormatter.formatMachineReadableDate(new Date(this.refEntry.timestamp))),this._machineReadableString}get shape(){return rt.DateHeader}get needsDateSeparator(){return!1}createDateSeparator(){}compareEntry(e){const t=this.refEntry.compare(e);return t===0?-1:t}updateEntry(e,t){return vn.Nothing()}removeEntry(e){return!1}tryIncludeEntry(){return!1}get comparisonIsNotCommutative(){return!0}updatePreviousSibling(e){this._firstTileInDay.updatePreviousSibling(e)}updateNextSibling(e){var t;if(!e)return;this._firstTileInDay=e;const r=this._dateString;this._dateString=void 0,this._machineReadableString=void 0,r&&r!==this.relativeDate&&((t=this._emitUpdate)==null||t.call(this,this,"relativeDate"))}notifyVisible(){}dispose(){}}class x_ extends VB{constructor(e,t){super(t),this._entry=e,this._date=this._entry.timestamp?new Date(this._entry.timestamp):void 0,this._needsDateSeparator=!1,this._emitUpdate=void 0}get shape(){return null}get isContinuation(){return!1}get needsDateSeparator(){return this._needsDateSeparator}createDateSeparator(){return new KB(this,this.childOptions({}))}_updateDateSeparator(e){e&&e._date&&this._date?this._needsDateSeparator=e._date.getFullYear()!==this._date.getFullYear()||e._date.getMonth()!==this._date.getMonth()||e._date.getDate()!==this._date.getDate():this._needsDateSeparator=!!this._date}get id(){return this._entry.asEventKey()}get eventId(){return this._entry.id}get isPending(){return this._entry.isPending}get isUnsent(){return this._entry.isPending&&this._entry.pendingEvent.status!==qe.Sent}get canAbortSending(){return this._entry.isPending&&!this._entry.pendingEvent.hasStartedSending}abortSending(){var e;(e=this._entry.pendingEvent)==null||e.abort()}setUpdateEmit(e){this._emitUpdate=e}emitChange(e){this._emitUpdate&&this._emitUpdate(this,e),super.emitChange(e)}get upperEntry(){return this._entry}get lowerEntry(){return this._entry}get comparisonIsNotCommutative(){return!1}compare(e){return e.comparisonIsNotCommutative?-e.compare(this):this.upperEntry.compare(e.upperEntry)}compareEntry(e){return this._entry.compare(e)}updateEntry(e,t){const r=this.shape==="redacted";return!e.isGap&&e.isRedacted!==r?vn.Replace("shape"):(this._entry=e,vn.Update(t))}removeEntry(){return!0}tryIncludeEntry(){return!1}updatePreviousSibling(e){(e==null?void 0:e.shape)!==rt.DateHeader&&this._updateDateSeparator(e)}updateNextSibling(){}notifyVisible(){}dispose(){this.setUpdateEmit(null),super.dispose()}get _room(){return this._roomVM.room}get _roomVM(){return this._options.roomVM}get _timeline(){return this._options.timeline}get _powerLevels(){return this._timeline.powerLevels}get _ownMember(){return this._options.timeline.me}get displayName(){return this._entry.displayName||this.sender}get sender(){return this._entry.sender}}class gK extends x_{constructor(e,t){super(e,t),this._loading=!1,this._waitingForConnection=!1,this._isAtTop=!0,this._siblingChanged=!1}get needsDateSeparator(){return!1}async fill(e=!1){if(!this._loading&&!this._entry.edgeReached){this._loading=!0,this.emitChange("isLoading");try{await this._room.fillGap(this._entry,10)}catch(t){return t instanceof dr?(await this._waitForReconnection(),e?!1:await this.fill(!0)):(this.reportError(t),!1)}finally{this._loading=!1,this.emitChange("isLoading")}return!0}return!1}async notifyVisible(){if(this.errorViewModel)return;let e=0,t;this._siblingChanged=!1;do t=await this.fill(),e=e+1;while(e<10&&!this._siblingChanged&&t&&!this.isDisposed)}get isAtTop(){return this._isAtTop}updatePreviousSibling(e){super.updatePreviousSibling(e);const t=!e;this._isAtTop!==t&&(this._isAtTop=t,this.emitChange("isAtTop")),this._siblingChanged=!0}updateNextSibling(){this._siblingChanged=!0}updateEntry(e,t){return super.updateEntry(e,t),e.isGap?vn.Nothing():vn.Remove()}async _waitForReconnection(){this._waitingForConnection=!0,this.emitUpdate("status"),await this.options.client.reconnector.connectionStatus.waitFor(e=>e===b_.Online).promise,this._waitingForConnection=!1,this.emitUpdate("status")}get shape(){return"gap"}get isLoading(){return this._loading}get showSpinner(){return this.isLoading||this._waitingForConnection}get status(){const e=this._entry.prev_batch?"previous":"next";return this._waitingForConnection?"Waiting for connection":this.errorViewModel?`Could not load ${e} messages`:this.isLoading?"Loading more messages":"Gave up loading more messages"}}class jB{constructor(e){this._parentTile=e,this._map=new pr,this._reactions=this._map.sortValues((t,r)=>t._compare(r))}update(e,t){if(e){for(const r in e)if(e.hasOwnProperty(r)){const i=e[r],s=this._map.get(r);s?s._tryUpdate(i)&&this._map.update(r):this._map.add(r,new nw(r,i,null,this._parentTile))}}if(t)for(const[r,i]of t.entries()){const s=this._map.get(r);s?(s._tryUpdatePending(i),this._map.update(r)):this._map.add(r,new nw(r,null,i,this._parentTile))}for(const r of this._map.keys()){const i=t==null?void 0:t.has(r),s=e==null?void 0:e.hasOwnProperty(r);!s&&!i?this._map.remove(r):s?i||this._map.get(r)._tryUpdatePending(null)&&this._map.update(r):this._map.get(r)._tryUpdate(null)&&this._map.update(r)}}get reactions(){return this._reactions}getReaction(e){return this._map.get(e)}}class nw{constructor(e,t,r,i){this._key=e,this._annotation=t,this._pending=r,this._parentTile=i,this._isToggling=!1}_tryUpdate(e){const t=!!this._annotation!=!!e,i=this._annotation&&e&&(e.me!==this._annotation.me||e.count!==this._annotation.count||e.firstTimestamp!==this._annotation.firstTimestamp);return t||i?(this._annotation=e,!0):!1}_tryUpdatePending(e){return!e&&!this._pending?!1:(this._pending=e,!0)}get key(){return this._key}get count(){var e,t;return(((e=this._pending)==null?void 0:e.count)||0)+(((t=this._annotation)==null?void 0:t.count)||0)}get isPending(){return this._pending!==null}get isActive(){var e;return((e=this._annotation)==null?void 0:e.me)||this.isPending}get firstTimestamp(){let e=Number.MAX_SAFE_INTEGER;return this._annotation&&(e=Math.min(e,this._annotation.firstTimestamp)),this._pending&&(e=Math.min(e,this._pending.firstTimestamp)),e}_compare(e){if(e===this)return 0;if(this.count!==e.count)return e.count-this.count;{const t=this.firstTimestamp-e.firstTimestamp;return t===0?this.key<e.key?-1:1:t}}async toggle(e=null){if(this._isToggling){console.log("busy toggling reaction already");return}this._isToggling=!0;try{await this._parentTile.toggleReaction(this.key,e)}finally{this._isToggling=!1}}}class Fd extends x_{constructor(e,t){super(e,t),this._isContinuation=!1,this._reactions=null,this._replyTile=null,(this._entry.annotations||this._entry.pendingAnnotations)&&this._updateReactions(),this._updateReplyTileIfNeeded(void 0)}notifyVisible(){var e;super.notifyVisible(),(e=this._replyTile)==null||e.notifyVisible()}get _mediaRepository(){return this._room.mediaRepository}get permaLink(){return`https://matrix.to/#/${encodeURIComponent(this._room.id)}/${encodeURIComponent(this._entry.id)}`}copyPermalink(){this.platform.copyPlaintext(this.permaLink)}get senderProfileLink(){return`https://matrix.to/#/${encodeURIComponent(this.sender)}`}get memberPanelLink(){return`${this.urlRouter.urlUntilSegment("room")}/member/${this.sender}`}get avatarColorNumber(){return sk(this._entry.sender)}avatarUrl(e){return LB(this._entry.avatarUrl,e,this.platform,this._mediaRepository)}get avatarLetter(){return ik(this.sender)}get avatarTitle(){return this.sender}get time(){return this._date&&this.timeFormatter.formatTime(this._date)}get isOwn(){return this._entry.sender===this._ownMember.userId}get isContinuation(){return this._isContinuation}get isUnverified(){return this._entry.isUnverified}get isReply(){return this._entry.isReply}_getContent(){return this._entry.content}updatePreviousSibling(e){super.updatePreviousSibling(e);let t=!1;if(e&&e instanceof Fd&&e.sender===this.sender){const r=this._entry.timestamp,i=e._entry.timestamp;t=r-i<5*60*1e3}t!==this._isContinuation&&(this._isContinuation=t,this.emitChange("isContinuation"))}updateEntry(e,t){const r=super.updateEntry(e,t);return r.shouldUpdate&&this._updateReactions(),this._updateReplyTileIfNeeded(t),r}_updateReplyTileIfNeeded(e){var t,r;const i=this._entry.contextEntry;if(i){const s=(t=this._replyTile)==null?void 0:t.updateEntry(i,e);if(s!=null&&s.shouldReplace||!this._replyTile){this.disposeTracked(this._replyTile);const o=this._options.tileClassForEntry,a=o(i,this._options);a&&(this._replyTile=new a(i,this._options))}s!=null&&s.shouldUpdate&&((r=this._replyTile)==null||r.emitChange())}}startReply(){this._roomVM.startReply(this._entry)}createReplyContent(e,t){return this._entry.createReplyContent(e,t)}redact(e,t){return this._room.sendRedaction(this._entry.id,e,t)}get canRedact(){return this._powerLevels.canRedactFromSender(this._entry.sender)}get reactions(){return this.shape!=="redacted"?this._reactions:null}get canReact(){return this._powerLevels.canSendType("m.reaction")}react(e,t=null){return this.logger.wrapOrRun(t,"react",async r=>{var i,s;if(!this.canReact){r.set("powerlevel_lacking",!0);return}if(this._entry.haveAnnotation(e)){r.set("already_reacted",!0);return}const o=(s=(i=this._entry.pendingAnnotations)==null?void 0:i.get(e))==null?void 0:s.redactionEntry;o&&!o.pendingEvent.hasStartedSending?(r.set("abort_redaction",!0),await o.pendingEvent.abort()):await this._room.sendEvent("m.reaction",this._entry.annotate(e),null,r)})}redactReaction(e,t=null){return this.logger.wrapOrRun(t,"redactReaction",async r=>{var i,s;if(!this._powerLevels.canRedactFromSender(this._ownMember.userId)){r.set("powerlevel_lacking",!0);return}if(!this._entry.haveAnnotation(e)){r.set("not_yet_reacted",!0);return}let o=(s=(i=this._entry.pendingAnnotations)==null?void 0:i.get(e))==null?void 0:s.annotationEntry;o||(o=await this._timeline.getOwnAnnotationEntry(this._entry.id,e)),o?await this._room.sendRedaction(o.id,null,r):r.set("no_reaction",!0)})}toggleReaction(e,t=null){return this.logger.wrapOrRun(t,"toggleReaction",async r=>{this._entry.haveAnnotation(e)?await this.redactReaction(e,r):await this.react(e,r)})}_updateReactions(){const{annotations:e,pendingAnnotations:t}=this._entry;!e&&!t?this._reactions&&(this._reactions=null):(this._reactions||(this._reactions=new jB(this)),this._reactions.update(e,t))}get replyTile(){return this._entry.contextEventId?this._replyTile:null}}const HB="(?:https|http|ftp):\\/\\/",ok="[^\\s.,?!)]",rw="[a-zA-Z0-9:.\\[\\]-]",zB=`${rw}*(?=${rw})${ok}`,GB=`(?:[\\/#](?:[^\\s]*${ok})?)`,qB=`${HB}${zB}${GB}?`,WB=new RegExp(qB,"gi");function ak(n,e){const t=n.matchAll(WB);let r=0;for(let s of t){const o=n.slice(r,s.index);e(o,!1),e(s[0],!0);const a=s[0].length;r=s.index+a}const i=n.slice(r);e(i,!1)}function YB(n){const e=[],t=n.split(`
`),r=(i,s)=>{s?e.push(new bp(i,[new po(i)])):e.push(new po(i))};for(let i=0;i<t.length;i+=1){const s=t[i];s.length&&ak(s,r),i>=t.length-1||e.push(new lk)}return new A_(n,e)}function XB(n){return new A_(n,[new po(n)])}class JB{constructor(e,t){this.level=e,this.inlines=t}get type(){return"header"}}class iw{constructor(e,t){this.language=e,this.text=t}get type(){return"codeblock"}}class QB{constructor(e,t){this.items=t,this.startOffset=e}get type(){return"list"}}class ZB{constructor(e,t){this.head=e,this.body=t}get type(){return"table"}}class eV{get type(){return"rule"}}class lk{get type(){return"newline"}}class Rc{constructor(e,t){this.format=e.toLowerCase(),this.children=t}get type(){return"format"}}class tV{constructor(e,t,r,i,s){this.src=e,this.width=t,this.height=r,this.alt=i,this.title=s}get type(){return"image"}}class nV{constructor(e,t,r){this.id=e,this.href=t,this.children=r}get type(){return"pill"}get avatarColorNumber(){return sk(this.id)}get avatarInitials(){return ik(this.id)}}class bp{constructor(e,t){this.url=e,this.inlines=t}get type(){return"link"}}class po{constructor(e){this.text=e}get type(){return"text"}}function rV(n){return n.type==="format"&&n.format==="blockquote"}class A_{constructor(e,t){this.sourceString=e,this.parts=t}insertEmote(e){let t=0;for(;t<this.parts.length&&rV(this.parts[t]);t++);this.parts.splice(t,0,new po(e))}}const Sa=Po("Plain","Html");class ck extends Fd{constructor(e,t){super(e,t),this._messageBody=null,this._format=null}get shape(){return"message"}_parseBody(e){return XB(e)}_getBodyFormat(){return Sa.Plain}get body(){const e=this._getBody(),t=this._getBodyFormat();return(!this._messageBody||this._messageBody.sourceString!==e||this._format!==t)&&(this._messageBody=this._parseBody(e,t),this._format=t),this._messageBody}}const iV=["EM","STRONG","CODE","DEL","SPAN"],sV=["DIV","BLOCKQUOTE"],oV=["https","http","ftp","mailto","magnet"].map(n=>`${n}://`),aV="https://matrix.to",sw=`${aV}/#/`;class lV{constructor(e,t){this.result=e,this.mediaRepository=t}parsePillLink(e){if(!e.startsWith(sw))return null;const t=e.substring(sw.length);return t[0]==="@"?t:null}parseLink(e,t){const r=this.result.getAttributeValue(e,"href"),i=r==null?void 0:r.toLowerCase();if(!i||!oV.some(o=>i.startsWith(o)))return new Rc("span",t);const s=this.parsePillLink(r);return s?new nV(s,r,t):new bp(r,t)}parseList(e){const t=this.result;let r=null;t.getNodeElementName(e)==="OL"&&(r=parseInt(t.getAttributeValue(e,"start"))||1);const i=[];for(const s of t.getChildNodes(e)){if(t.getNodeElementName(s)!=="LI")continue;const o=this.parseAnyNodes(t.getChildNodes(s));i.push(o)}return new QB(r,i)}_ensureElement(e,t){return e&&this.result.isElementNode(e)&&this.result.getNodeElementName(e)===t}parseCodeBlock(e){const t=this.result;let r;for(const o of t.getChildNodes(e)){r=o;break}let i=null;if(!this._ensureElement(r,"CODE"))return new iw(i,this.result.getNodeText(e));const s=t.getAttributeValue(r,"class")||"";for(const o of s.split(" "))if(o.startsWith("language-")&&!o.startsWith("language-_")){i=o.substring(9);break}return new iw(i,this.result.getNodeText(r))}parseImage(e){const t=this.result,r=t.getAttributeValue(e,"src")||"",i=this.mediaRepository.mxcUrl(r);if(!i)return null;const s=parseInt(t.getAttributeValue(e,"width"))||null,o=parseInt(t.getAttributeValue(e,"height"))||null,a=t.getAttributeValue(e,"alt"),c=t.getAttributeValue(e,"title");return new tV(i,s,o,a,c)}parseTableRow(e,t){const r=[];for(const i of this.result.getChildNodes(e)){if(!this._ensureElement(i,t))continue;const s=this.result.getChildNodes(i),o=this.parseInlineNodes(s);r.push(o)}return r}parseTableHead(e){let t=null;for(const r of this.result.getChildNodes(e)){t=r;break}return this._ensureElement(t,"TR")?this.parseTableRow(t,"TH"):null}parseTableBody(e){const t=[];for(const r of this.result.getChildNodes(e))this._ensureElement(r,"TR")&&t.push(this.parseTableRow(r,"TD"));return t}parseTable(e){const t=Array.from(this.result.getChildNodes(e));let r,i;return this._ensureElement(t[0],"THEAD")&&this._ensureElement(t[1],"TBODY")?(r=this.parseTableHead(t[0]),i=this.parseTableBody(t[1])):this._ensureElement(t[0],"TBODY")&&(r=null,i=this.parseTableBody(t[0])),new ZB(r,i)}parseInlineElement(e){const t=this.result,r=t.getNodeElementName(e),i=t.getChildNodes(e);switch(r){case"A":{const s=this.parseInlineNodes(i);return this.parseLink(e,s)}case"BR":return new lk;default:{if(!iV.includes(r))return null;const s=this.parseInlineNodes(i);return new Rc(r,s)}}}parseInlineNode(e){return this.result.isElementNode(e)?this.parseInlineElement(e):null}parseBlockElement(e){const t=this.result,r=t.getNodeElementName(e),i=t.getChildNodes(e);switch(r){case"H1":case"H2":case"H3":case"H4":case"H5":case"H6":{const s=this.parseInlineNodes(i);return new JB(parseInt(r[1]),s)}case"UL":case"OL":return this.parseList(e);case"PRE":return this.parseCodeBlock(e);case"HR":return new eV;case"IMG":return this.parseImage(e);case"P":{const s=this.parseInlineNodes(i);return new Rc(r,s)}case"TABLE":return this.parseTable(e);default:{if(!sV.includes(r))return null;const s=this.parseAnyNodes(i);return new Rc(r,s)}}}parseBlockNode(e){return this.result.isElementNode(e)?this.parseBlockElement(e):null}_parseTextParts(e,t){if(!this.result.isTextNode(e))return!1;const r=(i,s)=>{s?t.push(new bp(i,[new po(i)])):t.push(new po(i))};return ak(this.result.getNodeText(e),r),!0}_isAllowedNode(e){return!this._ensureElement(e,"MX-REPLY")}_parseInlineNodes(e,t){for(const r of e){if(this._parseTextParts(r,t))continue;const i=this.parseInlineNode(r);if(i){t.push(i);continue}this._isAllowedNode(r)&&this._parseInlineNodes(this.result.getChildNodes(r),t)}}parseInlineNodes(e){const t=[];return this._parseInlineNodes(e,t),t}_parseAnyNodes(e,t){for(const r of e){if(this._parseTextParts(r,t))continue;const i=this.parseInlineNode(r)||this.parseBlockNode(r);if(i){t.push(i);continue}this._isAllowedNode(r)&&this._parseAnyNodes(this.result.getChildNodes(r),t)}}parseAnyNodes(e){const t=[];return this._parseAnyNodes(e,t),t}}function cV(n,e,t){const r=n.parseHTML(t),s=new lV(r,e).parseAnyNodes(r.rootNodes);return new A_(t,s)}class yK extends ck{_getContentString(e){var t;return((t=this._getContent())==null?void 0:t[e])||""}_getPlainBody(){return this._getContentString("body")}_getFormattedBody(){return this._getContentString("formatted_body")}_getBody(){return this._getBodyFormat()===Sa.Html?this._getFormattedBody():this._getPlainBody()}_getBodyFormat(){var e;return((e=this._getContent())==null?void 0:e.format)==="org.matrix.custom.html"?Sa.Html:Sa.Plain}_parseBody(e,t){var r;let i;return t===Sa.Html?i=cV(this.platform,this._mediaRepository,e):i=YB(e),((r=this._getContent())==null?void 0:r.msgtype)==="m.emote"&&i.insertEmote(`* ${this.displayName} `),i}}const uV=300,dV=400;class hV extends Fd{constructor(e,t){super(e,t),this._decryptedThumbnail=null,this._decryptedFile=null,this._isVisible=!1,this._error=null,this._downloading=!1,this._downloadError=null}async downloadMedia(){if(this._downloading||this.isPending)return;const e=this._getContent(),t=e.body;this._downloading=!0,this.emitChange("status");let r;try{r=await this._mediaRepository.downloadAttachment(e),this.platform.saveFileAs(r,t)}catch(i){this._downloadError=i}finally{r==null||r.dispose(),this._downloading=!1}this.emitChange("status")}get isUploading(){return this.isPending&&this._entry.pendingEvent.status===qe.UploadingAttachments}get uploadPercentage(){const{pendingEvent:e}=this._entry;return e&&Math.round(e.attachmentsSentBytes/e.attachmentsTotalBytes*100)}get status(){const{pendingEvent:e}=this._entry;switch(e==null?void 0:e.status){case qe.Waiting:return this.i18n`Waiting`;case qe.EncryptingAttachments:case qe.Encrypting:return this.i18n`Encrypting`;case qe.UploadingAttachments:return this.i18n`Uploading`;case qe.Sending:return this.i18n`Sending`;case qe.Error:return this.i18n`Error: ${e.error.message}`;default:return this._downloadError?"Download failed":this._downloading?this.i18n`Downloading`:""}}get thumbnailUrl(){var e,t;if(!this._isVisible)return"";if(this._decryptedThumbnail)return this._decryptedThumbnail.url;{const r=(e=this._getContent().info)==null?void 0:e.thumbnail_url;if(r)return this._mediaRepository.mxcUrlThumbnail(r,this.width,this.height,"scale")}if(this._entry.isPending){const r=this._entry.pendingEvent.getAttachment("info.thumbnail_url");return r&&r.localPreview.url}if(this._isMainResourceImage()){if(this._decryptedFile)return this._decryptedFile.url;{const r=(t=this._getContent())==null?void 0:t.url;if(typeof r=="string")return this._mediaRepository.mxcUrlThumbnail(r,this.width,this.height,"scale")}}return""}notifyVisible(){super.notifyVisible(),this._isVisible=!0,this.emitChange("thumbnailUrl"),this.isPending||this._tryLoadEncryptedThumbnail()}get width(){var e;const t=(e=this._getContent())==null?void 0:e.info;return Math.round((t==null?void 0:t.w)*this._scaleFactor())}get height(){var e;const t=(e=this._getContent())==null?void 0:e.info;return Math.round((t==null?void 0:t.h)*this._scaleFactor())}get mimeType(){var e;const t=(e=this._getContent())==null?void 0:e.info;return t==null?void 0:t.mimetype}get label(){return this._getContent().body}get error(){return this._error?`Could not load media: ${this._error.message}`:null}setViewError(e){this._error=e,this.emitChange("error")}async _loadEncryptedFile(e){const t=await this._mediaRepository.downloadEncryptedFile(e,!0);if(this.isDisposed){t.dispose();return}return this.track(t)}async _tryLoadEncryptedThumbnail(){var e;try{const t=(e=this._getContent().info)==null?void 0:e.thumbnail_file,r=this._getContent().file;t?(this._decryptedThumbnail=await this._loadEncryptedFile(t),this.emitChange("thumbnailUrl")):r&&this._isMainResourceImage()&&(this._decryptedFile=await this._loadEncryptedFile(r),this.emitChange("thumbnailUrl"))}catch(t){this._error=t,this.emitChange("error")}}_scaleFactor(){var e;const t=(e=this._getContent())==null?void 0:e.info,r=uV/(t==null?void 0:t.h),i=dV/(t==null?void 0:t.w);return Math.min(i,r,1)}_isMainResourceImage(){return!0}}class vK extends hV{constructor(e,t){super(e,t),this._lightboxUrl=this.urlRouter.urlForSegments([this.navigation.segment("room",this._room.id),this.navigation.segment("lightbox",this._entry.id)])}get lightboxUrl(){return this.isPending?"":this._lightboxUrl}get shape(){return"image"}}class wK extends x_{get shape(){return"announcement"}get announcement(){var e,t;const{sender:r,content:i,prevContent:s,stateKey:o}=this._entry,a=this._entry.displayName||r,c=r===o?a:((e=this._entry.content)==null?void 0:e.displayname)||o,u=i&&i.membership,l=s&&s.membership;if(l==="join"&&u==="join"){if(i.avatar_url!==s.avatar_url)return`${a} changed their avatar`;if(i.displayname!==s.displayname)return i.displayname?`${(t=s.displayname)!=null?t:o} changed their name to ${i.displayname}`:`${o} removed their name (${s.displayname})`}else{if(u==="join")return`${c} joined the room`;if(u==="invite")return`${c} was invited to the room by ${a}`;if(l==="invite"){if(u==="join")return`${c} accepted the invitation to join the room`;if(u==="leave")return`${c} declined the invitation to join the room`}else if(u==="leave"){if(o===r)return`${c} left the room`;{const d=i.reason;return`${c} was kicked from the room by ${a}${d?`: ${d}`:""}`}}else if(u==="ban")return`${c} was banned from the room by ${a}`}return`${r} membership changed to ${i.membership}`}}class bK extends ck{updateEntry(e,t){const r=super.updateEntry(e,t);return e.eventType!=="m.room.encrypted"?vn.Replace("shape"):r}get shape(){return"message-status"}_getBody(){const e=this._entry.decryptionError,t=e==null?void 0:e.code;let r;return t==="MEGOLM_NO_SESSION"?r=this.i18n`The sender hasn't sent us the key for this message yet.`:r=(e==null?void 0:e.message)||this.i18n`Could not decrypt message because of unknown reason.`,r}}Po("Disconnected","Connecting","FirstSync","Sending","Syncing","SyncError");const fV="/assets/download-sandbox-48a866e9.html",pV="/assets/main-bdb9a925.js",mV="/assets/olm-82e831ad.wasm",_V="/assets/olm-bed41b9d.js",gV="/assets/olm_legacy-086c8bde.js";var uk={exports:{}};/*!
  Copyright (c) 2018 Jed Watson.
  Licensed under the MIT License (MIT), see
  http://jedwatson.github.io/classnames
*/(function(n){(function(){var e={}.hasOwnProperty;function t(){for(var r=[],i=0;i<arguments.length;i++){var s=arguments[i];if(s){var o=typeof s;if(o==="string"||o==="number")r.push(s);else if(Array.isArray(s)){if(s.length){var a=t.apply(null,s);a&&r.push(a)}}else if(o==="object")if(s.toString===Object.prototype.toString)for(var c in s)e.call(s,c)&&s[c]&&r.push(c);else r.push(s.toString())}}return r.join(" ")}n.exports?(t.default=t,n.exports=t):window.classNames=t})()})(uk);var yV=uk.exports;const Pl=mo(yV);function yl({id:n,className:e,style:t,variant:r="b1",color:i="surface",weight:s="regular",type:o,htmlFor:a,children:c}){const u=Pl(`Text Text-${r} Text--${i} Text--${s}`,e),l={id:n,className:u,style:t,htmlFor:a};return o==="span"?V("span",{...l,children:c}):o==="label"?V("label",{...l,children:c}):o==="div"?V("div",{...l,children:c}):r==="h1"?V("h1",{...l,children:c}):r==="h2"?V("h2",{...l,children:c}):r==="s1"?V("h4",{...l,children:c}):V("p",{...l,children:c})}const dk=R.createContext(void 0),vV=dk.Provider;function SK(n=!1){const e=R.useContext(dk);if(!e)throw new Error("HydrogenContext not initialized");if(n&&!e.session)throw new Error("Must be authenticated to access authenticated hydrogen context");return e}function Gh(n,e){const[t,r]=R.useState({loading:!1,error:void 0,value:void 0});return{callback:R.useCallback(async(...s)=>{r({loading:!0,error:void 0,value:void 0});let o;try{o=await n(...s),r({loading:!1,error:void 0,value:o})}catch(a){r({loading:!1,error:a,value:void 0})}return o},e),...t}}function wV({className:n,color:e="surface",size:t="md",paused:r=!1}){return V("div",{className:Pl("Dots",`Dots--${e}`,`Dots--${t}`,{"Dots--paused":r},n),children:V("span",{})})}function Bd({className:n,children:e}){return V("div",{className:Pl("CoverScreen flex flex-column justify-center items-center",n),children:e})}function Sp({className:n,message:e}){return Br(Bd,{className:Pl("gap-md",n),children:[V(wV,{size:"lg"}),V(yl,{variant:"b3",weight:"semi-bold",children:e||"Loading"})]})}function hk({className:n,style:e,variant:t="primary",fill:r="solid",size:i="md",type:s="button",onClick:o,children:a,disabled:c=!1,id:u}){const l=Pl(`Button Button--${t} Button--${r} Button--${i}`,n),d=r==="solid"?`on-${t}`:t;let p;const m=(w,S)=>V(yl,{variant:i==="xs"?"b3":"b2",color:d,weight:"semi-bold",children:w},S);return typeof a=="string"?p=m(a):Array.isArray(a)?p=a.map((w,S)=>typeof w=="string"?m(w,S):w):p=a,V("button",{id:u,className:l,style:e,type:s,onClick:o,disabled:c,children:p})}const bV="/_matrix/client/r0";function EK(n){return n.slice(n.indexOf(":")+1)}function SV(n){return n.slice(1,n.indexOf(":"))}async function EV(n,e){const t=`${bV}/directory/room/${encodeURIComponent(e)}`;try{const i=await(await fetch(`${n}${t}`,{method:"GET",headers:{"Content-Type":"application/json; charset=utf-8"},credentials:"same-origin"})).json();return i.room_id?{roomId:i.room_id,servers:i.servers}:i}catch{return{errcode:"ERROR",error:"Failed to resolve"}}}async function kK(n,e){const t=await EV(n,e);return(t==null?void 0:t.errcode)==="M_NOT_FOUND"}function IK(n,e){for(const t of n.values())if(t.canonicalAlias===e)return t.id}function TK(n,e){var t;return((t=n.get(e))==null?void 0:t.canonicalAlias)??void 0}function ow(n){const e="org.matrix.msc3815.profile";for(const t of n.values())if(t.type===e)return t}async function RK(n,e){if(!e.match(/^@\S+:\S+$/))return!1;try{return await n.profile(e).response(),!0}catch{return!1}}function CK(n){return n.match(/^!\S+:\S+$/)!==null}async function kV(n,e){return new Promise(t=>{const r=e.disposableOn("change",()=>{if(r(),!e.roomId)return t(void 0);const i=n.rooms.get(e.roomId);t(i)})})}async function MK(n,e,t,r){const i=await n.uploadAttachment(e,e.nativeBlob.name,{uploadProgress:c=>{r==null||r(c,e.size)}});t==null||t(i);const{content_uri:s,errcode:o,error:a}=await i.response();if(o)throw new Error(a??"Error Uploading file.");return s}const IV={u:"@",user:"@",r:"#",room:"#",roomid:"!"};function xK(n){const e=new URL(n,window.location.href);if(e.protocol==="matrix:"){const t=e.pathname.match(/^(\/\/.+\/)?(.+)$/);let r,i;if(t&&(t.length==3?(r=t[1],i=t[2]):t.length===2&&(i=t[1])),!i)throw new Error(`Invalid matrix uri "${n}": No path provided`);const s=i.split("/");if(s.length!==2&&s.length!==4)throw new Error(`Invalid matrix uri "${n}": Invalid number of segments`);const o=IV[s[0]];if(!o)throw new Error(`Invalid matrix uri "${n}": Invalid segment ${s[0]}`);if(!s[1])throw new Error(`Invalid matrix uri "${n}": Empty segment`);const a=`${o}${s[1]}`;let c;if(s.length===4)if((o==="!"||o==="#")&&(s[2]==="e"||s[2]==="event")&&s[3])c=`$${s[3]}`;else throw new Error(`Invalid matrix uri "${n}": Invalid segment ${s[2]}`);return{protocol:"matrix:",authority:r,mxid1:a,mxid2:c}}return e}function AK(n){return n instanceof URL?n.href:n.mxid1}function DK(n,e){if(!e)return;const t=Array.from(n).flatMap(([r,i])=>i.roomId===e?i:[]);return t.length?t[0]:void 0}function NK(n,e){const t=n.content.order,r=e.content.order;if(t===void 0&&r===void 0){const i=n.origin_server_ts,s=e.origin_server_ts;return i===s?0:i>s?-1:1}return t===void 0?1:r===void 0||t<r?-1:1}async function PK(n,e,t,r){const i=await n.hsApi.state(e,"m.room.power_levels","").response();await n.hsApi.sendState(e,"m.room.power_levels","",{...i,users:{...i.users,[t]:r}}).response()}function TV(){const n=R.useRef(!1);return R.useEffect(()=>(n.current=!0,()=>{n.current=!1}),[]),R.useCallback(()=>n.current,[])}const qh=EE({userId:"@dummy:server.xyz",displayName:"dummy",avatarUrl:void 0}),RV=EE(n=>n(qh),(n,e,t)=>{const{userId:r,displayName:i,avatarUrl:s}=n(qh);r===t.userId&&s===t.avatarUrl&&i===t.displayName||e(qh,t)});function CV(n,e){const t=RE(RV),r=TV(),[i,s]=R.useState(),o=R.useCallback((l,d,p)=>{t({userId:l,displayName:d||SV(l),avatarUrl:p})},[t]),a=R.useCallback(l=>{l.hsApi.profile(l.userId).response().then(d=>{r()&&o(l.userId,d.displayname,d.avatar_url)}).catch(()=>{})},[r,o]),c=R.useCallback(async(l,d)=>{s(d);const p=await d.observeMember(l.userId),m=p==null?void 0:p.subscribe(w=>{w.membership!=="join"&&(m==null||m());const{avatarUrl:S,displayName:v}=w;o(l.userId,S,v)})},[o,s]),u=R.useCallback(async l=>{const d=ow(l.rooms);if(d)c(l,d);else{const p=l.createRoom({type:Lu.Profile,visibility:Fn.Private,name:"Third Room - Profile",topic:"This room contain profile information.",isEncrypted:!1,isFederationDisabled:!1,powerLevelContentOverride:{invite:100,kick:100,ban:100,redact:100,state_default:100,events_default:100,users_default:0,users:{[l.userId]:100}}}),m=await kV(l,p);if(!m){window.setTimeout(()=>window.location.reload());return}c(l,m)}},[c]);return R.useEffect(()=>{let l;const{sync:d}=n;if(!e){s(void 0);return}if(o(e.userId),a(e),d.status.get()==="Syncing"||ow(e.rooms))u(e);else{let p=d.status.get();l=d.status.subscribe(m=>{p!==m&&(p=m,m==="Syncing"&&(u(e),l==null||l()))})}return()=>{l==null||l(),o("@dummy:server.xyz")}},[n,e,o,a,u]),i}function aw(n,e){const t=window;return t.thirdroom||(t.thirdroom={}),t.thirdroom[n]=e,()=>{t.thirdroom&&(t.thirdroom[n]=()=>{})}}function MV(n,e){const t=window;return t.thirdroom||(t.thirdroom={}),t.thirdroom[n]=e,()=>{t.thirdroom&&(t.thirdroom[n]=void 0)}}function xV(n,e,t){const r=new Blob([n],{type:t}),i=document.createElement("a");i.style.display="none",document.body.appendChild(i),i.href=URL.createObjectURL(r),i.download=e,i.click(),document.body.removeChild(i)}const AV="matrix-prod.svgun.ru",DV=["matrix-prod.svgun.ru","thirdroom.io","matrix.org"],NV=1,PV=1,OV="https://element.io/bugreports/submit",UV="#repository-room:matrix-prod.svgun.ru",$V={"https://id.thirdroom.io/realms/thirdroom/":{client_id:"thirdroom",guestKeycloakIdpHint:"guest"}},LV={defaultHomeServer:AV,homeserverList:DV,onboardingVersion:NV,whatsNewVersion:PV,bugReportEndpointUrl:OV,repositoryRoomIdOrAlias:UV,staticOidcClients:$V};function FV(n,e){const t=n.type;return t===void 0?["session","login"].includes(e.type):t==="session"?["left-panel"].includes(e.type):t==="left-panel"?["room"].includes(e.type):!1}class BV{attach(){}dispose(){}pushUrl(e){}tryRestoreLastUrl(){return!1}urlForSegments(e){return""}urlForSegment(e,t){return""}urlUntilSegment(e){return""}urlForPath(e){return""}openRoomActionUrl(e){return""}createSSOCallbackURL(){return""}createOIDCRedirectURL(){return window.location.origin}absoluteAppUrl(){return window.location.origin}absoluteUrlForAsset(e){return new URL("/assets/"+e,window.location.origin).toString()}normalizeUrl(){}}let la;function VV(){if(la)return la;const n=document.createElement("div");n.id="hydrogen-root",document.body.append(n);const e={downloadSandbox:fV,worker:pV,olm:{wasm:mV,legacyBundle:gV,wasmBundle:_V}},t=document.location.hostname==="thirdroom.io"?"thirdroom":"thirdroom_dev",r={...LV};r.staticOidcClients["https://id.thirdroom.io/realms/thirdroom/"]={client_id:t,guestKeycloakIdpHint:"guest"};const i={development:!1},s=new V$({container:n,assetPaths:e,config:r,options:i}),o=new Xs(x0.Calls),a=new PB(FV);return s.setNavigation(a),la={client:new MB(s,o,{deviceName:"Third Room"}),platform:s,navigation:a,containerEl:n,urlRouter:new BV,logger:s.logger},MV("hydrogen",la),aw("openCallLogs",()=>{const u=window.open("/logviewer","__blank");function l(){window.removeEventListener("log-viewer-ready",l),u==null||u.postMessage({hydrogenLogs:JSON.parse(JSON.stringify({items:Array.from(s.logger._openItems).map(d=>d.serialize(void 0,void 0,!1))}))})}window.addEventListener("log-viewer-ready",l)}),aw("downloadCallLogs",()=>{const u=JSON.stringify({items:Array.from(s.logger._openItems).map(l=>l.serialize(void 0,void 0,!1))});xV(u,"thirdroom-call-logs.json","application/json")}),la}function KV(){const n=localStorage.getItem("hydrogen_sessions_v1");if(n){const e=JSON.parse(n);if(Array.isArray(e))return e[0]}}async function jV(n){await n.loadStatus.waitFor(t=>t===be.FirstSync&&n.sync.status.get()==="CatchupSync"||t===be.LoginFailed||t===be.Error||t===be.Ready);const e=n.loadStatus.get();if(e===be.Error||e===be.LoginFailed)throw new Error(HV(n.loginFailure))}function HV(n){if(n===Js.Connection)return"Connection timeout. Please try again.";if(n===Js.Credentials)return"Invalid credentials. Please try again.";if(n===Js.Unknown)return"Unknown error. Please try again."}async function lw(n,e){try{if(await jV(n),n.session)return await n.session.callHandler.loadCalls("m.room"),n.session;await n.startLogout(e),localStorage.clear()}catch(t){throw localStorage.clear(),t}}async function zV(n,e,t,r){const{settingsStorage:i}=n,s=[`oidc_${t}_nonce`,`oidc_${t}_code_verifier`,`oidc_${t}_redirect_uri`,`oidc_${t}_homeserver`,`oidc_${t}_issuer`,`oidc_${t}_client_id`,`oidc_${t}_account_management_url`],[o,a,c,u,l,d,p]=await Promise.all(s.map(m=>i.getString(m)));if(i.remove(`oidc_${t}_started_at`),s.forEach(m=>i.remove(m)),!(!o||!a||!c||!u||!l||!d||!p))return new AB({oidcApi:new zc({issuer:l,staticClients:n.config.staticOidcClients,clientId:d,urlCreator:e,request:n.request,encoding:n.encoding,crypto:n.crypto}),nonce:o,codeVerifier:a,code:r,homeserver:u,redirectUri:c,accountManagementUrl:p})}function GV(n,e,t){const r=cd(),i=async(o,a)=>{const c=await zV(n,e,o,a);c&&(t(c),r("/"))},s=Io();if(s.hash!==""){const o=new URLSearchParams(s.hash.slice(1)),a=o.get("code"),c=o.get("state");if(o.get("error"))return o.get("error_description");a&&c&&i(c,a)}return null}function qV(n,e,t){const r=R.useRef(),i=r.current??void 0,{loading:s,error:o,callback:a}=Gh(async k=>{await n.startWithExistingSession(k.id),r.current=await lw(n,k.id)},[e,n]),{loading:c,error:u,callback:l}=Gh(async k=>{await n.startWithLogin(k),r.current=await lw(n,n.sessionId)},[n]),{loading:d,error:p,callback:m}=Gh(async()=>{if(n&&n.session){const g=(await e.sessionInfoStorage.getAll()).map(A=>n.startLogout(A.id));try{await Promise.allSettled(g)}catch(A){console.error(A)}localStorage.clear(),n.loadStatus.set(be.NotLoading),r.current=void 0}},[n,i]),w=GV(e,t,l),S=CV(n,i),v=s||c||d||i&&!S,_=o||u||p,b=w??(_==null?void 0:_.message);return{session:i,profileRoom:S,loadInitialSession:a,login:l,logout:m,loading:v,errorMsg:b}}function WV(){var g,A;const n=KV(),[{client:e,containerEl:t,platform:r,navigation:i,urlRouter:s,logger:o}]=R.useState(VV),{session:a,profileRoom:c,loadInitialSession:u,login:l,logout:d,loading:p,errorMsg:m}=qV(e,r,s);R.useEffect(()=>()=>{e.dispose(),t.remove()},[e,t]);const w=R.useMemo(()=>({client:e,platform:r,navigation:i,containerEl:t,urlRouter:s,logger:o,session:a,profileRoom:c,login:l,logout:d}),[e,r,i,t,s,o,a,c,l,d]),S=ty({path:"/landing"}),v=ty({path:"/login"}),_=window.location.href,b=/^\S+(\/world\/(!|#)\S+:\S+)$/;if(_.match(b)&&!n&&localStorage.setItem("on_login_redirect_uri",_),n&&!p&&!a&&!S&&u(n),p)return V(Sp,{});if(m)return Br(Bd,{className:"gap-md",children:[V(yl,{variant:"b1",weight:"semi-bold",children:m}),V(hk,{onClick:()=>window.location.reload(),children:"Refresh"})]});if(!a&&!n&&_.match(b))return V(ql,{to:"/login",replace:!0});if(!S&&!v&&!a&&!n)return V(ql,{to:"/landing",replace:!0});const k=(A=(g=localStorage.getItem("on_login_redirect_uri"))==null?void 0:g.match(b))==null?void 0:A[1];return n&&!S&&k?(localStorage.removeItem("on_login_redirect_uri"),V(ql,{to:k})):v&&n?V(ql,{to:"/",replace:!0}):V(vV,{value:w,children:V(eR,{})})}const YV="/assets/logo-full-a4d782c8.svg";function Cc(){return V(Bd,{children:V("img",{src:YV,alt:"Third Room"})})}function XV(){const n=cd();return Br(Bd,{className:"gap-lg",children:[Br("div",{className:"flex flex-column items-center gap-xs",children:[V(yl,{variant:"h2",weight:"bold",children:"Page not found"}),V(yl,{color:"surface-low",children:"Sorry, the page you're looking for doesn't exist."})]}),V(hk,{onClick:()=>n("/"),children:"Go to Homepage"})]})}const JV=yM(nR);window.onload=()=>{navigator.serviceWorker&&navigator.serviceWorker.register(BA,{type:"module"}).then(n=>{console.log("Service worker is registered.")})};function QV(){const{isFocusVisible:n}=bE();return R.useEffect(()=>{document.body.style.setProperty("--focus-outline",n?"var(--tc-surface) solid 2px":"none")},[n]),V(ca,{})}const ZV=R.lazy(()=>_i(()=>import("./LandingPage-b7f0491d.js"),["assets/LandingPage-b7f0491d.js","assets/DropdownMenu-c9ddf01c.js","assets/Label-b8166eab.js","assets/DropdownMenu-7ffc5089.css","assets/cross-0b515b96.js","assets/common-1b4c5772.js","assets/Site-7eb7ba6c.js","assets/Site-7c2b787b.css","assets/modulepreload-polyfill-3cfb730f.js","assets/LandingPage-4b81bfcd.css"])),eK=R.lazy(()=>_i(()=>import("./PreviewBlog-a2fc6ece.js"),["assets/PreviewBlog-a2fc6ece.js","assets/Site-7eb7ba6c.js","assets/DropdownMenu-c9ddf01c.js","assets/Label-b8166eab.js","assets/DropdownMenu-7ffc5089.css","assets/cross-0b515b96.js","assets/common-1b4c5772.js","assets/Site-7c2b787b.css","assets/modulepreload-polyfill-3cfb730f.js","assets/PreviewBlog-9a9e74bb.css"])),tK=R.lazy(()=>_i(()=>import("./LoginView-48df5c1d.js"),["assets/LoginView-48df5c1d.js","assets/index.module-9a456540.js","assets/DropdownMenu-c9ddf01c.js","assets/Label-b8166eab.js","assets/DropdownMenu-7ffc5089.css","assets/index-2207158b.css","assets/SettingTile-abd8ecde.js","assets/SettingTile-f76657fb.css","assets/planet-c905bcdd.js","assets/Footer-aa726a7f.js","assets/Footer-42b808df.css","assets/modulepreload-polyfill-3cfb730f.js","assets/LoginView-efedbb5b.css"])),cw=R.lazy(()=>_i(()=>import("./GLTFViewer-9094e721.js"),["assets/GLTFViewer-9094e721.js","assets/index-84625879.js","assets/mouse-left-107cf13e.js","assets/DropdownMenu-c9ddf01c.js","assets/Label-b8166eab.js","assets/DropdownMenu-7ffc5089.css","assets/index.module-9a456540.js","assets/index-2207158b.css","assets/cross-0b515b96.js","assets/mouse-left-ada4ebc9.css","assets/editor-9e67c00a.js","assets/Deferred-af9e678f.js","assets/Reticle-a481b0a6.js","assets/common-1b4c5772.js","assets/math-0381bedb.js","assets/SettingTile-abd8ecde.js","assets/SettingTile-f76657fb.css","assets/Reticle-221bfa1e.css","assets/modulepreload-polyfill-3cfb730f.js","assets/GLTFViewer-c8cfe193.css"])),nK=R.lazy(()=>_i(()=>import("./AssetPipeline-f01a48ac.js"),["assets/AssetPipeline-f01a48ac.js","assets/Deferred-af9e678f.js","assets/ktx-parse.modern-6c6da609.js","assets/Switch-b59763bd.js","assets/Label-b8166eab.js","assets/Switch-88a1d41d.css","assets/SettingTile-abd8ecde.js","assets/SettingTile-f76657fb.css","assets/modulepreload-polyfill-3cfb730f.js","assets/AssetPipeline-90394310.css"])),rK=R.lazy(()=>_i(()=>import("./SessionView-103d16fb.js"),["assets/SessionView-103d16fb.js","assets/index-84625879.js","assets/mouse-left-107cf13e.js","assets/DropdownMenu-c9ddf01c.js","assets/Label-b8166eab.js","assets/DropdownMenu-7ffc5089.css","assets/index.module-9a456540.js","assets/index-2207158b.css","assets/cross-0b515b96.js","assets/mouse-left-ada4ebc9.css","assets/editor-9e67c00a.js","assets/Deferred-af9e678f.js","assets/actions-42459e52.js","assets/overlayVisibility-d52fa692.js","assets/SettingTile-abd8ecde.js","assets/SettingTile-f76657fb.css","assets/Footer-aa726a7f.js","assets/Footer-42b808df.css","assets/math-0381bedb.js","assets/actions-4cee85b8.css","assets/planet-c905bcdd.js","assets/common-1b4c5772.js","assets/Switch-b59763bd.js","assets/Switch-88a1d41d.css","assets/modulepreload-polyfill-3cfb730f.js","assets/SessionView-0a7c0d31.css"])),uw=R.lazy(()=>_i(()=>import("./WorldRootView-34a7ecdd.js"),["assets/WorldRootView-34a7ecdd.js","assets/actions-42459e52.js","assets/DropdownMenu-c9ddf01c.js","assets/Label-b8166eab.js","assets/DropdownMenu-7ffc5089.css","assets/overlayVisibility-d52fa692.js","assets/editor-9e67c00a.js","assets/Deferred-af9e678f.js","assets/mouse-left-107cf13e.js","assets/index.module-9a456540.js","assets/index-2207158b.css","assets/cross-0b515b96.js","assets/mouse-left-ada4ebc9.css","assets/SettingTile-abd8ecde.js","assets/SettingTile-f76657fb.css","assets/Footer-aa726a7f.js","assets/Footer-42b808df.css","assets/math-0381bedb.js","assets/actions-4cee85b8.css","assets/common-1b4c5772.js","assets/WorldThumbnail-72ae1991.js","assets/WorldThumbnail-19425e7f.css","assets/Reticle-a481b0a6.js","assets/Reticle-221bfa1e.css","assets/modulepreload-polyfill-3cfb730f.js","assets/WorldRootView-b4c8af05.css"])),iK=R.lazy(()=>_i(()=>import("./MainMenuRootView-b320840f.js"),["assets/MainMenuRootView-b320840f.js","assets/overlayVisibility-d52fa692.js","assets/editor-9e67c00a.js","assets/Deferred-af9e678f.js","assets/WorldThumbnail-72ae1991.js","assets/common-1b4c5772.js","assets/WorldThumbnail-19425e7f.css","assets/modulepreload-polyfill-3cfb730f.js"]));function sK(){return Br(HA,{children:[V(QV,{}),Br(JV,{children:[Br(Vt,{element:V(WV,{}),children:[V(Vt,{path:"/landing",element:V(R.Suspense,{fallback:V(Cc,{}),children:V(ZV,{})})}),V(Vt,{path:"/login",element:V(R.Suspense,{fallback:V(Sp,{}),children:V(tK,{})})}),Br(Vt,{element:V(R.Suspense,{fallback:V(Sp,{}),children:V(rK,{})}),children:[V(Vt,{path:"world/:worldId",element:V(R.Suspense,{fallback:V(ca,{}),children:V(uw,{})})}),V(Vt,{path:"world/",element:V(R.Suspense,{fallback:V(ca,{}),children:V(uw,{})})}),V(Vt,{path:"/",element:V(R.Suspense,{fallback:V(ca,{}),children:V(iK,{})})})]}),V(Vt,{path:"/scene-preview",element:V(R.Suspense,{fallback:V(ca,{}),children:V(cw,{})})})]}),V(Vt,{path:"/preview",element:V(R.Suspense,{fallback:V(Cc,{}),children:V(eK,{})})}),V(Vt,{path:"/viewer",element:V(R.Suspense,{fallback:V(Cc,{}),children:V(cw,{})})}),V(Vt,{path:"/pipeline",element:V(R.Suspense,{fallback:V(Cc,{}),children:V(nK,{})})}),V(Vt,{path:"*",element:V(XV,{})})]})]})}QC({dsn:{}.VITE_SENTRY_DSN,environment:{}.VITE_SENTRY_ENVIRONMENT??"development",release:{}.VITE_SENTRY_RELEASE,integrations:[new Xm({routingInstrumentation:mM(jt.useEffect,Io,YT,yu,aS)})],tracesSampleRate:1});uR();const fk="root",pk=document.getElementById(fk);if(!pk)throw new Error(`Can not find root element with id: ${fk}`);RT.render(V(rR,{children:V(sK,{})}),pk);export{lK as $,kK as A,hk as B,NK as C,wV as D,CK as E,ca as F,An as G,dk as H,wt as I,LV as J,ty as K,YV as L,eR as M,Sp as N,zc as O,xK as P,IK as Q,Fn as R,TT as S,yl as T,jt as U,RT as V,AK as W,gK as X,bK as Y,wK as Z,gu as _,V as a,vK as a0,yK as a1,Dl as a2,_K as a3,mK as a4,hO as a5,DK as a6,uK as a7,PK as a8,Io as a9,TK as aa,_k as ab,gk as ac,_l as ad,bs as ae,aw as af,_i as ag,SK as b,Pl as c,TV as d,cK as e,mo as f,SV as g,xV as h,Gh as i,Br as j,qA as k,RV as l,RE as m,EE as n,dK as o,RK as p,G as q,R as r,DB as s,hr as t,cd as u,pr as v,kV as w,MK as x,Lu as y,EK as z};
//# sourceMappingURL=main.cc7980d7.js.map
