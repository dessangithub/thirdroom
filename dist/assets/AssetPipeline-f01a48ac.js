var dn=Object.defineProperty;var mn=(i,e,t)=>e in i?dn(i,e,{enumerable:!0,configurable:!0,writable:!0,value:t}):i[e]=t;var A=(i,e,t)=>(mn(i,typeof e!="symbol"?e+"":e,t),t);import{f as vs,h as xn,r as gt,j as pt,a as oe,T as et,F as rs}from"./main.cc7980d7.js";import{l as Ot,d as Tn,g as En,m as yn,t as bn,c as Rn}from"./Deferred-af9e678f.js";import{r as Ct,K as In,a as Nn}from"./ktx-parse.modern-6c6da609.js";import{S as An}from"./Switch-b59763bd.js";import{L as _n}from"./Label-b8166eab.js";import{S as wn}from"./SettingTile-abd8ecde.js";import"./modulepreload-polyfill-3cfb730f.js";let Yt=class{constructor(){this._listeners={}}addEventListener(e,t){const s=this._listeners;return s[e]===void 0&&(s[e]=[]),s[e].indexOf(t)===-1&&s[e].push(t),this}removeEventListener(e,t){if(this._listeners===void 0)return this;const s=this._listeners[e];if(s!==void 0){const r=s.indexOf(t);r!==-1&&s.splice(r,1)}return this}dispatchEvent(e){if(this._listeners===void 0)return this;const t=this._listeners[e.type];if(t!==void 0){const s=t.slice(0);for(let r=0,n=s.length;r<n;r++)s[r].call(this,e)}return this}dispose(){for(const e in this._listeners)delete this._listeners[e]}},We=class extends Yt{constructor(e,t,s,r={}){if(super(),this._name=void 0,this._parent=void 0,this._child=void 0,this._attributes=void 0,this._disposed=!1,this._name=e,this._parent=t,this._child=s,this._attributes=r,!t.isOnGraph(s))throw new Error("Cannot connect disconnected graphs.")}getName(){return this._name}getParent(){return this._parent}getChild(){return this._child}setChild(e){return this._child=e,this}getAttributes(){return this._attributes}dispose(){this._disposed||(this._disposed=!0,this.dispatchEvent({type:"dispose",target:this}),super.dispose())}isDisposed(){return this._disposed}},Mn=class extends Yt{constructor(...e){super(...e),this._emptySet=new Set,this._edges=new Set,this._parentEdges=new Map,this._childEdges=new Map}listEdges(){return Array.from(this._edges)}listParentEdges(e){return Array.from(this._childEdges.get(e)||this._emptySet)}listParents(e){return this.listParentEdges(e).map(t=>t.getParent())}listChildEdges(e){return Array.from(this._parentEdges.get(e)||this._emptySet)}listChildren(e){return this.listChildEdges(e).map(t=>t.getChild())}disconnectParents(e,t){let s=this.listParentEdges(e);return t&&(s=s.filter(r=>t(r.getParent()))),s.forEach(r=>r.dispose()),this}createEdge(e,t,s,r){return this._registerEdge(new We(e,t,s,r))}_registerEdge(e){this._edges.add(e);const t=e.getParent();this._parentEdges.has(t)||this._parentEdges.set(t,new Set),this._parentEdges.get(t).add(e);const s=e.getChild();return this._childEdges.has(s)||this._childEdges.set(s,new Set),this._childEdges.get(s).add(e),e.addEventListener("dispose",()=>this._removeEdge(e)),e}_removeEdge(e){return this._edges.delete(e),this._parentEdges.get(e.getParent()).delete(e),this._childEdges.get(e.getChild()).delete(e),this}};function ot(){return ot=Object.assign||function(i){for(var e=1;e<arguments.length;e++){var t=arguments[e];for(var s in t)Object.prototype.hasOwnProperty.call(t,s)&&(i[s]=t[s])}return i},ot.apply(this,arguments)}function Ut(i){return i instanceof We}function tt(i){return Array.isArray(i)&&i[0]instanceof We}function st(i){return!!(i&&typeof i=="object"&&Object.values(i)[0]instanceof We)}const j=Symbol("attributes"),Ye=Symbol("immutableKeys");let vn=class Ss extends Yt{constructor(e){super(),this._disposed=!1,this.graph=void 0,this[j]=void 0,this[Ye]=void 0,this.graph=e,this[Ye]=new Set,this[j]=this._createAttributes()}getDefaults(){return{}}_createAttributes(){const e=this.getDefaults(),t={};for(const s in e){const r=e[s];if(r instanceof Ss){const n=this.graph.createEdge(s,this,r);n.addEventListener("dispose",()=>r.dispose()),this[Ye].add(s),t[s]=n}else t[s]=r}return t}isOnGraph(e){return this.graph===e.graph}isDisposed(){return this._disposed}dispose(){this._disposed||(this.graph.listChildEdges(this).forEach(e=>e.dispose()),this.graph.disconnectParents(this),this._disposed=!0,this.dispatchEvent({type:"dispose"}))}detach(){return this.graph.disconnectParents(this),this}swap(e,t){for(const s in this[j]){const r=this[j][s];if(Ut(r)){const n=r;n.getChild()===e&&this.setRef(s,t,n.getAttributes())}else if(tt(r)){const n=r.find(o=>o.getChild()===e);if(n){const o=n.getAttributes();this.removeRef(s,e).addRef(s,t,o)}}else if(st(r)){const n=r;for(const o in n){const a=n[o];a.getChild()===e&&this.setRefMap(s,o,t,a.getAttributes())}}}return this}get(e){return this[j][e]}set(e,t){return this[j][e]=t,this.dispatchEvent({type:"change",attribute:e})}getRef(e){const t=this[j][e];return t?t.getChild():null}setRef(e,t,s){if(this[Ye].has(e))throw new Error(`Cannot overwrite immutable attribute, "${e}".`);const r=this[j][e];if(r&&r.dispose(),!t)return this;const n=this.graph.createEdge(e,this,t,s);return n.addEventListener("dispose",()=>{delete this[j][e],this.dispatchEvent({type:"change",attribute:e})}),this[j][e]=n,this.dispatchEvent({type:"change",attribute:e})}listRefs(e){return this[j][e].map(t=>t.getChild())}addRef(e,t,s){const r=this.graph.createEdge(e,this,t,s),n=this[j][e];return n.push(r),r.addEventListener("dispose",()=>{const o=n.filter(a=>a!==r);n.length=0;for(const a of o)n.push(a);this.dispatchEvent({type:"change",attribute:e})}),this.dispatchEvent({type:"change",attribute:e})}removeRef(e,t){return this[j][e].filter(s=>s.getChild()===t).forEach(s=>s.dispose()),this}listRefMapKeys(e){return Object.keys(this[j][e])}listRefMapValues(e){return Object.values(this[j][e]).map(t=>t.getChild())}getRefMap(e,t){const s=this[j][e];return s[t]?s[t].getChild():null}setRefMap(e,t,s,r){const n=this[j][e],o=n[t];if(o&&o.dispose(),!s)return this;r=Object.assign(r||{},{key:t});const a=this.graph.createEdge(e,this,s,ot({},r,{key:t}));return a.addEventListener("dispose",()=>{delete n[t],this.dispatchEvent({type:"change",attribute:e,key:t})}),n[t]=a,this.dispatchEvent({type:"change",attribute:e,key:t})}dispatchEvent(e){return super.dispatchEvent(ot({},e,{target:this})),this.graph.dispatchEvent(ot({},e,{target:this,type:`node:${e.type}`})),this}};const Os="@glb.bin";var R,bt,ie,he,J,Rt;function Sn(i){const e={min:[1/0,1/0,1/0],max:[-1/0,-1/0,-1/0]},t=i.propertyType===R.NODE?[i]:i.listChildren();for(const s of t)s.traverse(r=>{const n=r.getMesh();if(!n)return;const o=On(n,r.getWorldMatrix());Vt(o.min,e),Vt(o.max,e)});return e}function On(i,e){const t={min:[1/0,1/0,1/0],max:[-1/0,-1/0,-1/0]};for(const s of i.listPrimitives()){const r=s.getAttribute("POSITION");if(!r)continue;let n=[0,0,0],o=[0,0,0];for(let a=0;a<r.getCount();a++)n=r.getElement(a,n),o=bn(o,n,e),Vt(o,t)}return t}function Vt(i,e){for(let t=0;t<3;t++)e.min[t]=Math.min(i[t],e.min[t]),e.max[t]=Math.max(i[t],e.max[t])}(function(i){i.ACCESSOR="Accessor",i.ANIMATION="Animation",i.ANIMATION_CHANNEL="AnimationChannel",i.ANIMATION_SAMPLER="AnimationSampler",i.BUFFER="Buffer",i.CAMERA="Camera",i.MATERIAL="Material",i.MESH="Mesh",i.PRIMITIVE="Primitive",i.PRIMITIVE_TARGET="PrimitiveTarget",i.NODE="Node",i.ROOT="Root",i.SCENE="Scene",i.SKIN="Skin",i.TEXTURE="Texture",i.TEXTURE_INFO="TextureInfo"})(R||(R={})),function(i){i.INTERLEAVED="interleaved",i.SEPARATE="separate"}(bt||(bt={})),function(i){i.ARRAY_BUFFER="ARRAY_BUFFER",i.ELEMENT_ARRAY_BUFFER="ELEMENT_ARRAY_BUFFER",i.INVERSE_BIND_MATRICES="INVERSE_BIND_MATRICES",i.OTHER="OTHER"}(ie||(ie={})),function(i){i[i.R=4096]="R",i[i.G=256]="G",i[i.B=16]="B",i[i.A=1]="A"}(he||(he={})),function(i){i.GLTF="GLTF",i.GLB="GLB"}(J||(J={}));class S{static createBufferFromDataURI(e){if(typeof Buffer>"u"){const t=atob(e.split(",")[1]),s=new Uint8Array(t.length);for(let r=0;r<t.length;r++)s[r]=t.charCodeAt(r);return s}{const t=e.split(",")[1],s=e.indexOf("base64")>=0;return Buffer.from(t,s?"base64":"utf8")}}static encodeText(e){return typeof TextEncoder<"u"?new TextEncoder().encode(e):Buffer.from(e)}static decodeText(e){return typeof TextDecoder<"u"?new TextDecoder().decode(e):Buffer.from(e).toString("utf8")}static concat(e){let t=0;for(const n of e)t+=n.byteLength;const s=new Uint8Array(t);let r=0;for(const n of e)s.set(n,r),r+=n.byteLength;return s}static pad(e,t=0){const s=this.padNumber(e.byteLength);if(s===e.byteLength)return e;const r=new Uint8Array(s);if(r.set(e),t!==0)for(let n=e.byteLength;n<s;n++)r[n]=t;return r}static padNumber(e){return 4*Math.ceil(e/4)}static equals(e,t){if(e===t)return!0;if(e.byteLength!==t.byteLength)return!1;let s=e.byteLength;for(;s--;)if(e[s]!==t[s])return!1;return!0}static toView(e,t=0,s=1/0){return new Uint8Array(e.buffer,e.byteOffset+t,Math.min(e.byteLength,s))}static assertView(e){if(e&&!ArrayBuffer.isView(e))throw new Error(`Method requires Uint8Array parameter; received "${typeof e}".`);return e}}let Z=class{static hexToFactor(e,t){e=Math.floor(e);const s=t;return s[0]=(e>>16&255)/255,s[1]=(e>>8&255)/255,s[2]=(255&e)/255,this.convertSRGBToLinear(t,t)}static factorToHex(e){const t=[...e],[s,r,n]=this.convertLinearToSRGB(e,t);return 255*s<<16^255*r<<8^255*n<<0}static convertSRGBToLinear(e,t){const s=e,r=t;for(let n=0;n<3;n++)r[n]=s[n]<.04045?.0773993808*s[n]:Math.pow(.9478672986*s[n]+.0521327014,2.4);return t}static convertLinearToSRGB(e,t){const s=e,r=t;for(let n=0;n<3;n++)r[n]=s[n]<.0031308?12.92*s[n]:1.055*Math.pow(s[n],.41666)-.055;return t}},Cs=class Ds{match(e){return e.length>=8&&e[0]===137&&e[1]===80&&e[2]===78&&e[3]===71&&e[4]===13&&e[5]===10&&e[6]===26&&e[7]===10}getSize(e){const t=new DataView(e.buffer,e.byteOffset);return S.decodeText(e.slice(12,16))===Ds.PNG_FRIED_CHUNK_NAME?[t.getUint32(32,!1),t.getUint32(36,!1)]:[t.getUint32(16,!1),t.getUint32(20,!1)]}getChannels(e){return 4}};Cs.PNG_FRIED_CHUNK_NAME="CgBI";class ye{static registerFormat(e,t){this.impls[e]=t}static getMimeType(e){for(const t in this.impls)if(this.impls[t].match(e))return t;return null}static getSize(e,t){return this.impls[t]?this.impls[t].getSize(e):null}static getChannels(e,t){return this.impls[t]?this.impls[t].getChannels(e):null}static getMemSize(e,t){if(!this.impls[t])return null;if(this.impls[t].getGPUByteLength)return this.impls[t].getGPUByteLength(e);let s=0;const r=this.getSize(e,t);if(!r)return null;for(;r[0]>1||r[1]>1;)s+=r[0]*r[1]*4,r[0]=Math.max(Math.floor(r[0]/2),1),r[1]=Math.max(Math.floor(r[1]/2),1);return s+=4,s}static mimeTypeToExtension(e){return e==="image/jpeg"?"jpg":e.split("/").pop()}static extensionToMimeType(e){return e==="jpg"?"image/jpeg":`image/${e}`}}function Cn(i,e){if(e>i.byteLength)throw new TypeError("Corrupt JPG, exceeded buffer limits");if(i.getUint8(e)!==255)throw new TypeError("Invalid JPG, marker table corrupted");return i}ye.impls={"image/jpeg":new class{match(i){return i.length>=3&&i[0]===255&&i[1]===216&&i[2]===255}getSize(i){let e,t,s=new DataView(i.buffer,i.byteOffset+4);for(;s.byteLength;){if(e=s.getUint16(0,!1),Cn(s,e),t=s.getUint8(e+1),t===192||t===193||t===194)return[s.getUint16(e+7,!1),s.getUint16(e+5,!1)];s=new DataView(i.buffer,s.byteOffset+e+2)}throw new TypeError("Invalid JPG, no size found")}getChannels(i){return 3}},"image/png":new Cs};let be=class{static basename(e){const t=e.split(/[\\/]/).pop();return t.substring(0,t.lastIndexOf("."))}static extension(e){if(e.startsWith("data:image/")){const t=e.match(/data:(image\/\w+)/)[1];return ye.mimeTypeToExtension(t)}return e.startsWith("data:model/gltf+json")?"gltf":e.startsWith("data:model/gltf-binary")?"glb":e.startsWith("data:application/")?"bin":e.split(/[\\/]/).pop().split(/[.]/).pop()}};function ns(i){return Object.prototype.toString.call(i)==="[object Object]"}function ze(i){if(ns(i)===!1)return!1;const e=i.constructor;if(e===void 0)return!0;const t=e.prototype;return ns(t)!==!1&&Object.prototype.hasOwnProperty.call(t,"isPrototypeOf")!==!1}(function(i){i[i.SILENT=4]="SILENT",i[i.ERROR=3]="ERROR",i[i.WARN=2]="WARN",i[i.INFO=1]="INFO",i[i.DEBUG=0]="DEBUG"})(Rt||(Rt={}));let Ee=class rt{constructor(e){this.verbosity=void 0,this.verbosity=e}debug(e){this.verbosity<=rt.Verbosity.DEBUG&&console.debug(e)}info(e){this.verbosity<=rt.Verbosity.INFO&&console.info(e)}warn(e){this.verbosity<=rt.Verbosity.WARN&&console.warn(e)}error(e){this.verbosity<=rt.Verbosity.ERROR&&console.error(e)}};Ee.Verbosity=Rt,Ee.DEFAULT_INSTANCE=new Ee(Ee.Verbosity.INFO);let P=class{static identity(e){return e}static eq(e,t){if(e.length!==t.length)return!1;for(let s=0;s<e.length;s++)if(Math.abs(e[s]-t[s])>1e-5)return!1;return!0}static denormalize(e,t){switch(t){case 5126:return e;case 5123:return e/65535;case 5121:return e/255;case 5122:return Math.max(e/32767,-1);case 5120:return Math.max(e/127,-1);default:throw new Error("Invalid component type.")}}static normalize(e,t){switch(t){case 5126:return e;case 5123:return Math.round(65535*e);case 5121:return Math.round(255*e);case 5122:return Math.round(32767*e);case 5120:return Math.round(127*e);default:throw new Error("Invalid component type.")}}static decompose(e,t,s,r){let n=Ot([e[0],e[1],e[2]]);const o=Ot([e[4],e[5],e[6]]),a=Ot([e[8],e[9],e[10]]);Tn(e)<0&&(n=-n),t[0]=e[12],t[1]=e[13],t[2]=e[14];const c=e.slice(),u=1/n,f=1/o,p=1/a;c[0]*=u,c[1]*=u,c[2]*=u,c[4]*=f,c[5]*=f,c[6]*=f,c[8]*=p,c[9]*=p,c[10]*=p,En(s,c),r[0]=n,r[1]=o,r[2]=a}static compose(e,t,s,r){const n=r,o=t[0],a=t[1],c=t[2],u=t[3],f=o+o,p=a+a,h=c+c,m=o*f,y=o*p,T=o*h,x=a*p,g=a*h,l=c*h,d=u*f,E=u*p,b=u*h,I=s[0],_=s[1],w=s[2];return n[0]=(1-(x+l))*I,n[1]=(y+b)*I,n[2]=(T-E)*I,n[3]=0,n[4]=(y-b)*_,n[5]=(1-(m+l))*_,n[6]=(g+d)*_,n[7]=0,n[8]=(T+E)*w,n[9]=(g-d)*w,n[10]=(1-(m+x))*w,n[11]=0,n[12]=e[0],n[13]=e[1],n[14]=e[2],n[15]=1,n}};function Dn(i,e){if(!!i!=!!e)return!1;const t=i.getChild(),s=e.getChild();return t===s||t.equals(s)}function jn(i,e){if(!!i!=!!e||i.length!==e.length)return!1;for(let t=0;t<i.length;t++){const s=i[t],r=e[t];if(s.getChild()!==r.getChild()&&!s.getChild().equals(r.getChild()))return!1}return!0}function Fn(i,e){if(!!i!=!!e)return!1;const t=Object.keys(i),s=Object.keys(e);if(t.length!==s.length)return!1;for(const r in i){const n=i[r],o=e[r];if(!!n!=!!o)return!1;const a=n.getChild(),c=o.getChild();if(a!==c&&!a.equals(c))return!1}return!0}function js(i,e){if(i===e)return!0;if(!!i!=!!e||!i||!e||i.length!==e.length)return!1;for(let t=0;t<i.length;t++)if(i[t]!==e[t])return!1;return!0}function Fs(i,e){if(i===e)return!0;if(!!i!=!!e)return!1;if(!ze(i)||!ze(e))return i===e;const t=i,s=e;let r,n=0,o=0;for(r in t)n++;for(r in s)o++;if(n!==o)return!1;for(r in t){const a=t[r],c=s[r];if(It(a)&&It(c)){if(!js(a,c))return!1}else if(ze(a)&&ze(c)){if(!Fs(a,c))return!1}else if(a!==c)return!1}return!0}function It(i){return Array.isArray(i)||ArrayBuffer.isView(i)}const is="23456789abdegjkmnpqrvwxyzABDEGJKMNPQRVWXYZ",os=new Set,Pn=function(){let i="";for(let e=0;e<6;e++)i+=is.charAt(Math.floor(Math.random()*is.length));return i},Ln=function(){for(let i=0;i<999;i++){const e=Pn();if(!os.has(e))return os.add(e),e}return""};let we=class{static dirname(e){const t=e.lastIndexOf("/");return t===-1?"./":e.substring(0,t+1)}static basename(e){return be.basename(new URL(e,"https://null.example").pathname)}static extension(e){return be.extension(new URL(e,"https://null.example").pathname)}static resolve(e,t){if(!this.isRelativePath(t))return t;const s=e.split("/"),r=t.split("/");s.pop();for(let n=0;n<r.length;n++)r[n]!=="."&&(r[n]===".."?s.pop():s.push(r[n]));return s.join("/")}static isAbsoluteURL(e){return this.PROTOCOL_REGEXP.test(e)}static isRelativePath(e){return!/^(?:[a-zA-Z]+:)?\//.test(e)}};we.DEFAULT_INIT={},we.PROTOCOL_REGEXP=/^[a-zA-Z]+:\/\//;const Re=i=>i,Bn=new Set;let Kt=class extends vn{constructor(e,t=""){super(e),this[j].name=t,this.init(),this.dispatchEvent({type:"create"})}getDefaults(){return Object.assign(super.getDefaults(),{name:"",extras:{}})}getName(){return this.get("name")}setName(e){return this.set("name",e)}getExtras(){return this.get("extras")}setExtras(e){return this.set("extras",e)}clone(){return new this.constructor(this.graph).copy(this,Re)}copy(e,t=Re){for(const s in this[j]){const r=this[j][s];if(r instanceof We)this[Ye].has(s)||r.dispose();else if(tt(r))for(const n of r)n.dispose();else if(st(r))for(const n in r)r[n].dispose()}for(const s in e[j]){const r=this[j][s],n=e[j][s];if(n instanceof We)this[Ye].has(s)?r.getChild().copy(t(n.getChild()),t):this.setRef(s,t(n.getChild()),n.getAttributes());else if(tt(n))for(const o of n)this.addRef(s,t(o.getChild()),o.getAttributes());else if(st(n))for(const o in n){const a=n[o];this.setRefMap(s,o,t(a.getChild()),a.getAttributes())}else this[j][s]=ze(n)?JSON.parse(JSON.stringify(n)):Array.isArray(n)||n instanceof ArrayBuffer||ArrayBuffer.isView(n)?n.slice():n}return this}equals(e,t=Bn){if(this===e)return!0;if(this.propertyType!==e.propertyType)return!1;for(const s in this[j]){if(t.has(s))continue;const r=this[j][s],n=e[j][s];if(Ut(r)||Ut(n)){if(!Dn(r,n))return!1}else if(tt(r)||tt(n)){if(!jn(r,n))return!1}else if(st(r)||st(n)){if(!Fn(r,n))return!1}else if(ze(r)||ze(n)){if(!Fs(r,n))return!1}else if(It(r)||It(n)){if(!js(r,n))return!1}else if(r!==n)return!1}return!0}detach(){return this.graph.disconnectParents(this,e=>e.propertyType!=="Root"),this}listParents(){return this.graph.listParents(this)}},q=class extends Kt{getDefaults(){return Object.assign(super.getDefaults(),{extensions:{}})}getExtension(e){return this.getRefMap("extensions",e)}setExtension(e,t){return t&&t.t(this),this.setRefMap("extensions",e,t)}listExtensions(){return this.listRefMapValues("extensions")}},O=class B extends q{constructor(...e){super(...e),this.i=P.identity,this.o=P.identity}init(){this.propertyType=R.ACCESSOR}getDefaults(){return Object.assign(super.getDefaults(),{array:null,type:B.Type.SCALAR,componentType:B.ComponentType.FLOAT,normalized:!1,buffer:null})}copy(e,t=Re){return super.copy(e,t),this.i=e.i,this.o=e.o,this}static getElementSize(e){switch(e){case B.Type.SCALAR:return 1;case B.Type.VEC2:return 2;case B.Type.VEC3:return 3;case B.Type.VEC4:case B.Type.MAT2:return 4;case B.Type.MAT3:return 9;case B.Type.MAT4:return 16;default:throw new Error("Unexpected type: "+e)}}static getComponentSize(e){switch(e){case B.ComponentType.BYTE:case B.ComponentType.UNSIGNED_BYTE:return 1;case B.ComponentType.SHORT:case B.ComponentType.UNSIGNED_SHORT:return 2;case B.ComponentType.UNSIGNED_INT:case B.ComponentType.FLOAT:return 4;default:throw new Error("Unexpected component type: "+e)}}getMinNormalized(e){const t=this.getElementSize();this.getMin(e);for(let s=0;s<t;s++)e[s]=this.o(e[s]);return e}getMin(e){const t=this.get("array"),s=this.getCount(),r=this.getElementSize();for(let n=0;n<r;n++)e[n]=1/0;for(let n=0;n<s*r;n+=r)for(let o=0;o<r;o++){const a=t[n+o];Number.isFinite(a)&&(e[o]=Math.min(e[o],a))}return e}getMaxNormalized(e){const t=this.getElementSize();this.getMax(e);for(let s=0;s<t;s++)e[s]=this.o(e[s]);return e}getMax(e){const t=this.get("array"),s=this.getCount(),r=this.getElementSize();for(let n=0;n<r;n++)e[n]=-1/0;for(let n=0;n<s*r;n+=r)for(let o=0;o<r;o++){const a=t[n+o];Number.isFinite(a)&&(e[o]=Math.max(e[o],a))}return e}getCount(){const e=this.get("array");return e?e.length/this.getElementSize():0}getType(){return this.get("type")}setType(e){return this.set("type",e)}getElementSize(){return B.getElementSize(this.get("type"))}getComponentSize(){return this.get("array").BYTES_PER_ELEMENT}getComponentType(){return this.get("componentType")}getNormalized(){return this.get("normalized")}setNormalized(e){return this.set("normalized",e),e?(this.o=t=>P.denormalize(t,this.get("componentType")),this.i=t=>P.normalize(t,this.get("componentType"))):(this.o=P.identity,this.i=P.identity),this}getScalar(e){const t=this.getElementSize();return this.o(this.get("array")[e*t])}setScalar(e,t){return this.get("array")[e*this.getElementSize()]=this.i(t),this}getElement(e,t){const s=this.getElementSize(),r=this.get("array");for(let n=0;n<s;n++)t[n]=this.o(r[e*s+n]);return t}setElement(e,t){const s=this.getElementSize(),r=this.get("array");for(let n=0;n<s;n++)r[e*s+n]=this.i(t[n]);return this}getBuffer(){return this.getRef("buffer")}setBuffer(e){return this.setRef("buffer",e)}getArray(){return this.get("array")}setArray(e){return this.set("componentType",e?function(t){switch(t.constructor){case Float32Array:return B.ComponentType.FLOAT;case Uint32Array:return B.ComponentType.UNSIGNED_INT;case Uint16Array:return B.ComponentType.UNSIGNED_SHORT;case Uint8Array:return B.ComponentType.UNSIGNED_BYTE;case Int16Array:return B.ComponentType.SHORT;case Int8Array:return B.ComponentType.BYTE;default:throw new Error("Unknown accessor componentType.")}}(e):B.ComponentType.FLOAT),this.set("array",e),this}getByteLength(){const e=this.get("array");return e?e.byteLength:0}};O.Type={SCALAR:"SCALAR",VEC2:"VEC2",VEC3:"VEC3",VEC4:"VEC4",MAT2:"MAT2",MAT3:"MAT3",MAT4:"MAT4"},O.ComponentType={BYTE:5120,UNSIGNED_BYTE:5121,SHORT:5122,UNSIGNED_SHORT:5123,UNSIGNED_INT:5125,FLOAT:5126};let Ps=class extends q{init(){this.propertyType=R.ANIMATION}getDefaults(){return Object.assign(super.getDefaults(),{channels:[],samplers:[]})}addChannel(e){return this.addRef("channels",e)}removeChannel(e){return this.removeRef("channels",e)}listChannels(){return this.listRefs("channels")}addSampler(e){return this.addRef("samplers",e)}removeSampler(e){return this.removeRef("samplers",e)}listSamplers(){return this.listRefs("samplers")}},Mt=class extends q{init(){this.propertyType=R.ANIMATION_CHANNEL}getDefaults(){return Object.assign(super.getDefaults(),{targetPath:null,targetNode:null,sampler:null})}getTargetPath(){return this.get("targetPath")}setTargetPath(e){return this.set("targetPath",e)}getTargetNode(){return this.getRef("targetNode")}setTargetNode(e){return this.setRef("targetNode",e)}getSampler(){return this.getRef("sampler")}setSampler(e){return this.setRef("sampler",e)}};Mt.TargetPath={TRANSLATION:"translation",ROTATION:"rotation",SCALE:"scale",WEIGHTS:"weights"};let vt=class Ls extends q{init(){this.propertyType=R.ANIMATION_SAMPLER}getDefaultAttributes(){return Object.assign(super.getDefaults(),{interpolation:Ls.Interpolation.LINEAR,input:null,output:null})}getInterpolation(){return this.get("interpolation")}setInterpolation(e){return this.set("interpolation",e)}getInput(){return this.getRef("input")}setInput(e){return this.setRef("input",e,{usage:ie.OTHER})}getOutput(){return this.getRef("output")}setOutput(e){return this.setRef("output",e,{usage:ie.OTHER})}};vt.Interpolation={LINEAR:"LINEAR",STEP:"STEP",CUBICSPLINE:"CUBICSPLINE"};let Bs=class extends q{init(){this.propertyType=R.BUFFER}getDefaults(){return Object.assign(super.getDefaults(),{uri:""})}getURI(){return this.get("uri")}setURI(e){return this.set("uri",e)}},ct=class Us extends q{init(){this.propertyType=R.CAMERA}getDefaults(){return Object.assign(super.getDefaults(),{type:Us.Type.PERSPECTIVE,znear:.1,zfar:100,aspectRatio:null,yfov:2*Math.PI*50/360,xmag:1,ymag:1})}getType(){return this.get("type")}setType(e){return this.set("type",e)}getZNear(){return this.get("znear")}setZNear(e){return this.set("znear",e)}getZFar(){return this.get("zfar")}setZFar(e){return this.set("zfar",e)}getAspectRatio(){return this.get("aspectRatio")}setAspectRatio(e){return this.set("aspectRatio",e)}getYFov(){return this.get("yfov")}setYFov(e){return this.set("yfov",e)}getXMag(){return this.get("xmag")}setXMag(e){return this.set("xmag",e)}getYMag(){return this.get("ymag")}setYMag(e){return this.set("ymag",e)}};ct.Type={PERSPECTIVE:"perspective",ORTHOGRAPHIC:"orthographic"};let C=class extends Kt{t(e){if(!this.parentTypes.includes(e.propertyType))throw new Error(`Parent "${e.propertyType}" invalid for child "${this.propertyType}".`)}};C.EXTENSION_NAME=void 0;let U=class kt extends q{init(){this.propertyType=R.TEXTURE_INFO}getDefaults(){return Object.assign(super.getDefaults(),{texCoord:0,magFilter:null,minFilter:null,wrapS:kt.WrapMode.REPEAT,wrapT:kt.WrapMode.REPEAT})}getTexCoord(){return this.get("texCoord")}setTexCoord(e){return this.set("texCoord",e)}getMagFilter(){return this.get("magFilter")}setMagFilter(e){return this.set("magFilter",e)}getMinFilter(){return this.get("minFilter")}setMinFilter(e){return this.set("minFilter",e)}getWrapS(){return this.get("wrapS")}setWrapS(e){return this.set("wrapS",e)}getWrapT(){return this.get("wrapT")}setWrapT(e){return this.set("wrapT",e)}};U.WrapMode={CLAMP_TO_EDGE:33071,MIRRORED_REPEAT:33648,REPEAT:10497},U.MagFilter={NEAREST:9728,LINEAR:9729},U.MinFilter={NEAREST:9728,LINEAR:9729,NEAREST_MIPMAP_NEAREST:9984,LINEAR_MIPMAP_NEAREST:9985,NEAREST_MIPMAP_LINEAR:9986,LINEAR_MIPMAP_LINEAR:9987};const{R:dt,G:mt,B:xt,A:Un}=he;let ut=class Vs extends q{init(){this.propertyType=R.MATERIAL}getDefaults(){return Object.assign(super.getDefaults(),{alphaMode:Vs.AlphaMode.OPAQUE,alphaCutoff:.5,doubleSided:!1,baseColorFactor:[1,1,1,1],baseColorTexture:null,baseColorTextureInfo:new U(this.graph,"baseColorTextureInfo"),emissiveFactor:[0,0,0],emissiveTexture:null,emissiveTextureInfo:new U(this.graph,"emissiveTextureInfo"),normalScale:1,normalTexture:null,normalTextureInfo:new U(this.graph,"normalTextureInfo"),occlusionStrength:1,occlusionTexture:null,occlusionTextureInfo:new U(this.graph,"occlusionTextureInfo"),roughnessFactor:1,metallicFactor:1,metallicRoughnessTexture:null,metallicRoughnessTextureInfo:new U(this.graph,"metallicRoughnessTextureInfo")})}getDoubleSided(){return this.get("doubleSided")}setDoubleSided(e){return this.set("doubleSided",e)}getAlpha(){return this.get("baseColorFactor")[3]}setAlpha(e){const t=this.get("baseColorFactor").slice();return t[3]=e,this.set("baseColorFactor",t)}getAlphaMode(){return this.get("alphaMode")}setAlphaMode(e){return this.set("alphaMode",e)}getAlphaCutoff(){return this.get("alphaCutoff")}setAlphaCutoff(e){return this.set("alphaCutoff",e)}getBaseColorFactor(){return this.get("baseColorFactor")}setBaseColorFactor(e){return this.set("baseColorFactor",e)}getBaseColorHex(){return Z.factorToHex(this.get("baseColorFactor"))}setBaseColorHex(e){const t=this.get("baseColorFactor").slice();return this.set("baseColorFactor",Z.hexToFactor(e,t))}getBaseColorTexture(){return this.getRef("baseColorTexture")}getBaseColorTextureInfo(){return this.getRef("baseColorTexture")?this.getRef("baseColorTextureInfo"):null}setBaseColorTexture(e){return this.setRef("baseColorTexture",e,{channels:dt|mt|xt|Un})}getEmissiveFactor(){return this.get("emissiveFactor")}setEmissiveFactor(e){return this.set("emissiveFactor",e)}getEmissiveHex(){return Z.factorToHex(this.get("emissiveFactor"))}setEmissiveHex(e){const t=this.get("emissiveFactor").slice();return this.set("emissiveFactor",Z.hexToFactor(e,t))}getEmissiveTexture(){return this.getRef("emissiveTexture")}getEmissiveTextureInfo(){return this.getRef("emissiveTexture")?this.getRef("emissiveTextureInfo"):null}setEmissiveTexture(e){return this.setRef("emissiveTexture",e,{channels:dt|mt|xt})}getNormalScale(){return this.get("normalScale")}setNormalScale(e){return this.set("normalScale",e)}getNormalTexture(){return this.getRef("normalTexture")}getNormalTextureInfo(){return this.getRef("normalTexture")?this.getRef("normalTextureInfo"):null}setNormalTexture(e){return this.setRef("normalTexture",e,{channels:dt|mt|xt})}getOcclusionStrength(){return this.get("occlusionStrength")}setOcclusionStrength(e){return this.set("occlusionStrength",e)}getOcclusionTexture(){return this.getRef("occlusionTexture")}getOcclusionTextureInfo(){return this.getRef("occlusionTexture")?this.getRef("occlusionTextureInfo"):null}setOcclusionTexture(e){return this.setRef("occlusionTexture",e,{channels:dt})}getRoughnessFactor(){return this.get("roughnessFactor")}setRoughnessFactor(e){return this.set("roughnessFactor",e)}getMetallicFactor(){return this.get("metallicFactor")}setMetallicFactor(e){return this.set("metallicFactor",e)}getMetallicRoughnessTexture(){return this.getRef("metallicRoughnessTexture")}getMetallicRoughnessTextureInfo(){return this.getRef("metallicRoughnessTexture")?this.getRef("metallicRoughnessTextureInfo"):null}setMetallicRoughnessTexture(e){return this.setRef("metallicRoughnessTexture",e,{channels:mt|xt})}};ut.AlphaMode={OPAQUE:"OPAQUE",MASK:"MASK",BLEND:"BLEND"};let ks=class extends q{init(){this.propertyType=R.MESH}getDefaults(){return Object.assign(super.getDefaults(),{weights:[],primitives:[]})}addPrimitive(e){return this.addRef("primitives",e)}removePrimitive(e){return this.removeRef("primitives",e)}listPrimitives(){return this.listRefs("primitives")}getWeights(){return this.get("weights")}setWeights(e){return this.set("weights",e)}},Wt=class Gs extends q{constructor(...e){super(...e),this.u=null}init(){this.propertyType=R.NODE}getDefaults(){return Object.assign(super.getDefaults(),{translation:[0,0,0],rotation:[0,0,0,1],scale:[1,1,1],weights:[],camera:null,mesh:null,skin:null,children:[]})}copy(e,t=Re){if(t===Re)throw new Error("Node cannot be copied.");return super.copy(e,t)}getTranslation(){return this.get("translation")}getRotation(){return this.get("rotation")}getScale(){return this.get("scale")}setTranslation(e){return this.set("translation",e)}setRotation(e){return this.set("rotation",e)}setScale(e){return this.set("scale",e)}getMatrix(){return P.compose(this.get("translation"),this.get("rotation"),this.get("scale"),[])}setMatrix(e){const t=this.get("translation").slice(),s=this.get("rotation").slice(),r=this.get("scale").slice();return P.decompose(e,t,s,r),this.set("translation",t).set("rotation",s).set("scale",r)}getWorldTranslation(){const e=[0,0,0];return P.decompose(this.getWorldMatrix(),e,[0,0,0,1],[1,1,1]),e}getWorldRotation(){const e=[0,0,0,1];return P.decompose(this.getWorldMatrix(),[0,0,0],e,[1,1,1]),e}getWorldScale(){const e=[1,1,1];return P.decompose(this.getWorldMatrix(),[0,0,0],[0,0,0,1],e),e}getWorldMatrix(){const e=[];for(let r=this;r instanceof Gs;r=r.u)e.push(r);let t;const s=e.pop().getMatrix();for(;t=e.pop();)yn(s,s,t.getMatrix());return s}addChild(e){e.u&&e.u.removeChild(e),this.addRef("children",e),e.u=this;const t=this[j].children;return t[t.length-1].addEventListener("dispose",()=>e.u=null),this}removeChild(e){return this.removeRef("children",e)}listChildren(){return this.listRefs("children")}getParent(){return this.u}getMesh(){return this.getRef("mesh")}setMesh(e){return this.setRef("mesh",e)}getCamera(){return this.getRef("camera")}setCamera(e){return this.setRef("camera",e)}getSkin(){return this.getRef("skin")}setSkin(e){return this.setRef("skin",e)}getWeights(){return this.get("weights")}setWeights(e){return this.set("weights",e)}traverse(e){e(this);for(const t of this.listChildren())t.traverse(e);return this}},Je=class $s extends q{init(){this.propertyType=R.PRIMITIVE}getDefaults(){return Object.assign(super.getDefaults(),{mode:$s.Mode.TRIANGLES,material:null,indices:null,attributes:{},targets:[]})}getIndices(){return this.getRef("indices")}setIndices(e){return this.setRef("indices",e,{usage:ie.ELEMENT_ARRAY_BUFFER})}getAttribute(e){return this.getRefMap("attributes",e)}setAttribute(e,t){return this.setRefMap("attributes",e,t,{usage:ie.ARRAY_BUFFER})}listAttributes(){return this.listRefMapValues("attributes")}listSemantics(){return this.listRefMapKeys("attributes")}getMaterial(){return this.getRef("material")}setMaterial(e){return this.setRef("material",e)}getMode(){return this.get("mode")}setMode(e){return this.set("mode",e)}listTargets(){return this.listRefs("targets")}addTarget(e){return this.addRef("targets",e)}removeTarget(e){return this.removeRef("targets",e)}};Je.Mode={POINTS:0,LINES:1,LINE_LOOP:2,LINE_STRIP:3,TRIANGLES:4,TRIANGLE_STRIP:5,TRIANGLE_FAN:6};let Vn=class extends Kt{init(){this.propertyType=R.PRIMITIVE_TARGET}getDefaults(){return Object.assign(super.getDefaults(),{attributes:{}})}getAttribute(e){return this.getRefMap("attributes",e)}setAttribute(e,t){return this.setRefMap("attributes",e,t,{usage:ie.ARRAY_BUFFER})}listAttributes(){return this.listRefMapValues("attributes")}listSemantics(){return this.listRefMapKeys("attributes")}};function W(){return(W=Object.assign||function(i){for(var e=1;e<arguments.length;e++){var t=arguments[e];for(var s in t)Object.prototype.hasOwnProperty.call(t,s)&&(i[s]=t[s])}return i}).apply(this,arguments)}let zs=class extends q{init(){this.propertyType=R.SCENE}getDefaults(){return Object.assign(super.getDefaults(),{children:[]})}copy(e,t=Re){if(t===Re)throw new Error("Scene cannot be copied.");return super.copy(e,t)}addChild(e){e.u&&e.u.removeChild(e),this.addRef("children",e),e.u=this;const t=this[j].children;return t[t.length-1].addEventListener("dispose",()=>e.u=null),this}removeChild(e){return this.removeRef("children",e)}listChildren(){return this.listRefs("children")}traverse(e){for(const t of this.listChildren())t.traverse(e);return this}},Xs=class extends q{init(){this.propertyType=R.SKIN}getDefaults(){return Object.assign(super.getDefaults(),{skeleton:null,inverseBindMatrices:null,joints:[]})}getSkeleton(){return this.getRef("skeleton")}setSkeleton(e){return this.setRef("skeleton",e)}getInverseBindMatrices(){return this.getRef("inverseBindMatrices")}setInverseBindMatrices(e){return this.setRef("inverseBindMatrices",e,{usage:ie.INVERSE_BIND_MATRICES})}addJoint(e){return this.addRef("joints",e)}removeJoint(e){return this.removeRef("joints",e)}listJoints(){return this.listRefs("joints")}},Hs=class extends q{init(){this.propertyType=R.TEXTURE}getDefaults(){return Object.assign(super.getDefaults(),{image:null,mimeType:"",uri:""})}getMimeType(){return this.get("mimeType")||ye.extensionToMimeType(be.extension(this.get("uri")))}setMimeType(e){return this.set("mimeType",e)}getURI(){return this.get("uri")}setURI(e){return this.set("uri",e),this.set("mimeType",ye.extensionToMimeType(be.extension(e))),this}getImage(){return this.get("image")}setImage(e){return this.set("image",S.assertView(e))}getSize(){const e=this.get("image");return e?ye.getSize(e,this.getMimeType()):null}},St=class extends q{init(){this.propertyType=R.ROOT}getDefaults(){return Object.assign(super.getDefaults(),{asset:{generator:"glTF-Transform v2.4.3",version:"2.0"},defaultScene:null,accessors:[],animations:[],buffers:[],cameras:[],materials:[],meshes:[],nodes:[],scenes:[],skins:[],textures:[]})}constructor(e){super(e),this.h=new Set,e.addEventListener("node:create",t=>{this.l(t.target)})}clone(){throw new Error("Root cannot be cloned.")}copy(e,t=Re){if(t===Re)throw new Error("Root cannot be copied.");this.set("asset",W({},e.get("asset"))),this.setName(e.getName()),this.setExtras(W({},e.getExtras())),this.setDefaultScene(e.getDefaultScene()?t(e.getDefaultScene()):null);for(const s of e.listRefMapKeys("extensions")){const r=e.getExtension(s);this.setExtension(s,t(r))}return this}l(e){return e instanceof zs?this.addRef("scenes",e):e instanceof Wt?this.addRef("nodes",e):e instanceof ct?this.addRef("cameras",e):e instanceof Xs?this.addRef("skins",e):e instanceof ks?this.addRef("meshes",e):e instanceof ut?this.addRef("materials",e):e instanceof Hs?this.addRef("textures",e):e instanceof Ps?this.addRef("animations",e):e instanceof O?this.addRef("accessors",e):e instanceof Bs&&this.addRef("buffers",e),this}getAsset(){return this.get("asset")}listExtensionsUsed(){return Array.from(this.h)}listExtensionsRequired(){return this.listExtensionsUsed().filter(e=>e.isRequired())}g(e){return this.h.add(e),this}p(e){return this.h.delete(e),this}listScenes(){return this.listRefs("scenes")}setDefaultScene(e){return this.setRef("defaultScene",e)}getDefaultScene(){return this.getRef("defaultScene")}listNodes(){return this.listRefs("nodes")}listCameras(){return this.listRefs("cameras")}listSkins(){return this.listRefs("skins")}listMeshes(){return this.listRefs("meshes")}listMaterials(){return this.listRefs("materials")}listTextures(){return this.listRefs("textures")}listAnimations(){return this.listRefs("animations")}listAccessors(){return this.listRefs("accessors")}listBuffers(){return this.listRefs("buffers")}};class Jt{constructor(){this.m=new Mn,this.v=new St(this.m),this.T=Ee.DEFAULT_INSTANCE}getRoot(){return this.v}getGraph(){return this.m}getLogger(){return this.T}setLogger(e){return this.T=e,this}clone(){return new Jt().setLogger(this.T).merge(this)}merge(e){for(const n of e.getRoot().listExtensionsUsed()){const o=this.createExtension(n.constructor);n.isRequired()&&o.setRequired(!0)}const t=new Set,s=new Map;t.add(e.v),s.set(e.v,this.v);for(const n of e.m.listEdges())for(const o of[n.getParent(),n.getChild()]){if(t.has(o))continue;let a;a=o.propertyType===R.TEXTURE_INFO?o:new o.constructor(this.m),s.set(o,a),t.add(o)}const r=n=>{const o=s.get(n);if(!o)throw new Error("Could resolve property.");return o};for(const n of t){const o=s.get(n);if(!o)throw new Error("Could resolve property.");o.propertyType!==R.TEXTURE_INFO&&o.copy(n,r)}return this}async transform(...e){const t=e.map(s=>s.name);for(const s of e)await s(this,{stack:t});return this}createExtension(e){const t=e.EXTENSION_NAME;return this.getRoot().listExtensionsUsed().find(s=>s.extensionName===t)||new e(this)}createScene(e=""){return new zs(this.m,e)}createNode(e=""){return new Wt(this.m,e)}createCamera(e=""){return new ct(this.m,e)}createSkin(e=""){return new Xs(this.m,e)}createMesh(e=""){return new ks(this.m,e)}createPrimitive(){return new Je(this.m)}createPrimitiveTarget(e=""){return new Vn(this.m,e)}createMaterial(e=""){return new ut(this.m,e)}createTexture(e=""){return new Hs(this.m,e)}createAnimation(e=""){return new Ps(this.m,e)}createAnimationChannel(e=""){return new Mt(this.m,e)}createAnimationSampler(e=""){return new vt(this.m,e)}createAccessor(e="",t=null){return t||(t=this.getRoot().listBuffers()[0]),new O(this.m,e).setBuffer(t)}createBuffer(e=""){return new Bs(this.m,e)}}class D{constructor(e){this.extensionName="",this.prereadTypes=[],this.prewriteTypes=[],this.readDependencies=[],this.writeDependencies=[],this.document=void 0,this.required=!1,this.properties=new Set,this.S=void 0,this.document=e,e.getRoot().g(this),this.S=s=>{const r=s,n=r.target;n instanceof C&&n.extensionName===this.extensionName&&(r.type==="node:create"&&this.M(n),r.type==="node:dispose"&&this.I(n))};const t=e.getGraph();t.addEventListener("node:create",this.S),t.addEventListener("node:dispose",this.S)}dispose(){this.document.getRoot().p(this);const e=this.document.getGraph();e.removeEventListener("node:create",this.S),e.removeEventListener("node:dispose",this.S);for(const t of this.properties)t.dispose()}static register(){}isRequired(){return this.required}setRequired(e){return this.required=e,this}M(e){return this.properties.add(e),this}I(e){return this.properties.delete(e),this}install(e,t){return this}preread(e,t){return this}prewrite(e,t){return this}}D.EXTENSION_NAME=void 0;class kn{constructor(e){this.jsonDoc=void 0,this.buffers=[],this.bufferViews=[],this.bufferViewBuffers=[],this.accessors=[],this.textures=[],this.textureInfos=new Map,this.materials=[],this.meshes=[],this.cameras=[],this.nodes=[],this.skins=[],this.animations=[],this.scenes=[],this.jsonDoc=e}setTextureInfo(e,t){this.textureInfos.set(e,t),t.texCoord!==void 0&&e.setTexCoord(t.texCoord),t.extras!==void 0&&e.setExtras(t.extras);const s=this.jsonDoc.json.textures[t.index];if(s.sampler===void 0)return;const r=this.jsonDoc.json.samplers[s.sampler];r.magFilter!==void 0&&e.setMagFilter(r.magFilter),r.minFilter!==void 0&&e.setMinFilter(r.minFilter),r.wrapS!==void 0&&e.setWrapS(r.wrapS),r.wrapT!==void 0&&e.setWrapT(r.wrapT)}}const Gt={5120:Int8Array,5121:Uint8Array,5122:Int16Array,5123:Uint16Array,5125:Uint32Array,5126:Float32Array},as={logger:Ee.DEFAULT_INSTANCE,extensions:[],dependencies:{}};function Tt(i,e){const t=e.bufferViews[i.bufferView],s=e.jsonDoc.json.bufferViews[i.bufferView],r=Gt[i.componentType],n=O.getElementSize(i.type),o=r.BYTES_PER_ELEMENT;if(s.byteStride!==void 0&&s.byteStride!==n*o)return function(c,u){const f=u.bufferViews[c.bufferView],p=u.jsonDoc.json.bufferViews[c.bufferView],h=Gt[c.componentType],m=O.getElementSize(c.type),y=h.BYTES_PER_ELEMENT,T=c.byteOffset||0,x=new h(c.count*m),g=new DataView(f.buffer,f.byteOffset,f.byteLength),l=p.byteStride;for(let d=0;d<c.count;d++)for(let E=0;E<m;E++){const b=T+d*l+E*y;let I;switch(c.componentType){case O.ComponentType.FLOAT:I=g.getFloat32(b,!0);break;case O.ComponentType.UNSIGNED_INT:I=g.getUint32(b,!0);break;case O.ComponentType.UNSIGNED_SHORT:I=g.getUint16(b,!0);break;case O.ComponentType.UNSIGNED_BYTE:I=g.getUint8(b);break;case O.ComponentType.SHORT:I=g.getInt16(b,!0);break;case O.ComponentType.BYTE:I=g.getInt8(b);break;default:throw new Error(`Unexpected componentType "${c.componentType}".`)}x[d*m+E]=I}return x}(i,e);const a=t.byteOffset+(i.byteOffset||0);return new r(t.buffer.slice(a,a+i.count*n*o))}var at;(function(i){i[i.ARRAY_BUFFER=34962]="ARRAY_BUFFER",i[i.ELEMENT_ARRAY_BUFFER=34963]="ELEMENT_ARRAY_BUFFER"})(at||(at={}));let ue=class qs{constructor(e,t,s){this.N=void 0,this.jsonDoc=void 0,this.options=void 0,this.accessorIndexMap=new Map,this.animationIndexMap=new Map,this.bufferIndexMap=new Map,this.cameraIndexMap=new Map,this.skinIndexMap=new Map,this.materialIndexMap=new Map,this.meshIndexMap=new Map,this.nodeIndexMap=new Map,this.imageIndexMap=new Map,this.textureDefIndexMap=new Map,this.textureInfoDefMap=new Map,this.samplerDefIndexMap=new Map,this.sceneIndexMap=new Map,this.imageBufferViews=[],this.otherBufferViews=new Map,this.otherBufferViewsIndexMap=new Map,this.extensionData={},this.bufferURIGenerator=void 0,this.imageURIGenerator=void 0,this.logger=void 0,this.O=new Map,this.accessorUsageGroupedByParent=new Set(["ARRAY_BUFFER"]),this.accessorParents=new Map,this.N=e,this.jsonDoc=t,this.options=s;const r=e.getRoot(),n=r.listBuffers().length,o=r.listTextures().length;this.bufferURIGenerator=new cs(n>1,()=>s.basename||"buffer"),this.imageURIGenerator=new cs(o>1,a=>function(c,u){const f=c.getGraph().listParentEdges(u).find(p=>p.getParent()!==c.getRoot());return f?f.getName().replace(/texture$/i,""):""}(e,a)||s.basename||"texture"),this.logger=e.getLogger()}createTextureInfoDef(e,t){const s={magFilter:t.getMagFilter()||void 0,minFilter:t.getMinFilter()||void 0,wrapS:t.getWrapS(),wrapT:t.getWrapT()},r=JSON.stringify(s);this.samplerDefIndexMap.has(r)||(this.samplerDefIndexMap.set(r,this.jsonDoc.json.samplers.length),this.jsonDoc.json.samplers.push(s));const n={source:this.imageIndexMap.get(e),sampler:this.samplerDefIndexMap.get(r)},o=JSON.stringify(n);this.textureDefIndexMap.has(o)||(this.textureDefIndexMap.set(o,this.jsonDoc.json.textures.length),this.jsonDoc.json.textures.push(n));const a={index:this.textureDefIndexMap.get(o)};return t.getTexCoord()!==0&&(a.texCoord=t.getTexCoord()),Object.keys(t.getExtras()).length>0&&(a.extras=t.getExtras()),this.textureInfoDefMap.set(t,a),a}createPropertyDef(e){const t={};return e.getName()&&(t.name=e.getName()),Object.keys(e.getExtras()).length>0&&(t.extras=e.getExtras()),t}createAccessorDef(e){const t=this.createPropertyDef(e);return t.type=e.getType(),t.componentType=e.getComponentType(),t.count=e.getCount(),this.N.getGraph().listParentEdges(e).some(s=>s.getName()==="attributes"&&s.getAttributes().key==="POSITION"||s.getName()==="input")&&(t.max=e.getMax([]).map(Math.fround),t.min=e.getMin([]).map(Math.fround)),e.getNormalized()&&(t.normalized=e.getNormalized()),t}createImageData(e,t,s){if(this.options.format===J.GLB)this.imageBufferViews.push(t),e.bufferView=this.jsonDoc.json.bufferViews.length,this.jsonDoc.json.bufferViews.push({buffer:0,byteOffset:-1,byteLength:t.byteLength});else{const r=ye.mimeTypeToExtension(s.getMimeType());e.uri=this.imageURIGenerator.createURI(s,r),this.jsonDoc.resources[e.uri]=t}}getAccessorUsage(e){const t=this.O.get(e);if(t)return t;for(const s of this.N.getGraph().listParentEdges(e)){const{usage:r}=s.getAttributes();if(r)return r;s.getParent().propertyType!==R.ROOT&&this.N.getLogger().warn(`Missing attribute ".usage" on edge, "${s.getName()}".`)}return qs.BufferViewUsage.OTHER}addAccessorToUsageGroup(e,t){const s=this.O.get(e);if(s&&s!==t)throw new Error(`Accessor with usage "${s}" cannot be reused as "${t}".`);return this.O.set(e,t),this}listAccessorUsageGroups(){const e={};for(const[t,s]of Array.from(this.O.entries()))e[s]=e[s]||[],e[s].push(t);return e}};ue.BufferViewTarget=at,ue.BufferViewUsage=ie,ue.USAGE_TO_TARGET={[ie.ARRAY_BUFFER]:at.ARRAY_BUFFER,[ie.ELEMENT_ARRAY_BUFFER]:at.ELEMENT_ARRAY_BUFFER};let cs=class{constructor(e,t){this.multiple=void 0,this.basename=void 0,this.counter={},this.multiple=e,this.basename=t}createURI(e,t){if(e.getURI())return e.getURI();if(this.multiple){const s=this.basename(e);return this.counter[s]=this.counter[s]||1,`${s}_${this.counter[s]++}.${t}`}return`${this.basename(e)}.${t}`}};const{BufferViewUsage:Dt}=ue;var Nt;(function(i){i[i.JSON=1313821514]="JSON",i[i.BIN=5130562]="BIN"})(Nt||(Nt={}));let Gn=class{constructor(){this.T=Ee.DEFAULT_INSTANCE,this.h=new Set,this.C={},this.F=bt.INTERLEAVED,this.lastReadBytes=0,this.lastWriteBytes=0}setLogger(e){return this.T=e,this}registerExtensions(e){for(const t of e)this.h.add(t),t.register();return this}registerDependencies(e){return Object.assign(this.C,e),this}setVertexLayout(e){return this.F=e,this}async read(e){return await this.readJSON(await this.readAsJSON(e))}async readAsJSON(e){return e.match(/^data:application\/octet-stream;/)||this.detectFormat(e)===J.GLB?this.U(e):this.P(e)}async readJSON(e){return e=this.j(e),this.L(e),class{static read(t,s=as){const r=W({},as,s),{json:n}=t,o=new Jt;this.validate(t,r);const a=new kn(t),c=n.asset,u=o.getRoot().getAsset();c.copyright&&(u.copyright=c.copyright),c.extras&&(u.extras=c.extras),n.extras!==void 0&&o.getRoot().setExtras(W({},n.extras));const f=n.extensionsUsed||[],p=n.extensionsRequired||[];for(const l of r.extensions)if(f.includes(l.EXTENSION_NAME)){const d=o.createExtension(l).setRequired(p.includes(l.EXTENSION_NAME));for(const E of d.readDependencies)d.install(E,r.dependencies[E])}const h=n.buffers||[];o.getRoot().listExtensionsUsed().filter(l=>l.prereadTypes.includes(R.BUFFER)).forEach(l=>l.preread(a,R.BUFFER)),a.buffers=h.map(l=>{const d=o.createBuffer(l.name);return l.extras&&d.setExtras(l.extras),l.uri&&l.uri.indexOf("__")!==0&&d.setURI(l.uri),d}),a.bufferViewBuffers=(n.bufferViews||[]).map((l,d)=>{if(!a.bufferViews[d]){const E=t.json.buffers[l.buffer];a.bufferViews[d]=S.toView(E.uri?t.resources[E.uri]:t.resources["@glb.bin"],l.byteOffset||0,l.byteLength)}return a.buffers[l.buffer]}),a.accessors=(n.accessors||[]).map(l=>{const d=o.createAccessor(l.name,a.bufferViewBuffers[l.bufferView]).setType(l.type);if(l.extras&&d.setExtras(l.extras),l.normalized!==void 0&&d.setNormalized(l.normalized),l.bufferView===void 0&&!l.sparse)return d;let E;return E=l.sparse!==void 0?function(b,I){const _=Gt[b.componentType],w=O.getElementSize(b.type);let M;M=b.bufferView!==void 0?Tt(b,I):new _(b.count*w);const v=b.sparse,F=v.count,N=W({},b,v.indices,{count:F,type:"SCALAR"}),$=W({},b,v.values,{count:F}),Y=Tt(N,I),X=Tt($,I);for(let Q=0;Q<N.count;Q++)for(let re=0;re<w;re++)M[Y[Q]*w+re]=X[Q*w+re];return M}(l,a):Tt(l,a),d.setArray(E),d});const m=n.images||[],y=n.textures||[];o.getRoot().listExtensionsUsed().filter(l=>l.prereadTypes.includes(R.TEXTURE)).forEach(l=>l.preread(a,R.TEXTURE)),a.textures=m.map(l=>{const d=o.createTexture(l.name);if(l.extras&&d.setExtras(l.extras),l.bufferView!==void 0){const E=n.bufferViews[l.bufferView],b=t.json.buffers[E.buffer],I=E.byteOffset||0,_=(b.uri?t.resources[b.uri]:t.resources["@glb.bin"]).slice(I,I+E.byteLength);d.setImage(_)}else l.uri!==void 0&&(d.setImage(t.resources[l.uri]),l.uri.indexOf("__")!==0&&d.setURI(l.uri));if(l.mimeType!==void 0)d.setMimeType(l.mimeType);else if(l.uri){const E=be.extension(l.uri);d.setMimeType(ye.extensionToMimeType(E))}return d}),a.materials=(n.materials||[]).map(l=>{const d=o.createMaterial(l.name);l.extras&&d.setExtras(l.extras),l.alphaMode!==void 0&&d.setAlphaMode(l.alphaMode),l.alphaCutoff!==void 0&&d.setAlphaCutoff(l.alphaCutoff),l.doubleSided!==void 0&&d.setDoubleSided(l.doubleSided);const E=l.pbrMetallicRoughness||{};if(E.baseColorFactor!==void 0&&d.setBaseColorFactor(E.baseColorFactor),l.emissiveFactor!==void 0&&d.setEmissiveFactor(l.emissiveFactor),E.metallicFactor!==void 0&&d.setMetallicFactor(E.metallicFactor),E.roughnessFactor!==void 0&&d.setRoughnessFactor(E.roughnessFactor),E.baseColorTexture!==void 0){const b=E.baseColorTexture;d.setBaseColorTexture(a.textures[y[b.index].source]),a.setTextureInfo(d.getBaseColorTextureInfo(),b)}if(l.emissiveTexture!==void 0){const b=l.emissiveTexture;d.setEmissiveTexture(a.textures[y[b.index].source]),a.setTextureInfo(d.getEmissiveTextureInfo(),b)}if(l.normalTexture!==void 0){const b=l.normalTexture;d.setNormalTexture(a.textures[y[b.index].source]),a.setTextureInfo(d.getNormalTextureInfo(),b),l.normalTexture.scale!==void 0&&d.setNormalScale(l.normalTexture.scale)}if(l.occlusionTexture!==void 0){const b=l.occlusionTexture;d.setOcclusionTexture(a.textures[y[b.index].source]),a.setTextureInfo(d.getOcclusionTextureInfo(),b),l.occlusionTexture.strength!==void 0&&d.setOcclusionStrength(l.occlusionTexture.strength)}if(E.metallicRoughnessTexture!==void 0){const b=E.metallicRoughnessTexture;d.setMetallicRoughnessTexture(a.textures[y[b.index].source]),a.setTextureInfo(d.getMetallicRoughnessTextureInfo(),b)}return d});const T=n.meshes||[];o.getRoot().listExtensionsUsed().filter(l=>l.prereadTypes.includes(R.PRIMITIVE)).forEach(l=>l.preread(a,R.PRIMITIVE)),a.meshes=T.map(l=>{const d=o.createMesh(l.name);return l.extras&&d.setExtras(l.extras),l.weights!==void 0&&d.setWeights(l.weights),(l.primitives||[]).forEach(E=>{const b=o.createPrimitive();E.extras&&b.setExtras(E.extras),E.material!==void 0&&b.setMaterial(a.materials[E.material]),E.mode!==void 0&&b.setMode(E.mode);for(const[_,w]of Object.entries(E.attributes||{}))b.setAttribute(_,a.accessors[w]);E.indices!==void 0&&b.setIndices(a.accessors[E.indices]);const I=l.extras&&l.extras.targetNames||[];(E.targets||[]).forEach((_,w)=>{const M=I[w]||w.toString(),v=o.createPrimitiveTarget(M);for(const[F,N]of Object.entries(_))v.setAttribute(F,a.accessors[N]);b.addTarget(v)}),d.addPrimitive(b)}),d}),a.cameras=(n.cameras||[]).map(l=>{const d=o.createCamera(l.name).setType(l.type);if(l.extras&&d.setExtras(l.extras),l.type===ct.Type.PERSPECTIVE){const E=l.perspective;d.setYFov(E.yfov),d.setZNear(E.znear),E.zfar!==void 0&&d.setZFar(E.zfar),E.aspectRatio!==void 0&&d.setAspectRatio(E.aspectRatio)}else{const E=l.orthographic;d.setZNear(E.znear).setZFar(E.zfar).setXMag(E.xmag).setYMag(E.ymag)}return d});const x=n.nodes||[];o.getRoot().listExtensionsUsed().filter(l=>l.prereadTypes.includes(R.NODE)).forEach(l=>l.preread(a,R.NODE)),a.nodes=x.map(l=>{const d=o.createNode(l.name);if(l.extras&&d.setExtras(l.extras),l.translation!==void 0&&d.setTranslation(l.translation),l.rotation!==void 0&&d.setRotation(l.rotation),l.scale!==void 0&&d.setScale(l.scale),l.matrix!==void 0){const E=[0,0,0],b=[0,0,0,1],I=[1,1,1];P.decompose(l.matrix,E,b,I),d.setTranslation(E),d.setRotation(b),d.setScale(I)}return l.weights!==void 0&&d.setWeights(l.weights),d}),a.skins=(n.skins||[]).map(l=>{const d=o.createSkin(l.name);l.extras&&d.setExtras(l.extras),l.inverseBindMatrices!==void 0&&d.setInverseBindMatrices(a.accessors[l.inverseBindMatrices]),l.skeleton!==void 0&&d.setSkeleton(a.nodes[l.skeleton]);for(const E of l.joints)d.addJoint(a.nodes[E]);return d}),x.map((l,d)=>{const E=a.nodes[d];(l.children||[]).forEach(b=>E.addChild(a.nodes[b])),l.mesh!==void 0&&E.setMesh(a.meshes[l.mesh]),l.camera!==void 0&&E.setCamera(a.cameras[l.camera]),l.skin!==void 0&&E.setSkin(a.skins[l.skin])}),a.animations=(n.animations||[]).map(l=>{const d=o.createAnimation(l.name);l.extras&&d.setExtras(l.extras);const E=(l.samplers||[]).map(b=>{const I=o.createAnimationSampler().setInput(a.accessors[b.input]).setOutput(a.accessors[b.output]).setInterpolation(b.interpolation||vt.Interpolation.LINEAR);return b.extras&&I.setExtras(b.extras),d.addSampler(I),I});return(l.channels||[]).forEach(b=>{const I=o.createAnimationChannel().setSampler(E[b.sampler]).setTargetPath(b.target.path);b.target.node!==void 0&&I.setTargetNode(a.nodes[b.target.node]),b.extras&&I.setExtras(b.extras),d.addChannel(I)}),d});const g=n.scenes||[];return o.getRoot().listExtensionsUsed().filter(l=>l.prereadTypes.includes(R.SCENE)).forEach(l=>l.preread(a,R.SCENE)),a.scenes=g.map(l=>{const d=o.createScene(l.name);return l.extras&&d.setExtras(l.extras),(l.nodes||[]).map(E=>a.nodes[E]).forEach(E=>d.addChild(E)),d}),n.scene!==void 0&&o.getRoot().setDefaultScene(a.scenes[n.scene]),o.getRoot().listExtensionsUsed().forEach(l=>l.read(a)),o}static validate(t,s){const r=t.json;if(r.asset.version!=="2.0")throw new Error(`Unsupported glTF version, "${r.asset.version}".`);if(r.extensionsRequired){for(const n of r.extensionsRequired)if(!s.extensions.find(o=>o.EXTENSION_NAME===n))throw new Error(`Missing required extension, "${n}".`)}if(r.extensionsUsed)for(const n of r.extensionsUsed)s.extensions.find(o=>o.EXTENSION_NAME===n)||s.logger.warn(`Missing optional extension, "${n}".`)}}.read(e,{extensions:Array.from(this.h),dependencies:this.C,logger:this.T})}async binaryToJSON(e){const t=this._(S.assertView(e));this.L(t);const s=t.json;if(s.buffers&&s.buffers.some(r=>function(n,o){return o.uri!==void 0&&!(o.uri in n.resources)}(t,r)))throw new Error("Cannot resolve external buffers with binaryToJSON().");if(s.images&&s.images.some(r=>function(n,o){return o.uri!==void 0&&!(o.uri in n.resources)&&o.bufferView===void 0}(t,r)))throw new Error("Cannot resolve external images with binaryToJSON().");return t}async readBinary(e){return this.readJSON(await this.binaryToJSON(S.assertView(e)))}async writeJSON(e,t={}){if(t.format===J.GLB&&e.getRoot().listBuffers().length>1)throw new Error("GLB must have 0–1 buffers.");return class{static write(s,r){const n=s.getRoot(),o={asset:W({generator:"glTF-Transform v2.4.3"},n.getAsset()),extras:W({},n.getExtras())},a={json:o,resources:{}},c=new ue(s,a,r),u=r.logger||Ee.DEFAULT_INSTANCE,f=new Set(r.extensions.map(g=>g.EXTENSION_NAME)),p=s.getRoot().listExtensionsUsed().filter(g=>f.has(g.extensionName)),h=s.getRoot().listExtensionsRequired().filter(g=>f.has(g.extensionName));p.length<s.getRoot().listExtensionsUsed().length&&u.warn("Some extensions were not registered for I/O, and will not be written.");for(const g of p)for(const l of g.writeDependencies)g.install(l,r.dependencies[l]);function m(g,l,d,E){const b=[];let I=0;for(const w of g){const M=c.createAccessorDef(w);M.bufferView=o.bufferViews.length;const v=w.getArray(),F=S.pad(S.toView(v));M.byteOffset=I,I+=F.byteLength,b.push(F),c.accessorIndexMap.set(w,o.accessors.length),o.accessors.push(M)}const _={buffer:l,byteOffset:d,byteLength:S.concat(b).byteLength};return E&&(_.target=E),o.bufferViews.push(_),{buffers:b,byteLength:I}}function y(g,l,d){const E=g[0].getCount();let b=0;for(const M of g){const v=c.createAccessorDef(M);v.bufferView=o.bufferViews.length,v.byteOffset=b;const F=M.getElementSize(),N=M.getComponentSize();b+=S.padNumber(F*N),c.accessorIndexMap.set(M,o.accessors.length),o.accessors.push(v)}const I=E*b,_=new ArrayBuffer(I),w=new DataView(_);for(let M=0;M<E;M++){let v=0;for(const F of g){const N=F.getElementSize(),$=F.getComponentSize(),Y=F.getComponentType(),X=F.getArray();for(let Q=0;Q<N;Q++){const re=M*b+v+Q*$,He=X[M*N+Q];switch(Y){case O.ComponentType.FLOAT:w.setFloat32(re,He,!0);break;case O.ComponentType.BYTE:w.setInt8(re,He);break;case O.ComponentType.SHORT:w.setInt16(re,He,!0);break;case O.ComponentType.UNSIGNED_BYTE:w.setUint8(re,He);break;case O.ComponentType.UNSIGNED_SHORT:w.setUint16(re,He,!0);break;case O.ComponentType.UNSIGNED_INT:w.setUint32(re,He,!0);break;default:throw new Error("Unexpected component type: "+Y)}}v+=S.padNumber(N*$)}}return o.bufferViews.push({buffer:l,byteOffset:d,byteLength:I,byteStride:b,target:ue.BufferViewTarget.ARRAY_BUFFER}),{byteLength:I,buffers:[new Uint8Array(_)]}}const T=new Map;for(const g of s.getGraph().listEdges()){if(g.getParent()===n)continue;const l=g.getChild();if(l instanceof O){const d=T.get(l)||[];d.push(g),T.set(l,d)}}if(o.accessors=[],o.bufferViews=[],o.samplers=[],o.textures=[],o.images=n.listTextures().map((g,l)=>{const d=c.createPropertyDef(g);g.getMimeType()&&(d.mimeType=g.getMimeType());const E=g.getImage();return E&&c.createImageData(d,E,g),c.imageIndexMap.set(g,l),d}),p.filter(g=>g.prewriteTypes.includes(R.ACCESSOR)).forEach(g=>g.prewrite(c,R.ACCESSOR)),n.listAccessors().forEach(g=>{const l=c.accessorUsageGroupedByParent,d=c.accessorParents;if(c.accessorIndexMap.has(g))return;const E=T.get(g)||[],b=c.getAccessorUsage(g);if(c.addAccessorToUsageGroup(g,b),l.has(b)){const I=E[0].getParent(),_=d.get(I)||new Set;_.add(g),d.set(I,_)}}),p.filter(g=>g.prewriteTypes.includes(R.BUFFER)).forEach(g=>g.prewrite(c,R.BUFFER)),(n.listAccessors().length>0||n.listTextures().length>0||c.otherBufferViews.size>0)&&n.listBuffers().length===0)throw new Error("Buffer required for Document resources, but none was found.");o.buffers=[],n.listBuffers().forEach((g,l)=>{const d=c.createPropertyDef(g),E=c.accessorUsageGroupedByParent,b=c.accessorParents,I=g.listParents().filter(N=>N instanceof O),_=new Set(I),w=[],M=o.buffers.length;let v=0;const F=c.listAccessorUsageGroups();for(const N in F)if(E.has(N))for(const $ of Array.from(b.values())){const Y=Array.from($).filter(X=>_.has(X)).filter(X=>c.getAccessorUsage(X)===N);if(Y.length)if(N!==Dt.ARRAY_BUFFER||r.vertexLayout===bt.INTERLEAVED){const X=N===Dt.ARRAY_BUFFER?y(Y,M,v):m(Y,M,v);v+=X.byteLength,w.push(...X.buffers)}else for(const X of Y){const Q=y([X],M,v);v+=Q.byteLength,w.push(...Q.buffers)}}else{const $=F[N].filter(X=>_.has(X));if(!$.length)continue;const Y=m($,M,v,N===Dt.ELEMENT_ARRAY_BUFFER?ue.BufferViewTarget.ELEMENT_ARRAY_BUFFER:void 0);v+=Y.byteLength,w.push(...Y.buffers)}if(c.imageBufferViews.length&&l===0){for(let N=0;N<c.imageBufferViews.length;N++)if(o.bufferViews[o.images[N].bufferView].byteOffset=v,v+=c.imageBufferViews[N].byteLength,w.push(c.imageBufferViews[N]),v%8){const $=8-v%8;v+=$,w.push(new Uint8Array($))}}if(c.otherBufferViews.has(g))for(const N of c.otherBufferViews.get(g))o.bufferViews.push({buffer:M,byteOffset:v,byteLength:N.byteLength}),c.otherBufferViewsIndexMap.set(N,o.bufferViews.length-1),v+=N.byteLength,w.push(N);if(v){let N;r.format===J.GLB?N="@glb.bin":(N=c.bufferURIGenerator.createURI(g,"bin"),d.uri=N),d.byteLength=v,a.resources[N]=S.concat(w)}o.buffers.push(d),c.bufferIndexMap.set(g,l)}),n.listAccessors().find(g=>!g.getBuffer())&&u.warn("Skipped writing one or more Accessors: no Buffer assigned."),o.materials=n.listMaterials().map((g,l)=>{const d=c.createPropertyDef(g);if(g.getAlphaMode()!==ut.AlphaMode.OPAQUE&&(d.alphaMode=g.getAlphaMode()),g.getAlphaMode()===ut.AlphaMode.MASK&&(d.alphaCutoff=g.getAlphaCutoff()),g.getDoubleSided()&&(d.doubleSided=!0),d.pbrMetallicRoughness={},P.eq(g.getBaseColorFactor(),[1,1,1,1])||(d.pbrMetallicRoughness.baseColorFactor=g.getBaseColorFactor()),P.eq(g.getEmissiveFactor(),[0,0,0])||(d.emissiveFactor=g.getEmissiveFactor()),g.getRoughnessFactor()!==1&&(d.pbrMetallicRoughness.roughnessFactor=g.getRoughnessFactor()),g.getMetallicFactor()!==1&&(d.pbrMetallicRoughness.metallicFactor=g.getMetallicFactor()),g.getBaseColorTexture()){const E=g.getBaseColorTexture(),b=g.getBaseColorTextureInfo();d.pbrMetallicRoughness.baseColorTexture=c.createTextureInfoDef(E,b)}if(g.getEmissiveTexture()){const E=g.getEmissiveTexture(),b=g.getEmissiveTextureInfo();d.emissiveTexture=c.createTextureInfoDef(E,b)}if(g.getNormalTexture()){const E=g.getNormalTexture(),b=g.getNormalTextureInfo(),I=c.createTextureInfoDef(E,b);g.getNormalScale()!==1&&(I.scale=g.getNormalScale()),d.normalTexture=I}if(g.getOcclusionTexture()){const E=g.getOcclusionTexture(),b=g.getOcclusionTextureInfo(),I=c.createTextureInfoDef(E,b);g.getOcclusionStrength()!==1&&(I.strength=g.getOcclusionStrength()),d.occlusionTexture=I}if(g.getMetallicRoughnessTexture()){const E=g.getMetallicRoughnessTexture(),b=g.getMetallicRoughnessTextureInfo();d.pbrMetallicRoughness.metallicRoughnessTexture=c.createTextureInfoDef(E,b)}return c.materialIndexMap.set(g,l),d}),o.meshes=n.listMeshes().map((g,l)=>{const d=c.createPropertyDef(g);let E=null;return d.primitives=g.listPrimitives().map(b=>{const I={attributes:{}};I.mode=b.getMode();const _=b.getMaterial();_&&(I.material=c.materialIndexMap.get(_)),Object.keys(b.getExtras()).length&&(I.extras=b.getExtras());const w=b.getIndices();w&&(I.indices=c.accessorIndexMap.get(w));for(const M of b.listSemantics())I.attributes[M]=c.accessorIndexMap.get(b.getAttribute(M));for(const M of b.listTargets()){const v={};for(const F of M.listSemantics())v[F]=c.accessorIndexMap.get(M.getAttribute(F));I.targets=I.targets||[],I.targets.push(v)}return b.listTargets().length&&!E&&(E=b.listTargets().map(M=>M.getName())),I}),g.getWeights().length&&(d.weights=g.getWeights()),E&&(d.extras=d.extras||{},d.extras.targetNames=E),c.meshIndexMap.set(g,l),d}),o.cameras=n.listCameras().map((g,l)=>{const d=c.createPropertyDef(g);if(d.type=g.getType(),d.type===ct.Type.PERSPECTIVE){d.perspective={znear:g.getZNear(),zfar:g.getZFar(),yfov:g.getYFov()};const E=g.getAspectRatio();E!==null&&(d.perspective.aspectRatio=E)}else d.orthographic={znear:g.getZNear(),zfar:g.getZFar(),xmag:g.getXMag(),ymag:g.getYMag()};return c.cameraIndexMap.set(g,l),d}),o.nodes=n.listNodes().map((g,l)=>{const d=c.createPropertyDef(g);return P.eq(g.getTranslation(),[0,0,0])||(d.translation=g.getTranslation()),P.eq(g.getRotation(),[0,0,0,1])||(d.rotation=g.getRotation()),P.eq(g.getScale(),[1,1,1])||(d.scale=g.getScale()),g.getWeights().length&&(d.weights=g.getWeights()),c.nodeIndexMap.set(g,l),d}),o.skins=n.listSkins().map((g,l)=>{const d=c.createPropertyDef(g),E=g.getInverseBindMatrices();E&&(d.inverseBindMatrices=c.accessorIndexMap.get(E));const b=g.getSkeleton();return b&&(d.skeleton=c.nodeIndexMap.get(b)),d.joints=g.listJoints().map(I=>c.nodeIndexMap.get(I)),c.skinIndexMap.set(g,l),d}),n.listNodes().forEach((g,l)=>{const d=o.nodes[l],E=g.getMesh();E&&(d.mesh=c.meshIndexMap.get(E));const b=g.getCamera();b&&(d.camera=c.cameraIndexMap.get(b));const I=g.getSkin();I&&(d.skin=c.skinIndexMap.get(I)),g.listChildren().length>0&&(d.children=g.listChildren().map(_=>c.nodeIndexMap.get(_)))}),o.animations=n.listAnimations().map((g,l)=>{const d=c.createPropertyDef(g),E=new Map;return d.samplers=g.listSamplers().map((b,I)=>{const _=c.createPropertyDef(b);return _.input=c.accessorIndexMap.get(b.getInput()),_.output=c.accessorIndexMap.get(b.getOutput()),_.interpolation=b.getInterpolation(),E.set(b,I),_}),d.channels=g.listChannels().map(b=>{const I=c.createPropertyDef(b);return I.sampler=E.get(b.getSampler()),I.target={node:c.nodeIndexMap.get(b.getTargetNode()),path:b.getTargetPath()},I}),c.animationIndexMap.set(g,l),d}),o.scenes=n.listScenes().map((g,l)=>{const d=c.createPropertyDef(g);return d.nodes=g.listChildren().map(E=>c.nodeIndexMap.get(E)),c.sceneIndexMap.set(g,l),d});const x=n.getDefaultScene();return x&&(o.scene=n.listScenes().indexOf(x)),o.extensionsUsed=p.map(g=>g.extensionName),o.extensionsRequired=h.map(g=>g.extensionName),p.forEach(g=>g.write(c)),function(g){const l=[];for(const d in g){const E=g[d];(Array.isArray(E)&&E.length===0||E===null||E===""||E&&typeof E=="object"&&Object.keys(E).length===0)&&l.push(d)}for(const d of l)delete g[d]}(o),a}}.write(e,{format:t.format||J.GLTF,basename:t.basename||"",logger:this.T,vertexLayout:this.F,dependencies:W({},this.C),extensions:Array.from(this.h)})}async writeBinary(e){const{json:t,resources:s}=await this.writeJSON(e,{format:J.GLB}),r=new Uint32Array([1179937895,2,12]),n=JSON.stringify(t),o=S.pad(S.encodeText(n),32),a=S.toView(new Uint32Array([o.byteLength,1313821514])),c=S.concat([a,o]);r[r.length-1]+=c.byteLength;const u=Object.values(s)[0];if(!u||!u.byteLength)return S.concat([S.toView(r),c]);const f=S.pad(u,0),p=S.toView(new Uint32Array([f.byteLength,5130562])),h=S.concat([p,f]);return r[r.length-1]+=h.byteLength,S.concat([S.toView(r),c,h])}detectFormat(e){return(we.isAbsoluteURL(e)?we.extension(e):be.extension(e))==="glb"?J.GLB:J.GLTF}async P(e){this.lastReadBytes=0;const t=await this.readURI(e,"text");this.lastReadBytes+=t.length;const s={json:JSON.parse(t),resources:{}};return await this.D(s,this.dirname(e)),this.L(s),s}async U(e){const t=await this.readURI(e,"view");this.lastReadBytes=t.byteLength;const s=this._(t);return await this.D(s,this.dirname(e)),this.L(s),s}async D(e,t){var s=this;const r=[...e.json.images||[],...e.json.buffers||[]].map(async function(n){const o=n.uri;if(!o||o.match(/data:/))return Promise.resolve();e.resources[o]=await s.readURI(s.resolve(t,o),"view"),s.lastReadBytes+=e.resources[o].byteLength});await Promise.all(r)}L(e){function t(s){if(s.uri){if(s.uri in e.resources)S.assertView(e.resources[s.uri]);else if(s.uri.match(/data:/)){const r=`__${Ln()}.${be.extension(s.uri)}`;e.resources[r]=S.createBufferFromDataURI(s.uri),s.uri=r}}}(e.json.images||[]).forEach(s=>{if(s.bufferView===void 0&&s.uri===void 0)throw new Error("Missing resource URI or buffer view.");t(s)}),(e.json.buffers||[]).forEach(t)}j(e){const{images:t,buffers:s}=e.json;return e={json:W({},e.json),resources:W({},e.resources)},t&&(e.json.images=t.map(r=>W({},r))),s&&(e.json.buffers=s.map(r=>W({},r))),e}_(e){const t=new Uint32Array(e.buffer,e.byteOffset,3);if(t[0]!==1179937895)throw new Error("Invalid glTF asset.");if(t[1]!==2)throw new Error(`Unsupported glTF binary version, "${t[1]}".`);const s=new Uint32Array(e.buffer,e.byteOffset+12,2);if(s[1]!==Nt.JSON)throw new Error("Missing required GLB JSON chunk.");const r=s[0],n=S.decodeText(S.toView(e,20,r)),o=JSON.parse(n),a=20+r;if(e.byteLength<=a)return{json:o,resources:{}};const c=new Uint32Array(e.buffer,e.byteOffset+a,2);if(c[1]!==Nt.BIN)throw new Error("Expected GLB BIN in second chunk.");return{json:o,resources:{"@glb.bin":S.toView(e,a+8,c[0])}}}};class $n extends Gn{constructor(e=we.DEFAULT_INIT){super(),this.V=void 0,this.V=e}async readURI(e,t){const s=await fetch(e,this.V);switch(t){case"view":return new Uint8Array(await s.arrayBuffer());case"text":return s.text()}}resolve(e,t){return we.resolve(e,t)}dirname(e){return we.dirname(e)}detectFormat(e){return we.extension(e)==="glb"?J.GLB:J.GLTF}}class Ys extends C{init(){this.extensionName="EXT_mesh_gpu_instancing",this.propertyType="InstancedMesh",this.parentTypes=[R.NODE]}getDefaults(){return Object.assign(super.getDefaults(),{attributes:{}})}getAttribute(e){return this.getRefMap("attributes",e)}setAttribute(e,t){return this.setRefMap("attributes",e,t,{usage:"INSTANCE_ATTRIBUTE"})}listAttributes(){return this.listRefMapValues("attributes")}listSemantics(){return this.listRefMapKeys("attributes")}}Ys.EXTENSION_NAME="EXT_mesh_gpu_instancing";const Ce="EXT_mesh_gpu_instancing";class Zt extends D{constructor(...e){super(...e),this.extensionName=Ce,this.provideTypes=[R.NODE],this.prewriteTypes=[R.ACCESSOR]}createInstancedMesh(){return new Ys(this.document.getGraph())}read(e){return(e.jsonDoc.json.nodes||[]).forEach((t,s)=>{if(!t.extensions||!t.extensions[Ce])return;const r=t.extensions[Ce],n=this.createInstancedMesh();for(const o in r.attributes)n.setAttribute(o,e.accessors[r.attributes[o]]);e.nodes[s].setExtension(Ce,n)}),this}prewrite(e){e.accessorUsageGroupedByParent.add("INSTANCE_ATTRIBUTE");for(const t of this.properties)for(const s of t.listAttributes())e.addAccessorToUsageGroup(s,"INSTANCE_ATTRIBUTE");return this}write(e){const t=e.jsonDoc;return this.document.getRoot().listNodes().forEach(s=>{const r=s.getExtension(Ce);if(r){const n=e.nodeIndexMap.get(s),o=t.json.nodes[n],a={attributes:{}};r.listSemantics().forEach(c=>{const u=r.getAttribute(c);a.attributes[c]=e.accessorIndexMap.get(u)}),o.extensions=o.extensions||{},o.extensions[Ce]=a}}),this}}function Me(){return(Me=Object.assign||function(i){for(var e=1;e<arguments.length;e++){var t=arguments[e];for(var s in t)Object.prototype.hasOwnProperty.call(t,s)&&(i[s]=t[s])}return i}).apply(this,arguments)}var ht,Ke,V;Zt.EXTENSION_NAME=Ce,function(i){i.QUANTIZE="quantize",i.FILTER="filter"}(ht||(ht={})),function(i){i.ATTRIBUTES="ATTRIBUTES",i.TRIANGLES="TRIANGLES",i.INDICES="INDICES"}(Ke||(Ke={})),function(i){i.NONE="NONE",i.OCTAHEDRAL="OCTAHEDRAL",i.QUATERNION="QUATERNION",i.EXPONENTIAL="EXPONENTIAL"}(V||(V={}));const{BYTE:zn,SHORT:us,FLOAT:Xn}=O.ComponentType,{normalize:hs,denormalize:jt}=P;function Hn(i,e,t,s){const{filter:r,bits:n}=s,o={array:i.getArray(),byteStride:i.getElementSize()*i.getComponentSize(),componentType:i.getComponentType(),normalized:i.getNormalized()};if(t!==Ke.ATTRIBUTES)return o;if(r!==V.NONE){let a=i.getNormalized()?function(c){const u=c.getComponentType(),f=c.getArray(),p=new Float32Array(f.length);for(let h=0;h<f.length;h++)p[h]=jt(f[h],u);return p}(i):new Float32Array(o.array);switch(r){case V.EXPONENTIAL:o.byteStride=4*i.getElementSize(),o.componentType=Xn,o.normalized=!1,o.array=e.encodeFilterExp(a,i.getCount(),o.byteStride,n);break;case V.OCTAHEDRAL:o.byteStride=n>8?8:4,o.componentType=n>8?us:zn,o.normalized=!0,a=i.getElementSize()===3?function(c){const u=new Float32Array(4*c.length/3);for(let f=0,p=c.length/3;f<p;f++)u[4*f]=c[3*f],u[4*f+1]=c[3*f+1],u[4*f+2]=c[3*f+2];return u}(a):a,o.array=e.encodeFilterOct(a,i.getCount(),o.byteStride,n);break;case V.QUATERNION:o.byteStride=8,o.componentType=us,o.normalized=!0,o.array=e.encodeFilterQuat(a,i.getCount(),o.byteStride,n);break;default:throw new Error("Invalid filter.")}o.min=i.getMin([]),o.max=i.getMax([]),i.getNormalized()&&(o.min=o.min.map(c=>jt(c,i.getComponentType())),o.max=o.max.map(c=>jt(c,i.getComponentType()))),o.normalized&&(o.min=o.min.map(c=>hs(c,o.componentType)),o.max=o.max.map(c=>hs(c,o.componentType)))}else o.byteStride%4&&(o.array=function(a,c){const u=S.padNumber(a.BYTES_PER_ELEMENT*c)/a.BYTES_PER_ELEMENT,f=new a.constructor(a.length/c*u);for(let p=0;p*c<a.length;p++)for(let h=0;h<c;h++)f[p*u+h]=a[p*c+h];return f}(o.array,i.getElementSize()),o.byteStride=o.array.byteLength/i.getCount());return o}function qn(i,e){return e===ue.BufferViewUsage.ELEMENT_ARRAY_BUFFER?i.listParents().some(t=>t instanceof Je&&t.getMode()===Je.Mode.TRIANGLES)?Ke.TRIANGLES:Ke.INDICES:Ke.ATTRIBUTES}function Yn(i,e){const t=e.getGraph().listParentEdges(i).filter(s=>!(s.getParent()instanceof St));for(const s of t){const r=s.getName(),n=s.getAttributes().key||"";if(r==="indices")return{filter:V.NONE};if(r==="attributes"){if(n==="POSITION")return{filter:V.NONE};if(n==="TEXCOORD_0")return{filter:V.NONE};if(n==="NORMAL")return{filter:V.OCTAHEDRAL,bits:8};if(n==="TANGENT")return{filter:V.OCTAHEDRAL,bits:8};if(n.startsWith("JOINTS_"))return{filter:V.NONE};if(n.startsWith("WEIGHTS_"))return{filter:V.NONE}}if(r==="output"){const o=Ks(i);return o==="rotation"?{filter:V.QUATERNION,bits:16}:o==="translation"||o==="scale"?{filter:V.EXPONENTIAL,bits:12}:{filter:V.NONE}}if(r==="input")return{filter:V.NONE};if(r==="inverseBindMatrices")return{filter:V.NONE}}return{filter:V.NONE}}function Ks(i){for(const e of i.listParents())if(e instanceof vt){for(const t of e.listParents())if(t instanceof Mt)return t.getTargetPath()}return null}const H="EXT_meshopt_compression",ls={method:ht.QUANTIZE};class $t extends D{constructor(...e){super(...e),this.extensionName=H,this.prereadTypes=[R.BUFFER,R.PRIMITIVE],this.prewriteTypes=[R.BUFFER,R.ACCESSOR],this.readDependencies=["meshopt.decoder"],this.writeDependencies=["meshopt.encoder"],this._decoder=null,this._decoderFallbackBufferMap=new Map,this._encoder=null,this._encoderOptions=ls,this._encoderFallbackBuffer=null,this._encoderBufferViews={},this._encoderBufferViewData={},this._encoderBufferViewAccessors={}}install(e,t){return e==="meshopt.decoder"&&(this._decoder=t),e==="meshopt.encoder"&&(this._encoder=t),this}setEncoderOptions(e){return this._encoderOptions=Me({},ls,e),this}preread(e,t){if(!this._decoder){if(!this.isRequired())return this;throw new Error(`[${H}] Please install extension dependency, "meshopt.decoder".`)}if(!this._decoder.supported){if(!this.isRequired())return this;throw new Error(`[${H}]: Missing WASM support.`)}return t===R.BUFFER?this._prereadBuffers(e):t===R.PRIMITIVE&&this._prereadPrimitives(e),this}_prereadBuffers(e){const t=e.jsonDoc;(t.json.bufferViews||[]).forEach((s,r)=>{if(!s.extensions||!s.extensions[H])return;const n=s.extensions[H],o=n.byteOffset||0,a=n.byteLength||0,c=n.count,u=n.byteStride,f=new Uint8Array(c*u),p=t.json.buffers[s.buffer],h=S.toView(p.uri?t.resources[p.uri]:t.resources[Os],o,a);this._decoder.decodeGltfBuffer(f,c,u,h,n.mode,n.filter),e.bufferViews[r]=f})}_prereadPrimitives(e){const t=e.jsonDoc;(t.json.bufferViews||[]).forEach(s=>{var r;s.extensions&&s.extensions[H]&&(r=t.json.buffers[s.buffer]).extensions&&r.extensions.EXT_meshopt_compression&&r.extensions.EXT_meshopt_compression.fallback&&this._decoderFallbackBufferMap.set(e.buffers[s.buffer],e.buffers[s.extensions[H].buffer])})}read(e){if(!this.isRequired())return this;for(const[t,s]of this._decoderFallbackBufferMap){for(const r of t.listParents())r instanceof O&&r.swap(t,s);t.dispose()}return this}prewrite(e,t){return t===R.ACCESSOR?this._prewriteAccessors(e):t===R.BUFFER&&this._prewriteBuffers(e),this}_prewriteAccessors(e){const t=e.jsonDoc.json,s=this._encoder,r=this._encoderOptions,n=this.document.createBuffer(),o=this.document.getRoot().listBuffers().indexOf(n);this._encoderFallbackBuffer=n,this._encoderBufferViews={},this._encoderBufferViewData={},this._encoderBufferViewAccessors={};for(const a of this.document.getRoot().listAccessors()){if(Ks(a)==="weights")continue;const c=e.getAccessorUsage(a),u=qn(a,c),f=r.method===ht.FILTER?Yn(a,this.document):{filter:V.NONE},p=Hn(a,s,u,f),{array:h,byteStride:m}=p,y=a.getBuffer();if(!y)throw new Error(`${H}: Missing buffer for accessor.`);const T=this.document.getRoot().listBuffers().indexOf(y),x=[c,u,f.filter,m,T].join(":");let g=this._encoderBufferViews[x],l=this._encoderBufferViewData[x],d=this._encoderBufferViewAccessors[x];g&&l||(d=this._encoderBufferViewAccessors[x]=[],l=this._encoderBufferViewData[x]=[],g=this._encoderBufferViews[x]={buffer:o,target:ue.USAGE_TO_TARGET[c],byteOffset:0,byteLength:0,byteStride:c===ue.BufferViewUsage.ARRAY_BUFFER?m:void 0,extensions:{[H]:{buffer:T,byteOffset:0,byteLength:0,mode:u,filter:f.filter!==V.NONE?f.filter:void 0,byteStride:m,count:0}}});const E=e.createAccessorDef(a);E.componentType=p.componentType,E.normalized=p.normalized,E.byteOffset=g.byteLength,E.min&&p.min&&(E.min=p.min),E.max&&p.max&&(E.max=p.max),e.accessorIndexMap.set(a,t.accessors.length),t.accessors.push(E),d.push(E),l.push(new Uint8Array(h.buffer,h.byteOffset,h.byteLength)),g.byteLength+=h.byteLength,g.extensions.EXT_meshopt_compression.count+=a.getCount()}}_prewriteBuffers(e){const t=this._encoder;for(const s in this._encoderBufferViews){const r=this._encoderBufferViews[s],n=this._encoderBufferViewData[s],o=this.document.getRoot().listBuffers()[r.extensions[H].buffer],a=e.otherBufferViews.get(o)||[],{count:c,byteStride:u,mode:f}=r.extensions[H],p=S.concat(n),h=t.encodeGltfBuffer(p,c,u,f),m=S.pad(h);r.extensions[H].byteLength=h.byteLength,n.length=0,n.push(m),a.push(m),e.otherBufferViews.set(o,a)}}write(e){let t=0;for(const o in this._encoderBufferViews){const a=this._encoderBufferViews[o],c=e.otherBufferViewsIndexMap.get(this._encoderBufferViewData[o][0]),u=this._encoderBufferViewAccessors[o];for(const h of u)h.bufferView=c;const f=e.jsonDoc.json.bufferViews[c],p=f.byteOffset||0;Object.assign(f,a),f.byteOffset=t,f.extensions[H].byteOffset=p,t+=S.padNumber(a.byteLength)}const s=this._encoderFallbackBuffer,r=e.bufferIndexMap.get(s),n=e.jsonDoc.json.buffers[r];return n.byteLength=t,n.extensions={[H]:{fallback:!0}},s.dispose(),this}}$t.EXTENSION_NAME=H,$t.EncoderMethod=ht;const nt="EXT_texture_webp";class Kn{match(e){return e.length>=12&&e[8]===87&&e[9]===69&&e[10]===66&&e[11]===80}getSize(e){const t=S.decodeText(e.slice(0,4)),s=S.decodeText(e.slice(8,12));if(t!=="RIFF"||s!=="WEBP")return null;const r=new DataView(e.buffer,e.byteOffset);let n=12;for(;n<r.byteLength;){const o=S.decodeText(new Uint8Array([r.getUint8(n),r.getUint8(n+1),r.getUint8(n+2),r.getUint8(n+3)])),a=r.getUint32(n+4,!0);if(o==="VP8 ")return[16383&r.getInt16(n+14,!0),16383&r.getInt16(n+16,!0)];if(o==="VP8L"){const c=r.getUint8(n+9),u=r.getUint8(n+10),f=r.getUint8(n+11);return[1+((63&u)<<8|c),1+((15&r.getUint8(n+12))<<10|f<<2|(192&u)>>6)]}n+=8+a+a%2}return null}getChannels(e){return 4}}class Ws extends D{constructor(...e){super(...e),this.extensionName=nt,this.prereadTypes=[R.TEXTURE]}static register(){ye.registerFormat("image/webp",new Kn)}preread(e){return(e.jsonDoc.json.textures||[]).forEach(t=>{t.extensions&&t.extensions[nt]&&(t.source=t.extensions[nt].source)}),this}read(e){return this}write(e){const t=e.jsonDoc;return this.document.getRoot().listTextures().forEach(s=>{if(s.getMimeType()==="image/webp"){const r=e.imageIndexMap.get(s);(t.json.textures||[]).forEach(n=>{n.source===r&&(n.extensions=n.extensions||{},n.extensions[nt]={source:n.source},delete n.source)})}}),this}}Ws.EXTENSION_NAME=nt;const fs="KHR_draco_mesh_compression";let G,Js,Zs,K;function Wn(i,e){const t=new G.DecoderBuffer;try{if(t.Init(e,e.length),i.GetEncodedGeometryType(t)!==G.TRIANGULAR_MESH)throw new Error(`[${fs}] Unknown geometry type.`);const s=new G.Mesh;if(!i.DecodeBufferToMesh(t,s).ok()||s.ptr===0)throw new Error(`[${fs}] Decoding failure.`);return s}finally{G.destroy(t)}}function Jn(i,e){const t=3*e.num_faces();let s,r;if(e.num_points()<=65534){const n=t*Uint16Array.BYTES_PER_ELEMENT;s=G._malloc(n),i.GetTrianglesUInt16Array(e,n,s),r=new Uint16Array(G.HEAPU16.buffer,s,t).slice()}else{const n=t*Uint32Array.BYTES_PER_ELEMENT;s=G._malloc(n),i.GetTrianglesUInt32Array(e,n,s),r=new Uint32Array(G.HEAPU32.buffer,s,t).slice()}return G._free(s),r}function Zn(i,e,t,s){const r=Zs[s.componentType],n=Js[s.componentType],o=t.num_components(),a=e.num_points()*o,c=a*n.BYTES_PER_ELEMENT,u=G._malloc(c);i.GetAttributeDataArrayForAllPoints(e,t,r,c,u);const f=new n(G.HEAPF32.buffer,u,a).slice();return G._free(u),f}var lt,se;(function(i){i[i.EDGEBREAKER=1]="EDGEBREAKER",i[i.SEQUENTIAL=0]="SEQUENTIAL"})(lt||(lt={})),function(i){i.POSITION="POSITION",i.NORMAL="NORMAL",i.COLOR="COLOR",i.TEX_COORD="TEX_COORD",i.GENERIC="GENERIC"}(se||(se={}));const Qs={[se.POSITION]:14,[se.NORMAL]:10,[se.COLOR]:8,[se.TEX_COORD]:12,[se.GENERIC]:12},gs={decodeSpeed:5,encodeSpeed:5,method:lt.EDGEBREAKER,quantizationBits:Qs,quantizationVolume:"mesh"};function Qn(i,e=gs){const t=Me({},gs,e);t.quantizationBits=Me({},Qs,e.quantizationBits);const s=new K.Encoder,r=new K.MeshBuilder,n=new K.Mesh,o={},a=new K.DracoInt8Array;for(const y of i.listSemantics()){const T=i.getAttribute(y),x=ei(y),g=ti(r,T.getComponentType(),n,K[x],T.getCount(),T.getElementSize(),T.getArray());if(g===-1)throw new Error(`Error compressing "${y}" attribute.`);if(o[y]=g,t.quantizationVolume==="mesh"||y!=="POSITION")s.SetAttributeQuantization(K[x],t.quantizationBits[x]);else{if(typeof t.quantizationVolume!="object")throw new Error("Invalid quantization volume state.");{const{quantizationVolume:l}=t,d=Math.max(l.max[0]-l.min[0],l.max[1]-l.min[1],l.max[2]-l.min[2]);s.SetAttributeExplicitQuantization(K[x],t.quantizationBits[x],T.getElementSize(),l.min,d)}}}const c=i.getIndices();if(!c)throw new Error("Primitive must have indices.");r.AddFacesToMesh(n,c.getCount()/3,c.getArray()),s.SetSpeedOptions(t.encodeSpeed,t.decodeSpeed),s.SetTrackEncodedProperties(!0),t.method===lt.SEQUENTIAL||i.listTargets().length>0?s.SetEncodingMethod(K.MESH_SEQUENTIAL_ENCODING):s.SetEncodingMethod(K.MESH_EDGEBREAKER_ENCODING);const u=s.EncodeMeshToDracoBuffer(n,a);if(u<=0)throw new Error("Error applying Draco compression.");const f=new Uint8Array(u);for(let y=0;y<u;++y)f[y]=a.GetValue(y);const p=i.getAttribute("POSITION").getCount(),h=s.GetNumberOfEncodedPoints(),m=3*s.GetNumberOfEncodedFaces();if(i.listTargets().length>0&&h!==p)throw new Error('Compression reduced vertex count unexpectedly, corrupting morph targets. Applying the "weld" function before compression may resolve the issue.');return K.destroy(a),K.destroy(n),K.destroy(r),K.destroy(s),{numVertices:h,numIndices:m,data:f,attributeIDs:o}}function ei(i){return i==="POSITION"?se.POSITION:i==="NORMAL"?se.NORMAL:i.startsWith("COLOR_")?se.COLOR:i.startsWith("TEXCOORD_")?se.TEX_COORD:se.GENERIC}function ti(i,e,t,s,r,n,o){switch(e){case O.ComponentType.UNSIGNED_BYTE:return i.AddUInt8Attribute(t,s,r,n,o);case O.ComponentType.BYTE:return i.AddInt8Attribute(t,s,r,n,o);case O.ComponentType.UNSIGNED_SHORT:return i.AddUInt16Attribute(t,s,r,n,o);case O.ComponentType.SHORT:return i.AddInt16Attribute(t,s,r,n,o);case O.ComponentType.UNSIGNED_INT:return i.AddUInt32Attribute(t,s,r,n,o);case O.ComponentType.FLOAT:return i.AddFloatAttribute(t,s,r,n,o);default:throw new Error(`Unexpected component type, "${e}".`)}}const k="KHR_draco_mesh_compression";class zt extends D{constructor(...e){super(...e),this.extensionName=k,this.prereadTypes=[R.PRIMITIVE],this.prewriteTypes=[R.ACCESSOR],this.readDependencies=["draco3d.decoder"],this.writeDependencies=["draco3d.encoder"],this._decoderModule=null,this._encoderModule=null,this._encoderOptions={}}install(e,t){return e==="draco3d.decoder"&&(this._decoderModule=t,G=this._decoderModule,Js={[O.ComponentType.FLOAT]:Float32Array,[O.ComponentType.UNSIGNED_INT]:Uint32Array,[O.ComponentType.UNSIGNED_SHORT]:Uint16Array,[O.ComponentType.UNSIGNED_BYTE]:Uint8Array,[O.ComponentType.SHORT]:Int16Array,[O.ComponentType.BYTE]:Int8Array},Zs={[O.ComponentType.FLOAT]:G.DT_FLOAT32,[O.ComponentType.UNSIGNED_INT]:G.DT_UINT32,[O.ComponentType.UNSIGNED_SHORT]:G.DT_UINT16,[O.ComponentType.UNSIGNED_BYTE]:G.DT_UINT8,[O.ComponentType.SHORT]:G.DT_INT16,[O.ComponentType.BYTE]:G.DT_INT8}),e==="draco3d.encoder"&&(this._encoderModule=t,K=this._encoderModule),this}setEncoderOptions(e){return this._encoderOptions=e,this}preread(e){if(!this._decoderModule)throw new Error(`[${k}] Please install extension dependency, "draco3d.decoder".`);const t=this.document.getLogger(),s=e.jsonDoc,r=new Map;try{const n=s.json.meshes||[];for(const o of n)for(const a of o.primitives){if(!a.extensions||!a.extensions[k])continue;const c=a.extensions[k];let[u,f]=r.get(c.bufferView)||[];if(!f||!u){const p=s.json.bufferViews[c.bufferView],h=s.json.buffers[p.buffer],m=S.toView(h.uri?s.resources[h.uri]:s.resources[Os],p.byteOffset||0,p.byteLength);u=new this._decoderModule.Decoder,f=Wn(u,m),r.set(c.bufferView,[u,f]),t.debug(`[${k}] Decompressed ${m.byteLength} bytes.`)}for(const p in a.attributes){const h=e.jsonDoc.json.accessors[a.attributes[p]],m=u.GetAttributeByUniqueId(f,c.attributes[p]),y=Zn(u,f,m,h);e.accessors[a.attributes[p]].setArray(y)}a.indices!==void 0&&e.accessors[a.indices].setArray(Jn(u,f))}}finally{for(const[n,o]of Array.from(r.values()))this._decoderModule.destroy(n),this._decoderModule.destroy(o)}return this}read(e){return this}prewrite(e,t){if(!this._encoderModule)throw new Error(`[${k}] Please install extension dependency, "draco3d.encoder".`);const s=this.document.getLogger();s.debug(`[${k}] Compression options: ${JSON.stringify(this._encoderOptions)}`);const r=function(a){const c=a.getLogger(),u=new Set,f=new Set;for(const x of a.getRoot().listMeshes())for(const g of x.listPrimitives())g.getIndices()?g.getMode()!==Je.Mode.TRIANGLES?(f.add(g),c.warn(`[${k}] Skipping Draco compression on non-TRIANGLES primitive.`)):u.add(g):(f.add(g),c.warn(`[${k}] Skipping Draco compression on non-indexed primitive.`));const p=a.getRoot().listAccessors(),h=new Map;for(let x=0;x<p.length;x++)h.set(p[x],x);const m=new Map,y=new Set,T=new Map;for(const x of Array.from(u)){let g=ps(x,h);if(y.has(g))T.set(x,g);else{if(m.has(x.getIndices())){const l=x.getIndices(),d=l.clone();h.set(d,a.getRoot().listAccessors().length-1),x.swap(l,d)}for(const l of x.listAttributes())if(m.has(l)){const d=l.clone();h.set(d,a.getRoot().listAccessors().length-1),x.swap(l,d)}g=ps(x,h),y.add(g),T.set(x,g),m.set(x.getIndices(),g);for(const l of x.listAttributes())m.set(l,g)}}for(const x of Array.from(m.keys())){const g=new Set(x.listParents().map(l=>l.propertyType));if(g.size!==2||!g.has(R.PRIMITIVE)||!g.has(R.ROOT))throw new Error(`[${k}] Compressed accessors must only be used as indices or vertex attributes.`)}for(const x of Array.from(u)){const g=T.get(x),l=x.getIndices();if(m.get(l)!==g||x.listAttributes().some(d=>m.get(d)!==g))throw new Error(`[${k}] Draco primitives must share all, or no, accessors.`)}for(const x of Array.from(f)){const g=x.getIndices();if(m.has(g)||x.listAttributes().some(l=>m.has(l)))throw new Error(`[${k}] Accessor cannot be shared by compressed and uncompressed primitives.`)}return T}(this.document),n=new Map;let o="mesh";this._encoderOptions.quantizationVolume==="scene"&&(this.document.getRoot().listScenes().length!==1?s.warn(`[${k}]: quantizationVolume=scene requires exactly 1 scene.`):o=Sn(this.document.getRoot().listScenes().pop()));for(const a of Array.from(r.keys())){const c=r.get(a);if(!c)throw new Error("Unexpected primitive.");if(n.has(c)){n.set(c,n.get(c));continue}const u=a.getIndices(),f=e.jsonDoc.json.accessors,p=Qn(a,Me({},this._encoderOptions,{quantizationVolume:o}));n.set(c,p);const h=e.createAccessorDef(u);h.count=p.numIndices,e.accessorIndexMap.set(u,f.length),f.push(h);for(const y of a.listSemantics()){const T=a.getAttribute(y),x=e.createAccessorDef(T);x.count=p.numVertices,e.accessorIndexMap.set(T,f.length),f.push(x)}const m=a.getAttribute("POSITION").getBuffer()||this.document.getRoot().listBuffers()[0];e.otherBufferViews.has(m)||e.otherBufferViews.set(m,[]),e.otherBufferViews.get(m).push(p.data)}return s.debug(`[${k}] Compressed ${r.size} primitives.`),e.extensionData[k]={primitiveHashMap:r,primitiveEncodingMap:n},this}write(e){const t=e.extensionData[k];for(const s of this.document.getRoot().listMeshes()){const r=e.jsonDoc.json.meshes[e.meshIndexMap.get(s)];for(let n=0;n<s.listPrimitives().length;n++){const o=s.listPrimitives()[n],a=r.primitives[n],c=t.primitiveHashMap.get(o);if(!c)continue;const u=t.primitiveEncodingMap.get(c);a.extensions=a.extensions||{},a.extensions[k]={bufferView:e.otherBufferViewsIndexMap.get(u.data),attributes:u.attributeIDs}}}if(!t.primitiveHashMap.size){const s=e.jsonDoc.json;s.extensionsUsed=(s.extensionsUsed||[]).filter(r=>r!==k),s.extensionsRequired=(s.extensionsRequired||[]).filter(r=>r!==k)}return this}}function ps(i,e){const t=[],s=i.getIndices();t.push(e.get(s));for(const r of i.listAttributes())t.push(e.get(r));return t.sort().join("|")}zt.EXTENSION_NAME=k,zt.EncoderMethod=lt;class Ze extends C{init(){this.extensionName="KHR_lights_punctual",this.propertyType="Light",this.parentTypes=[R.NODE]}getDefaults(){return Object.assign(super.getDefaults(),{color:[1,1,1],intensity:1,type:Ze.Type.POINT,range:null,innerConeAngle:0,outerConeAngle:Math.PI/4})}getColor(){return this.get("color")}setColor(e){return this.set("color",e)}getColorHex(){return Z.factorToHex(this.getColor())}setColorHex(e){const t=this.getColor().slice();return Z.hexToFactor(e,t),this.setColor(t)}getIntensity(){return this.get("intensity")}setIntensity(e){return this.set("intensity",e)}getType(){return this.get("type")}setType(e){return this.set("type",e)}getRange(){return this.get("range")}setRange(e){return this.set("range",e)}getInnerConeAngle(){return this.get("innerConeAngle")}setInnerConeAngle(e){return this.set("innerConeAngle",e)}getOuterConeAngle(){return this.get("outerConeAngle")}setOuterConeAngle(e){return this.set("outerConeAngle",e)}}Ze.EXTENSION_NAME="KHR_lights_punctual",Ze.Type={POINT:"point",SPOT:"spot",DIRECTIONAL:"directional"};const ae="KHR_lights_punctual";class er extends D{constructor(...e){super(...e),this.extensionName=ae}createLight(e=""){return new Ze(this.document.getGraph(),e)}read(e){const t=e.jsonDoc;if(!t.json.extensions||!t.json.extensions[ae])return this;const s=(t.json.extensions[ae].lights||[]).map(r=>{var n,o;const a=this.createLight().setName(r.name||"").setType(r.type);return r.color!==void 0&&a.setColor(r.color),r.intensity!==void 0&&a.setIntensity(r.intensity),r.range!==void 0&&a.setRange(r.range),((n=r.spot)==null?void 0:n.innerConeAngle)!==void 0&&a.setInnerConeAngle(r.spot.innerConeAngle),((o=r.spot)==null?void 0:o.outerConeAngle)!==void 0&&a.setOuterConeAngle(r.spot.outerConeAngle),a});return t.json.nodes.forEach((r,n)=>{r.extensions&&r.extensions[ae]&&e.nodes[n].setExtension(ae,s[r.extensions[ae].light])}),this}write(e){const t=e.jsonDoc;if(this.properties.size===0)return this;const s=[],r=new Map;for(const n of this.properties){const o=n,a={type:o.getType()};P.eq(o.getColor(),[1,1,1])||(a.color=o.getColor()),o.getIntensity()!==1&&(a.intensity=o.getIntensity()),o.getRange()!=null&&(a.range=o.getRange()),o.getName()&&(a.name=o.getName()),o.getType()===Ze.Type.SPOT&&(a.spot={innerConeAngle:o.getInnerConeAngle(),outerConeAngle:o.getOuterConeAngle()}),s.push(a),r.set(o,s.length-1)}return this.document.getRoot().listNodes().forEach(n=>{const o=n.getExtension(ae);if(o){const a=e.nodeIndexMap.get(n),c=t.json.nodes[a];c.extensions=c.extensions||{},c.extensions[ae]={light:r.get(o)}}}),t.json.extensions=t.json.extensions||{},t.json.extensions[ae]={lights:s},this}}er.EXTENSION_NAME=ae;const{R:ds,G:ms,B:si}=he;class tr extends C{init(){this.extensionName="KHR_materials_clearcoat",this.propertyType="Clearcoat",this.parentTypes=[R.MATERIAL]}getDefaults(){return Object.assign(super.getDefaults(),{clearcoatFactor:0,clearcoatTexture:null,clearcoatTextureInfo:new U(this.graph,"clearcoatTextureInfo"),clearcoatRoughnessFactor:0,clearcoatRoughnessTexture:null,clearcoatRoughnessTextureInfo:new U(this.graph,"clearcoatRoughnessTextureInfo"),clearcoatNormalScale:1,clearcoatNormalTexture:null,clearcoatNormalTextureInfo:new U(this.graph,"clearcoatNormalTextureInfo")})}getClearcoatFactor(){return this.get("clearcoatFactor")}setClearcoatFactor(e){return this.set("clearcoatFactor",e)}getClearcoatTexture(){return this.getRef("clearcoatTexture")}getClearcoatTextureInfo(){return this.getRef("clearcoatTexture")?this.getRef("clearcoatTextureInfo"):null}setClearcoatTexture(e){return this.setRef("clearcoatTexture",e,{channels:ds})}getClearcoatRoughnessFactor(){return this.get("clearcoatRoughnessFactor")}setClearcoatRoughnessFactor(e){return this.set("clearcoatRoughnessFactor",e)}getClearcoatRoughnessTexture(){return this.getRef("clearcoatRoughnessTexture")}getClearcoatRoughnessTextureInfo(){return this.getRef("clearcoatRoughnessTexture")?this.getRef("clearcoatRoughnessTextureInfo"):null}setClearcoatRoughnessTexture(e){return this.setRef("clearcoatRoughnessTexture",e,{channels:ms})}getClearcoatNormalScale(){return this.get("clearcoatNormalScale")}setClearcoatNormalScale(e){return this.set("clearcoatNormalScale",e)}getClearcoatNormalTexture(){return this.getRef("clearcoatNormalTexture")}getClearcoatNormalTextureInfo(){return this.getRef("clearcoatNormalTexture")?this.getRef("clearcoatNormalTextureInfo"):null}setClearcoatNormalTexture(e){return this.setRef("clearcoatNormalTexture",e,{channels:ds|ms|si})}}tr.EXTENSION_NAME="KHR_materials_clearcoat";const De="KHR_materials_clearcoat";class sr extends D{constructor(...e){super(...e),this.extensionName=De}createClearcoat(){return new tr(this.document.getGraph())}read(e){const t=e.jsonDoc,s=t.json.textures||[];return(t.json.materials||[]).forEach((r,n)=>{if(r.extensions&&r.extensions[De]){const o=this.createClearcoat();e.materials[n].setExtension(De,o);const a=r.extensions[De];if(a.clearcoatFactor!==void 0&&o.setClearcoatFactor(a.clearcoatFactor),a.clearcoatRoughnessFactor!==void 0&&o.setClearcoatRoughnessFactor(a.clearcoatRoughnessFactor),a.clearcoatTexture!==void 0){const c=a.clearcoatTexture;o.setClearcoatTexture(e.textures[s[c.index].source]),e.setTextureInfo(o.getClearcoatTextureInfo(),c)}if(a.clearcoatRoughnessTexture!==void 0){const c=a.clearcoatRoughnessTexture;o.setClearcoatRoughnessTexture(e.textures[s[c.index].source]),e.setTextureInfo(o.getClearcoatRoughnessTextureInfo(),c)}if(a.clearcoatNormalTexture!==void 0){const c=a.clearcoatNormalTexture;o.setClearcoatNormalTexture(e.textures[s[c.index].source]),e.setTextureInfo(o.getClearcoatNormalTextureInfo(),c),c.scale!==void 0&&o.setClearcoatNormalScale(c.scale)}}}),this}write(e){const t=e.jsonDoc;return this.document.getRoot().listMaterials().forEach(s=>{const r=s.getExtension(De);if(r){const n=e.materialIndexMap.get(s),o=t.json.materials[n];o.extensions=o.extensions||{};const a=o.extensions[De]={clearcoatFactor:r.getClearcoatFactor(),clearcoatRoughnessFactor:r.getClearcoatRoughnessFactor()};if(r.getClearcoatTexture()){const c=r.getClearcoatTexture(),u=r.getClearcoatTextureInfo();a.clearcoatTexture=e.createTextureInfoDef(c,u)}if(r.getClearcoatRoughnessTexture()){const c=r.getClearcoatRoughnessTexture(),u=r.getClearcoatRoughnessTextureInfo();a.clearcoatRoughnessTexture=e.createTextureInfoDef(c,u)}if(r.getClearcoatNormalTexture()){const c=r.getClearcoatNormalTexture(),u=r.getClearcoatNormalTextureInfo();a.clearcoatNormalTexture=e.createTextureInfoDef(c,u),r.getClearcoatNormalScale()!==1&&(a.clearcoatNormalTexture.scale=r.getClearcoatNormalScale())}}}),this}}sr.EXTENSION_NAME=De;class rr extends C{init(){this.extensionName="KHR_materials_emissive_strength",this.propertyType="EmissiveStrength",this.parentTypes=[R.MATERIAL]}getDefaults(){return Object.assign(super.getDefaults(),{emissiveStrength:1})}getEmissiveStrength(){return this.get("emissiveStrength")}setEmissiveStrength(e){return this.set("emissiveStrength",e)}}rr.EXTENSION_NAME="KHR_materials_emissive_strength";const je="KHR_materials_emissive_strength";class nr extends D{constructor(...e){super(...e),this.extensionName=je}createEmissiveStrength(){return new rr(this.document.getGraph())}read(e){return(e.jsonDoc.json.materials||[]).forEach((t,s)=>{if(t.extensions&&t.extensions[je]){const r=this.createEmissiveStrength();e.materials[s].setExtension(je,r);const n=t.extensions[je];n.emissiveStrength!==void 0&&r.setEmissiveStrength(n.emissiveStrength)}}),this}write(e){const t=e.jsonDoc;return this.document.getRoot().listMaterials().forEach(s=>{const r=s.getExtension(je);if(r){const n=e.materialIndexMap.get(s),o=t.json.materials[n];o.extensions=o.extensions||{},o.extensions[je]={emissiveStrength:r.getEmissiveStrength()}}}),this}}nr.EXTENSION_NAME=je;class ir extends C{init(){this.extensionName="KHR_materials_ior",this.propertyType="IOR",this.parentTypes=[R.MATERIAL]}getDefaults(){return Object.assign(super.getDefaults(),{ior:0})}getIOR(){return this.get("ior")}setIOR(e){return this.set("ior",e)}}ir.EXTENSION_NAME="KHR_materials_ior";const Fe="KHR_materials_ior";class or extends D{constructor(...e){super(...e),this.extensionName=Fe}createIOR(){return new ir(this.document.getGraph())}read(e){return(e.jsonDoc.json.materials||[]).forEach((t,s)=>{if(t.extensions&&t.extensions[Fe]){const r=this.createIOR();e.materials[s].setExtension(Fe,r);const n=t.extensions[Fe];n.ior!==void 0&&r.setIOR(n.ior)}}),this}write(e){const t=e.jsonDoc;return this.document.getRoot().listMaterials().forEach(s=>{const r=s.getExtension(Fe);if(r){const n=e.materialIndexMap.get(s),o=t.json.materials[n];o.extensions=o.extensions||{},o.extensions[Fe]={ior:r.getIOR()}}}),this}}or.EXTENSION_NAME=Fe;const{R:ri,G:ni}=he;class ar extends C{init(){this.extensionName="KHR_materials_iridescence",this.propertyType="Iridescence",this.parentTypes=[R.MATERIAL]}getDefaults(){return Object.assign(super.getDefaults(),{iridescenceFactor:0,iridescenceTexture:null,iridescenceTextureInfo:new U(this.graph,"iridescenceTextureInfo"),iridescenceIOR:1.3,iridescenceThicknessMinimum:100,iridescenceThicknessMaximum:400,iridescenceThicknessTexture:null,iridescenceThicknessTextureInfo:new U(this.graph,"iridescenceThicknessTextureInfo")})}getIridescenceFactor(){return this.get("iridescenceFactor")}setIridescenceFactor(e){return this.set("iridescenceFactor",e)}getIridescenceTexture(){return this.getRef("iridescenceTexture")}getIridescenceTextureInfo(){return this.getRef("iridescenceTexture")?this.getRef("iridescenceTextureInfo"):null}setIridescenceTexture(e){return this.setRef("iridescenceTexture",e,{channels:ri})}getIridescenceIOR(){return this.get("iridescenceIOR")}setIridescenceIOR(e){return this.set("iridescenceIOR",e)}getIridescenceThicknessMinimum(){return this.get("iridescenceThicknessMinimum")}setIridescenceThicknessMinimum(e){return this.set("iridescenceThicknessMinimum",e)}getIridescenceThicknessMaximum(){return this.get("iridescenceThicknessMaximum")}setIridescenceThicknessMaximum(e){return this.set("iridescenceThicknessMaximum",e)}getIridescenceThicknessTexture(){return this.getRef("iridescenceThicknessTexture")}getIridescenceThicknessTextureInfo(){return this.getRef("iridescenceThicknessTexture")?this.getRef("iridescenceThicknessTextureInfo"):null}setIridescenceThicknessTexture(e){return this.setRef("iridescenceThicknessTexture",e,{channels:ni})}}ar.EXTENSION_NAME="KHR_materials_iridescence";const Pe="KHR_materials_iridescence";class cr extends D{constructor(...e){super(...e),this.extensionName=Pe}createIridescence(){return new ar(this.document.getGraph())}read(e){const t=e.jsonDoc,s=t.json.textures||[];return(t.json.materials||[]).forEach((r,n)=>{if(r.extensions&&r.extensions[Pe]){const o=this.createIridescence();e.materials[n].setExtension(Pe,o);const a=r.extensions[Pe];if(a.iridescenceFactor!==void 0&&o.setIridescenceFactor(a.iridescenceFactor),a.iridescenceIor!==void 0&&o.setIridescenceIOR(a.iridescenceIor),a.iridescenceThicknessMinimum!==void 0&&o.setIridescenceThicknessMinimum(a.iridescenceThicknessMinimum),a.iridescenceThicknessMaximum!==void 0&&o.setIridescenceThicknessMaximum(a.iridescenceThicknessMaximum),a.iridescenceTexture!==void 0){const c=a.iridescenceTexture;o.setIridescenceTexture(e.textures[s[c.index].source]),e.setTextureInfo(o.getIridescenceTextureInfo(),c)}if(a.iridescenceThicknessTexture!==void 0){const c=a.iridescenceThicknessTexture;o.setIridescenceThicknessTexture(e.textures[s[c.index].source]),e.setTextureInfo(o.getIridescenceThicknessTextureInfo(),c)}}}),this}write(e){const t=e.jsonDoc;return this.document.getRoot().listMaterials().forEach(s=>{const r=s.getExtension(Pe);if(r){const n=e.materialIndexMap.get(s),o=t.json.materials[n];o.extensions=o.extensions||{};const a=o.extensions[Pe]={};if(r.getIridescenceFactor()>0&&(a.iridescenceFactor=r.getIridescenceFactor()),r.getIridescenceIOR()!==1.3&&(a.iridescenceIor=r.getIridescenceIOR()),r.getIridescenceThicknessMinimum()!==100&&(a.iridescenceThicknessMinimum=r.getIridescenceThicknessMinimum()),r.getIridescenceThicknessMaximum()!==400&&(a.iridescenceThicknessMaximum=r.getIridescenceThicknessMaximum()),r.getIridescenceTexture()){const c=r.getIridescenceTexture(),u=r.getIridescenceTextureInfo();a.iridescenceTexture=e.createTextureInfoDef(c,u)}if(r.getIridescenceThicknessTexture()){const c=r.getIridescenceThicknessTexture(),u=r.getIridescenceThicknessTextureInfo();a.iridescenceThicknessTexture=e.createTextureInfoDef(c,u)}}}),this}}cr.EXTENSION_NAME=Pe;const{R:xs,G:Ts,B:Es,A:ys}=he;class ur extends C{init(){this.extensionName="KHR_materials_pbrSpecularGlossiness",this.propertyType="PBRSpecularGlossiness",this.parentTypes=[R.MATERIAL]}getDefaults(){return Object.assign(super.getDefaults(),{diffuseFactor:[1,1,1,1],diffuseTexture:null,diffuseTextureInfo:new U(this.graph,"diffuseTextureInfo"),specularFactor:[1,1,1],glossinessFactor:1,specularGlossinessTexture:null,specularGlossinessTextureInfo:new U(this.graph,"specularGlossinessTextureInfo")})}getDiffuseFactor(){return this.get("diffuseFactor")}setDiffuseFactor(e){return this.set("diffuseFactor",e)}getDiffuseHex(){return Z.factorToHex(this.getDiffuseFactor())}setDiffuseHex(e){const t=this.getDiffuseFactor().slice();return this.setDiffuseFactor(Z.hexToFactor(e,t))}getDiffuseTexture(){return this.getRef("diffuseTexture")}getDiffuseTextureInfo(){return this.getRef("diffuseTexture")?this.getRef("diffuseTextureInfo"):null}setDiffuseTexture(e){return this.setRef("diffuseTexture",e,{channels:xs|Ts|Es|ys})}getSpecularFactor(){return this.get("specularFactor")}setSpecularFactor(e){return this.set("specularFactor",e)}getGlossinessFactor(){return this.get("glossinessFactor")}setGlossinessFactor(e){return this.set("glossinessFactor",e)}getSpecularGlossinessTexture(){return this.getRef("specularGlossinessTexture")}getSpecularGlossinessTextureInfo(){return this.getRef("specularGlossinessTexture")?this.getRef("specularGlossinessTextureInfo"):null}setSpecularGlossinessTexture(e){return this.setRef("specularGlossinessTexture",e,{channels:xs|Ts|Es|ys})}}ur.EXTENSION_NAME="KHR_materials_pbrSpecularGlossiness";const Le="KHR_materials_pbrSpecularGlossiness";class hr extends D{constructor(...e){super(...e),this.extensionName=Le}createPBRSpecularGlossiness(){return new ur(this.document.getGraph())}read(e){const t=e.jsonDoc,s=t.json.textures||[];return(t.json.materials||[]).forEach((r,n)=>{if(r.extensions&&r.extensions[Le]){const o=this.createPBRSpecularGlossiness();e.materials[n].setExtension(Le,o);const a=r.extensions[Le];if(a.diffuseFactor!==void 0&&o.setDiffuseFactor(a.diffuseFactor),a.specularFactor!==void 0&&o.setSpecularFactor(a.specularFactor),a.glossinessFactor!==void 0&&o.setGlossinessFactor(a.glossinessFactor),a.diffuseTexture!==void 0){const c=a.diffuseTexture;o.setDiffuseTexture(e.textures[s[c.index].source]),e.setTextureInfo(o.getDiffuseTextureInfo(),c)}if(a.specularGlossinessTexture!==void 0){const c=a.specularGlossinessTexture;o.setSpecularGlossinessTexture(e.textures[s[c.index].source]),e.setTextureInfo(o.getSpecularGlossinessTextureInfo(),c)}}}),this}write(e){const t=e.jsonDoc;return this.document.getRoot().listMaterials().forEach(s=>{const r=s.getExtension(Le);if(r){const n=e.materialIndexMap.get(s),o=t.json.materials[n];o.extensions=o.extensions||{};const a=o.extensions[Le]={diffuseFactor:r.getDiffuseFactor(),specularFactor:r.getSpecularFactor(),glossinessFactor:r.getGlossinessFactor()};if(r.getDiffuseTexture()){const c=r.getDiffuseTexture(),u=r.getDiffuseTextureInfo();a.diffuseTexture=e.createTextureInfoDef(c,u)}if(r.getSpecularGlossinessTexture()){const c=r.getSpecularGlossinessTexture(),u=r.getSpecularGlossinessTextureInfo();a.specularGlossinessTexture=e.createTextureInfoDef(c,u)}}}),this}}hr.EXTENSION_NAME=Le;const{R:ii,G:oi,B:ai,A:ci}=he;class lr extends C{init(){this.extensionName="KHR_materials_sheen",this.propertyType="Sheen",this.parentTypes=[R.MATERIAL]}getDefaults(){return Object.assign(super.getDefaults(),{sheenColorFactor:[0,0,0],sheenColorTexture:null,sheenColorTextureInfo:new U(this.graph,"sheenColorTextureInfo"),sheenRoughnessFactor:0,sheenRoughnessTexture:null,sheenRoughnessTextureInfo:new U(this.graph,"sheenRoughnessTextureInfo")})}getSheenColorFactor(){return this.get("sheenColorFactor")}getSheenColorHex(){return Z.factorToHex(this.getSheenColorFactor())}setSheenColorFactor(e){return this.set("sheenColorFactor",e)}setSheenColorHex(e){const t=this.getSheenColorFactor().slice();return this.set("sheenColorFactor",Z.hexToFactor(e,t))}getSheenColorTexture(){return this.getRef("sheenColorTexture")}getSheenColorTextureInfo(){return this.getRef("sheenColorTexture")?this.getRef("sheenColorTextureInfo"):null}setSheenColorTexture(e){return this.setRef("sheenColorTexture",e,{channels:ii|oi|ai})}getSheenRoughnessFactor(){return this.get("sheenRoughnessFactor")}setSheenRoughnessFactor(e){return this.set("sheenRoughnessFactor",e)}getSheenRoughnessTexture(){return this.getRef("sheenRoughnessTexture")}getSheenRoughnessTextureInfo(){return this.getRef("sheenRoughnessTexture")?this.getRef("sheenRoughnessTextureInfo"):null}setSheenRoughnessTexture(e){return this.setRef("sheenRoughnessTexture",e,{channels:ci})}}lr.EXTENSION_NAME="KHR_materials_sheen";const Be="KHR_materials_sheen";class fr extends D{constructor(...e){super(...e),this.extensionName=Be}createSheen(){return new lr(this.document.getGraph())}read(e){const t=e.jsonDoc,s=t.json.textures||[];return(t.json.materials||[]).forEach((r,n)=>{if(r.extensions&&r.extensions[Be]){const o=this.createSheen();e.materials[n].setExtension(Be,o);const a=r.extensions[Be];if(a.sheenColorFactor!==void 0&&o.setSheenColorFactor(a.sheenColorFactor),a.sheenRoughnessFactor!==void 0&&o.setSheenRoughnessFactor(a.sheenRoughnessFactor),a.sheenColorTexture!==void 0){const c=a.sheenColorTexture;o.setSheenColorTexture(e.textures[s[c.index].source]),e.setTextureInfo(o.getSheenColorTextureInfo(),c)}if(a.sheenRoughnessTexture!==void 0){const c=a.sheenRoughnessTexture;o.setSheenRoughnessTexture(e.textures[s[c.index].source]),e.setTextureInfo(o.getSheenRoughnessTextureInfo(),c)}}}),this}write(e){const t=e.jsonDoc;return this.document.getRoot().listMaterials().forEach(s=>{const r=s.getExtension(Be);if(r){const n=e.materialIndexMap.get(s),o=t.json.materials[n];o.extensions=o.extensions||{};const a=o.extensions[Be]={sheenColorFactor:r.getSheenColorFactor(),sheenRoughnessFactor:r.getSheenRoughnessFactor()};if(r.getSheenColorTexture()){const c=r.getSheenColorTexture(),u=r.getSheenColorTextureInfo();a.sheenColorTexture=e.createTextureInfoDef(c,u)}if(r.getSheenRoughnessTexture()){const c=r.getSheenRoughnessTexture(),u=r.getSheenRoughnessTextureInfo();a.sheenRoughnessTexture=e.createTextureInfoDef(c,u)}}}),this}}fr.EXTENSION_NAME=Be;const{R:ui,G:hi,B:li,A:fi}=he;class gr extends C{init(){this.extensionName="KHR_materials_specular",this.propertyType="Specular",this.parentTypes=[R.MATERIAL]}getDefaults(){return Object.assign(super.getDefaults(),{specularFactor:1,specularTexture:null,specularTextureInfo:new U(this.graph,"specularTextureInfo"),specularColorFactor:[1,1,1],specularColorTexture:null,specularColorTextureInfo:new U(this.graph,"specularColorTextureInfo")})}getSpecularFactor(){return this.get("specularFactor")}setSpecularFactor(e){return this.set("specularFactor",e)}getSpecularColorFactor(){return this.get("specularColorFactor")}setSpecularColorFactor(e){return this.set("specularColorFactor",e)}getSpecularColorHex(){return Z.factorToHex(this.getSpecularColorFactor())}setSpecularColorHex(e){const t=this.getSpecularColorFactor().slice();return this.set("specularColorFactor",Z.hexToFactor(e,t))}getSpecularTexture(){return this.getRef("specularTexture")}getSpecularTextureInfo(){return this.getRef("specularTexture")?this.getRef("specularTextureInfo"):null}setSpecularTexture(e){return this.setRef("specularTexture",e,{channels:fi})}getSpecularColorTexture(){return this.getRef("specularColorTexture")}getSpecularColorTextureInfo(){return this.getRef("specularColorTexture")?this.getRef("specularColorTextureInfo"):null}setSpecularColorTexture(e){return this.setRef("specularColorTexture",e,{channels:ui|hi|li})}}gr.EXTENSION_NAME="KHR_materials_specular";const Ue="KHR_materials_specular";class pr extends D{constructor(...e){super(...e),this.extensionName=Ue}createSpecular(){return new gr(this.document.getGraph())}read(e){const t=e.jsonDoc,s=t.json.textures||[];return(t.json.materials||[]).forEach((r,n)=>{if(r.extensions&&r.extensions[Ue]){const o=this.createSpecular();e.materials[n].setExtension(Ue,o);const a=r.extensions[Ue];if(a.specularFactor!==void 0&&o.setSpecularFactor(a.specularFactor),a.specularColorFactor!==void 0&&o.setSpecularColorFactor(a.specularColorFactor),a.specularTexture!==void 0){const c=a.specularTexture;o.setSpecularTexture(e.textures[s[c.index].source]),e.setTextureInfo(o.getSpecularTextureInfo(),c)}if(a.specularColorTexture!==void 0){const c=a.specularColorTexture;o.setSpecularColorTexture(e.textures[s[c.index].source]),e.setTextureInfo(o.getSpecularColorTextureInfo(),c)}}}),this}write(e){const t=e.jsonDoc;return this.document.getRoot().listMaterials().forEach(s=>{const r=s.getExtension(Ue);if(r){const n=e.materialIndexMap.get(s),o=t.json.materials[n];o.extensions=o.extensions||{};const a=o.extensions[Ue]={};if(r.getSpecularFactor()!==1&&(a.specularFactor=r.getSpecularFactor()),P.eq(r.getSpecularColorFactor(),[1,1,1])||(a.specularColorFactor=r.getSpecularColorFactor()),r.getSpecularTexture()){const c=r.getSpecularTexture(),u=r.getSpecularTextureInfo();a.specularTexture=e.createTextureInfoDef(c,u)}if(r.getSpecularColorTexture()){const c=r.getSpecularColorTexture(),u=r.getSpecularColorTextureInfo();a.specularColorTexture=e.createTextureInfoDef(c,u)}}}),this}}pr.EXTENSION_NAME=Ue;const{R:gi}=he;class dr extends C{init(){this.extensionName="KHR_materials_transmission",this.propertyType="Transmission",this.parentTypes=[R.MATERIAL]}getDefaults(){return Object.assign(super.getDefaults(),{transmissionFactor:0,transmissionTexture:null,transmissionTextureInfo:new U(this.graph,"transmissionTextureInfo")})}getTransmissionFactor(){return this.get("transmissionFactor")}setTransmissionFactor(e){return this.set("transmissionFactor",e)}getTransmissionTexture(){return this.getRef("transmissionTexture")}getTransmissionTextureInfo(){return this.getRef("transmissionTexture")?this.getRef("transmissionTextureInfo"):null}setTransmissionTexture(e){return this.setRef("transmissionTexture",e,{channels:gi})}}dr.EXTENSION_NAME="KHR_materials_transmission";const Ve="KHR_materials_transmission";class mr extends D{constructor(...e){super(...e),this.extensionName=Ve}createTransmission(){return new dr(this.document.getGraph())}read(e){const t=e.jsonDoc,s=t.json.textures||[];return(t.json.materials||[]).forEach((r,n)=>{if(r.extensions&&r.extensions[Ve]){const o=this.createTransmission();e.materials[n].setExtension(Ve,o);const a=r.extensions[Ve];if(a.transmissionFactor!==void 0&&o.setTransmissionFactor(a.transmissionFactor),a.transmissionTexture!==void 0){const c=a.transmissionTexture;o.setTransmissionTexture(e.textures[s[c.index].source]),e.setTextureInfo(o.getTransmissionTextureInfo(),c)}}}),this}write(e){const t=e.jsonDoc;return this.document.getRoot().listMaterials().forEach(s=>{const r=s.getExtension(Ve);if(r){const n=e.materialIndexMap.get(s),o=t.json.materials[n];o.extensions=o.extensions||{};const a=o.extensions[Ve]={transmissionFactor:r.getTransmissionFactor()};if(r.getTransmissionTexture()){const c=r.getTransmissionTexture(),u=r.getTransmissionTextureInfo();a.transmissionTexture=e.createTextureInfoDef(c,u)}}}),this}}mr.EXTENSION_NAME=Ve;class xr extends C{init(){this.extensionName="KHR_materials_unlit",this.propertyType="Unlit",this.parentTypes=[R.MATERIAL]}}xr.EXTENSION_NAME="KHR_materials_unlit";const qe="KHR_materials_unlit";class Tr extends D{constructor(...e){super(...e),this.extensionName=qe}createUnlit(){return new xr(this.document.getGraph())}read(e){return(e.jsonDoc.json.materials||[]).forEach((t,s)=>{t.extensions&&t.extensions[qe]&&e.materials[s].setExtension(qe,this.createUnlit())}),this}write(e){const t=e.jsonDoc;return this.document.getRoot().listMaterials().forEach(s=>{if(s.getExtension(qe)){const r=e.materialIndexMap.get(s),n=t.json.materials[r];n.extensions=n.extensions||{},n.extensions[qe]={}}}),this}}Tr.EXTENSION_NAME=qe;class Er extends C{init(){this.extensionName="KHR_materials_variants",this.propertyType="Mapping",this.parentTypes=["MappingList"]}getDefaults(){return Object.assign(super.getDefaults(),{material:null,variants:[]})}getMaterial(){return this.getRef("material")}setMaterial(e){return this.setRef("material",e)}addVariant(e){return this.addRef("variants",e)}removeVariant(e){return this.removeRef("variants",e)}listVariants(){return this.listRefs("variants")}}Er.EXTENSION_NAME="KHR_materials_variants";class yr extends C{init(){this.extensionName="KHR_materials_variants",this.propertyType="MappingList",this.parentTypes=[R.PRIMITIVE]}getDefaults(){return Object.assign(super.getDefaults(),{mappings:[]})}addMapping(e){return this.addRef("mappings",e)}removeMapping(e){return this.removeRef("mappings",e)}listMappings(){return this.listRefs("mappings")}}yr.EXTENSION_NAME="KHR_materials_variants";class Xt extends C{init(){this.extensionName="KHR_materials_variants",this.propertyType="Variant",this.parentTypes=["MappingList"]}}Xt.EXTENSION_NAME="KHR_materials_variants";const ce="KHR_materials_variants";class br extends D{constructor(...e){super(...e),this.extensionName=ce}createMappingList(){return new yr(this.document.getGraph())}createVariant(e=""){return new Xt(this.document.getGraph(),e)}createMapping(){return new Er(this.document.getGraph())}listVariants(){return Array.from(this.properties).filter(e=>e instanceof Xt)}read(e){const t=e.jsonDoc;if(!t.json.extensions||!t.json.extensions[ce])return this;const s=(t.json.extensions[ce].variants||[]).map(r=>this.createVariant().setName(r.name||""));return(t.json.meshes||[]).forEach((r,n)=>{const o=e.meshes[n];(r.primitives||[]).forEach((a,c)=>{if(!a.extensions||!a.extensions[ce])return;const u=this.createMappingList(),f=a.extensions[ce];for(const p of f.mappings){const h=this.createMapping();p.material!==void 0&&h.setMaterial(e.materials[p.material]);for(const m of p.variants||[])h.addVariant(s[m]);u.addMapping(h)}o.listPrimitives()[c].setExtension(ce,u)})}),this}write(e){const t=e.jsonDoc,s=this.listVariants();if(!s.length)return this;const r=[],n=new Map;for(const o of s)n.set(o,r.length),r.push(e.createPropertyDef(o));for(const o of this.document.getRoot().listMeshes()){const a=e.meshIndexMap.get(o);o.listPrimitives().forEach((c,u)=>{const f=c.getExtension(ce);if(!f)return;const p=e.jsonDoc.json.meshes[a].primitives[u],h=f.listMappings().map(m=>{const y=e.createPropertyDef(m),T=m.getMaterial();return T&&(y.material=e.materialIndexMap.get(T)),y.variants=m.listVariants().map(x=>n.get(x)),y});p.extensions=p.extensions||{},p.extensions[ce]={mappings:h}})}return t.json.extensions=t.json.extensions||{},t.json.extensions[ce]={variants:r},this}}br.EXTENSION_NAME=ce;const{G:pi}=he;class Rr extends C{init(){this.extensionName="KHR_materials_volume",this.propertyType="Volume",this.parentTypes=[R.MATERIAL]}getDefaults(){return Object.assign(super.getDefaults(),{thicknessFactor:0,thicknessTexture:null,thicknessTextureInfo:new U(this.graph,"thicknessTexture"),attenuationDistance:1/0,attenuationColor:[1,1,1]})}getThicknessFactor(){return this.get("thicknessFactor")}setThicknessFactor(e){return this.set("thicknessFactor",e)}getThicknessTexture(){return this.getRef("thicknessTexture")}getThicknessTextureInfo(){return this.getRef("thicknessTexture")?this.getRef("thicknessTextureInfo"):null}setThicknessTexture(e){return this.setRef("thicknessTexture",e,{channels:pi})}getAttenuationDistance(){return this.get("attenuationDistance")}setAttenuationDistance(e){return this.set("attenuationDistance",e)}getAttenuationColor(){return this.get("attenuationColor")}setAttenuationColor(e){return this.set("attenuationColor",e)}getAttenuationColorHex(){return Z.factorToHex(this.getAttenuationColor())}setAttenuationColorHex(e){const t=this.getAttenuationColor().slice();return this.set("attenuationColor",Z.hexToFactor(e,t))}}Rr.EXTENSION_NAME="KHR_materials_volume";const ke="KHR_materials_volume";class Ir extends D{constructor(...e){super(...e),this.extensionName=ke}createVolume(){return new Rr(this.document.getGraph())}read(e){const t=e.jsonDoc,s=t.json.textures||[];return(t.json.materials||[]).forEach((r,n)=>{if(r.extensions&&r.extensions[ke]){const o=this.createVolume();e.materials[n].setExtension(ke,o);const a=r.extensions[ke];if(a.thicknessFactor!==void 0&&o.setThicknessFactor(a.thicknessFactor),a.attenuationDistance!==void 0&&o.setAttenuationDistance(a.attenuationDistance),a.attenuationColor!==void 0&&o.setAttenuationColor(a.attenuationColor),a.thicknessTexture!==void 0){const c=a.thicknessTexture;o.setThicknessTexture(e.textures[s[c.index].source]),e.setTextureInfo(o.getThicknessTextureInfo(),c)}}}),this}write(e){const t=e.jsonDoc;return this.document.getRoot().listMaterials().forEach(s=>{const r=s.getExtension(ke);if(r){const n=e.materialIndexMap.get(s),o=t.json.materials[n];o.extensions=o.extensions||{};const a=o.extensions[ke]={};if(r.getThicknessFactor()>0&&(a.thicknessFactor=r.getThicknessFactor()),Number.isFinite(r.getAttenuationDistance())&&(a.attenuationDistance=r.getAttenuationDistance()),P.eq(r.getAttenuationColor(),[1,1,1])||(a.attenuationColor=r.getAttenuationColor()),r.getThicknessTexture()){const c=r.getThicknessTexture(),u=r.getThicknessTextureInfo();a.thicknessTexture=e.createTextureInfoDef(c,u)}}}),this}}Ir.EXTENSION_NAME=ke;const Nr="KHR_mesh_quantization";class Ar extends D{constructor(...e){super(...e),this.extensionName=Nr}read(e){return this}write(e){return this}}Ar.EXTENSION_NAME=Nr;const it="KHR_texture_basisu";class di{match(e){return e[0]===171&&e[1]===75&&e[2]===84&&e[3]===88&&e[4]===32&&e[5]===50&&e[6]===48&&e[7]===187&&e[8]===13&&e[9]===10&&e[10]===26&&e[11]===10}getSize(e){const t=Ct(e);return[t.pixelWidth,t.pixelHeight]}getChannels(e){const t=Ct(e).dataFormatDescriptor[0];if(t.colorModel===In)return t.samples.length===2&&(15&t.samples[1].channelType)==15?4:3;if(t.colorModel===Nn)return(15&t.samples[0].channelType)==3?4:3;throw new Error(`Unexpected KTX2 colorModel, "${t.colorModel}".`)}getGPUByteLength(e){const t=Ct(e),s=this.getChannels(e)>3;let r=0;for(let n=0;n<t.levels.length;n++){const o=t.levels[n];r+=o.uncompressedByteLength?o.uncompressedByteLength:Math.max(1,Math.floor(t.pixelWidth/Math.pow(2,n)))/4*(Math.max(1,Math.floor(t.pixelHeight/Math.pow(2,n)))/4)*(s?16:8)}return r}}class Qt extends D{constructor(...e){super(...e),this.extensionName=it,this.prereadTypes=[R.TEXTURE]}static register(){ye.registerFormat("image/ktx2",new di)}preread(e){return e.jsonDoc.json.textures.forEach(t=>{t.extensions&&t.extensions[it]&&(t.source=t.extensions[it].source)}),this}read(e){return this}write(e){const t=e.jsonDoc;return this.document.getRoot().listTextures().forEach(s=>{if(s.getMimeType()==="image/ktx2"){const r=e.imageIndexMap.get(s);t.json.textures.forEach(n=>{n.source===r&&(n.extensions=n.extensions||{},n.extensions[it]={source:n.source},delete n.source)})}}),this}}Qt.EXTENSION_NAME=it;let _r=class extends C{init(){this.extensionName="KHR_texture_transform",this.propertyType="Transform",this.parentTypes=[R.TEXTURE_INFO]}getDefaults(){return Object.assign(super.getDefaults(),{offset:[0,0],rotation:0,scale:[1,1],texCoord:null})}getOffset(){return this.get("offset")}setOffset(e){return this.set("offset",e)}getRotation(){return this.get("rotation")}setRotation(e){return this.set("rotation",e)}getScale(){return this.get("scale")}setScale(e){return this.set("scale",e)}getTexCoord(){return this.get("texCoord")}setTexCoord(e){return this.set("texCoord",e)}};_r.EXTENSION_NAME="KHR_texture_transform";const Ge="KHR_texture_transform";class wr extends D{constructor(...e){super(...e),this.extensionName=Ge}createTransform(){return new _r(this.document.getGraph())}read(e){for(const[t,s]of Array.from(e.textureInfos.entries())){if(!s.extensions||!s.extensions[Ge])continue;const r=this.createTransform(),n=s.extensions[Ge];n.offset!==void 0&&r.setOffset(n.offset),n.rotation!==void 0&&r.setRotation(n.rotation),n.scale!==void 0&&r.setScale(n.scale),n.texCoord!==void 0&&r.setTexCoord(n.texCoord),t.setExtension(Ge,r)}return this}write(e){const t=Array.from(e.textureInfoDefMap.entries());for(const[s,r]of t){const n=s.getExtension(Ge);if(!n)continue;r.extensions=r.extensions||{};const o={},a=P.eq;a(n.getOffset(),[0,0])||(o.offset=n.getOffset()),n.getRotation()!==0&&(o.rotation=n.getRotation()),a(n.getScale(),[1,1])||(o.scale=n.getScale()),n.getTexCoord()!=null&&(o.texCoord=n.getTexCoord()),r.extensions[Ge]=o}return this}}wr.EXTENSION_NAME=Ge;const mi=[R.ROOT,R.SCENE,R.NODE,R.MESH,R.MATERIAL,R.TEXTURE,R.ANIMATION];class Mr extends C{init(){this.extensionName="KHR_xmp_json_ld",this.propertyType="Packet",this.parentTypes=mi}getDefaults(){return Object.assign(super.getDefaults(),{context:{},properties:{}})}getContext(){return this.get("context")}setContext(e){return this.set("context",Me({},e))}listProperties(){return Object.keys(this.get("properties"))}getProperty(e){const t=this.get("properties");return e in t?t[e]:null}setProperty(e,t){this._assertContext(e);const s=Me({},this.get("properties"));return t?s[e]=t:delete s[e],this.set("properties",s)}toJSONLD(){return Me({"@context":Ft(this.get("context"))},Ft(this.get("properties")))}fromJSONLD(e){const t=(e=Ft(e))["@context"];return t&&this.set("context",t),delete e["@context"],this.set("properties",e)}_assertContext(e){if(!(e.split(":")[0]in this.get("context")))throw new Error(`KHR_xmp_json_ld: Missing context for term, "${e}".`)}}function Ft(i){return JSON.parse(JSON.stringify(i))}Mr.EXTENSION_NAME="KHR_xmp_json_ld";const fe="KHR_xmp_json_ld";class vr extends D{constructor(...e){super(...e),this.extensionName=fe}createPacket(){return new Mr(this.document.getGraph())}listPackets(){return Array.from(this.properties)}read(e){var t;const s=(t=e.jsonDoc.json.extensions)==null?void 0:t[fe];if(!s||!s.packets)return this;const r=e.jsonDoc.json,n=this.document.getRoot(),o=s.packets.map(u=>this.createPacket().fromJSONLD(u)),a=[[r.asset],r.scenes,r.nodes,r.meshes,r.materials,r.images,r.animations],c=[[n],n.listScenes(),n.listNodes(),n.listMeshes(),n.listMaterials(),n.listTextures(),n.listAnimations()];for(let u=0;u<a.length;u++){const f=a[u]||[];for(let p=0;p<f.length;p++){const h=f[p];h.extensions&&h.extensions[fe]&&c[u][p].setExtension(fe,o[h.extensions[fe].packet])}}return this}write(e){const{json:t}=e.jsonDoc,s=[];for(const r of this.properties){s.push(r.toJSONLD());for(const n of r.listParents()){let o;switch(n.propertyType){case R.ROOT:o=t.asset;break;case R.SCENE:o=t.scenes[e.sceneIndexMap.get(n)];break;case R.NODE:o=t.nodes[e.nodeIndexMap.get(n)];break;case R.MESH:o=t.meshes[e.meshIndexMap.get(n)];break;case R.MATERIAL:o=t.materials[e.materialIndexMap.get(n)];break;case R.TEXTURE:o=t.images[e.imageIndexMap.get(n)];break;case R.ANIMATION:o=t.animations[e.animationIndexMap.get(n)];break;default:o=null,this.document.getLogger().warn(`[${fe}]: Unsupported parent property, "${n.propertyType}"`)}o&&(o.extensions=o.extensions||{},o.extensions[fe]={packet:s.length-1})}}return s.length>0&&(t.extensions=t.extensions||{},t.extensions[fe]={packets:s}),this}}vr.EXTENSION_NAME=fe;const xi=[zt,er,sr,nr,or,cr,hr,pr,fr,mr,Tr,br,Ir,Ar,Qt,wr,vr],Ti=[Zt,$t,Ws,...xi];function Ei(i){for(var e=new Array(i),t=0;t<i;++t)e[t]=t;return e}var yi=Ei;/*!
 * Determine if an object is a Buffer
 *
 * @author   Feross Aboukhadijeh <https://feross.org>
 * @license  MIT
 */var bi=function(i){return i!=null&&(Sr(i)||Ri(i)||!!i._isBuffer)};function Sr(i){return!!i.constructor&&typeof i.constructor.isBuffer=="function"&&i.constructor.isBuffer(i)}function Ri(i){return typeof i.readFloatLE=="function"&&typeof i.slice=="function"&&Sr(i.slice(0,0))}var Ii=yi,Ni=bi,Ai=typeof Float64Array<"u";function _i(i,e){return i[0]-e[0]}function wi(){var i=this.stride,e=new Array(i.length),t;for(t=0;t<e.length;++t)e[t]=[Math.abs(i[t]),t];e.sort(_i);var s=new Array(e.length);for(t=0;t<s.length;++t)s[t]=e[t][1];return s}function Mi(i,e){var t=["View",e,"d",i].join("");e<0&&(t="View_Nil"+i);var s=i==="generic";if(e===-1){var r="function "+t+"(a){this.data=a;};var proto="+t+".prototype;proto.dtype='"+i+"';proto.index=function(){return -1};proto.size=0;proto.dimension=-1;proto.shape=proto.stride=proto.order=[];proto.lo=proto.hi=proto.transpose=proto.step=function(){return new "+t+"(this.data);};proto.get=proto.set=function(){};proto.pick=function(){return null};return function construct_"+t+"(a){return new "+t+"(a);}",T=new Function(r);return T()}else if(e===0){var r="function "+t+"(a,d) {this.data = a;this.offset = d};var proto="+t+".prototype;proto.dtype='"+i+"';proto.index=function(){return this.offset};proto.dimension=0;proto.size=1;proto.shape=proto.stride=proto.order=[];proto.lo=proto.hi=proto.transpose=proto.step=function "+t+"_copy() {return new "+t+"(this.data,this.offset)};proto.pick=function "+t+"_pick(){return TrivialArray(this.data);};proto.valueOf=proto.get=function "+t+"_get(){return "+(s?"this.data.get(this.offset)":"this.data[this.offset]")+"};proto.set=function "+t+"_set(v){return "+(s?"this.data.set(this.offset,v)":"this.data[this.offset]=v")+"};return function construct_"+t+"(a,b,c,d){return new "+t+"(a,d)}",T=new Function("TrivialArray",r);return T(At[i][0])}var r=["'use strict'"],n=Ii(e),o=n.map(function(x){return"i"+x}),a="this.offset+"+n.map(function(x){return"this.stride["+x+"]*i"+x}).join("+"),c=n.map(function(x){return"b"+x}).join(","),u=n.map(function(x){return"c"+x}).join(",");r.push("function "+t+"(a,"+c+","+u+",d){this.data=a","this.shape=["+c+"]","this.stride=["+u+"]","this.offset=d|0}","var proto="+t+".prototype","proto.dtype='"+i+"'","proto.dimension="+e),r.push("Object.defineProperty(proto,'size',{get:function "+t+"_size(){return "+n.map(function(x){return"this.shape["+x+"]"}).join("*"),"}})"),e===1?r.push("proto.order=[0]"):(r.push("Object.defineProperty(proto,'order',{get:"),e<4?(r.push("function "+t+"_order(){"),e===2?r.push("return (Math.abs(this.stride[0])>Math.abs(this.stride[1]))?[1,0]:[0,1]}})"):e===3&&r.push("var s0=Math.abs(this.stride[0]),s1=Math.abs(this.stride[1]),s2=Math.abs(this.stride[2]);if(s0>s1){if(s1>s2){return [2,1,0];}else if(s0>s2){return [1,2,0];}else{return [1,0,2];}}else if(s0>s2){return [2,0,1];}else if(s2>s1){return [0,1,2];}else{return [0,2,1];}}})")):r.push("ORDER})")),r.push("proto.set=function "+t+"_set("+o.join(",")+",v){"),s?r.push("return this.data.set("+a+",v)}"):r.push("return this.data["+a+"]=v}"),r.push("proto.get=function "+t+"_get("+o.join(",")+"){"),s?r.push("return this.data.get("+a+")}"):r.push("return this.data["+a+"]}"),r.push("proto.index=function "+t+"_index(",o.join(),"){return "+a+"}"),r.push("proto.hi=function "+t+"_hi("+o.join(",")+"){return new "+t+"(this.data,"+n.map(function(x){return["(typeof i",x,"!=='number'||i",x,"<0)?this.shape[",x,"]:i",x,"|0"].join("")}).join(",")+","+n.map(function(x){return"this.stride["+x+"]"}).join(",")+",this.offset)}");var f=n.map(function(x){return"a"+x+"=this.shape["+x+"]"}),p=n.map(function(x){return"c"+x+"=this.stride["+x+"]"});r.push("proto.lo=function "+t+"_lo("+o.join(",")+"){var b=this.offset,d=0,"+f.join(",")+","+p.join(","));for(var h=0;h<e;++h)r.push("if(typeof i"+h+"==='number'&&i"+h+">=0){d=i"+h+"|0;b+=c"+h+"*d;a"+h+"-=d}");r.push("return new "+t+"(this.data,"+n.map(function(x){return"a"+x}).join(",")+","+n.map(function(x){return"c"+x}).join(",")+",b)}"),r.push("proto.step=function "+t+"_step("+o.join(",")+"){var "+n.map(function(x){return"a"+x+"=this.shape["+x+"]"}).join(",")+","+n.map(function(x){return"b"+x+"=this.stride["+x+"]"}).join(",")+",c=this.offset,d=0,ceil=Math.ceil");for(var h=0;h<e;++h)r.push("if(typeof i"+h+"==='number'){d=i"+h+"|0;if(d<0){c+=b"+h+"*(a"+h+"-1);a"+h+"=ceil(-a"+h+"/d)}else{a"+h+"=ceil(a"+h+"/d)}b"+h+"*=d}");r.push("return new "+t+"(this.data,"+n.map(function(x){return"a"+x}).join(",")+","+n.map(function(x){return"b"+x}).join(",")+",c)}");for(var m=new Array(e),y=new Array(e),h=0;h<e;++h)m[h]="a[i"+h+"]",y[h]="b[i"+h+"]";r.push("proto.transpose=function "+t+"_transpose("+o+"){"+o.map(function(x,g){return x+"=("+x+"===undefined?"+g+":"+x+"|0)"}).join(";"),"var a=this.shape,b=this.stride;return new "+t+"(this.data,"+m.join(",")+","+y.join(",")+",this.offset)}"),r.push("proto.pick=function "+t+"_pick("+o+"){var a=[],b=[],c=this.offset");for(var h=0;h<e;++h)r.push("if(typeof i"+h+"==='number'&&i"+h+">=0){c=(c+this.stride["+h+"]*i"+h+")|0}else{a.push(this.shape["+h+"]);b.push(this.stride["+h+"])}");r.push("var ctor=CTOR_LIST[a.length+1];return ctor(this.data,a,b,c)}"),r.push("return function construct_"+t+"(data,shape,stride,offset){return new "+t+"(data,"+n.map(function(x){return"shape["+x+"]"}).join(",")+","+n.map(function(x){return"stride["+x+"]"}).join(",")+",offset)}");var T=new Function("CTOR_LIST","ORDER",r.join(`
`));return T(At[i],wi)}function vi(i){if(Ni(i))return"buffer";if(Ai)switch(Object.prototype.toString.call(i)){case"[object Float64Array]":return"float64";case"[object Float32Array]":return"float32";case"[object Int8Array]":return"int8";case"[object Int16Array]":return"int16";case"[object Int32Array]":return"int32";case"[object Uint8Array]":return"uint8";case"[object Uint16Array]":return"uint16";case"[object Uint32Array]":return"uint32";case"[object Uint8ClampedArray]":return"uint8_clamped";case"[object BigInt64Array]":return"bigint64";case"[object BigUint64Array]":return"biguint64"}return Array.isArray(i)?"array":"generic"}var At={float32:[],float64:[],int8:[],int16:[],int32:[],uint8:[],uint16:[],uint32:[],array:[],uint8_clamped:[],bigint64:[],biguint64:[],buffer:[],generic:[]};function Si(i,e,t,s){if(i===void 0){var u=At.array[0];return u([])}else typeof i=="number"&&(i=[i]);e===void 0&&(e=[i.length]);var r=e.length;if(t===void 0){t=new Array(r);for(var n=r-1,o=1;n>=0;--n)t[n]=o,o*=e[n]}if(s===void 0){s=0;for(var n=0;n<r;++n)t[n]<0&&(s-=(e[n]-1)*t[n])}for(var a=vi(i),c=At[a];c.length<=r+1;)c.push(Mi(a,c.length-1));var u=c[r+1];return u(i,e,t,s)}var Oi=Si;const te=vs(Oi);var Or={};function Ci(i,e){for(var t=1,s=i.length,r=i[0],n=i[0],o=1;o<s;++o)if(n=r,r=i[o],e(r,n)){if(o===t){t++;continue}i[t++]=r}return i.length=t,i}function Di(i){for(var e=1,t=i.length,s=i[0],r=i[0],n=1;n<t;++n,r=s)if(r=s,s=i[n],s!==r){if(n===e){e++;continue}i[e++]=s}return i.length=e,i}function ji(i,e,t){return i.length===0?i:e?(t||i.sort(e),Ci(i,e)):(t||i.sort(),Di(i))}var Fi=ji,Pi=Fi;function Cr(i,e,t){var s=i.length,r=e.arrayArgs.length,n=e.indexArgs.length>0,o=[],a=[],c=0,u=0,f,p;for(f=0;f<s;++f)a.push(["i",f,"=0"].join(""));for(p=0;p<r;++p)for(f=0;f<s;++f)u=c,c=i[f],f===0?a.push(["d",p,"s",f,"=t",p,"p",c].join("")):a.push(["d",p,"s",f,"=(t",p,"p",c,"-s",u,"*t",p,"p",u,")"].join(""));for(a.length>0&&o.push("var "+a.join(",")),f=s-1;f>=0;--f)c=i[f],o.push(["for(i",f,"=0;i",f,"<s",c,";++i",f,"){"].join(""));for(o.push(t),f=0;f<s;++f){for(u=c,c=i[f],p=0;p<r;++p)o.push(["p",p,"+=d",p,"s",f].join(""));n&&(f>0&&o.push(["index[",u,"]-=s",u].join("")),o.push(["++index[",c,"]"].join(""))),o.push("}")}return o.join(`
`)}function Li(i,e,t,s){for(var r=e.length,n=t.arrayArgs.length,o=t.blockSize,a=t.indexArgs.length>0,c=[],u=0;u<n;++u)c.push(["var offset",u,"=p",u].join(""));for(var u=i;u<r;++u)c.push(["for(var j"+u+"=SS[",e[u],"]|0;j",u,">0;){"].join("")),c.push(["if(j",u,"<",o,"){"].join("")),c.push(["s",e[u],"=j",u].join("")),c.push(["j",u,"=0"].join("")),c.push(["}else{s",e[u],"=",o].join("")),c.push(["j",u,"-=",o,"}"].join("")),a&&c.push(["index[",e[u],"]=j",u].join(""));for(var u=0;u<n;++u){for(var f=["offset"+u],p=i;p<r;++p)f.push(["j",p,"*t",u,"p",e[p]].join(""));c.push(["p",u,"=(",f.join("+"),")"].join(""))}c.push(Cr(e,t,s));for(var u=i;u<r;++u)c.push("}");return c.join(`
`)}function Bi(i){for(var e=0,t=i[0].length;e<t;){for(var s=1;s<i.length;++s)if(i[s][e]!==i[0][e])return e;++e}return e}function Pt(i,e,t){for(var s=i.body,r=[],n=[],o=0;o<i.args.length;++o){var a=i.args[o];if(!(a.count<=0)){var c=new RegExp(a.name,"g"),u="",f=e.arrayArgs.indexOf(o);switch(e.argTypes[o]){case"offset":var p=e.offsetArgIndex.indexOf(o),h=e.offsetArgs[p];f=h.array,u="+q"+p;case"array":u="p"+f+u;var m="l"+o,y="a"+f;if(e.arrayBlockIndices[f]===0)a.count===1?t[f]==="generic"?a.lvalue?(r.push(["var ",m,"=",y,".get(",u,")"].join("")),s=s.replace(c,m),n.push([y,".set(",u,",",m,")"].join(""))):s=s.replace(c,[y,".get(",u,")"].join("")):s=s.replace(c,[y,"[",u,"]"].join("")):t[f]==="generic"?(r.push(["var ",m,"=",y,".get(",u,")"].join("")),s=s.replace(c,m),a.lvalue&&n.push([y,".set(",u,",",m,")"].join(""))):(r.push(["var ",m,"=",y,"[",u,"]"].join("")),s=s.replace(c,m),a.lvalue&&n.push([y,"[",u,"]=",m].join("")));else{for(var T=[a.name],x=[u],g=0;g<Math.abs(e.arrayBlockIndices[f]);g++)T.push("\\s*\\[([^\\]]+)\\]"),x.push("$"+(g+1)+"*t"+f+"b"+g);if(c=new RegExp(T.join(""),"g"),u=x.join("+"),t[f]==="generic")throw new Error("cwise: Generic arrays not supported in combination with blocks!");s=s.replace(c,[y,"[",u,"]"].join(""))}break;case"scalar":s=s.replace(c,"Y"+e.scalarArgs.indexOf(o));break;case"index":s=s.replace(c,"index");break;case"shape":s=s.replace(c,"shape");break}}}return[r.join(`
`),s,n.join(`
`)].join(`
`).trim()}function Ui(i){for(var e=new Array(i.length),t=!0,s=0;s<i.length;++s){var r=i[s],n=r.match(/\d+/);n?n=n[0]:n="",r.charAt(0)===0?e[s]="u"+r.charAt(1)+n:e[s]=r.charAt(0)+n,s>0&&(t=t&&e[s]===e[s-1])}return t?e[0]:e.join("")}function Vi(i,e){for(var t=e[1].length-Math.abs(i.arrayBlockIndices[0])|0,s=new Array(i.arrayArgs.length),r=new Array(i.arrayArgs.length),n=0;n<i.arrayArgs.length;++n)r[n]=e[2*n],s[n]=e[2*n+1];for(var o=[],a=[],c=[],u=[],f=[],n=0;n<i.arrayArgs.length;++n){i.arrayBlockIndices[n]<0?(c.push(0),u.push(t),o.push(t),a.push(t+i.arrayBlockIndices[n])):(c.push(i.arrayBlockIndices[n]),u.push(i.arrayBlockIndices[n]+t),o.push(0),a.push(i.arrayBlockIndices[n]));for(var p=[],h=0;h<s[n].length;h++)c[n]<=s[n][h]&&s[n][h]<u[n]&&p.push(s[n][h]-c[n]);f.push(p)}for(var m=["SS"],y=["'use strict'"],T=[],h=0;h<t;++h)T.push(["s",h,"=SS[",h,"]"].join(""));for(var n=0;n<i.arrayArgs.length;++n){m.push("a"+n),m.push("t"+n),m.push("p"+n);for(var h=0;h<t;++h)T.push(["t",n,"p",h,"=t",n,"[",c[n]+h,"]"].join(""));for(var h=0;h<Math.abs(i.arrayBlockIndices[n]);++h)T.push(["t",n,"b",h,"=t",n,"[",o[n]+h,"]"].join(""))}for(var n=0;n<i.scalarArgs.length;++n)m.push("Y"+n);if(i.shapeArgs.length>0&&T.push("shape=SS.slice(0)"),i.indexArgs.length>0){for(var x=new Array(t),n=0;n<t;++n)x[n]="0";T.push(["index=[",x.join(","),"]"].join(""))}for(var n=0;n<i.offsetArgs.length;++n){for(var g=i.offsetArgs[n],l=[],h=0;h<g.offset.length;++h)g.offset[h]!==0&&(g.offset[h]===1?l.push(["t",g.array,"p",h].join("")):l.push([g.offset[h],"*t",g.array,"p",h].join("")));l.length===0?T.push("q"+n+"=0"):T.push(["q",n,"=",l.join("+")].join(""))}var d=Pi([].concat(i.pre.thisVars).concat(i.body.thisVars).concat(i.post.thisVars));T=T.concat(d),T.length>0&&y.push("var "+T.join(","));for(var n=0;n<i.arrayArgs.length;++n)y.push("p"+n+"|=0");i.pre.body.length>3&&y.push(Pt(i.pre,i,r));var E=Pt(i.body,i,r),b=Bi(f);b<t?y.push(Li(b,f[0],i,E)):y.push(Cr(f[0],i,E)),i.post.body.length>3&&y.push(Pt(i.post,i,r)),i.debug&&console.log("-----Generated cwise routine for ",e,`:
`+y.join(`
`)+`
----------`);var I=[i.funcName||"unnamed","_cwise_loop_",s[0].join("s"),"m",b,Ui(r)].join(""),_=new Function(["function ",I,"(",m.join(","),"){",y.join(`
`),"} return ",I].join(""));return _()}var ki=Vi,Gi=ki;function $i(i){var e=["'use strict'","var CACHED={}"],t=[],s=i.funcName+"_cwise_thunk";e.push(["return function ",s,"(",i.shimArgs.join(","),"){"].join(""));for(var r=[],n=[],o=[["array",i.arrayArgs[0],".shape.slice(",Math.max(0,i.arrayBlockIndices[0]),i.arrayBlockIndices[0]<0?","+i.arrayBlockIndices[0]+")":")"].join("")],a=[],c=[],u=0;u<i.arrayArgs.length;++u){var f=i.arrayArgs[u];t.push(["t",f,"=array",f,".dtype,","r",f,"=array",f,".order"].join("")),r.push("t"+f),r.push("r"+f),n.push("t"+f),n.push("r"+f+".join()"),o.push("array"+f+".data"),o.push("array"+f+".stride"),o.push("array"+f+".offset|0"),u>0&&(a.push("array"+i.arrayArgs[0]+".shape.length===array"+f+".shape.length+"+(Math.abs(i.arrayBlockIndices[0])-Math.abs(i.arrayBlockIndices[u]))),c.push("array"+i.arrayArgs[0]+".shape[shapeIndex+"+Math.max(0,i.arrayBlockIndices[0])+"]===array"+f+".shape[shapeIndex+"+Math.max(0,i.arrayBlockIndices[u])+"]"))}i.arrayArgs.length>1&&(e.push("if (!("+a.join(" && ")+")) throw new Error('cwise: Arrays do not all have the same dimensionality!')"),e.push("for(var shapeIndex=array"+i.arrayArgs[0]+".shape.length-"+Math.abs(i.arrayBlockIndices[0])+"; shapeIndex-->0;) {"),e.push("if (!("+c.join(" && ")+")) throw new Error('cwise: Arrays do not all have the same shape!')"),e.push("}"));for(var u=0;u<i.scalarArgs.length;++u)o.push("scalar"+i.scalarArgs[u]);t.push(["type=[",n.join(","),"].join()"].join("")),t.push("proc=CACHED[type]"),e.push("var "+t.join(",")),e.push(["if(!proc){","CACHED[type]=proc=compile([",r.join(","),"])}","return proc(",o.join(","),")}"].join("")),i.debug&&console.log(`-----Generated thunk:
`+e.join(`
`)+`
----------`);var p=new Function("compile",e.join(`
`));return p(Gi.bind(void 0,i))}var zi=$i,Xi=zi;function Hi(){this.argTypes=[],this.shimArgs=[],this.arrayArgs=[],this.arrayBlockIndices=[],this.scalarArgs=[],this.offsetArgs=[],this.offsetArgIndex=[],this.indexArgs=[],this.shapeArgs=[],this.funcName="",this.pre=null,this.body=null,this.post=null,this.debug=!1}function qi(i){var e=new Hi;e.pre=i.pre,e.body=i.body,e.post=i.post;var t=i.args.slice(0);e.argTypes=t;for(var s=0;s<t.length;++s){var r=t[s];if(r==="array"||typeof r=="object"&&r.blockIndices){if(e.argTypes[s]="array",e.arrayArgs.push(s),e.arrayBlockIndices.push(r.blockIndices?r.blockIndices:0),e.shimArgs.push("array"+s),s<e.pre.args.length&&e.pre.args[s].count>0)throw new Error("cwise: pre() block may not reference array args");if(s<e.post.args.length&&e.post.args[s].count>0)throw new Error("cwise: post() block may not reference array args")}else if(r==="scalar")e.scalarArgs.push(s),e.shimArgs.push("scalar"+s);else if(r==="index"){if(e.indexArgs.push(s),s<e.pre.args.length&&e.pre.args[s].count>0)throw new Error("cwise: pre() block may not reference array index");if(s<e.body.args.length&&e.body.args[s].lvalue)throw new Error("cwise: body() block may not write to array index");if(s<e.post.args.length&&e.post.args[s].count>0)throw new Error("cwise: post() block may not reference array index")}else if(r==="shape"){if(e.shapeArgs.push(s),s<e.pre.args.length&&e.pre.args[s].lvalue)throw new Error("cwise: pre() block may not write to array shape");if(s<e.body.args.length&&e.body.args[s].lvalue)throw new Error("cwise: body() block may not write to array shape");if(s<e.post.args.length&&e.post.args[s].lvalue)throw new Error("cwise: post() block may not write to array shape")}else if(typeof r=="object"&&r.offset)e.argTypes[s]="offset",e.offsetArgs.push({array:r.array,offset:r.offset}),e.offsetArgIndex.push(s);else throw new Error("cwise: Unknown argument type "+t[s])}if(e.arrayArgs.length<=0)throw new Error("cwise: No array arguments specified");if(e.pre.args.length>t.length)throw new Error("cwise: Too many arguments in pre() block");if(e.body.args.length>t.length)throw new Error("cwise: Too many arguments in body() block");if(e.post.args.length>t.length)throw new Error("cwise: Too many arguments in post() block");return e.debug=!!i.printCode||!!i.debug,e.funcName=i.funcName||"cwise",e.blockSize=i.blockSize||64,Xi(e)}var Yi=qi;(function(i){var e=Yi,t={body:"",args:[],thisVars:[],localVars:[]};function s(h){if(!h)return t;for(var m=0;m<h.args.length;++m){var y=h.args[m];m===0?h.args[m]={name:y,lvalue:!0,rvalue:!!h.rvalue,count:h.count||1}:h.args[m]={name:y,lvalue:!1,rvalue:!0,count:1}}return h.thisVars||(h.thisVars=[]),h.localVars||(h.localVars=[]),h}function r(h){return e({args:h.args,pre:s(h.pre),body:s(h.body),post:s(h.proc),funcName:h.funcName})}function n(h){for(var m=[],y=0;y<h.args.length;++y)m.push("a"+y);var T=new Function("P",["return function ",h.funcName,"_ndarrayops(",m.join(","),") {P(",m.join(","),");return a0}"].join(""));return T(r(h))}var o={add:"+",sub:"-",mul:"*",div:"/",mod:"%",band:"&",bor:"|",bxor:"^",lshift:"<<",rshift:">>",rrshift:">>>"};(function(){for(var h in o){var m=o[h];i[h]=n({args:["array","array","array"],body:{args:["a","b","c"],body:"a=b"+m+"c"},funcName:h}),i[h+"eq"]=n({args:["array","array"],body:{args:["a","b"],body:"a"+m+"=b"},rvalue:!0,funcName:h+"eq"}),i[h+"s"]=n({args:["array","array","scalar"],body:{args:["a","b","s"],body:"a=b"+m+"s"},funcName:h+"s"}),i[h+"seq"]=n({args:["array","scalar"],body:{args:["a","s"],body:"a"+m+"=s"},rvalue:!0,funcName:h+"seq"})}})();var a={not:"!",bnot:"~",neg:"-",recip:"1.0/"};(function(){for(var h in a){var m=a[h];i[h]=n({args:["array","array"],body:{args:["a","b"],body:"a="+m+"b"},funcName:h}),i[h+"eq"]=n({args:["array"],body:{args:["a"],body:"a="+m+"a"},rvalue:!0,count:2,funcName:h+"eq"})}})();var c={and:"&&",or:"||",eq:"===",neq:"!==",lt:"<",gt:">",leq:"<=",geq:">="};(function(){for(var h in c){var m=c[h];i[h]=n({args:["array","array","array"],body:{args:["a","b","c"],body:"a=b"+m+"c"},funcName:h}),i[h+"s"]=n({args:["array","array","scalar"],body:{args:["a","b","s"],body:"a=b"+m+"s"},funcName:h+"s"}),i[h+"eq"]=n({args:["array","array"],body:{args:["a","b"],body:"a=a"+m+"b"},rvalue:!0,count:2,funcName:h+"eq"}),i[h+"seq"]=n({args:["array","scalar"],body:{args:["a","s"],body:"a=a"+m+"s"},rvalue:!0,count:2,funcName:h+"seq"})}})();var u=["abs","acos","asin","atan","ceil","cos","exp","floor","log","round","sin","sqrt","tan"];(function(){for(var h=0;h<u.length;++h){var m=u[h];i[m]=n({args:["array","array"],pre:{args:[],body:"this_f=Math."+m,thisVars:["this_f"]},body:{args:["a","b"],body:"a=this_f(b)",thisVars:["this_f"]},funcName:m}),i[m+"eq"]=n({args:["array"],pre:{args:[],body:"this_f=Math."+m,thisVars:["this_f"]},body:{args:["a"],body:"a=this_f(a)",thisVars:["this_f"]},rvalue:!0,count:2,funcName:m+"eq"})}})();var f=["max","min","atan2","pow"];(function(){for(var h=0;h<f.length;++h){var m=f[h];i[m]=n({args:["array","array","array"],pre:{args:[],body:"this_f=Math."+m,thisVars:["this_f"]},body:{args:["a","b","c"],body:"a=this_f(b,c)",thisVars:["this_f"]},funcName:m}),i[m+"s"]=n({args:["array","array","scalar"],pre:{args:[],body:"this_f=Math."+m,thisVars:["this_f"]},body:{args:["a","b","c"],body:"a=this_f(b,c)",thisVars:["this_f"]},funcName:m+"s"}),i[m+"eq"]=n({args:["array","array"],pre:{args:[],body:"this_f=Math."+m,thisVars:["this_f"]},body:{args:["a","b"],body:"a=this_f(a,b)",thisVars:["this_f"]},rvalue:!0,count:2,funcName:m+"eq"}),i[m+"seq"]=n({args:["array","scalar"],pre:{args:[],body:"this_f=Math."+m,thisVars:["this_f"]},body:{args:["a","b"],body:"a=this_f(a,b)",thisVars:["this_f"]},rvalue:!0,count:2,funcName:m+"seq"})}})();var p=["atan2","pow"];(function(){for(var h=0;h<p.length;++h){var m=p[h];i[m+"op"]=n({args:["array","array","array"],pre:{args:[],body:"this_f=Math."+m,thisVars:["this_f"]},body:{args:["a","b","c"],body:"a=this_f(c,b)",thisVars:["this_f"]},funcName:m+"op"}),i[m+"ops"]=n({args:["array","array","scalar"],pre:{args:[],body:"this_f=Math."+m,thisVars:["this_f"]},body:{args:["a","b","c"],body:"a=this_f(c,b)",thisVars:["this_f"]},funcName:m+"ops"}),i[m+"opeq"]=n({args:["array","array"],pre:{args:[],body:"this_f=Math."+m,thisVars:["this_f"]},body:{args:["a","b"],body:"a=this_f(b,a)",thisVars:["this_f"]},rvalue:!0,count:2,funcName:m+"opeq"}),i[m+"opseq"]=n({args:["array","scalar"],pre:{args:[],body:"this_f=Math."+m,thisVars:["this_f"]},body:{args:["a","b"],body:"a=this_f(b,a)",thisVars:["this_f"]},rvalue:!0,count:2,funcName:m+"opseq"})}})(),i.any=e({args:["array"],pre:t,body:{args:[{name:"a",lvalue:!1,rvalue:!0,count:1}],body:"if(a){return true}",localVars:[],thisVars:[]},post:{args:[],localVars:[],thisVars:[],body:"return false"},funcName:"any"}),i.all=e({args:["array"],pre:t,body:{args:[{name:"x",lvalue:!1,rvalue:!0,count:1}],body:"if(!x){return false}",localVars:[],thisVars:[]},post:{args:[],localVars:[],thisVars:[],body:"return true"},funcName:"all"}),i.sum=e({args:["array"],pre:{args:[],localVars:[],thisVars:["this_s"],body:"this_s=0"},body:{args:[{name:"a",lvalue:!1,rvalue:!0,count:1}],body:"this_s+=a",localVars:[],thisVars:["this_s"]},post:{args:[],localVars:[],thisVars:["this_s"],body:"return this_s"},funcName:"sum"}),i.prod=e({args:["array"],pre:{args:[],localVars:[],thisVars:["this_s"],body:"this_s=1"},body:{args:[{name:"a",lvalue:!1,rvalue:!0,count:1}],body:"this_s*=a",localVars:[],thisVars:["this_s"]},post:{args:[],localVars:[],thisVars:["this_s"],body:"return this_s"},funcName:"prod"}),i.norm2squared=e({args:["array"],pre:{args:[],localVars:[],thisVars:["this_s"],body:"this_s=0"},body:{args:[{name:"a",lvalue:!1,rvalue:!0,count:2}],body:"this_s+=a*a",localVars:[],thisVars:["this_s"]},post:{args:[],localVars:[],thisVars:["this_s"],body:"return this_s"},funcName:"norm2squared"}),i.norm2=e({args:["array"],pre:{args:[],localVars:[],thisVars:["this_s"],body:"this_s=0"},body:{args:[{name:"a",lvalue:!1,rvalue:!0,count:2}],body:"this_s+=a*a",localVars:[],thisVars:["this_s"]},post:{args:[],localVars:[],thisVars:["this_s"],body:"return Math.sqrt(this_s)"},funcName:"norm2"}),i.norminf=e({args:["array"],pre:{args:[],localVars:[],thisVars:["this_s"],body:"this_s=0"},body:{args:[{name:"a",lvalue:!1,rvalue:!0,count:4}],body:"if(-a>this_s){this_s=-a}else if(a>this_s){this_s=a}",localVars:[],thisVars:["this_s"]},post:{args:[],localVars:[],thisVars:["this_s"],body:"return this_s"},funcName:"norminf"}),i.norm1=e({args:["array"],pre:{args:[],localVars:[],thisVars:["this_s"],body:"this_s=0"},body:{args:[{name:"a",lvalue:!1,rvalue:!0,count:3}],body:"this_s+=a<0?-a:a",localVars:[],thisVars:["this_s"]},post:{args:[],localVars:[],thisVars:["this_s"],body:"return this_s"},funcName:"norm1"}),i.sup=e({args:["array"],pre:{body:"this_h=-Infinity",args:[],thisVars:["this_h"],localVars:[]},body:{body:"if(_inline_1_arg0_>this_h)this_h=_inline_1_arg0_",args:[{name:"_inline_1_arg0_",lvalue:!1,rvalue:!0,count:2}],thisVars:["this_h"],localVars:[]},post:{body:"return this_h",args:[],thisVars:["this_h"],localVars:[]}}),i.inf=e({args:["array"],pre:{body:"this_h=Infinity",args:[],thisVars:["this_h"],localVars:[]},body:{body:"if(_inline_1_arg0_<this_h)this_h=_inline_1_arg0_",args:[{name:"_inline_1_arg0_",lvalue:!1,rvalue:!0,count:2}],thisVars:["this_h"],localVars:[]},post:{body:"return this_h",args:[],thisVars:["this_h"],localVars:[]}}),i.argmin=e({args:["index","array","shape"],pre:{body:"{this_v=Infinity;this_i=_inline_0_arg2_.slice(0)}",args:[{name:"_inline_0_arg0_",lvalue:!1,rvalue:!1,count:0},{name:"_inline_0_arg1_",lvalue:!1,rvalue:!1,count:0},{name:"_inline_0_arg2_",lvalue:!1,rvalue:!0,count:1}],thisVars:["this_i","this_v"],localVars:[]},body:{body:"{if(_inline_1_arg1_<this_v){this_v=_inline_1_arg1_;for(var _inline_1_k=0;_inline_1_k<_inline_1_arg0_.length;++_inline_1_k){this_i[_inline_1_k]=_inline_1_arg0_[_inline_1_k]}}}",args:[{name:"_inline_1_arg0_",lvalue:!1,rvalue:!0,count:2},{name:"_inline_1_arg1_",lvalue:!1,rvalue:!0,count:2}],thisVars:["this_i","this_v"],localVars:["_inline_1_k"]},post:{body:"{return this_i}",args:[],thisVars:["this_i"],localVars:[]}}),i.argmax=e({args:["index","array","shape"],pre:{body:"{this_v=-Infinity;this_i=_inline_0_arg2_.slice(0)}",args:[{name:"_inline_0_arg0_",lvalue:!1,rvalue:!1,count:0},{name:"_inline_0_arg1_",lvalue:!1,rvalue:!1,count:0},{name:"_inline_0_arg2_",lvalue:!1,rvalue:!0,count:1}],thisVars:["this_i","this_v"],localVars:[]},body:{body:"{if(_inline_1_arg1_>this_v){this_v=_inline_1_arg1_;for(var _inline_1_k=0;_inline_1_k<_inline_1_arg0_.length;++_inline_1_k){this_i[_inline_1_k]=_inline_1_arg0_[_inline_1_k]}}}",args:[{name:"_inline_1_arg0_",lvalue:!1,rvalue:!0,count:2},{name:"_inline_1_arg1_",lvalue:!1,rvalue:!0,count:2}],thisVars:["this_i","this_v"],localVars:["_inline_1_k"]},post:{body:"{return this_i}",args:[],thisVars:["this_i"],localVars:[]}}),i.random=n({args:["array"],pre:{args:[],body:"this_f=Math.random",thisVars:["this_f"]},body:{args:["a"],body:"a=this_f()",thisVars:["this_f"]},funcName:"random"}),i.assign=n({args:["array","array"],body:{args:["a","b"],body:"a=b"},funcName:"assign"}),i.assigns=n({args:["array","scalar"],body:{args:["a","b"],body:"a=b"},funcName:"assigns"}),i.equals=e({args:["array","array"],pre:t,body:{args:[{name:"x",lvalue:!1,rvalue:!0,count:1},{name:"y",lvalue:!1,rvalue:!0,count:1}],body:"if(x!==y){return false}",localVars:[],thisVars:[]},post:{args:[],localVars:[],thisVars:[],body:"return true"},funcName:"equals"})})(Or);const Oe=vs(Or);function Ki(i,e,t={}){const s=document.createElement("canvas");s.width=i.shape[0],s.height=i.shape[1];const r=s.getContext("2d"),n=r.getImageData(0,0,s.width,s.height);try{Dr(i,n.data)}catch(a){return jr.from(Promise.reject(a))}r.putImageData(n,0,0);const o=t.quality?t.quality/100:void 0;switch(e){case"canvas":return s;case"jpg":case"jpeg":return bs(s,"image/jpeg",o);case"png":return bs(s,"image/png");default:throw new Error("[ndarray-pixels] Unsupported file type: "+e)}}function bs(i,e,t){const s=new Promise((r,n)=>{i.toBlob(async o=>{o?r(new Uint8Array(await o.arrayBuffer())):n(new Error("[ndarray-pixels] Failed to canvas.toBlob()."))},e,t)});return jr.from(s)}function Dr(i,e,t=-1){if(i.shape.length===4)return Dr(i.pick(t),e,0);if(i.shape.length===3)if(i.shape[2]===3)Oe.assign(te(e,[i.shape[0],i.shape[1],3],[4,4*i.shape[0],1]),i),Oe.assigns(te(e,[i.shape[0]*i.shape[1]],[4],3),255);else if(i.shape[2]===4)Oe.assign(te(e,[i.shape[0],i.shape[1],4],[4,4*i.shape[0],1]),i);else{if(i.shape[2]!==1)throw new Error("[ndarray-pixels] Incompatible array shape.");Oe.assign(te(e,[i.shape[0],i.shape[1],3],[4,4*i.shape[0],1]),te(i.data,[i.shape[0],i.shape[1],3],[i.stride[0],i.stride[1],0],i.offset)),Oe.assigns(te(e,[i.shape[0]*i.shape[1]],[4],3),255)}else{if(i.shape.length!==2)throw new Error("[ndarray-pixels] Incompatible array shape.");Oe.assign(te(e,[i.shape[0],i.shape[1],3],[4,4*i.shape[0],1]),te(i.data,[i.shape[0],i.shape[1],3],[i.stride[0],i.stride[1],0],i.offset)),Oe.assigns(te(e,[i.shape[0]*i.shape[1]],[4],3),255)}return e}let jr=class Fr{constructor(e){this._promise=void 0,this._promise=e}on(e,t){return e==="data"?this._promise.then(t):e==="error"?this._promise.catch(t):e==="end"&&this._promise.finally(t),this}static from(e){return new Fr(e)}};async function Wi(i,e){return i instanceof Uint8Array&&typeof Buffer<"u"&&(i=Buffer.from(i)),new Promise((t,s)=>{(function(r,n,o){if(o=o||n,r instanceof Uint8Array){if(typeof n!="string")throw new Error("[ndarray-pixels] Type must be given for Uint8Array image data");const c=new Blob([r],{type:n});r=URL.createObjectURL(c)}const a=new Image;a.crossOrigin="anonymous",a.onload=function(){URL.revokeObjectURL(r);const c=document.createElement("canvas");c.width=a.width,c.height=a.height;const u=c.getContext("2d");u.drawImage(a,0,0);const f=u.getImageData(0,0,a.width,a.height);o(null,te(new Uint8Array(f.data),[a.width,a.height,4],[4,4*a.width,1],0))},a.onerror=c=>{URL.revokeObjectURL(r),o(c)},a.src=r})(i,e,(r,n)=>{n&&!r?t(n):s(r)})})}async function Ji(i,e){return new Promise((t,s)=>{const r=[],n=e.replace("image/","");Ki(i,n).on("data",o=>r.push(o)).on("end",()=>t(function(o){let a=0;for(const f of o)a+=f.byteLength;const c=new Uint8Array(a);let u=0;for(const f of o)c.set(f,u),u+=f.byteLength;return c}(r))).on("error",o=>s(o))})}const Zi=(i,e)=>{if(i<=-e||i>=e)return 0;const t=i*Math.PI;return Math.sin(t)/t*Math.sin(t/e)/(t/e)},Rs=i=>Math.round(16383*i),Is=(i,e,t,s,r)=>{const n=r?2:3,o=1/t,a=Math.min(1,t),c=n/a,u=Math.floor(2*(c+1)),f=new Int16Array((u+2)*e);let p=0;for(let h=0;h<e;h++){const m=(h+.5)*o+s,y=Math.max(0,Math.floor(m-c)),T=Math.min(i-1,Math.ceil(m+c)),x=T-y+1,g=new Float32Array(x),l=new Int16Array(x);let d=0,E=0;for(let M=y;M<=T;M++){const v=Zi((M+.5-m)*a,n);d+=v,g[E]=v,E++}let b=0;for(let M=0;M<g.length;M++){const v=g[M]/d;b+=v,l[M]=Rs(v)}l[e>>1]+=Rs(1-b);let I=0;for(;I<l.length&&l[I]===0;)I++;let _=l.length-1;for(;_>0&&l[_]===0;)_--;const w=_-I+1;f[p++]=y+I,f[p++]=w,f.set(l.subarray(I,_+1),p),p+=w}return f},Et=i=>i<0?0:i>255?255:i,Ns=(i,e,t)=>{const[s,r]=i.shape,[n]=e.shape;for(let o=0;o<r;o++){const a=o;let c=0;for(let u=0;u<n;u++){let f=t[c++],p=0,h=0,m=0,y=0;for(let T=t[c++];T>0;T--){const x=t[c++];p+=x*i.get(f,o,0),h+=x*i.get(f,o,1),m+=x*i.get(f,o,2),y+=x*i.get(f,o,3),f++}e.set(u,a,0,Et(p+8192>>14)),e.set(u,a,1,Et(h+8192>>14)),e.set(u,a,2,Et(m+8192>>14)),e.set(u,a,3,Et(y+8192>>14))}}};var Qe;function Pr(i,e,t){const[s,r]=i.shape,[n,o]=e.shape,a=o/r,c=Is(s,n,n/s,0,t===Qe.LANCZOS_2),u=Is(r,o,a,0,t===Qe.LANCZOS_2),f=te(new Uint8Array(n*r*4),[r,n,4]),p=f.transpose(1,0),h=e.transpose(1,0);Ns(i,p,c),Ns(f,h,u)}function Qi(i,e){Pr(i,e,Qe.LANCZOS_3)}function eo(i,e){Pr(i,e,Qe.LANCZOS_2)}(function(i){i[i.LANCZOS_3=3]="LANCZOS_3",i[i.LANCZOS_2=2]="LANCZOS_2"})(Qe||(Qe={}));function ft(){return(ft=Object.assign||function(i){for(var e=1;e<arguments.length;e++){var t=arguments[e];for(var s in t)Object.prototype.hasOwnProperty.call(t,s)&&(i[s]=t[s])}return i}).apply(this,arguments)}function to(i,e){return Object.defineProperty(e,"name",{value:i}),e}R.ACCESSOR,R.MESH,R.TEXTURE,R.MATERIAL;R.NODE,R.SKIN,R.MESH,R.CAMERA,R.PRIMITIVE,R.PRIMITIVE_TARGET,R.ANIMATION,R.MATERIAL,R.TEXTURE,R.ACCESSOR,R.BUFFER;Mt.TargetPath;function Lr(i,e){const t=i.getRoot(),s=i.getGraph().listParentEdges(e).filter(r=>r.getParent()!==t).map(r=>r.getName());return Array.from(new Set(s))}var ve;(function(i){i.OXIPNG="oxipng",i.MOZJPEG="mozjpeg",i.WEBP="webp"})(ve||(ve={}));ve.OXIPNG+"",ve.MOZJPEG+"",ve.WEBP+"";const es={jobs:4,formats:/.*/,slots:/.*/,auto:!1};ft({},es,{codec:ve.WEBP});ft({},es,{codec:ve.MOZJPEG,formats:/^image\/jpeg$/});ft({},es,{codec:ve.OXIPNG,formats:/^image\/png$/});const le="textureResize";var _t;(function(i){i.LANCZOS3="lanczos3",i.LANCZOS2="lanczos2"})(_t||(_t={}));const As={size:[2048,2048],filter:_t.LANCZOS3,pattern:null,slots:null};function Lt(i=As){const e=ft({},As,i);return to(le,async t=>{const s=t.getLogger();for(const r of t.getRoot().listTextures()){const n=r.getName(),o=r.getURI();if(e.pattern&&!e.pattern.test(n)&&!e.pattern.test(o)){s.debug(`${le}: Skipping, excluded by "pattern" parameter.`);continue}if(r.getMimeType()!=="image/png"&&r.getMimeType()!=="image/jpeg"){s.warn(`${le}: Skipping, unsupported texture type "${r.getMimeType()}".`);continue}const a=Lr(t,r);if(e.slots&&!a.some(g=>{var l;return(l=e.slots)==null?void 0:l.test(g)})){s.debug(`${le}: Skipping, [${a.join(", ")}] excluded by "slots" parameter.`);continue}const[c,u]=e.size,[f,p]=r.getSize();if(f<=c&&p<=u){s.debug(`${le}: Skipping, not within size range.`);continue}let h=f,m=p;h>c&&(m=Math.floor(m*(c/h)),h=c),m>u&&(h=Math.floor(h*(u/m)),m=u);const y=r.getImage(),T=await Wi(y,r.getMimeType()),x=te(new Uint8Array(h*m*4),[h,m,4]);s.debug(`${le}: Resizing "${o||n}", ${T.shape} → ${x.shape}...`),s.debug(`${le}: Slots → [${a.join(", ")}]`);try{e.filter===_t.LANCZOS3?Qi(T,x):eo(T,x)}catch(g){if(g instanceof Error){s.warn(`${le}: Failed to resize "${o||n}": "${g.message}".`);continue}throw g}r.setImage(await Ji(x,r.getMimeType()))}s.debug(`${le}: Complete.`)})}const L="KHR_audio";class Br extends D{constructor(){super(...arguments);A(this,"extensionName",L);A(this,"prewriteTypes",[R.BUFFER]);A(this,"audioDataUris",new Map)}createSceneAudioEmitters(){return new Vr(this.document.getGraph())}createAudioEmitter(){return new Te(this.document.getGraph())}createAudioSource(){return new kr(this.document.getGraph())}createAudioData(){return new Gr(this.document.getGraph())}static async beforeReadDocument(t,s){if(!s.json.extensions||!s.json.extensions[L])return;const r=s.json.extensions[L];r.audio&&await Promise.all(r.audio.map(async({uri:n})=>{!n||n.match(/data:/)||(s.resources[n]=await t.readURI(t.resolve(t.dirname(n),n),"view"))}))}read(t){const{json:s,resources:r}=t.jsonDoc;if(!s.extensions||!s.extensions[L])return this;const n=s.extensions[L],o=n.audio||[],a=n.sources||[],c=n.emitters||[],u=o.map(y=>{const T=this.createAudioData();if(y.bufferView!==void 0){const x=s.bufferViews[y.bufferView],g=s.buffers[x.buffer],l=g.uri?r[g.uri]:r["@glb.bin"],d=x.byteOffset||0,E=x.byteLength,b=l.slice(d,d+E);T.setData(b)}else y.uri!==void 0&&(T.setData(r[y.uri]),y.uri.indexOf("__")!==0&&T.setURI(y.uri));return T}),f=a.map(y=>{const T=this.createAudioSource();return y.autoPlay!==void 0&&T.setAutoPlay(y.autoPlay),y.loop!==void 0&&T.setLoop(y.loop),y.gain!==void 0&&T.setGain(y.gain),y.audio!==void 0&&T.setAudio(u[y.audio]),T}),p=c.map(y=>{const T=this.createAudioEmitter();if(T.setType(y.type),y.gain!==void 0&&T.setGain(y.gain),y.sources!==void 0)for(const x of y.sources)T.addSource(f[x]);if(y.type===Te.Type.POSITIONAL&&y.positional){const x=y.positional;x.coneInnerAngle!==void 0&&T.setConeInnerAngle(x.coneInnerAngle),x.coneOuterAngle!==void 0&&T.setConeOuterAngle(x.coneOuterAngle),x.coneOuterGain!==void 0&&T.setConeOuterGain(x.coneOuterGain),x.distanceModel!==void 0&&T.setDistanceModel(x.distanceModel),x.maxDistance!==void 0&&T.setMaxDistance(x.maxDistance),x.refDistance!==void 0&&T.setRefDistance(x.refDistance),x.rolloffFactor!==void 0&&T.setRolloffFactor(x.rolloffFactor)}return T});return(s.scenes||[]).forEach((y,T)=>{if(!y.extensions||!y.extensions[L])return;const x=y.extensions[L],g=this.createSceneAudioEmitters();for(const l of x.emitters)g.addEmitter(p[l]);t.scenes[T].setExtension(L,g)}),(s.nodes||[]).forEach((y,T)=>{if(!y.extensions||!y.extensions[L])return;const x=y.extensions[L];t.nodes[T].setExtension(L,p[x.emitter])}),this}prewrite(t,s){this.audioDataUris.clear();let r=0;for(const n of this.properties)if(n.propertyType===Ht){const o=n,a=o.getData();if(a)if(t.options.format===J.GLB){const c=this.document.getRoot().listBuffers()[0],u=t.otherBufferViews.get(c)||[];u.push(a),t.otherBufferViews.set(c,u)}else{const c=o.getURI()||`audio_${r++}.mp3`;t.jsonDoc.resources[c]=a,this.audioDataUris.set(o,c)}}return this}write(t){const s=t.jsonDoc;if(this.properties.size===0)return this;const r=[],n=new Map;for(const f of this.properties)if(f.propertyType===Ht){const p=f,h={},m=p.getData();m&&(t.options.format===J.GLB?(h.mimeType="audio/mpeg",h.bufferView=t.otherBufferViewsIndexMap.get(m)):h.uri=this.audioDataUris.get(p)),n.set(p,r.length),r.push(h)}const o=[],a=new Map;for(const f of this.properties)if(f.propertyType===ss){const p=f,h={},m=p.getAudio();if(m){const T=n.get(m);T!==void 0&&(h.audio=T)}p.getAutoPlay()&&(h.autoPlay=!0),p.getLoop()&&(h.loop=!0);const y=p.getGain();y!==1&&(h.gain=y),a.set(p,o.length),o.push(h)}const c=[],u=new Map;for(const f of this.properties)if(f.propertyType===ts){const p=f,h=p.getType(),m={type:h},y=p.listSources().map(x=>a.get(x));y.length>0&&(m.sources=y);const T=p.getGain();if(T!==1&&(m.gain=T),h===Te.Type.POSITIONAL){const x={},g=p.getConeInnerAngle();g!==Math.PI*2&&(x.coneInnerAngle=g);const l=p.getConeOuterAngle();l!==Math.PI*2&&(x.coneOuterAngle=l);const d=p.getConeOuterGain();d!==0&&(x.coneOuterGain=d);const E=p.getDistanceModel();E!==Te.DistanceModel.INVERSE&&(x.distanceModel=E);const b=p.getMaxDistance();b!==1e4&&(x.maxDistance=b);const I=p.getRefDistance();I!==1&&(x.refDistance=I);const _=p.getRolloffFactor();_!==1&&(x.rolloffFactor=_),Object.keys(x).length>0&&(m.positional=x)}u.set(p,c.length),c.push(m)}return this.document.getRoot().listScenes().forEach(f=>{const p=f.getExtension(L);if(p){const h=t.sceneIndexMap.get(f),m=s.json.scenes[h];m.extensions=m.extensions||{};const y=p.listEmitters().map(T=>u.get(T));m.extensions[L]={emitters:y}}}),this.document.getRoot().listNodes().forEach(f=>{const p=f.getExtension(L);if(p){const h=t.nodeIndexMap.get(f),m=s.json.nodes[h];m.extensions=m.extensions||{},m.extensions[L]={emitter:u.get(p)}}}),s.json.extensions=s.json.extensions||{},s.json.extensions[L]={audio:r,sources:o,emitters:c},this}}A(Br,"EXTENSION_NAME",L);const Ur="SceneAudioEmitters";class Vr extends C{init(){this.extensionName=L,this.propertyType=Ur,this.parentTypes=[R.SCENE]}getDefaults(){return Object.assign(super.getDefaults(),{emitters:[]})}listEmitters(){return this.listRefs("emitters")}addEmitter(e){return this.addRef("emitters",e)}removeEmitter(e){return this.removeRef("emitters",e)}}A(Vr,"EXTENSION_NAME",L);const ts="AudioEmitter",wt=class extends C{init(){this.extensionName=L,this.propertyType=ts,this.parentTypes=[R.NODE,Ur]}getDefaults(){return Object.assign(super.getDefaults(),{type:wt.Type.GLOBAL,gain:1,sources:[],coneInnerAngle:Math.PI*2,coneOuterAngle:Math.PI*2,coneOuterGain:0,distanceModel:wt.DistanceModel.INVERSE,maxDistance:1e4,refDistance:1,rolloffFactor:1})}getType(){return this.get("type")}setType(e){return this.set("type",e)}getGain(){return this.get("gain")}setGain(e){return this.set("gain",e)}listSources(){return this.listRefs("sources")}addSource(e){return this.addRef("sources",e)}removeSource(e){return this.removeRef("sources",e)}getConeInnerAngle(){return this.get("coneInnerAngle")}setConeInnerAngle(e){return this.set("coneInnerAngle",e)}getConeOuterAngle(){return this.get("coneOuterAngle")}setConeOuterAngle(e){return this.set("coneOuterAngle",e)}getConeOuterGain(){return this.get("coneOuterGain")}setConeOuterGain(e){return this.set("coneOuterGain",e)}getDistanceModel(){return this.get("distanceModel")}setDistanceModel(e){return this.set("distanceModel",e)}getMaxDistance(){return this.get("maxDistance")}setMaxDistance(e){return this.set("maxDistance",e)}getRefDistance(){return this.get("refDistance")}setRefDistance(e){return this.set("refDistance",e)}getRolloffFactor(){return this.get("rolloffFactor")}setRolloffFactor(e){return this.set("rolloffFactor",e)}};let Te=wt;A(Te,"EXTENSION_NAME",L),A(Te,"Type",{GLOBAL:"global",POSITIONAL:"positional"}),A(Te,"DistanceModel",{INVERSE:"inverse",LINEAR:"linear",EXPONENTIAL:"exponential"});const ss="AudioSource";class kr extends C{init(){this.extensionName=L,this.propertyType=ss,this.parentTypes=[ts]}getDefaults(){return Object.assign(super.getDefaults(),{autoPlay:!1,gain:1,loop:!1,audio:null})}getAutoPlay(){return this.get("autoPlay")}setAutoPlay(e){return this.set("autoPlay",e)}getLoop(){return this.get("loop")}setLoop(e){return this.set("loop",e)}getGain(){return this.get("gain")}setGain(e){return this.set("gain",e)}getAudio(){return this.getRef("audio")}setAudio(e){return this.setRef("audio",e)}}A(kr,"EXTENSION_NAME",L);const Ht="AudioData";class Gr extends C{init(){this.extensionName=L,this.propertyType=Ht,this.parentTypes=[ss]}getDefaults(){return Object.assign(super.getDefaults(),{uri:"",mimeType:"",data:null})}getURI(){return this.get("uri")}setURI(e){return this.set("mimeType",_s(be.extension(e))),this.set("uri",e)}getMimeType(){return this.get("mimeType")||_s(be.extension(this.getURI()))}setMimeType(e){return this.set("mimeType",e)}getData(){return this.get("data")}setData(e){return this.set("data",S.assertView(e))}}A(Gr,"EXTENSION_NAME",L);function _s(i){return i==="mp3"?"audio/mpeg":`audio/${i}`}const ge="MX_background",so="Background";class $r extends D{constructor(){super(...arguments);A(this,"extensionName",ge)}createBackground(){return new zr(this.document.getGraph())}read(t){const s=t.jsonDoc,r=s.json.textures||[];return(s.json.scenes||[]).forEach((o,a)=>{if(!o.extensions||!o.extensions[ge])return;const c=this.createBackground(),f=o.extensions[ge].backgroundTexture,p=t.textures[r[f.index].source];c.setBackgroundTexture(p),t.setTextureInfo(c.getBackgroundTextureInfo(),f),t.scenes[a].setExtension(ge,c)}),this}write(t){const s=t.jsonDoc;return this.document.getRoot().listScenes().forEach(r=>{const n=r.getExtension(ge);if(n){const o=t.sceneIndexMap.get(r),a=s.json.scenes[o];a.extensions=a.extensions||{};const c=n.getBackgroundTexture(),u=n.getBackgroundTextureInfo();a.extensions[ge]={backgroundTexture:t.createTextureInfoDef(c,u)}}}),this}}A($r,"EXTENSION_NAME",ge);class zr extends C{init(){this.extensionName=ge,this.propertyType=so,this.parentTypes=[R.SCENE]}getDefaults(){return Object.assign(super.getDefaults(),{backgroundTexture:null,backgroundTextureInfo:new U(this.graph,"backgroundTextureInfo")})}getBackgroundTexture(){return this.getRef("backgroundTexture")}setBackgroundTexture(e){return this.setRef("backgroundTexture",e)}getBackgroundTextureInfo(){return this.getRef("backgroundTexture")?this.getRef("backgroundTextureInfo"):null}}A(zr,"EXTENSION_NAME",ge);const pe="MX_lightmap",ro="Lightmap",ws=P.eq;class Xe extends D{constructor(){super(...arguments);A(this,"extensionName",pe)}createLightmap(){return new Xr(this.document.getGraph())}read(t){const s=t.jsonDoc,r=s.json.nodes||[],n=s.json.textures||[];return r.forEach((o,a)=>{if(o.extensions&&o.extensions[pe]){const c=this.createLightmap();t.nodes[a].setExtension(pe,c);const u=o.extensions[pe],f=u.lightMapTexture,p=t.textures[n[f.index].source];c.setLightMapTexture(p),t.setTextureInfo(c.getLightMapTextureInfo(),f),u.intensity!==void 0&&c.setIntensity(u.intensity),u.offset!==void 0&&c.setOffset(u.offset),u.scale!==void 0&&c.setScale(u.scale)}}),this}write(t){const s=t.jsonDoc;return this.document.getRoot().listNodes().forEach(r=>{const n=r.getExtension(pe);if(n){const o=t.nodeIndexMap.get(r),a=s.json.nodes[o];a.extensions=a.extensions||{};const c=a.extensions[pe]={};if(n.getIntensity()!==1&&(c.intensity=n.getIntensity()),ws(n.getOffset(),[0,0])||(c.offset=n.getOffset()),ws(n.getScale(),[1,1])||(c.scale=n.getScale()),n.getLightMapTexture()){const u=n.getLightMapTexture(),f=n.getLightMapTextureInfo();c.lightMapTexture=t.createTextureInfoDef(u,f)}}}),this}}A(Xe,"EXTENSION_NAME",pe);class Xr extends C{init(){this.extensionName=pe,this.propertyType=ro,this.parentTypes=[R.NODE]}getDefaults(){return Object.assign(super.getDefaults(),{scale:[1,1],offset:[0,0],intensity:1,lightMapTexture:null,lightMapTextureInfo:new U(this.graph,"lightMapTextureInfo")})}getScale(){return this.get("scale")}setScale(e){return this.set("scale",e)}getOffset(){return this.get("offset")}setOffset(e){return this.set("offset",e)}getIntensity(){return this.get("intensity")}setIntensity(e){return this.set("intensity",e)}getLightMapTexture(){return this.getRef("lightMapTexture")}setLightMapTexture(e){return this.setRef("lightMapTexture",e)}getLightMapTextureInfo(){return this.getRef("lightMapTexture")?this.getRef("lightMapTextureInfo"):null}}A(Xr,"EXTENSION_NAME",pe);const de="MX_lights_shadows",no="Shadows";class Hr extends D{constructor(){super(...arguments);A(this,"extensionName",de)}createLightsShadows(){return new qr(this.document.getGraph())}read(t){return(t.jsonDoc.json.nodes||[]).forEach((n,o)=>{if(n.extensions&&n.extensions[de]){const a=this.createLightsShadows(),c=n.extensions[de];c.castShadow!==void 0&&a.setCastShadow(c.castShadow),c.receiveShadow!==void 0&&a.setReceiveShadow(c.receiveShadow),t.nodes[o].setExtension(de,a)}}),this}write(t){const s=t.jsonDoc;return this.document.getRoot().listNodes().forEach(r=>{const n=r.getExtension(de);if(n){const o=t.nodeIndexMap.get(r),a=s.json.nodes[o];a.extensions=a.extensions||{},a.extensions[de]={castShadow:n.getCastShadow(),receiveShadow:n.getReceiveShadow()}}}),this}}A(Hr,"EXTENSION_NAME",de);class qr extends C{init(){this.extensionName=de,this.propertyType=no,this.parentTypes=[R.NODE]}getDefaults(){return Object.assign(super.getDefaults(),{castShadow:null,receiveShadow:null})}getCastShadow(){return this.get("castShadow")}setCastShadow(e){return this.set("castShadow",e)}getReceiveShadow(){return this.get("receiveShadow")}setReceiveShadow(e){return this.set("receiveShadow",e)}}A(qr,"EXTENSION_NAME",de);const me="MX_portal",io="Portal";class Yr extends D{constructor(){super(...arguments);A(this,"extensionName",me)}createPortal(){return new Kr(this.document.getGraph())}read(t){return(t.jsonDoc.json.nodes||[]).forEach((n,o)=>{if(n.extensions&&n.extensions[me]){const a=this.createPortal(),c=n.extensions[me];a.setUri(c.uri),t.nodes[o].setExtension(me,a)}}),this}write(t){const s=t.jsonDoc;return this.document.getRoot().listNodes().forEach(r=>{const n=r.getExtension(me);if(n){const o=t.nodeIndexMap.get(r),a=s.json.nodes[o];a.extensions=a.extensions||{},a.extensions[me]={uri:n.getUri()}}}),this}}A(Yr,"EXTENSION_NAME",me);class Kr extends C{init(){this.extensionName=me,this.propertyType=io,this.parentTypes=[R.NODE]}getDefaults(){return Object.assign(super.getDefaults(),{uri:null})}getUri(){return this.get("uri")}setUri(e){return this.set("uri",e)}}A(Kr,"EXTENSION_NAME",me);const ne="MX_postprocessing";class Wr extends D{constructor(){super(...arguments);A(this,"extensionName",ne)}createBloomEffect(){return new Zr(this.document.getGraph())}createPostprocessing(){return new Qr(this.document.getGraph())}read(t){return(t.jsonDoc.json.scenes||[]).forEach((n,o)=>{if(!n.extensions||!n.extensions[ne])return;const a=n.extensions[ne],c=this.createPostprocessing();if(a.bloom){const u=a.bloom,f=this.createBloomEffect();u.strength!==void 0&&f.setStrength(u.strength),u.radius!==void 0&&f.setRadius(u.radius),u.threshold!==void 0&&f.setThreshold(u.threshold),c.setBloom(f)}t.scenes[o].setExtension(ne,c)}),this}write(t){const s=t.jsonDoc;return this.properties.size===0?this:(this.document.getRoot().listScenes().forEach(r=>{const n=r.getExtension(ne);if(n){const o=t.sceneIndexMap.get(r),a=s.json.scenes[o];a.extensions=a.extensions||{};const c={},u=n.getBloom();u&&(c.bloom={strength:u.getStrength(),radius:u.getRadius(),threshold:u.getThreshold()}),a.extensions[ne]=c}}),this)}}A(Wr,"EXTENSION_NAME",ne);const Jr="Postprocessing",oo="BloomEffect";class Zr extends C{init(){this.extensionName=ne,this.propertyType=oo,this.parentTypes=[Jr]}getDefaults(){return Object.assign(super.getDefaults(),{strength:.4,radius:.4,threshold:.9})}getStrength(){return this.get("strength")}setStrength(e){return this.set("strength",e)}getRadius(){return this.get("radius")}setRadius(e){return this.set("radius",e)}getThreshold(){return this.get("threshold")}setThreshold(e){return this.set("threshold",e)}}A(Zr,"EXTENSION_NAME",ne);class Qr extends C{init(){this.extensionName=ne,this.propertyType=Jr,this.parentTypes=[R.SCENE]}getDefaults(){return Object.assign(super.getDefaults(),{bloom:null})}getBloom(){return this.getRef("bloom")}setBloom(e){return this.setRef("bloom",e)}}A(Qr,"EXTENSION_NAME",ne);const z="MX_reflection_probes",ao="ReflectionProbe";class en extends D{constructor(){super(...arguments);A(this,"extensionName",z)}createReflectionProbe(){return new tn(this.document.getGraph())}read(t){const s=t.jsonDoc;if(!s.json.extensions||!s.json.extensions[z])return this;const n=s.json.extensions[z].reflectionProbes||[],o=s.json.textures||[],a=n.map(f=>{const p=this.createReflectionProbe();p.setSize(f.size||null);const h=f.reflectionProbeTexture,m=t.textures[o[h.index].source];return p.setReflectionProbeTexture(m),t.setTextureInfo(p.getReflectionProbeTextureInfo(),h),p});return(s.json.nodes||[]).forEach((f,p)=>{if(!f.extensions||!f.extensions[z])return;const h=f.extensions[z];t.nodes[p].setExtension(z,a[h.reflectionProbe])}),(s.json.scenes||[]).forEach((f,p)=>{if(!f.extensions||!f.extensions[z])return;const h=f.extensions[z];t.scenes[p].setExtension(z,a[h.reflectionProbe])}),this}write(t){const s=t.jsonDoc;if(this.properties.size===0)return this;const r=[],n=new Map;for(const o of this.properties){const a=o,c=a.getReflectionProbeTexture(),u=a.getReflectionProbeTextureInfo(),f={reflectionProbeTexture:t.createTextureInfoDef(c,u)},p=a.getSize();p&&(f.size=p),r.push(f),n.set(a,r.length-1)}return this.document.getRoot().listNodes().forEach(o=>{const a=o.getExtension(z);if(a){const c=t.nodeIndexMap.get(o),u=s.json.nodes[c];u.extensions=u.extensions||{},u.extensions[z]={reflectionProbe:n.get(a)}}}),this.document.getRoot().listScenes().forEach(o=>{const a=o.getExtension(z);if(a){const c=t.sceneIndexMap.get(o),u=s.json.scenes[c];u.extensions=u.extensions||{},u.extensions[z]={reflectionProbe:n.get(a)}}}),s.json.extensions=s.json.extensions||{},s.json.extensions[z]={reflectionProbes:r},this}}A(en,"EXTENSION_NAME",z);class tn extends C{init(){this.extensionName=z,this.propertyType=ao,this.parentTypes=[R.SCENE,R.NODE]}getDefaults(){return Object.assign(super.getDefaults(),{size:null,reflectionProbeTexture:null,reflectionProbeTextureInfo:new U(this.graph,"reflectionProbeTextureInfo")})}getSize(){return this.get("size")}setSize(e){return this.set("size",e)}getReflectionProbeTexture(){return this.getRef("reflectionProbeTexture")}setReflectionProbeTexture(e){return this.setRef("reflectionProbeTexture",e)}getReflectionProbeTextureInfo(){return this.getRef("reflectionProbeTexture")?this.getRef("reflectionProbeTextureInfo"):null}}A(tn,"EXTENSION_NAME",z);const Ie="MX_scene_ar";class sn extends D{constructor(){super(...arguments);A(this,"extensionName",Ie)}createSceneAR(){return new rn(this.document.getGraph())}read(t){return(t.jsonDoc.json.scenes||[]).forEach((n,o)=>{if(!n.extensions||!n.extensions[Ie])return;const a=this.createSceneAR();t.scenes[o].setExtension(Ie,a)}),this}write(t){const s=t.jsonDoc;return this.properties.size===0?this:(this.document.getRoot().listScenes().forEach(r=>{if(r.getExtension(Ie)){const o=t.sceneIndexMap.get(r),a=s.json.scenes[o];a.extensions=a.extensions||{},a.extensions[Ie]={}}}),this)}}A(sn,"EXTENSION_NAME",Ie);const co="SceneAR";class rn extends C{init(){this.extensionName=Ie,this.propertyType=co,this.parentTypes=[R.SCENE]}getDefaults(){return Object.assign(super.getDefaults(),{})}}A(rn,"EXTENSION_NAME",Ie);const Ne="MX_spawn_point",uo="SpawnPoint";class nn extends D{constructor(){super(...arguments);A(this,"extensionName",Ne)}createSpawnPoint(){return new on(this.document.getGraph())}read(t){return(t.jsonDoc.json.nodes||[]).forEach((n,o)=>{if(n.extensions&&n.extensions[Ne]){const a=this.createSpawnPoint();t.nodes[o].setExtension(Ne,a)}}),this}write(t){const s=t.jsonDoc;return this.document.getRoot().listNodes().forEach(r=>{if(r.getExtension(Ne)){const o=t.nodeIndexMap.get(r),a=s.json.nodes[o];a.extensions=a.extensions||{},a.extensions[Ne]={}}}),this}}A(nn,"EXTENSION_NAME",Ne);class on extends C{init(){this.extensionName=Ne,this.propertyType=uo,this.parentTypes=[R.NODE]}}A(on,"EXTENSION_NAME",Ne);const Ae="MX_static",ho="Static";class an extends D{constructor(){super(...arguments);A(this,"extensionName",Ae)}createStatic(){return new cn(this.document.getGraph())}read(t){return(t.jsonDoc.json.nodes||[]).forEach((n,o)=>{if(n.extensions&&n.extensions[Ae]){const a=this.createStatic();t.nodes[o].setExtension(Ae,a)}}),this}write(t){const s=t.jsonDoc;return this.document.getRoot().listNodes().forEach(r=>{if(r.getExtension(Ae)){const o=t.nodeIndexMap.get(r),a=s.json.nodes[o];a.extensions=a.extensions||{},a.extensions[Ae]={}}}),this}}A(an,"EXTENSION_NAME",Ae);class cn extends C{init(){this.extensionName=Ae,this.propertyType=ho,this.parentTypes=[R.NODE]}}A(cn,"EXTENSION_NAME",Ae);const _e="MX_texture_rgbm",lo="TextureRGBM";class un extends D{constructor(){super(...arguments);A(this,"extensionName",_e)}createTextureRGBM(){return new hn(this.document.getGraph())}read(t){return(t.jsonDoc.json.textures||[]).forEach((n,o)=>{if(n.extensions&&n.extensions[_e]){const a=this.createTextureRGBM();t.textures[o].setExtension(_e,a)}}),this}write(t){const s=t.jsonDoc;return this.document.getRoot().listTextures().forEach(r=>{if(r.getExtension(_e)){const o=t.imageIndexMap.get(r);(s.json.textures||[]).forEach(c=>{c.source===o&&(c.extensions=c.extensions||{},c.extensions[_e]={})})}}),this}}A(un,"EXTENSION_NAME",_e);class hn extends C{init(){this.extensionName=_e,this.propertyType=lo,this.parentTypes=[R.TEXTURE]}getDefaults(){return Object.assign(super.getDefaults(),{})}}A(hn,"EXTENSION_NAME",_e);const ee="OMI_collider",fo="Collider";class ln extends D{constructor(){super(...arguments);A(this,"extensionName",ee)}createCollider(){return new $e(this.document.getGraph())}read(t){const s=t.jsonDoc;if(!s.json.extensions||!s.json.extensions[ee])return this;const o=(s.json.extensions[ee].colliders||[]).map(c=>{const u=this.createCollider().setType(c.type);return c.extents!==void 0&&u.setExtents(c.extents),c.radius!==void 0&&u.setRadius(c.radius),c.height!==void 0&&u.setHeight(c.height),c.mesh!==void 0&&u.setMesh(t.meshes[c.mesh]),u});return(s.json.nodes||[]).forEach((c,u)=>{if(!c.extensions||!c.extensions[ee])return;const f=c.extensions[ee];t.nodes[u].setExtension(ee,o[f.collider])}),this}write(t){const s=t.jsonDoc;if(this.properties.size===0)return this;const r=[],n=new Map;for(const o of this.properties){const a=o,c=a.getType(),u={type:c};c===$e.Type.BOX?u.extents=a.getExtents():c===$e.Type.MESH?u.mesh=t.meshIndexMap.get(a.getMesh()):c===$e.Type.SPHERE?u.radius=a.getRadius():c===$e.Type.CAPSULE&&(u.height=a.getHeight(),u.radius=a.getRadius()),r.push(u),n.set(a,r.length-1)}return this.document.getRoot().listNodes().forEach(o=>{const a=o.getExtension(ee);if(a){const c=t.nodeIndexMap.get(o),u=s.json.nodes[c];u.extensions=u.extensions||{},u.extensions[ee]={collider:n.get(a)}}}),s.json.extensions=s.json.extensions||{},s.json.extensions[ee]={colliders:r},this}}A(ln,"EXTENSION_NAME",ee);class $e extends C{init(){this.extensionName=ee,this.propertyType=fo,this.parentTypes=[R.NODE]}getDefaults(){return Object.assign(super.getDefaults(),{type:null,extents:null,radius:null,height:null,mesh:null})}getType(){return this.get("type")}setType(e){return this.set("type",e)}getExtents(){return this.get("extents")}setExtents(e){return this.set("extents",e)}getRadius(){return this.get("radius")}setRadius(e){return this.set("radius",e)}getHeight(){return this.get("height")}setHeight(e){return this.set("height",e)}getMesh(){return this.getRef("mesh")}setMesh(e){return this.setRef("mesh",e)}}A($e,"EXTENSION_NAME",ee),A($e,"Type",{MESH:"mesh",BOX:"box",SPHERE:"sphere",CAPSULE:"capsule",HULL:"hull",COMPOUND:"compound"});const xe="OMI_link",go="Link";class fn extends D{constructor(){super(...arguments);A(this,"extensionName",xe)}createLink(){return new gn(this.document.getGraph())}read(t){return(t.jsonDoc.json.nodes||[]).forEach((n,o)=>{if(n.extensions&&n.extensions[xe]){const a=this.createLink(),c=n.extensions[xe];a.setUri(c.uri),t.nodes[o].setExtension(xe,a)}}),this}write(t){const s=t.jsonDoc;return this.document.getRoot().listNodes().forEach(r=>{const n=r.getExtension(xe);if(n){const o=t.nodeIndexMap.get(r),a=s.json.nodes[o];a.extensions=a.extensions||{},a.extensions[xe]={uri:n.getUri()}}}),this}}A(fn,"EXTENSION_NAME",xe);class gn extends C{init(){this.extensionName=xe,this.propertyType=go,this.parentTypes=[R.NODE]}getDefaults(){return Object.assign(super.getDefaults(),{uri:null})}getUri(){return this.get("uri")}setUri(e){return this.set("uri",e)}}A(gn,"EXTENSION_NAME",xe);function po(){return new Worker("/assets/TextureCompressionWorker-ff1cad75.js")}function mo(i){return async e=>{const t=e.getRoot();let s=0;const r=new Map,n=new Map,o=[],a=navigator.hardwareConcurrency||4;let c=0;i&&i({step:"Compressing textures with Basis Universal Texture Compression...",status:`Using ${a} threads. Initializing...`});for(let T=0;T<a;T++){const x=new po;x.addEventListener("message",g=>{const l=g.data.jobId;g.data.error?r.get(l).reject(new Error("Error compressing texture")):(c++,i&&i({step:"Compressing textures with Basis Universal Texture Compression...",status:`Using ${a} threads. ${r.size-c} / ${r.size} textures remaining.`}),r.get(l).resolve(g.data))}),o.push(x)}const u=document.createElement("canvas"),f=u.getContext("2d"),p=performance.now();let h=!1;for(const T of t.listTextures()){const x=T.getMimeType();if(x!=="image/png"&&x!=="image/jpeg")continue;let g=T.getImage();const l=T.getSize();if(!g||!l)continue;const d=T.getName()||T.getURI(),E=Lr(e,T),b=E.some(N=>N==="baseColorTexture"||N==="emissiveTexture"),I=E.some(N=>N==="normalTexture"),_=E.some(N=>N==="backgroundTexture"),w=r.size%o.length,M=o[w],v=T.listParents().some(N=>N.propertyType==="ReflectionProbe"||N.propertyType==="Lightmap");if(v&&x==="image/jpeg")continue;if(x==="image/jpeg"){const N=g.byteLength;u.width=l[0],u.height=l[1],f.clearRect(0,0,l[0],l[1]);const $=await createImageBitmap(new Blob([g],{type:x}));f.drawImage($,0,0),g=f.getImageData(0,0,l[0],l[1]).data,$.close(),console.log(`Converted image from jpeg to bitmap:
  Width: ${l[0]}
  Height: ${l[1]}
  JPEG Byte Length: ${N}
  Bitmap Byte Length: ${g.byteLength}`)}const F=s++;n.set(F,T),r.set(F,Rn(!1)),M.postMessage({jobId:F,name:d,slots:E,isSRGB:b,isNormal:I,useOptiPng:v,size:l,data:g,mimeType:x,flipY:_},[g.buffer])}const m=await Promise.all(Array.from(r.values()).map(T=>T.promise));for(const T of o)T.terminate();for(const T of m){const x=n.get(T.jobId);x.setImage(T.data),x.setMimeType(T.mimeType),T.mimeType==="image/ktx2"&&(h=!0)}h&&e.createExtension(Qt).setRequired(!0);const y=((performance.now()-p)/1e3).toFixed(1);console.log(`Total texture compression time: ${y} secs`)}}const Se="dedup",Bt={propertyTypes:[R.ACCESSOR,R.MESH,R.TEXTURE,R.MATERIAL]},xo=function(i=Bt){const e={...Bt,...i},t=new Set(e.propertyTypes);for(const r of e.propertyTypes)if(!Bt.propertyTypes.includes(r))throw new Error(`${Se}: Unsupported deduplication on type "${r}".`);const s=r=>{const n=r.getLogger();t.has(R.ACCESSOR)&&To(n,r),t.has(R.TEXTURE)&&yo(n,r),t.has(R.MATERIAL)&&bo(n,r),t.has(R.MESH)&&Eo(n,r),n.debug(`${Se}: Complete.`)};return Object.defineProperty(s,"name",{value:"dedupe-properties"}),s};function To(i,e){const t=new Set,s=new Set,r=new Set,n=new Set,o=e.getRoot().listMeshes();o.forEach(h=>{h.listPrimitives().forEach(m=>{m.listAttributes().forEach(T=>s.add(T));const y=m.getIndices();y&&t.add(y)})});for(const h of e.getRoot().listAnimations())for(const m of h.listSamplers()){const y=m.getInput(),T=m.getOutput();y&&r.add(y),T&&n.add(T)}function a(h){const m=new Map;for(let y=0;y<h.length;y++){const T=h[y],x=S.toView(T.getArray());if(!m.has(T))for(let g=0;g<h.length;g++){const l=h[g];T!==l&&(m.has(l)||T.getType()===l.getType()&&T.getComponentType()===l.getComponentType()&&T.getCount()===l.getCount()&&T.getNormalized()===l.getNormalized()&&S.equals(x,S.toView(l.getArray()))&&m.set(l,T))}}return m}const c=a(Array.from(t));i.debug(`${Se}: Found ${c.size} duplicates among ${t.size} indices.`);const u=a(Array.from(s));i.debug(`${Se}: Found ${u.size} duplicates among ${s.size} attributes.`);const f=a(Array.from(r)),p=a(Array.from(n));i.debug(`${Se}: Found ${f.size+p.size} duplicates among ${r.size+n.size} animation accessors.`),o.forEach(h=>{h.listPrimitives().forEach(m=>{m.listAttributes().forEach(T=>{u.has(T)&&m.swap(T,u.get(T))});const y=m.getIndices();y&&c.has(y)&&m.swap(y,c.get(y))})}),Array.from(c.keys()).forEach(h=>h.dispose()),Array.from(u.keys()).forEach(h=>h.dispose());for(const h of e.getRoot().listAnimations())for(const m of h.listSamplers()){const y=m.getInput(),T=m.getOutput();y&&f.has(y)&&m.swap(y,f.get(y)),T&&p.has(T)&&m.swap(T,p.get(T))}Array.from(f.keys()).forEach(h=>h.dispose()),Array.from(p.keys()).forEach(h=>h.dispose())}function Eo(i,e){const t=e.getRoot(),s=new Map;t.listAccessors().forEach((o,a)=>s.set(o,a)),t.listMaterials().forEach((o,a)=>s.set(o,a));const r=t.listMeshes().length,n=new Map;for(const o of t.listMeshes()){const a=[];for(const u of o.listPrimitives())a.push(pn(u,s));const c=a.join(";");if(n.has(c)){const u=n.get(c);o.listParents().forEach(f=>{f.propertyType!==R.ROOT&&f.swap(o,u)}),o.dispose()}else n.set(c,o)}i.debug(`${Se}: Found ${r-n.size} duplicates among ${r} meshes.`)}function yo(i,e){const t=e.getRoot(),s=t.listTextures(),r=new Map;for(let n=0;n<s.length;n++){const o=s[n],a=o.getImage();if(!r.has(o))for(let c=0;c<s.length;c++){const u=s[c],f=u.getImage();if(o===u||r.has(u)||o.getMimeType()!==u.getMimeType())continue;const p=o.getSize(),h=u.getSize();!p||!h||p[0]===h[0]&&p[1]===h[1]&&(!a||!f||S.equals(a,f)&&r.set(u,o))}}i.debug(`${Se}: Found ${r.size} duplicates among ${t.listTextures().length} textures.`),Array.from(r.entries()).forEach(([n,o])=>{n.listParents().forEach(a=>{a instanceof St||a.swap(n,o)}),n.dispose()})}function bo(i,e){const t=e.getRoot(),s=t.listMaterials(),r=new Map,n=new Set(["name"]);for(let o=0;o<s.length;o++){const a=s[o];if(!r.has(a))for(let c=0;c<s.length;c++){const u=s[c];a!==u&&(r.has(u)||a.equals(u,n)&&r.set(u,a))}}i.debug(`${Se}: Found ${r.size} duplicates among ${t.listMaterials().length} materials.`),Array.from(r.entries()).forEach(([o,a])=>{o.listParents().forEach(c=>{c instanceof St||c.swap(o,a)}),o.dispose()})}function pn(i,e){const t=[];for(const s of i.listSemantics()){const r=i.getAttribute(s);t.push(s+":"+e.get(r))}if(i instanceof Je){const s=i.getIndices();s&&t.push("indices:"+e.get(s));const r=i.getMaterial();r&&t.push("material:"+e.get(r)),t.push("mode:"+i.getMode());for(const n of i.listTargets())t.push("target:"+pn(n,e))}return t.join(",")}const yt="extension-aware-instance";function Ms(){const i=new Map;let e=0;return t=>{let s=i.get(t);return s===void 0&&(s=e++,i.set(t,s)),s}}function Ro(){const i=Ms(),e=Ms();return t=>{var n;const s=t.getMesh(),r=(n=t.getExtension(Xe.EXTENSION_NAME))==null?void 0:n.getLightMapTexture();return!s||t.getSkin()?null:`mesh-${i(s)}`+(r?`-lightmap-${e(r)}`:"")}}function Io(){const i=e=>{const t=e.getLogger(),s=e.getRoot(),r=e.createExtension(Zt);let n=0,o=0;const a=new Set;for(const c of s.listAnimations())for(const u of c.listChannels()){const f=u.getTargetNode();f&&f.traverse(p=>{a.add(p)})}for(const c of s.listScenes()){const u=new Map,f=Ro();c.traverse(p=>{var m;if(a.has(p))return;const h=f(p);if(h){let y=u.get(h);if(!y){const T=(m=p.getExtension(Xe.EXTENSION_NAME))==null?void 0:m.clone();T&&(T.setOffset([0,0]),T.setScale([1,1])),y={mesh:p.getMesh(),nodes:new Set,lightMap:T},u.set(h,y)}y.nodes.add(p)}});for(const[,{mesh:p,nodes:h,lightMap:m}]of u){if(h.size<2)continue;const y=[],T=Array.from(h),x=Ao(e,r,p,h.size,!!m),g=x.getAttribute("TRANSLATION"),l=x.getAttribute("ROTATION"),d=x.getAttribute("SCALE"),E=e.createNode().setName(T[0].getName()+"-instanced").setMesh(p).setExtension("EXT_mesh_gpu_instancing",x);m&&E.setExtension(Xe.EXTENSION_NAME,m),c.addChild(E);let b=!1,I=!1,_=!1;for(let w=0;w<T.length;w++){let M,v,F;const N=T[w];if(g.setElement(w,M=N.getWorldTranslation()),l.setElement(w,v=N.getWorldRotation()),d.setElement(w,F=N.getWorldScale()),m){const $=N.getExtension(Xe.EXTENSION_NAME),Y=x.getAttribute("_LIGHTMAP_OFFSET"),X=x.getAttribute("_LIGHTMAP_SCALE");Y.setElement(w,$.getOffset()),X.setElement(w,$.getScale()),N.setExtension(Xe.EXTENSION_NAME,null)}P.eq(M,[0,0,0])||(b=!0),P.eq(v,[0,0,0,1])||(I=!0),P.eq(F,[1,1,1])||(_=!0),N.setMesh(null),y.push(N)}b||g.dispose(),I||l.dispose(),_||d.dispose(),No(y,t),n++,o+=T.length}}n>0?t.info(`${yt}: Created ${n} batches, with ${o} total instances.`):(t.info(`${yt}: No meshes with multiple parent nodes were found.`),r.dispose()),t.debug(`${yt}: Complete.`)};return Object.defineProperty(i,"name",{value:"extension-aware-instance"}),i}function No(i,e){let t,s=0;for(;t=i.pop();){if(t.listChildren().length||t.getCamera()||t.getMesh()||t.getSkin()||t.listExtensions().length)continue;const r=t.getParent();r instanceof Wt&&i.push(r),t.dispose(),s++}e.debug(`${yt}: Removed ${s} unused nodes.`)}function Ao(i,e,t,s,r){const n=t.listPrimitives()[0].getAttribute("POSITION").getBuffer(),o=i.createAccessor().setType("VEC3").setArray(new Float32Array(3*s)).setBuffer(n),a=i.createAccessor().setType("VEC4").setArray(new Float32Array(4*s)).setBuffer(n),c=i.createAccessor().setType("VEC3").setArray(new Float32Array(3*s)).setBuffer(n),u=e.createInstancedMesh().setAttribute("TRANSLATION",o).setAttribute("ROTATION",a).setAttribute("SCALE",c);if(r){const f=i.createAccessor().setType("VEC2").setArray(new Float32Array(2*s)).setBuffer(n),p=i.createAccessor().setType("VEC2").setArray(new Float32Array(2*s)).setBuffer(n);u.setAttribute("_LIGHTMAP_SCALE",f).setAttribute("_LIGHTMAP_OFFSET",p)}return u}function _o(i){i.registerExtensions([...Ti,Br,Xe,Hr,en,$r,sn,nn,an,Wr,Yr,un,fn,ln])}const qt={dedupeProperties:!0,resizeTextures:!0,instancing:!0,compressTextures:!0};async function wo(i,e=qt,t){e.dedupeProperties&&(t&&t({step:"Deduplicating Properties..."}),await i.transform(xo())),e.instancing&&(t&&t({step:"Instancing meshes..."}),await i.transform(Io())),e.resizeTextures&&(t&&t({step:"Resizing base color textures and emissive textures to 2048x2048..."}),await i.transform(Lt({pattern:/^(?!ignore-).*/,slots:/(baseColorTexture)|(emissiveTexture)/,size:[2048,2048]})),t&&t({step:"Resizing metallic roughness, occlusion, and normal textures to 1024x1024..."}),await i.transform(Lt({pattern:/^(?!ignore-).*/,slots:/(metallicRoughnessTexture)|(occlusionTexture)|(normalTexture)/,size:[1024,1024]})),await i.transform(Lt({pattern:/^ignore-.*/,size:[4096,4096]}))),e.compressTextures&&await i.transform(mo(t))}class Mo extends $n{constructor(){super(...arguments);A(this,"fileMap",new Map);A(this,"beforeReadDocumentHooks",[])}readGLTF(t,s){return this.fileMap=s,this.read(t)}registerExtensions(t){super.registerExtensions(t);for(const s of t)s.beforeReadDocument&&this.beforeReadDocumentHooks.push(s.beforeReadDocument);return this}async readAsJSON(t){const s=await super.readAsJSON(t);return await Promise.all(this.beforeReadDocumentHooks.map(r=>r(this,s))),s}resolve(t,s){const r=super.resolve(t,s);return this.fileMap.get(decodeURIComponent(s))||r}}async function vo(i,e,t,s){const r=new Ee(Rt.DEBUG),n=new Mo().setLogger(r);_o(n),s&&s({step:"Reading glTF..."});const o=await n.readGLTF(i,e);o.setLogger(r),s&&s({step:"Transforming glTF..."}),await wo(o,t,s),s&&s({step:"Writing glTF..."});const a=await n.writeBinary(o),c=`${o.getRoot().getName()||"scene"}.glb`;s&&s({step:`glTF successfully transformed, downloading "${c}"...`}),xn(a,c,"model/gltf-binary")}function oa(){const[{step:i,status:e,error:t},s]=gt.useState({step:"Drag and drop .gltf directory contents onto this page to optimize."}),[r,n]=gt.useState(qt),o=gt.useCallback(c=>{if(c.preventDefault(),!c.dataTransfer)return;let u;const f=new Map;for(const p of c.dataTransfer.items){const h=p.getAsFile();if(h){const m=URL.createObjectURL(h);h.name.match(/\.gl(?:tf|b)$/)?u=m:f.set(h.name,m)}}u&&vo(u,f,r,({step:p,status:h})=>{s({step:p,status:h})}).catch(p=>{console.error(p),s({error:p.message})})},[r]),a=gt.useCallback(c=>{c.preventDefault()},[]);return pt("div",{className:"AssetPipeline",children:[oe("div",{className:"AssetPipeline__dropzone",onDrop:o,onDragOver:a}),pt("div",{className:"AssetPipeline__content gap-lg",children:[oe(et,{variant:"h2",children:"Third Room Asset Pipeline"}),Object.keys(qt).map(c=>oe(wn,{label:oe(_n,{children:c}),children:oe(An,{checked:r[c],onCheckedChange:u=>n(f=>({...f,[c]:u}))})})),oe("div",{className:"AssetPipeline__message",children:t?pt(rs,{children:[oe(et,{color:"danger",children:t}),oe(et,{color:"danger",children:"See console for more details."})]}):pt(rs,{children:[oe(et,{children:i}),e&&oe(et,{children:e})]})})]})]})}export{oa as default};
//# sourceMappingURL=AssetPipeline-f01a48ac.js.map
