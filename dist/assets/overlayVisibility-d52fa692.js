import{n as w,a7 as k,ad as N,ae as O,a6 as j,b as P,m as z,r as R}from"./main.cc7980d7.js";import{m as Z,_ as S,$ as U,a0 as _,W as G,a1 as V,a2 as Y,a3 as $,b as q,a4 as g,a5 as H,a6 as B,a7 as F,i as J,U as K,a8 as Q}from"./editor-9e67c00a.js";const W=w({worldId:void 0,entered:!1,loading:!1}),X=w(e=>e(W),(e,t,o)=>{if(o.type==="LOAD"){t(W,{worldId:o.roomId,entered:!1,loading:!0});return}if(o.type==="ENTER"){t(W,{worldId:e(W).worldId,entered:!0,loading:!1});return}o.type==="CLOSE"&&(t(W,{worldId:void 0,entered:!1,loading:!1}),t(Z,{type:"RESET"}))}),M=w(void 0),ee=w(e=>e(M)),A=w(new Set),te=w(e=>e(A),(e,t,o)=>{if(o.type==="OPEN"){t(A,k(e(A),r=>{r.add(o.roomId)})),t(M,o.roomId);return}if(o.type==="MINIMIZE"&&e(M)===o.roomId){t(M,void 0);return}if(o.type==="CLOSE"){t(A,k(e(A),r=>{r.delete(o.roomId)})),e(M)===o.roomId&&t(M,void 0);return}}),L=w(void 0),ce=w(e=>e(L),(e,t,o)=>{t(L,o);const r=e(ee);r&&t(te,{type:"MINIMIZE",roomId:r})});function oe(e,t){return e.eventTimestamp===t.eventTimestamp?e.deviceIndex-t.deviceIndex:e.eventTimestamp-t.eventTimestamp}function re(e,t){return e.eventTimestamp===t.eventTimestamp?e.deviceIndex<=t.deviceIndex:e.eventTimestamp<t.eventTimestamp}function b(e){const t=Array.from(new Map(e.members).values()).sort(oe).filter(o=>o.isConnected&&o.dataChannel);if(t.length!==0&&!re(e,t[0]))return t[0]}const ae=(e,t)=>j(e.callHandler.calls,t.id);async function se(e,t,o,r){var v,T;const d=t.session;if(!d)throw new Error("You must initialize the client session before creating the network interface");let l=ae(d,r);l||(l=await d.callHandler.createCall(r.id,"m.voice","World Call",N.Room));let C;try{C=await o.mediaDevices.getMediaTracks(!0,!1)}catch(n){console.error(n)}const x=C?new O().withUserMedia(C).withDataChannel({}):new O().withDataChannel({});await l.join(x),((v=l.muteSettings)==null?void 0:v.microphone)===!1&&localStorage.getItem("microphone")!=="true"&&l.setMuted(l.muteSettings.toggleMicrophone()),S(e,(T=l.localMedia)==null?void 0:T.userMedia);let i;const m=d.userId,E=await p(l,m);await c(l,m,E===m);function p(n,I){return new Promise(u=>{let y;const f=b(n);if(f){u(f.userId);return}if(n.members.size===0){u(I);return}const a=n.members.subscribe({onAdd(){const s=b(n);s&&(clearTimeout(y),a(),u(s.userId))},onRemove(){const s=b(n);s&&(clearTimeout(y),a(),u(s.userId))},onReset(){throw new Error("Unexpected reset of groupCall.members")},onUpdate(){const s=b(n);s&&(clearTimeout(y),a(),u(s.userId))}});y=window.setTimeout(()=>{a();const s=b(n);u((s==null?void 0:s.userId)??I)},1e4)})}async function c(n,I,u){var y;u&&U(e,I),i=n.members.subscribe({onAdd(f,a){var s;a.isConnected&&a.dataChannel&&(h(n,I),_(e,a.userId,a.dataChannel,(s=a.remoteMedia)==null?void 0:s.userMedia))},onRemove(f,a){h(n,I),G(e,a.userId)},onReset(){throw new Error("Unexpected reset of groupCall.members")},onUpdate(f,a){var s;a.isConnected&&a.dataChannel&&!V(e,a.userId)&&(h(n,I),_(e,a.userId,a.dataChannel,(s=a.remoteMedia)==null?void 0:s.userMedia))}});for(const[,f]of n.members)f.isConnected&&f.dataChannel&&_(e,f.userId,f.dataChannel,(y=f.remoteMedia)==null?void 0:y.userMedia)}function h(n,I){const u=b(n);u?U(e,u.userId):U(e,I)}return{dispose:()=>{Y(e),$(e),S(e,void 0),i&&i(),l&&l.leave()}}}let D;const ne=e=>{D=e},ie=e=>{e(D)};function me(){const{session:e,platform:t,client:o}=P(!0),r=q(),d=z(X),l=R.useCallback(async()=>{ie(i=>{i==null||i.dispose()}),g(r),d({type:"CLOSE"})},[d,r]),C=R.useCallback(async(i,m)=>{const E=i.id;d({type:"LOAD",roomId:E});const p=m.max_member_object_cap;let c=m.scene_url,h=m.script_url;if(typeof c!="string")throw new Error("3D scene does not exist for this world.");c.startsWith("mxc:")&&(c=e.mediaRepository.mxcUrl(c)),h&&h.startsWith("mxc:")&&(h=e.mediaRepository.mxcUrl(h));try{H(r,e,i.id);const[v]=await Promise.all([se(r,o,t,i),B(r,c,{environmentScriptUrl:h,maxObjectCap:p})]);ne(v),await F(r,e.userId),J(r,K).context.resume().catch(()=>console.error("Couldn't resume audio context")),d({type:"ENTER"})}catch(v){throw new Error((v==null?void 0:v.message)??"Unknown error loading world.")}},[r,e,d,o,t]),x=R.useCallback(async(i,m)=>{d({type:"LOAD",roomId:i.id}),g(r),H(r,e,i.id);const E=m.max_member_object_cap;let p=m.scene_url,c=m.script_url;if(typeof p!="string")throw new Error("3D scene does not exist for this world.");p.startsWith("mxc:")&&(p=e.mediaRepository.mxcUrl(p)),c&&c.startsWith("mxc:")&&(c=e.mediaRepository.mxcUrl(c)),await Q(r,p,{environmentScriptUrl:c,maxObjectCap:E}),d({type:"ENTER"})},[d,r,e]);return{loadAndEnterWorld:C,exitWorld:l,reloadWorld:x}}const ue=w(!0);export{te as a,ee as b,ue as c,ce as o,me as u,X as w};
//# sourceMappingURL=overlayVisibility-d52fa692.js.map
