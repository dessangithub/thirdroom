{"version":3,"file":"sw.js","sources":["../sw.ts"],"sourcesContent":["/// <reference lib=\"ESNext\" />\n/// <reference lib=\"WebWorker\" />\n\nexport declare const self: ServiceWorkerGlobalScope;\n\nconst CACHE_VERSION = 1;\nconst MXC_DOWNLOAD_CACHE = `mxc_download_v${CACHE_VERSION}`;\nconst MXC_DOWNLOAD_REGEX = /^\\S+\\/_matrix\\/media\\/r0\\/download\\/\\S+$/;\n\nself.addEventListener(\"activate\", function (event) {\n  event.waitUntil(\n    caches.keys().then((cacheNames) => {\n      return Promise.all(\n        cacheNames.map((cacheName) => {\n          if (cacheName !== MXC_DOWNLOAD_CACHE) {\n            return caches.delete(cacheName);\n          }\n        })\n      );\n    })\n  );\n});\n\nself.addEventListener(\"fetch\", (event: FetchEvent) => {\n  const { request } = event;\n\n  // Only handle mxc download request.\n  if (request.method !== \"GET\" || MXC_DOWNLOAD_REGEX.test(request.url) === false) return;\n\n  event.respondWith(\n    caches.open(MXC_DOWNLOAD_CACHE).then((cache) => {\n      return cache\n        .match(request)\n        .then((cachedResponse) => {\n          if (cachedResponse) {\n            return cachedResponse;\n          }\n\n          return fetch(request.clone()).then((fetchedResponse) => {\n            if (fetchedResponse.ok) {\n              event.waitUntil(cache.put(request, fetchedResponse.clone()));\n            }\n\n            return fetchedResponse;\n          });\n        })\n        .catch((error) => {\n          console.error(`Service Worker Error fetching ${request.url}:`, error);\n          throw error;\n        });\n    })\n  );\n});\n"],"names":["MXC_DOWNLOAD_CACHE","MXC_DOWNLOAD_REGEX","event","cacheNames","cacheName","request","cache","cachedResponse","fetchedResponse","error"],"mappings":"AAMA,MAAMA,EAAqB,kBACrBC,EAAqB,2CAE3B,KAAK,iBAAiB,WAAY,SAAUC,EAAO,CAC3CA,EAAA,UACJ,OAAO,KAAA,EAAO,KAAMC,GACX,QAAQ,IACbA,EAAW,IAAKC,GAAc,CAC5B,GAAIA,IAAcJ,EACT,OAAA,OAAO,OAAOI,CAAS,CAChC,CACD,CAAA,CAEJ,CAAA,CAEL,CAAC,EAED,KAAK,iBAAiB,QAAUF,GAAsB,CAC9C,KAAA,CAAE,QAAAG,CAAY,EAAAH,EAGhBG,EAAQ,SAAW,OAASJ,EAAmB,KAAKI,EAAQ,GAAG,IAAM,IAEnEH,EAAA,YACJ,OAAO,KAAKF,CAAkB,EAAE,KAAMM,GAC7BA,EACJ,MAAMD,CAAO,EACb,KAAME,GACDA,GAIG,MAAMF,EAAQ,MAAO,CAAA,EAAE,KAAMG,IAC9BA,EAAgB,IAClBN,EAAM,UAAUI,EAAM,IAAID,EAASG,EAAgB,MAAO,CAAA,CAAC,EAGtDA,EACR,CACF,EACA,MAAOC,GAAU,CAChB,cAAQ,MAAM,iCAAiCJ,EAAQ,OAAQI,CAAK,EAC9DA,CAAA,CACP,CACJ,CAAA,CAEL,CAAC"}